import { Hono } from 'hono'
import type { Context } from 'hono'
import type { Bindings, Variables, User, AppEnv, RequestUser } from './types/app'
import {
  isDevEnv,
  renderUserMenu,
  getLogoImage,
  getLogoSVG,
  isAdminRole,
  renderLayout,
  renderLayoutWithContext,
  SOURCE_LABEL_MAP,
  DEFAULT_CANONICAL_ORIGIN,
  buildCanonicalUrl,
  isAnalysisType,
  isPricingTier,
  isRequestStatus,
  isPageType,
  buildCommentPageSlug,
  toParentId,
  getClientIp,
  parseSourcesQuery,
  parseNumberParam,
  toIntegerOrNull,
  formatEmploymentRate,
  escapeHtml,
  formatDateSafe,
  serializeForScript,
  createMetaDescription,
  mapRoleForComments,
  getOptionalUser,
  maskIpForDisplay,
  toHex,
  hashIpAddress,
} from './utils/shared-helpers'
import {
  renderJobCard,
  renderMajorCard,
} from './utils/card-renderers'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import { renderer } from './renderer'
import auth from './routes/auth'
import { authMiddleware, requireAuth, requireAdmin, requireRole } from './middleware/auth'
import { JOB_CATEGORIES, APTITUDE_TYPES } from './api/careernetAPI'
import {
  ROLE_IDENTITY_OPTIONS,
  CAREER_STAGE_OPTIONS,
  TRANSITION_STATUS_OPTIONS,
  SKILL_LEVEL_OPTIONS,
  SKILL_LEVEL_NOTICE,
  CONSTRAINT_OPTIONS,
  TRANSITION_SIGNAL_QUESTIONS,
  IDENTITY_ANCHOR_PATTERNS,
  MAJOR_STUDENT_OPTIONS,
} from './services/ai-analyzer/career-tree-types'
import { getUnifiedJobDetail, getUnifiedJobDetailWithRawData, getUnifiedMajorDetail, searchUnifiedJobs, searchUnifiedMajors } from './services/profileDataService'
import { ragSearchJobs, ragSearchMajors } from './services/rag-search'
import type { UnifiedJobDetail, UnifiedMajorDetail } from './types/unifiedProfiles'
// renderUnifiedJobDetail, createJobJsonLd â†’ moved to routes/job-detail.ts
import { renderJobTemplateDesignPage } from './templates/jobTemplateDesignPage'
import { renderJobETLInspectionPage } from './templates/jobETLInspectionPage'
// renderUnifiedMajorDetail, createMajorJsonLd â†’ moved to routes/major-detail.ts
import type { JobSourceRow, MajorSourceRow } from './types/database'
import { buildCommentGovernanceItems, resolveCommentPolicy } from './templates/detailTemplateUtils'
// getSampleJobDetail, getSampleMajorDetail â†’ moved to routes/job-detail.ts, major-detail.ts
import { composeDetailSlug, resolveDetailIdFromSlug } from './utils/slug'
// withKvCache, buildListCacheKey, CacheState â†’ moved to routes/major-list.ts
import type { 
  ExportedHandlerScheduledHandler,
  D1Database,
  KVNamespace,
  R2Bucket,
  R2ObjectBody,
  VectorizeIndex,
  Ai
} from '@cloudflare/workers-types'
// LIST_CACHE_STALE_SECONDS, LIST_CACHE_MAX_AGE_SECONDS â†’ moved to routes/major-list.ts
import { attemptScheduledRefresh, getFreshnessStatus, resolveFreshnessTargetById } from './services/freshnessService'
import { SERP_FRESHNESS_TARGETS } from './config/freshnessConfig'
import { storePerfMetrics, type PerfMetricsPayload, type PerfAlert } from './services/perfMetricsService'
import {
  createOrUpdateSession,
  createAnalysisRequest,
  createAnalysisResult,
  getAnalysisRequestWithResult,
  getSession as getAiSession,
  listRequestsBySession,
  updateRequestStatus
} from './services/aiAnalysisService'
// Phase 0: AI Analyzer Service (scoring-v0.2.1-final)
import { analyzerRoutes } from './services/ai-analyzer'
import { shareRoutes } from './routes/share'
import { commentRoutes } from './routes/comments'
import { feedbackRoutes } from './routes/feedback'
import { adminRoutes } from './routes/admin'
import { uploadRoutes } from './routes/upload'
import { contentEditorRoutes } from './routes/content-editor'
import { howtoRoutes } from './routes/howto'
import { searchRoutes } from './routes/search'
import { jobListRoutes } from './routes/job-list'
import { majorListRoutes } from './routes/major-list'
import { jobDetailRoutes } from './routes/job-detail'
import { majorDetailRoutes } from './routes/major-detail'
import {
  recordSerpInteraction,
  getDailySerpSummary,
  listRecentSerpInteractions
} from './services/serpInteractionService'
// commentService functions moved to routes/comments.ts and routes/admin.ts
// listHowtoReports: static import removed (only dynamic import used now)
import type { AnalysisType, PricingTier, RequestStatus } from './types/aiAnalysis'
// getOrGeneratePage â†’ moved to routes/job-detail.ts, major-detail.ts
// editService, revisionService, editValidation, similarNamesService, adminSimilarNames â†’ moved to routes/content-editor.ts
// renderAdminDashboard moved to routes/admin.ts
import { renderUserLayoutContent } from './templates/user/userLayout'
import { renderUserAiResultsContent, type AiResultItem } from './templates/user/userAiResults'
// renderAdminUsers, renderAdminUserDetail, renderAdminFeedbackPage, renderAdminFeedbackDetail moved to routes/admin.ts
// listFeedbackWithCommentCount, listComments, getFeedbackById moved to routes/admin.ts and routes/feedback.ts
import { renderOnboardingPage } from './templates/onboarding'
import { renderTermsPage } from './templates/legal/terms'
import { renderPrivacyPage } from './templates/legal/privacy'
import { renderHelpPage } from './templates/help'
import { renderNav, renderNavStyles, renderNavScripts } from './templates/partials/nav'
import { renderNotFoundPage } from './templates/notFound'
import {
  getOnboardingStatus,
  checkNicknameAvailability,
  submitOnboarding,
} from './services/onboardingService'
// renderAdminContent, renderAdminStats, adminService functions moved to routes/admin.ts
import { weakETag, toNFC, matchETag } from './utils/etag'
import { TEMPLATE_VERSIONS } from './constants/template-versions'

const timingMiddleware = async (c: any, next: any) => {
  if (!isDevEnv(c?.env)) {
    await next()
    return
  }
  const t0 = Date.now()
  const marks: Record<string, number> = {}
  c.set('mark', (k: string) => {
    marks[k] = Date.now()
  })
  await next()
  const parts = Object.entries(marks).map(([k, v]) => `${k};dur=${Date.now() - Number(v)}`)
  if (parts.length > 0) {
    c.header('Server-Timing', parts.join(', '))
  }
  c.header('X-Response-Duration', String(Date.now() - t0))
}

const apiCacheHintMiddleware = async (c: any, next: any) => {
  await next()
  const path = c.req.path || ''
  if (path.startsWith('/api/') && !c.res.headers.get('Cache-Control')) {
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
  }
}

const errorLoggingMiddleware = async (c: any, next: any) => {
  try {
    await next()
  } catch (e: any) {
    return c.text('Internal Error', 500)
  }
}



const app = new Hono<AppEnv>()

// Global error handler â€” ì—ëŸ¬ ì›ì¸ íŒŒì•…ìš©
app.onError((err, c) => {
  return c.text(`Error: ${err?.message}\nStack: ${err?.stack}`, 500)
})

// ì„ì‹œ ì§„ë‹¨ ì—”ë“œí¬ì¸íŠ¸ â€” ë°”ì¸ë”© í™•ì¸ìš©
app.get('/api/debug/bindings', async (c) => {
  const kvTest = { exists: !!c.env.KV, type: typeof c.env.KV }
  const dbTest = { exists: !!c.env.DB, type: typeof c.env.DB }
  let kvWrite = 'skip'
  if (c.env.KV) {
    try {
      await c.env.KV.put('_test_binding', 'ok', { expirationTtl: 60 })
      const val = await c.env.KV.get('_test_binding')
      kvWrite = val === 'ok' ? 'ok' : `read_mismatch:${val}`
      await c.env.KV.delete('_test_binding')
    } catch (e: any) {
      kvWrite = `error:${e?.message}`
    }
  }
  let dbWrite = 'skip'
  if (c.env.DB) {
    try {
      const r = await c.env.DB.prepare('SELECT 1 as v').first<{v:number}>()
      dbWrite = r?.v === 1 ? 'ok' : `unexpected:${JSON.stringify(r)}`
    } catch (e: any) {
      dbWrite = `error:${e?.message}`
    }
  }
  return c.json({ kv: kvTest, db: dbTest, kvWrite, dbWrite })
})

// www â†’ non-www 301 ë¦¬ë‹¤ì´ë ‰íŠ¸
app.use('*', async (c, next) => {
  const url = new URL(c.req.url)
  if (url.hostname.startsWith('www.')) {
    url.hostname = url.hostname.slice(4)
    return c.redirect(url.toString(), 301)
  }
  return next()
})

// Middleware
app.use('*', cors())
app.use('*', renderer)
app.use('*', errorLoggingMiddleware)
app.use('*', timingMiddleware)
app.use('*', apiCacheHintMiddleware)

// Serve static files from public directory
// All static assets including JS, CSS, images are served from /static/* path
// @ts-ignore - Cloudflare Workers types mismatch
app.use('/static/*', serveStatic({ root: './public' }))

// Serve images from public/images directory
// @ts-ignore - Cloudflare Workers types mismatch
app.use('/images/*', serveStatic({ root: './public' }))

// Phase 3: ì¸ì¦ Middleware (ëª¨ë“  ë¼ìš°íŠ¸ì— ì ìš©)
app.use('*', authMiddleware)

// Phase 3: ì¸ì¦ ë¼ìš°íŠ¸
app.route('/auth', auth)

// ============================================
// Phase 0: AI Analyzer API (scoring-v0.2.1-final)
// POST /api/ai-analyzer/analyze   - ë¶„ì„ ìš”ì²­
// POST /api/ai-analyzer/followup  - follow-up ì‘ë‹µ
// GET  /api/ai-analyzer/result/:id - ê²°ê³¼ ì¡°íšŒ
// GET  /api/ai-analyzer/session/:id - ì„¸ì…˜ ì´ë ¥
// ============================================
app.route('/api/ai-analyzer', analyzerRoutes)
app.route('', shareRoutes)
app.route('', commentRoutes)
app.route('', feedbackRoutes)
app.route('', adminRoutes)
app.route('', uploadRoutes)
app.route('', contentEditorRoutes)
app.route('/howto', howtoRoutes)
app.route('', jobListRoutes)      // /job (list) - BEFORE /job/:slug
app.route('', majorListRoutes)    // /major (list) - BEFORE /major/:slug
app.route('', searchRoutes)       // /search
app.route('', jobDetailRoutes)    // /job/:slug
app.route('', majorDetailRoutes)  // /major/:slug, /majors/:id

// ============================================
// ì˜¨ë³´ë”© ë¼ìš°íŠ¸
// ============================================

// ì˜¨ë³´ë”© í˜ì´ì§€ (ì²« ë¡œê·¸ì¸ ì‚¬ìš©ì)
import { getCookie, deleteCookie } from 'hono/cookie'

app.get('/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  
  // ì´ë¯¸ ì˜¨ë³´ë”© ì™„ë£Œí•œ ì‚¬ìš©ìëŠ” ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  if (user && (user as any).onboarded === 1) {
    return c.redirect('/')
  }
  
  // ì˜¨ë³´ë”© ì™„ë£Œ í›„ ëŒì•„ê°ˆ URL
  const returnUrl = getCookie(c, 'onboarding_return_url') || '/'
  
  const html = renderOnboardingPage({
    userName: user?.name,
    returnUrl
  })
  
  return c.html(html)
})

// ì˜¨ë³´ë”© ìƒíƒœ ì¡°íšŒ API
app.get('/api/me/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const status = await getOnboardingStatus(c.env.DB, user.id)
    return c.json(status)
  } catch (error) {
    return c.json({ error: 'Failed to get onboarding status' }, 500)
  }
})

// ë‹‰ë„¤ì„ ê°€ìš©ì„± ì²´í¬ API
app.get('/api/nickname/check', async (c) => {
  const value = c.req.query('value')
  
  if (!value || typeof value !== 'string') {
    return c.json({ ok: false, reason: 'invalid', message: 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' })
  }
  
  try {
    const result = await checkNicknameAvailability(c.env.DB, value)
    return c.json(result)
  } catch (error) {
    return c.json({ ok: false, reason: 'invalid', message: 'ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì˜¨ë³´ë”© ì œì¶œ API
app.post('/api/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'Unauthorized' }, 401)
  }
  
  let body: any
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'Invalid JSON body' }, 400)
  }
  
  // IP ë° User-Agent ìˆ˜ì§‘
  const ip = c.req.header('CF-Connecting-IP') || c.req.header('X-Forwarded-For')?.split(',')[0] || undefined
  const ua = c.req.header('User-Agent') || undefined
  
  try {
    const result = await submitOnboarding(c.env.DB, user.id, body, { ip, ua })
    
    if (result.success) {
      // ì˜¨ë³´ë”© ì™„ë£Œ í›„ ë¦¬í„´ URL ì¿ í‚¤ ì‚­ì œ
      deleteCookie(c, 'onboarding_return_url')
    }
    
    return c.json(result)
  } catch (error) {
    return c.json({ success: false, error: 'ì˜¨ë³´ë”© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì•½ê´€ í˜ì´ì§€
app.get('/legal/terms', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderTermsPage({ userMenuHtml }))
})

// ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€
app.get('/legal/privacy', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderPrivacyPage({ userMenuHtml }))
})

// Help Center
app.get('/help', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderHelpPage({ userMenuHtml }))
})


// ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (ì‚¬ìš©ì ëŒ€ìƒ â€” feat/fixë§Œ í•„í„°ë§)
app.get('/releases', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)

  // --- GitHub APIì—ì„œ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸° (cf.cacheTtlë¡œ ì—£ì§€ ìºì‹±) ---
  interface ReleaseNote { type: 'feat' | 'fix' | 'improve'; message: string; date: string; dateKey: string }

  let notes: ReleaseNote[] = []
  let fetchError = false

  const typeMap: Record<string, ReleaseNote['type']> = {
    feat: 'feat', fix: 'fix', improve: 'improve', update: 'improve', perf: 'improve'
  }

  const KV_RELEASE_KEY = 'release-notes-v5'

  const parseCommitMessage = (msg: string, iso: string): ReleaseNote | null => {
    const firstLine = msg.split('\n')[0].trim()
    const match = firstLine.match(/^(feat|fix|improve|update|perf)(\(.+?\))?:\s*(.+)$/i)
    if (!match) return null
    const rawType = match[1].toLowerCase()
    const type = typeMap[rawType] || 'improve'
    const body = match[3].trim()
    if (!body) return null
    const d = new Date(iso)
    const kst = new Date(d.getTime() + 9 * 60 * 60 * 1000)
    const dateKey = `${kst.getFullYear()}-${String(kst.getMonth() + 1).padStart(2, '0')}`
    return { type, message: body.length > 100 ? body.slice(0, 97) + '...' : body, date: iso, dateKey }
  }

  try {
    // 1) KV ìºì‹œ í™•ì¸ (ê°€ì¥ ì•ˆì •ì )
    const kvData = await c.env.KV.get(KV_RELEASE_KEY).catch(() => null)
    if (kvData) {
      notes = JSON.parse(kvData) as ReleaseNote[]
    } else {
      // 2) GitHub API í˜¸ì¶œ (cf.cacheTtlë¡œ Cloudflare ì—£ì§€ ìºì‹± â€” rate limit ìš°íšŒ)
      const apiUrl = 'https://api.github.com/repos/Tok2coder/Careerwiki/commits?sha=main&per_page=100'
      const ghHeaders: Record<string, string> = { 'Accept': 'application/vnd.github.v3+json', 'User-Agent': 'Careerwiki-Releases' }
      const ghToken = (c.env as any).GITHUB_TOKEN as string | undefined
      if (ghToken) ghHeaders['Authorization'] = `token ${ghToken}`

      const apiRes = await fetch(apiUrl, {
        headers: ghHeaders,
        cf: { cacheTtl: 7200, cacheEverything: true },
      } as any)

      if (apiRes.ok) {
        const commits = await apiRes.json() as any[]
        for (const cm of commits) {
          const msg: string = cm.commit?.message || ''
          const iso = cm.commit?.author?.date || cm.commit?.committer?.date || ''
          const note = parseCommitMessage(msg, iso)
          if (note) notes.push(note)
        }
        // KVì— ì €ì¥ (24ì‹œê°„)
        if (notes.length > 0) {
          try { await c.env.KV.put(KV_RELEASE_KEY, JSON.stringify(notes), { expirationTtl: 86400 }) } catch {}
        }
      } else {
        fetchError = true
      }
    }
  } catch (e) {
    fetchError = true
  }

  const esc = (s: string): string => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')

  const typeLabel: Record<string, { icon: string; label: string; color: string; bg: string }> = {
    feat:    { icon: 'fa-wand-magic-sparkles', label: 'ìƒˆ ê¸°ëŠ¥',  color: '#a78bfa', bg: 'rgba(167,139,250,0.15)' },
    fix:     { icon: 'fa-bug',      label: 'ë²„ê·¸ ìˆ˜ì •', color: '#f87171', bg: 'rgba(248,113,113,0.15)' },
    improve: { icon: 'fa-arrow-up', label: 'ê°œì„ ',     color: '#60a5fa', bg: 'rgba(96,165,250,0.15)' },
  }

  // ë‚ ì§œë³„ ê·¸ë£¹í•‘
  const grouped = new Map<string, ReleaseNote[]>()
  for (const n of notes) {
    const arr = grouped.get(n.dateKey) || []
    arr.push(n)
    grouped.set(n.dateKey, arr)
  }

  const fmtDateHeader = (key: string): string => {
    const [y, m] = key.split('-').map(Number)
    return `${y}ë…„ ${m}ì›”`
  }

  // ì›” ëª©ë¡ (ì •ë ¬ë¨: ìµœì‹  ë¨¼ì €)
  const monthKeys = [...grouped.keys()]

  // ê° ì›”ë³„ ì¹´ë“œ HTML ìƒì„± (data-month ì†ì„±ìœ¼ë¡œ JS í† ê¸€)
  let sectionsHtml = ''
  if (fetchError || notes.length === 0) {
    sectionsHtml = `
      <div class="glass-card rounded-xl p-8 text-center" style="background:rgba(26,26,46,0.82);border:1px solid rgba(148,163,184,0.22);backdrop-filter:blur(14px);">
        <i class="fas fa-box-open text-3xl text-slate-400 mb-4 block"></i>
        <p class="text-white font-semibold mb-2">${fetchError ? 'ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' : 'ì•„ì§ ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤'}</p>
        <p class="text-sm text-slate-400">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
      </div>`
  } else {
    for (const [dateKey, items] of grouped) {
      const isFirst = dateKey === monthKeys[0]
      const itemsHtml = items.map(n => {
        const t = typeLabel[n.type] || typeLabel.improve
        return `
          <div class="flex items-start gap-3 py-3">
            <span class="flex-shrink-0 mt-0.5 w-7 h-7 rounded-lg flex items-center justify-center text-xs" style="background:${t.bg};color:${t.color};"><i class="fas ${t.icon}"></i></span>
            <div class="flex-1 min-w-0">
              <p class="text-white text-sm sm:text-base leading-relaxed">${esc(n.message)}</p>
            </div>
            <span class="flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium" style="background:${t.bg};color:${t.color};">${t.label}</span>
          </div>`
      }).join('<div style="border-top:1px solid rgba(148,163,184,0.1);"></div>')

      const fc = items.filter(n => n.type === 'feat').length
      const xc = items.filter(n => n.type === 'fix').length
      const ic = items.filter(n => n.type === 'improve').length

      sectionsHtml += `
        <div class="rl-month" data-month="${dateKey}" data-feat="${fc}" data-fix="${xc}" data-improve="${ic}" style="${isFirst ? '' : 'display:none;'}">
          <div class="glass-card rounded-xl px-4 sm:px-5" style="background:rgba(26,26,46,0.82);border:1px solid rgba(148,163,184,0.15);backdrop-filter:blur(14px);">
            ${itemsHtml}
          </div>
        </div>`
    }
  }

  // ë“œë¡­ë‹¤ìš´ ì˜µì…˜
  const dropdownOptions = monthKeys.map((k, i) => {
    const [y, m] = k.split('-').map(Number)
    const count = grouped.get(k)!.length
    return `<option value="${k}"${i === 0 ? ' selected' : ''}>${y}ë…„ ${m}ì›” (${count}ê±´)</option>`
  }).join('')

  return c.html(`<!DOCTYPE html>
  <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>ì—…ë°ì´íŠ¸ ë‚´ì—­ | Careerwiki</title>
      <link href="/static/style.css" rel="stylesheet" />
      <link rel="stylesheet" href="/static/tailwind.css">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
      ${renderNavStyles()}
    </head>
    <body class="bg-wiki-bg text-wiki-text min-h-screen">
      ${renderNav(userMenuHtml)}
      <main class="max-w-[1400px] mx-auto px-4 pt-20 pb-10 sm:pt-12">
        <header class="mb-8 space-y-3">
          <div class="flex items-center gap-2 text-xs text-blue-300 font-semibold uppercase tracking-[0.2em]">
            <i class="fas fa-rocket"></i><span>ì—…ë°ì´íŠ¸ ë‚´ì—­</span>
          </div>
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <h1 class="text-3xl md:text-4xl font-bold text-white">ì—…ë°ì´íŠ¸ ë‚´ì—­</h1>
            <p class="text-wiki-muted text-[15px]">Careerwikiì— ì¶”ê°€ëœ ìƒˆ ê¸°ëŠ¥ê³¼ ê°œì„  ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
          </div>
        </header>
        ${monthKeys.length > 0 ? `
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
          <div id="rlStats" class="flex flex-wrap justify-center gap-3">
          </div>
          <select id="rlMonthSelect" onchange="rlSwitch(this.value)" class="px-4 py-2 rounded-lg text-sm font-medium" style="background:rgba(26,26,46,0.82);border:1px solid rgba(148,163,184,0.25);color:#e6e8f5;">
            ${dropdownOptions}
          </select>
        </div>` : ''}
        <div id="rlSections">
          ${sectionsHtml}
        </div>
      </main>
      ${renderNavScripts()}
      <script>
      function rlSwitch(month){
        document.querySelectorAll('.rl-month').forEach(function(el){
          el.style.display=el.getAttribute('data-month')===month?'':'none';
        });
        var active=document.querySelector('.rl-month[data-month="'+month+'"]');
        if(!active)return;
        var fc=+active.getAttribute('data-feat'),xc=+active.getAttribute('data-fix'),ic=+active.getAttribute('data-improve');
        document.getElementById('rlStats').innerHTML=
          '<div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs" style="background:rgba(167,139,250,0.12);color:#a78bfa;"><i class="fas fa-wand-magic-sparkles"></i><span>ìƒˆ ê¸°ëŠ¥ '+fc+'</span></div>'+
          '<div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs" style="background:rgba(248,113,113,0.12);color:#f87171;"><i class="fas fa-bug"></i><span>ë²„ê·¸ ìˆ˜ì • '+xc+'</span></div>'+
          '<div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs" style="background:rgba(96,165,250,0.12);color:#60a5fa;"><i class="fas fa-arrow-up"></i><span>ê°œì„  '+ic+'</span></div>';
      }
      rlSwitch(document.getElementById('rlMonthSelect')?.value||'');
      </script>
    </body>
  </html>`)
})


// Homepage - Google style with menu buttons
app.get('/', (c) => {
  // Phase 3 Day 4: ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  
  const content = `
    <div class="w-full min-h-screen flex flex-col">
        <header class="homepage-header">
            <div class="mx-auto w-full max-w-[1400px] px-3 flex items-center">
                <div class="flex-grow"></div>
                <div class="flex items-center gap-0">
                    <a href="/help" class="header-icon-button px-2" title="ë„ì›€ë§">
                        <i class="fas fa-question-circle text-base"></i>
                    </a>
                    ${renderUserMenu(userData)}
                </div>
            </div>
        </header>

        <section class="hero-shell flex-grow">
            <div class="hero-inner">
                <div class="flex justify-center">
                    ${getLogoSVG('large')}
                </div>
                <div class="search-shell">
                    <form action="/search" method="get">
                        <div class="search-bar">
                            <input type="text" name="q" 
                                   placeholder="ì§ì—… Â· ì „ê³µ ê²€ìƒ‰" 
                                   autofocus>
                            <button type="submit" class="search-button" aria-label="ê²€ìƒ‰">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <div class="pillar-grid w-full">
                    <a href="/analyzer" class="menu-button text-center group">
                        <i class="fas fa-brain text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">AI ì¶”ì²œ</div>
                    </a>
                    <a href="/job" class="menu-button text-center group">
                        <i class="fas fa-briefcase text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">ì§ì—…ìœ„í‚¤</div>
                    </a>
                    <a href="/major" class="menu-button text-center group">
                        <i class="fas fa-university text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">ì „ê³µìœ„í‚¤</div>
                    </a>
                    <a href="/howto" class="menu-button text-center group">
                        <i class="fas fa-route text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">HowTo</div>
                    </a>
                </div>
            </div>
        </section>
    </div>
  `
  
  return c.html(renderLayout(content, 'Careerwiki - AI ì§„ë¡œ ë¶„ì„ í”Œë«í¼', 'AI ê¸°ë°˜ ê°œì¸ ë§ì¶¤í˜• ì§„ë¡œ ë¶„ì„ê³¼ ì „ëµ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•˜ëŠ” í”Œë«í¼', true, { user: userData, context: c }))
})

// AI Analyzer Page - Choose between Job or Major (ë¡œê·¸ì¸ ë¶ˆí•„ìš” - ì•ˆë‚´ë§Œ)
app.get('/analyzer', (c) => {
  const user = c.get('user')
  const isLoggedIn = !!user

  const bannerHtml = isLoggedIn
    ? `<div class="mt-8 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-amber-400 text-lg"></i>
                <div>
                    <p class="text-amber-300 font-medium">ë°˜ë“œì‹œ ë³¸ì¸ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”</p>
                    <p class="text-sm text-amber-200/70">ì…ë ¥í•œ ì •ë³´ëŠ” í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •ì— ì €ì¥ë©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒì˜ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•˜ë©´ ë°ì´í„°ê°€ ì„ì¼ ìˆ˜ ìˆì–´ìš”.</p>
                </div>
            </div>
        </div>`
    : `<div class="mt-8 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl text-center">
            <p class="text-amber-400 font-semibold mb-1">
                <i class="fas fa-lock mr-2"></i>AI ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
            </p>
            <p class="text-wiki-muted text-sm">
                ë¡œê·¸ì¸í•˜ì‹œë©´ ë¶„ì„ ê²°ê³¼ ì €ì¥, ì´ë ¥ì„œ ì²¨ë¶€, ë§ì¶¤ ì¶”ì²œ ë“±ì˜ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>`

  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 pt-0 md:pt-2">
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white">
                <i class="fas fa-brain mr-2 text-wiki-primary"></i>AI ì¶”ì²œ
            </h1>
            <p class="text-wiki-muted text-sm md:text-base mt-2 max-w-lg mx-auto leading-relaxed">
                LLM ì‹¬ì¸µ ì¸í„°ë·°ì™€ ë²¡í„° ì‹œë§¨í‹± ê²€ìƒ‰ìœ¼ë¡œ<br class="hidden md:inline"> ìˆ˜ì²œ ê°œì˜ ì§ì—…Â·ì „ê³µ ì¤‘ ë‚˜ì—ê²Œ ë§ëŠ” ì§„ë¡œë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤
            </p>
        </div>

        <div class="glass-card p-6 md:p-8 rounded-2xl">
            <h2 class="text-xl md:text-2xl font-bold mb-6 text-center">ë¬´ì—‡ì„ ì¶”ì²œë°›ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</h2>

            <div class="grid md:grid-cols-2 gap-6 md:gap-8">
                <!-- Job Recommendation -->
                <a href="/analyzer/job" class="glass-card p-8 rounded-xl hover-glow block text-center group relative overflow-hidden">
                    <i class="fas fa-briefcase text-6xl mb-4 text-wiki-secondary group-hover:text-wiki-primary transition"></i>
                    <h3 class="text-2xl font-bold mb-3">ì§ì—… ì¶”ì²œ</h3>
                    <p class="text-wiki-muted">
                        ë‚˜ì˜ ì„±í–¥, ëŠ¥ë ¥, ê°€ì¹˜ê´€ì„ ë°”íƒ•ìœ¼ë¡œ<br>
                        ì í•©í•œ ì§ì—…ì„ AIê°€ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤
                    </p>
                    <div class="mt-4 flex items-center justify-center gap-2">
                        <span class="text-wiki-muted line-through text-sm">â‚©50,000</span>
                        <span class="text-emerald-400 font-bold text-lg">ë¬´ë£Œ</span>
                    </div>
                    <p class="text-xs text-emerald-400/70 mt-1">ë² íƒ€ ê¸°ê°„ í•œì •</p>
                    <div class="mt-4">
                        <span class="px-6 py-3 bg-wiki-primary text-white rounded-lg inline-block group-hover:bg-blue-600 transition">
                            ì§ì—… ì¶”ì²œë°›ê¸° â†’
                        </span>
                    </div>
                </a>

                <!-- Major Recommendation -->
                <a href="/analyzer/major" class="glass-card p-8 rounded-xl hover-glow block text-center group relative overflow-hidden">
                    <i class="fas fa-university text-6xl mb-4 text-wiki-secondary group-hover:text-wiki-primary transition"></i>
                    <h3 class="text-2xl font-bold mb-3">ì „ê³µ ì¶”ì²œ</h3>
                    <p class="text-wiki-muted">
                        ë‚˜ì˜ ì ì„±, í¥ë¯¸, ëª©í‘œë¥¼ ë¶„ì„í•˜ì—¬<br>
                        ìµœì ì˜ ì „ê³µì„ AIê°€ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤
                    </p>
                    <div class="mt-4 flex items-center justify-center gap-2">
                        <span class="text-wiki-muted line-through text-sm">â‚©10,000</span>
                        <span class="text-emerald-400 font-bold text-lg">ë¬´ë£Œ</span>
                    </div>
                    <p class="text-xs text-emerald-400/70 mt-1">ë² íƒ€ ê¸°ê°„ í•œì •</p>
                    <div class="mt-4">
                        <span class="px-6 py-3 bg-wiki-primary text-white rounded-lg inline-block group-hover:bg-blue-600 transition">
                            ì „ê³µ ì¶”ì²œë°›ê¸° â†’
                        </span>
                    </div>
                </a>
            </div>
            
            ${bannerHtml}
            
            <div class="mt-6 text-center text-wiki-muted text-sm">
                <p>AI ì¶”ì²œì€ ê°œì¸ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë©°, ê²°ê³¼ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI ì¶”ì²œ - Careerwiki'))
})

// AI Job Analyzer v2.0.0 (Stage-based Universal Intake + Follow-up) - ë¡œê·¸ì¸ í•„ìˆ˜
app.get('/analyzer/job', requireAuth, (c) => {
  const user = c.get('user')
  const debugMode = c.req.query('debug') === 'true' || isAdminRole(user?.role)
  
  // ============================================
  // í†µí•© ì§ˆë¬¸ ë°ì´í„° (3ë‹¨ê³„ êµ¬ì¡°: í”„ë¡œí•„ â†’ ì‹¬ì¸µ â†’ ê²°ê³¼)
  // Step 1 í”„ë¡œí•„ì—ì„œ 5ì¶• ìƒíƒœ + ì•„ë˜ í†µí•© ì§ˆë¬¸ì„ í•¨ê»˜ ìˆ˜ì§‘
  // ============================================
  const universalQuestionsJson = JSON.stringify([
    // ============================================
    // 1. ê´€ì‹¬ë¶„ì•¼ (í†µí•©: ë¯¸ë‹ˆëª¨ë“ˆ interest + ê¸°ì¡´ univ_interest)
    // ============================================
    { id: 'univ_interest', order: 1, text: 'ì–´ë–¤ ê²ƒì— ê´€ì‹¬ì´ ìˆê±°ë‚˜ ì¬ë¯¸ìˆë‹¤ê³  ëŠë¼ë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'problem_solving', label: 'ë¬¸ì œí•´ê²°/ë¶„ì„', emoji: 'ğŸ”', token: 'problem_solving' },
      { value: 'creating', label: 'ì°½ì‘/ë””ìì¸', emoji: 'ğŸ¨', token: 'creating' },
      { value: 'helping', label: 'ì‚¬ëŒ/ì†Œí†µ/ë•ê¸°', emoji: 'ğŸ¤', token: 'helping_teaching' },
      { value: 'data', label: 'ë°ì´í„°/ìˆ«ì', emoji: 'ğŸ“Š', token: 'data_numbers' },
      { value: 'tech', label: 'ê¸°ìˆ /IT', emoji: 'ğŸ’»', token: 'tech' },
      { value: 'organizing', label: 'ì¡°ì§/ê´€ë¦¬', emoji: 'ğŸ“‹', token: 'organizing' },
      { value: 'influencing', label: 'ì˜í–¥ë ¥/ì„¤ë“', emoji: 'ğŸ“¢', token: 'influencing' },
      { value: 'nature', label: 'ìì—°/í™˜ê²½', emoji: 'ğŸŒ¿', token: 'nature' },
      { value: 'health', label: 'ê±´ê°•/ì˜ë£Œ', emoji: 'ğŸ¥', token: 'health' },
      { value: 'media', label: 'ë¯¸ë””ì–´/ì½˜í…ì¸ ', emoji: 'ğŸ“±', token: 'media' },
    ], allow_unknown: true, unknown_label: 'ì˜ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.interest.keywords', required: true, max_selections: 3 },

    // ============================================
    // 2. ì¤‘ìš” ê°€ì¹˜ (í†µí•©: ë¯¸ë‹ˆëª¨ë“ˆ value + ê¸°ì¡´ univ_priority)
    // ============================================
    { id: 'univ_priority', order: 2, text: 'ì¼ì—ì„œ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê±´ ë­”ê°€ìš”?', ui_type: 'chips', options: [
      { value: 'autonomy', label: 'ììœ¨/ììœ ', emoji: 'ğŸ¦‹', token: 'autonomy' },
      { value: 'growth', label: 'ì„±ì¥/ë°œì „', emoji: 'ğŸŒ±', token: 'growth' },
      { value: 'stability', label: 'ì•ˆì •/ì˜ˆì¸¡ê°€ëŠ¥', emoji: 'ğŸ ', token: 'stability' },
      { value: 'income', label: 'ë†’ì€ ìˆ˜ì…', emoji: 'ğŸ’°', token: 'income' },
      { value: 'meaning', label: 'ì˜ë¯¸/ì‚¬íšŒê¸°ì—¬', emoji: 'ğŸŒ', token: 'meaning' },
      { value: 'recognition', label: 'ì¸ì •/ì˜í–¥ë ¥', emoji: 'â­', token: 'recognition' },
      { value: 'wlb', label: 'ì›Œë¼ë°¸', emoji: 'âš–ï¸', token: 'wlb' },
    ], allow_unknown: true, unknown_label: 'ì•„ì§ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'priority.top1', required: true, max_selections: 2 },

    // ============================================
    // 3. ê°•ì  (í†µí•©: ë¯¸ë‹ˆëª¨ë“ˆ strength + ê¸°ì¡´ univ_strength)
    // ============================================
    { id: 'univ_strength', order: 3, text: 'ì‹¤ì œë¡œ ì˜í•˜ê±°ë‚˜ ë‚¨ë“¤ì´ ì¸ì •í•´ì¤€ ê²ƒì€?', ui_type: 'chips', options: [
      { value: 'analytical', label: 'ë¶„ì„/ë…¼ë¦¬', emoji: 'ğŸ§ ', token: 'analytical' },
      { value: 'creative', label: 'ì°½ì˜/ì•„ì´ë””ì–´', emoji: 'ğŸ’¡', token: 'creative' },
      { value: 'communication', label: 'ì†Œí†µ/ì„¤ëª…', emoji: 'ğŸ’¬', token: 'communication' },
      { value: 'structured_execution', label: 'ê³„íš/ì‹¤í–‰', emoji: 'ğŸ“‘', token: 'structured_execution' },
      { value: 'persistence', label: 'ëˆê¸°/ì¸ë‚´', emoji: 'ğŸ‹ï¸', token: 'persistence' },
      { value: 'fast_learning', label: 'ë¹ ë¥¸ í•™ìŠµ', emoji: 'ğŸ“–', token: 'fast_learning' },
      { value: 'empathy', label: 'ê³µê°/ë°°ë ¤', emoji: 'â¤ï¸', token: 'empathy' },
      { value: 'leadership', label: 'ë¦¬ë”ì‹­', emoji: 'ğŸ‘‘', token: 'leadership' },
    ], allow_unknown: true, unknown_label: 'ì˜ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.strength.keywords', required: true, max_selections: 3 },

    // ============================================
    // 4. í”¼í•˜ê³  ì‹¶ì€ ê²ƒ (Soft Dislike - ì„ í˜¸ë„ ë°˜ì˜)
    // ============================================
    { id: 'univ_dislike', order: 4, text: 'ì´ê±´ í”¼í•˜ê³  ì‹¶ë‹¤ê³  ëŠë¼ëŠ” ê²Œ ìˆë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'meeting', label: 'íšŒì˜ ë§ìŒ', emoji: 'ğŸ—£ï¸' },
      { value: 'sales', label: 'ì˜ì—…/ì„¤ë“', emoji: 'ğŸ¤' },
      { value: 'routine', label: 'ë‹¨ìˆœ ë°˜ë³µ', emoji: 'ğŸ”„' },
      { value: 'pressure', label: 'ì••ë°•/ë§ˆê°', emoji: 'â°' },
      { value: 'public', label: 'ë°œí‘œ/ì•ì— ì„œê¸°', emoji: 'ğŸ¤' },
      { value: 'conflict', label: 'ê°ˆë“±/ëŒ€ë¦½', emoji: 'âš¡' },
      { value: 'uncertainty', label: 'ë¶ˆí™•ì‹¤í•¨', emoji: 'â“' },
    ], allow_unknown: true, unknown_label: 'ë”±íˆ ì—†ì–´ìš”', fact_key: 'profile.dislike.keywords', required: true, max_selections: 3 },

    // ============================================
    // 5. ì—…ë¬´ ìŠ¤íƒ€ì¼ (í˜‘ì—…+í™˜ê²½ í†µí•©)
    // ============================================
    { id: 'univ_workstyle_social', order: 5, text: 'ì¼í•  ë•Œ ì–´ë–¤ ë°©ì‹ì´ ë” í¸í•œê°€ìš”?', ui_type: 'chips', options: [
      // í˜‘ì—… ë°©ì‹
      { value: 'solo', label: 'í˜¼ì ì§‘ì¤‘', emoji: 'ğŸ§˜', group: 'collaboration' },
      { value: 'team', label: 'íŒ€ì›Œí¬', emoji: 'ğŸ‘«', group: 'collaboration' },
      // í™˜ê²½ êµ¬ì¡° ì„ í˜¸
      { value: 'structured', label: 'ê·œì¹™/ì ˆì°¨ ìˆëŠ” í™˜ê²½', emoji: 'ğŸ“‹', group: 'structure' },
      { value: 'flexible', label: 'ììœ ë¡œìš´ í™˜ê²½', emoji: 'ğŸ¦‹', group: 'structure' },
    ], allow_unknown: true, unknown_label: 'ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.workstyle', required: true, max_selections: 2 },

    // ============================================
    // 6. ë°°ê²½ ì •ë³´ (ì„ íƒ)
    // ============================================
    { id: 'univ_special_experience', order: 6, text: 'íŠ¹ë³„í•œ ê²½í—˜ì´ë‚˜ ë°°ê²½ì´ ìˆë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'overseas_living', label: 'í•´ì™¸ ê±°ì£¼/ìœ í•™', emoji: 'ğŸŒ' },
      { value: 'license_cert', label: 'ì „ë¬¸ ìê²©ì¦/ë©´í—ˆ', emoji: 'ğŸ“œ' },
      { value: 'startup_experience', label: 'ì°½ì—…/ì‚¬ì—… ê²½í—˜', emoji: 'ğŸš€' },
      { value: 'research_academic', label: 'ì—°êµ¬/í•™ìˆ  ê²½í—˜', emoji: 'ğŸ”¬' },
      { value: 'volunteer_ngo', label: 'ë´‰ì‚¬/NGO í™œë™', emoji: 'ğŸ¤' },
    ], allow_unknown: true, unknown_label: 'ì—†ì–´ìš”', allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.background.special_experience', required: true, max_selections: 3 },

    // ============================================
    // 7. ì–¸ì–´ ëŠ¥ë ¥ (ë³µì›) - ìˆ˜ì¤€ ì„ íƒ í¬í•¨
    // ============================================
    { id: 'univ_language', order: 7, text: 'í•œêµ­ì–´ ì™¸ì— ì‚¬ìš© ê°€ëŠ¥í•œ ì–¸ì–´ê°€ ìˆë‚˜ìš”?', ui_type: 'language_chips', options: [
      { value: 'english', label: 'ì˜ì–´', emoji: 'ğŸ‡ºğŸ‡¸' },
      { value: 'chinese', label: 'ì¤‘êµ­ì–´', emoji: 'ğŸ‡¨ğŸ‡³' },
      { value: 'japanese', label: 'ì¼ë³¸ì–´', emoji: 'ğŸ‡¯ğŸ‡µ' },
      { value: 'spanish', label: 'ìŠ¤í˜ì¸ì–´', emoji: 'ğŸ‡ªğŸ‡¸' },
      { value: 'french', label: 'í”„ë‘ìŠ¤ì–´', emoji: 'ğŸ‡«ğŸ‡·' },
      { value: 'german', label: 'ë…ì¼ì–´', emoji: 'ğŸ‡©ğŸ‡ª' },
      { value: 'vietnamese', label: 'ë² íŠ¸ë‚¨ì–´', emoji: 'ğŸ‡»ğŸ‡³' },
      { value: 'thai', label: 'íƒœêµ­ì–´', emoji: 'ğŸ‡¹ğŸ‡­' },
    ], other_languages: [
      { value: 'indonesian', label: 'ì¸ë„ë„¤ì‹œì•„ì–´' },
      { value: 'russian', label: 'ëŸ¬ì‹œì•„ì–´' },
      { value: 'portuguese', label: 'í¬ë¥´íˆ¬ê°ˆì–´' },
      { value: 'arabic', label: 'ì•„ëì–´' },
      { value: 'hindi', label: 'íŒë””ì–´' },
      { value: 'italian', label: 'ì´íƒˆë¦¬ì•„ì–´' },
      { value: 'dutch', label: 'ë„¤ëœë€ë“œì–´' },
      { value: 'polish', label: 'í´ë€ë“œì–´' },
      { value: 'turkish', label: 'í„°í‚¤ì–´' },
      { value: 'swedish', label: 'ìŠ¤ì›¨ë´ì–´' },
    ], levels: [
      { value: 'basic', label: 'ì¼ìƒíšŒí™”', emoji: 'ğŸ’¬' },
      { value: 'business', label: 'ì—…ë¬´ê°€ëŠ¥', emoji: 'ğŸ’¼' },
      { value: 'native', label: 'ì›ì–´ë¯¼ê¸‰', emoji: 'ğŸ†' },
    ], allow_unknown: true, unknown_label: 'ì—†ì–´ìš”', fact_key: 'profile.background.language', required: true, max_selections: 5 },

    // ============================================
    // ğŸ”¥ Q8. í¬ê¸° ê°€ëŠ¥ì„± (Hard Bias - ë§¤ìš° ì¤‘ìš”)
    // ì „ê³µ vs ì§ì—…, ì•ˆì • vs ì„±ì¥, í˜„ì‹¤ vs ì´ìƒ ë¶„ê¸°
    // ============================================
    { id: 'mm_sacrifice', order: 8, text: 'ì§„ë¡œë¥¼ ìœ„í•´ ê°ìˆ˜í•  ìˆ˜ ìˆëŠ” ê²ƒì€?', ui_type: 'chips', options: [
      { value: 'low_initial_income', label: 'ì´ˆë°˜ ì—°ë´‰ì´ ë‚®ì•„ë„ ê´œì°®ë‹¤', emoji: 'ğŸ“‰', token: 'low_initial_income' },
      { value: 'willing_to_study', label: 'ë‹¤ì‹œ ê³µë¶€/í›ˆë ¨í•˜ëŠ” ê±´ ê´œì°®ë‹¤', emoji: 'ğŸ“š', token: 'willing_to_study' },
      { value: 'field_change_ok', label: 'ì™„ì „íˆ ë‹¤ë¥¸ ë¶„ì•¼ë¡œ ê°€ë„ ê´œì°®ë‹¤', emoji: 'ğŸ”„', token: 'field_change_ok' },
      { value: 'social_pressure_ok', label: 'ì£¼ë³€ì˜ ì‹œì„ ì„ ê°ìˆ˜í•  ìˆ˜ ìˆë‹¤', emoji: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘', token: 'social_pressure_ok' },
      { value: 'no_sacrifice', label: 'ì•„ë¬´ê²ƒë„ í¬ê¸°í•˜ê³  ì‹¶ì§€ ì•Šë‹¤', emoji: 'â›”', token: 'no_sacrifice' },
    ], allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.sacrifice_flags', required: true, max_selections: 2,
       help_text: 'ğŸ’¡ ì´ ì§ˆë¬¸ í•˜ë‚˜ë¡œ ì¶”ì²œ ë°©í–¥ì´ í¬ê²Œ ë‹¬ë¼ì ¸ìš”' },

    // ============================================
    // âš¡ Q9. ì—ë„ˆì§€ ì†Œëª¨ì› (Hard Bias - ìŠ¤íŠ¸ë ˆìŠ¤ íƒ€ì…)
    // ============================================
    { id: 'mm_energy_drain', order: 9, text: 'ì´ëŸ´ ë•Œ ê°€ì¥ ë¹¨ë¦¬ ì§€ì¹˜ë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'people_drain', label: 'ì‚¬ëŒ ìƒëŒ€', emoji: 'ğŸ˜µ', token: 'people_drain' },
      { value: 'cognitive_drain', label: 'ê³„ì† ìƒê°í•´ì•¼ í•˜ëŠ” ì¼', emoji: 'ğŸ§ ', token: 'cognitive_drain' },
      { value: 'time_pressure_drain', label: 'ì‹œê°„ ì••ë°•', emoji: 'â±ï¸', token: 'time_pressure_drain' },
      { value: 'responsibility_drain', label: 'ì±…ì„ì´ í° ê²°ì •', emoji: 'ğŸ“Š', token: 'responsibility_drain' },
      { value: 'repetition_drain', label: 'ë°˜ë³µ ì‘ì—…', emoji: 'ğŸ”', token: 'repetition_drain' },
      { value: 'unpredictability_drain', label: 'ì˜ˆì¸¡ ë¶ˆê°€í•œ ìƒí™©', emoji: 'â“', token: 'unpredictability_drain' },
    ], allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.energy_drain_flags', required: true, max_selections: 2,
       help_text: 'ğŸ’¡ ë²„í‹¸ ìˆ˜ ìˆëŠ” ì§ì—…ì„ ì°¾ëŠ” í•µì‹¬ ì§ˆë¬¸ì´ì—ìš”' },

    // ============================================
    // ğŸ§­ Q10. ì„±ì·¨ í”¼ë“œë°± íƒ€ì… (Soft Bias)
    // ì§ì—… ë§Œì¡±ë„ ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ
    // ============================================
    { id: 'mm_achievement', order: 10, text: 'ì¼ì„ ì˜í•˜ê³  ìˆë‹¤ëŠ” ëŠë‚Œì€ ì–¸ì œ ë“œë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'metric_feedback', label: 'ê²°ê³¼ê°€ ìˆ˜ì¹˜ë¡œ ë³´ì¼ ë•Œ', emoji: 'ğŸ†', token: 'metric_feedback' },
      { value: 'helping_feedback', label: 'ëˆ„êµ°ê°€ì—ê²Œ ì§ì ‘ ë„ì›€ì´ ëì„ ë•Œ', emoji: 'ğŸ™Œ', token: 'helping_feedback' },
      { value: 'problem_solved_feedback', label: 'ì–´ë ¤ìš´ ë¬¸ì œë¥¼ í•´ê²°í–ˆì„ ë•Œ', emoji: 'ğŸ§©', token: 'problem_solved_feedback' },
      { value: 'tangible_output_feedback', label: 'ë‚´ê°€ ë§Œë“  ê²°ê³¼ë¬¼ì´ ë‚¨ì„ ë•Œ', emoji: 'ğŸ¨', token: 'tangible_output_feedback' },
      { value: 'growth_feedback', label: 'ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì„±ì¥í•  ë•Œ', emoji: 'ğŸ“ˆ', token: 'growth_feedback' },
    ], allow_unknown: true, unknown_label: 'ì˜ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.achievement_feedback_top', required: true, max_selections: 2 },

    // ============================================
    // ğŸƒ Q11. ì‹¤í–‰ ì†ë„ ì„±í–¥ (Soft Bias)
    // ìŠ¤íƒ€íŠ¸ì—…/ê¸°íš vs ìš´ì˜/ê´€ë¦¬/ì „ë¬¸ì§ ë¶„ê¸°
    // ============================================
    { id: 'mm_execution', order: 11, text: 'ìƒˆë¡œìš´ ì¼ì„ ì‹œì‘í•  ë•Œ ë‚˜ëŠ”?', ui_type: 'radio', options: [
      { value: 'action_first', label: 'ì¼ë‹¨ í•´ë³´ë©° ë°°ìš°ëŠ” í¸', emoji: 'ğŸš€', token: 'action_first' },
      { value: 'plan_first', label: 'ê³„íšì´ ì„œì•¼ ì‹œì‘í•˜ëŠ” í¸', emoji: 'ğŸ§±', token: 'plan_first' },
      { value: 'depends', label: 'ë‘˜ ë‹¤ ìƒí™© ë”°ë¼ ë‹¤ë¦„', emoji: 'ğŸ”„', token: 'execution_depends' },
    ], fact_key: 'profile.execution_style', required: true },

    // ============================================
    // ğŸŒ Q12. ì˜í–¥ ë²”ìœ„ ì„ í˜¸ (Soft Bias)
    // ì˜ë¯¸ ì§€í–¥ ì§ì—… ì¶”ì²œ ì •í™•ë„ ë³´ê°•
    // ============================================
    { id: 'mm_impact', order: 12, text: 'ë‚´ ì¼ì´ ì˜í–¥ì„ ë¯¸ì¹˜ê¸¸ ë°”ë¼ëŠ” ë²”ìœ„ëŠ”?', ui_type: 'radio', options: [
      { value: 'impact_individual', label: 'ê°œì¸ í•œ ëª…', emoji: 'ğŸ‘¤', token: 'impact_individual' },
      { value: 'impact_team', label: 'ì‘ì€ íŒ€/ì¡°ì§', emoji: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘', token: 'impact_team' },
      { value: 'impact_industry', label: 'íšŒì‚¬/ì‚°ì—…', emoji: 'ğŸ¢', token: 'impact_industry' },
      { value: 'impact_society', label: 'ì‚¬íšŒ ì „ë°˜', emoji: 'ğŸŒ', token: 'impact_society' },
      { value: 'impact_unsure', label: 'ì˜ ëª¨ë¥´ê² ë‹¤', emoji: 'ğŸ¤·', token: 'impact_unsure' },
    ], fact_key: 'profile.impact_scope', required: true },

    // ============================================
    // ğŸ’¥ Q13. ì‹¤íŒ¨ ë°˜ì‘ (Hard Biasê¸‰ ë³´ì •ì)
    // 'ë²„í‹¸ ìˆ˜ ìˆëŠ” ì§ì—…' ê²°ì • í•µì‹¬
    // ============================================
    { id: 'mm_failure', order: 13, text: 'ì¼ì´ ì˜ ì•ˆ ëì„ ë•Œ, ë‚˜ëŠ” ë³´í†µ ì–´ë–¤ ë°˜ì‘ì— ê°€ê¹ë‚˜ìš”?', ui_type: 'radio', options: [
      { value: 'iterate_on_failure', label: 'ë‹¤ì‹œ êµ¬ì¡°ë¥¼ ê³ ì³ë³¸ë‹¤', emoji: 'ğŸ”„', token: 'iterate_on_failure' },
      { value: 'pivot_on_failure', label: 'ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ë¹ ë¥´ê²Œ ë°”ê¾¼ë‹¤', emoji: 'ğŸ§ª', token: 'pivot_on_failure' },
      { value: 'pause_on_failure', label: 'ì ì‹œ ë©ˆì¶”ê³  ì •ë¦¬í•œë‹¤', emoji: 'â¸ï¸', token: 'pause_on_failure' },
      { value: 'emotionally_affected', label: 'í¬ê²Œ í”ë“¤ë¦°ë‹¤', emoji: 'ğŸ’¥', token: 'emotionally_affected' },
    ], allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.failure_response', required: true,
       help_text: 'ğŸ’¡ ìŠ¤íŠ¸ë ˆìŠ¤ ì§ˆë¬¸ê³¼ í•¨ê»˜ ë²„í‹¸ ìˆ˜ ìˆëŠ” ì§ì—…ì„ ì°¾ì•„ìš”' },

    // ============================================
    // ğŸ›¡ï¸ Q14. ë²„íŒ€ ì•µì»¤ (Desire â†” Feasibility ê°ˆë“± í•´ì†Œ)
    // ============================================
    { id: 'mm_anchor', order: 14, text: 'ì•„ë˜ ì¤‘ í•˜ë‚˜ë§Œ ìœ ì§€ëœë‹¤ë©´, í˜ë“¤ì–´ë„ ì¼ì„ ê³„ì†í•  ìˆ˜ ìˆë‹¤ë©´?', ui_type: 'radio', options: [
      { value: 'reward_anchor', label: 'ë³´ìƒì´ ëª…í™•í•¨', emoji: 'ğŸ’°', token: 'reward_anchor' },
      { value: 'growth_anchor', label: 'ì„±ì¥ ì²´ê°', emoji: 'ğŸ“ˆ', token: 'growth_anchor' },
      { value: 'people_anchor', label: 'í•¨ê»˜í•˜ëŠ” ì‚¬ëŒ', emoji: 'ğŸ¤', token: 'people_anchor' },
      { value: 'meaning_anchor', label: 'ì˜ë¯¸/ë°©í–¥ì„±', emoji: 'ğŸ§­', token: 'meaning_anchor' },
      { value: 'stability_anchor', label: 'ì•ˆì •ì„±', emoji: 'ğŸ›¡ï¸', token: 'stability_anchor' },
    ], allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.persistence_anchor', required: true,
       help_text: 'ğŸ’¡ ì‹«ì€ ê²Œ ë§ì§€ë§Œ ì´ê±´ ê²¬ë”˜ë‹¤ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”' },

    // ============================================
    // ğŸ‘ï¸ Q15. íƒ€ì¸ ê¸°ëŒ€ ë°˜ì‘ (ì§ì—… í˜•íƒœ ë¶„ê¸°)
    // ì „ë¬¸ì§ / ì¡°ì§ / í”„ë¦¬ëœì„œ / ì°½ì‘ì§ ë¶„ê¸°
    // ============================================
    { id: 'mm_expectation', order: 15, text: 'ì£¼ë³€ì˜ ê¸°ëŒ€ë‚˜ ê¸°ì¤€ì´ ìˆì„ ë•Œ ë‚˜ëŠ”?', ui_type: 'radio', options: [
      { value: 'external_structure_ok', label: 'ê¸°ì¤€ì´ ìˆìœ¼ë©´ í¸í•˜ë‹¤', emoji: 'ğŸ§±', token: 'external_structure_ok' },
      { value: 'neutral_to_expectation', label: 'ìƒê´€ì—†ë‹¤', emoji: 'ğŸ˜', token: 'neutral_to_expectation' },
      { value: 'expectation_pressure', label: 'ë¶€ë‹´ì´ ëœë‹¤', emoji: 'ğŸ˜£', token: 'expectation_pressure' },
    ], allow_other: true, other_label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)', fact_key: 'profile.external_expectation', required: true },
  ])
  
  // Job Stages ë©”íƒ€ë°ì´í„°
  const jobStagesJson = JSON.stringify([
    { id: 'job_explore', label: 'íƒìƒ‰ ë‹¨ê³„', description: 'ì•„ì§ ê²½í—˜ì´ ê±°ì˜ ì—†ì–´ìš”', emoji: 'ğŸ”' },
    { id: 'job_student', label: 'í•™ìƒ (ì „ê³µ ì—°ê³„)', description: 'í˜„ì¬ í•™ìƒì´ì—ìš”', emoji: 'ğŸ“' },
    { id: 'job_prepare', label: 'ì·¨ì—… ì¤€ë¹„ ì¤‘', description: 'ê³§ ì·¨ì—… ì˜ˆì •ì´ì—ìš”', emoji: 'ğŸ“' },
    { id: 'job_early', label: 'ì´ˆê¸° ì»¤ë¦¬ì–´ (0~3ë…„)', description: 'ì¼ ì‹œì‘í•œ ì§€ ì–¼ë§ˆ ì•ˆ ëì–´ìš”', emoji: 'ğŸŒ±' },
    { id: 'job_mid', label: 'ê²½ë ¥ì (3ë…„+)', description: 'ê²½ë ¥ì´ ì¢€ ìŒ“ì˜€ì–´ìš”', emoji: 'ğŸš€' },
    { id: 'job_transition', label: 'ì „í™˜/ë³µê·€', description: 'ì—…ì¢… ì „í™˜ ë˜ëŠ” ì¬ì·¨ì—…', emoji: 'ğŸ”„' },
    { id: 'job_second', label: 'ì„¸ì»¨ë“œ ì»¤ë¦¬ì–´', description: 'ì€í‡´ í›„ ìƒˆ ì‹œì‘', emoji: 'ğŸŒ…' },
  ])
  
  // ë¯¸ì„±ë…„/íƒìƒ‰ ë‹¨ê³„ ëª©ë¡
  const minorStages = ['job_explore', 'major_child', 'major_elementary', 'major_middle']
  
  // 5ì¶• ìƒíƒœì¢Œí‘œ ë°ì´í„° (Career Tree)
  const roleIdentityOptionsJson = JSON.stringify(ROLE_IDENTITY_OPTIONS)
  const careerStageOptionsJson = JSON.stringify(CAREER_STAGE_OPTIONS)
  const transitionStatusOptionsJson = JSON.stringify(TRANSITION_STATUS_OPTIONS)
  const skillLevelOptionsJson = JSON.stringify(SKILL_LEVEL_OPTIONS)
  const constraintOptionsJson = JSON.stringify(CONSTRAINT_OPTIONS)
  
  // ì „ì´ ì‹ í˜¸ ì§ˆë¬¸ ë°ì´í„°
  const transitionSignalQuestionsJson = JSON.stringify(TRANSITION_SIGNAL_QUESTIONS)
  
  // identity anchor ì§ˆë¬¸ ë°ì´í„°
  const identityAnchorPatternsJson = JSON.stringify(IDENTITY_ANCHOR_PATTERNS)
  
  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 pt-0 md:pt-2">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-center text-white">
            <i class="fas fa-briefcase mr-2 text-wiki-primary"></i>AI ì§ì—… ì¶”ì²œ
            ${debugMode ? '<span class="ml-2 text-sm bg-yellow-500 text-black px-2 py-1 rounded">DEBUG MODE</span>' : ''}
        </h1>

        <!-- Step Indicator (3ë‹¨ê³„: í”„ë¡œí•„â†’ì‹¬ì¸µâ†’ê²°ê³¼) -->
        <div class="flex justify-center items-center gap-2 md:gap-4 mb-6 flex-wrap" id="step-indicator">
            <div class="step-dot flex flex-col items-center active" data-step="1">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-primary text-white rounded-full font-bold text-sm md:text-base">1</span>
                <span class="text-xs mt-1">í”„ë¡œí•„</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="2">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-border text-wiki-muted rounded-full font-bold text-sm md:text-base">2</span>
                <span class="text-xs mt-1">ì‹¬ì¸µ</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="3">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-border text-wiki-muted rounded-full font-bold text-sm md:text-base">3</span>
                <span class="text-xs mt-1">ê²°ê³¼</span>
            </div>
        </div>
        
        <!-- ë³¸ì¸ ê³„ì • ì‚¬ìš© ì•ˆë‚´ ë°°ë„ˆ (Step 1ì—ì„œë§Œ í‘œì‹œ) -->
        <div id="account-warning-banner" class="mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-amber-400 text-lg"></i>
                <div>
                    <p class="text-amber-300 font-medium">ë°˜ë“œì‹œ ë³¸ì¸ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”</p>
                    <p class="text-sm text-amber-200/70">ì…ë ¥í•œ ì •ë³´ëŠ” í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •ì— ì €ì¥ë©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒì˜ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•˜ë©´ ë°ì´í„°ê°€ ì„ì¼ ìˆ˜ ìˆì–´ìš”.</p>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <!-- ============================================ -->
        <div id="loading-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-8 rounded-2xl text-center max-w-sm mx-4">
                <div class="relative w-16 h-16 mx-auto mb-4">
                    <div class="absolute inset-0 border-4 border-wiki-primary/30 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-transparent border-t-wiki-primary rounded-full animate-spin"></div>
                </div>
                <p id="loading-message" class="text-lg font-semibold text-white mb-2">ì²˜ë¦¬ ì¤‘...</p>
                <p id="loading-submessage" class="text-sm text-wiki-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
        </div>
        
        <!-- ì´ì–´í•˜ê¸°/ìƒˆë¡œì‹œì‘ ëª¨ë‹¬ -->
        <div id="continue-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-wiki-border/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-500 to-wiki-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-history text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">ì§„í–‰ ì¤‘ì¸ ë¶„ì„ì´ ìˆìŠµë‹ˆë‹¤</h3>
                    <p class="text-wiki-muted text-sm" id="continue-modal-info">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="continueFromDraft()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-wiki-primary text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-play mr-2"></i>ì´ì–´ì„œ í•˜ê¸°
                    </button>
                    <button type="button" onclick="showRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-redo mr-2"></i>ìƒˆë¡œ ì‹œì‘í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ìƒˆë¡œ ì‹œì‘ ê²½ê³  ëª¨ë‹¬ -->
        <div id="restart-warning-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-amber-500/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">ì •ë§ ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                    <p class="text-wiki-muted text-sm">
                        ì´ì „ì— ì…ë ¥í•œ ëª¨ë“  ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤.<br>
                        ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="hideRestartWarning()"
                            class="flex-1 px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition whitespace-nowrap">
                        ì·¨ì†Œ
                    </button>
                    <button type="button" onclick="confirmRestart()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:opacity-90 transition whitespace-nowrap">
                        ì‚­ì œ í›„ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 0: ì¶”ì²œ ìœ í˜• ì„ íƒ (ì´ë¯¸ /analyzerì—ì„œ ì„ íƒë¨ - ìˆ¨ê¹€) -->
        <!-- ============================================ -->
        <div id="step0" class="step-content hidden glass-card p-8 rounded-2xl mb-6">
            <!-- /analyzer/jobìœ¼ë¡œ ì§ì ‘ ì ‘ê·¼í–ˆìœ¼ë¯€ë¡œ ìœ í˜• ì„ íƒì€ ìƒëµ -->
        </div>
        
        <!-- ============================================ -->
        <!-- Step 1: í”„ë¡œí•„ ë‹¨ê³„ (2ë¼ìš´ë“œ êµ¬ì¡°) -->
        <!-- ============================================ -->
        <div id="step1" class="step-content">
            <!-- ========================================== -->
            <!-- í”„ë¡œí•„ 1-1: ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš” (5ì¶• ìƒíƒœì¢Œí‘œ) -->
            <!-- ========================================== -->
            <div id="profile-step-1" class="glass-card p-6 md:p-8 rounded-2xl mb-6">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2));">
                        <span class="text-xs text-purple-300">í”„ë¡œí•„ 1/2</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300">
                        <i class="fas fa-user-circle text-wiki-primary mr-3"></i>ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”
                    </h2>
                    <p class="text-wiki-muted mt-2">í˜„ì¬ ìƒí™©ì„ íŒŒì•…í•´ìš” (1~2ë¶„)</p>
                </div>
                
                <!-- ì´ë ¥ì„œ ì—…ë¡œë“œ ì„¹ì…˜ (ì„ íƒì‚¬í•­) -->
                <div class="mb-8 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px dashed rgba(99,102,241,0.3);">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">ì´ë ¥ì„œë¡œ ë¹ ë¥´ê²Œ ì‹œì‘í•˜ê¸°</h3>
                            <p class="text-xs" style="color: rgb(148,163,184)">PDF ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ì•„ë˜ í•­ëª©ì„ ìë™ìœ¼ë¡œ ì±„ì›Œë“œë ¤ìš”</p>
                        </div>
                        <span class="ml-auto px-3 py-1 text-xs rounded-full" style="background-color: rgba(99,102,241,0.2); color: rgb(165,180,252);">ì„ íƒì‚¬í•­</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="file" id="resume-upload" accept=".pdf" class="hidden" onchange="handleResumeUpload(this)">
                            <div class="flex items-center justify-center gap-3 px-4 py-3 rounded-xl border-2 border-dashed transition-all hover:border-indigo-400"
                                 style="background-color: rgba(26,26,46,0.5); border-color: rgba(99,102,241,0.3);">
                                <i class="fas fa-cloud-upload-alt text-xl" style="color: rgb(165,180,252);"></i>
                                <span style="color: rgb(148,163,184);">PDF íŒŒì¼ ì„ íƒ</span>
                            </div>
                        </label>
                        
                        <div id="resume-status" class="hidden flex items-center gap-2 px-4 py-3 rounded-xl" style="background-color: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);">
                            <i class="fas fa-check-circle text-emerald-400"></i>
                            <span class="text-emerald-400 text-sm" id="resume-status-text">ë¶„ì„ ì™„ë£Œ!</span>
                        </div>
                    </div>
                    
                    <p class="text-xs mt-2" style="color: rgb(100,116,139);">
                        <i class="fas fa-info-circle mr-1"></i>
                        íŒŒì¼ì€ ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ë¶„ì„ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì„ì‹œì €ì¥ ì‹œ ë¶„ì„ ê²°ê³¼ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>
                    
                    <div id="resume-loading" class="hidden mt-3 flex items-center justify-center gap-3 py-3">
                        <i class="fas fa-spinner fa-spin text-indigo-400"></i>
                        <span style="color: rgb(165,180,252);">ì´ë ¥ì„œ ë¶„ì„ ì¤‘...</span>
                    </div>
                    
                    <div id="resume-error" class="hidden mt-3 p-3 rounded-lg" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);">
                        <p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i><span id="resume-error-text"></span></p>
                    </div>
                </div>
                
                <!-- 5ì¶• ìƒíƒœì¢Œí‘œ ì…ë ¥ ì˜ì—­ -->
                <div class="space-y-8" id="career-state-form">
                
                <!-- ì¶• 1: ì—­í•  ì •ì²´ì„± -->
                <div class="state-axis-section" data-axis="role_identity">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-wiki-primary to-wiki-secondary rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">1</div>
                        <h3 class="text-lg font-bold">í˜„ì¬ ë‚˜ëŠ”?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="role-options">
                <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
            </div>
            
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 2: ê²½ë ¥ ì—°ì°¨ -->
                <div class="state-axis-section" data-axis="career_stage_years">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">2</div>
                        <h3 class="text-lg font-bold">ê²½ë ¥ì€?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="career-stage-options">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 3: í˜„ì¬ ëª©í‘œ (ë‹¤ì¤‘ ì„ íƒ) -->
                <div class="state-axis-section" data-axis="transition_status">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">3</div>
                        <h3 class="text-lg font-bold">í˜„ì¬ ëª©í‘œëŠ”?</h3>
                        <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">ë³µìˆ˜ ì„ íƒ</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">ì›í•˜ëŠ” ëª©í‘œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="transition-status-options">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 4: ìˆ™ë ¨ë„ (ê´€ì‹¬ ë¶„ì•¼ ê¸°ì¤€) -->
                <div class="state-axis-section" data-axis="skill_level">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">4</div>
                        <h3 class="text-lg font-bold">ê´€ì‹¬ ë¶„ì•¼ì—ì„œì˜ ìˆ™ë ¨ë„ëŠ”?</h3>
                    </div>
                    <div class="ml-11 mb-4 p-3 bg-violet-500/10 rounded-lg border border-violet-500/20">
                        <p class="text-sm text-violet-300">
                            <i class="fas fa-lightbulb mr-2"></i>
                            í˜„ì¬ ê²½ë ¥ê³¼ ë¬´ê´€í•˜ê²Œ, <strong>ì•ìœ¼ë¡œ ê°€ê³  ì‹¶ì€ ë¶„ì•¼</strong> ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”
                        </p>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3" id="skill-level-options">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 5: ì œì•½ ì¡°ê±´ (ë‹¤ì¤‘ ì„ íƒ) -->
                <div class="state-axis-section" data-axis="constraints">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">5</div>
                        <h3 class="text-lg font-bold">í˜„ì¬ ì œì•½ì´ ìˆë‚˜ìš”?</h3>
                        <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full">ì„ íƒì‚¬í•­</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">í•´ë‹¹í•˜ëŠ” ì œì•½ì„ ì„ íƒí•˜ë©´ ë§ì¶¤ ì¶”ì²œì— ë°˜ì˜ë©ë‹ˆë‹¤</p>
                    <div class="max-w-2xl mx-auto" id="constraint-options">
                        <!-- JSë¡œ ë™ì  ìƒì„± (ì¹´ë“œí˜• ì•„ì½”ë””ì–¸) -->
                    </div>
                </div>
                
                </div>
                
                <!-- í”„ë¡œí•„ 1-1 í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="flex justify-center gap-3 pt-8 mt-6 border-t border-wiki-border/30">
                    <a href="/analyzer"
                       class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>ìœ í˜• ë‹¤ì‹œ ì„ íƒ
                    </a>
                    <button type="button" onclick="saveDraftNow()" id="profile1-save-btn"
                            class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                        <i class="fas fa-save mr-2 text-emerald-400"></i>ì„ì‹œì €ì¥
                    </button>
                    <button type="button" id="profile1-next-btn" onclick="goToProfileStep2()"
                            class="px-10 py-4 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold rounded-xl shadow-lg shadow-wiki-primary/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-wiki-primary/40 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ
                    </button>
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- í”„ë¡œí•„ 1-2: ë‚˜ë¥¼ ì•Œì•„ê°€ê¸° (í†µí•© ì§ˆë¬¸) -->
            <!-- ========================================== -->
            <div id="profile-step-2" class="glass-card p-6 md:p-8 rounded-2xl mb-6 hidden">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(249,115,22,0.2));">
                        <span class="text-xs text-amber-300">í”„ë¡œí•„ 2/2</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-orange-300">
                        <i class="fas fa-compass text-amber-400 mr-3"></i>ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°
                    </h2>
                    <p class="text-wiki-muted mt-2">ê° ì§ˆë¬¸ì—ì„œ ê°€ì¥ ëŒë¦¬ëŠ” ê²ƒì„ ì„ íƒí•´ì£¼ì„¸ìš” (2~3ë¶„)</p>
                </div>
                
                <!-- í†µí•© ì§ˆë¬¸ ì»¨í…Œì´ë„ˆ -->
                <div class="space-y-6" id="integrated-questions-section">
                    <div id="integrated-questions-container">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <!-- í”„ë¡œí•„ 1-2 í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="flex justify-center gap-3 pt-8 mt-6 border-t border-wiki-border/30">
                    <button type="button" onclick="goToProfileStep1()"
                            class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>ì´ì „
                    </button>
                    <button type="button" onclick="saveDraftNow()" id="profile2-save-btn"
                            class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                        <i class="fas fa-save mr-2 text-emerald-400"></i>ì„ì‹œì €ì¥
                    </button>
                    <button type="button" id="step1-next-btn" onclick="goToStep2Direct()" disabled
                            class="px-10 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl shadow-lg shadow-amber-500/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-amber-500/40 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-arrow-right mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ìœ¼ë¡œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 2: ì‹¬ì¸µ ì§ˆë¬¸ (LLM Follow-up) -->
        <!-- ============================================ -->
        <div id="step2" class="step-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-user-astronaut text-purple-400 mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ (1~2ë¶„)
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm" id="step2-subtitle">
                ë” ì •í™•í•œ ì¶”ì²œì„ ìœ„í•œ ë§ì¶¤ ì§ˆë¬¸ì´ì—ìš”
            </p>
            
            <div id="followup-questions-form" class="space-y-6">
                <!-- JSë¡œ ë™ì  ìƒì„± -->
            </div>
            
            <div class="flex justify-center gap-3 pt-6">
                <button type="button" id="step2-prev-btn"
                        class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                    <i class="fas fa-arrow-left mr-2"></i>ì´ì „
                </button>
                <button type="button" onclick="saveDraftNow()" id="step2-save-btn"
                        class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                    <i class="fas fa-save mr-2 text-emerald-400"></i>ì„ì‹œì €ì¥
                </button>
                <button type="button" id="analyze-btn"
                        class="px-12 py-4 bg-gradient-to-r from-purple-500 to-wiki-secondary text-white font-bold rounded-xl hover-glow transition transform hover:scale-105">
                    <i class="fas fa-magic mr-2"></i>AI ì¶”ì²œ ë°›ê¸°
                </button>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 3: ê²°ê³¼ ì˜ì—­ -->
        <!-- ============================================ -->
        <div id="step3" class="step-content hidden">
            <!-- User Insight ì¹´ë“œ -->
            <div id="user-insight-card" class="glass-card p-6 rounded-2xl mb-6 border border-purple-500/50 hidden">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">âœ¨</span>
                    <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        ë‹¹ì‹ ì— ëŒ€í•œ ì¸ì‚¬ì´íŠ¸
                    </span>
                </h2>
                <p id="insight-summary" class="text-lg mb-4">-</p>
                
                <div id="insight-traits" class="space-y-3 mb-4">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
                
                <div id="insight-applied-facts" class="text-sm text-wiki-muted border-t border-wiki-border pt-3 hidden">
                    <span class="font-semibold">ì ìš©ëœ ì •ë³´:</span>
                    <span id="insight-facts-list">-</span>
                </div>
            </div>
            
            <!-- Confidence UI: ê·¼ê±° ê°•ë„ + ê²°ì •ë³€ìˆ˜ -->
            <div id="confidence-card" class="glass-card p-6 rounded-2xl mb-6 border border-emerald-500/30 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-emerald-400"></i>
                    <span>ì¶”ì²œ ê·¼ê±° ê°•ë„</span>
                </h2>
                
                <!-- ê·¼ê±° ê°•ë„ ê²Œì´ì§€ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-wiki-muted">ì‹ ë¢°ë„</span>
                        <span id="confidence-score-text" class="text-lg font-bold text-emerald-400">--%</span>
                    </div>
                    <div class="w-full bg-wiki-bg rounded-full h-3 overflow-hidden">
                        <div id="confidence-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="confidence-description" class="text-xs text-wiki-muted mt-2">-</p>
                </div>
                
                <!-- ê²°ì • ë³€ìˆ˜ (Key Decision Variables) -->
                <div>
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-key text-amber-400"></i>
                        <span>ì´ ë‹µë³€ë“¤ì´ ê²°ê³¼ì— ì˜í–¥ì„ ì£¼ì—ˆì–´ìš”</span>
                    </h3>
                    <div id="key-decisions" class="space-y-2">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </div>
                </div>
            </div>
            
            <!-- TOP3 ì¶”ì²œ ê²°ê³¼ -->
            <div class="glass-card p-8 rounded-2xl mb-6">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-trophy text-yellow-400 mr-2"></i>TOP 3 ì¶”ì²œ ì§ì—…
                </h2>
                <div id="top3-results" class="grid md:grid-cols-3 gap-4">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- ë””ë²„ê·¸ íŒ¨ë„ (debug=trueì¼ ë•Œë§Œ) -->
            ${debugMode ? `
            <div class="glass-card p-6 rounded-2xl mb-6 border border-yellow-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-400">
                        <i class="fas fa-bug mr-2"></i>ë””ë²„ê·¸ íŒ¨ë„ (Stage-based V3)
                    </h3>
                    <button onclick="toggleDebugPanel()" class="text-sm text-wiki-muted hover:text-white">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
                </div>
                <div id="debug-panel-content">
                    <!-- 1. Candidate Source -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-database mr-1"></i>1. Candidate Source
                        </h4>
                        <div id="debug-candidate-source" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 2. ì ìˆ˜ ë¶„í•´ -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-chart-bar mr-1"></i>2. ì ìˆ˜ ë¶„í•´ (TOP3)
                        </h4>
                        <div id="debug-score-breakdown" class="text-white font-mono text-xs overflow-x-auto">-</div>
                    </div>
                    
                    <!-- 3. Follow-up ê·¼ê±° -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-question mr-1"></i>3. Follow-up ê·¼ê±°
                        </h4>
                        <div id="debug-followup-rationale" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 4. Rank Change -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-exchange-alt mr-1"></i>4. Rank Change
                        </h4>
                        <div id="debug-rank-change" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 5. Applied Facts & Rules -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-cog mr-1"></i>5. Applied Facts & Rules
                        </h4>
                        <div id="debug-applied-facts" class="text-white font-mono text-xs max-h-32 overflow-y-auto">-</div>
                    </div>
                    
                    <!-- 6. ë²„ì „ ì •ë³´ -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-code-branch mr-1"></i>6. ë²„ì „ ì •ë³´
                        </h4>
                        <div id="debug-versions" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- Diversity/Phase4 ìƒíƒœ -->
                    <div class="p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-shield-alt mr-1"></i>Phase4 ìƒíƒœ
                        </h4>
                        <div id="debug-phase4-status" class="text-white font-mono text-sm">-</div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- ì¶”ê°€ Follow-up ì§ˆë¬¸ (ê²°ê³¼ í›„) -->
            <div id="result-followup-section" class="glass-card p-6 rounded-2xl mb-6 hidden">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-question-circle text-blue-400 mr-2"></i>ë” ì •í™•í•œ ì¶”ì²œì„ ìœ„í•´
                </h3>
                <p id="result-followup-question" class="text-lg mb-4">-</p>
                <div id="result-followup-options" class="flex flex-wrap gap-3">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- ìƒˆ ë¶„ì„ ë²„íŠ¼ -->
            <div class="text-center">
                <button onclick="resetAnalysis()" class="px-6 py-3 bg-wiki-card text-white rounded-lg hover:bg-wiki-primary transition">
                    <i class="fas fa-redo mr-2"></i>ìƒˆë¡œ ë¶„ì„í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // V3 Stage-based AI Analyzer
        // ============================================
        const DEBUG_MODE = ${debugMode};
        const UNIVERSAL_QUESTIONS = ${universalQuestionsJson};
        const JOB_STAGES = ${jobStagesJson};
        const MINOR_STAGES = ${JSON.stringify(minorStages)};
        
        // 5ì¶• ìƒíƒœì¢Œí‘œ ë°ì´í„° (Career Tree)
        const ROLE_IDENTITY_OPTIONS = ${roleIdentityOptionsJson};
        const CAREER_STAGE_OPTIONS = ${careerStageOptionsJson};
        const TRANSITION_STATUS_OPTIONS = ${transitionStatusOptionsJson};
        const SKILL_LEVEL_OPTIONS = ${skillLevelOptionsJson};
        const CONSTRAINT_OPTIONS = ${constraintOptionsJson};
        
        // ì „ì´ ì‹ í˜¸ ì§ˆë¬¸ ë°ì´í„°
        const TRANSITION_SIGNAL_QUESTIONS = ${transitionSignalQuestionsJson};

        // identity anchor ì§ˆë¬¸ ë°ì´í„°
        const IDENTITY_ANCHOR_PATTERNS = ${identityAnchorPatternsJson};

        // ============================================
        // ë™ì  ì„œìˆ í˜• ì§ˆë¬¸ ì‹œìŠ¤í…œ (ìƒí™© + ê²½ë ¥ + ëª©í‘œ ê¸°ë°˜)
        // ============================================
        const NARRATIVE_QUESTIONS = {
            'student_explore': {
                question1: { id: 'dream_future', text: 'ì–´ë–¤ ì¼ì„ í•˜ëŠ” ì‚¬ëŒì´ ë˜ê³  ì‹¶ë‚˜ìš”? ì™œ ê·¸ëŸ°ê°€ìš”?', placeholder: 'ì˜ˆ: ì‚¬ëŒë“¤ì—ê²Œ ì˜ê°ì„ ì£¼ëŠ” ì¼ì„ í•˜ê³  ì‹¶ì–´ìš”. ì–´ë¦´ ë•Œ ì¢‹ì€ ì„ ìƒë‹˜ì„ ë§Œë‚˜ì„œ ì œ ì¸ìƒì´ ë°”ë€Œì—ˆê±°ë“ ìš”...', emoji: 'ğŸŒŸ', color: 'from-yellow-500 to-orange-500', fact_key: 'narrative.dream_future' },
                question2: { id: 'fun_experience', text: 'í•™êµë‚˜ ì¼ìƒì—ì„œ ê°€ì¥ ì¬ë¯¸ìˆì—ˆë˜ í™œë™ì€ ë­ì˜€ë‚˜ìš”? ì™œ ì¬ë¯¸ìˆì—ˆë‚˜ìš”?', placeholder: 'ì˜ˆ: íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ë°œí‘œë¥¼ ë§¡ì•˜ì„ ë•Œìš”. ì œ ì•„ì´ë””ì–´ê°€ íŒ€ì›ë“¤ì—ê²Œ ì¸ì •ë°›ëŠ” ëŠë‚Œì´ ì¢‹ì•˜ì–´ìš”...', emoji: 'âœ¨', color: 'from-pink-500 to-rose-500', fact_key: 'narrative.fun_experience' },
            },
            'student_changer': {
                question1: { id: 'change_reason', text: 'ì „ê³µì´ë‚˜ ì§„ë¡œë¥¼ ë°”ê¾¸ê³  ì‹¶ì€ ì´ìœ ê°€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì²˜ìŒì—” ë¶€ëª¨ë‹˜ ê¶Œìœ ë¡œ ì„ íƒí–ˆëŠ”ë°, ê³µë¶€í• ìˆ˜ë¡ ì €ë‘ ì•ˆ ë§ëŠ”ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆì–´ìš”...', emoji: 'ğŸ”„', color: 'from-blue-500 to-cyan-500', fact_key: 'narrative.change_reason' },
                question2: { id: 'new_interest', text: 'ìƒˆë¡œ ë„ì „í•˜ê³  ì‹¶ì€ ë¶„ì•¼ê°€ ìˆë‚˜ìš”? ì™œ ëŒë¦¬ë‚˜ìš”?', placeholder: 'ì˜ˆ: ë””ìì¸ ìª½ì´ìš”. ë­”ê°€ ë§Œë“¤ì–´ë‚´ëŠ” ì¼ì„ í•  ë•Œ ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥´ê±°ë“ ìš”...', emoji: 'ğŸ¯', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.new_interest' },
            },
            // === student + first_job ì‹œë‚˜ë¦¬ì˜¤ (ìƒˆë¡œ ì¶”ê°€) ===
            'student_first_job': {
                question1: { id: 'student_first_job_dream', text: 'ì¡¸ì—… í›„ ì–´ë–¤ íšŒì‚¬ë‚˜ í™˜ê²½ì—ì„œ ì¼í•˜ê³  ì‹¶ë‚˜ìš”?', placeholder: 'ì˜ˆ: ìŠ¤íƒ€íŠ¸ì—…ì—ì„œ ì¼í•´ë³´ê³  ì‹¶ì–´ìš”. ë¹ ë¥´ê²Œ ë°°ìš°ë©´ì„œ ì—¬ëŸ¬ ì¼ì„ ê²½í—˜í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ì„œ...', emoji: 'ğŸ¢', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.student_first_job_dream' },
                question2: { id: 'student_first_job_prep', text: 'ì·¨ì—… ì¤€ë¹„ë¥¼ ìœ„í•´ ì§€ê¸ˆ í•˜ê³  ìˆëŠ” ê²ƒì´ ìˆë‚˜ìš”?', placeholder: 'ì˜ˆ: ì¸í„´ ê²½í—˜ì„ ìŒ“ìœ¼ë ¤ê³  í•´ìš”. ìê²©ì¦ë„ ì¤€ë¹„ ì¤‘ì´ê³ , í¬íŠ¸í´ë¦¬ì˜¤ë„ ë§Œë“¤ê³  ìˆì–´ìš”...', emoji: 'ğŸ“', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.student_first_job_prep' },
            },
            'worker_junior': {
                question1: { id: 'rewarding_moment', text: 'í˜„ì¬ ì¼ì—ì„œ ê°€ì¥ ë³´ëŒ ìˆëŠ” ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?', placeholder: 'ì˜ˆ: ì œê°€ ë§¡ì€ ê¸°ëŠ¥ì´ ì‹¤ì œë¡œ ë°°í¬ë˜ê³  ì‚¬ìš©ì ë°˜ì‘ì„ ë³¼ ë•Œìš”. ë‚´ê°€ ë§Œë“  ê²Œ ëˆ„êµ°ê°€ì—ê²Œ ë„ì›€ì´ ëœë‹¤ëŠ” ê²Œ...', emoji: 'ğŸ’ª', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.rewarding_moment' },
                question2: { id: 'future_vision', text: '3ë…„ í›„ ì–´ë–¤ ëª¨ìŠµì´ê³  ì‹¶ë‚˜ìš”? êµ¬ì²´ì ìœ¼ë¡œ ìƒìƒí•´ë³¸ë‹¤ë©´?', placeholder: 'ì˜ˆ: íŒ€ì—ì„œ ì¸ì •ë°›ëŠ” ì¤‘ê°„ ì—­í• ì´ìš”. í›„ë°°ë„ ê°€ë¥´ì¹˜ê³ , ì œ ì˜ê²¬ì´ ë°˜ì˜ë˜ëŠ” ìœ„ì¹˜...', emoji: 'ğŸ”®', color: 'from-indigo-500 to-blue-500', fact_key: 'narrative.future_vision' },
            },
            'worker_junior_changer': {
                question1: { id: 'change_trigger', text: 'ì´ì§ì´ë‚˜ ì „í™˜ì„ ìƒê°í•˜ê²Œ ëœ ê³„ê¸°ê°€ ìˆë‚˜ìš”?', placeholder: 'ì˜ˆ: ë°˜ë³µë˜ëŠ” ì—…ë¬´ì— ì„±ì¥ì´ ë©ˆì¶˜ ëŠë‚Œì´ ë“¤ì—ˆì–´ìš”. ë§¤ì¼ ê°™ì€ ì¼ë§Œ í•˜ë‹ˆê¹Œ...', emoji: 'ğŸ’­', color: 'from-amber-500 to-orange-500', fact_key: 'narrative.change_trigger' },
                question2: { id: 'next_must_have', text: 'ë‹¤ìŒ ì§ì¥ì—ì„œ ê¼­ ì–»ê³  ì‹¶ì€ ê²ƒì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ìƒˆë¡œìš´ ê¸°ìˆ ì„ ë°°ìš¸ ìˆ˜ ìˆëŠ” í™˜ê²½ì´ìš”. ê·¸ë¦¬ê³  ì•¼ê·¼ ì—†ì´ ì œ ì‹œê°„ì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©´...', emoji: 'ğŸ', color: 'from-green-500 to-emerald-500', fact_key: 'narrative.next_must_have' },
            },
            'worker_mid': {
                question1: { id: 'proud_achievement', text: 'ì§€ê¸ˆê¹Œì§€ ì»¤ë¦¬ì–´ì—ì„œ ê°€ì¥ ìë‘ìŠ¤ëŸ¬ìš´ ì„±ê³¼ê°€ ìˆë‹¤ë©´?', placeholder: 'ì˜ˆ: ì²˜ìŒìœ¼ë¡œ í”„ë¡œì íŠ¸ ë¦¬ë“œë¥¼ ë§¡ì•„ì„œ ì„±ê³µì ìœ¼ë¡œ ë§ˆë¬´ë¦¬í–ˆì„ ë•Œìš”. í˜ë“¤ì—ˆì§€ë§Œ ë¿Œë“¯í–ˆì–´ìš”...', emoji: 'ğŸ†', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.proud_achievement' },
                question2: { id: 'current_gap', text: 'í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•„ì‰¬ìš´ ì ì´ ìˆë‹¤ë©´ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ê´€ë¦¬ ì—…ë¬´ê°€ ëŠ˜ë©´ì„œ ì‹¤ë¬´ ì—­ëŸ‰ì´ ì •ì²´ëœ ëŠë‚Œì´ì—ìš”. ì˜ˆì „ì²˜ëŸ¼ ê¹Šì´ íŒŒê³ ë“¤ ì‹œê°„ì´ ì—†ì–´ì„œ...', emoji: 'ğŸ¤”', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.current_gap' },
            },
            'worker_mid_changer': {
                question1: { id: 'change_motivation', text: 'ë³€í™”ë¥¼ ìƒê°í•˜ê²Œ ëœ ê³„ê¸°ê°€ ìˆë‚˜ìš”? (ì‘ì€ ë¶ˆí¸í•¨ì´ë“  í° ì „í™˜ì ì´ë“ )', placeholder: 'ì˜ˆ: ìµœê·¼ í”„ë¡œì íŠ¸ê°€ ëë‚˜ê³  ë‚˜ë‹ˆ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê³ ë¯¼í•˜ê²Œ ëì–´ìš”. ì„±ì¥ì´ ì •ì²´ëœ ëŠë‚Œë„ ìˆê³ ...', emoji: 'ğŸ’­', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.change_motivation' },
                question2: { id: 'must_avoid', text: 'ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë°˜ë“œì‹œ í”¼í•˜ê³  ì‹¶ì€ ê²ƒì€?', placeholder: 'ì˜ˆ: ì •ì¹˜ê°€ ì‹¬í•œ ì¡°ì§ì´ìš”. ì‹¤ë ¥ë³´ë‹¤ ëˆˆì¹˜ê°€ ì¤‘ìš”í•œ í™˜ê²½ì—ì„œëŠ” ëª» ë²„í‹¸ ê²ƒ ê°™ì•„ìš”...', emoji: 'ğŸš«', color: 'from-orange-600 to-red-500', fact_key: 'narrative.must_avoid' },
            },
            'worker_senior': {
                question1: { id: 'legacy', text: 'ì§€ê¸ˆê¹Œì§€ ìŒ“ì•„ì˜¨ ê²ƒ ì¤‘ ê°€ì¥ ì†Œì¤‘í•œ ê²ƒì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì—…ê³„ì—ì„œì˜ ë„¤íŠ¸ì›Œí¬ìš”. ì–´ë””ì„œë“  ë„ì›€ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆëŠ” ê´€ê³„ë“¤ì´ í° ìì‚°ì´ì—ìš”...', emoji: 'ğŸ’', color: 'from-purple-600 to-indigo-600', fact_key: 'narrative.legacy' },
                question2: { id: 'remaining_goal', text: 'ë‚¨ì€ ì»¤ë¦¬ì–´ì—ì„œ ê¼­ ì´ë£¨ê³  ì‹¶ì€ ê²ƒì´ ìˆë‹¤ë©´?', placeholder: 'ì˜ˆ: í›„ë°°ë“¤ì„ í‚¤ìš°ëŠ” ì¼ì´ìš”. ì œê°€ ë°›ì€ ë„ì›€ì„ ë‹¤ìŒ ì„¸ëŒ€ì— ëŒë ¤ì£¼ê³  ì‹¶ì–´ìš”...', emoji: 'ğŸŒ±', color: 'from-teal-600 to-cyan-600', fact_key: 'narrative.remaining_goal' },
            },
            'worker_senior_changer': {
                question1: { id: 'senior_change_reason', text: 'ì´ ì‹œì ì—ì„œ ë³€í™”ë¥¼ ìƒê°í•˜ê²Œ ëœ ì´ìœ ëŠ” ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ë” ì´ìƒ ì´ ë¶„ì•¼ì—ì„œ ì„±ì¥í•  ê²Œ ì—†ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆì–´ìš”. ìƒˆë¡œìš´ ë„ì „ì´ í•„ìš”í•œ ì‹œê¸°...', emoji: 'ğŸ”„', color: 'from-blue-600 to-purple-600', fact_key: 'narrative.senior_change_reason' },
                question2: { id: 'non_negotiable', text: 'ìƒˆë¡œìš´ ì‹œì‘ì—ì„œ ì ˆëŒ€ í¬ê¸°í•  ìˆ˜ ì—†ëŠ” ì¡°ê±´ì€?', placeholder: 'ì˜ˆ: ì—°ë´‰ ìˆ˜ì¤€ì€ ìœ ì§€í•´ì•¼ í•´ìš”. ê°€ì¡± ë¶€ì–‘ ì±…ì„ì´ ìˆì–´ì„œ ë„ˆë¬´ í° ë¦¬ìŠ¤í¬ëŠ” ëª» ì ¸ìš”...', emoji: 'âš–ï¸', color: 'from-slate-600 to-zinc-600', fact_key: 'narrative.non_negotiable' },
            },
            'entrepreneur': {
                question1: { id: 'entrepreneur_why', text: 'ì™œ ë…ë¦½ì ì¸ ì¼ì„ ì„ íƒí•˜ì…¨ë‚˜ìš”? (í˜¹ì€ ì„ íƒí•˜ë ¤ í•˜ë‚˜ìš”?)', placeholder: 'ì˜ˆ: ì œ ì•„ì´ë””ì–´ë¥¼ ì§ì ‘ ì‹¤í˜„í•˜ê³  ì‹¶ì—ˆì–´ìš”. ì¡°ì§ì—ì„œëŠ” í•­ìƒ ëˆ„êµ°ê°€ì˜ ê²°ì •ì„ ê¸°ë‹¤ë ¤ì•¼ í•´ì„œ...', emoji: 'ğŸš€', color: 'from-orange-500 to-red-500', fact_key: 'narrative.entrepreneur_why' },
                question2: { id: 'entrepreneur_challenge', text: 'ë…ë¦½ì ìœ¼ë¡œ ì¼í•˜ë©´ì„œ ê°€ì¥ í˜ë“  ì ì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ìˆ˜ì…ì´ ë¶ˆì•ˆì •í•œ ê±°ìš”. ì˜ë  ë•Œì™€ ì•ˆ ë  ë•Œì˜ ì°¨ì´ê°€ ë„ˆë¬´ ì»¤ì„œ ìŠ¤íŠ¸ë ˆìŠ¤...', emoji: 'ğŸ”ï¸', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.entrepreneur_challenge' },
            },
            'inactive_returner': {
                question1: { id: 'gap_reflection', text: 'ê²½ë ¥ ë‹¨ì ˆ ê¸°ê°„ ë™ì•ˆ ì–´ë–¤ ìƒê°ì´ ë“¤ì—ˆë‚˜ìš”?', placeholder: 'ì˜ˆ: ì²˜ìŒì—” ì‰¬ëŠ” ê²Œ ì¢‹ì•˜ëŠ”ë°, ì‹œê°„ì´ ì§€ë‚˜ë‹ˆê¹Œ ë¶ˆì•ˆí•´ì¡Œì–´ìš”. ì‚¬íšŒì™€ ë‹¨ì ˆëœ ëŠë‚Œ...', emoji: 'ğŸ’­', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.gap_reflection' },
                question2: { id: 'comeback_worry', text: 'ë³µê·€í•˜ë©´ì„œ ê°€ì¥ ê±±ì •ë˜ëŠ” ë¶€ë¶„ì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ê¸°ìˆ ì´ ë§ì´ ë°”ë€Œì—ˆì„ ê²ƒ ê°™ì•„ìš”. ë”°ë¼ê°ˆ ìˆ˜ ìˆì„ì§€, ë‚˜ì´ ë•Œë¬¸ì— í¸ê²¬ì´ ìˆì„ì§€...', emoji: 'ğŸ˜°', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.comeback_worry' },
            },
            'manager_10plus_second': {
                question1: { id: 'accumulated_value', text: 'ì§€ê¸ˆê¹Œì§€ ìŒ“ì€ ê²ƒ ì¤‘ ê°€ì¥ ê°€ì¹˜ ìˆëŠ” ê²ƒì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì‚¬ëŒì„ ë³´ëŠ” ëˆˆì´ìš”. ìˆ˜ë§ì€ ë©´ì ‘ê³¼ í‰ê°€ë¥¼ í•˜ë©´ì„œ ì¸ì¬ë¥¼ ì•Œì•„ë³´ëŠ” ê°ê°ì´ ìƒê²¼ì–´ìš”...', emoji: 'ğŸ’', color: 'from-purple-600 to-pink-600', fact_key: 'narrative.accumulated_value' },
                question2: { id: 'second_career_dream', text: 'ì€í‡´ í›„ ë˜ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ê¼­ í•´ë³´ê³  ì‹¶ì€ ì¼ì€?', placeholder: 'ì˜ˆ: ì»¨ì„¤íŒ…ì´ìš”. ì œ ê²½í—˜ì„ í›„ë°° ê²½ì˜ìë“¤ì—ê²Œ ë‚˜ëˆ ì£¼ê³  ì‹¶ì–´ìš”. ëˆë³´ë‹¤ëŠ” ì˜ë¯¸ê°€ ì¤‘ìš”...', emoji: 'ğŸŒ…', color: 'from-amber-500 to-orange-500', fact_key: 'narrative.second_career_dream' },
            },
            // === manager ì—­í•  ì¶”ê°€ ì‹œë‚˜ë¦¬ì˜¤ (ìƒˆë¡œ ì¶”ê°€) ===
            'manager_growth': {
                question1: { id: 'leadership_proudest', text: 'ë¦¬ë”ë¡œì„œ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?', placeholder: 'ì˜ˆ: íŒ€ì›ì´ ì„±ì¥í•´ì„œ ë…ë¦½ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ë¥¼ ì´ëŒê²Œ ëì„ ë•Œìš”. ì œê°€ í•œ ê²ƒì´ ì•„ë‹Œë°ë„ ë¿Œë“¯í–ˆì–´ìš”...', emoji: 'ğŸ‘‘', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.leadership_proudest' },
                question2: { id: 'leadership_challenge', text: 'ë¦¬ë”ì‹­ì—ì„œ ê°€ì¥ ì–´ë ¤ìš´ ì ì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: íŒ€ì›ë“¤ì˜ ì„œë¡œ ë‹¤ë¥¸ ê¸°ëŒ€ë¥¼ ì¡°ìœ¨í•˜ëŠ” ê±°ìš”. ëª¨ë‘ë¥¼ ë§Œì¡±ì‹œí‚¬ ìˆ˜ ì—†ë‹¤ëŠ” ê±¸ ì•Œë©´ì„œë„...', emoji: 'ğŸ¤”', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.leadership_challenge' },
            },
            'manager_changer': {
                question1: { id: 'manager_change_reason', text: 'ê´€ë¦¬ìë¡œì„œ ìƒˆë¡œìš´ ë¶„ì•¼ë¡œ ì „í™˜í•˜ë ¤ëŠ” ì´ìœ ëŠ” ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: í˜„ì¬ ì¡°ì§ì—ì„œ ë” ì„±ì¥í•˜ê¸° ì–´ë ¤ì›Œìš”. ìƒˆë¡œìš´ ë„ì „ì´ í•„ìš”í•œ ì‹œì ì¸ ê²ƒ ê°™ì•„ìš”...', emoji: 'ğŸ”„', color: 'from-blue-600 to-purple-600', fact_key: 'narrative.manager_change_reason' },
                question2: { id: 'manager_transferable', text: 'ë‹¤ë¥¸ ë¶„ì•¼ì—ì„œë„ í™œìš© ê°€ëŠ¥í•œ ë³¸ì¸ì˜ ê°•ì ì€ ë­˜ê¹Œìš”?', placeholder: 'ì˜ˆ: ì‚¬ëŒì„ ì´ë„ëŠ” ê²½í—˜ì´ìš”. ì–´ë–¤ ë¶„ì•¼ë“  íŒ€ì„ ë§Œë“¤ê³  í‚¤ìš°ëŠ” ê±´ ë¹„ìŠ·í•  ê²ƒ ê°™ì•„ìš”...', emoji: 'ğŸ’¼', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.manager_transferable' },
            },
            'worker_changer': {
                question1: { id: 'change_trigger_general', text: 'ì´ì§ì´ë‚˜ ì „í™˜ì„ ìƒê°í•˜ê²Œ ëœ ê³„ê¸°ê°€ ìˆë‚˜ìš”?', placeholder: 'ì˜ˆ: ì„±ì¥ì´ ë©ˆì¶˜ ëŠë‚Œì´ ë“¤ì—ˆì–´ìš”. ë§¤ì¼ ê°™ì€ ì¼ë§Œ ë°˜ë³µí•˜ë‹ˆê¹Œ ë¬´ê¸°ë ¥í•´ì§€ë”ë¼ê³ ìš”...', emoji: 'ğŸ’­', color: 'from-blue-500 to-cyan-500', fact_key: 'narrative.change_trigger' },
                question2: { id: 'next_priority', text: 'ë‹¤ìŒ ì§ì¥/ì»¤ë¦¬ì–´ì—ì„œ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê²ƒì€?', placeholder: 'ì˜ˆ: ë°°ìš¸ ìˆ˜ ìˆëŠ” í™˜ê²½ì´ìš”. ì •ì²´ë˜ì§€ ì•Šê³  ê³„ì† ì„±ì¥í•  ìˆ˜ ìˆëŠ” ê³³ì´ë©´ ì¢‹ê² ì–´ìš”...', emoji: 'â­', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.next_priority' },
            },
            // === job_seeker ì—­í•  ì‹œë‚˜ë¦¬ì˜¤ (ìƒˆë¡œ ì¶”ê°€) ===
            'job_seeker_first': {
                question1: { id: 'first_job_expectation', text: 'ì²« ì§ì¥ì—ì„œ ê°€ì¥ ê¸°ëŒ€í•˜ëŠ” ê²ƒì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì‹¤ë¬´ ê²½í—˜ì„ ìŒ“ìœ¼ë©´ì„œ ì „ë¬¸ì„±ì„ í‚¤ìš°ê³  ì‹¶ì–´ìš”. ì¢‹ì€ ë©˜í† ë¥¼ ë§Œë‚¬ìœ¼ë©´ ì¢‹ê² ì–´ìš”...', emoji: 'ğŸŒŸ', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.first_job_expectation' },
                question2: { id: 'first_job_worry', text: 'ì·¨ì—… ì¤€ë¹„ ì¤‘ ê°€ì¥ ê±±ì •ë˜ê±°ë‚˜ ì–´ë ¤ìš´ ì ì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ìŠ¤í™ì´ ë¶€ì¡±í•œ ê²ƒ ê°™ì•„ì„œ ê±±ì •ì´ì—ìš”. ì–´ë””ì„œë¶€í„° ì‹œì‘í•´ì•¼ í• ì§€ ë§‰ë§‰í•˜ê³ ...', emoji: 'ğŸ˜°', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.first_job_worry' },
            },
            'job_seeker_return': {
                question1: { id: 'return_gap_experience', text: 'ê²½ë ¥ ê³µë°± ê¸°ê°„ ë™ì•ˆ ì–´ë–¤ ê²½í—˜ì„ í•˜ì…¨ë‚˜ìš”?', placeholder: 'ì˜ˆ: ìœ¡ì•„ì— ì§‘ì¤‘í–ˆì–´ìš”. í˜ë“¤ì—ˆì§€ë§Œ ì•„ì´ì™€ í•¨ê»˜í•œ ì‹œê°„ì´ ì†Œì¤‘í–ˆì–´ìš”. ê·¸ ì™¸ì—ë„...', emoji: 'ğŸ’­', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.return_gap_experience' },
                question2: { id: 'return_concern', text: 'ë³µê·€í•˜ë©´ì„œ ê°€ì¥ ê±±ì •ë˜ëŠ” ë¶€ë¶„ì€ ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì—…ê³„ê°€ ë§ì´ ë³€í–ˆì„ ê²ƒ ê°™ì•„ìš”. ì œ ê²½ë ¥ì´ ì•„ì§ ìœ íš¨í•œì§€, ì ì‘í•  ìˆ˜ ìˆì„ì§€...', emoji: 'ğŸ¤”', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.return_concern' },
            },
            'job_seeker_second': {
                question1: { id: 'second_career_motivation', text: 'ìƒˆë¡œìš´ ì»¤ë¦¬ì–´ë¥¼ ì‹œì‘í•˜ë ¤ëŠ” ì´ìœ ëŠ” ë­”ê°€ìš”?', placeholder: 'ì˜ˆ: ì€í‡´ í›„ì—ë„ ì˜ë¯¸ ìˆëŠ” ì¼ì„ í•˜ê³  ì‹¶ì–´ìš”. ê·¸ë™ì•ˆ ìŒ“ì€ ê²½í—˜ì„ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ í™œìš©í•˜ê³ ...', emoji: 'ğŸŒ…', color: 'from-orange-500 to-amber-500', fact_key: 'narrative.second_career_motivation' },
                question2: { id: 'second_career_vision', text: 'ìƒˆë¡œìš´ ì»¤ë¦¬ì–´ì—ì„œ ì´ë£¨ê³  ì‹¶ì€ ê²ƒì´ ìˆë‹¤ë©´?', placeholder: 'ì˜ˆ: ì Šì€ ì„¸ëŒ€ì—ê²Œ ë„ì›€ì´ ë˜ê³  ì‹¶ì–´ìš”. ì»¨ì„¤íŒ…ì´ë‚˜ ê°•ì˜ ê°™ì€ ê²ƒë„ ìƒê°í•˜ê³  ìˆì–´ìš”...', emoji: 'ğŸ¯', color: 'from-purple-500 to-pink-500', fact_key: 'narrative.second_career_vision' },
            },
            'job_seeker_explore': {
                question1: { id: 'explore_interest', text: 'ìš”ì¦˜ ê´€ì‹¬ì´ ê°€ê±°ë‚˜ ëŒë¦¬ëŠ” ë¶„ì•¼ê°€ ìˆë‚˜ìš”?', placeholder: 'ì˜ˆ: IT ìª½ì— ê´€ì‹¬ì´ ê°€ìš”. ë¹„ì „ê³µìë„ í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤ì´ ìˆë‹¤ê³  ë“¤ì–´ì„œ...', emoji: 'ğŸ”', color: 'from-cyan-500 to-blue-500', fact_key: 'narrative.explore_interest' },
                question2: { id: 'explore_blocker', text: 'ë°©í–¥ì„ ì •í•˜ê¸° ì–´ë ¤ìš´ ì´ìœ ê°€ ë­˜ê¹Œìš”?', placeholder: 'ì˜ˆ: ë­˜ ì¢‹ì•„í•˜ëŠ”ì§€ ì˜ ëª¨ë¥´ê² ì–´ìš”. ì´ê²ƒì €ê²ƒ í•´ë³´ê³  ì‹¶ì€ë° ì–´ë””ì„œë¶€í„° ì‹œì‘í•´ì•¼ í• ì§€...', emoji: 'â“', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.explore_blocker' },
            },
            'default': {
                question1: { id: 'high_alive', text: 'ìµœê·¼ 6ê°œì›” ì¤‘ ê°€ì¥ "ì‚´ì•„ìˆë‹¤"ê³  ëŠë‚€ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”? ì™œ ê·¸ë¬ë‚˜ìš”?', placeholder: 'ì˜ˆ: íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ì œ ì•„ì´ë””ì–´ê°€ ì±„íƒëì„ ë•Œìš”. ì²˜ìŒìœ¼ë¡œ ì œ ìƒê°ì´ ì¸ì •ë°›ì€ ëŠë‚Œì´ì—ˆê³ ...', emoji: 'ğŸ”¥', color: 'from-orange-500 to-red-500', fact_key: 'narrative.high_alive_moment' },
                question2: { id: 'lost_moment', text: 'ë°˜ëŒ€ë¡œ ê°€ì¥ "ë‚˜ë¥¼ ìƒì—ˆë‹¤"ê³  ëŠë‚€ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”? ì™œ ê·¸ë¬ë‚˜ìš”?', placeholder: 'ì˜ˆ: ë§¤ì¼ ê°™ì€ ë³´ê³ ì„œë¥¼ ì‘ì„±í•  ë•Œìš”. ì œê°€ ëˆ„êµ°ì§€, ì™œ ì´ ì¼ì„ í•˜ëŠ”ì§€ ëª¨ë¥´ê² ì—ˆì–´ìš”...', emoji: 'ğŸŒ«ï¸', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.lost_moment' },
            },
        };
        
        // ì»¨í…ìŠ¤íŠ¸ í‚¤ ìƒì„± í•¨ìˆ˜
        function getNarrativeContextKey(roleIdentity, careerStage, transitionStatus) {
            // transitionStatusë¥¼ ë°°ì—´ë¡œ ì •ê·œí™” (ë¬¸ìì—´/ë°°ì—´ ëª¨ë‘ ì§€ì›)
            const statusArray = Array.isArray(transitionStatus) 
                ? transitionStatus 
                : (transitionStatus ? [transitionStatus] : []);
            const hasStatus = (status) => statusArray.includes(status);
            
            // 1. job_seeker ì—­í•  ì „ìš© (ìƒˆë¡œ ì¶”ê°€)
            if (roleIdentity === 'job_seeker') {
                if (hasStatus('first_job')) return 'job_seeker_first';
                if (hasStatus('return_work')) return 'job_seeker_return';
                if (hasStatus('second_career')) return 'job_seeker_second';
                if (hasStatus('explore')) return 'job_seeker_explore';
                return 'job_seeker_first'; // ê¸°ë³¸ê°’
            }
            
            // 2. manager ì—­í•  ì²˜ë¦¬ (í™•ì¥)
            if (roleIdentity === 'manager') {
                if (careerStage === '10_plus' && hasStatus('second_career')) return 'manager_10plus_second';
                if (hasStatus('field_change')) return 'manager_changer';
                return 'manager_growth';
            }
            
            // 3. íŠ¹ìˆ˜ ì—­í•  ì²˜ë¦¬
            // Note: 'inactive' ì—­í• ì€ UIì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ inactive_returner ì²´í¬ ì œê±°
            // ê²½ë ¥ ë³µê·€ìëŠ” job_seeker + return_work â†’ job_seeker_return ì‹œë‚˜ë¦¬ì˜¤ ì‚¬ìš©
            if (roleIdentity === 'entrepreneur') return 'entrepreneur';
            
            // 4. í•™ìƒ ì—­í•  ì²˜ë¦¬ (í™•ì¥)
            if (roleIdentity === 'student') {
                if (hasStatus('first_job')) return 'student_first_job';
                if (hasStatus('field_change')) return 'student_changer';
                return 'student_explore';
            }
            
            // 5. ì´ì§/ì „í™˜ ì˜ì‚¬ê°€ ìˆëŠ” ê²½ìš° (worker)
            if (hasStatus('field_change') || transitionStatus === 'changer') {
                if (careerStage === '0_3') return 'worker_junior_changer';
                if (careerStage === '3_10') return 'worker_mid_changer';
                if (careerStage === '10_plus') return 'worker_senior_changer';
                return 'worker_changer';
            }
            
            // 6. ê²½ë ¥ ê¸°ë°˜
            if (careerStage === 'none' || careerStage === '0_3') return 'worker_junior';
            if (careerStage === '3_10') return 'worker_mid';
            if (careerStage === '10_plus') return 'worker_senior';
            
            // 7. ê¸°ë³¸ê°’
            return 'default';
        }
        
        // ì„œìˆ í˜• ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
        function getNarrativeQuestions() {
            const key = getNarrativeContextKey(
                careerState.role_identity,
                careerState.career_stage_years,
                careerState.transition_status
            );
            return NARRATIVE_QUESTIONS[key] || NARRATIVE_QUESTIONS['default'];
        }
        
        // ìƒíƒœ ê´€ë¦¬ - /analyzer/jobìœ¼ë¡œ ì§„ì…í–ˆìœ¼ë¯€ë¡œ Step 1(ìƒíƒœ ì„ íƒ)ë¶€í„° ì‹œì‘
        let currentStep = 1;
        let profileSubStep = 1;  // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í… (1: 5ì¶• ìƒíƒœ, 2: ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°)
        let selectedAnalysisType = 'job';
        let selectedStage = null;  // ê¸°ì¡´ í˜¸í™˜ì„±
        let universalAnswers = {};
        let followupAnswers = {};
        let transitionSignalAnswers = {};  // ì „ì´ ì‹ í˜¸ ë‹µë³€
        let currentSessionId = null;
        let currentRequestId = null;
        let previousTop3 = [];

        // ============================================
        // Phase 3: í¸ì§‘ ëª¨ë“œ ìœ í‹¸ë¦¬í‹°
        // ============================================
        function showEditModeBanner() {
            if (!window.__editMode) return;
            const banner = document.createElement('div');
            banner.id = 'edit-mode-banner';
            banner.className = 'mb-4 p-3 rounded-xl border';
            banner.style.cssText = 'border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.08);';
            banner.innerHTML = '<div class="flex items-center justify-between flex-wrap gap-2"><div class="flex items-center gap-2"><i class="fas fa-edit text-amber-400"></i><span class="text-amber-300 text-sm font-medium">ìˆ˜ì • ëª¨ë“œ</span><span class="text-amber-200/70 text-xs">ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì´í›„ ë‹¨ê³„ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤</span></div><button onclick="cancelEditMode()" class="px-3 py-1 text-xs rounded-lg border border-wiki-border text-wiki-muted hover:text-white transition">ì·¨ì†Œ</button></div>';
            const container = document.querySelector('.max-w-6xl') || document.querySelector('main');
            if (container) container.insertBefore(banner, container.firstChild);
        }

        async function cancelEditMode() {
            if (!window.__editMode) return;
            try {
                await fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                    method: 'DELETE', credentials: 'same-origin'
                });
            } catch (e) {}
            window.location.href = '/user/ai-results/' + window.__sourceRequestId;
        }

        function getEditModePayloadExtras() {
            if (!window.__editMode) return {};
            return {
                session_id: window.__originalSessionId,
                edit_mode: true,
                edit_session_id: window.__editSessionId,
                source_request_id: window.__sourceRequestId,
                version_note: 'ì…ë ¥ ìˆ˜ì •',
            };
        }

        // í¸ì§‘ ëª¨ë“œ ë³€ê²½ ê°ì§€
        function detectStep1Changes() {
            if (!window.__editMode) return false;
            return JSON.stringify(careerState) !== window.__editSnapshot.careerState
                || JSON.stringify(universalAnswers) !== window.__editSnapshot.universalAnswers;
        }
        function detectNarrativeChanges() {
            if (!window.__editMode) return false;
            return JSON.stringify(window.narrativeFacts || {}) !== window.__editSnapshot.narrativeFacts;
        }
        function detectRoundChanges(roundNumber) {
            if (!window.__editMode) return false;
            const snapRounds = JSON.parse(window.__editSnapshot.roundAnswers);
            const currRounds = window.roundAnswers || [];
            const snapR = snapRounds.filter(a => a.roundNumber === roundNumber);
            const currR = currRounds.filter(a => a.roundNumber === roundNumber);
            return JSON.stringify(snapR) !== JSON.stringify(currR);
        }

        // ìºìŠ¤ì¼€ì´ë“œ ë¦¬ì…‹
        function cascadeResetFromStep1() {
            window.narrativeFacts = null;
            window.roundAnswers = [];
            window.roundQuestions = null;
            window.currentRound = 0;
            window.savedNarrativeQuestions = null;
            window.__editSnapshot.narrativeFacts = '{}';
            window.__editSnapshot.roundAnswers = '[]';
        }
        function cascadeResetFromNarrative() {
            window.roundAnswers = [];
            window.roundQuestions = null;
            window.currentRound = 0;
            window.__editSnapshot.roundAnswers = '[]';
        }
        function cascadeResetFromRound(roundNumber) {
            window.roundAnswers = (window.roundAnswers || []).filter(a => a.roundNumber <= roundNumber);
            window.currentRound = roundNumber;
            window.__editSnapshot.roundAnswers = JSON.stringify(window.roundAnswers);
        }
        // ============================================

        // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í… ì´ë™ í•¨ìˆ˜
        function goToProfileStep1() {
            profileSubStep = 1;
            document.getElementById('profile-step-1')?.classList.remove('hidden');
            document.getElementById('profile-step-2')?.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function goToProfileStep2() {
            // 5ì¶• ì¤‘ ìµœì†Œ 1ê°œ ì„ íƒ í™•ì¸
            if (!careerState.role_identity) {
                alert('í˜„ì¬ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            profileSubStep = 2;
            document.getElementById('profile-step-1')?.classList.add('hidden');
            document.getElementById('profile-step-2')?.classList.remove('hidden');
            
            // í†µí•© ì§ˆë¬¸ ë Œë”ë§ (í•™ìƒ/ì–´ë¥¸ì— ë”°ë¼ í•­ìƒ ë‹¤ì‹œ ë Œë”ë§)
            renderIntegratedQuestions();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 5ì¶• ìƒíƒœì¢Œí‘œ ì €ì¥
        let careerState = {
            role_identity: null,
            career_stage_years: null,
            transition_status: null,
            skill_level: null,
            constraints: {}
        };
        
        // ============================================
        // ë¡œë”© ì˜¤ë²„ë ˆì´
        // ============================================
        function showLoading(message, submessage = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”') {
            const overlay = document.getElementById('loading-overlay');
            const msgEl = document.getElementById('loading-message');
            const subEl = document.getElementById('loading-submessage');
            if (msgEl) msgEl.textContent = message;
            if (subEl) subEl.textContent = submessage;
            if (overlay) overlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }
        
        // ============================================
        // ì´ë ¥ì„œ ì—…ë¡œë“œ ì²˜ë¦¬
        // ============================================
        async function handleResumeUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // PDF íŒŒì¼ í™•ì¸
            if (file.type !== 'application/pdf') {
                showResumeError('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showResumeError('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('resume-loading').classList.remove('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.add('hidden');
            
            try {
                // pdf.jsë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (CDN ì‚¬ìš©)
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                if (!pdfjsLib) {
                    // pdf.js ë™ì  ë¡œë“œ
                    await loadPdfJs();
                }
                
                const pdfText = await extractTextFromPdf(file);
                
                if (pdfText.length < 100) {
                    showResumeError('ì´ë ¥ì„œì—ì„œ ì¶©ë¶„í•œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ ê¸°ë°˜ PDFì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì„œë²„ë¡œ íŒŒì‹± ìš”ì²­
                const response = await fetch('/api/ai-analyzer/resume/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: pdfText,
                        session_id: currentSessionId,
                        save_to_draft: false,
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'íŒŒì‹± ì‹¤íŒ¨');
                }
                
                // íŒŒì‹± ê²°ê³¼ë¡œ UI ì—…ë°ì´íŠ¸
                applyResumeParseResult(data.career_state, data.data);
                
                // ì„±ê³µ ìƒíƒœ í‘œì‹œ
                document.getElementById('resume-loading').classList.add('hidden');
                document.getElementById('resume-status').classList.remove('hidden');
                
                // ì´ë ¥ì„œ í˜•ì‹ í™•ì¸ (ì¶”ì¶œëœ ë°ì´í„° ê¸°ì¤€)
                const extracted = data.data.extracted || {};
                const hasSkills = extracted.skills?.length > 0;
                const hasCerts = extracted.certifications?.length > 0;
                const hasEducation = !!extracted.education_level;
                const hasExperience = extracted.total_experience_years !== null;
                const hasRole = !!extracted.current_role_type;
                
                // 2ê°œ ì´ìƒì˜ ì •ë³´ê°€ ì¶”ì¶œë˜ì—ˆìœ¼ë©´ ì´ë ¥ì„œë¡œ ì¸ì •
                const extractedCount = [hasSkills, hasCerts, hasEducation, hasExperience, hasRole].filter(Boolean).length;
                
                if (extractedCount < 2) {
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-amber-400">âš ï¸ ì¶©ë¶„í•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆì–´ìš”. ê·¸ë˜ë„ ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ì°¸ê³ ë©ë‹ˆë‹¤.</span>';
                } else {
                    const infoSummary = [];
                    if (hasSkills) infoSummary.push('ìŠ¤í‚¬ ' + extracted.skills.length + 'ê°œ');
                    if (hasCerts) infoSummary.push('ìê²©ì¦ ' + extracted.certifications.length + 'ê°œ');
                    if (hasEducation) infoSummary.push(extracted.education_level);
                    if (hasExperience) infoSummary.push('ê²½ë ¥ ' + extracted.total_experience_years + 'ë…„');
                    if (hasRole) infoSummary.push(extracted.current_role_type);
                    
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-emerald-400">âœ“ ë¶„ì„ ì™„ë£Œ! (' + infoSummary.slice(0, 3).join(', ') + ')</span>';
                }
                
            } catch (error) {
                showResumeError(error.message || 'ì´ë ¥ì„œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function showResumeError(message) {
            document.getElementById('resume-loading').classList.add('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.remove('hidden');
            document.getElementById('resume-error-text').textContent = message;
        }
        
        // pdf.js ë™ì  ë¡œë“œ
        async function loadPdfJs() {
            return new Promise((resolve, reject) => {
                if (window.pdfjsLib) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = () => reject(new Error('PDF.js ë¡œë“œ ì‹¤íŒ¨'));
                document.head.appendChild(script);
            });
        }
        
        // PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        async function extractTextFromPdf(file) {
            await loadPdfJs();
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            return fullText.trim();
        }
        
        // íŒŒì‹± ê²°ê³¼ë¥¼ UIì— ì ìš©
        function applyResumeParseResult(careerStateFromResume, parsedData) {
            // ì´ë ¥ì„œ ì—…ë¡œë“œ í”Œë˜ê·¸ ì„¤ì •
            window.resumeUploaded = true;
            
            // ì´ë ¥ì„œì—ì„œ ì¶”ì¶œí•œ ë°°ê²½ ì •ë³´ ì €ì¥ (ì‹¬ì¸µ ì§ˆë¬¸ì—ì„œ ì‚¬ìš©)
            const extracted = parsedData.extracted || {};
            const bgParts = [];
            if (extracted.education_level) bgParts.push(extracted.education_level);
            if (extracted.major) bgParts.push(extracted.major + ' ì „ê³µ');
            if (extracted.current_role_type) bgParts.push(extracted.current_role_type);
            if (extracted.total_experience_years) bgParts.push('ê²½ë ¥ ' + extracted.total_experience_years + 'ë…„');
            if (extracted.industry) bgParts.push(extracted.industry + ' ë¶„ì•¼');
            if (extracted.skills?.length > 0) bgParts.push('ìŠ¤í‚¬: ' + extracted.skills.slice(0, 3).join(', '));
            
            window.resumeCareerBackground = bgParts.join(', ');
            
            // ì—­í•  ì •ì²´ì„± ì„ íƒ
            if (careerStateFromResume.role_identity) {
                const roleBtn = document.querySelector(\`#role-options [data-value="\${careerStateFromResume.role_identity}"]\`);
                if (roleBtn) roleBtn.click();
            }
            
            // ê²½ë ¥ ì—°ì°¨ ì„ íƒ
            if (careerStateFromResume.career_stage_years) {
                const stageBtn = document.querySelector(\`#career-stage-options [data-value="\${careerStateFromResume.career_stage_years}"]\`);
                if (stageBtn) stageBtn.click();
            }
            
            // ì „í™˜ ìƒíƒœ ì„ íƒ
            if (careerStateFromResume.transition_status) {
                const transBtn = document.querySelector(\`#transition-status-options [data-value="\${careerStateFromResume.transition_status}"]\`);
                if (transBtn && !transBtn.classList.contains('selected')) transBtn.click();
            }
            
            // ìˆ™ë ¨ë„ ì„ íƒ
            if (careerStateFromResume.skill_level !== undefined && careerStateFromResume.skill_level !== null) {
                const skillBtn = document.querySelector(\`#skill-level-options [data-value="\${careerStateFromResume.skill_level}"]\`);
                if (skillBtn) skillBtn.click();
            }
            
        }
        
        // ============================================
        // Step ë„¤ë¹„ê²Œì´ì…˜
        // ============================================
        const visitedSteps = {};  // ë°©ë¬¸ ê¸°ë¡ ë° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
        
        // ============================================
        // Summary Banner: ëˆ„ì  ë©”ëª¨ë¦¬ ìš”ì•½ í‘œì‹œ
        // ============================================
        function renderSummaryBanner(containerId, memory) {
            const container = document.getElementById(containerId);
            if (!container || !memory) return;
            
            // ê¸°ì¡´ ë°°ë„ˆ ì œê±°
            const existingBanner = container.querySelector('.summary-banner');
            if (existingBanner) existingBanner.remove();
            
            const summaryItems = [];
            
            // ì•ˆì •ì  ë™ê¸° (confidence ë†’ì€ ê²ƒ)
            if (memory.stable_drivers && memory.stable_drivers.length > 0) {
                const topDrivers = memory.stable_drivers
                    .filter(d => d.confidence >= 0.6)
                    .slice(0, 2)
                    .map(d => d.text);
                if (topDrivers.length > 0) {
                    summaryItems.push('âœ¨ ì—ë„ˆì§€ ì˜¬ë¼ê°€ëŠ” ìˆœê°„: ' + topDrivers.join(', '));
                }
            }
            
            // ë°˜ë³µ ë‘ë ¤ì›€
            if (memory.recurring_fears && memory.recurring_fears.length > 0) {
                const topFears = memory.recurring_fears
                    .filter(f => f.confidence >= 0.6)
                    .slice(0, 2)
                    .map(f => f.text);
                if (topFears.length > 0) {
                    summaryItems.push('ğŸ’­ í”¼í•˜ê³  ì‹¶ì€ ê²ƒ: ' + topFears.join(', '));
                }
            }
            
            // ê°€ì¹˜ ì¶©ëŒ
            if (memory.contradictions && memory.contradictions.length > 0) {
                summaryItems.push('âš¡ íƒìƒ‰ ì¤‘ì¸ ê°ˆë“±: ' + memory.contradictions[0].text);
            }
            
            // ì˜ì‚¬ê²°ì • ê¸°ì¤€
            if (memory.decision_rules && memory.decision_rules.length > 0) {
                const topRule = memory.decision_rules.find(r => r.confidence >= 0.7);
                if (topRule) {
                    summaryItems.push('ğŸ“‹ í™•ì¸ëœ ê¸°ì¤€: ' + topRule.text);
                }
            }
            
            if (summaryItems.length === 0) return;
            
            const banner = document.createElement('div');
            banner.className = 'summary-banner bg-wiki-card/50 border border-wiki-border/50 rounded-xl p-4 mb-6';
            banner.innerHTML = \`
                <div class="text-sm text-wiki-muted mb-2 font-medium">ğŸ’¡ ì§€ê¸ˆê¹Œì§€ íŒŒì•…ëœ ë‹¹ì‹ ì˜ ê¸°ì¤€</div>
                <div class="space-y-1">
                    \${summaryItems.map(item => \`<div class="text-wiki-text text-sm">\${item}</div>\`).join('')}
                </div>
            \`;
            
            // ì»¨í…Œì´ë„ˆ ìµœìƒë‹¨ì— ì‚½ì…
            const firstChild = container.firstChild;
            container.insertBefore(banner, firstChild);
        }
        
        function goToStep(step, skipRender = false) {
            // í˜„ì¬ Stepì˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (ë– ë‚˜ê¸° ì „)
            if (currentStep && visitedSteps[currentStep] !== undefined) {
                visitedSteps[currentStep] = window.scrollY;
            }
            
            currentStep = step;
            window.currentStep = step; // ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸ (ì„ì‹œì €ì¥ìš©)
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            const stepEl = document.getElementById('step' + step);
            if (stepEl) stepEl.classList.remove('hidden');
            
            // ë³¸ì¸ ê³„ì • ê²½ê³  ë°°ë„ˆ: Step 1ì—ì„œë§Œ í‘œì‹œ
            const warningBanner = document.getElementById('account-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = step === 1 ? 'block' : 'none';
            }
            
            // ============================================
            // ìš”ì•½ ë°°ë„ˆ í‘œì‹œ (Step 2 ì´ìƒ + memory ìˆì„ ë•Œ)
            // 3ë‹¨ê³„ êµ¬ì¡°: Step 1 = í”„ë¡œí•„, Step 2 = ì‹¬ì¸µ, Step 3 = ê²°ê³¼
            // ============================================
            if (step >= 2 && window.aggregatedProfile?.memory) {
                const containerMap = { 2: 'step2', 3: 'step3' };
                const containerId = containerMap[step];
                if (containerId) {
                    setTimeout(() => {
                        renderSummaryBanner(containerId, window.aggregatedProfile.memory);
                    }, 100);
                }
            }

            // Stepë³„ ë Œë”ë§ ë³µì› (3ë‹¨ê³„ êµ¬ì¡°)
            if (!skipRender) {
                try {
                    if (step === 1) {
                        setTimeout(() => {
                            restoreConstraintDetails();
                            // profileSubStepì´ 2ì¸ ê²½ìš°ì—ë§Œ ë‚˜ë¥¼ì•Œì•„ê°€ê¸° ì§ˆë¬¸ ë Œë”ë§
                            if (profileSubStep === 2) {
                                renderIntegratedQuestions();
                            }
                        }, 100);
                    }
                    // Step 2ëŠ” ì‹¬ì¸µ ì§ˆë¬¸ (generateFollowupQuestionsì—ì„œ ë Œë”ë§)
                    // Step 3ëŠ” ê²°ê³¼ (submitFollowupsAndAnalyzeì—ì„œ ë Œë”ë§)
                } catch (error) {
                }
            }

            // ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= step) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê´€ë¦¬: ì²˜ìŒ ë°©ë¬¸ â†’ ë§¨ ìœ„, ì¬ë°©ë¬¸ â†’ ì´ì „ ìœ„ì¹˜
            setTimeout(() => {
                if (visitedSteps[step] !== undefined) {
                    window.scrollTo(0, visitedSteps[step]);
                } else {
                    window.scrollTo(0, 0);
                    visitedSteps[step] = 0;
                }
            }, 50);
        }
        
        // ============================================
        // Step 0: ë¶„ì„ ìœ í˜• ì„ íƒ
        // ============================================
        function selectAnalysisType(type) {
            selectedAnalysisType = type;
            if (type === 'job') {
                renderStageOptions();
                goToStep(1);
            }
        }
        
        // ============================================
        // Step 1: Stage ì„ íƒ
        // ============================================
        // ============================================
        // Step 1: 5ì¶• ìƒíƒœì¢Œí‘œ UI ë Œë”ë§
        // ============================================
        // ============================================
        // ë¹„í™œì„±í™” ê·œì¹™ + ë¹„í™œì„±í™” ì‚¬ìœ 
        // ============================================
        const ROLE_DISABLED_RULES = {
            student: {
                career_stage: ['3_10', '10_plus'],
                transition_status: ['return_work', 'second_career'],
                skill_level: [3, 4],
                reasons: {
                    career_stage: 'í•™ìƒ ìƒíƒœì—ì„œëŠ” ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”',
                    transition_status: 'í•™ìƒ ìƒíƒœì—ì„œëŠ” í•´ë‹¹í•˜ì§€ ì•Šì•„ìš”',
                    skill_level: 'í•™ìƒ ìƒíƒœì—ì„œëŠ” ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”'
                }
            },
            worker: {
                career_stage: [],
                transition_status: ['first_job'],
                skill_level: [],
                reasons: { transition_status: 'ì´ë¯¸ ì§ì¥ì¸ì´ì—ìš”' }
            },
            manager: {
                career_stage: ['none'],
                transition_status: ['first_job'],
                skill_level: [0],
                reasons: {
                    career_stage: 'ê´€ë¦¬ìëŠ” ê²½í—˜ì´ ìˆì–´ì•¼ í•´ìš”',
                    transition_status: 'ì´ë¯¸ ì§ì¥ì¸ì´ì—ìš”',
                    skill_level: 'ê´€ë¦¬ìëŠ” ê²½í—˜ì´ ìˆì–´ì•¼ í•´ìš”'
                }
            },
            entrepreneur: {
                career_stage: [],
                transition_status: ['first_job'],
                skill_level: [],
                reasons: { transition_status: 'ì´ë¯¸ ì‚¬ì—…ì„ ìš´ì˜ ì¤‘ì´ì—ìš”' }
            },
            job_seeker: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            }
        };
        
        // ============================================
        // ì „ë¬¸ì ì¸ UI ë Œë”ë§ í•¨ìˆ˜ë“¤
        // ============================================
        function renderCareerStateForm() {
            renderRoleOptions();
            updateCareerStageOptions();
            updateTransitionStatusOptions();
            updateSkillLevelOptions();
            renderConstraintOptions();
            // í†µí•© ì§ˆë¬¸ì€ goToProfileStep2()ì—ì„œ í•™ìƒ/ì§ì¥ì¸ ì„ íƒ í›„ ë Œë”ë§
        }
        
        // ì¶• 1: ì—­í•  ì •ì²´ì„± (ë‹¤í¬ í…Œë§ˆ ì¹´ë“œ ë””ìì¸)
        function renderRoleOptions() {
            const container = document.getElementById('role-options');
            if (!container) return;
            
            container.innerHTML = ROLE_IDENTITY_OPTIONS.map((opt, idx) => \`
                <button type="button" onclick="selectRole('\${opt.value}', this)"
                        class="role-card group relative overflow-hidden rounded-xl border p-4 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg"
                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                        data-value="\${opt.value}"
                        onmouseover="this.style.borderColor='rgba(67,97,238,0.5)'; this.style.backgroundColor='rgba(26,26,46,1)';"
                        onmouseout="if(!this.classList.contains('selected')){this.style.borderColor='rgba(42,42,62,0.5)'; this.style.backgroundColor='rgba(26,26,46,0.9)';}">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-blue-500/10 to-transparent rounded-bl-full"></div>
                    <div class="relative z-10">
                        <div class="text-3xl mb-2 transform group-hover:scale-110 transition-transform">\${opt.emoji}</div>
                        <div class="font-semibold text-white">\${opt.label}</div>
                        <div class="text-xs text-slate-400 mt-1 leading-relaxed">\${opt.description}</div>
                    </div>
                    <div class="tooltip-content absolute left-1/2 -translate-x-1/2 bottom-full mb-3 px-4 py-2 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none w-56 text-center z-50 shadow-xl border border-slate-700">
                        \${opt.help}
                    </div>
                </button>
            \`).join('');
        }
        
        function selectRole(value, btnEl) {
            careerState.role_identity = value;
            
            // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('#role-options .role-card').forEach(btn => {
                btn.classList.remove('selected', 'shadow-lg');
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
            });
            btnEl.classList.add('selected', 'shadow-lg');
            btnEl.style.borderColor = '#4361ee';
            btnEl.style.backgroundColor = 'rgba(67,97,238,0.2)';
            
            // ë‹¤ë¥¸ ì¶•ë“¤ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
            setTimeout(() => {
                updateCareerStageOptions();
                updateTransitionStatusOptions();
                updateSkillLevelOptions();
            }, 150);
            
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // ì¶• 2: ê²½ë ¥ ê¸°ê°„ (ë‹¤í¬ í…Œë§ˆ í”„ë¡œê·¸ë ˆìŠ¤ ë°”)
        function updateCareerStageOptions() {
            const container = document.getElementById('career-stage-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { career_stage: [], reasons: {} };
            const disabledValues = rules.career_stage || [];
            const reason = rules.reasons?.career_stage || 'í˜„ì¬ ìƒíƒœì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”';
            
            container.innerHTML = CAREER_STAGE_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.career_stage_years === opt.value;
                const progressWidth = [0, 33, 66, 100][idx];
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(67,97,238,0.2); border-color: #4361ee;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectCareerStage('\${opt.value}', this)"\`}
                            class="career-stage-btn group relative overflow-hidden rounded-xl p-4 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute inset-0 bg-stripes opacity-20"></div>
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#4361ee' : '#fff'}">\${opt.label}</span>
                                \${isSelected ? '<span style="color: #4361ee" class="text-lg">âœ“</span>' : ''}
                            </div>
                            <div class="text-xs mb-3" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                            
                            <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                            <div class="h-1.5 rounded-full overflow-hidden" style="background-color: rgba(42,42,62,0.3)">
                                <div class="h-full rounded-full transition-all duration-500" 
                                     style="width: \${progressWidth}%; background-color: \${isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? '#4361ee' : 'rgba(148,163,184,0.5)'}"></div>
                            </div>
                        </div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                ğŸ”’ \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
            
            // ì„ íƒê°’ ì´ˆê¸°í™” (ë¹„í™œì„±í™”ëœ ê²½ìš°)
            if (disabledValues.includes(careerState.career_stage_years)) {
                careerState.career_stage_years = null;
            }
        }
        
        function selectCareerStage(value, btnEl) {
            careerState.career_stage_years = value;
            updateCareerStageOptions();
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // ì¶• 3: í˜„ì¬ ëª©í‘œ (ë‹¤í¬ í…Œë§ˆ ì¹© ìŠ¤íƒ€ì¼)
        function updateTransitionStatusOptions() {
            const container = document.getElementById('transition-status-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { transition_status: [], reasons: {} };
            const disabledValues = rules.transition_status || [];
            const reason = rules.reasons?.transition_status || 'í˜„ì¬ ìƒíƒœì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”';
            
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = careerState.transition_status ? [careerState.transition_status] : [];
            }
            
            // ë¹„í™œì„±í™”ëœ ê°’ ì œê±°
            careerState.transition_status = careerState.transition_status.filter(v => !disabledValues.includes(v));
            
            container.innerHTML = TRANSITION_STATUS_OPTIONS.map(opt => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.transition_status.includes(opt.value);
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(16,185,129,0.2); border-color: #10b981;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="toggleTransitionStatus('\${opt.value}', this)"\`}
                            class="goal-chip group relative rounded-xl p-4 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : isSelected ? 'shadow-lg transform scale-[1.02]' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : isSelected ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <div class="text-2xl mb-2 \${isDisabled ? 'grayscale opacity-50' : ''}">\${opt.emoji}</div>
                        <div class="font-semibold text-sm" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#34d399' : '#fff'}">\${opt.label}</div>
                        <div class="text-xs mt-1" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? 'rgba(110,231,183,0.8)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                ğŸ”’ \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function toggleTransitionStatus(value, btnEl) {
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            
            const idx = careerState.transition_status.indexOf(value);
            if (idx === -1) {
                careerState.transition_status.push(value);
            } else {
                careerState.transition_status.splice(idx, 1);
            }
            
            updateTransitionStatusOptions();
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // ì¶• 4: ìˆ™ë ¨ë„ (ë‹¤í¬ í…Œë§ˆ ë ˆë²¨ ê²Œì´ì§€)
        function updateSkillLevelOptions() {
            const container = document.getElementById('skill-level-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { skill_level: [], reasons: {} };
            const disabledValues = rules.skill_level || [];
            const reason = rules.reasons?.skill_level || 'í˜„ì¬ ìƒíƒœì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”';
            
            // ë¹„í™œì„±í™”ëœ ê°’ ì´ˆê¸°í™”
            if (disabledValues.includes(careerState.skill_level)) {
                careerState.skill_level = null;
            }
            
            container.innerHTML = SKILL_LEVEL_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.skill_level === opt.value;
                const levelBars = idx + 1;
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(139,92,246,0.2); border-color: #8b5cf6;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectSkillLevel(\${opt.value}, this)"\`}
                            class="skill-btn group relative rounded-xl p-3 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : isSelected ? 'shadow-lg' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-3.5 h-3.5 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <!-- ë ˆë²¨ ë°” -->
                        <div class="flex gap-1 mb-2 justify-center">
                            \${[1,2,3,4,5].map(i => \`
                                <div class="w-3 h-6 rounded-sm transition-all duration-300" 
                                     style="background-color: \${i <= levelBars 
                                        ? isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? '#8b5cf6' : 'rgba(148,163,184,0.5)'
                                        : 'rgba(42,42,62,0.3)'}"></div>
                            \`).join('')}
                        </div>
                        
                        <div class="font-semibold text-sm" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#a78bfa' : '#fff'}">\${opt.label}</div>
                        <div class="text-xs mt-0.5" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                ğŸ”’ \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function selectSkillLevel(value, btnEl) {
            careerState.skill_level = value;
            updateSkillLevelOptions();
            checkStep1Completion();
        }
        
        function selectAxis(axis, value, btnEl) {
            careerState[axis] = value;
            const container = btnEl.parentElement;
            container.querySelectorAll('.axis-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            });
            btnEl.classList.add('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // ============================================
        // ì¶• 5: ì œì•½ ì¡°ê±´ (ë‹¤í¬ í…Œë§ˆ ì•„ì½”ë””ì–¸ ì¹´ë“œ)
        // ============================================
        let noConstraintSelected = false;
        
        function renderConstraintOptions() {
            const container = document.getElementById('constraint-options');
            if (!container) return;
            
            container.innerHTML = \`
                <!-- ì œì•½ ì—†ìŒ ì¹´ë“œ -->
                <div class="mb-4">
                    <button type="button" onclick="toggleNoConstraint(this)" id="no-constraint-btn"
                            class="w-full p-4 rounded-xl border border-dashed hover:border-emerald-500/50 transition-all duration-300 group"
                            style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.5);">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" style="background-color: rgba(16,185,129,0.2);">
                                âœ…
                            </div>
                            <div class="text-left flex-1">
                                <div class="font-semibold text-white">ì œì•½ ì—†ìŒ</div>
                                <div class="text-sm" style="color: rgb(148,163,184)">íŠ¹ë³„í•œ ì œì•½ ì¡°ê±´ ì—†ì´ ëª¨ë“  ì˜µì…˜ì„ ê³ ë ¤í•´ìš”</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center no-constraint-check opacity-0 transition-opacity" style="border-color: rgba(42,42,62,0.5);">
                                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </button>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                    <span class="text-xs font-medium" style="color: rgb(148,163,184)">ë˜ëŠ” ì œì•½ ì¡°ê±´ ì„ íƒ</span>
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                </div>
                
                <!-- ì œì•½ ì¡°ê±´ ì¹´ë“œë“¤ -->
                <div id="constraint-list" class="grid gap-3 transition-all duration-300">
                    \${CONSTRAINT_OPTIONS.map(opt => \`
                        <div class="constraint-card rounded-xl border overflow-hidden transition-all duration-300" 
                             style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.9);"
                             data-type="\${opt.type}">
                            
                            <!-- í—¤ë” (í´ë¦­ ì˜ì—­) -->
                            <button type="button" onclick="toggleConstraint('\${opt.type}', this)"
                                    class="constraint-header w-full p-4 flex items-center gap-4 text-left transition-colors"
                                    onmouseover="this.style.backgroundColor='rgba(26,26,46,1)';"
                                    onmouseout="this.style.backgroundColor='transparent';">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl flex-shrink-0" style="background-color: rgba(245,158,11,0.2);">
                                    \${opt.emoji}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-white">\${opt.label}</div>
                                    <div class="text-sm truncate" style="color: rgb(148,163,184)">\${opt.description}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="constraint-badge hidden px-2 py-1 text-amber-400 text-xs font-medium rounded-full" style="background-color: rgba(245,158,11,0.2);">
                                        ì„ íƒë¨
                                    </div>
                                    <svg class="constraint-chevron w-5 h-5 transition-transform duration-300" style="color: rgb(148,163,184)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </button>
                            
                            <!-- ìƒì„¸ ë‚´ìš© (í¼ì¹¨) -->
                            <div class="constraint-detail hidden border-t" style="border-color: rgba(42,42,62,0.3); background-color: rgba(15,15,35,0.5);">
                                <div class="p-4 space-y-4">
                                    <!-- ë¹ ë¥¸ ì„ íƒ íƒœê·¸ -->
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">êµ¬ì²´ì ì¸ ìƒí™© (ì„ íƒ)</label>
                                        <div class="flex flex-wrap gap-2">
                                            \${opt.details.map(d => \`
                                                <button type="button" onclick="selectConstraintDetail('\${opt.type}', '\${d.value}', this)"
                                                        class="detail-tag px-3 py-1.5 text-sm rounded-full border"
                                                        data-value="\${d.value}">
                                                    \${d.label}
                                                </button>
                                            \`).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- ìƒì„¸ ì„¤ëª… ì…ë ¥ -->
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">ì¶”ê°€ ì„¤ëª… (ì„ íƒ)</label>
                                        <div class="relative">
                                            <textarea class="constraint-textarea w-full px-4 py-3 text-sm border rounded-lg transition-all resize-none"
                                                      style="border-color: rgba(42,42,62,0.5); background-color: rgba(15,15,35,1); color: #fff;"
                                                      rows="2"
                                                      placeholder="\${opt.placeholder}"
                                                      onfocus="this.style.borderColor='rgba(245,158,11,0.5)';"
                                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)';"
                                                      onchange="updateConstraintCustomDetail('\${opt.type}', this.value)"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }
        
        function toggleNoConstraint(btnEl) {
            noConstraintSelected = !noConstraintSelected;
            const checkEl = btnEl.querySelector('.no-constraint-check');
            const constraintList = document.getElementById('constraint-list');
            
            if (noConstraintSelected) {
                // ì„ íƒ ìƒíƒœ
                btnEl.classList.add('border-solid', 'shadow-lg');
                btnEl.classList.remove('border-dashed');
                btnEl.style.borderColor = '#10b981';
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                checkEl.classList.remove('opacity-0');
                checkEl.classList.add('opacity-100');
                checkEl.style.backgroundColor = '#10b981';
                checkEl.style.borderColor = '#10b981';
                
                // ëª¨ë“  ì œì•½ í•´ì œ
                careerState.constraints = {};
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.add('opacity-30', 'pointer-events-none');
                    card.querySelector('.constraint-badge')?.classList.add('hidden');
                    card.querySelector('.constraint-detail')?.classList.add('hidden');
                    card.querySelector('.constraint-chevron')?.classList.remove('rotate-180');
                });
                constraintList.classList.add('opacity-50');
            } else {
                // ì„ íƒ í•´ì œ
                btnEl.classList.remove('border-solid', 'shadow-lg');
                btnEl.classList.add('border-dashed');
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                checkEl.classList.remove('opacity-100');
                checkEl.style.backgroundColor = 'transparent';
                checkEl.style.borderColor = 'rgba(42,42,62,0.5)';
                
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                constraintList.classList.remove('opacity-50');
            }
        }
        
        function toggleConstraint(type, btnEl) {
            // "ì œì•½ ì—†ìŒ" ìë™ í•´ì œ
            if (noConstraintSelected) {
                noConstraintSelected = false;
                const noBtn = document.getElementById('no-constraint-btn');
                const checkEl = noBtn.querySelector('.no-constraint-check');
                noBtn.classList.remove('border-solid', 'shadow-lg');
                noBtn.classList.add('border-dashed');
                noBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noBtn.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                document.getElementById('constraint-list').classList.remove('opacity-50');
            }
            
            const card = btnEl.closest('.constraint-card');
            const badge = card.querySelector('.constraint-badge');
            const detail = card.querySelector('.constraint-detail');
            const chevron = card.querySelector('.constraint-chevron');
            const isSelected = careerState.constraints[type]?.has_constraint;
            
            if (isSelected) {
                // ì œì•½ í•´ì œ
                delete careerState.constraints[type];
                card.classList.remove('shadow-lg');
                card.style.borderColor = 'rgba(42,42,62,0.5)';
                badge.classList.add('hidden');
                detail.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                
                // íƒœê·¸ ì„ íƒ ì´ˆê¸°í™”
                detail.querySelectorAll('.detail-tag').forEach(tag => {
                    tag.classList.remove('selected');
                    tag.style.backgroundColor = 'rgba(26,26,46,0.5)';
                    tag.style.borderColor = 'rgba(42,42,62,0.5)';
                    tag.style.color = 'rgb(148,163,184)';
                });
            } else {
                // ì œì•½ ì„ íƒ
                careerState.constraints[type] = { has_constraint: true };
                card.classList.add('shadow-lg');
                card.style.borderColor = '#f59e0b';
                badge.classList.remove('hidden');
                detail.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            }
        }
        
        function selectConstraintDetail(type, value, btnEl) {
            if (!careerState.constraints[type]) return;

            const isCurrentlySelected = btnEl.classList.contains('selected');

            // details ë°°ì—´ ì´ˆê¸°í™”
            if (!careerState.constraints[type].details) {
                careerState.constraints[type].details = [];
            }
            if (!Array.isArray(careerState.constraints[type].details)) {
                careerState.constraints[type].details = careerState.constraints[type].details
                    ? [careerState.constraints[type].details] : [];
            }

            // í† ê¸€: ì„ íƒ/í•´ì œ
            if (isCurrentlySelected) {
                btnEl.classList.remove('selected');
                careerState.constraints[type].details = careerState.constraints[type].details.filter(v => v !== value);
            } else {
                btnEl.classList.add('selected');
                if (!careerState.constraints[type].details.includes(value)) {
                    careerState.constraints[type].details.push(value);
                }
            }
            
            // ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ì ìš© (ë¸Œë¼ìš°ì € ë¦¬í˜ì¸íŠ¸ ì§€ì—° ë°©ì§€)
            applyDetailTagStyle(btnEl, !isCurrentlySelected);
        }
        
        // ì œì•½ì¡°ê±´ ì„¸ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš© (requestAnimationFrameìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜)
        function applyDetailTagStyle(btn, isSelected) {
            const styles = isSelected
                ? { bg: 'rgba(245,158,11,0.2)', border: 'rgba(245,158,11,0.5)', color: '#f59e0b' }
                : { bg: 'rgba(26,26,46,0.5)', border: 'rgba(42,42,62,0.5)', color: 'rgb(148,163,184)' };
            
            const applyStyles = () => {
                btn.style.setProperty('background-color', styles.bg, 'important');
                btn.style.setProperty('border-color', styles.border, 'important');
                btn.style.setProperty('color', styles.color, 'important');
            };
            
            applyStyles();
            requestAnimationFrame(applyStyles);
        }
        
        function updateConstraintCustomDetail(type, value) {
            if (!careerState.constraints[type]) return;
            careerState.constraints[type].custom_detail = value;
        }
        
        // ì œì•½ì¡°ê±´ ì„¸ë¶€ì‚¬í•­ ë³µì› í•¨ìˆ˜
        function restoreConstraintDetails() {
            if (!careerState.constraints) return;
            
            for (const [type, constraint] of Object.entries(careerState.constraints)) {
                const card = document.querySelector(\`.constraint-card[data-type="\${type}"]\`);
                if (card && constraint.has_constraint) {
                    const detail = card.querySelector('.constraint-detail');
                    const chevron = card.querySelector('.constraint-chevron');
                    const badge = card.querySelector('.constraint-badge');
                    
                    // ì¹´ë“œ ì„ íƒ ìƒíƒœ í‘œì‹œ
                    card.style.borderColor = 'rgba(245,158,11,0.5)';
                    card.style.backgroundColor = 'rgba(245,158,11,0.05)';
                    
                    if (badge) badge.classList.remove('hidden');
                    if (detail && chevron) {
                        detail.classList.remove('hidden');
                        chevron.classList.add('rotate-180');
                    }
                    
                    // ì„¸ë¶€ì‚¬í•­ ë²„íŠ¼ ì„ íƒ ìƒíƒœ ë³µì›
                    if (constraint.details && Array.isArray(constraint.details)) {
                        for (const value of constraint.details) {
                            const btn = card.querySelector(\`.detail-tag[data-value="\${value}"]\`);
                            if (btn && !btn.classList.contains('selected')) {
                                btn.classList.add('selected');
                                applyDetailTagStyle(btn, true);
                            }
                        }
                    }
                    
                    // ì¶”ê°€ ì„¤ëª… ë³µì›
                    if (constraint.custom_detail) {
                        const textarea = card.querySelector('.constraint-textarea');
                        if (textarea) textarea.value = constraint.custom_detail;
                    }
                }
            }
        }
        
        function updateSelectedStageFromCareerState() {
            // ê¸°ì¡´ ë¡œì§ê³¼ í˜¸í™˜ì„±ì„ ìœ„í•´ careerStateë¥¼ ê¸°ë°˜ìœ¼ë¡œ selectedStage ì„¤ì •
            const { role_identity, career_stage_years, transition_status } = careerState;
            
            if (role_identity === 'student') {
                selectedStage = 'job_student';
            } else if (transition_status === 'changer' || transition_status === 'returner') {
                selectedStage = 'job_transition';
            } else if (transition_status === 'second_career') {
                selectedStage = 'job_second';
            } else if (career_stage_years === 'none') {
                selectedStage = 'job_explore';
            } else if (career_stage_years === '0_3') {
                selectedStage = 'job_early';
            } else {
                selectedStage = 'job_mid';
            }
        }
        
        function checkStep1Completion() {
            const { role_identity, career_stage_years, transition_status, skill_level } = careerState;
            
            // 5ì¶• ìƒíƒœ í™•ì¸
            const stateComplete = role_identity && career_stage_years && transition_status && skill_level !== null;
            
            // í†µí•© ì§ˆë¬¸ í™•ì¸ (í•„ìˆ˜: ê´€ì‹¬ë¶„ì•¼, ê°€ì¹˜, ì—…ë¬´ìŠ¤íƒ€ì¼)
            const hasInterest = integratedAnswers.univ_interest && integratedAnswers.univ_interest.length > 0;
            const hasPriority = integratedAnswers.univ_priority && 
                (Array.isArray(integratedAnswers.univ_priority) ? integratedAnswers.univ_priority.length > 0 : !!integratedAnswers.univ_priority);
            const hasWorkstyle = !!integratedAnswers.univ_workstyle_social;
            
            const questionsComplete = hasInterest && hasPriority && hasWorkstyle;
            const isComplete = stateComplete && questionsComplete;
            
            const nextBtn = document.getElementById('step1-next-btn');
            if (nextBtn) {
                nextBtn.disabled = !isComplete;
                if (isComplete) {
                    nextBtn.classList.add('hover-glow');
                } else {
                    nextBtn.classList.remove('hover-glow');
                }
            }
        }
        
        // validateStep1ì€ checkStep1Completionì˜ ë³„ì¹­
        function validateStep1() {
            checkStep1Completion();
        }
        
        // ê¸°ì¡´ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
        function renderStageOptions() {
            renderCareerStateForm();
        }
        
        function selectStage(stageId) {
            selectedStage = stageId;
        }
        
        // ============================================
        // í†µí•© ì§ˆë¬¸ ë°ì´í„° (ê¸°ì¡´ ë¯¸ë‹ˆëª¨ë“ˆ í† í° ë§¤í•‘ ìœ ì§€)
        // ============================================
        const TOKEN_MAPPING = {
            // interest ë§¤í•‘
            problem_solving: 'problem_solving',
            creating: 'creating',
            helping: 'helping_teaching',
            data: 'data_numbers',
            tech: 'tech',
            organizing: 'organizing',
            influencing: 'influencing',
            nature: 'nature',
            health: 'health',
            media: 'media',
            // value ë§¤í•‘
            autonomy: 'autonomy',
            growth: 'growth',
            stability: 'stability',
            income: 'income',
            meaning: 'meaning',
            recognition: 'recognition',
            wlb: 'wlb',
            // strength ë§¤í•‘
            analytical: 'analytical',
            creative: 'creative',
            communication: 'communication',
            structured_execution: 'structured_execution',
            persistence: 'persistence',
            fast_learning: 'fast_learning',
            empathy: 'empathy',
            leadership: 'leadership',
        };
        
        // í†µí•© ì§ˆë¬¸ ê²°ê³¼ ì €ì¥ (ê¸°ì¡´ ë¯¸ë‹ˆëª¨ë“ˆê³¼ í˜¸í™˜)
        window.miniModuleResult = null;
        let integratedAnswers = {};
        
        // í†µí•© ì§ˆë¬¸ ë Œë”ë§ í•¨ìˆ˜
        // í•™ìƒìš© ì§ˆë¬¸ í…ìŠ¤íŠ¸ ë³€í™˜ ë§¤í•‘
        const studentQuestionTexts = {
            'univ_priority': 'ë‚˜ì¤‘ì— ì¼ì„ í•˜ê²Œ ëœë‹¤ë©´ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê±´ ë­”ê°€ìš”?',
            'univ_workstyle_social': 'ë¬´ì–¸ê°€ë¥¼ í•  ë•Œ ì–´ë–¤ ë°©ì‹ì´ ë” í¸í•œê°€ìš”?',
            'mm_sacrifice': 'ê¿ˆì„ ìœ„í•´ ê°ìˆ˜í•  ìˆ˜ ìˆëŠ” ê²ƒì€?',
            'mm_energy_drain': 'ì–´ë–¨ ë•Œ ê°€ì¥ ë¹¨ë¦¬ ì§€ì¹˜ë‚˜ìš”?',
            'mm_achievement': 'ì˜í•˜ê³  ìˆë‹¤ëŠ” ëŠë‚Œì€ ì–¸ì œ ë“œë‚˜ìš”?',
            'mm_execution': 'ìƒˆë¡œìš´ ê²ƒì„ ì‹œì‘í•  ë•Œ ë‚˜ëŠ”?',
            'mm_failure': 'ì¼ì´ë‚˜ ê³µë¶€ê°€ ì˜ ì•ˆ ëì„ ë•Œ, ë‚˜ëŠ” ë³´í†µ ì–´ë–¤ ë°˜ì‘ì— ê°€ê¹ë‚˜ìš”?',
            'mm_anchor': 'í˜ë“¤ì–´ë„ ê³„ì†í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê±´?',
        };
        
        function renderIntegratedQuestions() {
            const container = document.getElementById('integrated-questions-container');
            if (!container) return;
            
            const questions = JSON.parse('${universalQuestionsJson}');
            
            // í•™ìƒ ì—¬ë¶€ í™•ì¸
            const isStudent = careerState.role_identity === 'student';
            
            container.innerHTML = questions.map((q, idx) => {
                const isRequired = q.required;
                const maxSel = q.max_selections || 3;
                
                // í•™ìƒìš© ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì ìš©
                const questionText = isStudent && studentQuestionTexts[q.id] 
                    ? studentQuestionTexts[q.id] 
                    : q.text;
                
                return \`
                    <div class="integrated-question mb-6 p-5 rounded-xl" 
                         style="background: linear-gradient(135deg, rgba(99,102,241,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(99,102,241,0.2);"
                         data-question-id="\${q.id}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-6 h-6 bg-wiki-primary/30 text-wiki-primary rounded-full flex items-center justify-center text-xs font-bold">\${idx + 1}</span>
                            <h4 class="font-semibold text-white">\${questionText}</h4>
                            \${isRequired ? '<span class="text-red-400 text-xs">*í•„ìˆ˜</span>' : ''}
                        </div>
                        \${q.help_text ? \`<p class="text-xs text-emerald-400 mb-3 ml-8">\${q.help_text}</p>\` : ''}
                        \${q.ui_type === 'chips' ? \`
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" 
                                            onclick="toggleIntegratedChip('\${q.id}', '\${opt.value}', this, \${maxSel})"
                                            class="int-chip px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}"
                                            data-token="\${opt.token || opt.value}">
                                        <span class="mr-1">\${opt.emoji || ''}</span>\${opt.label}
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" 
                                            onclick="toggleIntegratedChip('\${q.id}', 'unknown', this, \${maxSel})"
                                            class="int-chip px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="unknown">
                                        <span class="mr-1">â“</span>\${q.unknown_label || 'ëª¨ë¥´ê² ì–´ìš”'}
                                    </button>
                                \` : ''}
                                \${q.allow_other ? \`
                                    <button type="button" 
                                            onclick="showIntegratedOtherInput('\${q.id}', this)"
                                            class="int-chip int-other-btn px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="other">
                                        <span class="mr-1">âœï¸</span>\${q.other_label || 'ê¸°íƒ€'}
                                    </button>
                                \` : ''}
                            </div>
                            \${q.allow_other ? \`
                            <div id="\${q.id}-other-input" class="hidden mt-3">
                                <input type="text" 
                                       id="\${q.id}-other-text"
                                       placeholder="ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”" 
                                       class="w-full px-3 py-2 rounded-lg border text-sm"
                                       style="background: rgba(15,15,35,0.8); border-color: rgba(99,102,241,0.5); color: white;"
                                       onkeyup="updateIntegratedOtherValue('\${q.id}')"
                                       maxlength="50">
                            </div>
                            \` : ''}
                            <p class="text-xs text-wiki-muted mt-2">ìµœëŒ€ \${maxSel}ê°œ ì„ íƒ</p>
                        \` : q.ui_type === 'radio' ? \`
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" 
                                            onclick="selectIntegratedRadio('\${q.id}', '\${opt.value}', this)"
                                            class="int-radio px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <span class="mr-1">\${opt.emoji || ''}</span>\${opt.label}
                                    </button>
                                \`).join('')}
                                \${q.allow_other ? \`
                                    <button type="button" 
                                            onclick="showIntegratedOtherInput('\${q.id}', this, true)"
                                            class="int-radio int-other-btn px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="other">
                                        <span class="mr-1">âœï¸</span>\${q.other_label || 'ê¸°íƒ€'}
                                    </button>
                                \` : ''}
                            </div>
                            \${q.allow_other ? \`
                            <div id="\${q.id}-other-input" class="hidden mt-3">
                                <input type="text" 
                                       id="\${q.id}-other-text"
                                       placeholder="ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”" 
                                       class="w-full px-3 py-2 rounded-lg border text-sm"
                                       style="background: rgba(15,15,35,0.8); border-color: rgba(99,102,241,0.5); color: white;"
                                       onkeyup="updateIntegratedOtherValue('\${q.id}', true)"
                                       maxlength="50">
                            </div>
                            \` : ''}
                        \` : q.ui_type === 'language_chips' ? \`
                            <div class="language-selector-integrated" data-question-id="\${q.id}">
                                <!-- ì£¼ìš” ì–¸ì–´ ë²„íŠ¼ë“¤ -->
                                <div class="flex flex-wrap gap-2 mb-3">
                                    \${q.options.map(opt => \`
                                        <button type="button" 
                                                onclick="toggleIntegratedLanguage('\${q.id}', '\${opt.value}', '\${opt.label}', this)"
                                                class="int-lang-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                                data-value="\${opt.value}">
                                            <span class="flex items-center gap-2">
                                                <span class="text-lg">\${opt.emoji || ''}</span>
                                                <span style="color: rgb(148,163,184);">\${opt.label}</span>
                                            </span>
                                            <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden lang-check">âœ“</div>
                                        </button>
                                    \`).join('')}
                                    \${q.allow_unknown ? \`
                                        <button type="button" 
                                                onclick="toggleIntegratedLanguageNone('\${q.id}', this)"
                                                class="int-lang-chip int-lang-none px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                                data-value="none">
                                            <span class="flex items-center gap-2">
                                                <span class="text-lg">âŒ</span>
                                                <span style="color: rgb(148,163,184);">\${q.unknown_label || 'ì—†ì–´ìš”'}</span>
                                            </span>
                                        </button>
                                    \` : ''}
                                    <button type="button" 
                                            onclick="showIntegratedOtherLanguages('\${q.id}')"
                                            class="int-lang-other-btn px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">ğŸŒ</span>
                                            <span style="color: rgb(148,163,184);">ê¸°íƒ€ ì–¸ì–´</span>
                                        </span>
                                    </button>
                                </div>
                                
                                <!-- ìˆ˜ì¤€ ì„ íƒ íŒ¨ë„ -->
                                <div id="\${q.id}-level-panel" class="hidden mt-3 p-4 rounded-xl animate-fadeIn" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                                    <p class="text-sm mb-3" style="color: rgb(148,163,184);">
                                        <span id="\${q.id}-level-label" class="font-semibold text-white">ì˜ì–´</span> ìˆ˜ì¤€ì„ ì„ íƒí•´ì£¼ì„¸ìš”:
                                    </p>
                                    <div class="flex flex-wrap gap-3">
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'basic')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="basic">
                                            <span class="text-lg">ğŸ’¬</span>
                                            <span style="color: rgb(148,163,184);">ì¼ìƒíšŒí™”</span>
                                        </button>
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'business')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="business">
                                            <span class="text-lg">ğŸ’¼</span>
                                            <span style="color: rgb(148,163,184);">ì—…ë¬´ê°€ëŠ¥</span>
                                        </button>
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'native')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="native">
                                            <span class="text-lg">ğŸ†</span>
                                            <span style="color: rgb(148,163,184);">ì›ì–´ë¯¼ê¸‰</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- ê¸°íƒ€ ì–¸ì–´ ì„ íƒ íŒ¨ë„ -->
                                <div id="\${q.id}-other-panel" class="hidden mt-3 p-4 rounded-xl animate-fadeIn" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.3);">
                                    <p class="text-sm mb-3" style="color: rgb(148,163,184);">ì–´ë–¤ ì–¸ì–´ì¸ê°€ìš”?</p>
                                    <div class="flex flex-wrap gap-2">
                                        \${(q.other_languages || []).map(lang => \`
                                            <button type="button" onclick="selectIntegratedOtherLanguage('\${q.id}', '\${lang.value}', '\${lang.label}')"
                                                    class="int-other-lang-btn px-3 py-2 rounded-lg border transition-all duration-200 text-sm"
                                                    style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);">
                                                \${lang.label}
                                            </button>
                                        \`).join('')}
                                    </div>
                                </div>
                                
                                <!-- ì„ íƒëœ ì–¸ì–´ í‘œì‹œ -->
                                <div id="\${q.id}-selected" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>
                        \` : ''}
                    </div>
                \`;
            }).join('');
            
            // ê¸°ì¡´ ì„ íƒ ë‹µë³€ ë³µì›
            restoreIntegratedAnswers();
        }
        
        // ê¸°ì¡´ í†µí•© ì§ˆë¬¸ ë‹µë³€ ë³µì› í•¨ìˆ˜
        function restoreIntegratedAnswers() {
            if (!integratedAnswers || Object.keys(integratedAnswers).length === 0) return;
            
            
            Object.keys(integratedAnswers).forEach(questionId => {
                const value = integratedAnswers[questionId];
                if (!value) return;
                
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) return;
                
                // ë°°ì—´ì¸ ê²½ìš° (chips)
                if (Array.isArray(value)) {
                    value.forEach(v => {
                        const btn = container.querySelector(\`[data-value="\${v}"]\`);
                        if (btn && !btn.classList.contains('selected')) {
                            btn.classList.add('selected');
                            btn.style.background = 'linear-gradient(135deg, rgba(67,97,238,0.3), rgba(168,85,247,0.2))';
                            btn.style.borderColor = 'rgba(67,97,238,0.5)';
                        }
                    });
                } 
                // ë¬¸ìì—´ì¸ ê²½ìš° (radio)
                else if (typeof value === 'string') {
                    const btn = container.querySelector(\`[data-value="\${value}"]\`);
                    if (btn && !btn.classList.contains('selected')) {
                        btn.classList.add('selected');
                        btn.style.background = 'linear-gradient(135deg, rgba(67,97,238,0.3), rgba(168,85,247,0.2))';
                        btn.style.borderColor = 'rgba(67,97,238,0.5)';
                    }
                }
            });
        }
        
        function toggleIntegratedChip(questionId, value, btn, maxSel) {
            if (!integratedAnswers[questionId]) {
                integratedAnswers[questionId] = [];
            }
            
            const arr = integratedAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx >= 0) {
                // ì„ íƒ í•´ì œ
                arr.splice(idx, 1);
                btn.style.background = 'rgba(26,26,46,0.7)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.classList.remove('selected');
            } else {
                // ì„ íƒ ì¶”ê°€
                if (arr.length >= maxSel) {
                    // ê°€ì¥ ì˜¤ë˜ëœ ì„ íƒ ì œê±°
                    const oldValue = arr.shift();
                    const container = btn.closest('.integrated-question');
                    const oldBtn = container.querySelector(\`[data-value="\${oldValue}"]\`);
                    if (oldBtn) {
                        oldBtn.style.background = 'rgba(26,26,46,0.7)';
                        oldBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        oldBtn.classList.remove('selected');
                    }
                }
                arr.push(value);
                btn.style.background = 'rgba(99,102,241,0.2)';
                btn.style.borderColor = 'rgba(99,102,241,0.5)';
                btn.classList.add('selected');
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function selectIntegratedRadio(questionId, value, btn) {
            // ê°™ì€ ì§ˆë¬¸ì˜ ë‹¤ë¥¸ ë¼ë””ì˜¤ ë²„íŠ¼ í•´ì œ
            const container = btn.closest('.integrated-question');
            container.querySelectorAll('.int-radio').forEach(b => {
                b.style.background = 'rgba(26,26,46,0.7)';
                b.style.borderColor = 'rgba(42,42,62,0.5)';
                b.classList.remove('selected');
            });
            
            // ì„ íƒ
            btn.style.background = 'rgba(99,102,241,0.2)';
            btn.style.borderColor = 'rgba(99,102,241,0.5)';
            btn.classList.add('selected');
            
            integratedAnswers[questionId] = value;
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // í†µí•© ì§ˆë¬¸ ì–¸ì–´ ì„ íƒ (ìˆ˜ì¤€ ì„ íƒ í¬í•¨)
        let integratedLanguageSelection = {};  // { questionId: { lang: { level, label } } }
        let currentIntegratedLangQuestion = null;
        let currentIntegratedLangValue = null;
        let currentIntegratedLangLabel = null;
        
        function toggleIntegratedLanguage(questionId, langValue, langLabel, btn) {
            if (!integratedLanguageSelection[questionId]) {
                integratedLanguageSelection[questionId] = {};
            }
            
            const langData = integratedLanguageSelection[questionId];
            
            // 'ì—†ì–´ìš”' ì„ íƒ í•´ì œ
            const noneBtn = btn.closest('.language-selector-integrated')?.querySelector('.int-lang-none');
            if (noneBtn) {
                noneBtn.style.background = 'rgba(26,26,46,0.9)';
                noneBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noneBtn.classList.remove('selected');
            }
            integratedAnswers[questionId + '_none'] = false;
            
            if (langData[langValue]) {
                // ì´ë¯¸ ì„ íƒëœ ì–¸ì–´ â†’ ì„ íƒ í•´ì œ
                delete langData[langValue];
                btn.style.background = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.lang-check')?.classList.add('hidden');
                
                // íŒ¨ë„ ìˆ¨ê¸°ê¸°
                document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
                document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            } else {
                // ìƒˆ ì–¸ì–´ ì„ íƒ â†’ ìˆ˜ì¤€ ì„ íƒ UI í‘œì‹œ
                currentIntegratedLangQuestion = questionId;
                currentIntegratedLangValue = langValue;
                currentIntegratedLangLabel = langLabel;
                
                // ë¼ë²¨ ì—…ë°ì´íŠ¸
                const labelEl = document.getElementById(questionId + '-level-label');
                if (labelEl) labelEl.textContent = langLabel;
                
                // ê¸°íƒ€ íŒ¨ë„ ìˆ¨ê¸°ê³  ìˆ˜ì¤€ íŒ¨ë„ í‘œì‹œ
                document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
                const levelPanel = document.getElementById(questionId + '-level-panel');
                if (levelPanel) {
                    levelPanel.classList.remove('hidden');
                    levelPanel.querySelectorAll('.int-level-btn').forEach(b => {
                        b.style.background = 'rgba(26,26,46,0.9)';
                        b.style.borderColor = 'rgba(42,42,62,0.5)';
                    });
                }
            }
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
        }
        
        function toggleIntegratedLanguageNone(questionId, btn) {
            const container = btn.closest('.language-selector-integrated');
            
            // ëª¨ë“  ì–¸ì–´ ì„ íƒ í•´ì œ
            integratedLanguageSelection[questionId] = {};
            container?.querySelectorAll('.int-lang-chip').forEach(b => {
                b.style.background = 'rgba(26,26,46,0.9)';
                b.style.borderColor = 'rgba(42,42,62,0.5)';
                b.querySelector('.lang-check')?.classList.add('hidden');
            });
            
            // 'ì—†ì–´ìš”' ë²„íŠ¼ ì„ íƒ
            btn.style.background = 'rgba(239,68,68,0.2)';
            btn.style.borderColor = 'rgba(239,68,68,0.5)';
            btn.classList.add('selected');
            
            // íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            
            integratedAnswers[questionId] = ['none'];
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function showIntegratedOtherLanguages(questionId) {
            // ìˆ˜ì¤€ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            // ê¸°íƒ€ ì–¸ì–´ íŒ¨ë„ í‘œì‹œ
            const otherPanel = document.getElementById(questionId + '-other-panel');
            if (otherPanel) {
                otherPanel.classList.toggle('hidden');
            }
        }
        
        function selectIntegratedOtherLanguage(questionId, langValue, langLabel) {
            currentIntegratedLangQuestion = questionId;
            currentIntegratedLangValue = langValue;
            currentIntegratedLangLabel = langLabel;
            
            // ë¼ë²¨ ì—…ë°ì´íŠ¸
            const labelEl = document.getElementById(questionId + '-level-label');
            if (labelEl) labelEl.textContent = langLabel;
            
            // ê¸°íƒ€ íŒ¨ë„ ìˆ¨ê¸°ê³  ìˆ˜ì¤€ íŒ¨ë„ í‘œì‹œ
            document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            const levelPanel = document.getElementById(questionId + '-level-panel');
            if (levelPanel) {
                levelPanel.classList.remove('hidden');
                levelPanel.querySelectorAll('.int-level-btn').forEach(b => {
                    b.style.background = 'rgba(26,26,46,0.9)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                });
            }
        }
        
        function selectIntegratedLanguageLevel(questionId, level) {
            if (!currentIntegratedLangValue) return;
            
            const langValue = currentIntegratedLangValue;
            const langLabel = currentIntegratedLangLabel;
            
            if (!integratedLanguageSelection[questionId]) {
                integratedLanguageSelection[questionId] = {};
            }
            
            // 'ì—†ì–´ìš”' ì„ íƒ í•´ì œ
            const container = document.querySelector(\`.language-selector-integrated[data-question-id="\${questionId}"]\`);
            const noneBtn = container?.querySelector('.int-lang-none');
            if (noneBtn) {
                noneBtn.style.background = 'rgba(26,26,46,0.9)';
                noneBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noneBtn.classList.remove('selected');
            }
            
            // ì–¸ì–´ì— ìˆ˜ì¤€ ì„¤ì •
            integratedLanguageSelection[questionId][langValue] = { level, label: langLabel };
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì£¼ìš” ì–¸ì–´ì¸ ê²½ìš°)
            const langBtn = container?.querySelector(\`.int-lang-chip[data-value="\${langValue}"]\`);
            if (langBtn) {
                langBtn.style.background = 'rgba(99,102,241,0.2)';
                langBtn.style.borderColor = 'rgba(99,102,241,0.5)';
                langBtn.querySelector('.lang-check')?.classList.remove('hidden');
            }
            
            // ìˆ˜ì¤€ ë²„íŠ¼ ê°•ì¡°
            const levelPanel = document.getElementById(questionId + '-level-panel');
            levelPanel?.querySelectorAll('.int-level-btn').forEach(b => {
                if (b.dataset.level === level) {
                    b.style.background = 'rgba(99,102,241,0.2)';
                    b.style.borderColor = 'rgba(99,102,241,0.5)';
                } else {
                    b.style.background = 'rgba(26,26,46,0.9)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                }
            });
            
            // ì ì‹œ í›„ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            }, 300);
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
            currentIntegratedLangValue = null;
            currentIntegratedLangLabel = null;
        }
        
        function updateIntegratedLanguageDisplay(questionId) {
            const selectedContainer = document.getElementById(questionId + '-selected');
            if (!selectedContainer) return;
            
            const langData = integratedLanguageSelection[questionId] || {};
            const levelLabels = { basic: 'ì¼ìƒíšŒí™”', business: 'ì—…ë¬´ê°€ëŠ¥', native: 'ì›ì–´ë¯¼ê¸‰' };
            
            selectedContainer.innerHTML = Object.entries(langData).map(([lang, data]) => \`
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm" 
                     style="background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3);">
                    <span class="text-white font-medium">\${data.label || lang}</span>
                    <span style="color: rgb(148,163,184);">Â·</span>
                    <span style="color: rgb(129,140,248);">\${levelLabels[data.level] || data.level}</span>
                    <button type="button" onclick="removeIntegratedLanguage('\${questionId}', '\${lang}')" 
                            class="ml-1 text-red-400 hover:text-red-300">Ã—</button>
                </div>
            \`).join('');
        }
        
        function removeIntegratedLanguage(questionId, langValue) {
            if (integratedLanguageSelection[questionId]) {
                delete integratedLanguageSelection[questionId][langValue];
            }
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³µì›
            const container = document.querySelector(\`.language-selector-integrated[data-question-id="\${questionId}"]\`);
            const langBtn = container?.querySelector(\`.int-lang-chip[data-value="\${langValue}"]\`);
            if (langBtn) {
                langBtn.style.background = 'rgba(26,26,46,0.9)';
                langBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                langBtn.querySelector('.lang-check')?.classList.add('hidden');
            }
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
        }
        
        function updateIntegratedLanguageAnswers(questionId) {
            const langData = integratedLanguageSelection[questionId] || {};
            const values = Object.entries(langData).map(([lang, data]) => \`\${lang}_\${data.level}\`);
            
            if (values.length > 0) {
                integratedAnswers[questionId] = values;
            } else {
                delete integratedAnswers[questionId];
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // í†µí•© ì§ˆë¬¸ 'ê¸°íƒ€' ì…ë ¥ ì²˜ë¦¬
        let integratedOtherValues = {};  // { questionId: 'ê¸°íƒ€ ì…ë ¥ê°’' }
        
        function showIntegratedOtherInput(questionId, btn, isRadio = false) {
            const container = btn.closest('.integrated-question');
            const inputDiv = document.getElementById(questionId + '-other-input');
            const textInput = document.getElementById(questionId + '-other-text');
            
            if (isRadio) {
                // radio: ê¸°ì¡´ ì„ íƒ í•´ì œ
                container.querySelectorAll('.int-radio').forEach(b => {
                    b.style.background = 'rgba(26,26,46,0.7)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                    b.classList.remove('selected');
                });
            }
            
            // ë²„íŠ¼ ì„ íƒ í‘œì‹œ
            btn.style.background = 'rgba(99,102,241,0.2)';
            btn.style.borderColor = 'rgba(99,102,241,0.5)';
            btn.classList.add('selected');
            
            // ì…ë ¥ í•„ë“œ í‘œì‹œ
            if (inputDiv) {
                inputDiv.classList.remove('hidden');
                textInput?.focus();
            }
            
            // ê¸°ì¡´ ê°’ ìˆìœ¼ë©´ ì„¤ì •
            if (isRadio) {
                integratedAnswers[questionId] = integratedOtherValues[questionId] 
                    ? 'other:' + integratedOtherValues[questionId] 
                    : 'other';
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function updateIntegratedOtherValue(questionId, isRadio = false) {
            const textInput = document.getElementById(questionId + '-other-text');
            const value = textInput?.value?.trim() || '';
            
            integratedOtherValues[questionId] = value;
            
            if (isRadio) {
                // radio: ê¸°íƒ€ê°’ìœ¼ë¡œ ì„¤ì •
                integratedAnswers[questionId] = value ? 'other:' + value : 'other';
            } else {
                // chips: ê¸°ì¡´ ë°°ì—´ì— ê¸°íƒ€ê°’ ì¶”ê°€/ê°±ì‹ 
                if (!integratedAnswers[questionId]) {
                    integratedAnswers[questionId] = [];
                }
                // ê¸°ì¡´ other: ê°’ ì œê±°
                integratedAnswers[questionId] = integratedAnswers[questionId].filter(v => !v.startsWith('other:') && v !== 'other');
                if (value) {
                    integratedAnswers[questionId].push('other:' + value);
                }
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // í†µí•© ì§ˆë¬¸ ë‹µë³€ì„ universalAnswersì™€ miniModuleResultì— ë°˜ì˜
        function updateIntegratedUniversalAnswers() {
            // universalAnswersì— ë°˜ì˜
            for (const [key, value] of Object.entries(integratedAnswers)) {
                universalAnswers[key] = value;
            }
            
            // miniModuleResult ê³„ì‚° (LLM ì•µì»¤ìš©)
            const interest_top = (integratedAnswers.univ_interest || [])
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            const value_top = (Array.isArray(integratedAnswers.univ_priority) 
                ? integratedAnswers.univ_priority 
                : [integratedAnswers.univ_priority])
                .filter(Boolean)
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            const strength_top = (integratedAnswers.univ_strength || [])
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            
            // Step 1ì˜ ì œì•½ì¡°ê±´ì—ì„œ constraint_flags ì¶”ì¶œ
            const constraint_flags = [];
            if (careerState.constraints) {
                for (const [type, data] of Object.entries(careerState.constraints)) {
                    if (data.has_constraint) {
                        constraint_flags.push(type + '_constraint');
                    }
                }
            }
            
            window.miniModuleResult = {
                interest_top,
                value_top,
                strength_top,
                constraint_flags,
                raw_selections: {
                    interest: integratedAnswers.univ_interest || [],
                    value: Array.isArray(integratedAnswers.univ_priority) 
                        ? integratedAnswers.univ_priority 
                        : [integratedAnswers.univ_priority].filter(Boolean),
                    strength: integratedAnswers.univ_strength || [],
                    constraint: constraint_flags,
                }
            };
            
        }
        
        // Step 1 â†’ Step 2 (ì‹¬ì¸µ ì§ˆë¬¸) ì§ì ‘ ì´ë™
        async function goToStep2Direct() {
            // Phase 3: í¸ì§‘ ëª¨ë“œ ìºìŠ¤ì¼€ì´ë“œ ë¦¬ì…‹
            if (window.__editMode && detectStep1Changes()) {
                cascadeResetFromStep1();
            }
            // í†µí•© ì§ˆë¬¸ ê²°ê³¼ ê³„ì‚°
            updateIntegratedUniversalAnswers();
            
            // ì €ì¥
            saveDraftToServer();
            
            // Step 2 (ì‹¬ì¸µ ì§ˆë¬¸)ë¡œ ì´ë™
            goToStep(2);
            
            // V3 ëª¨ë“œ: ê¸°ì´ˆ ì„œìˆ í˜• ì§ˆë¬¸ â†’ ë¼ìš´ë“œ 1,2,3
            if (window.V3_MODE !== false) {
                renderNarrativeStep();
            } else {
                // V2 í´ë°±: ê¸°ë³¸ ì„ íƒí˜• ì§ˆë¬¸
                await generateFollowupQuestions();
            }
        }
        
        // ì‹¬ì¸µ ì§ˆë¬¸ ìƒì„± í•¨ìˆ˜
        async function generateFollowupQuestions() {
            showLoading('ì§ˆë¬¸ êµ¬ì„± ì¤‘...', 'ë§ì¶¤ ì‹¬ì¸µ ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        career_state: careerState,
                        mini_module_result: window.miniModuleResult || null,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                } else {
                    // ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì§ˆë¬¸ í‘œì‹œ
                    renderDefaultFollowupQuestions();
                }
            } catch (error) {
                hideLoading();
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ì§ˆë¬¸ í‘œì‹œ
                renderDefaultFollowupQuestions();
            }
        }
        
        // ê¸°ë³¸ ì‹¬ì¸µ ì§ˆë¬¸ (API ì‹¤íŒ¨ ì‹œ í´ë°±)
        function renderDefaultFollowupQuestions() {
            const defaultQuestions = [
                {
                    id: 'default_work_preference',
                    question: 'í•˜ë£¨ ì—…ë¬´ ì¤‘ ê°€ì¥ ë³´ëŒì„ ëŠë¼ëŠ” ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?',
                    fact_key: 'preference.work_satisfaction',
                    options: [
                        { value: 'problem_solved', label: 'ì–´ë ¤ìš´ ë¬¸ì œë¥¼ í•´ê²°í–ˆì„ ë•Œ' },
                        { value: 'helped_someone', label: 'ëˆ„êµ°ê°€ì—ê²Œ ë„ì›€ì´ ëì„ ë•Œ' },
                        { value: 'learned_new', label: 'ìƒˆë¡œìš´ ê²ƒì„ ë°°ì› ì„ ë•Œ' },
                        { value: 'completed_task', label: 'ì¼ì„ ê¹”ë”í•˜ê²Œ ë§ˆë¬´ë¦¬í–ˆì„ ë•Œ' },
                        { value: 'recognized', label: 'ì„±ê³¼ë¥¼ ì¸ì •ë°›ì•˜ì„ ë•Œ' },
                    ]
                },
                {
                    id: 'default_challenge',
                    question: 'ê°€ì¥ í˜ë“¤ê²Œ ëŠê»´ì§€ëŠ” ì—…ë¬´ ìƒí™©ì€?',
                    fact_key: 'aversion.work_challenge',
                    options: [
                        { value: 'unclear_direction', label: 'ë°©í–¥ì´ ë¶ˆëª…í™•í•  ë•Œ' },
                        { value: 'too_many_people', label: 'ë§ì€ ì‚¬ëŒê³¼ ì¡°ìœ¨í•´ì•¼ í•  ë•Œ' },
                        { value: 'repetitive', label: 'ë°˜ë³µì ì¸ ì¼ì´ ê³„ì†ë  ë•Œ' },
                        { value: 'tight_deadline', label: 'ì´‰ë°•í•œ ë§ˆê°ì— ì«“ê¸¸ ë•Œ' },
                        { value: 'no_feedback', label: 'í”¼ë“œë°±ì´ ì—†ì„ ë•Œ' },
                    ]
                },
                {
                    id: 'default_growth',
                    question: 'ì•ìœ¼ë¡œ ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ì„±ì¥í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?',
                    fact_key: 'goal.growth_direction',
                    options: [
                        { value: 'specialist', label: 'í•œ ë¶„ì•¼ì˜ ì „ë¬¸ê°€ê°€ ë˜ê³  ì‹¶ë‹¤' },
                        { value: 'generalist', label: 'ë‹¤ì–‘í•œ ê²½í—˜ì„ ìŒ“ê³  ì‹¶ë‹¤' },
                        { value: 'leader', label: 'íŒ€ì„ ì´ë„ëŠ” ë¦¬ë”ê°€ ë˜ê³  ì‹¶ë‹¤' },
                        { value: 'entrepreneur', label: 'ë‚˜ë§Œì˜ ì‚¬ì—…ì„ í•˜ê³  ì‹¶ë‹¤' },
                        { value: 'balance', label: 'ì¼ê³¼ ì‚¶ì˜ ê· í˜•ì„ ì°¾ê³  ì‹¶ë‹¤' },
                    ]
                }
            ];
            
            renderFollowupQuestions(defaultQuestions);
        }
        
        // ============================================
        // [DEPRECATED] ë ˆê±°ì‹œ ë¯¸ë‹ˆëª¨ë“ˆ í•¨ìˆ˜ë“¤
        // 3ë‹¨ê³„ êµ¬ì¡°ì—ì„œëŠ” í†µí•© ì§ˆë¬¸ìœ¼ë¡œ ëŒ€ì²´ë¨
        // Draft ë³µì› ë° major í˜ì´ì§€ í˜¸í™˜ì„ ìœ„í•´ ìœ ì§€
        // ============================================
        const MINI_MODULE_DATA = {};  // ë¹ˆ ê°ì²´ë¡œ ëŒ€ì²´
        const MINI_MODULE_ORDER = [];  // ë¹ˆ ë°°ì—´ë¡œ ëŒ€ì²´
        let currentMiniModuleIndex = 0;
        let miniModuleSelections = { interest: [], value: [], strength: [], constraint: [] };
        
        function renderMiniModule() {
            // DEPRECATED: 3ë‹¨ê³„ êµ¬ì¡°ì—ì„œëŠ” renderIntegratedQuestions() ì‚¬ìš©
            const moduleKey = MINI_MODULE_ORDER[currentMiniModuleIndex];
            const module = MINI_MODULE_DATA[moduleKey];
            const container = document.getElementById('mini-module-container');
            if (!container) return;
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            MINI_MODULE_ORDER.forEach((key, idx) => {
                const bar = document.getElementById(\`mm-progress-\${idx + 1}\`);
                if (bar) {
                    if (idx < currentMiniModuleIndex) {
                        bar.className = 'w-16 h-1 rounded-full bg-emerald-500';
                    } else if (idx === currentMiniModuleIndex) {
                        bar.className = 'w-16 h-1 rounded-full bg-amber-500';
                    } else {
                        bar.className = 'w-16 h-1 rounded-full bg-wiki-border/50';
                    }
                }
            });
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const btnText = document.getElementById('mm-btn-text');
            if (btnText) {
                if (currentMiniModuleIndex === MINI_MODULE_ORDER.length - 1) {
                    btnText.textContent = 'ì™„ë£Œ';
                } else {
                    btnText.textContent = 'ë‹¤ìŒ ì˜ì—­';
                }
            }
            
            const colorMap = {
                amber: { bg: 'rgba(245, 158, 11, 0.1)', border: 'rgba(245, 158, 11, 0.3)', text: 'rgb(252, 211, 77)' },
                emerald: { bg: 'rgba(16, 185, 129, 0.1)', border: 'rgba(16, 185, 129, 0.3)', text: 'rgb(110, 231, 183)' },
                blue: { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', text: 'rgb(147, 197, 253)' },
                red: { bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)', text: 'rgb(252, 165, 165)' },
            };
            const colors = colorMap[module.color] || colorMap.amber;
            
            // ì œì•½ ëª¨ë“ˆì€ ì„ íƒ ì œí•œ ì—†ìŒ, ë‚˜ë¨¸ì§€ëŠ” 2ê°œ
            const isConstraint = moduleKey === 'constraint';
            const selectionLimit = isConstraint ? 6 : 2;
            const selectionHint = isConstraint ? 'í•´ë‹¹í•˜ëŠ” ê²ƒì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš” (ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸° ê°€ëŠ¥)' : 'ê°€ì¥ ëŒë¦¬ëŠ” ê²ƒ 2ê°œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
            
            container.innerHTML = \`
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-3" style="background: \${colors.bg}; border: 2px solid \${colors.border};">
                        <span class="text-3xl">\${module.emoji}</span>
                    </div>
                    <h3 class="text-lg font-bold text-white">\${module.title}</h3>
                    <p class="text-sm" style="color: \${colors.text};">\${module.subtitle}</p>
                    <p class="text-xs text-wiki-muted mt-1">\${selectionHint}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    \${module.questions.map(q => \`
                        <button type="button" onclick="selectMiniModuleItem('\${moduleKey}', '\${q.token}', this, \${selectionLimit})"
                                class="mm-chip p-4 rounded-xl border-2 transition-all duration-200 text-left group"
                                style="background-color: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                data-token="\${q.token}">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl group-hover:scale-110 transition-transform">\${q.emoji}</span>
                                <span class="text-white text-sm">\${q.text}</span>
                            </div>
                        </button>
                    \`).join('')}
                </div>
                
                <div class="text-center mt-4">
                    <span id="mm-selection-count" class="text-sm text-wiki-muted">
                        ì„ íƒ: 0\${isConstraint ? '' : '/2'}
                    </span>
                </div>
            \`;
            
            // ì´ì „ ì„ íƒ ë³µì›
            const currentSelections = miniModuleSelections[moduleKey];
            if (currentSelections.length > 0) {
                currentSelections.forEach(token => {
                    const chip = container.querySelector(\`[data-token="\${token}"]\`);
                    if (chip) {
                        chip.style.backgroundColor = colors.bg;
                        chip.style.borderColor = colors.border;
                        chip.classList.add('mm-selected');
                    }
                });
                updateMiniModuleCount(moduleKey);
            }
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateMiniModuleNextButton();
        }
        
        function selectMiniModuleItem(moduleKey, token, btn, limit) {
            const module = MINI_MODULE_DATA[moduleKey];
            const colorMap = {
                amber: { bg: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.5)' },
                emerald: { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.5)' },
                blue: { bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.5)' },
                red: { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.5)' },
            };
            const colors = colorMap[module.color] || colorMap.amber;
            
            const selections = miniModuleSelections[moduleKey];
            const isSelected = selections.includes(token);
            
            if (isSelected) {
                // ì„ íƒ í•´ì œ
                const idx = selections.indexOf(token);
                selections.splice(idx, 1);
                btn.style.backgroundColor = 'rgba(26,26,46,0.7)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.classList.remove('mm-selected');
            } else {
                // ì„ íƒ ì¶”ê°€ (ì œí•œ í™•ì¸)
                if (selections.length >= limit) {
                    // ì œí•œ ì´ˆê³¼ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ì„ íƒ ì œê±°
                    const oldToken = selections.shift();
                    const oldBtn = document.querySelector(\`[data-token="\${oldToken}"]\`);
                    if (oldBtn) {
                        oldBtn.style.backgroundColor = 'rgba(26,26,46,0.7)';
                        oldBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        oldBtn.classList.remove('mm-selected');
                    }
                }
                selections.push(token);
                btn.style.backgroundColor = colors.bg;
                btn.style.borderColor = colors.border;
                btn.classList.add('mm-selected');
            }
            
            updateMiniModuleCount(moduleKey);
            updateMiniModuleNextButton();
        }
        
        function updateMiniModuleCount(moduleKey) {
            const countEl = document.getElementById('mm-selection-count');
            if (!countEl) return;
            
            const isConstraint = moduleKey === 'constraint';
            const count = miniModuleSelections[moduleKey].length;
            
            if (isConstraint) {
                countEl.textContent = \`ì„ íƒ: \${count}\`;
            } else {
                countEl.textContent = \`ì„ íƒ: \${count}/2\`;
            }
        }
        
        function updateMiniModuleNextButton() {
            const btn = document.getElementById('mm-next-btn');
            if (!btn) return;
            
            const moduleKey = MINI_MODULE_ORDER[currentMiniModuleIndex];
            const isConstraint = moduleKey === 'constraint';
            const count = miniModuleSelections[moduleKey].length;
            
            // ì œì•½ ëª¨ë“ˆì€ 0ê°œë„ í—ˆìš©, ë‚˜ë¨¸ì§€ëŠ” 2ê°œ í•„ìˆ˜
            const isValid = isConstraint ? true : count === 2;
            btn.disabled = !isValid;
        }
        
        // ë¯¸ë‹ˆëª¨ë“ˆì—ì„œ "ì´ì „" ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
        function goBackMiniModuleOrStep1() {
            if (currentMiniModuleIndex > 0) {
                // ì´ì „ ë¯¸ë‹ˆëª¨ë“ˆë¡œ ì´ë™
                currentMiniModuleIndex--;
                renderMiniModule();
            } else {
                // ì²« ë¯¸ë‹ˆëª¨ë“ˆì´ë©´ Step 1(ìƒíƒœ ë‹¨ê³„)ë¡œ ì´ë™
                goToStep(1);
            }
        }
        
        function nextMiniModule() {
            currentMiniModuleIndex++;
            
            if (currentMiniModuleIndex >= MINI_MODULE_ORDER.length) {
                // ë¯¸ë‹ˆëª¨ë“ˆ ì™„ë£Œ â†’ ê²°ê³¼ ê³„ì‚° í›„ Step 2ë¡œ
                finishMiniModule();
            } else {
                // ë‹¤ìŒ ëª¨ë“ˆ ë Œë”ë§
                renderMiniModule();
            }
        }
        
        function finishMiniModule() {
            // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ ê³„ì‚°
            const result = calculateMiniModuleResultFromSelections();
            window.miniModuleResult = result;
            
            
            // Step 2ë¡œ ì „í™˜
            goToStep2WithLoading();
        }
        
        function calculateMiniModuleResultFromSelections() {
            const getTopN = (selections, n) => {
                // ì„ íƒëœ ìˆœì„œëŒ€ë¡œ ìƒìœ„ Nê°œ ë°˜í™˜
                return selections.slice(0, n);
            };
            
            const interest_top = getTopN(miniModuleSelections.interest, 2);
            const value_top = getTopN(miniModuleSelections.value, 2);
            const strength_top = getTopN(miniModuleSelections.strength, 2);
            const constraint_flags = [...miniModuleSelections.constraint];
            
            // ë‚´ë¶€ ì¶©ëŒ ì²´í¬
            const conflictPairs = [
                ['autonomy', 'stability', 'autonomy_vs_stability'],
                ['growth', 'income', 'growth_vs_income'],
                ['meaning', 'income', 'meaning_vs_income'],
            ];
            
            const internal_conflict_flags = [];
            for (const [val1, val2, conflictName] of conflictPairs) {
                if (value_top.includes(val1) && value_top.includes(val2)) {
                    internal_conflict_flags.push(conflictName);
                }
            }
            
            return {
                interest_top,
                value_top,
                strength_top,
                constraint_flags,
                internal_conflict_flags: internal_conflict_flags.length > 0 ? internal_conflict_flags : undefined,
                raw_selections: { ...miniModuleSelections },
            };
        }
        
        function summarizeMiniModuleResultLocal(result) {
            const tokenToKorean = {
                problem_solving: 'ë¬¸ì œí•´ê²°', creating: 'ì°½ì‘', helping_teaching: 'ë„ì›€/ê°€ë¥´ì¹¨',
                data_numbers: 'ë°ì´í„°', organizing: 'ì¡°ì§/ê´€ë¦¬', influencing: 'ì˜í–¥ë ¥',
                autonomy: 'ììœ¨', growth: 'ì„±ì¥', stability: 'ì•ˆì •', income: 'ìˆ˜ì…', meaning: 'ì˜ë¯¸', recognition: 'ì¸ì •',
                analytical: 'ë¶„ì„ë ¥', creative: 'ì°½ì˜ë ¥', communication: 'ì†Œí†µë ¥',
                structured_execution: 'ì‹¤í–‰ë ¥', persistence: 'ëˆê¸°', fast_learning: 'í•™ìŠµë ¥',
                time_constraint: 'ì‹œê°„', income_constraint: 'ìˆ˜ì…', location_constraint: 'ìœ„ì¹˜',
                physical_constraint: 'ì²´ë ¥', qualification_constraint: 'ìê²©', uncertainty_constraint: 'ë¶ˆí™•ì‹¤ì„±',
            };
            
            const format = (arr) => arr.map(t => tokenToKorean[t] || t).join(', ') || 'ì—†ìŒ';
            
            return \`í¥ë¯¸: \${format(result.interest_top)} | ê°€ì¹˜: \${format(result.value_top)} | ê°•ì : \${format(result.strength_top)} | ì œì•½: \${format(result.constraint_flags)}\`;
        }
        
        function goBackToMiniModule() {
            // Step 2ì—ì„œ ë¯¸ë‹ˆëª¨ë“ˆë¡œ ëŒì•„ê°€ê¸°
            currentMiniModuleIndex = MINI_MODULE_ORDER.length - 1; // ë§ˆì§€ë§‰ ëª¨ë“ˆë¶€í„° ì‹œì‘
            renderMiniModule();
            
            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            document.getElementById('step1-5')?.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Step 1 â†’ Step 2 ì „í™˜ (ë¡œë”© í¬í•¨)
        function goToStep2WithLoading() {
            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();
            
            showLoading('ì§ˆë¬¸ êµ¬ì„± ì¤‘...', 'ìƒí™©ì— ë§ëŠ” ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');
            setTimeout(() => {
            renderUniversalQuestions();
            goToStep(2);
                hideLoading();
            }, 600);
        }
        
        // ============================================
        // Step 3: ì „ì´ ì‹ í˜¸ UI ë Œë”ë§ (ê³ ê¸‰ UI)
        // ============================================
        function renderTransitionSignalForm() {
            const container = document.getElementById('transition-signal-form');
            if (!container) return;
            
            // Step3 ì œëª© ë³µì› (V3 ë¼ìš´ë“œì—ì„œ ëŒì•„ì˜¨ ê²½ìš°)
            const step3Title = document.querySelector('#step3 h2');
            if (step3Title) {
                step3Title.innerHTML = '<i class="fas fa-compass text-emerald-400 mr-2"></i>ì•ìœ¼ë¡œì˜ ë°©í–¥ (1~2ë¶„)';
            }
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
            const nextBtn = document.getElementById('step3-next-btn');
            if (nextBtn) {
                nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ';
                nextBtn.onclick = submitTransitionAndContinue;
            }
            
            // ì´ì „ ë²„íŠ¼: Step 2ë¡œ ëŒì•„ê°€ê¸°
            const prevBtn = document.getElementById('step3-prev-btn');
            if (prevBtn) {
                prevBtn.onclick = () => goToStep(2);
            }

            container.innerHTML = TRANSITION_SIGNAL_QUESTIONS.map(q => {
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-2 text-white">\${q.text}</h4>
                            <p class="text-xs mb-3" style="color: rgb(100,116,139)">ìµœëŒ€ \${q.max_selections || 3}ê°œê¹Œì§€ ì„ íƒ (ì„ íƒ ìˆœì„œ = ìš°ì„ ìˆœìœ„)</p>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map((opt, idx) => \`
                                    <button type="button" onclick="selectTransitionChip('\${q.question_id}', '\${opt.value}', this, \${q.max_selections || 3})"
                                            class="trans-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-rank"></div>
                                    </button>
                                \`).join('')}
                            </div>
                            <div class="selected-order mt-3 text-sm hidden p-3 rounded-lg" style="background-color: rgba(16,185,129,0.1); color: #34d399;"></div>
                        </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectTransitionRadio('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-radio group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(148,163,184)"><span class="mr-1">\${opt.emoji}</span>\${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                } else if (q.ui_type === 'checkbox') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleTransitionCheckbox('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-checkbox group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
            
            // ì €ì¥ëœ ê°’ ë³µì›
            restoreTransitionSignalAnswers();
        }
        
        // ì „ì´ ì‹ í˜¸ ë‹µë³€ ë³µì›
        function restoreTransitionSignalAnswers() {
            if (!transitionSignalAnswers || Object.keys(transitionSignalAnswers).length === 0) return;
            
            for (const [questionId, values] of Object.entries(transitionSignalAnswers)) {
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) continue;
                
                if (Array.isArray(values)) {
                    // ì¹© ì„ íƒ ë³µì›
                    for (const val of values) {
                        const btn = container.querySelector(\`[data-value="\${val}"]\`);
                        if (btn) {
                            // ì„ íƒ ìƒíƒœë¡œ ìŠ¤íƒ€ì¼ ì ìš©
                            btn.style.backgroundColor = 'rgba(16,185,129,0.2)';
                            btn.style.borderColor = '#10b981';
                            btn.style.color = '#34d399';
                        }
                    }
                    // ìˆœì„œ ì—…ë°ì´íŠ¸
                    updateChipOrder(questionId);
                } else if (typeof values === 'string') {
                    // ë¼ë””ì˜¤ ë²„íŠ¼ ë³µì› (selectTransitionRadioì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
                    const btn = container.querySelector(\`[data-value="\${values}"]\`);
                    if (btn) {
                        btn.style.backgroundColor = 'rgba(16,185,129,0.2)';
                        btn.style.borderColor = '#10b981';
                        const radioCircle = btn.querySelector('.radio-circle');
                        const radioDot = btn.querySelector('.radio-dot');
                        if (radioCircle) radioCircle.style.borderColor = '#10b981';
                        if (radioDot) radioDot.classList.remove('hidden');
                    }
                }
            }
        }
        
        // ì „ì´ ì‹ í˜¸ ë‹µë³€ ìˆ˜ì§‘
        function collectTransitionSignalAnswers() {
            // transitionSignalAnswersëŠ” selectTransitionChip ë“±ì—ì„œ ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨
            // ìŠ¬ë¼ì´ë” ê°’ ìˆ˜ì§‘
            document.querySelectorAll('.trans-slider').forEach(slider => {
                const questionId = slider.closest('[data-question-id]')?.dataset.questionId;
                if (questionId) {
                    transitionSignalAnswers[questionId] = slider.value;
                }
            });
        }
        
        // ì „ì´ ì‹ í˜¸ ì„ íƒ í•¸ë“¤ëŸ¬ë“¤ (ê³ ê¸‰ UI)
        function selectTransitionChip(questionId, value, btnEl, maxSelections) {
            if (!transitionSignalAnswers[questionId]) {
                transitionSignalAnswers[questionId] = [];
            }
            
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                // ì´ë¯¸ ì„ íƒë¨ â†’ ì œê±°
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-rank')?.classList.add('hidden');
                btnEl.querySelector('.chip-rank')?.classList.remove('flex');
            } else if (arr.length < maxSelections) {
                // ìƒˆë¡œ ì„ íƒ
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
            }
            
            // ì„ íƒ ìˆœì„œ í‘œì‹œ ë° ìˆœìœ„ ë°°ì§€ ì—…ë°ì´íŠ¸
            updateChipOrder(questionId);
        }
        
        function updateChipOrder(questionId) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            if (!container) {
                return;
            }
            const orderEl = container.querySelector('.selected-order');
            if (!orderEl) {
                return;
            }
            const arr = transitionSignalAnswers[questionId] || [];
            
            // ëª¨ë“  ìˆœìœ„ ë°°ì§€ ì´ˆê¸°í™”
            container.querySelectorAll('.trans-chip').forEach(btn => {
                const rank = btn.querySelector('.chip-rank');
                if (rank) {
                    rank.classList.add('hidden');
                    rank.classList.remove('flex');
                }
            });
            
            if (arr.length > 0) {
                const q = TRANSITION_SIGNAL_QUESTIONS.find(q => q.question_id === questionId);
                const labels = arr.map((v, i) => {
                    const opt = q?.options.find(o => o.value === v);
                    // í•´ë‹¹ ë²„íŠ¼ì— ìˆœìœ„ ë°°ì§€ í‘œì‹œ
                    const btn = container.querySelector(\`[data-value="\${v}"]\`);
                    if (btn) {
                        const rank = btn.querySelector('.chip-rank');
                        if (rank) {
                            rank.textContent = i + 1;
                            rank.classList.remove('hidden');
                            rank.classList.add('flex');
                        }
                    }
                    return \`\${i + 1}ìˆœìœ„: \${opt?.label || v}\`;
                });
                orderEl.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>' + labels.join(' â†’ ');
                orderEl.classList.remove('hidden');
            } else {
                orderEl.classList.add('hidden');
            }
        }
        
        function selectTransitionRadio(questionId, value, btnEl) {
            const isSelected = transitionSignalAnswers[questionId] === value;
            
            // ê°™ì€ ì§ˆë¬¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì„ íƒ í•´ì œ
            const container = btnEl.parentElement;
            container.querySelectorAll('.trans-radio').forEach(btn => {
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                transitionSignalAnswers[questionId] = value;
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete transitionSignalAnswers[questionId];
            }
        }
        
        function toggleTransitionCheckbox(questionId, value, btnEl) {
            if (!transitionSignalAnswers[questionId]) {
                transitionSignalAnswers[questionId] = [];
            }
            
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
            } else {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
                btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                btnEl.querySelector('.chip-check')?.classList.add('flex');
            }
        }
        
        // Step 2 â†’ Step 3 ì „í™˜ (ì „ì´ ì‹ í˜¸)
        async function submitUniversalAndGoToTransition() {
            collectUniversalAnswers();
            
            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();
            
            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ì „ì´ ì‹ í˜¸ ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');
            
            setTimeout(() => {
                try {
                    renderTransitionSignalForm();
                    goToStep(3);
                } catch (error) {
                } finally {
                    hideLoading();
                }
            }, 600);
        }
        
        // Step 3 â†’ ì„œìˆ í˜• ì§ˆë¬¸ ë‹¨ê³„ ì „í™˜ (V3)
        async function submitTransitionAndContinue() {
            // ì „ì´ ì‹ í˜¸ ë‹µë³€ ìˆ˜ì§‘ (ì„ì‹œ ì €ì¥ìš©)
            collectTransitionSignalAnswers();
            
            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();
            
            // V3 ëª¨ë“œ: ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ ë‹¨ê³„ë¡œ ì§„í–‰
            const isMinor = MINOR_STAGES.includes(selectedStage);

            if (!isMinor && window.V3_MODE !== false) {
                showLoading('ì¤€ë¹„ ì¤‘...', 'ì‹¬ì¸µ ì§ˆë¬¸ì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
                setTimeout(() => {
                    renderNarrativeStep();
                    hideLoading();
                }, 400);
                return;
            }
            
            // ê¸°ì¡´ V2 ë¡œì§
            showLoading('ë¶„ì„ ì¤‘...', 'ë§ì¶¤ ì‹¬ì¸µ ì§ˆë¬¸ì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(2); // ì‹¬ì¸µ ì§ˆë¬¸ (3ë‹¨ê³„ êµ¬ì¡°)
                } else {
                    // Follow-up ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ë¡œ
                    currentRequestId = data.request_id;
                    displayResults(data);
                    goToStep(3); // ê²°ê³¼ (3ë‹¨ê³„ êµ¬ì¡°)
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ============================================
        // V3: 3ë¼ìš´ë“œ ì‹¬ì¸µ ì§ˆë¬¸ ì‹œìŠ¤í…œ
        // ============================================
        window.V3_MODE = true; // V3 ëª¨ë“œ í™œì„±í™” í”Œë˜ê·¸
        window.currentRound = 1;
        window.roundAnswers = [];
        window.narrativeFacts = null;
        
        // V3: ì„œìˆ í˜• ë‹µë³€ ì €ì¥ (P0-1: ì—ëŸ¬ í‘œì‹œ ê°•í™”)
        async function saveNarrativeFacts(facts) {
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                // P0-1: session_id ìœ íš¨ì„± ê²€ì‚¬
                if (!currentSessionId || currentSessionId.trim() === '') {
                    showErrorToast('ì„¸ì…˜ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return false;
                }


                const response = await fetch('/api/ai-analyzer/v3/narrative-facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        high_alive_moment: facts.highAliveMoment || facts.question1Answer || '',
                        lost_moment: facts.lostMoment || facts.question2Answer || '',
                        existential_answer: facts.existentialAnswer || undefined,
                    })
                });

                // P0-1: ì‘ë‹µ ìƒíƒœ í™•ì¸
                if (!response.ok) {
                    const errorText = await response.text();
                    // í…Œì´ë¸” ì—†ìŒ ë“±ì˜ D1 ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰ (í…ŒìŠ¤íŠ¸ í™˜ê²½)
                    if (errorText.includes('error code: 1031') || errorText.includes('no such table')) {
                        return true; // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê³„ì† ì§„í–‰
                    }
                    showErrorToast('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + errorText.substring(0, 100));
                    return false;
                }

                const data = await response.json();

                // P0-1: ìƒì„¸ ì—ëŸ¬ í‘œì‹œ
                if (!data.success) {
                    showErrorToast('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + (data.detail || data.error || 'Unknown error'));
                    return false;
                }

                return true;

            } catch (error) {
                // JSON íŒŒì‹± ì—ëŸ¬ ë“±ì€ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰ (í…ŒìŠ¤íŠ¸ í™˜ê²½)
                if (error.message && error.message.includes('JSON')) {
                    return true;
                }
                showErrorToast('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (error.message || 'Network error'));
                return false;
            }
        }
        
        // P0-1: ì—ëŸ¬ í† ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
        function showErrorToast(message) {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.querySelector('.v3-error-toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'v3-error-toast';
            toast.innerHTML = \`
                <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                            background: #ef4444; color: white; padding: 12px 20px; border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; max-width: 90vw;
                            font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>\${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-left: 8px; background: none; border: none; color: white; cursor: pointer;">âœ•</button>
                </div>
            \`;
            document.body.appendChild(toast);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => toast.remove(), 5000);
        }
        
        // V3: ë¼ìš´ë“œ ì§ˆë¬¸ ì‹œì‘
        async function startV3RoundQuestions(roundNumber) {
            const roundMeta = {
                1: { title: 'ë‚´ë©´ì˜ ì—ë„ˆì§€ íƒìƒ‰', subtitle: 'ë¬´ì—‡ì´ ë‹¹ì‹ ì„ ì›€ì§ì´ê²Œ í•˜ë‚˜ìš”?', emoji: 'ğŸ”¥', color: 'from-orange-500 to-red-500' },
                2: { title: 'ê²½ê³„ì„  í™•ì¸', subtitle: 'ë¬´ì—‡ì„ í”¼í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?', emoji: 'ğŸ›¡ï¸', color: 'from-purple-500 to-indigo-500' },
                3: { title: 'ì‹¤í–‰ ê³„íš ì„¤ê³„', subtitle: 'ì–´ë–»ê²Œ ì‹œì‘í•  ìˆ˜ ìˆì„ê¹Œìš”?', emoji: 'ğŸš€', color: 'from-emerald-500 to-teal-500' },
            };
            
            const meta = roundMeta[roundNumber];
            showLoading('ì§ˆë¬¸ êµ¬ì„± ì¤‘...', meta.subtitle);
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/v3/round-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        narrative_facts: window.narrativeFacts,
                        previous_round_answers: window.roundAnswers,
                        universal_answers: universalAnswers,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ (LLM íŒë‹¨ ì•µì»¤ - ì´ê²Œ í•µì‹¬!)
                        mini_module_result: window.miniModuleResult || null,
                    })
                });
                
                hideLoading();
                
                // ë¨¼ì € HTTP ìƒíƒœ ì²´í¬ (500 ì—ëŸ¬ ë“±)
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown server error');
                    alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (HTTP ' + response.status + ')\\n\\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const data = await response.json();
                
                // API ì—ëŸ¬ ì²˜ë¦¬
                if (data.error) {
                    alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'Unknown error') + '\\n\\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // LLM ìƒì„± ì§ˆë¬¸ ì‚¬ìš©
                const questions = data.questions || [];
                
                if (questions.length > 0) {
                    window.currentRound = roundNumber;
                    window.roundQuestions = questions;  // ì§ˆë¬¸ ì €ì¥ (ë³µì›ìš©)
                    
                    
                    renderV3RoundUI(roundNumber, questions, meta);
                    // Step 2ì— ë¼ìš´ë“œ í‘œì‹œ (3ë‹¨ê³„ êµ¬ì¡°)
                    document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
                    document.getElementById('step2')?.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
                    alert('ì§ˆë¬¸ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                hideLoading();
                alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'Network error') + '\\n\\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // V3: ë¼ìš´ë“œ UI ë Œë”ë§
        function renderV3RoundUI(roundNumber, questions, meta) {
            // Step 2ì—ì„œ í˜¸ì¶œ ì‹œ followup-questions-form ì‚¬ìš©
            const container = document.getElementById('followup-questions-form') || document.getElementById('transition-signal-form');
            if (!container) return;
            
            const progressWidth = (roundNumber / 3) * 100;
            
            container.innerHTML = \`
                <!-- ë¼ìš´ë“œ í—¤ë” -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl mb-4" style="background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(234,88,12,0.1));">
                        <span class="text-3xl">\${meta.emoji}</span>
                        <div class="text-left">
                            <div class="text-lg font-bold text-white">\${meta.title}</div>
                            <div class="text-sm text-wiki-muted">\${meta.subtitle}</div>
                        </div>
                    </div>
                    
                    <!-- ë¼ìš´ë“œ ì§„í–‰ í‘œì‹œ -->
                    <div class="flex items-center justify-center gap-3 mb-4">
                        \${[1, 2, 3].map(r => \`
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all \${r === roundNumber ? 'bg-gradient-to-r ' + meta.color + ' text-white scale-110' : r < roundNumber ? 'bg-emerald-500 text-white' : 'bg-wiki-card text-wiki-muted'}">
                                    \${r < roundNumber ? 'âœ“' : r}
                                </div>
                                \${r < 3 ? '<div class="w-8 h-0.5 ' + (r < roundNumber ? 'bg-emerald-500' : 'bg-wiki-border') + '"></div>' : ''}
                            </div>
                        \`).join('')}
                    </div>
                    <div class="text-xs text-wiki-muted">Round \${roundNumber} / 3</div>
                </div>
                
                <!-- ì§ˆë¬¸ë“¤ -->
                <div class="space-y-6" id="v3-round-questions">
                    \${questions.map((q, idx) => \`
                        <div class="question-block p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(26,26,46,0.8), rgba(36,36,56,0.5)); border: 1px solid rgba(67,97,238,0.2);">
                            <label class="block text-lg font-semibold mb-3 text-white">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-wiki-primary/20 text-wiki-primary text-sm mr-2">\${idx + 1}</span>
                                \${q.questionText}
                            </label>
                            <textarea 
                                id="v3_q_\${q.id}"
                                name="\${q.id}" 
                                rows="4" 
                                minlength="\${q.minLengthGuidance || 30}"
                                placeholder="ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”..."
                                class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                style="background-color: rgba(15,15,35,1); border-color: rgba(67,97,238,0.3); color: #fff;"
                                onfocus="this.style.borderColor='rgba(67,97,238,0.6)';"
                                onblur="this.style.borderColor='rgba(67,97,238,0.3)';"
                                oninput="updateV3Counter(this)"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-wiki-muted">ìµœì†Œ \${q.minLengthGuidance || 30}ì</span>
                                <span id="v3_q_\${q.id}_counter" class="text-xs text-wiki-muted">0ì</span>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
            
            // Step 2 ì œëª© ë° ì„œë¸Œíƒ€ì´í‹€ ì—…ë°ì´íŠ¸ (3ë‹¨ê³„ êµ¬ì¡°)
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = \`<i class="fas fa-comments text-wiki-primary mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ Round \${roundNumber}\`;
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                const subtitleText = roundNumber === 1 
                    ? 'ë‹¹ì‹ ì˜ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤ ì§ˆë¬¸ì„ ì¤€ë¹„í–ˆì–´ìš”' 
                    : roundNumber === 2 
                    ? 'ë” ê¹Šì´ ìˆëŠ” ì´í•´ë¥¼ ìœ„í•œ ì§ˆë¬¸ì´ì—ìš”' 
                    : 'ë§ˆì§€ë§‰ìœ¼ë¡œ ëª‡ ê°€ì§€ë§Œ ë” ì—¬ì­¤ë³¼ê²Œìš”';
                step2Subtitle.textContent = subtitleText;
            }
            
            // Step ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸ - ì‹¬ì¸µ ë‹¨ê³„(2) í‘œì‹œ
            currentStep = 2;
            window.currentStep = 2;
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= 2) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            // Step 2 ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                if (roundNumber < 3) {
                    analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ ë¼ìš´ë“œ';
                    analyzeBtn.onclick = () => submitV3RoundAndContinue(roundNumber, questions);
                } else {
                    analyzeBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>ë¶„ì„ ì‹œì‘';
                    analyzeBtn.onclick = () => submitV3RoundAndAnalyze(questions);
                }
            }
            
            // ì´ì „ ë²„íŠ¼ ë™ì‘ ì—…ë°ì´íŠ¸ (ë¼ìš´ë“œë³„ ë¶„ê¸°)
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    if (roundNumber === 1) {
                        // Round 1 -> ì„œìˆ í˜• ì§ˆë¬¸ìœ¼ë¡œ
                        showPrevWarningModal(() => {
                            renderNarrativeStep();
                        });
                    } else {
                        // Round 2/3 -> ì´ì „ ë¼ìš´ë“œë¡œ (ê²½ê³  ì—†ì´ ë°”ë¡œ ì´ë™)
                        startV3RoundQuestions(roundNumber - 1);
                    }
                };
            }
        }
        
        // ì´ì „ ë²„íŠ¼ ê²½ê³  ëª¨ë‹¬ í‘œì‹œ
        function showPrevWarningModal(onConfirm) {
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('prev-warning-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'prev-warning-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.innerHTML = \`
                <div class="bg-wiki-card rounded-2xl p-6 max-w-md w-full border border-wiki-border shadow-2xl">
                    <div class="text-center mb-4">
                        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-yellow-500/20 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-2xl text-yellow-400"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                        <p class="text-wiki-muted text-sm">ì´ì „ ë‹¨ê³„ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ë©´ ì‹¬ì¸µ ì§ˆë¬¸ì´ ìƒˆë¡œ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-yellow-400 text-sm mt-2"><i class="fas fa-info-circle mr-1"></i>ê¸°ì¡´ ë‹µë³€ì´ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="prev-warning-cancel" class="flex-1 px-4 py-3 bg-wiki-bg border border-wiki-border rounded-xl text-white hover:bg-wiki-card transition">
                            ì·¨ì†Œ
                        </button>
                        <button id="prev-warning-confirm" class="flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl text-white font-medium transition">
                            ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            
            document.getElementById('prev-warning-cancel').onclick = () => modal.remove();
            document.getElementById('prev-warning-confirm').onclick = () => {
                modal.remove();
                // ì‹¬ì¸µ ì§ˆë¬¸ ìƒíƒœ ì´ˆê¸°í™”
                window.currentRound = 0;
                window.roundQuestions = null;
                window.roundAnswers = [];
                onConfirm();
            };
        }
        
        // V3: ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ ë‹µë³€ ë³µì›
        function restoreNarrativeAnswers() {
            if (!window.narrativeFacts) {
                return;
            }
            
            const facts = window.narrativeFacts;
            
            // Q0: ìŠ¤í† ë¦¬ ì§ˆë¬¸
            const q0 = document.getElementById('narrative_q0');
            if (q0 && (facts.storyAnswer || facts.life_story)) {
                q0.value = facts.storyAnswer || facts.life_story || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q0, 5000);
                }
            }
            
            // Career background (ì„ íƒ)
            const careerBg = document.getElementById('narrative_career_bg');
            if (careerBg && facts.career_background) {
                careerBg.value = facts.career_background;
            }
            
            // Q1: ë™ì  ì§ˆë¬¸ 1
            const q1 = document.getElementById('narrative_q1');
            if (q1 && (facts.question1Answer || facts.highAliveMoment)) {
                q1.value = facts.question1Answer || facts.highAliveMoment || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q1, 10000);
                }
            }
            
            // Q2: ë™ì  ì§ˆë¬¸ 2
            const q2 = document.getElementById('narrative_q2');
            if (q2 && (facts.question2Answer || facts.lostMoment)) {
                q2.value = facts.question2Answer || facts.lostMoment || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q2, 10000);
                }
            }
            
        }
        
        // V3: ë¼ìš´ë“œ ë‹µë³€ ë³µì›
        function restoreRoundAnswers() {
            if (!window.roundAnswers || !window.currentRound) return;
            
            // í˜„ì¬ ë¼ìš´ë“œì˜ ë‹µë³€ ì°¾ê¸°
            const currentRoundAnswers = window.roundAnswers.filter(a => a.roundNumber === window.currentRound);
            
            currentRoundAnswers.forEach(answer => {
                const textarea = document.getElementById('v3_q_' + answer.questionId);
                if (textarea && answer.answer) {
                    textarea.value = answer.answer;
                    // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                    if (typeof updateV3Counter === 'function') {
                        updateV3Counter(textarea);
                    }
                }
            });
            
        }
        
        // V3: ê¸€ììˆ˜ ì¹´ìš´í„°
        function updateV3Counter(textarea) {
            const counter = document.getElementById(textarea.id + '_counter');
            if (counter) {
                counter.textContent = textarea.value.length + 'ì';
                counter.style.color = textarea.value.length >= (parseInt(textarea.minLength) || 30) ? 'rgb(74, 222, 128)' : 'rgb(148,163,184)';
            }
        }
        
        // V3: ë¼ìš´ë“œ ë‹µë³€ ì œì¶œ í›„ ë‹¤ìŒ ë¼ìš´ë“œ
        async function submitV3RoundAndContinue(currentRound, questions) {
            const answers = collectV3RoundAnswers(questions);
            if (!validateV3Answers(answers, questions)) return;

            // Phase 3: í¸ì§‘ ëª¨ë“œ - ë¼ìš´ë“œ ë³€ê²½ ì‹œ ì´í›„ ë¼ìš´ë“œ ì´ˆê¸°í™”
            if (window.__editMode && detectRoundChanges(currentRound)) {
                cascadeResetFromRound(currentRound);
            }
            
            const nextBtn = document.getElementById('step3-next-btn');
            const prevBtn = document.getElementById('step3-prev-btn');
            const originalNextHtml = nextBtn?.innerHTML;
            
            // ì €ì¥ êµ¬ê°„ë¶€í„° ë¡œë”© í‘œì‹œ (ê¸°ì¡´ì—ëŠ” ì—†ì—ˆìŒ)
            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');
            
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                if (nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...';
                }
                if (prevBtn) prevBtn.setAttribute('disabled', 'true');
                
                // ë‹µë³€ ì €ì¥
                await saveV3RoundAnswers(currentRound, answers, questions);
                
                // ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ (startV3RoundQuestions ë‚´ë¶€ì—ì„œ showLoading('ì§ˆë¬¸ êµ¬ì„± ì¤‘...') â†’ hideLoading() ì²˜ë¦¬ë¨)
                await startV3RoundQuestions(currentRound + 1);
            } finally {
                // ë²„íŠ¼ ë³µì›
                if (nextBtn) {
                    nextBtn.disabled = false;
                    if (originalNextHtml) nextBtn.innerHTML = originalNextHtml;
                }
                if (prevBtn) prevBtn.removeAttribute('disabled');
                // ì•ˆì „ì¥ì¹˜: ì˜¤ë¥˜ë¡œ startV3RoundQuestionsë¡œ ëª» ê°”ì„ ë•Œë¥¼ ëŒ€ë¹„
                hideLoading();
            }
        }
        
        // V3: ë§ˆì§€ë§‰ ë¼ìš´ë“œ í›„ ë¶„ì„ ì‹œì‘
        async function submitV3RoundAndAnalyze(questions) {
            const answers = collectV3RoundAnswers(questions);
            if (!validateV3Answers(answers, questions)) return;
            
            const nextBtn = document.getElementById('step3-next-btn');
            const prevBtn = document.getElementById('step3-prev-btn');
            
            // ì €ì¥ë¶€í„° ë¡œë”© í‘œì‹œ
            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ë§ˆì§€ë§‰ ë‹µë³€ì„ ì €ì¥í•˜ê³  ìˆì–´ìš”');
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...';
            }
            if (prevBtn) prevBtn.setAttribute('disabled', 'true');
            
            // ë§ˆì§€ë§‰ ë¼ìš´ë“œ ë‹µë³€ ì €ì¥
            await saveV3RoundAnswers(3, answers, questions);
            
            // ============================================
            // Freeze v1.1: Recommendation Mode í†µí•©
            // - ê¸°ì¡´ ë¶„ì„ API í˜¸ì¶œ (ë¦¬í¬íŠ¸ ìƒì„±ìš©)
            // - ìƒˆ Recommend API í˜¸ì¶œ (ìµœì‹  Vectorize+TAG ê¸°ë°˜ ì¶”ì²œ)
            // ============================================
            showLoading('ë¶„ì„ ì¤‘...', 'ì „ë¬¸ê°€ê¸‰ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”');
            
            try {
                // 1. ê¸°ì¡´ ë¶„ì„ API (ë¦¬í¬íŠ¸ ìƒì„±)
                const analyzeResponse = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        narrative_facts: window.narrativeFacts,
                        round_answers: window.roundAnswers,
                        engine_version: 'v3',
                        debug: DEBUG_MODE,
                        ...getEditModePayloadExtras(),
                    })
                });
                
                const analyzeData = await analyzeResponse.json();
                
                // â˜…â˜…â˜… LLM ëª¨ë“ˆ í™•ì¸ìš© ì½˜ì†” ë¡œê·¸ â˜…â˜…â˜…
                
                // 2. Recommendation Mode API (ìµœì‹  Vectorize+TAG ì¶”ì²œ)
                showLoading('ì¶”ì²œ ìƒì„± ì¤‘...', 'AIê°€ ìµœì ì˜ ì§ì—…ì„ ì°¾ê³  ìˆì–´ìš”');
                
                try {
                    // SearchProfile êµ¬ì„±
                    const miniModule = window.miniModuleResult || {};
                    const searchProfile = {
                        desiredThemes: [
                            ...(miniModule.interest_top || []),
                            ...(miniModule.value_top || []),
                            ...(universalAnswers.univ_interest || []),
                        ].filter(Boolean),
                        dislikedThemes: universalAnswers.univ_dislike || [],
                        strengthsHypothesis: miniModule.strength_top || [],
                        environmentPreferences: [],
                        hardConstraints: miniModule.constraint_flags || [],
                        riskSignals: [],
                        keywords: [
                            ...(miniModule.interest_top || []),
                            ...(universalAnswers.univ_interest || []),
                        ].filter(Boolean),
                    };
                    
                    // Phase 1: ì¶”ì²œë§Œ ë¹ ë¥´ê²Œ (ë¦¬í¬íŠ¸ëŠ” Phase 2ì—ì„œ ë¹„ë™ê¸° ìƒì„±)
                    let recommendResponse;
                    for (let attempt = 0; attempt <= 2; attempt++) {
                        recommendResponse = await fetch('/api/ai-analyzer/v3/recommend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: currentSessionId,
                                searchProfile: searchProfile,
                                mini_module_result: miniModule,
                                topK: 800,
                                judgeTopN: 20,
                                skipReport: true,
                                debug: DEBUG_MODE,
                            })
                        });
                        if (recommendResponse.ok || recommendResponse.status < 500) break;
                        if (attempt < 2) {
                            await new Promise(r => setTimeout(r, 5000 * (attempt + 1)));
                        }
                    }

                    const recommendData = await recommendResponse.json();

                    // ğŸ” DEBUG: API ì‘ë‹µ í™•ì¸
                    if (recommendData.recommendations?.like_top10?.[0]) {
                    }

                    // 3. ê²°ê³¼ ë³‘í•©: Recommendation Mode ê²°ê³¼ë¥¼ ìš°ì„  ì‚¬ìš©
                    if (recommendData.success && recommendData.recommendations) {

                        // analyzeData.resultê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                        if (!analyzeData.result) {
                            analyzeData.result = {};
                        }

                        // fit_top3ì— Recommendation Mode ê²°ê³¼ ë³‘í•© (result ì•ˆì— ì €ì¥)
                        if (recommendData.recommendations.top_jobs) {
                            const newTopJobs = recommendData.recommendations.top_jobs.slice(0, 10);
                            analyzeData.result.fit_top3 = newTopJobs.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                feasibility_score: job.feasibility_score || 0,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                                evidence_quotes: job.evidence_quotes || [],
                                risk_details: [],
                                evidence_links: [],
                            }));
                        }

                        // like_top10ì— Recommendation Mode ê²°ê³¼ ë³‘í•© (result ì•ˆì— ì €ì¥)
                        if (recommendData.recommendations.like_top10) {
                            analyzeData.result.like_top10 = recommendData.recommendations.like_top10.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                feasibility_score: job.feasibility_score || 0,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                            }));
                        }

                        // can_top10ì— Recommendation Mode ê²°ê³¼ ë³‘í•© (result ì•ˆì— ì €ì¥)
                        if (recommendData.recommendations.can_top10) {
                            analyzeData.result.can_top10 = recommendData.recommendations.can_top10.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                feasibility_score: job.feasibility_score || 0,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                            }));
                        }

                        // premium_report ë³‘í•© (ì¶”ì²œ ëª¨ë“œì˜ LLM ë¦¬í¬íŠ¸ê°€ ë” ì •í™•í•¨)
                        if (recommendData.premium_report) {
                            analyzeData.result.premium_report = recommendData.premium_report;
                        }

                        // request_id ì—…ë°ì´íŠ¸ (ì¶”ì²œ ëª¨ë“œì—ì„œ ê°±ì‹ ëœ ID ì‚¬ìš©)
                        if (recommendData.request_id) {
                            analyzeData.request_id = recommendData.request_id;
                        }

                        // ë©”íƒ€ë°ì´í„° ì¶”ê°€
                        analyzeData._recommendation_mode = {
                            enabled: true,
                            total_candidates: recommendData.recommendations.total_candidates,
                            filtered_count: recommendData.recommendations.filtered_count,
                            search_duration_ms: recommendData.recommendations.search_duration_ms,
                        };
                    }
                } catch (recommendError) {
                    // Recommendation Mode ì‹¤íŒ¨í•´ë„ ê¸°ì¡´ ê²°ê³¼ëŠ” í‘œì‹œ
                }
                
                hideLoading();

                // í¸ì§‘ ëª¨ë“œ: ë¶„ì„ ì™„ë£Œ â†’ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                if (window.__editMode && analyzeData.request_id) {
                    fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                        method: 'DELETE', credentials: 'same-origin'
                    }).catch(() => {});
                    window.location.href = '/user/ai-results/' + analyzeData.request_id;
                    return;
                }

                currentRequestId = analyzeData.request_id;
                displayResults(analyzeData);
                goToStep(3); // ê²°ê³¼ (3ë‹¨ê³„ êµ¬ì¡°)

                // Phase 2: í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ ë¹„ë™ê¸° ìƒì„± (ê²°ê³¼ í‘œì‹œ í›„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
                (async () => {
                    // ë¦¬í¬íŠ¸ ë¡œë”© í‘œì‹œ
                    const reportBanner = document.createElement('div');
                    reportBanner.id = 'report-loading-banner';
                    reportBanner.className = 'text-center py-3 px-4 rounded-xl mb-4';
                    reportBanner.style.cssText = 'background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);';
                    reportBanner.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span class="text-sm" style="color: rgba(165,180,252,0.9);">ì‹¬ë¦¬ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>';
                    const step3El = document.getElementById('step3');
                    if (step3El && step3El.firstChild) {
                        step3El.insertBefore(reportBanner, step3El.firstChild);
                    }

                    try {
                        const reportResponse = await fetch('/api/ai-analyzer/v3/recommend/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: currentSessionId }),
                        });

                        document.getElementById('report-loading-banner')?.remove();

                        if (reportResponse.ok) {
                            const reportData = await reportResponse.json();
                            if (reportData.premium_report) {
                                analyzeData.result.premium_report = reportData.premium_report;
                                // í˜„ì¬ í™œì„± íƒ­ ì €ì¥ í›„ ì¬ë Œë”ë§
                                const activeTab = document.querySelector('.report-tab.active')?.getAttribute('data-tab');
                                displayResults(analyzeData);
                                if (activeTab) showReportTab(activeTab);
                            }
                        } else {
                        }
                    } catch (reportError) {
                        document.getElementById('report-loading-banner')?.remove();
                    }
                })();

            } catch (error) {
                hideLoading();
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // V3: ë¼ìš´ë“œ ë‹µë³€ ìˆ˜ì§‘
        function collectV3RoundAnswers(questions) {
            return questions.map(q => {
                const textarea = document.getElementById('v3_q_' + q.id);
                return {
                    question_id: q.id,
                    question_text: q.questionText,
                    purpose_tag: q.purposeTag,
                    answer: textarea ? textarea.value.trim() : '',
                };
            });
        }
        
        // V3: ë‹µë³€ ê²€ì¦
        function validateV3Answers(answers, questions) {
            for (let i = 0; i < answers.length; i++) {
                const minLen = questions[i].minLengthGuidance || 30;
                if (answers[i].answer.length < minLen) {
                    const textarea = document.getElementById('v3_q_' + questions[i].id);
                    if (textarea) {
                        textarea.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                        textarea.focus();
                    }
                    alert('ì§ˆë¬¸ ' + (i + 1) + 'ì— ' + minLen + 'ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                    return false;
                }
            }
            return true;
        }
        
        // V3: ë¼ìš´ë“œ ë‹µë³€ ì €ì¥ (P0-1: ì—ëŸ¬ í‘œì‹œ ê°•í™”)
        async function saveV3RoundAnswers(roundNumber, answers, questions) {
            // ë¡œì»¬ ì €ì¥ (í•­ìƒ ìˆ˜í–‰) - ì§ˆë¬¸ í…ìŠ¤íŠ¸ë„ í•¨ê»˜ ì €ì¥!
            for (const ans of answers) {
                window.roundAnswers.push({
                    questionId: ans.question_id,
                    questionText: ans.question_text,  // ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì¶”ê°€ (ë‹¤ìŒ ë¼ìš´ë“œì—ì„œ ì‚¬ìš©)
                    roundNumber: roundNumber,
                    answer: ans.answer,
                    answeredAt: new Date().toISOString(),
                });
            }
            
            // P0-1: session_id ìœ íš¨ì„± ê²€ì‚¬
            if (!currentSessionId || currentSessionId.trim() === '') {
                showErrorToast('ì„¸ì…˜ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            
            // ì„œë²„ ì €ì¥
            try {
                const response = await fetch('/api/ai-analyzer/v3/round-answers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        answers: answers,
                    })
                });
                
                // ë¨¼ì € HTTP ìƒíƒœ ì²´í¬ (500 ì—ëŸ¬ ë“±)
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    showErrorToast('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì‹¤íŒ¨ (HTTP ' + response.status + ')');
                    // ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ ì§„í–‰ì€ ê³„ì†
                    return false;
                }
                
                const data = await response.json();
                
                // P0-1: ìƒì„¸ ì—ëŸ¬ í‘œì‹œ
                if (!data.success) {
                    showErrorToast('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + (data.detail || data.error || 'Unknown error'));
                    // ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ ì§„í–‰ì€ ê³„ì†
                    return false;
                }
                
                return true;
                
            } catch (error) {
                showErrorToast('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (error.message || 'Network error'));
                // ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ ì§„í–‰ì€ ê³„ì†
                return false;
            }
        }
        
        // ============================================
        // Step 2: Universal Questions ë Œë”ë§ (ì„œìˆ í˜•ì€ Step 3.5ë¡œ ì´ë™)
        // ============================================
        function renderUniversalQuestions() {
            const container = document.getElementById('universal-questions');
            const isMinor = MINOR_STAGES.includes(selectedStage);
            
            // ============================================
            // ì¤‘ë³µ ì˜µì…˜ í•„í„°ë§ ë§µ ìƒì„± (ë¯¸ë‹ˆëª¨ë“ˆ/Step1 â†’ Step2)
            // ============================================
            const duplicateOptionsMap = {};
            
            // ë¯¸ë‹ˆëª¨ë“ˆ constraint â†’ univ_life_constraint ì¤‘ë³µ ë§¤í•‘
            const constraintToLifeConstraintMap = {
                'income_constraint': 'finance_pressure',     // ê²½ì œì  ì œì•½
                'physical_constraint': 'health',             // ê±´ê°•/ì²´ë ¥ ì œì•½
                'time_constraint': 'caregiving',             // ì‹œê°„ ì œì•½ â†’ ëŒë´„
            };
            
            // ë¯¸ë‹ˆëª¨ë“ˆ interest â†’ univ_interest ì¤‘ë³µ ë§¤í•‘
            const interestToUnivInterestMap = {
                'creative': 'creative',                      // ì°½ì‘/ì•„ì´ë””ì–´
                'analysis': 'science',                       // ë¶„ì„/ì—°êµ¬ â†’ ê³¼í•™/ì—°êµ¬
                'helping': 'social',                         // ë•ê¸°/ì„œë¹„ìŠ¤ â†’ ì‚¬íšŒ/ë³µì§€
                'data_handling': 'tech',                     // ë°ì´í„° â†’ ê¸°ìˆ /IT
            };
            
            // ë¯¸ë‹ˆëª¨ë“ˆ value â†’ univ_priority ì¤‘ë³µ ë§¤í•‘ (ì´ë¯¸ ì „ì²´ ì§ˆë¬¸ ì œì™¸ë¨)
            
            // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¤‘ë³µ ì˜µì…˜ ì¶”ì¶œ
            if (window.miniModuleResult) {
                const mm = window.miniModuleResult;
                
                // constraint_flags â†’ univ_life_constraint ì¤‘ë³µ
                if (mm.constraint_flags?.length > 0) {
                    duplicateOptionsMap['univ_life_constraint'] = mm.constraint_flags
                        .map(c => constraintToLifeConstraintMap[c])
                        .filter(Boolean);
                }
                
                // interest_top â†’ univ_interest ì¤‘ë³µ
                if (mm.interest_top?.length > 0) {
                    duplicateOptionsMap['univ_interest'] = mm.interest_top
                        .map(i => interestToUnivInterestMap[i])
                        .filter(Boolean);
                }
            }
            
            // Step 1ì—ì„œ ì œì•½ì¡°ê±´ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            function hasStep1Constraints() {
                if (!careerState.constraints) return false;
                return Object.values(careerState.constraints).some(c => c?.has_constraint === true);
            }
            
            // ë¯¸ì„±ë…„ ë‹¨ê³„ì—ì„œëŠ” ì˜¤í”ˆí…ìŠ¤íŠ¸ ì§ˆë¬¸ ìˆ¨ê¹€ + ë¯¸ë‹ˆëª¨ë“ˆ ì¤‘ë³µ ì§ˆë¬¸ ì œê±°
            const filteredQuestions = UNIVERSAL_QUESTIONS.filter(q => {
                if (isMinor && q.ui_type === 'text') return false;
                
                // === ë¯¸ë‹ˆëª¨ë“ˆê³¼ ì¤‘ë³µë˜ëŠ” ì§ˆë¬¸ ì œê±° ===
                // univ_priority (ê°€ì¹˜) - ë¯¸ë‹ˆëª¨ë“ˆ value_topê³¼ ì¤‘ë³µ
                if (q.id === 'univ_priority' && window.miniModuleResult?.value_top?.length > 0) {
                    return false;
                }
                // univ_interest (ê´€ì‹¬ì‚¬) - ë¯¸ë‹ˆëª¨ë“ˆ interest_topê³¼ ì¤‘ë³µ
                if (q.id === 'univ_interest' && window.miniModuleResult?.interest_top?.length > 0) {
                    return false;
                }
                // univ_strength (ê°•ì ) - ë¯¸ë‹ˆëª¨ë“ˆ strength_topê³¼ ì¤‘ë³µ
                if (q.id === 'univ_strength' && window.miniModuleResult?.strength_top?.length > 0) {
                    return false;
                }
                // univ_life_constraint (ìƒí™œ ì œì•½) - Step 1 ì œì•½ ë˜ëŠ” ë¯¸ë‹ˆëª¨ë“ˆ constraint_flagsì™€ ì¤‘ë³µ
                if (q.id === 'univ_life_constraint' && 
                    (window.miniModuleResult?.constraint_flags?.length > 0 || hasStep1Constraints())) {
                    return false;
                }
                
                return true;
            });
            
            // ê°’ ë³µì›: universalAnswersì— ì €ì¥ëœ ê°’ ë³µì›
            // ì¤‘ë³µ ì˜µì…˜ ë§µì„ ì „ì—­ì— ì €ì¥í•˜ì—¬ renderUniversalQuestionì—ì„œ ì‚¬ìš©
            window._duplicateOptionsMap = duplicateOptionsMap;
            
            // ì§ˆë¬¸ì„ order í•„ë“œì— ë”°ë¼ ì •ë ¬
            const sortedQuestions = filteredQuestions.sort((a, b) => (a.order || 999) - (b.order || 999));
            container.innerHTML = sortedQuestions.map(q => renderUniversalQuestion(q, isMinor)).join('');
            
            // ì €ì¥ëœ ê°’ ë³µì›
            restoreUniversalAnswers();
        }
        
        // ì €ì¥ëœ Universal ë‹µë³€ ë³µì›
        function restoreUniversalAnswers() {
            if (!universalAnswers || Object.keys(universalAnswers).length === 0) return;
            
            for (const [questionId, values] of Object.entries(universalAnswers)) {
                if (Array.isArray(values)) {
                    // ì¹©/ì²´í¬ë°•ìŠ¤ ì„ íƒ
                    for (const val of values) {
                        const btn = document.querySelector(\`[data-question-id="\${questionId}"] [data-value="\${val}"]\`);
                        if (btn && !btn.classList.contains('chip-selected')) {
                            btn.click();
                        }
                    }
                } else if (typeof values === 'string') {
                    // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
                    const radioBtn = document.querySelector(\`[data-question-id="\${questionId}"] [data-value="\${values}"]\`);
                    if (radioBtn && !radioBtn.classList.contains('radio-selected')) {
                        radioBtn.click();
                    }
                    
                    // í…ìŠ¤íŠ¸ ì…ë ¥
                    const textarea = document.querySelector(\`[data-question-id="\${questionId}"] textarea, textarea[name="\${questionId}"]\`);
                    if (textarea) textarea.value = values;
                }
            }
        }
        
        // V3: ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ ë‹¨ê³„ ë Œë”ë§ (Step 3.5 - ì „ì´ ì‹ í˜¸ ë‹¤ìŒ)
        // ìƒí™© + ê²½ë ¥ + ëª©í‘œì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì§ˆë¬¸ ì„ íƒ
        function renderNarrativeStep() {
            // Step 2ì—ì„œ í˜¸ì¶œ ì‹œ followup-questions-form ì‚¬ìš©
            const container = document.getElementById('followup-questions-form') || document.getElementById('transition-signal-form');
            if (!container) return;
            
            // ì €ì¥ëœ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            const questions = window.savedNarrativeQuestions || getNarrativeQuestions();
            const q1 = questions.question1;
            const q2 = questions.question2;
            
            // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì§ˆë¬¸ ì €ì¥ (ë‚˜ì¤‘ì— ì„ì‹œì €ì¥ ì‹œ ì‚¬ìš©)
            window.savedNarrativeQuestions = questions;
            
            // ì €ì¥ëœ ê°’ ë³µì› (fact_key ê¸°ë°˜)
            const savedQ0 = window.narrativeFacts?.storyAnswer || window.narrativeFacts?.life_story || '';
            const savedQ1 = window.narrativeFacts?.question1Answer || window.narrativeFacts?.highAliveMoment || '';
            const savedQ2 = window.narrativeFacts?.question2Answer || window.narrativeFacts?.lostMoment || '';
            const savedQ3 = window.narrativeFacts?.existentialAnswer || '';
            const savedCareerBg = window.narrativeFacts?.career_background || '';
            
            // ìŠ¤í† ë¦¬ ì§ˆë¬¸ (ê³µí†µ - ëª¨ë“  í…œí”Œë¦¿ì—ì„œ ì²« ë²ˆì§¸ ì§ˆë¬¸)
            const storyQuestion = {
                id: 'life_story',
                text: 'ê°„ëµí•˜ê²Œ ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”',
                placeholder: 'ì˜ˆ: ëŒ€í•™ì—ì„œ ê²½ì˜í•™ì„ ì „ê³µí•˜ê³  ë§ˆì¼€íŒ… íšŒì‚¬ì—ì„œ 3ë…„ ì¼í–ˆì–´ìš”. ìˆ«ìë³´ë‹¤ëŠ” ì‚¬ëŒë“¤ê³¼ ì†Œí†µí•˜ëŠ” ì¼ì´ ì¢‹ì•„ì„œ ê¸°íš ìª½ìœ¼ë¡œ ì˜®ê²¼ê³ , ì§€ê¸ˆì€ ìƒˆë¡œìš´ ë„ì „ì„ ì°¾ê³  ìˆì–´ìš”...',
                emoji: 'ğŸ“–',
                color: 'from-slate-500 to-blue-500',
                fact_key: 'narrative.life_story'
            };
            
            // ì „ê³µ/ì´ì „ ì§ì—… ì§ˆë¬¸ (ì„ íƒ - êµ¬ì¡°í™” ì…ë ¥)
            const careerBackgroundQuestion = {
                id: 'career_background',
                text: 'ì „ê³µ/ìµœê·¼ ì§ë¬´ ì •ë³´ (ì„ íƒ)',
                placeholder: 'ì˜ˆ: ì»´í“¨í„°ê³µí•™ ì „ê³µ, ë§ˆì¼€íŒ… íšŒì‚¬ 3ë…„ ê·¼ë¬´, ë°ì´í„° ë¶„ì„ ì—…ë¬´',
                hint: 'ì „ê³µ/í•™ê³¼, ìµœê·¼ ì§ë¬´/ì—…ì¢…, ê²½ë ¥ ê¸°ê°„ì„ ê°„ëµíˆ ì ì–´ì£¼ì„¸ìš”. AIê°€ ë” ì •í™•í•œ ì¶”ì²œì„ ë“œë¦¬ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.',
                emoji: 'ğŸ“‹',
                color: 'from-cyan-500 to-blue-500',
                fact_key: 'narrative.career_background',
                required: false
            };
            
            // ìƒ‰ìƒ íŒŒì‹± í•¨ìˆ˜
            const parseGradient = (color) => {
                const colors = color.replace('from-', '').replace(' to-', ',').split(',');
                const colorMap = {
                    'yellow-500': '234,179,8', 'orange-500': '249,115,22', 'red-500': '239,68,68',
                    'pink-500': '236,72,153', 'rose-500': '244,63,94', 'rose-600': '225,29,72',
                    'violet-500': '139,92,246', 'purple-500': '168,85,247', 'purple-600': '147,51,234',
                    'indigo-500': '99,102,241', 'indigo-600': '79,70,229', 'blue-500': '59,130,246',
                    'blue-600': '37,99,235', 'cyan-500': '6,182,212', 'cyan-600': '8,145,178',
                    'teal-500': '20,184,166', 'teal-600': '13,148,136', 'emerald-500': '16,185,129',
                    'green-500': '34,197,94', 'amber-500': '245,158,11', 'slate-500': '100,116,139',
                    'slate-600': '71,85,105', 'gray-600': '75,85,99', 'zinc-600': '82,82,91', 'pink-600': '219,39,119',
                };
                return colors.map(c => colorMap[c.trim()] || '139,92,246');
            };
            
            const q0Colors = parseGradient(storyQuestion.color);
            const careerBgColors = parseGradient(careerBackgroundQuestion.color);
            const q1Colors = parseGradient(q1.color);
            const q2Colors = parseGradient(q2.color);
            
            container.innerHTML = \`
                <!-- ê²©ë ¤ ë¬¸êµ¬ -->
                <div class="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 rounded-xl p-4 mb-6">
                    <p class="text-emerald-300 text-sm">
                        <i class="fas fa-lightbulb mr-2"></i>
                        ìì„¸íˆ (êµ¬ì²´ì ì¸ ìƒí™©, ê°ì •, ì´ìœ ë¥¼ ì†”ì§í•˜ê²Œ) ì‘ì„±í• ìˆ˜ë¡ AIê°€ ë‹¹ì‹ ì„ ë” ì˜ ì´í•´í•˜ê³ , ë” ì •í™•í•œ ì¶”ì²œì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.
                    </p>
                </div>
                
                <!-- ì„œìˆ í˜• ì§ˆë¬¸ 0 (ìŠ¤í† ë¦¬ - ê³µí†µ) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q0Colors[0]},0.1), rgba(\${q0Colors[1]},0.05)); border: 1px solid rgba(\${q0Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${storyQuestion.emoji}</span>
                        \${storyQuestion.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">í•™ë ¥, ê²½ë ¥, í˜„ì¬ ìƒí™© ë“± ë°°ê²½ì„ ê°„ëµíˆ ì ì–´ì£¼ì„¸ìš”. AIê°€ ë§¥ë½ì„ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë¼ìš”.</p>
                    <textarea 
                        id="narrative_q0"
                        name="narrative_q0" 
                        data-fact-key="\${storyQuestion.fact_key}"
                        data-question-id="\${storyQuestion.id}"
                        rows="4" 
                        minlength="30"
                        maxlength="5000"
                        placeholder="\${storyQuestion.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[100px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q0Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q0Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q0Colors[0]},0.3)'; validateNarrativeLength(this, 30);"
                        oninput="updateNarrativeCounter(this, 5000);">\${savedQ0}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q0_hint" class="text-xs text-wiki-muted">ìµœì†Œ 30ì / í˜„ì¬ \${savedQ0.length}ì</span>
                        <span id="narrative_q0_counter" class="text-xs text-wiki-muted">\${savedQ0.length}ì</span>
                    </div>
                </div>
                
                <!-- ì „ê³µ/ì´ì „ ì§ì—… ì •ë³´ (ì´ë ¥ì„œ ì—…ë¡œë“œ ì‹œ ìë™ ì…ë ¥ or ìˆ¨ê¹€) -->
                \${window.resumeUploaded && window.resumeCareerBackground ? \`
                    <!-- ì´ë ¥ì„œì—ì„œ ì¶”ì¶œëœ ì •ë³´ í‘œì‹œ (ì½ê¸° ì „ìš©) -->
                    <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3);">
                        <label class="block text-lg font-semibold mb-2 text-white">
                            <span class="mr-2">ğŸ“‹</span>
                            ì´ë ¥ì„œì—ì„œ ì¶”ì¶œëœ ë°°ê²½ ì •ë³´
                            <span class="text-xs text-emerald-400 ml-2">âœ“ ìë™ ì…ë ¥ë¨</span>
                        </label>
                        <div class="px-4 py-3 rounded-xl" style="background-color: rgba(15,15,35,0.7); border: 1px solid rgba(16,185,129,0.2);">
                            <p class="text-white">\${window.resumeCareerBackground}</p>
                        </div>
                        <input type="hidden" id="narrative_career_bg" name="narrative_career_bg" 
                               data-fact-key="\${careerBackgroundQuestion.fact_key}"
                               value="\${window.resumeCareerBackground}" />
                    </div>
                \` : \`
                    <!-- ìˆ˜ë™ ì…ë ¥ í•„ë“œ (ì´ë ¥ì„œ ë¯¸ì—…ë¡œë“œ ì‹œ) -->
                    <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${careerBgColors[0]},0.1), rgba(\${careerBgColors[1]},0.05)); border: 1px solid rgba(\${careerBgColors[0]},0.2);">
                        <label class="block text-lg font-semibold mb-2 text-white">
                            <span class="mr-2">\${careerBackgroundQuestion.emoji}</span>
                            \${careerBackgroundQuestion.text}
                            <span class="text-xs text-wiki-muted ml-2">(ì„ íƒì‚¬í•­)</span>
                        </label>
                        <p class="text-sm text-wiki-muted mb-4">\${careerBackgroundQuestion.hint}</p>
                        <input 
                            type="text"
                            id="narrative_career_bg"
                            name="narrative_career_bg" 
                            data-fact-key="\${careerBackgroundQuestion.fact_key}"
                            data-question-id="\${careerBackgroundQuestion.id}"
                            maxlength="500"
                            placeholder="\${careerBackgroundQuestion.placeholder}"
                            value="\${savedCareerBg}"
                            class="w-full px-4 py-3 rounded-xl border transition-all"
                            style="background-color: rgba(15,15,35,1); border-color: rgba(\${careerBgColors[0]},0.3); color: #fff;"
                            onfocus="this.style.borderColor='rgba(\${careerBgColors[0]},0.6)';"
                            onblur="this.style.borderColor='rgba(\${careerBgColors[0]},0.3)';"
                        />
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-wiki-muted/60">ì „ê³µ, ì§ë¬´, ì—…ì¢…, ê²½ë ¥ ê¸°ê°„ ë“± ì •í™•í•œ ì¶”ì²œì— ë„ì›€ì´ ë©ë‹ˆë‹¤</span>
                        </div>
                    </div>
                \`}
                
                <!-- ì„œìˆ í˜• ì§ˆë¬¸ 1 (ë™ì ) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q1Colors[0]},0.1), rgba(\${q1Colors[1]},0.05)); border: 1px solid rgba(\${q1Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q1.emoji}</span>
                        \${q1.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">êµ¬ì²´ì ì¸ ìƒí™©, ê·¸ë•Œì˜ ê°ì •, ì™œ ê·¸ë ‡ê²Œ ëŠê¼ˆëŠ”ì§€ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”</p>
                    <textarea 
                        id="narrative_q1"
                        name="narrative_q1" 
                        data-fact-key="\${q1.fact_key}"
                        data-question-id="\${q1.id}"
                        rows="5" 
                        minlength="50"
                        maxlength="10000"
                        placeholder="\${q1.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q1Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q1Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q1Colors[0]},0.3)'; validateNarrativeLength(this, 50);"
                        oninput="updateNarrativeCounter(this, 10000);">\${savedQ1}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q1_hint" class="text-xs text-wiki-muted">ìµœì†Œ 50ì / í˜„ì¬ \${savedQ1.length}ì</span>
                        <span id="narrative_q1_counter" class="text-xs text-wiki-muted">\${savedQ1.length}ì</span>
                    </div>
                </div>
                
                <!-- ì„œìˆ í˜• ì§ˆë¬¸ 2 (ë™ì ) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q2Colors[0]},0.1), rgba(\${q2Colors[1]},0.05)); border: 1px solid rgba(\${q2Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q2.emoji}</span>
                        \${q2.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">êµ¬ì²´ì ì¸ ìƒí™©, ê·¸ë•Œì˜ ê°ì •, ì™œ ê·¸ë ‡ê²Œ ëŠê¼ˆëŠ”ì§€ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”</p>
                    <textarea 
                        id="narrative_q2"
                        name="narrative_q2" 
                        data-fact-key="\${q2.fact_key}"
                        data-question-id="\${q2.id}"
                        rows="5" 
                        minlength="50"
                        maxlength="10000"
                        placeholder="\${q2.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q2Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q2Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q2Colors[0]},0.3)'; validateNarrativeLength(this, 50);"
                        oninput="updateNarrativeCounter(this, 10000);">\${savedQ2}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q2_hint" class="text-xs text-wiki-muted">ìµœì†Œ 50ì / í˜„ì¬ \${savedQ2.length}ì</span>
                        <span id="narrative_q2_counter" class="text-xs text-wiki-muted">\${savedQ2.length}ì</span>
                    </div>
                </div>
                
                <!-- ì„œìˆ í˜• ì§ˆë¬¸ 3: ì‹¤ì¡´ì  ê°€ì¹˜ ì§ˆë¬¸ -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.2);">
                    <label class="block text-lg font-semibold mb-3 text-white">
                        <span class="mr-2">\u{1F30C}</span>
                        ë§ˆì§€ë§‰ 7ì¼
                    </label>
                    <div class="text-sm text-slate-300 mb-4 leading-relaxed space-y-2">
                        <p>ì˜¤ëŠ˜ ë°¤ 9ì‹œ, ëª¨ë“  ë°©ì†¡ê³¼ íœ´ëŒ€í°ì— ê¸´ê¸‰ ë‰´ìŠ¤ê°€ ëœ¹ë‹ˆë‹¤.</p>
                        <p>ê³¼í•™ì ìœ¼ë¡œ í™•ì¸ëœ ì‚¬ì‹¤ì´ë©°, ì •í™•íˆ 7ì¼ ë’¤ ì§€êµ¬ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤. ìƒì¡´ ê°€ëŠ¥ì„±ì€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ì‚¬ëŒë“¤ì€ ê°ìì˜ ë°©ì‹ìœ¼ë¡œ ë‚¨ì€ ì‹œê°„ì„ ë³´ë‚´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.</p>
                        <p class="text-white font-medium pt-1">ì´ ì†Œì‹ì„ ë“£ëŠ” ìˆœê°„, ë‹¹ì‹ ì´ ê°€ì¥ ë¨¼ì € ë– ì˜¬ë¦´ í–‰ë™ì€ ë¬´ì—‡ì¼ ê²ƒ ê°™ë‚˜ìš”?</p>
                        <p class="text-white font-medium">ì–´ë””ë¡œ ê°€ê³  ì‹¶ê³ , ëˆ„êµ¬ë¥¼ ë§Œë‚˜ê³  ì‹¶ê³ , ë¬´ì—‡ì„ í•˜ê³  ì‹¶ì„ ê²ƒ ê°™ë‚˜ìš”?</p>
                        <p class="text-white font-medium">ê·¸ë¦¬ê³  ì™œ ê·¸ê²ƒì´ ê°€ì¥ ë¨¼ì € ë– ì˜¬ëì„ê¹Œìš”?</p>
                    </div>
                    <textarea
                        id="narrative_q3"
                        name="narrative_q3"
                        data-fact-key="narrative.existential_answer"
                        rows="5"
                        minlength="30"
                        maxlength="5000"
                        placeholder="ê°€ì¥ ë¨¼ì € ë– ì˜¤ë¥´ëŠ” í–‰ë™, ê°€ê³  ì‹¶ì€ ê³³, ë§Œë‚˜ê³  ì‹¶ì€ ì‚¬ëŒ, ê·¸ë¦¬ê³  ê·¸ ì´ìœ ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”..."
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[100px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(168,85,247,0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(168,85,247,0.6)';"
                        onblur="this.style.borderColor='rgba(168,85,247,0.3)'; validateNarrativeLength(this, 30);"
                        oninput="updateNarrativeCounter(this, 5000);">\${savedQ3}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q3_hint" class="text-xs text-wiki-muted">ìµœì†Œ 30ì / í˜„ì¬ \${savedQ3.length}ì</span>
                        <span id="narrative_q3_counter" class="text-xs text-wiki-muted">\${savedQ3.length}ì</span>
                    </div>
                </div>

                <!-- ì¶”ê°€ ê²©ë ¤ ë¬¸êµ¬ -->
                <div class="text-center text-xs text-wiki-muted/60 mt-6">
                    <i class="fas fa-shield-alt mr-1"></i>
                    ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ì¶”ì²œì—ë§Œ ì‚¬ìš©ë˜ë©°, ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            \`;
            
            // Step 2 ì œëª© ë° ì„œë¸Œíƒ€ì´í‹€ ì—…ë°ì´íŠ¸ (3ë‹¨ê³„ êµ¬ì¡°)
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = '<i class="fas fa-comments text-wiki-primary mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ';
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                step2Subtitle.textContent = 'ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ë“¤ë ¤ì£¼ì„¸ìš”';
            }
            
            // Step ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸ - ì‹¬ì¸µ ë‹¨ê³„ (Step 2) í‘œì‹œ
            currentStep = 2;
            window.currentStep = 2;
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= 2) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            
            // Step 2 ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ';
                analyzeBtn.onclick = submitNarrativeAndContinueV3;
            }
            
            // ì´ì „ ë²„íŠ¼: í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    // ì„œìˆ í˜• ë‹µë³€ ì„ì‹œ ì €ì¥
                    collectNarrativeAnswers();
                    // í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
                    goToStep(1);
                    goToProfileStep2();  // í”„ë¡œí•„ 2/2ë¡œ ì´ë™
                };
            }
            
            // ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì¹´ìš´í„°/íŒíŠ¸ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                const q0 = document.getElementById('narrative_q0');
                const q1 = document.getElementById('narrative_q1');
                const q2 = document.getElementById('narrative_q2');
                if (q0 && q0.value) {
                    updateNarrativeCounter(q0, 5000);
                    validateNarrativeLength(q0, 30);
                }
                if (q1 && q1.value) {
                    updateNarrativeCounter(q1, 10000);
                    validateNarrativeLength(q1, 50);
                }
                if (q2 && q2.value) {
                    updateNarrativeCounter(q2, 10000);
                    validateNarrativeLength(q2, 50);
                }
                const q3 = document.getElementById('narrative_q3');
                if (q3 && q3.value) {
                    updateNarrativeCounter(q3, 5000);
                    validateNarrativeLength(q3, 30);
                }
            }, 100);
        }
        
        // ì„œìˆ í˜• ê¸€ììˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸ (ìƒí•œì„  ê·¼ì ‘ ì‹œì—ë§Œ í‘œì‹œ)
        function updateNarrativeCounter(textarea, maxLength) {
            const counter = document.getElementById(textarea.id + '_counter');
            const hint = document.getElementById(textarea.id + '_hint');
            const current = textarea.value.length;
            const minLength = parseInt(textarea.minLength) || 30;
            
            if (counter) {
                // í•­ìƒ ê¸€ììˆ˜ í‘œì‹œ
                counter.textContent = current.toLocaleString() + 'ì';
                counter.classList.remove('hidden');
                
                // ìƒ‰ìƒ (ìµœì†Œ ì¶©ì¡± ì—¬ë¶€ì— ë”°ë¼)
                if (current >= maxLength * 0.9) {
                    counter.style.color = current >= maxLength ? 'rgb(239, 68, 68)' : 'rgb(251, 146, 60)';
                } else if (current >= minLength) {
                    counter.style.color = 'rgb(74, 222, 128)';  // ìµœì†Œ ì¶©ì¡±: ì´ˆë¡ìƒ‰
                } else {
                    counter.style.color = 'rgb(148, 163, 184)';  // ë¯¸ì¶©ì¡±: íšŒìƒ‰
                }
            }
            
            // íŒíŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ìµœì†Œ ê¸€ììˆ˜ í‘œì‹œ)
            if (hint) {
                if (current >= minLength) {
                    hint.textContent = 'âœ“ ìµœì†Œ ' + minLength + 'ì ì¶©ì¡±';
                    hint.style.color = 'rgb(74, 222, 128)';
                } else {
                    hint.textContent = 'ìµœì†Œ ' + minLength + 'ì / í˜„ì¬ ' + current + 'ì';
                    hint.style.color = 'rgb(148, 163, 184)';
                }
            }
        }
        
        // ì„œìˆ í˜• ìµœì†Œ ê¸¸ì´ ê²€ì¦ (ì••ë°• ì œê±°, ê¶Œì¥ ë©”ì‹œì§€ë¡œ ë³€ê²½)
        function validateNarrativeLength(textarea, minLength) {
            const hint = document.getElementById(textarea.id + '_hint');
            const current = textarea.value.length;
            if (hint) {
                // í•­ìƒ ë¶€ë“œëŸ¬ìš´ í†¤ìœ¼ë¡œ ì•ˆë‚´
                hint.textContent = 'ğŸ’¡ ìì„¸íˆ ì ì„ìˆ˜ë¡ ì¶”ì²œ ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤';
                hint.style.color = 'rgb(148,163,184)';
            }
        }
        
        // ì„œìˆ í˜• ë‹µë³€ ì œì¶œ í›„ V3 ë¼ìš´ë“œë¡œ ì§„í–‰
        async function submitNarrativeAndContinueV3() {
            // ì„œìˆ í˜• ë‹µë³€ ê²€ì¦
            if (!validateNarrativeRequired()) {
                return;
            }

            // ì„œìˆ í˜• ë‹µë³€ ìˆ˜ì§‘ ë° ì €ì¥
            const narrativeFacts = collectNarrativeAnswers();

            // Phase 3: í¸ì§‘ ëª¨ë“œ - ì„œìˆ í˜• ë³€ê²½ ì‹œ ë¼ìš´ë“œ ë°ì´í„° ì´ˆê¸°í™”
            if (window.__editMode && detectNarrativeChanges()) {
                cascadeResetFromNarrative();
            }
            if (narrativeFacts) {
                await saveNarrativeFacts(narrativeFacts);
            }
            
            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();
            
            // 3ë¼ìš´ë“œ ì‹¬ì¸µ ì§ˆë¬¸ ì‹œì‘
            await startV3RoundQuestions(1);
        }
        
        // ì„œìˆ í˜• ë‹µë³€ ìˆ˜ì§‘ (ë™ì  ì§ˆë¬¸ ì§€ì›)
        function collectNarrativeAnswers() {
            const q0 = document.getElementById('narrative_q0');
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');
            const q3 = document.getElementById('narrative_q3');
            const careerBg = document.getElementById('narrative_career_bg');

            // ë ˆê±°ì‹œ ì§€ì› (ì´ì „ ë²„ì „ í˜¸í™˜)
            const legacyHighAlive = document.getElementById('narrative_high_alive');
            const legacyLost = document.getElementById('narrative_lost');

            if (q1 && q2) {
                // ìƒˆë¡œìš´ ë™ì  ì§ˆë¬¸ í˜•ì‹
                window.narrativeFacts = {
                    // ìŠ¤í† ë¦¬ ì§ˆë¬¸ (ê³µí†µ)
                    storyAnswer: q0?.value?.trim() || '',
                    life_story: q0?.value?.trim() || '',
                    // ì „ê³µ/ì´ì „ ì§ì—… (ì„ íƒ)
                    career_background: careerBg?.value?.trim() || '',
                    // ë ˆê±°ì‹œ í˜¸í™˜ì„± ìœ ì§€
                    highAliveMoment: q1.value.trim(),
                    lostMoment: q2.value.trim(),
                    // ì‹¤ì¡´ì  ê°€ì¹˜ ì§ˆë¬¸ (7ì¼ ë’¤ ì§€êµ¬ ë©¸ë§)
                    existentialAnswer: q3?.value?.trim() || '',
                    // ìƒˆë¡œìš´ êµ¬ì¡°
                    question1Answer: q1.value.trim(),
                    question2Answer: q2.value.trim(),
                    question1FactKey: q1.dataset.factKey,
                    question2FactKey: q2.dataset.factKey,
                    question1Id: q1.dataset.questionId,
                    question2Id: q2.dataset.questionId,
                };
            } else if (legacyHighAlive && legacyLost) {
                // ë ˆê±°ì‹œ í˜•ì‹
                window.narrativeFacts = {
                    highAliveMoment: legacyHighAlive.value.trim(),
                    lostMoment: legacyLost.value.trim()
                };
            }
            return window.narrativeFacts || null;
        }

        // ì„œìˆ í˜• í•„ìˆ˜ ê²€ì¦ (ë™ì  ì§ˆë¬¸ ì§€ì›)
        function validateNarrativeRequired() {
            const isMinor = MINOR_STAGES.includes(selectedStage);
            if (isMinor) return true; // ë¯¸ì„±ë…„ì€ ì„œìˆ í˜• ì—†ìŒ

            // ìŠ¤í† ë¦¬ ì§ˆë¬¸ (ê³µí†µ)
            const q0 = document.getElementById('narrative_q0');
            
            // ìƒˆë¡œìš´ ë™ì  ì§ˆë¬¸ í˜•ì‹
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');
            
            // ë ˆê±°ì‹œ ì§€ì›
            const legacyHighAlive = document.getElementById('narrative_high_alive');
            const legacyLost = document.getElementById('narrative_lost');
            
            const textarea1 = q1 || legacyHighAlive;
            const textarea2 = q2 || legacyLost;

            if (!textarea1 || !textarea2) return true; // ìš”ì†Œ ì—†ìœ¼ë©´ íŒ¨ìŠ¤

            // ìŠ¤í† ë¦¬ ì§ˆë¬¸ ê²€ì¦ (ìµœì†Œ 30ì)
            if (q0 && q0.value.trim().length < 30) {
                q0.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q0.focus();
                alert('ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸°ë¥¼ 30ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            const q1Valid = textarea1.value.trim().length >= 50;
            const q2Valid = textarea2.value.trim().length >= 50;

            if (!q1Valid) {
                textarea1.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                textarea1.focus();
                alert('ì²« ë²ˆì§¸ ì§ˆë¬¸ì— 50ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            if (!q2Valid) {
                textarea2.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                textarea2.focus();
                alert('ë‘ ë²ˆì§¸ ì§ˆë¬¸ì— 50ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            // ì‹¤ì¡´ì  ì§ˆë¬¸ ê²€ì¦ (ìµœì†Œ 30ì)
            const q3El = document.getElementById('narrative_q3');
            if (q3El && q3El.value.trim().length > 0 && q3El.value.trim().length < 30) {
                q3El.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q3El.focus();
                alert('ì‹¤ì¡´ì  ì§ˆë¬¸ì— 30ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            return true;
        }
        
        function renderUniversalQuestion(q, isMinor) {
            let optionsHtml = '';
            const requiredMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : '';
            const qId = q.question_id || q.id;  // question_id ë˜ëŠ” id ì‚¬ìš©
            
            // íŠ¹ë³„í•œ ìƒí™© ì§ˆë¬¸ì¸ ê²½ìš° ì¶”ê°€ ì„¤ëª… í•„ë“œ í¬í•¨
            const isLifeConstraint = qId === 'univ_life_constraint';
            
            if (q.ui_type === 'language_chips') {
                // ì–¸ì–´ ì„ íƒ UI (ìˆ˜ì¤€ ì„ íƒ + ê¸°íƒ€ ì–¸ì–´ ì…ë ¥ ì§€ì›)
                const levels = q.levels || [
                    { value: 'basic', label: 'ì¼ìƒíšŒí™”' },
                    { value: 'business', label: 'ì—…ë¬´ê°€ëŠ¥' },
                    { value: 'native', label: 'ì›ì–´ë¯¼ê¸‰' },
                ];
                optionsHtml = \`
                    <div class="language-selector" data-question-id="\${qId}" data-max-selections="\${q.max_selections || 5}">
                        <div class="flex flex-wrap gap-2 mb-3">
                            \${(q.options || []).map(opt => \`
                                <button type="button" onclick="toggleLanguageChip('\${qId}', '\${opt.value}', this, \${opt.hasInput || false})"
                                        class="lang-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                        data-value="\${opt.value}" data-has-level="\${opt.hasLevel || false}" data-has-input="\${opt.hasInput || false}">
                                    <span class="flex items-center gap-2">
                                        \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                        <span>\${opt.label}</span>
                                    </span>
                                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                </button>
                            \`).join('')}
                        </div>
                        
                        <!-- ì–¸ì–´ ìˆ˜ì¤€ ì„ íƒ íŒ¨ë„ (ì–¸ì–´ ì„ íƒ ì‹œ í‘œì‹œ) -->
                        <div id="lang-level-panel-\${qId}" class="hidden mt-3 p-4 rounded-xl" style="background-color: rgba(15,15,35,0.8); border: 1px solid rgba(42,42,62,0.5);">
                            <p class="text-sm mb-3" style="color: rgb(148,163,184);">
                                <span id="lang-level-label-\${qId}">ì˜ì–´</span> ìˆ˜ì¤€ì„ ì„ íƒí•´ì£¼ì„¸ìš”:
                            </p>
                            <div class="flex flex-wrap gap-2">
                                \${levels.map(lvl => \`
                                    <button type="button" onclick="selectLanguageLevel('\${qId}', '\${lvl.value}', this)"
                                            class="level-option px-4 py-2 rounded-lg border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-level="\${lvl.value}">
                                        \${lvl.label}
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                        
                        <!-- ê¸°íƒ€ ì–¸ì–´ ì…ë ¥ íŒ¨ë„ -->
                        <div id="lang-other-panel-\${qId}" class="hidden mt-3 p-4 rounded-xl" style="background-color: rgba(15,15,35,0.8); border: 1px solid rgba(42,42,62,0.5);">
                            <p class="text-sm mb-3" style="color: rgb(148,163,184);">ì–´ë–¤ ì–¸ì–´ì¸ê°€ìš”?</p>
                            <div class="flex gap-2 flex-wrap">
                                <select id="lang-other-select-\${qId}" onchange="selectOtherLanguage('\${qId}', this.value)"
                                        class="px-4 py-2 rounded-lg border flex-shrink-0"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);">
                                    <option value="">ì„ íƒ...</option>
                                    <option value="vietnamese">ë² íŠ¸ë‚¨ì–´</option>
                                    <option value="thai">íƒœêµ­ì–´</option>
                                    <option value="indonesian">ì¸ë„ë„¤ì‹œì•„ì–´</option>
                                    <option value="russian">ëŸ¬ì‹œì•„ì–´</option>
                                    <option value="portuguese">í¬ë¥´íˆ¬ê°ˆì–´</option>
                                    <option value="arabic">ì•„ëì–´</option>
                                    <option value="hindi">íŒë””ì–´</option>
                                    <option value="italian">ì´íƒˆë¦¬ì•„ì–´</option>
                                    <option value="dutch">ë„¤ëœë€ë“œì–´</option>
                                    <option value="custom">ì§ì ‘ ì…ë ¥...</option>
                                </select>
                                <input type="text" id="lang-other-input-\${qId}" 
                                       placeholder="ì–¸ì–´ëª… ì…ë ¥" 
                                       class="hidden px-4 py-2 rounded-lg border flex-1 min-w-[150px]"
                                       style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: #fff;"
                                       onchange="setCustomLanguage('\${qId}', this.value)">
                            </div>
                            <div class="mt-3">
                                <p class="text-sm mb-2" style="color: rgb(148,163,184);">ìˆ˜ì¤€:</p>
                                <div class="flex flex-wrap gap-2">
                                    \${levels.map(lvl => \`
                                        <button type="button" onclick="selectOtherLanguageLevel('\${qId}', '\${lvl.value}', this)"
                                                class="other-level-option px-4 py-2 rounded-lg border transition-all duration-200"
                                                style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                                data-level="\${lvl.value}">
                                            \${lvl.label}
                                        </button>
                                    \`).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì„ íƒëœ ì–¸ì–´ í‘œì‹œ -->
                        <div id="lang-selected-\${qId}" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>
                    \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">ìµœëŒ€ \${q.max_selections}ê°œ ì„ íƒ ê°€ëŠ¥</p>\` : ''}
                \`;
            } else if (q.ui_type === 'chips' || q.ui_type === 'checkbox') {
                // ì¤‘ë³µ ì˜µì…˜ í•„í„°ë§ (ë¯¸ë‹ˆëª¨ë“ˆì—ì„œ ì´ë¯¸ ì„ íƒëœ í•­ëª©)
                const duplicateOptions = window._duplicateOptionsMap?.[qId] || [];
                
                optionsHtml = \`
                    <div class="flex flex-wrap gap-2" data-question-id="\${qId}" data-max-selections="\${q.max_selections || 99}">
                        \${(q.options || []).map(opt => {
                            const isDuplicate = duplicateOptions.includes(opt.value);
                            if (isDuplicate) {
                                // ì¤‘ë³µ ì˜µì…˜: ë¹„í™œì„±í™” ìƒíƒœë¡œ í‘œì‹œ + "ì´ë¯¸ ì„ íƒë¨" í‘œì‹œ
                                return \`
                                    <button type="button" disabled
                                            class="chip-option chip-duplicate group relative px-4 py-2.5 rounded-xl border transition-all duration-200 cursor-not-allowed"
                                            style="background-color: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.3); color: rgb(165,180,252); opacity: 0.7;"
                                            data-value="\${opt.value}" title="ë‚˜ë¥¼ ì•Œì•„ê°€ê¸° ë‹¨ê³„ì—ì„œ ì´ë¯¸ ì„ íƒë¨">
                                        <span class="flex items-center gap-2">
                                            \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                            <span>\${opt.label}</span>
                                            <span class="text-xs ml-1" style="color: rgb(129,140,248);">âœ“ ì„ íƒë¨</span>
                                        </span>
                                    </button>
                                \`;
                            }
                            return \`
                                <button type="button" onclick="toggleChipOption('\${qId}', '\${opt.value}', this, false)"
                                        class="chip-option group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                        data-value="\${opt.value}">
                                    <span class="flex items-center gap-2">
                                        \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                        <span>\${opt.label}</span>
                                    </span>
                                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                </button>
                            \`;
                        }).join('')}
                        \${q.allow_unknown ? \`
                            <button type="button" onclick="toggleChipOption('\${qId}', '_unknown', this, true)"
                                    class="chip-option chip-unknown group relative px-4 py-2.5 rounded-xl border border-dashed transition-all duration-200"
                                    style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5); color: rgb(120,120,140);"
                                    data-value="_unknown">
                                <span class="flex items-center gap-2">
                                    <span class="text-lg">â“</span>
                                    <span>\${q.unknown_label}</span>
                                </span>
                                <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-slate-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                            </button>
                        \` : ''}
                    </div>
                    \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">ìµœëŒ€ \${q.max_selections}ê°œ ì„ íƒ ê°€ëŠ¥</p>\` : ''}
                    \${isLifeConstraint ? \`
                        <div id="life-constraint-detail" class="mt-4 hidden">
                            <label class="text-sm font-medium mb-2 block" style="color: rgb(148,163,184)">
                                <i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ìƒí™©ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œë ¤ì£¼ì„¸ìš” (ì„ íƒ)
                            </label>
                            <textarea id="life_constraint_detail" 
                                      name="life_constraint_detail" 
                                      rows="3"
                                      placeholder="ì˜ˆ: ì¥ì• ì˜ ì¢…ë¥˜, ëŒë´„ ëŒ€ìƒê³¼ ì‹œê°„, ê²½ì œì  ìƒí™© ë“± êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì‹œë©´ ë” ì •í™•í•œ ì¶”ì²œì´ ê°€ëŠ¥í•´ìš”"
                                      class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                      style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                                      onfocus="this.style.borderColor='rgba(67,97,238,0.5)';"
                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)'; updateLifeConstraintDetail(this.value);"></textarea>
                            <p class="text-xs mt-1" style="color: rgba(148,163,184,0.6)">ì…ë ¥í•œ ë‚´ìš©ì€ ì¶”ì²œ ì •í™•ë„ë¥¼ ë†’ì´ëŠ” ë°ì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤</p>
                        </div>
                    \` : ''}
                \`;
            } else if (q.ui_type === 'radio') {
                optionsHtml = \`
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3" data-question-id="\${q.id}">
                        \${(q.options || []).map(opt => \`
                            <button type="button" onclick="selectRadioOption('\${q.id}', '\${opt.value}', this, false)"
                                    class="radio-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                    style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                    data-value="\${opt.value}">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                    </div>
                                    <span style="color: rgb(148,163,184)">\${opt.emoji || ''} \${opt.label}</span>
                                </div>
                            </button>
                        \`).join('')}
                        \${q.allow_unknown ? \`
                            <button type="button" onclick="selectRadioOption('\${q.id}', '_unknown', this, true)"
                                    class="radio-option radio-unknown group relative p-4 rounded-xl border border-dashed text-left transition-all duration-200"
                                    style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5);"
                                    data-value="_unknown">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full bg-slate-500 hidden radio-dot"></div>
                                    </div>
                                    <span style="color: rgb(120,120,140)">â“ \${q.unknown_label}</span>
                                </div>
                            </button>
                        \` : ''}
                    </div>
                \`;
            } else if (q.ui_type === 'text') {
                const privacyWarning = isMinor ? \`
                    <p class="text-xs text-yellow-400 mt-2">âš ï¸ ë¯¼ê°í•œ ê°œì¸ì •ë³´(ì£¼ì†Œ/í•™êµ ì´ë¦„/ì—°ë½ì²˜/ì‹¤ëª… ë“±)ëŠ” ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.</p>
                \` : '';
                optionsHtml = \`
                    <textarea name="\${q.id}" rows="3" placeholder="\${q.placeholder || ''}"
                              class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                              style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                              onfocus="this.style.borderColor='rgba(67,97,238,0.5)';"
                              onblur="this.style.borderColor='rgba(42,42,62,0.5)';"></textarea>
                    \${privacyWarning}
                \`;
            }
            
            // help_text í‘œì‹œ
            const helpTextHtml = q.help_text ? \`<p class="text-xs mt-3 px-2 py-1.5 rounded-lg" style="color: rgb(147,197,253); background-color: rgba(59,130,246,0.1);">\${q.help_text}</p>\` : '';
            
            return \`
                <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                    <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                    \${optionsHtml}
                    \${helpTextHtml}
                </div>
            \`;
        }
        
        // ì¹© ì˜µì…˜ í† ê¸€ (ë³µìˆ˜ ì„ íƒ)
        function toggleChipOption(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const maxSelections = parseInt(container.dataset.maxSelections) || 99;
            const isSelected = btnEl.classList.contains('selected');
            
            if (isUnknown) {
                // "ëª¨ë¥´ê² ì–´ìš”" ë¥˜ ì„ íƒ ì‹œ: ë‹¤ë¥¸ ëª¨ë“  ì„ íƒ í•´ì œ
                container.querySelectorAll('.chip-option').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.style.backgroundColor = btn.classList.contains('chip-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                    btn.style.borderColor = btn.classList.contains('chip-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                    btn.style.color = btn.classList.contains('chip-unknown') ? 'rgb(120,120,140)' : 'rgb(148,163,184)';
                    btn.querySelector('.chip-check')?.classList.add('hidden');
                    btn.querySelector('.chip-check')?.classList.remove('flex');
                });
                
                if (!isSelected) {
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.style.color = '#94a3b8';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    
                    // ë‹¤ë¥¸ ì˜µì…˜ë“¤ ë¹„í™œì„±í™” í‘œì‹œ
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                } else {
                    // ë‹¤ë¥¸ ì˜µì…˜ë“¤ ë‹¤ì‹œ í™œì„±í™”
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
            } else {
                // ì¼ë°˜ ì˜µì…˜ ì„ íƒ ì‹œ
                // ë¨¼ì € "ëª¨ë¥´ê² ì–´ìš”" í•´ì œ
                const unknownBtn = container.querySelector('.chip-unknown');
                if (unknownBtn && unknownBtn.classList.contains('selected')) {
                    unknownBtn.classList.remove('selected');
                    unknownBtn.style.backgroundColor = 'rgba(15,15,35,0.5)';
                    unknownBtn.style.borderColor = 'rgba(100,100,120,0.5)';
                    unknownBtn.style.borderStyle = 'dashed';
                    unknownBtn.style.color = 'rgb(120,120,140)';
                    unknownBtn.querySelector('.chip-check')?.classList.add('hidden');
                    unknownBtn.querySelector('.chip-check')?.classList.remove('flex');
                    // ë‹¤ë¥¸ ì˜µì…˜ë“¤ ë‹¤ì‹œ í™œì„±í™”
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
                
                if (isSelected) {
                    // ì„ íƒ í•´ì œ
                    btnEl.classList.remove('selected');
                    btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                    btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                    btnEl.style.color = 'rgb(148,163,184)';
                    btnEl.querySelector('.chip-check')?.classList.add('hidden');
                    btnEl.querySelector('.chip-check')?.classList.remove('flex');
                } else {
                    // ìµœëŒ€ ì„ íƒ ìˆ˜ ì²´í¬
                    const selectedCount = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)').length;
                    if (selectedCount >= maxSelections) {
                        // ê°€ì¥ ë¨¼ì € ì„ íƒëœ ê²ƒ í•´ì œ
                        const firstSelected = container.querySelector('.chip-option.selected:not(.chip-unknown)');
                        if (firstSelected) {
                            firstSelected.classList.remove('selected');
                            firstSelected.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            firstSelected.style.borderColor = 'rgba(42,42,62,0.5)';
                            firstSelected.style.color = 'rgb(148,163,184)';
                            firstSelected.querySelector('.chip-check')?.classList.add('hidden');
                            firstSelected.querySelector('.chip-check')?.classList.remove('flex');
                        }
                    }
                    
                    // ìƒˆ ì„ íƒ
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.style.color = '#34d399';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                }
            }
            
            // íŠ¹ë³„í•œ ìƒí™© (univ_life_constraint) ì¶”ê°€ ì„¤ëª… í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
            if (questionId === 'univ_life_constraint') {
                const detailContainer = document.getElementById('life-constraint-detail');
                if (detailContainer) {
                    const selectedCount = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)').length;
                    if (selectedCount > 0) {
                        detailContainer.classList.remove('hidden');
                    } else {
                        detailContainer.classList.add('hidden');
                    }
                }
            }
        }
        
        // íŠ¹ë³„í•œ ìƒí™© ì¶”ê°€ ì„¤ëª… ì—…ë°ì´íŠ¸
        function updateLifeConstraintDetail(value) {
            universalAnswers['life_constraint_detail'] = value;
        }
        
        // ============================================
        // ì–¸ì–´ ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ============================================
        // ì„ íƒëœ ì–¸ì–´ ë°ì´í„° ì €ì¥
        window.selectedLanguages = {};
        window.currentLangSelection = {};  // í˜„ì¬ ì„ íƒ ì¤‘ì¸ ì–¸ì–´ ì •ë³´
        
        // ì–¸ì–´ ì¹© í† ê¸€
        function toggleLanguageChip(questionId, langValue, btnEl, hasInput) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const maxSelections = parseInt(container?.dataset?.maxSelections || '5');
            const isSelected = btnEl.classList.contains('selected');
            const hasLevel = btnEl.dataset.hasLevel === 'true';
            
            // ìˆ˜ì¤€ íŒ¨ë„ ìˆ¨ê¸°ê¸° (ë‹¤ë¥¸ ì–¸ì–´ ì„ íƒ ì‹œ)
            const levelPanel = document.getElementById(\`lang-level-panel-\${questionId}\`);
            const otherPanel = document.getElementById(\`lang-other-panel-\${questionId}\`);
            
            if (isSelected) {
                // ì„ íƒ í•´ì œ
                btnEl.classList.remove('selected');
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
                
                // ì €ì¥ëœ ì–¸ì–´ ë°ì´í„°ì—ì„œ ì œê±°
                if (window.selectedLanguages[questionId]) {
                    delete window.selectedLanguages[questionId][langValue];
                }
                
                // íŒ¨ë„ ìˆ¨ê¸°ê¸°
                if (levelPanel) levelPanel.classList.add('hidden');
                if (otherPanel) otherPanel.classList.add('hidden');
                
                updateLanguageDisplay(questionId);
            } else {
                // ìµœëŒ€ ì„ íƒ ìˆ˜ ì²´í¬
                const currentCount = Object.keys(window.selectedLanguages[questionId] || {}).length;
                if (currentCount >= maxSelections) {
                    alert(\`ìµœëŒ€ \${maxSelections}ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.\`);
                    return;
                }
                
                // í˜„ì¬ ì„ íƒ ì¤‘ì¸ ì–¸ì–´ ì •ë³´ ì €ì¥
                window.currentLangSelection[questionId] = { 
                    lang: langValue, 
                    btnEl: btnEl,
                    hasLevel: hasLevel,
                    hasInput: hasInput
                };
                
                if (hasInput) {
                    // ê¸°íƒ€ ì–¸ì–´: ì…ë ¥ íŒ¨ë„ í‘œì‹œ
                    if (levelPanel) levelPanel.classList.add('hidden');
                    if (otherPanel) {
                        otherPanel.classList.remove('hidden');
                        // ì´ˆê¸°í™”
                        const select = document.getElementById(\`lang-other-select-\${questionId}\`);
                        const input = document.getElementById(\`lang-other-input-\${questionId}\`);
                        if (select) select.value = '';
                        if (input) { input.value = ''; input.classList.add('hidden'); }
                    }
                } else if (hasLevel) {
                    // ìˆ˜ì¤€ ì„ íƒ íŒ¨ë„ í‘œì‹œ
                    if (otherPanel) otherPanel.classList.add('hidden');
                    if (levelPanel) {
                        levelPanel.classList.remove('hidden');
                        const label = document.getElementById(\`lang-level-label-\${questionId}\`);
                        if (label) label.textContent = btnEl.querySelector('span span:last-child')?.textContent || langValue;
                        // ìˆ˜ì¤€ ë²„íŠ¼ ì´ˆê¸°í™”
                        levelPanel.querySelectorAll('.level-option').forEach(opt => {
                            opt.classList.remove('selected');
                            opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            opt.style.borderColor = 'rgba(42,42,62,0.5)';
                            opt.style.color = 'rgb(148,163,184)';
                        });
                    }
                } else {
                    // ìˆ˜ì¤€ ì„ íƒ ì—†ëŠ” ì–¸ì–´: ë°”ë¡œ ì„ íƒ ì™„ë£Œ
                    completeLanguageSelection(questionId, langValue, 'business', btnEl);
                }
            }
        }
        window.toggleLanguageChip = toggleLanguageChip;
        
        // ì–¸ì–´ ìˆ˜ì¤€ ì„ íƒ
        function selectLanguageLevel(questionId, levelValue, btnEl) {
            const current = window.currentLangSelection[questionId];
            if (!current) return;
            
            // ìˆ˜ì¤€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const panel = document.getElementById(\`lang-level-panel-\${questionId}\`);
            panel?.querySelectorAll('.level-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                opt.style.borderColor = 'rgba(42,42,62,0.5)';
                opt.style.color = 'rgb(148,163,184)';
            });
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            
            // ì„ íƒ ì™„ë£Œ
            completeLanguageSelection(questionId, current.lang, levelValue, current.btnEl);
            
            // íŒ¨ë„ ìˆ¨ê¸°ê¸°
            if (panel) panel.classList.add('hidden');
        }
        window.selectLanguageLevel = selectLanguageLevel;
        
        // ê¸°íƒ€ ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ì„ íƒ
        function selectOtherLanguage(questionId, value) {
            const input = document.getElementById(\`lang-other-input-\${questionId}\`);
            if (value === 'custom') {
                input?.classList.remove('hidden');
                input?.focus();
            } else {
                input?.classList.add('hidden');
                if (input) input.value = '';
            }
            window.currentLangSelection[questionId].otherLang = value === 'custom' ? '' : value;
        }
        window.selectOtherLanguage = selectOtherLanguage;
        
        // ê¸°íƒ€ ì–¸ì–´ ì§ì ‘ ì…ë ¥
        function setCustomLanguage(questionId, value) {
            window.currentLangSelection[questionId].otherLang = value;
        }
        window.setCustomLanguage = setCustomLanguage;
        
        // ê¸°íƒ€ ì–¸ì–´ ìˆ˜ì¤€ ì„ íƒ
        function selectOtherLanguageLevel(questionId, levelValue, btnEl) {
            const current = window.currentLangSelection[questionId];
            if (!current || !current.otherLang) {
                alert('ë¨¼ì € ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìˆ˜ì¤€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const panel = document.getElementById(\`lang-other-panel-\${questionId}\`);
            panel?.querySelectorAll('.other-level-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                opt.style.borderColor = 'rgba(42,42,62,0.5)';
                opt.style.color = 'rgb(148,163,184)';
            });
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            
            // ì„ íƒ ì™„ë£Œ (ê¸°íƒ€ ì–¸ì–´)
            const langKey = \`other_\${current.otherLang}\`;
            completeLanguageSelection(questionId, langKey, levelValue, current.btnEl);
            
            // íŒ¨ë„ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
            if (panel) panel.classList.add('hidden');
            const select = document.getElementById(\`lang-other-select-\${questionId}\`);
            const input = document.getElementById(\`lang-other-input-\${questionId}\`);
            if (select) select.value = '';
            if (input) { input.value = ''; input.classList.add('hidden'); }
        }
        window.selectOtherLanguageLevel = selectOtherLanguageLevel;
        
        // ì–¸ì–´ ì„ íƒ ì™„ë£Œ ì²˜ë¦¬
        function completeLanguageSelection(questionId, langValue, levelValue, btnEl) {
            // ì €ì¥ êµ¬ì¡° ì´ˆê¸°í™”
            if (!window.selectedLanguages[questionId]) {
                window.selectedLanguages[questionId] = {};
            }
            
            // ì–¸ì–´+ìˆ˜ì¤€ ì €ì¥
            window.selectedLanguages[questionId][langValue] = levelValue;
            
            // ì¹© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            btnEl.querySelector('.chip-check')?.classList.remove('hidden');
            btnEl.querySelector('.chip-check')?.classList.add('flex');
            
            // í‘œì‹œ ì—…ë°ì´íŠ¸
            updateLanguageDisplay(questionId);
            
            // í˜„ì¬ ì„ íƒ ì •ë³´ ì´ˆê¸°í™”
            delete window.currentLangSelection[questionId];
        }
        
        // ì„ íƒëœ ì–¸ì–´ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateLanguageDisplay(questionId) {
            const displayContainer = document.getElementById(\`lang-selected-\${questionId}\`);
            if (!displayContainer) return;
            
            const langs = window.selectedLanguages[questionId] || {};
            const levelLabels = { basic: 'ì¼ìƒíšŒí™”', business: 'ì—…ë¬´ê°€ëŠ¥', native: 'ì›ì–´ë¯¼ê¸‰' };
            const langLabels = {
                english: 'ì˜ì–´', chinese: 'ì¤‘êµ­ì–´', japanese: 'ì¼ë³¸ì–´',
                spanish: 'ìŠ¤í˜ì¸ì–´', german: 'ë…ì¼ì–´', french: 'í”„ë‘ìŠ¤ì–´',
                vietnamese: 'ë² íŠ¸ë‚¨ì–´', thai: 'íƒœêµ­ì–´', indonesian: 'ì¸ë„ë„¤ì‹œì•„ì–´',
                russian: 'ëŸ¬ì‹œì•„ì–´', portuguese: 'í¬ë¥´íˆ¬ê°ˆì–´', arabic: 'ì•„ëì–´',
                hindi: 'íŒë””ì–´', italian: 'ì´íƒˆë¦¬ì•„ì–´', dutch: 'ë„¤ëœë€ë“œì–´'
            };
            
            displayContainer.innerHTML = Object.entries(langs).map(([lang, level]) => {
                const isOther = lang.startsWith('other_');
                const langName = isOther 
                    ? (langLabels[lang.replace('other_', '')] || lang.replace('other_', ''))
                    : (langLabels[lang] || lang);
                const levelName = levelLabels[level] || level;
                
                return \`
                    <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm"
                          style="background-color: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #34d399;">
                        \${langName} (\${levelName})
                        <button type="button" onclick="removeSelectedLanguage('\${questionId}', '\${lang}')" 
                                class="hover:text-red-400 transition-colors">&times;</button>
                    </span>
                \`;
            }).join('');
            
            // universalAnswers ì—…ë°ì´íŠ¸
            const values = Object.entries(langs).map(([lang, level]) => \`\${lang}_\${level}\`);
            if (values.length > 0) {
                universalAnswers[questionId] = values;
            } else {
                delete universalAnswers[questionId];
            }
        }
        
        // ì„ íƒëœ ì–¸ì–´ ì œê±°
        function removeSelectedLanguage(questionId, langValue) {
            if (window.selectedLanguages[questionId]) {
                delete window.selectedLanguages[questionId][langValue];
            }
            
            // ì¹© ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const btn = container?.querySelector(\`[data-value="\${langValue}"]\`);
            if (btn) {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.style.color = 'rgb(148,163,184)';
                btn.querySelector('.chip-check')?.classList.add('hidden');
                btn.querySelector('.chip-check')?.classList.remove('flex');
            }
            
            // other ë²„íŠ¼ì˜ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
            if (langValue.startsWith('other_')) {
                const otherBtn = container?.querySelector('[data-value="other"]');
                if (otherBtn) {
                    // ë‹¤ë¥¸ other ì–¸ì–´ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                    const hasOtherLangs = Object.keys(window.selectedLanguages[questionId] || {}).some(k => k.startsWith('other_'));
                    if (!hasOtherLangs) {
                        otherBtn.classList.remove('selected');
                        otherBtn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                        otherBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        otherBtn.style.color = 'rgb(148,163,184)';
                        otherBtn.querySelector('.chip-check')?.classList.add('hidden');
                        otherBtn.querySelector('.chip-check')?.classList.remove('flex');
                    }
                }
            }
            
            updateLanguageDisplay(questionId);
        }
        window.removeSelectedLanguage = removeSelectedLanguage;
        
        // ============================================
        
        // ë¼ë””ì˜¤ ì˜µì…˜ ì„ íƒ (ë‹¨ì¼ ì„ íƒ)
        function selectRadioOption(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const isSelected = btnEl.classList.contains('selected');
            
            // ëª¨ë“  ì˜µì…˜ ì„ íƒ í•´ì œ
            container.querySelectorAll('.radio-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = btn.classList.contains('radio-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                btn.style.borderColor = btn.classList.contains('radio-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
                btn.classList.remove('disabled-by-unknown');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
            
            if (!isSelected) {
                // ìƒˆ ì„ íƒ
                btnEl.classList.add('selected');
                
                if (isUnknown) {
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#64748b';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    
                    // ë‹¤ë¥¸ ì˜µì…˜ë“¤ ë¹„í™œì„±í™” í‘œì‹œ
                    container.querySelectorAll('.radio-option:not(.radio-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                } else {
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                }
            }
        }
        
        // ============================================
        // Universal ë‹µë³€ ìˆ˜ì§‘
        // ============================================
        function collectUniversalAnswers() {
            universalAnswers = {};
            UNIVERSAL_QUESTIONS.forEach(q => {
                if (q.ui_type === 'language_chips') {
                    // ì–¸ì–´ ì„ íƒ UI: window.selectedLanguagesì—ì„œ ê°€ì ¸ì˜´
                    const langs = window.selectedLanguages?.[q.id] || {};
                    const values = Object.entries(langs).map(([lang, level]) => \`\${lang}_\${level}\`);
                    if (values.length > 0) universalAnswers[q.id] = values;
                } else if (q.ui_type === 'chips' || q.ui_type === 'checkbox') {
                    const container = document.querySelector(\`[data-question-id="\${q.id}"]\`);
                    if (container) {
                        const selected = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)');
                        const values = Array.from(selected).map(btn => btn.dataset.value);
                    if (values.length > 0) universalAnswers[q.id] = values;
                    }
                } else if (q.ui_type === 'radio') {
                    const container = document.querySelector(\`[data-question-id="\${q.id}"]\`);
                    if (container) {
                        const selected = container.querySelector('.radio-option.selected:not(.radio-unknown)');
                        if (selected) universalAnswers[q.id] = selected.dataset.value;
                    }
                } else if (q.ui_type === 'text') {
                    const textarea = document.querySelector(\`textarea[name="\${q.id}"]\`);
                    if (textarea && textarea.value.trim()) universalAnswers[q.id] = textarea.value.trim();
                }
            });
            return universalAnswers;
        }
        
        // ============================================
        // Step 2 â†’ Step 3 or Step 4
        // ============================================
        async function submitUniversalAndContinue() {
            collectUniversalAnswers();
            showLoading('ë‹µë³€ ë¶„ì„ ì¤‘...', 'ì‹¬í™” ì§ˆë¬¸ì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
            
            // API í˜¸ì¶œí•˜ì—¬ follow-up ì§ˆë¬¸ ë°›ê¸°
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(3);
                } else {
                    // Follow-up ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ë¡œ
                    currentRequestId = data.request_id;
                    displayResults(data);
                    goToStep(3); // ê²°ê³¼ (3ë‹¨ê³„ êµ¬ì¡°)
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        async function submitUniversalAndAnalyze() {
            collectUniversalAnswers();
            const btn = document.getElementById('analyze-btn-quick');
            if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë¶„ì„ ì¤‘...';
            }
            showLoading('AIê°€ ë¶„ì„ ì¤‘...', 'ë§ì¶¤ ì¶”ì²œì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
            
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'API ì˜¤ë¥˜');
                
                currentRequestId = data.request_id;
                displayResults(data);
                goToStep(3); // ê²°ê³¼ (3ë‹¨ê³„ êµ¬ì¡°)
            } catch (error) {
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
                if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>ë°”ë¡œ ê²°ê³¼ ë³´ê¸°';
                }
            }
        }
        
        // ============================================
        // Step 2: Follow-up Questions ë Œë”ë§ (ê³ ê¸‰ UI) - 3ë‹¨ê³„ êµ¬ì¡°
        // ============================================
        function renderFollowupQuestions(questions) {
            const container = document.getElementById('followup-questions-form');
            container.innerHTML = questions.slice(0, 5).map((q, idx) => \`
                <div class="followup-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="followup_\${q.id}">
                    <div class="flex items-start gap-4 mb-4">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white;">\${idx + 1}</span>
                        <h4 class="font-semibold text-white text-lg leading-relaxed">\${q.question}</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 ml-12">
                        \${(q.options || []).map(opt => \`
                            <button type="button" onclick="selectFollowupOption('followup_\${q.id}', '\${opt.value}', '\${q.fact_key}', this)"
                                    class="followup-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                    style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                    data-value="\${opt.value}" data-fact-key="\${q.fact_key}">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full hidden radio-dot" style="background: linear-gradient(135deg, #a855f7, #6366f1);"></div>
                                    </div>
                                    <span style="color: rgb(148,163,184)">\${opt.label}</span>
                                </div>
                            </button>
                        \`).join('')}
                    </div>
                </div>
            \`).join('');
        }
        
        function selectFollowupOption(questionId, value, factKey, btnEl) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const isSelected = btnEl.classList.contains('selected');
            
            // ê°™ì€ ì§ˆë¬¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì„ íƒ í•´ì œ
            container.querySelectorAll('.followup-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                btnEl.classList.add('selected');
                btnEl.style.backgroundColor = 'rgba(168,85,247,0.2)';
                btnEl.style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-circle').style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            }
        }
        
        async function submitFollowupsAndAnalyze() {
            const btn = document.getElementById('analyze-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë¶„ì„ ì¤‘...';
            showLoading('AIê°€ ë¶„ì„ ì¤‘...', 'ë§ì¶¤ ì¶”ì²œì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
            
            // Followup ë‹µë³€ ìˆ˜ì§‘ ë° ì œì¶œ (ìƒˆ UI ë°©ì‹)
            try {
                const selectedOptions = document.querySelectorAll('#followup-questions-form .followup-option.selected');
                for (const btn of selectedOptions) {
                    const factKey = btn.dataset.factKey;
                    const answer = btn.dataset.value;
                    const container = btn.closest('[data-question-id]');
                    const questionId = container.dataset.questionId.replace('followup_', '');
                    
                    await fetch('/api/ai-analyzer/followup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            question_id: questionId,
                            fact_key: factKey,
                            answer: answer,
                        })
                    });
                }
                
                // ì¬ë¶„ì„
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API ì˜¤ë¥˜');
                
                currentRequestId = data.request_id;
                displayResults(data);
                goToStep(3); // ê²°ê³¼ (3ë‹¨ê³„ êµ¬ì¡°)
            } catch (error) {
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>AI ì¶”ì²œ ì‹œì‘í•˜ê¸°';
            }
        }
        
        // ============================================
        // Step 4: ê²°ê³¼ í‘œì‹œ (V3: í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ ì§€ì›)
        // ============================================
        function displayResults(data) {
            // ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            if (!data || !data.result) {
                showErrorToast('ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (data?.error || 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'));
                return;
            }
            
            const result = data.result;

            // mini_module_result ë³µì› (DBì—ì„œ ë¡œë“œ ì‹œ windowì— ì—†ì„ ìˆ˜ ìˆìŒ)
            if (result.mini_module_result && !window.miniModuleResult) {
                window.miniModuleResult = result.mini_module_result;
            }

            // V3: í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ê°€ ìˆìœ¼ë©´ ìƒˆ UIë¡œ í‘œì‹œ
            if (result.premium_report || (result.engine_version && result.engine_version.startsWith('v3'))) {
                displayPremiumReportV3(result);
                return;
            }
            
            // V2 ê¸°ì¡´ ë¡œì§
            const top3 = result.fit_top3 || [];
            
            // User Insight í‘œì‹œ
            displayUserInsight(result.user_insight);
            
            // Confidence UI í‘œì‹œ
            displayConfidenceUI(result);
            
            // TOP3 í‘œì‹œ (ì¸ë„¤ì¼ + ë§í¬ í¬í•¨, ì ìˆ˜ëŠ” í† ê¸€)
            const top3Html = top3.map((job, idx) => \`
                <div class="bg-wiki-bg p-4 rounded-xl border border-wiki-border group">
                    <a href="/job/\${job.slug || job.job_id}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        \${job.image_url ? \`
                            <div class="mb-3 overflow-hidden rounded-lg">
                                <img src="\${job.image_url}" alt="\${job.job_name}" class="w-full h-32 object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">\${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                            <span class="text-lg font-bold group-hover:text-wiki-primary transition">\${job.job_name}</span>
                        </div>
                        <div class="text-xs text-wiki-primary opacity-0 group-hover:opacity-100 transition">ìì„¸íˆ ë³´ê¸° â†’</div>
                    </a>
                    <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>ìƒì„¸ ì ìˆ˜ ë³´ê¸°</span>
                        <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                    </button>
                    <div class="score-details hidden mt-2 pt-2 border-t border-wiki-border/30">
                        <div class="p-3 rounded-lg" style="background-color: rgba(26,26,46,0.5);">
                            \${getScoreExplanation(job.like_score, job.can_score, job.fit_score, job.risk_penalty || 0, job.feasibility_score || 0)}
                        </div>
                    </div>
                </div>
            \`).join('');
            document.getElementById('top3-results').innerHTML = top3Html || '<p class="text-wiki-muted col-span-3 text-center">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            // ë””ë²„ê·¸ íŒ¨ë„ (debug=true)
            if (DEBUG_MODE) {
                updateDebugPanel(result, data);
            }
            
            // ì¶”ê°€ Follow-up ì§ˆë¬¸ (ìˆìœ¼ë©´)
            if (result.followup_questions?.length > 0) {
                displayResultFollowup(result.followup_questions[0]);
            }
            
            previousTop3 = top3.map(j => j.job_name);
        }
        
        // ============================================
        // V3: í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ UI
        // ============================================
        
        // ì˜ì–´ ìš©ì–´ â†’ í•œêµ­ì–´ ë³€í™˜ ë§µ
        const STAGE_LABELS = {
            job_explore: 'íƒìƒ‰ ë‹¨ê³„',
            job_student: 'í•™ìƒ ë‹¨ê³„',
            job_prepare: 'ì·¨ì—… ì¤€ë¹„',
            job_early: 'ì´ˆê¸° ì»¤ë¦¬ì–´ (0~3ë…„)',
            job_mid: 'ê²½ë ¥ì (3ë…„+)',
            job_transition: 'ì „í™˜/ë³µê·€',
            job_second: 'ì„¸ì»¨ë“œ ì»¤ë¦¬ì–´',
        };
        
        const VALUE_LABELS = {
            recognition: 'ì¸ì •ë°›ê³  ì˜í–¥ë ¥ ë°œíœ˜',
            stability: 'ì•ˆì •ì„±',
            income: 'ë†’ì€ ìˆ˜ì…',
            growth: 'ì„±ì¥',
            autonomy: 'ììœ¨ì„±',
            meaning: 'ì˜ë¯¸/ì‚¬íšŒ ê¸°ì—¬',
            wlb: 'ì›Œë¼ë°¸',
            balance: 'ì¼ê³¼ ì‚¶ì˜ ê· í˜•',
            expertise: 'ì „ë¬¸ì„±',
            creativity: 'ì°½ì˜ì„±',
        };

        // ì›Œí¬ìŠ¤íƒ€ì¼ ë³€í™˜ ë§µ (ë°±ì—”ë“œ TOKEN_TO_KOREANê³¼ ë™ê¸°í™”)
        const WORKSTYLE_LABELS = {
            solo: 'í˜¼ì ì§‘ì¤‘',
            solo_deep: 'í˜¼ì ê¹Šì´ ì§‘ì¤‘',
            team: 'íŒ€ í˜‘ì—…',
            team_harmony: 'íŒ€ ì¡°í™”',
            mixed: 'ìƒí™©ì— ë”°ë¼',
            structured: 'ì²´ê³„ì  í™˜ê²½',
            flexible: 'ììœ ë¡œìš´ í™˜ê²½',
        };

        // ê´€ì‹¬ ì˜ì—­ ë³€í™˜ ë§µ
        const INTEREST_LABELS = {
            problem_solving: 'ë¬¸ì œ í•´ê²°',
            data_numbers: 'ë°ì´í„°/ìˆ«ì',
            tech: 'ê¸°ìˆ /IT',
            creative: 'ì°½ì‘/ì˜ˆìˆ ',
            people: 'ì‚¬ëŒ/ì†Œí†µ',
            helping: 'ëŒë´„/ë´‰ì‚¬',
            business: 'ë¹„ì¦ˆë‹ˆìŠ¤/ê²½ì˜',
            nature: 'ìì—°/í™˜ê²½',
            physical: 'ì‹ ì²´ í™œë™',
            research: 'ì—°êµ¬/íƒêµ¬',
            teaching: 'êµìœ¡/ê°€ë¥´ì¹¨',
            analysis: 'ë¶„ì„',
            design: 'ë””ìì¸',
            writing: 'ê¸€ì“°ê¸°',
            hands_on: 'ì†ìœ¼ë¡œ ë§Œë“¤ê¸°',
        };

        // ê°•ì  ë³€í™˜ ë§µ (ë°±ì—”ë“œ TOKEN_TO_KOREANê³¼ ë™ê¸°í™”)
        const STRENGTH_LABELS = {
            // ë°±ì—”ë“œ ê¸°ë³¸ í† í°
            analytical: 'ë¶„ì„ë ¥',
            creative: 'ì°½ì˜ë ¥',  // ë°±ì—”ë“œëŠ” creative (creativity ì•„ë‹˜)
            communication: 'ì†Œí†µë ¥',
            structured_execution: 'ì‹¤í–‰ë ¥',  // â˜… ëˆ„ë½ëë˜ í† í°!
            persistence: 'ëˆê¸°',  // ë°±ì—”ë“œëŠ” persistence (perseverance ì•„ë‹˜)
            fast_learning: 'í•™ìŠµë ¥',
            // ì¶”ê°€ í† í°
            leadership: 'ë¦¬ë”ì‹­',
            detail_oriented: 'ê¼¼ê¼¼í•¨',
            patience: 'ì¸ë‚´ì‹¬',
            empathy: 'ê³µê° ëŠ¥ë ¥',
            organization: 'ì²´ê³„ì  ì •ë¦¬',
            adaptability: 'ì ì‘ë ¥',
            perseverance: 'ëˆê¸°',  // í˜¸í™˜ìš© ìœ ì§€
            creativity: 'ì°½ì˜ì„±',  // í˜¸í™˜ìš© ìœ ì§€
            strategic: 'ì „ëµì  ì‚¬ê³ ',
            teamwork: 'íŒ€ì›Œí¬',
            independence: 'ë…ë¦½ì  ì—…ë¬´',
        };

        // ì—ë„ˆì§€ ì†Œì§„ ìš”ì¸ ë³€í™˜ ë§µ (ë°±ì—”ë“œ TOKEN_TO_KOREANê³¼ ë™ê¸°í™”)
        const DRAIN_LABELS = {
            // ë°±ì—”ë“œ ê¸°ë³¸ í† í°
            people_drain: 'ëŒ€ì¸ê´€ê³„ ìŠ¤íŠ¸ë ˆìŠ¤',
            cognitive_drain: 'ì¸ì§€ í”¼ë¡œ',
            time_pressure_drain: 'ì‹œê°„ ì••ë°• ìŠ¤íŠ¸ë ˆìŠ¤',
            responsibility_drain: 'ì±…ì„ ìŠ¤íŠ¸ë ˆìŠ¤',
            repetition_drain: 'ë°˜ë³µ í”¼ë¡œ',
            unpredictability_drain: 'ë¶ˆí™•ì‹¤ì„± ìŠ¤íŠ¸ë ˆìŠ¤',
            routine_drain: 'ë°˜ë³µ ì—…ë¬´ í”¼ë¡œ',
            bureaucracy_drain: 'ê´€ë£Œì£¼ì˜ ìŠ¤íŠ¸ë ˆìŠ¤',
            // í˜¸í™˜ìš©
            pressure_drain: 'ë§ˆê° ì••ë°•',
            conflict_drain: 'ê°ˆë“± ìƒí™©',
            isolation_drain: 'ê³ ë¦½ëœ í™˜ê²½',
            physical_drain: 'ì‹ ì²´ì  í”¼ë¡œ',
            uncertainty_drain: 'ë¶ˆí™•ì‹¤ì„±',
        };

        // í¬ìƒ ê°€ëŠ¥ ìš”ì†Œ ë³€í™˜ ë§µ (ë°±ì—”ë“œ TOKEN_TO_KOREANê³¼ ë™ê¸°í™”)
        const SACRIFICE_LABELS = {
            // ë°±ì—”ë“œ ê¸°ë³¸ í† í°
            low_initial_income: 'ë‚®ì€ ì´ˆë´‰ ê°ìˆ˜',
            willing_to_study: 'ì¬í•™ìŠµ ê°ìˆ˜',
            field_change_ok: 'ë¶„ì•¼ ì „í™˜ ê°ìˆ˜',
            ignore_social_pressure: 'ì£¼ë³€ ì‹œì„  ê°ìˆ˜',
            no_sacrifice: 'í¬ê¸° ë¶ˆê°€',
            unstable_hours: 'ë¶ˆê·œì¹™í•œ ì‹œê°„ ê°ìˆ˜',
            long_hours_ok: 'ê¸´ ê·¼ë¬´ì‹œê°„ ê°ìˆ˜',
            // í˜¸í™˜ìš©
            long_hours: 'ê¸´ ê·¼ë¬´ì‹œê°„',
            relocation: 'ê±°ì£¼ì§€ ì´ë™',
            unstable_early: 'ì´ˆê¸° ë¶ˆì•ˆì • ê°ìˆ˜',
        };

        // ì œì•½ì¡°ê±´ ë³€í™˜ ë§µ (ë¯¸ë‹ˆëª¨ë“ˆ ë° ë°±ì—”ë“œ constraint í† í°)
        const CONSTRAINT_LABELS = {
            // ë¯¸ë‹ˆëª¨ë“ˆ ê¸°ë³¸ ì œì•½ í† í°
            time_constraint: 'ì‹œê°„ ì œì•½',
            income_constraint: 'ìˆ˜ì… ì¡°ê±´',
            location_constraint: 'ìœ„ì¹˜ ì œì•½',
            physical_constraint: 'ì²´ë ¥ ì œì•½',
            qualification_constraint: 'ìê²© ì œì•½',
            uncertainty_constraint: 'ë¶ˆí™•ì‹¤ì„± íšŒí”¼',
            health_constraint: 'ê±´ê°• ì œì•½',
            // ë°±ì—”ë“œ confirmed_constraint í† í°
            work_hours_strict: 'ë¶ˆê·œì¹™í•œ ê·¼ë¬´ì‹œê°„',
            no_travel: 'ì¶œì¥ ë¶ˆê°€',
            no_overtime: 'ì•¼ê·¼ ë¶ˆê°€',
            remote_only: 'ì¬íƒë§Œ ê°€ëŠ¥',
            remote_preferred: 'ì¬íƒ ì„ í˜¸',
            prefer_remote: 'ì¬íƒ ì„ í˜¸',
            shift_work_no: 'êµëŒ€ê·¼ë¬´ ë¶ˆê°€',
            degree_impossible: 'í•™ìœ„ ì·¨ë“ ì–´ë ¤ì›€',
            license_impossible: 'ìê²© ì·¨ë“ ì–´ë ¤ì›€',
            travel_impossible: 'ì¶œì¥ ë¶ˆê°€',
            prefer_low_overtime: 'ì•¼ê·¼ ìµœì†Œí™”',
            // ê¸°íƒ€ ì œì•½
            no_shift: 'êµëŒ€ê·¼ë¬´ ë¶ˆê°€',
            no_weekend: 'ì£¼ë§ ê·¼ë¬´ ë¶ˆê°€',
            no_physical: 'ìœ¡ì²´ë…¸ë™ ë¶ˆê°€',
            no_outdoor: 'ì•¼ì™¸ê·¼ë¬´ ë¶ˆê°€',
            no_repetitive: 'ë°˜ë³µ ì—…ë¬´ íšŒí”¼',
            no_social_stress: 'ëŒ€ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ íšŒí”¼',
            no_relocation: 'ì´ì‚¬/ì¶œì¥ ë¶ˆê°€',
        };

        // ì˜ì–´ ìš©ì–´ë¥¼ í•œêµ­ì–´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        // í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì— ì•ˆì „í•˜ê²Œ ì‚½ì…í•˜ê¸° ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeTemplateString(str) {
            if (!str) return str;
            // $ì™€ ë°±í‹±ì„ HTML ì—”í‹°í‹°ë¡œ ì¹˜í™˜í•˜ì—¬ í…œí”Œë¦¿ ë¦¬í„°ëŸ´ íŒŒì‹± ì—ëŸ¬ ë°©ì§€
            const backtick = String.fromCharCode(96);
            return String(str).replace(/\\$/g, '&#36;').replace(new RegExp(backtick, 'g'), '&#96;');
        }

        function translateToKorean(text) {
            if (!text) return text;
            let result = String(text);

            // ëª¨ë“  ë ˆì´ë¸” ë§µ í•©ì¹˜ê¸°
            const ALL_LABELS = {
                ...STAGE_LABELS,
                ...VALUE_LABELS,
                ...WORKSTYLE_LABELS,
                ...INTEREST_LABELS,
                ...STRENGTH_LABELS,
                ...DRAIN_LABELS,
                ...SACRIFICE_LABELS,
                ...CONSTRAINT_LABELS,
            };

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ë¨¼ì € ì²˜ë¦¬
            if (ALL_LABELS[result]) {
                return ALL_LABELS[result];
            }

            // ë¶€ë¶„ ë¬¸ìì—´ ì¹˜í™˜ (ì–¸ë”ìŠ¤ì½”ì–´ í¬í•¨ í‚¤ë¥¼ ë¨¼ì € ì²˜ë¦¬)
            const sortedEntries = Object.entries(ALL_LABELS)
                .sort((a, b) => b[0].length - a[0].length);

            for (const [eng, kor] of sortedEntries) {
                result = result.replace(new RegExp(eng.replace(/_/g, '[_\\\\s]?'), 'gi'), kor);
            }

            // í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ì•ˆì „ì„±ì„ ìœ„í•´ ì´ìŠ¤ì¼€ì´í”„
            return escapeTemplateString(result);
        }
        
        function displayPremiumReportV3(result) {
            // ê²°ê³¼ ë‹¨ê³„: step indicatorì™€ í˜ì´ì§€ íƒ€ì´í‹€ ìˆ¨ê¹€ (ê¹”ë”í•œ ë¦¬í¬íŠ¸ ë·°)
            const stepIndicator = document.getElementById('step-indicator');
            if (stepIndicator) stepIndicator.style.display = 'none';
            const pageTitle = document.querySelector('h1.text-3xl');
            if (pageTitle) pageTitle.style.display = 'none';
            // ê³„ì • ì•ˆë‚´ ë°°ë„ˆë„ ìˆ¨ê¹€
            const accountBanner = document.getElementById('account-warning-banner');
            if (accountBanner) accountBanner.style.display = 'none';

            const report = result.premium_report || {};
            
            // PremiumReport íƒ€ì… ë°ì´í„° ë§¤í•‘ (ë°±ì—”ë“œ ì‹¤ì œ í•„ë“œì— ë§ì¶¤)
            // ë°±ì—”ë“œ ì‹¤ì œ í•„ë“œ: executiveSummary, workStyleNarrative, innerConflictAnalysis ë“±
            const summary = {
                headline: report.executiveSummary || report.summary_one_page?.headline || '',
                top_takeaways: report.lifeVersionStatement?.expanded || report.summary_one_page?.top_takeaways || [],
                recommended_next_step: report.expertGuidance?.doNow?.[0] || report.summary_one_page?.recommended_next_step || '',
            };
            
            // ì‹¬ë¦¬ ë¶„ì„ ë°ì´í„° ë§¤í•‘ (ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ + ë°±ì—”ë“œ ë¶„ì„ ê²°ê³¼ í™œìš©)
            const mm = window.miniModuleResult || {};

            // workStyleNarrative í…ìŠ¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜
            function cleanWorkStyleNarrative(text) {
                if (!text) return null;
                let cleaned = text;
                // 1. ê´„í˜¸ ì•ˆì˜ Top2/ì„ í˜¸/ê°•ì  ì •ë³´ ì œê±° (í¥ë¯¸ Top2: ...), (ê°€ì¹˜ Top2: ...), (í™˜ê²½ ì„ í˜¸: ...), (ê°•ì  Top2: ...) ë“±
                cleaned = cleaned.replace(/\\([^)]*(?:Top2|ì„ í˜¸|ê°•ì )[^)]*\\)/g, '');
                // 2. ë‘ ë²ˆì§¸ ì´í›„ì˜ "ë‹¹ì‹ ì€" ì œê±° (ì²« ë²ˆì§¸ë§Œ ìœ ì§€)
                const parts = cleaned.split('ë‹¹ì‹ ì€');
                if (parts.length > 2) {
                    // ì²« ë²ˆì§¸ "ë‹¹ì‹ ì€"ë§Œ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì—°ê²°
                    cleaned = parts[0] + 'ë‹¹ì‹ ì€' + parts.slice(1).join('');
                }
                // 3. ì—°ì†ëœ ê³µë°± ì •ë¦¬
                cleaned = cleaned.replace(/\\s+/g, ' ').trim();
                return cleaned;
            }

            const personal = {
                personality_summary: cleanWorkStyleNarrative(report.workStyleNarrative) ||
                    (report.lifeVersionStatement?.oneLiner) ||
                    (mm.interest_top?.length ? generatePersonalitySummary(mm) : null),
                work_style_insights: [
                    report.workStyleMap?.socialStyle ? \`\${translateToKorean(report.workStyleMap.socialStyle)} ì—…ë¬´ ìŠ¤íƒ€ì¼ì„ ì„ í˜¸í•©ë‹ˆë‹¤\` : null,
                    report.workStyleMap?.decisionStyle ? \`ì˜ì‚¬ê²°ì • ì‹œ \${translateToKorean(report.workStyleMap.decisionStyle)} ì ‘ê·¼ì„ ì·¨í•©ë‹ˆë‹¤\` : null,
                    report.growthCurveDescription || null,
                    ...(report.personal_analysis?.work_style_insights || []),
                ].filter(Boolean),
                value_priorities: mm.value_top?.map(v => translateToKorean(v)) || 
                    report.personal_analysis?.value_priorities || [],
                potential_challenges: [
                    ...(report.stressTriggers || []),
                    ...(report.conflictPatterns || []),
                    ...(report.personal_analysis?.potential_challenges || []),
                ].slice(0, 3),
                blind_spots_to_check: report.failurePattern ? [report.failurePattern] : 
                    (report.personal_analysis?.blind_spots_to_check || []),
            };
            
            const hypotheses = report.key_hypotheses || {};
            const topRecs = report.recommendations_top || {};
            const holdRecs = report.recommendations_hold || {};
            const planB = report.plan_b_paths || {};
            const nextQ = report.next_questions || {};

            // ============================================
            // V3 ì‹¬ë¦¬ ë¶„ì„ ì¶”ê°€ ë°ì´í„° ë§¤í•‘
            // ============================================

            // ë‚´ë©´ ê°ˆë“± ë¶„ì„
            const innerConflict = {
                analysis: report.innerConflictAnalysis || '',
                patterns: report.conflictPatterns || [],
            };

            // ì„±ì¥ ê³¡ì„ 
            const growthCurve = {
                type: report.growthCurveType || '',
                description: report.growthCurveDescription || '',
            };

            // ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„
            const stressProfile = {
                profile: report.stressProfile || '',
                triggers: report.stressTriggers || [],
                failurePattern: report.failurePattern || '',
            };

            // í”„ë¡œí•„ í•´ì„ (LLM ìƒì„±)
            const profileInterpretation = report.profileInterpretation || null;

            // ì „í™˜ íƒ€ì´ë° (30/60/90ì¼ ê³„íš)
            const transitionTiming = report.transitionTiming || {
                day30: { goal: '', actions: [], milestone: '' },
                day60: { goal: '', actions: [], milestone: '' },
                day90: { goal: '', actions: [], milestone: '' },
            };

            // ì¸ìƒ ë²„ì „ ì„ ì–¸ë¬¸
            const lifeVersion = {
                oneLiner: report.lifeVersionStatement?.oneLiner || '',
                expanded: report.lifeVersionStatement?.expanded || [],
            };

            // ì „ë¬¸ê°€ ê°€ì´ë˜ìŠ¤
            const expertGuidance = report.expertGuidance || {
                doNow: [],
                stopDoing: [],
                learnNext: [],
                avoidPaths: [],
            };

            // ì‘ì—… ìŠ¤íƒ€ì¼ ë§µ (5ì¶•)
            const workStyleMap = report.workStyleMap || {
                analytical_vs_creative: 0,
                solo_vs_team: 0,
                structured_vs_flexible: 0,
                depth_vs_breadth: 0,
                guided_vs_autonomous: 0,
            };

            // ë©”íƒ€ì¸ì§€ ë¶„ì„ ê²°ê³¼
            const metaCognition = report.metaCognition || null;

            // í•œêµ­ì–´ ë°›ì¹¨ íŒë³„ (ì¡°ì‚¬ ì„ íƒìš©)
            function hasBatchim(word) {
                if (!word || word.length === 0) return false;
                const last = word.charCodeAt(word.length - 1);
                if (last >= 0xAC00 && last <= 0xD7A3) return (last - 0xAC00) % 28 !== 0;
                if (last >= 0x30 && last <= 0x39) return [0, 1, 3, 6, 7, 8].includes(last - 0x30);
                return false;
            }

            // ì„±ê²© ìš”ì•½ ìƒì„± í—¬í¼ (ë¯¸ë‹ˆëª¨ë“ˆ ê¸°ë°˜)
            function generatePersonalitySummary(mm) {
                const parts = [];
                if (mm.interest_top?.length) {
                    const items = mm.interest_top.map(t => translateToKorean(t));
                    const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? 'ê³¼ ' : 'ì™€ ') + items[items.length - 1] : items[0];
                    parts.push(\`\${joined}ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ìˆìœ¼ë©°\`);
                }
                if (mm.value_top?.length) {
                    const items = mm.value_top.map(t => translateToKorean(t));
                    const lastItem = items[items.length - 1];
                    const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? 'ê³¼ ' : 'ì™€ ') + lastItem : lastItem;
                    const particle = hasBatchim(lastItem) ? 'ì„' : 'ë¥¼';
                    parts.push(\`\${joined}\${particle} ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ”\`);
                }
                if (mm.strength_top?.length) {
                    const items = mm.strength_top.map(t => translateToKorean(t));
                    parts.push(\`\${items.join(', ')}ì—ì„œ ê°•ì ì„ ë³´ì´ëŠ”\`);
                }
                if (parts.length === 0) return null;
                return parts.join(' ') + ' ë¶„ì…ë‹ˆë‹¤.';
            }
            
            // ì§ì—… ì¶”ì²œ ë°ì´í„° - result.fit_top3 ìš°ì„  ì‚¬ìš© (ì§ì—… ì´ë¦„, ì¸ë„¤ì¼ í¬í•¨)
            const fitTop3 = result.fit_top3 || [];
            const jobRecs = report.jobRecommendations || {};
            
            // overallTop5: fit_top3 ìš°ì„ , ë¶€ì¡±í•˜ë©´ jobRecommendationsì—ì„œ ë³´ì¶©
            const overallTop5 = fitTop3.length > 0 ? fitTop3.slice(0, 5) : (jobRecs.overallTop5 || topRecs.recommendations || []);
            
            // fitTop10: can_top10 ë˜ëŠ” fit_top3 í™•ì¥ (ë°˜ë“œì‹œ 10ê°œë¡œ ì œí•œ)
            const fitTop10 = (result.can_top10 || fitTop3 || []).slice(0, 10);
            
            // likeTop10: like_top10 ë˜ëŠ” desireTop10 (ë°˜ë“œì‹œ 10ê°œë¡œ ì œí•œ)
            const likeTop10 = (result.like_top10 || jobRecs.desireTop10 || []).slice(0, 10);
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” (3ë‹¨ê³„ êµ¬ì¡°: step3 = ê²°ê³¼)
            const container = document.getElementById('step3');
            if (!container) return;

            // ì»¤ë¦¬ì–´ ë¹„ì „ ì„¹ì…˜ HTML ì‚¬ì „ ê³„ì‚° (ì¤‘ì²© í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ë¬¸ì œ ë°©ì§€)
            let careerVisionHtml = '';
            if (lifeVersion.oneLiner) {
                let profileDesc = '';
                if (profileInterpretation) {
                    const pi = profileInterpretation;
                    const parts = [];
                    if (pi.interests?.length > 0) {
                        parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>ì— ê´€ì‹¬ì´ ìˆê³ ');
                    }
                    if (pi.strengths?.length > 0) {
                        parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>ì´ ê°•ì ì´ë©°');
                    }
                    if (pi.values?.length > 0) {
                        parts.push('<span class="text-purple-400">' + translateToKorean(pi.values[0].label) + '</span>ì„ ì¤‘ì‹œí•˜ëŠ” ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤ ë¶„ì„ì…ë‹ˆë‹¤.');
                    }
                    if (parts.length > 0) {
                        // ë§ˆì§€ë§‰ íŒŒíŠ¸ì— ë¬¸ì¥ ì¢…ê²°ì´ ì—†ìœ¼ë©´ ì¶”ê°€
                        const joined = parts.join(', ');
                        const finalText = joined.endsWith('.') ? joined : joined + 'ì˜ í”„ë¡œí•„ì…ë‹ˆë‹¤.';
                        profileDesc = '<p class="text-[15px] text-wiki-muted mt-3 leading-relaxed">' + finalText + '</p>';
                    }
                }
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.3);"><p class="text-lg md:text-xl font-semibold leading-relaxed" style="color: rgb(251,191,36);">"' + translateToKorean(lifeVersion.oneLiner) + '"</p>' + profileDesc + '</div>';
            } else if (personal.personality_summary) {
                const highlightedText = personal.personality_summary.replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">&#39;$1&#39;</strong>');
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">ğŸ’« ' + highlightedText + '</p></div>';
            } else if (profileInterpretation) {
                const pi = profileInterpretation;
                const parts = [];
                if (pi.interests?.length > 0) {
                    parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>ì„ ì¢‹ì•„í•˜ê³ ');
                }
                if (pi.strengths?.length > 0) {
                    parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>ì— ê°•ì ì„ ê°€ì§„');
                }
                if (pi.values?.length > 0) {
                    const valLabel = translateToKorean(pi.values[0].label);
                    parts.push('<span class="text-purple-400">' + valLabel + '</span>' + (hasBatchim(valLabel) ? 'ì„' : 'ë¥¼') + ' ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ”');
                }
                const summaryText = parts.length > 0 ? 'ë‹¹ì‹ ì€ ' + parts.join(', ') + ' ì‚¬ëŒì…ë‹ˆë‹¤.' : 'ë‹¹ì‹ ì˜ ì»¤ë¦¬ì–´ í”„ë¡œí•„ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.';
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">ğŸ’« ' + summaryText + '</p></div>';
            }

            // íƒ­ UI ìƒì„±
            container.innerHTML = \`
                <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
                <div class="text-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold mb-2 flex items-center justify-center gap-2">
                        <span class="text-2xl">âœ¨</span>
                        ë‹¹ì‹ ë§Œì˜ ì»¤ë¦¬ì–´ ë¶„ì„ ë¦¬í¬íŠ¸
                    </h2>
                    <p class="text-wiki-muted text-sm">AIê°€ ë¶„ì„í•œ ë‹¹ì‹ ì˜ ì»¤ë¦¬ì–´ ë°©í–¥ì„±</p>
                    <div class="flex justify-center items-center gap-2 mt-3">
                        <button onclick="shareReport()" id="share-report-btn" class="inline-flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium transition" style="background: linear-gradient(135deg, #6366f1, #a855f7); color: white; border: none; cursor: pointer;">
                            <i class="fas fa-share-alt"></i> ê³µìœ 
                        </button>
                        \${DEBUG_MODE ? \`
                        <button onclick="copyAllReportContent()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition" style="background: rgba(67, 97, 238, 0.2); color: #64b5f6; border: 1px solid rgba(67, 97, 238, 0.3);">
                            <i class="fas fa-copy"></i> ê²°ê³¼ ì „ì²´ ë³µì‚¬
                        </button>
                        \` : ''}
                    </div>
                </div>
                
                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="flex justify-center gap-1 mb-6 flex-wrap" id="report-tabs">
                    <button onclick="showReportTab('summary')" class="report-tab active px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="summary">ìš”ì•½</button>
                    <button onclick="showReportTab('psychology')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="psychology">ë©”íƒ€ì¸ì§€</button>
                    <button onclick="showReportTab('recommendations')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="recommendations">ì¶”ì²œ ì§ì—…</button>
                    <button onclick="showReportTab('details')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="details" title="ë¶„ì„ ìƒì„¸">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                
                <!-- íƒ­ ì»¨í…ì¸ : ìš”ì•½ -->
                <div id="tab-summary" class="report-tab-content glass-card p-6 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">ğŸ“‹</span>
                            <span class="bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">ìš”ì•½</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">ë‹¹ì‹ ì˜ ì»¤ë¦¬ì–´ ë¶„ì„ í•µì‹¬ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                    </div>

                    <!-- âœ¨ ì»¤ë¦¬ì–´ ë¹„ì „ (ìš”ì•½ íƒ­ ì²« ì„¹ì…˜) -->
                    <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                        <span>âœ¨</span> ì»¤ë¦¬ì–´ ë¹„ì „
                    </h4>
                    \${careerVisionHtml}

                    <!-- ğŸ“Š ë©”íƒ€ì¸ì§€ ìš”ì•½ (ìš”ì•½ íƒ­) -->
                    \${metaCognition ? \`
                        <div class="mt-8 mb-8">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>ğŸ“Š</span> ë©”íƒ€ì¸ì§€
                                <button onclick="showReportTab('psychology')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                                    <span>ìì„¸íˆ ë³´ê¸°</span>
                                    <i class="fas fa-chevron-right text-[10px]"></i>
                                </button>
                            </h4>

                            \${(() => {
                                const metaSummarySections = [
                                    metaCognition.myArsenal?.strengths?.length > 0 ? 'strengths' : null,
                                    profileInterpretation?.values?.length > 0 ? 'values' : null,
                                    metaCognition.stressRecovery?.stressFactors?.length > 0 ? 'stress' : null,
                                ].filter(Boolean);
                                const metaSummaryCount = metaSummarySections.length;
                                const metaSummaryGridClass = metaSummaryCount <= 1 ? 'grid grid-cols-1 gap-4' : metaSummaryCount === 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 md:grid-cols-3 gap-4';
                                return '<div class="' + metaSummaryGridClass + '">';
                            })()}
                                <!-- í•µì‹¬ ê°•ì  -->
                                \${metaCognition.myArsenal?.strengths?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">ğŸ’ª</span>
                                            <h5 class="font-bold text-green-400 text-[15px]">í•µì‹¬ ê°•ì </h5>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${metaCognition.myArsenal.strengths.slice(0, 3).map(s => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">\${translateToKorean(s.trait)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}

                                <!-- í•µì‹¬ ê°€ì¹˜ -->
                                \${profileInterpretation?.values?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">â­</span>
                                            <h5 class="font-bold text-purple-400 text-[15px]">í•µì‹¬ ê°€ì¹˜</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${profileInterpretation.values.slice(0, 3).map(v => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(168,85,247,0.15); color: rgb(216,180,254);">\${translateToKorean(v.label)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}

                                <!-- ìŠ¤íŠ¸ë ˆìŠ¤ ì£¼ì˜ì  -->
                                \${metaCognition.stressRecovery?.stressFactors?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">âš ï¸</span>
                                            <h5 class="font-bold text-red-400 text-[15px]">ì£¼ì˜ì </h5>
                                            <span class="relative group cursor-help">
                                                <i class="fas fa-question-circle text-wiki-muted text-xs"></i>
                                                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 rounded-lg text-xs text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50" style="background: rgba(30,30,40,0.95); border: 1px solid rgba(255,255,255,0.1);">ì´ í•­ëª©ë“¤ì€ ì—ë„ˆì§€ê°€ ì†Œëª¨ë˜ê±°ë‚˜ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ìš”ì¸ì…ë‹ˆë‹¤.<br/>ì»¤ë¦¬ì–´ ì„ íƒ ì‹œ ì´ ìš”ì¸ë“¤ì„ ê³ ë ¤í•˜ë©´ ë²ˆì•„ì›ƒì„ ì˜ˆë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                            </span>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${metaCognition.stressRecovery.stressFactors.slice(0, 2).map(s => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">\${translateToKorean(s.factor)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}
                            </div>
                        </div>
                    \` : ''}

                    <!-- ğŸ†• ë‚˜ì˜ ì»¤ë¦¬ì–´ í”„ë¡œí•„ (í”„ë¡œí•„ í•´ì„) -->
                    \${profileInterpretation ? \`
                        <div class="mt-8 mb-8">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>ğŸ§¬</span> ë‚˜ì˜ ì»¤ë¦¬ì–´ í”„ë¡œí•„
                            </h4>

                            \${(() => {
                                const profileSections = [
                                    profileInterpretation.interests?.length > 0 ? 'interests' : null,
                                    profileInterpretation.strengths?.length > 0 ? 'strengths' : null,
                                    profileInterpretation.values?.length > 0 ? 'values' : null,
                                    profileInterpretation.constraints?.length > 0 ? 'constraints' : null
                                ].filter(Boolean);
                                const profileCount = profileSections.length;
                                const profileGridClass = profileCount <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';
                                const profileIsOdd = profileCount > 1 && profileCount % 2 === 1;
                                const profileLastSection = profileSections[profileCount - 1];
                                const interestsSpan = profileIsOdd && profileLastSection === 'interests' ? 'md:col-span-2' : '';
                                const strengthsSpan = profileIsOdd && profileLastSection === 'strengths' ? 'md:col-span-2' : '';
                                const valuesSpan = profileIsOdd && profileLastSection === 'values' ? 'md:col-span-2' : '';
                                const constraintsSpan = profileIsOdd && profileLastSection === 'constraints' ? 'md:col-span-2' : '';
                                return '<div class="' + profileGridClass + '">' +

                                (profileInterpretation.interests?.length > 0 ? '<div class="p-4 rounded-xl ' + interestsSpan + '" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ’š</span><h5 class="font-bold text-green-400 text-[15px]">ì¢‹ì•„í•˜ëŠ” ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.interests_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.interests.map(item => '<div class="pl-3 border-l-2 border-green-500/30"><div class="font-medium text-green-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì— ëŒ€í•œ ê´€ì‹¬ì´ ë†’ìŠµë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                                (profileInterpretation.strengths?.length > 0 ? '<div class="p-4 rounded-xl ' + strengthsSpan + '" style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ’ª</span><h5 class="font-bold text-blue-400 text-[15px]">ì˜í•˜ëŠ” ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.strengths_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.strengths.map(item => '<div class="pl-3 border-l-2 border-blue-500/30"><div class="font-medium text-blue-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì´(ê°€) ê°•ì ì…ë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                                (profileInterpretation.values?.length > 0 ? '<div class="p-4 rounded-xl ' + valuesSpan + '" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">â­</span><h5 class="font-bold text-purple-400 text-[15px]">ì¤‘ìš”í•œ ê°€ì¹˜</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.values_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.values.map(item => '<div class="pl-3 border-l-2 border-purple-500/30"><div class="font-medium text-purple-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì„(ë¥¼) ì¤‘ìš”í•˜ê²Œ ì—¬ê¹ë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                                (profileInterpretation.constraints?.length > 0 ? '<div class="p-4 rounded-xl ' + constraintsSpan + '" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸš«</span><h5 class="font-bold text-red-400 text-[15px]">í”¼í•˜ê³  ì‹¶ì€ ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.constraints_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.constraints.map(item => '<div class="pl-3 border-l-2 border-red-500/30"><div class="font-medium text-red-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div></div>' : '') +

                                '</div>';
                            })()}
                        </div>
                    \` : ''}

                    <!-- ì—…ë¬´ ìŠ¤íƒ€ì¼ íŒíŠ¸ (í•µì‹¬ ì¸ì‚¬ì´íŠ¸ì—ì„œ ì´ë™) -->
                    \${workStyleMap && (workStyleMap.analytical_vs_creative !== undefined || workStyleMap.solo_vs_team !== undefined) ? \`
                        <div class="mt-6 flex flex-wrap gap-2 justify-center">
                            \${[
                                workStyleMap.analytical_vs_creative < 0 ? 'ğŸ” ë¶„ì„ì  ì ‘ê·¼' : workStyleMap.analytical_vs_creative > 0 ? 'ğŸ’¡ ì°½ì˜ì  ì ‘ê·¼' : null,
                                workStyleMap.solo_vs_team < 0 ? 'ğŸ§˜ ì§‘ì¤‘ ì‘ì—… ì„ í˜¸' : workStyleMap.solo_vs_team > 0 ? 'ğŸ¤ í˜‘ì—… ì„ í˜¸' : null,
                                workStyleMap.structured_vs_flexible < 0 ? 'ğŸ“‹ ì²´ê³„ì  ìŠ¤íƒ€ì¼' : workStyleMap.structured_vs_flexible > 0 ? 'ğŸŒŠ ìœ ì—°í•œ ìŠ¤íƒ€ì¼' : null,
                                workStyleMap.guided_vs_autonomous > 0 ? 'ğŸš€ ììœ¨ ì§€í–¥' : null,
                            ].filter(Boolean).map(hint => \`
                                <span class="px-3 py-1.5 rounded-full text-[13px] font-medium" style="background: rgba(99,102,241,0.1); color: rgb(165,180,252); border: 1px solid rgba(99,102,241,0.2);">\${hint}</span>
                            \`).join('')}
                        </div>
                    \` : ''}

                    <!-- C: í”„ë¡œí•„ â†’ ì¶”ì²œ ë¸Œë¦¿ì§€ ë¬¸ì¥ -->
                    \${profileInterpretation && overallTop5.length > 0 ? \`
                        <div class="mt-4 mb-2 p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05)); border: 1px solid rgba(251,191,36,0.2);">
                            <p class="text-base md:text-lg" style="color: rgb(253,224,71);">
                                <span class="font-medium">ğŸ¯ ì´ëŸ° ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì§ì—…</span>
                            </p>
                            <p class="text-[15px] text-wiki-muted mt-2">
                                \${(() => {
                                    const parts = [];
                                    const pi = profileInterpretation;
                                    if (pi.interests?.length > 0) {
                                        parts.push('<span class="text-green-400">"' + translateToKorean(pi.interests[0].label) + '"</span>ì„ ì¢‹ì•„í•˜ê³ ');
                                    }
                                    if (pi.strengths?.length > 0) {
                                        parts.push('<span class="text-blue-400">"' + translateToKorean(pi.strengths[0].label) + '"</span>ì´ ê°•ì ì¸ ë‹¹ì‹ ');
                                    }
                                    if (pi.constraints?.length > 0) {
                                        parts.push('<span class="text-red-400">"' + translateToKorean(pi.constraints[0].label) + '"</span> ì—†ì´ ì„±ì¥í•  ìˆ˜ ìˆëŠ” ì§ì—…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
                                    } else if (parts.length > 0) {
                                        parts.push('ì—ê²Œ ë§ëŠ” ì§ì—…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
                                    }
                                    return parts.length > 0 ? parts.join(' ') : 'ë‹¹ì‹ ì˜ í”„ë¡œí•„ì„ ë°”íƒ•ìœ¼ë¡œ ì§ì—…ì„ ì¶”ì²œí•©ë‹ˆë‹¤.';
                                })()}
                            </p>
                        </div>
                    \` : ''}

                    <!-- TOP 3 ì§ì—… ì¹´ë“œ (ìš”ì•½ íƒ­) -->
                    \${overallTop5.length > 0 ? \`
                        <div class="mt-6 pt-4 border-t border-wiki-border/30">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>ğŸ†</span> ì¶”ì²œ ì§ì—… Top 3
                                <button onclick="showReportTab('recommendations')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                                    <span>ë”ë³´ê¸°</span>
                                    <i class="fas fa-chevron-right text-[10px]"></i>
                                </button>
                            </h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                \${overallTop5.slice(0, 3).map((job, idx) => {
                                    const jobName = job.job_name || job.job_id || 'ì§ì—…';
                                    const jobSlug = job.slug || encodeURIComponent(jobName);
                                    const rationale = job.rationale || job.one_line_why || '';
                                    const imageUrl = job.image_url || '';
                                    const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                                    // fallback 1: rationaleì—ì„œ ì²« ë¬¸ì¥ ì¶”ì¶œ (ìë™ ìƒì„± ì•„ë‹Œ ê²½ìš°)
                                    // fallback 2: rationale ì „ì²´ (ìë™ ìƒì„± í¬í•¨)
                                    // fallback 3: ì§ì—…ëª… ê¸°ë°˜ ê¸°ë³¸ ì„¤ëª…
                                    const displayDescription = description
                                        || (rationale && !rationale.includes('ìë™ ìƒì„±') ? rationale.split('.')[0] + '.' : '')
                                        || (rationale ? rationale.replace('ìë™ ìƒì„±ëœ ê²°ê³¼ì…ë‹ˆë‹¤. LLM ë¶„ì„ì´ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', '').trim() : '')
                                        || \`\${jobName} ì§ì—…ì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”.\`;
                                    const fitScore = job.scores?.fit || job.fit_score || '-';
                                    const likeScore = job.scores?.like || job.like_score || '-';

                                    // rationale íŒŒì‹±: ì¢‹ì•„í•  ì´ìœ , ì˜í•  ì´ìœ  ì¶”ì¶œ
                                    const extractLikeReason = (r) => {
                                        if (!r || r.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) return null;
                                        const match = r.match(/\\[ì¢‹ì•„í•  ì´ìœ \\]\\s*(.+?)(?=\\[|$)/s)
                                            || r.match(/\\[1\\]\\s*(.+?)(?=\\[2\\]|$)/s);
                                        return match ? match[1].trim() : null;
                                    };
                                    const extractCanReason = (r) => {
                                        if (!r || r.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) return null;
                                        const match = r.match(/\\[ì˜í•  ì´ìœ \\]\\s*(.+?)(?=\\[|$)/s)
                                            || r.match(/\\[2\\]\\s*(.+?)(?=\\[3\\]|\\[ë¦¬ìŠ¤í¬\\]|$)/s);
                                        return match ? match[1].trim() : null;
                                    };

                                    const likeReason = job.like_reason || extractLikeReason(rationale);
                                    const canReason = job.can_reason || extractCanReason(rationale);
                                    const hasReasons = likeReason || canReason;

                                    return \`
                                        <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="block p-4 rounded-xl transition-all hover:scale-[1.02] group"
                                           style="background: linear-gradient(135deg, rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.15), rgba(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'},0.05)); border: 1px solid rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.3);">
                                            <!-- ì¸ë„¤ì¼ (ì—†ìœ¼ë©´ placeholder) -->
                                            <div class="mb-3 overflow-hidden rounded-lg" style="aspect-ratio: 16/10;">
                                                \${imageUrl ? \`
                                                    <img src="\${imageUrl}" alt="\${jobName}"
                                                         class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="hidden w-full h-full items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                        <i class="fas fa-briefcase text-3xl text-wiki-muted"></i>
                                                    </div>
                                                \` : \`
                                                    <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                        <i class="fas fa-briefcase text-3xl text-wiki-muted"></i>
                                                    </div>
                                                \`}
                                            </div>
                                            <div class="flex items-center gap-3 mb-3">
                                                <span class="text-2xl">\${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                                                <span class="font-bold text-lg text-white flex-1 line-clamp-1">\${jobName}</span>
                                                <span class="text-base font-bold" style="color: rgb(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'});">Fit \${fitScore}</span>
                                            </div>
                                            \${displayDescription ? \`<p class="text-base text-wiki-muted line-clamp-3 mb-3">\${displayDescription}</p>\` : ''}
                                            <!-- ì˜í•  ì´ìœ  + ì¢‹ì•„í•  ì´ìœ  -->
                                            \${hasReasons ? \`
                                                <div class="space-y-1.5 mt-3 p-3 rounded-lg" style="background: rgba(0,0,0,0.2);">
                                                    \${likeReason ? \`<p class="text-[13px] leading-relaxed text-purple-300/90"><span class="text-purple-400 font-medium">ğŸ’œ Like:</span> \${likeReason}</p>\` : ''}
                                                    \${canReason ? \`<p class="text-[13px] leading-relaxed text-blue-300/90"><span class="text-blue-400 font-medium">ğŸ’ª Can:</span> \${canReason}</p>\` : ''}
                                                </div>
                                            \` : (rationale && !rationale.includes('ìë™ ìƒì„±ëœ ê²°ê³¼') ? \`
                                                <p class="text-[13px] text-emerald-400/80 mt-3">ğŸ’¡ \${rationale}</p>
                                            \` : '')}
                                        </a>
                                    \`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                </div>

                <!-- íƒ­ ì»¨í…ì¸ : ë©”íƒ€ì¸ì§€ -->
                <div id="tab-psychology" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">ğŸ“Š</span>
                            <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ë©”íƒ€ì¸ì§€</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">ìê¸° ìì‹ ì— ëŒ€í•œ ê¹Šì€ ì´í•´ì™€ ë‚´ë©´ íƒêµ¬.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
                    </div>

                    <!-- ============================================ -->
                    <!-- í•µì‹¬ ìš”ì•½ (ğŸ’« ë‹¹ì‹ ì€...) - ê°€ì¥ ë¨¼ì € í‘œì‹œ -->
                    <!-- ============================================ -->
                    \${personal.personality_summary || metaCognition?.innerExploration?.identityInsight ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                            <h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">ğŸ’« í•µì‹¬ ìš”ì•½</h4>
                            <p class="text-base md:text-lg leading-relaxed text-white mb-4">
                                \${(() => {
                                    // LLM identityInsight ìš°ì„ , ì—†ìœ¼ë©´ personality_summary fallback
                                    const rawText = metaCognition?.innerExploration?.identityInsight || personal.personality_summary || '';
                                    // í‚¤ì›Œë“œ ë³¼ë“œ + ìƒ‰ìƒ ì²˜ë¦¬
                                    let styled = rawText
                                        .replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">$1</strong>');
                                    // í”„ë¡œí•„ í‚¤ì›Œë“œì— ìƒ‰ìƒ ì ìš©
                                    if (profileInterpretation) {
                                        const pi = profileInterpretation;
                                        (pi.interests || []).forEach(i => {
                                            const label = translateToKorean(i.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-green-400">' + label + '</strong>');
                                        });
                                        (pi.strengths || []).forEach(s => {
                                            const label = translateToKorean(s.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-blue-400">' + label + '</strong>');
                                        });
                                        (pi.values || []).forEach(v => {
                                            const label = translateToKorean(v.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-purple-400">' + label + '</strong>');
                                        });
                                    }
                                    return styled;
                                })()}
                            </p>
                            \${metaCognition?.innerExploration?.innerConflicts ? \`
                                <div class="p-4 rounded-xl mb-4" style="background-color: rgba(236,72,153,0.08); border-left: 3px solid rgba(236,72,153,0.5);">
                                    <div class="text-[15px] font-medium text-pink-300 mb-2">ğŸ­ ì•Œì•„ë‘ë©´ ì¢‹ì€ ë‚´ì  ê°ˆë“±</div>
                                    <p class="text-[15px] text-wiki-muted leading-relaxed">\${translateToKorean(metaCognition.innerExploration.innerConflicts)}</p>
                                </div>
                            \` : ''}
                            \${metaCognition?.innerExploration?.valueAnalysis ? \`
                                <details class="group">
                                    <summary class="cursor-pointer text-[15px] text-violet-400 font-medium hover:text-violet-300 flex items-center gap-2">
                                        <span>ğŸ“–</span>
                                        <span class="group-open:hidden">â–¶ ì¶”ê°€ ì„¤ëª…</span>
                                        <span class="hidden group-open:inline">â–¼ ì¶”ê°€ ì„¤ëª…</span>
                                    </summary>
                                    <div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(139,92,246,0.05);">
                                        \${translateToKorean(metaCognition.innerExploration.valueAnalysis)}
                                    </div>
                                </details>
                            \` : ''}
                        </div>
                    \` : \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.2);">
                            <h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">ğŸ’« í•µì‹¬ ìš”ì•½</h4>
                            <p class="text-base md:text-lg leading-relaxed text-wiki-muted">ì‹¬ì¸µ ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì‹¬ì¸µ ì§ˆë¬¸ì— ìì„¸íˆ ë‹µë³€í•´ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    \`}

                    <!-- ============================================ -->
                    <!-- ë©”íƒ€ì¸ì§€ 5ê°œ ì„¹ì…˜ (LLM/Rule ê¸°ë°˜) - í•µì‹¬ ìš”ì•½ ì•„ë˜ì— ë°°ì¹˜ -->
                    <!-- ============================================ -->

                    \${metaCognition ? \`
                        <!-- ê°•ì  + ì„ í˜¸ë„ (2ì—´ ê·¸ë¦¬ë“œ) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- 1ï¸âƒ£ ë‚˜ì˜ ë¬´ê¸°ê³  (ê°•ì  + ì•½ì ) - í•µì‹¬ë§Œ í‘œì‹œ -->
                            <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(99,102,241,0.05)); border: 1px solid rgba(59,130,246,0.15);">
                                <h4 class="text-lg font-bold mb-4 text-blue-400 flex items-center gap-2">
                                    <span>ğŸ’ª</span> ë‚˜ì˜ ê°•ì 
                                </h4>

                            \${metaCognition.myArsenal?.strengths?.length > 0 ? \`
                                <!-- í´ë¦­ ê°€ëŠ¥í•œ ê°•ì  íƒœê·¸ -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    \${metaCognition.myArsenal.strengths.map((s, i) => {
                                        const icons = { 'ë¶„ì„ë ¥': 'ğŸ”', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ì†Œí†µë ¥': 'ğŸ’¬', 'ì²´ê³„ì  ì‹¤í–‰ë ¥': 'ğŸ“‹', 'ëˆê¸°': 'ğŸ’ª', 'ë¹ ë¥¸ í•™ìŠµ': 'âš¡', 'ë¦¬ë”ì‹­': 'ğŸ‘‘', 'ê³µê° ëŠ¥ë ¥': 'ğŸ¤', 'ê¼¼ê¼¼í•¨': 'ğŸ”¬', 'ì ì‘ë ¥': 'ğŸŒŠ' };
                                        const icon = icons[translateToKorean(s.trait)] || 'âœ¨';
                                        return \`<button onclick="document.getElementById('strength-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-4 py-2 rounded-full text-[15px] font-semibold cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">
                                            \${icon} \${translateToKorean(s.trait)}
                                        </button>\`;
                                    }).join('')}
                                </div>
                                <!-- íƒœê·¸ í´ë¦­ ì‹œ í‘œì‹œë˜ëŠ” ìƒì„¸ ì„¤ëª… -->
                                \${metaCognition.myArsenal.strengths.map((s, i) => \`
                                    <div id="strength-detail-\${i}" class="hidden mb-3 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed animate-fadeIn" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);">
                                        <span class="font-medium text-green-300">\${translateToKorean(s.trait)}:</span>
                                        <span class="ml-1">\${s.meaning}</span>
                                    </div>
                                \`).join('')}

                                <!-- ìƒë‹´ì‚¬ ë…¸íŠ¸ -->
                                \${metaCognition.myArsenal.counselorNote ? \`
                                    <div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.myArsenal.counselorNote)}</p>
                                    </div>
                                \` : ''}
                            \` : '<p class="text-[15px] text-wiki-muted">ê°•ì  ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>'}

                            \${metaCognition.myArsenal?.weaknesses?.length > 0 ? \`
                                <div class="mt-5 pt-4 border-t border-wiki-border/20">
                                    <div class="text-[15px] font-medium text-orange-400 mb-3 flex items-center gap-2">
                                        <span>âš ï¸</span> ê°œì„  ê°€ëŠ¥ ì˜ì—­
                                    </div>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        \${metaCognition.myArsenal.weaknesses.map(w => \`
                                            <span class="px-3 py-1.5 rounded-full text-[15px]" style="background-color: rgba(251,146,60,0.1); color: rgb(253,186,116);">
                                                \${translateToKorean(w.trait)}
                                            </span>
                                        \`).join('')}
                                    </div>
                                    <!-- ê°œì„  ì˜ì—­ ìƒì„¸ - ë”ë³´ê¸° -->
                                    <details class="group">
                                        <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                            <span class="group-open:hidden">â–¶ ê·¹ë³µ ë°©í–¥ ë³´ê¸°</span>
                                            <span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span>
                                        </summary>
                                        <div class="mt-3 space-y-2 pl-2 border-l-2 border-orange-500/20">
                                            \${metaCognition.myArsenal.weaknesses.map(w => \`
                                                <div class="text-[15px]">
                                                    <span class="font-medium text-orange-300">\${translateToKorean(w.trait)}:</span>
                                                    <span class="text-wiki-muted ml-1">\${w.meaning}</span>
                                                </div>
                                            \`).join('')}
                                        </div>
                                    </details>
                                </div>
                            \` : ''}
                            </div>

                            <!-- 2ï¸âƒ£ ì„ í˜¸ë„ ì§€ë„ - í•µì‹¬ë§Œ í‘œì‹œ -->
                            <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.15);">
                                <h4 class="text-lg font-bold mb-4 text-purple-400 flex items-center gap-2">
                                    <span>ğŸ¯</span> ì„ í˜¸ë„ ìš”ì•½
                                </h4>

                            <div class="space-y-4">
                                <!-- ì¢‹ì•„í•˜ëŠ” ê²ƒ -->
                                \${metaCognition.preferenceMap?.likes?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-green-400 mb-2">ğŸ’š ì¢‹ì•„í•˜ëŠ” ê²ƒ</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.likes.map((l, i) => {
                                                const icons = { 'ê¸°ìˆ /IT': 'ğŸ’»', 'ë¬¸ì œí•´ê²°': 'ğŸ§©', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ë°ì´í„°/ìˆ«ì': 'ğŸ“Š', 'ì‚¬ëŒ ë•ê¸°': 'ğŸ¤²', 'ì¡°ì§/ê´€ë¦¬': 'ğŸ“‹', 'ì˜í–¥ë ¥': 'ğŸ“¢', 'ì—°êµ¬/íƒêµ¬': 'ğŸ”¬', 'ë¦¬ë”©': 'ğŸ‘‘', 'ë¹Œë”©': 'ğŸ—ï¸' };
                                                const icon = icons[translateToKorean(l.item)] || 'ğŸ’š';
                                                return \`<button onclick="document.getElementById('like-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.12); color: rgb(134,239,172);">\${icon} \${translateToKorean(l.item)}</button>\`;
                                            }).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.likes.map((l, i) => \`
                                            <div id="like-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);">
                                                <span class="font-medium text-green-300">\${translateToKorean(l.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(l.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}

                                <!-- í”¼í•˜ê³  ì‹¶ì€ ê²ƒ -->
                                \${metaCognition.preferenceMap?.dislikes?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-red-400 mb-2">ğŸš« í”¼í•˜ê³  ì‹¶ì€ ê²ƒ</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.dislikes.map((d, i) => {
                                                const icons = { 'ë¶ˆê·œì¹™í•œ ê·¼ë¬´ì‹œê°„': 'â°', 'ì¬íƒ ì„ í˜¸': 'ğŸ ', 'ì•¼ê·¼ ì—†ìŒ': 'ğŸŒ™', 'ì¶œì¥ ì—†ìŒ': 'âœˆï¸', 'êµëŒ€ê·¼ë¬´ ì—†ìŒ': 'ğŸ”„', 'ì‹œê°„ ì œì•½': 'â³', 'ìˆ˜ì… ì œì•½': 'ğŸ’°', 'ì²´ë ¥ ì œì•½': 'ğŸ‹ï¸', 'ë¶ˆí™•ì‹¤ì„± ì œì•½': 'â“' };
                                                const icon = icons[translateToKorean(d.item)] || 'ğŸš«';
                                                return \`<button onclick="document.getElementById('dislike-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">\${icon} \${translateToKorean(d.item)}</button>\`;
                                            }).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.dislikes.map((d, i) => \`
                                            <div id="dislike-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);">
                                                <span class="font-medium text-red-300">\${translateToKorean(d.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(d.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}

                                <!-- ì˜ ë§ëŠ” ê²ƒ -->
                                \${metaCognition.preferenceMap?.fits?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-blue-400 mb-2">ğŸ’™ ì˜ ë§ëŠ” ê²ƒ</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.fits.map((f, i) => \`
                                                <button onclick="document.getElementById('fit-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(59,130,246,0.12); color: rgb(147,197,253);">ğŸ’™ \${translateToKorean(f.item)}</button>
                                            \`).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.fits.map((f, i) => \`
                                            <div id="fit-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(59,130,246,0.05); border-left: 2px solid rgba(59,130,246,0.3);">
                                                <span class="font-medium text-blue-300">\${translateToKorean(f.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(f.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}
                            </div>

                            <!-- ìƒë‹´ì‚¬ ë…¸íŠ¸ -->
                            \${metaCognition.preferenceMap?.counselorNote ? \`
                                <div class="mt-4 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                    <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div>
                                    <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.preferenceMap.counselorNote)}</p>
                                </div>
                            \` : ''}
                            </div>
                        </div>

                        <!-- ìŠ¤íŠ¸ë ˆìŠ¤ + ì„±ì¥ (2ì—´ ê·¸ë¦¬ë“œ, í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ì „ì²´ ë„ˆë¹„) -->
                        <div class="grid grid-cols-1 \${metaCognition.stressRecovery?.stressFactors?.length > 0 && metaCognition.growthPotential ? 'md:grid-cols-2' : ''} gap-6 mb-6">
                            <!-- 4ï¸âƒ£ ìŠ¤íŠ¸ë ˆìŠ¤ & íšŒë³µ - í•µì‹¬ë§Œ -->
                            \${metaCognition.stressRecovery?.stressFactors?.length > 0 ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(251,146,60,0.05)); border: 1px solid rgba(239,68,68,0.15);">
                                    <h4 class="text-lg font-bold mb-4 text-red-400 flex items-center gap-2">
                                        <span>âš¡</span> ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸
                                    </h4>

                                <!-- í´ë¦­ ê°€ëŠ¥í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸ íƒœê·¸ -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    \${metaCognition.stressRecovery.stressFactors.map((s, i) => {
                                        const icons = { 'ë°˜ë³µ ì—…ë¬´ í”¼ë¡œ': 'ğŸ”„', 'ê´€ë£Œì£¼ì˜ ìŠ¤íŠ¸ë ˆìŠ¤': 'ğŸ“‘', 'ì‚¬ëŒ ìƒëŒ€ í”¼ë¡œ': 'ğŸ‘¥', 'ì¸ì§€ ê³¼ë¶€í•˜': 'ğŸ§ ', 'ì‹œê°„ ì••ë°•': 'â°', 'ì±…ì„ê° ë¶€ë‹´': 'âš–ï¸', 'ì˜ˆì¸¡ ë¶ˆê°€': 'ğŸŒªï¸', 'ê°ˆë“± ìƒí™©': 'ğŸ’¢', 'ë©€í‹°íƒœìŠ¤í‚¹': 'ğŸ”€', 'ë¶ˆí™•ì‹¤ì„±': 'â“' };
                                        const icon = icons[translateToKorean(s.factor)] || 'âš¡';
                                        return \`<button onclick="document.getElementById('stress-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-3 py-1.5 rounded-full text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">
                                            \${icon} \${translateToKorean(s.factor)}
                                        </button>\`;
                                    }).join('')}
                                </div>
                                <!-- íƒœê·¸ í´ë¦­ ì‹œ í‘œì‹œë˜ëŠ” ìƒì„¸ ì„¤ëª… -->
                                \${metaCognition.stressRecovery.stressFactors.map((s, i) => \`
                                    <div id="stress-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);">
                                        <span class="font-medium text-red-300">\${translateToKorean(s.factor)}:</span>
                                        <span class="ml-1">\${translateToKorean(s.why)}</span>
                                    </div>
                                \`).join('')}

                                <!-- ìƒë‹´ì‚¬ ë…¸íŠ¸ -->
                                \${metaCognition.stressRecovery.counselorNote ? \`
                                    <div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.stressRecovery.counselorNote)}</p>
                                    </div>
                                \` : ''}

                                <!-- íšŒë³µ ë°©ë²• (ìˆìœ¼ë©´) -->
                                \${metaCognition.stressRecovery?.recoveryMethods?.length > 0 ? \`
                                    <div class="mt-4 pt-4 border-t border-wiki-border/20">
                                        <div class="text-[15px] font-medium text-emerald-400 mb-2 flex items-center gap-2">
                                            <span>ğŸŒ¿</span> íšŒë³µ ë°©ë²•
                                        </div>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            \${metaCognition.stressRecovery.recoveryMethods.map(r => \`
                                                <span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">
                                                    \${translateToKorean(r.factor)}
                                                </span>
                                            \`).join('')}
                                        </div>
                                        <!-- íšŒë³µ ë°©ë²• ìƒì„¸ - ë”ë³´ê¸° -->
                                        <details class="group">
                                            <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                                <span class="group-open:hidden">â–¶ ì™œ íšŒë³µë˜ëŠ”ì§€ ì´í•´í•˜ê¸°</span>
                                                <span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span>
                                            </summary>
                                            <div class="mt-3 space-y-2 text-[15px]">
                                                \${metaCognition.stressRecovery.recoveryMethods.map(r => \`
                                                    <div class="p-3 rounded-lg" style="background-color: rgba(16,185,129,0.05);">
                                                        <span class="font-medium text-emerald-300">\${translateToKorean(r.factor)}:</span>
                                                        <span class="text-wiki-muted ml-1">\${translateToKorean(r.why)}</span>
                                                    </div>
                                                \`).join('')}
                                            </div>
                                        </details>
                                    </div>
                                \` : ''}
                                </div>
                            \` : ''}

                            <!-- 5ï¸âƒ£ ì„±ì¥ ê°€ëŠ¥ì„± -->
                            \${metaCognition.growthPotential ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(52,211,153,0.05)); border: 1px solid rgba(16,185,129,0.15);">
                                    <h4 class="text-lg font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                        <span>ğŸŒ±</span> ì„±ì¥ ê°€ëŠ¥ì„±
                                    </h4>

                                <!-- í•µì‹¬: í™œìš©í•  ê°•ì  íƒœê·¸ (ì•„ì´ì½˜ ê°œë³„ ì ìš©) -->
                                \${metaCognition.growthPotential.leveragePoints?.length > 0 ? \`
                                    <div class="flex flex-wrap gap-2 mb-4">
                                        \${metaCognition.growthPotential.leveragePoints.map(p => {
                                            const icons = { 'ë¶„ì„ë ¥': 'ğŸ”', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ì†Œí†µë ¥': 'ğŸ’¬', 'ì²´ê³„ì  ì‹¤í–‰ë ¥': 'ğŸ“‹', 'ëˆê¸°': 'ğŸ’ª', 'ë¹ ë¥¸ í•™ìŠµ': 'âš¡', 'ë¦¬ë”ì‹­': 'ğŸ‘‘', 'ê³µê° ëŠ¥ë ¥': 'ğŸ¤', 'ê¼¼ê¼¼í•¨': 'ğŸ”¬', 'ì ì‘ë ¥': 'ğŸŒŠ' };
                                            const icon = icons[translateToKorean(p)] || 'âœ¨';
                                            return \`<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">
                                                \${icon} \${translateToKorean(p)}
                                            </span>\`;
                                        }).join('')}
                                    </div>
                                \` : ''}

                                <!-- ìƒë‹´ì‚¬ ë…¸íŠ¸ (í•µì‹¬ ë©”ì‹œì§€) -->
                                \${metaCognition.growthPotential.counselorNote ? \`
                                    <div class="p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-2" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.growthPotential.counselorNote)}</p>
                                    </div>
                                \` : ''}

                                <!-- ì„±ì¥ ë°©í–¥ - ë”ë³´ê¸° -->
                                \${metaCognition.growthPotential.direction ? \`
                                    <details class="group">
                                        <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                            <span class="group-open:hidden">â–¶ ì„±ì¥ ë°©í–¥ ìƒì„¸ ë³´ê¸°</span>
                                            <span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span>
                                        </summary>
                                        <div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(16,185,129,0.05);">
                                            ğŸ¯ \${translateToKorean(metaCognition.growthPotential.direction)}
                                        </div>
                                    </details>
                                \` : ''}
                                </div>
                            \` : ''}
                        </div>

                        <hr class="border-wiki-border/20 my-8" />
                    \` : ''}

                    <!-- ============================================ -->
                    <!-- ============================================ -->
                    <!-- ì¶”ê°€ ë¶„ì„ ì„¹ì…˜ë“¤ (í•µì‹¬ ìš”ì•½ ì•„ë˜ ë³´ì¶© ì •ë³´) -->
                    <!-- ============================================ -->

                    <!-- ì‘ì—… ìŠ¤íƒ€ì¼ ì¸ì‚¬ì´íŠ¸ -->
                    \${personal.work_style_insights?.length > 0 ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>ğŸ¨</span> ì‘ì—… ìŠ¤íƒ€ì¼
                            </h4>
                            <div class="grid gap-3">
                                \${personal.work_style_insights.map(ws => {
                                    // ë§ˆì¹¨í‘œ ì¼ê´€ì„± ë³´ì¥
                                    let text = translateToKorean(ws).trim();
                                    if (!text.endsWith('.') && !text.endsWith('ë‹¤.') && !text.endsWith('ìš”.') && !text.endsWith('ë‹ˆë‹¤.')) {
                                        if (text.endsWith('ë‹¤') || text.endsWith('ìš”') || text.endsWith('ë‹ˆë‹¤')) {
                                            text += '.';
                                        } else {
                                            text += '.';
                                        }
                                    }
                                    // í‚¤ì›Œë“œ ë³¼ë“œ+ìƒ‰ìƒ ì²˜ë¦¬
                                    text = text
                                        .replace(/(ì„±ì¥|ë„ì „|í•™ìŠµ|ëª°ì…|ì„±ì·¨ê°|ììœ¨|ì°½ì˜ì„±|ë¶„ì„|ë¬¸ì œ|í•´ê²°|ë…ë¦½|í˜‘ì—…|ë¦¬ë”ì‹­|ê¼¼ê¼¼|ìœ ì—°|ì•ˆì •|ì „ë¬¸ì„±|ì²´ê³„)/g, '<strong class="text-indigo-400">$1</strong>');
                                    return \`<div class="p-4 rounded-xl bg-wiki-bg/50 flex items-start gap-4" style="border: 1px solid rgba(99,102,241,0.1);">
                                        <span class="text-wiki-primary text-lg mt-0.5">âœ“</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${text}</span>
                                    </div>\`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- ê°€ì¹˜ ìš°ì„ ìˆœìœ„ (ê°€ë¡œ ë°°ì¹˜) -->
                    \${personal.value_priorities?.length > 0 ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>â­</span> ê°€ì¹˜ ìš°ì„ ìˆœìœ„
                            </h4>
                            <div class="grid grid-cols-\${Math.min(personal.value_priorities.length, 3)} gap-3">
                                \${personal.value_priorities.slice(0, 5).map((v, i) => {
                                    const colors = ['rgba(168,85,247,0.2)', 'rgba(99,102,241,0.2)', 'rgba(59,130,246,0.2)', 'rgba(6,182,212,0.2)', 'rgba(16,185,129,0.2)'];
                                    const textColors = ['rgb(216,180,254)', 'rgb(165,180,252)', 'rgb(147,197,253)', 'rgb(103,232,249)', 'rgb(110,231,183)'];
                                    let text = translateToKorean(v).trim();
                                    // ì§§ì€ ê°’ ë ˆì´ë¸”ì€ ë§ˆì¹¨í‘œ ì œê±°, ë¬¸ì¥(10ì+)ë§Œ ë§ˆì¹¨í‘œ ìœ ì§€
                                    if (text.length < 10) text = text.replace(/\\.$/, '');
                                    else if (!text.endsWith('.')) text += '.';
                                    return \`<div class="p-3 md:p-4 rounded-xl flex items-center gap-2 justify-center" style="background-color: \${colors[i % colors.length]}; border: 1px solid \${colors[i % colors.length].replace('0.2', '0.3')};">
                                        <span class="text-sm font-bold" style="color: \${textColors[i % textColors.length]};">#\${i + 1}</span>
                                        <span class="text-[15px] font-semibold text-wiki-text">\${text}</span>
                                    </div>\`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- ì ì¬ì  ë„ì „ -->
                    \${personal.potential_challenges?.length > 0 ? \`
                        <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-orange-400 flex items-center gap-2">
                                <span>âš ï¸</span> ì£¼ì˜í•  ì 
                            </h4>
                            <ul class="space-y-3">
                                \${personal.potential_challenges.map(c => \`
                                    <li class="flex items-center gap-3">
                                        <span class="text-orange-400">â€¢</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${c}</span>
                                    </li>
                                \`).join('')}
                            </ul>
                        </div>
                    \` : ''}

                    <!-- ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ -->
                    \${personal.blind_spots_to_check?.length > 0 ? \`
                        <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2">
                                <span>ğŸ”</span> ì ê²€í•  ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ
                            </h4>
                            <ul class="space-y-3">
                                \${personal.blind_spots_to_check.map(b => \`
                                    <li class="flex items-center gap-3">
                                        <span class="text-red-400">â€¢</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${b}</span>
                                    </li>
                                \`).join('')}
                            </ul>
                        </div>
                    \` : ''}
                    
                    <!-- ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ ê¸°ë°˜ ê¸°ë³¸ ë¶„ì„ (ë°ì´í„°ê°€ ì—†ì„ ë•Œ) -->
                    \${!personal.work_style_insights?.length && window.miniModuleResult ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>ğŸ“Š</span> ì„ íƒ ê¸°ë°˜ ë¶„ì„
                            </h4>
                            <p class="text-sm text-wiki-muted mb-4">ë¯¸ë‹ˆëª¨ë“ˆì—ì„œ ì„ íƒí•œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ê¸°ì´ˆ ë¶„ì„ì…ë‹ˆë‹¤.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="p-4 rounded-xl" style="background-color: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.15);">
                                    <div class="text-sm font-semibold text-indigo-400 mb-2">í¥ë¯¸ ì˜ì—­</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.interest_top || []).map(t => translateToKorean(t)).join(', ') || 'ë¯¸ì„ íƒ'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.15);">
                                    <div class="text-sm font-semibold text-purple-400 mb-2">ì¤‘ìš” ê°€ì¹˜</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.value_top || []).map(t => translateToKorean(t)).join(', ') || 'ë¯¸ì„ íƒ'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.15);">
                                    <div class="text-sm font-semibold text-emerald-400 mb-2">ê°•ì </div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.strength_top || []).map(t => translateToKorean(t)).join(', ') || 'ë¯¸ì„ íƒ'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(251,146,60,0.08); border: 1px solid rgba(251,146,60,0.15);">
                                    <div class="text-sm font-semibold text-orange-400 mb-2">ì œì•½ ì¡°ê±´</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.constraint_flags || []).map(t => translateToKorean(t)).join(', ') || 'ì—†ìŒ'}</div>
                                </div>
                            </div>
                        </div>
                    \` : ''}

                    <!-- ============================================ -->
                    <!-- V3 ì¶”ê°€ ì‹¬ë¦¬ ë¶„ì„ ì„¹ì…˜ë“¤ -->
                    <!-- ============================================ -->

                    <!-- ì‘ì—… ìŠ¤íƒ€ì¼ 5ì¶• ì‹œê°í™” (ê°œì„ ëœ ë²„ì „) -->
                    \${workStyleMap && (workStyleMap.analytical_vs_creative !== 0 || workStyleMap.solo_vs_team !== 0) ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(6,182,212,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-cyan-400 flex items-center gap-2">
                                <span>ğŸ“Š</span> ì‘ì—… ìŠ¤íƒ€ì¼ 5ì¶• ë¶„ì„
                            </h4>
                            <p class="text-sm text-wiki-muted mb-5">ê° ì¶•ì˜ ì¤‘ì•™ì€ ê· í˜• ìƒíƒœì´ë©°, ì¢Œìš°ë¡œ ì¹˜ìš°ì¹ ìˆ˜ë¡ í•´ë‹¹ ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤.</p>
                            <div class="space-y-5">
                                \${[
                                    { left: 'ë¶„ì„í˜•', right: 'ì°½ì˜í˜•', value: workStyleMap.analytical_vs_creative, color: 'cyan', leftDesc: 'ë°ì´í„°ì™€ ë…¼ë¦¬ ê¸°ë°˜ ì ‘ê·¼ì„ ì„ í˜¸í•©ë‹ˆë‹¤', rightDesc: 'ìƒˆë¡œìš´ ì•„ì´ë””ì–´ì™€ ì°½ì˜ì  ì ‘ê·¼ì„ ì„ í˜¸í•©ë‹ˆë‹¤', balanceDesc: 'ë¶„ì„ê³¼ ì°½ì˜ì„±ì„ ê· í˜• ìˆê²Œ í™œìš©í•©ë‹ˆë‹¤' },
                                    { left: 'í˜¼ì ì§‘ì¤‘', right: 'íŒ€ í˜‘ì—…', value: workStyleMap.solo_vs_team, color: 'blue', leftDesc: 'ë…ë¦½ì ìœ¼ë¡œ ê¹Šì´ íŒŒê³ ë“œëŠ” ì‘ì—…ì—ì„œ ì—ë„ˆì§€ë¥¼ ì–»ìŠµë‹ˆë‹¤', rightDesc: 'íŒ€ì›ë“¤ê³¼ í•¨ê»˜ ë…¼ì˜í•˜ê³  í˜‘ë ¥í•  ë•Œ ì‹œë„ˆì§€ë¥¼ ëƒ…ë‹ˆë‹¤', balanceDesc: 'ìƒí™©ì— ë”°ë¼ ë…ë¦½ ì‘ì—…ê³¼ í˜‘ì—…ì„ ìœ ì—°í•˜ê²Œ ì „í™˜í•©ë‹ˆë‹¤' },
                                    { left: 'ì²´ê³„ì ', right: 'ìœ ì—°í•¨', value: workStyleMap.structured_vs_flexible, color: 'violet', leftDesc: 'ëª…í™•í•œ ê³„íšê³¼ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ ì•ˆì •ê°ì„ ëŠë‚ë‹ˆë‹¤', rightDesc: 'ìƒí™©ì— ë§ê²Œ ì¦‰í¥ì ìœ¼ë¡œ ëŒ€ì‘í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤', balanceDesc: 'ì²´ê³„ì™€ ìœ ì—°í•¨ì„ ìƒí™©ì— ë§ê²Œ ì¡°í•©í•©ë‹ˆë‹¤' },
                                    { left: 'ì „ë¬¸ê°€í˜•', right: 'ì œë„ˆëŸ´ë¦¬ìŠ¤íŠ¸', value: workStyleMap.depth_vs_breadth, color: 'amber', leftDesc: 'í•œ ë¶„ì•¼ë¥¼ ê¹Šì´ íŒŒê³ ë“¤ì–´ ì „ë¬¸ì„±ì„ í‚¤ìš°ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤', rightDesc: 'ë‹¤ì–‘í•œ ë¶„ì•¼ë¥¼ ë„“ê²Œ ê²½í—˜í•˜ë©° ì—°ê²°í•˜ëŠ” ê²ƒì„ ì¦ê¹ë‹ˆë‹¤', balanceDesc: 'ê¹Šì´ì™€ ë„“ì´ë¥¼ ê· í˜• ìˆê²Œ ì¶”êµ¬í•©ë‹ˆë‹¤' },
                                    { left: 'ê°€ì´ë“œ ì„ í˜¸', right: 'ììœ¨ ì„ í˜¸', value: workStyleMap.guided_vs_autonomous, color: 'emerald', leftDesc: 'ëª…í™•í•œ ë°©í–¥ê³¼ ë©˜í† ë§ì´ ìˆì„ ë•Œ ì„±ì¥ì´ ë¹ ë¦…ë‹ˆë‹¤', rightDesc: 'ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ììœ¨ì„±ì„ ì¤‘ìš”ì‹œí•©ë‹ˆë‹¤', balanceDesc: 'ì ì ˆí•œ ê°€ì´ë“œì™€ ììœ¨ì„±ì˜ ê· í˜•ì„ ì¶”êµ¬í•©ë‹ˆë‹¤' },
                                ].map(axis => \`
                                    <div>
                                        <div class="flex items-center gap-4">
                                            <span class="text-sm w-24 text-right \${axis.value < 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted'}">\${axis.left}</span>
                                            <div class="flex-1 h-3 bg-wiki-border/20 rounded-full relative overflow-hidden">
                                                <div class="absolute top-0 left-1/2 w-px h-full bg-wiki-muted/40 z-10"></div>
                                                \${axis.value === 0
                                                    ? '<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gray-400 rounded-full border-2 border-wiki-bg z-20"></div>'
                                                    : \`<div class="absolute top-0 h-full bg-\${axis.color}-400/80 rounded-full transition-all"
                                                         style="\${axis.value >= 0
                                                            ? 'left: 50%; width: ' + Math.max(axis.value / 2, 3) + '%;'
                                                            : 'right: 50%; width: ' + Math.max(Math.abs(axis.value) / 2, 3) + '%;'}"></div>\`}
                                            </div>
                                            <span class="text-sm w-24 \${axis.value > 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted'}">\${axis.right}</span>
                                        </div>
                                        <p class="text-xs text-wiki-muted mt-1 text-center">\${Math.abs(axis.value) >= 15 ? (axis.value < 0 ? axis.leftDesc : axis.rightDesc) : axis.balanceDesc}</p>
                                    </div>
                                \`).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- ë‚´ë©´ ê°ˆë“± + ì„±ì¥ ê³¡ì„  (ë‘˜ ë‹¤ ìˆìœ¼ë©´ 2ì—´, í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ 1ì—´) -->
                    \${(innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) || growthCurve.type ? \`
                        <div class="grid grid-cols-1 \${(innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) && growthCurve.type ? 'md:grid-cols-2' : ''} gap-6 mb-8">
                            <!-- ë‚´ë©´ ê°ˆë“± ë¶„ì„ -->
                            \${innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(168,85,247,0.2);">
                                    <h4 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                                        <span>ğŸ’­</span> ë‚´ë©´ ê°ˆë“± ë¶„ì„
                                    </h4>
                                    \${innerConflict.patterns?.length > 0 ? \`
                                        <p class="text-lg font-bold mb-3" style="color: rgb(216,180,254);">\${innerConflict.patterns[0]}</p>
                                    \` : ''}
                                    <p class="text-[15px] leading-relaxed text-wiki-text mb-4">\${innerConflict.analysis}</p>
                                    \${innerConflict.patterns?.length > 1 ? \`
                                        <div class="mt-4 pt-4 border-t border-purple-400/20">
                                            <span class="text-sm text-purple-300 font-semibold">ê¸°íƒ€ ê°ˆë“± íŒ¨í„´:</span>
                                            <ul class="mt-3 space-y-2">
                                                \${innerConflict.patterns.slice(1).map(p => \`
                                                    <li class="flex items-center gap-3">
                                                        <span class="text-purple-400">â€¢</span>
                                                        <span class="text-[15px] leading-relaxed text-wiki-muted">\${p}</span>
                                                    </li>
                                                \`).join('')}
                                            </ul>
                                        </div>
                                    \` : ''}
                                </div>
                            \` : ''}

                            <!-- ì„±ì¥ ê³¡ì„  -->
                            \${growthCurve.type ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(52,211,153,0.1)); border: 1px solid rgba(16,185,129,0.2);">
                                    <h4 class="text-xl font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                        <span>ğŸ“ˆ</span> ì„±ì¥ ê³¡ì„  ìœ í˜•
                                    </h4>
                                    <p class="text-lg font-bold mb-3" style="color: rgb(52,211,153);">\${translateToKorean(growthCurve.type)}</p>
                                    \${growthCurve.description ? \`
                                        <p class="text-[15px] leading-relaxed text-wiki-text">\${growthCurve.description}</p>
                                    \` : ''}
                                </div>
                            \` : ''}
                        </div>
                    \` : ''}

                    <!-- ì „í™˜ íƒ€ì´ë° (30/60/90ì¼ ê³„íš) -->
                    \${transitionTiming.day30?.goal || transitionTiming.day60?.goal || transitionTiming.day90?.goal ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-blue-400 flex items-center gap-2">
                                <span>ğŸ“…</span> 30/60/90ì¼ ì „í™˜ ê³„íš
                            </h4>
                            <p class="text-sm text-wiki-muted mb-5">ë‹¨ê³„ë³„ ëª©í‘œì™€ ì‹¤í–‰ ê³„íšì„ í†µí•´ ì²´ê³„ì ìœ¼ë¡œ ì „í™˜ì„ ì¤€ë¹„í•˜ì„¸ìš”.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                \${transitionTiming.day30?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15);">
                                        <div class="text-sm font-bold text-blue-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold">30</span>
                                            ì²« 30ì¼
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day30.goal}</div>
                                        \${transitionTiming.day30.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day30.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-blue-400">â€¢</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day30.milestone ? \`<div class="text-sm text-blue-400 font-medium">âœ“ \${transitionTiming.day30.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                                \${transitionTiming.day60?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.15);">
                                        <div class="text-sm font-bold text-indigo-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold">60</span>
                                            60ì¼ì°¨
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day60.goal}</div>
                                        \${transitionTiming.day60.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day60.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-indigo-400">â€¢</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day60.milestone ? \`<div class="text-sm text-indigo-400 font-medium">âœ“ \${transitionTiming.day60.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                                \${transitionTiming.day90?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.15);">
                                        <div class="text-sm font-bold text-violet-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-violet-500/20 flex items-center justify-center text-violet-400 font-bold">90</span>
                                            90ì¼ì°¨
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day90.goal}</div>
                                        \${transitionTiming.day90.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day90.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-violet-400">â€¢</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day90.milestone ? \`<div class="text-sm text-violet-400 font-medium">âœ“ \${transitionTiming.day90.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                            </div>
                        </div>
                    \` : ''}

                    <!-- ì „ë¬¸ê°€ ê°€ì´ë˜ìŠ¤ -->
                    \${expertGuidance.doNow?.length > 0 || expertGuidance.stopDoing?.length > 0 || expertGuidance.learnNext?.length > 0 ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-green-400 flex items-center gap-2">
                                <span>ğŸ§­</span> ì „ë¬¸ê°€ ê°€ì´ë˜ìŠ¤
                            </h4>
                            <p class="text-[15px] text-wiki-muted mb-5">ì§€ê¸ˆ ë‹¹ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì¡°ì–¸ì…ë‹ˆë‹¤.</p>
                            \${(() => {
                                // í™œì„± ì„¹ì…˜ ìˆ˜ ê³„ì‚°í•˜ì—¬ ê·¸ë¦¬ë“œ ë™ì  ì¡°ì •
                                const activeSections = [
                                    expertGuidance.doNow?.length > 0 ? 'doNow' : null,
                                    expertGuidance.stopDoing?.length > 0 ? 'stopDoing' : null,
                                    expertGuidance.learnNext?.length > 0 ? 'learnNext' : null,
                                    expertGuidance.avoidPaths?.length > 0 ? 'avoidPaths' : null
                                ].filter(Boolean);
                                const count = activeSections.length;
                                const lastSection = activeSections[count - 1];
                                const isOdd = count % 2 === 1;
                                const gridClass = count <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';

                                // í™€ìˆ˜ê°œì¼ ë•Œ ë§ˆì§€ë§‰ ì„¹ì…˜ë§Œ col-span-2
                                const doNowSpan = isOdd && lastSection === 'doNow' ? 'md:col-span-2' : '';
                                const stopSpan = isOdd && lastSection === 'stopDoing' ? 'md:col-span-2' : '';
                                const learnSpan = isOdd && lastSection === 'learnNext' ? 'md:col-span-2' : '';
                                const avoidSpan = isOdd && lastSection === 'avoidPaths' ? 'md:col-span-2' : '';

                                return '<div class="' + gridClass + '">'
                                + (expertGuidance.doNow?.length > 0 ? '<div class="p-5 rounded-xl ' + doNowSpan + '" style="background-color: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.15);"><div class="text-base font-bold text-green-400 mb-3 flex items-center gap-2"><span class="text-xl">âœ…</span> ì§€ê¸ˆ ì‹œì‘í•  ê²ƒ</div><ul class="space-y-2">' + expertGuidance.doNow.slice(0,3).map(d => '<li class="flex items-center gap-3"><span class="text-green-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(d) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.stopDoing?.length > 0 ? '<div class="p-5 rounded-xl ' + stopSpan + '" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.15);"><div class="text-base font-bold text-red-400 mb-3 flex items-center gap-2"><span class="text-xl">ğŸš«</span> ê·¸ë§Œí•´ì•¼ í•  ê²ƒ</div><ul class="space-y-2">' + expertGuidance.stopDoing.slice(0,3).map(s => '<li class="flex items-center gap-3"><span class="text-red-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(s) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.learnNext?.length > 0 ? '<div class="p-5 rounded-xl ' + learnSpan + '" style="background-color: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15);"><div class="text-base font-bold text-blue-400 mb-3 flex items-center gap-2"><span class="text-xl">ğŸ“š</span> í•™ìŠµí•  ê²ƒ</div><ul class="space-y-2">' + expertGuidance.learnNext.slice(0,3).map(l => '<li class="flex items-center gap-3"><span class="text-blue-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(l) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.avoidPaths?.length > 0 ? '<div class="p-5 rounded-xl ' + avoidSpan + '" style="background-color: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.15);"><div class="text-base font-bold text-orange-400 mb-3 flex items-center gap-2"><span class="text-xl">âš ï¸</span> í”¼í•´ì•¼ í•  ê²½ë¡œ</div><ul class="space-y-2">' + expertGuidance.avoidPaths.slice(0,3).map(a => '<li class="flex items-center gap-3"><span class="text-orange-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(a) + '</span></li>').join('') + '</ul></div>' : '')
                                + '</div>';
                            })()}
                        </div>
                    \` : ''}

                    <!-- ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„ ìƒì„¸ -->
                    \${stressProfile.profile ? \`
                        <div class="p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,146,60,0.1)); border: 1px solid rgba(239,68,68,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2">
                                <span>ğŸ˜°</span> ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„
                            </h4>
                            <p class="text-[15px] leading-relaxed text-wiki-text mb-4">\${stressProfile.profile}</p>
                            \${stressProfile.triggers?.length > 0 ? \`
                                <div class="mt-4 pt-4 border-t border-red-400/20">
                                    <span class="text-sm text-red-300 font-semibold">ì£¼ìš” íŠ¸ë¦¬ê±°:</span>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        \${stressProfile.triggers.map(t => \`
                                            <span class="px-3 py-1.5 rounded-lg text-sm font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">\${t}</span>
                                        \`).join('')}
                                    </div>
                                </div>
                            \` : ''}
                        </div>
                    \` : ''}

                </div>
                
                <!-- íƒ­ ì»¨í…ì¸ : ì¶”ì²œ ì§ì—… -->
                <div id="tab-recommendations" class="report-tab-content hidden glass-card p-6 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">ğŸ’¼</span>
                            <span class="bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">ì¶”ì²œ ì§ì—…</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì§ì—…ì„ AIê°€ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>
                    </div>

                    <!-- ğŸ“Œ í”„ë¡œí•„ ê¸°ë°˜ ì¶”ì²œ ìš”ì•½ (A: ì¶”ì²œ íƒ­ ìƒë‹¨) -->
                    \${profileInterpretation ? \`
                        <div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.08)); border: 1px solid rgba(99,102,241,0.2);">
                            <h4 class="text-lg font-bold mb-3 flex items-center gap-2" style="color: rgb(165,180,252);">
                                <span>ğŸ“Œ</span> ë‹¹ì‹ ì˜ í”„ë¡œí•„ ê¸°ë°˜ ì¶”ì²œ
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                \${profileInterpretation.interests?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(34,197,94,0.1);">
                                        <span class="text-green-400">ğŸ’š</span>
                                        <div>
                                            <div class="text-base font-semibold text-green-400">í¥ë¯¸</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.interests.slice(0,2).map(i => i.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.strengths?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(59,130,246,0.1);">
                                        <span class="text-blue-400">ğŸ’ª</span>
                                        <div>
                                            <div class="text-base font-semibold text-blue-400">ê°•ì </div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.strengths.slice(0,2).map(s => s.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.values?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(168,85,247,0.1);">
                                        <span class="text-purple-400">â­</span>
                                        <div>
                                            <div class="text-base font-semibold text-purple-400">ê°€ì¹˜</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.values.slice(0,2).map(v => v.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.constraints?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(239,68,68,0.1);">
                                        <span class="text-red-400">ğŸš«</span>
                                        <div>
                                            <div class="text-base font-semibold text-red-400">ì œì•½</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.constraints.slice(0,2).map(c => c.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                            </div>
                            <p class="text-[15px] text-wiki-muted">
                                ì´ ì¡°ê±´ë“¤ì„ ì¢…í•©í•˜ì—¬ <span class="text-wiki-primary font-medium">\${overallTop5.length || fitTop10.length}ê°œ</span>ì˜ ì§ì—…ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    \` : ''}

                    <!-- 3ì„¸íŠ¸ íƒ­ -->
                    <div class="flex gap-3 mb-6">
                        <button onclick="showJobSet('overall')" class="job-set-tab active flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="overall">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ†</span>
                                <span>ì¢…í•© ì¶”ì²œ</span>
                            </span>
                        </button>
                        <button onclick="showJobSet('fit')" class="job-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="fit">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ’ª</span>
                                <span>ì˜ í•  ê²ƒ ê°™ì€ ì§ì—…</span>
                            </span>
                        </button>
                        <button onclick="showJobSet('desire')" class="job-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="desire">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ’–</span>
                                <span>ì¢‹ì•„í• ë§Œí•œ ì§ì—…</span>
                            </span>
                        </button>
                    </div>
                    
                    <!-- ì§ì—… ì¹´ë“œë“¤ -->
                    <div id="job-cards-container">
                        \${renderJobCardsV3((overallTop5.length > 0 ? overallTop5 : fitTop10).slice(0, 5), 'overall', profileInterpretation)}
                    </div>
                </div>
                
                <!-- íƒ­ ì»¨í…ì¸ : ë¶„ì„ ìƒì„¸ (ì ìˆ˜/ì‹ ë¢°ë„ ì •ë³´) -->
                <div id="tab-details" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">ğŸ“Š</span>
                            <span class="bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">ë¶„ì„ ìƒì„¸ ì •ë³´</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">AI ì¶”ì²œì˜ ê·¼ê±°ì™€ ê¸°ìˆ ì  ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                        <p class="text-center text-wiki-muted text-xs mt-1">ì—”ì§„ ë²„ì „: \${result.engine_version || 'unknown'}</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
                    </div>
                    <p class="text-base text-wiki-muted mb-6">ì´ ì„¹ì…˜ì€ AI ì¶”ì²œì˜ ê·¼ê±°, ì‚¬ìš©ëœ ì•Œê³ ë¦¬ì¦˜, ê·¸ë¦¬ê³  ì ìˆ˜ ì‚°ì¶œ ê³¼ì •ì„ ìƒì„¸íˆ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>

                    <!-- ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì„¤ëª… -->
                    <div class="mb-8 p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.05)); border: 1px solid rgba(34,197,94,0.2);">
                        <h4 class="text-xl font-bold mb-4 text-emerald-400">ğŸ”¬ ë¶„ì„ íŒŒì´í”„ë¼ì¸</h4>
                        <div class="space-y-4 text-base">
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">1</span>
                                <div>
                                    <p class="font-medium text-white">ë²¡í„° ê²€ìƒ‰ (Vectorize)</p>
                                    <p class="text-wiki-muted text-[15px]">ë‹¹ì‹ ì˜ ë‹µë³€ì„ ì„ë² ë”©ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ 7,000ê°œ ì§ì—… DBì—ì„œ ì˜ë¯¸ì ìœ¼ë¡œ ìœ ì‚¬í•œ í›„ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">2</span>
                                <div>
                                    <p class="font-medium text-white">TAG í•„í„°ë§ (Hard Constraints)</p>
                                    <p class="text-wiki-muted text-[15px]">ì›Œë¼ë°¸, ì›ê²©ê·¼ë¬´, ìê²©ìš”ê±´ ë“± ì ˆëŒ€ ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ì§ì—…ì„ ì œì™¸í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">3</span>
                                <div>
                                    <p class="font-medium text-white">LLM Judge (GPT-4o-mini)</p>
                                    <p class="text-wiki-muted text-[15px]">ë‚¨ì€ í›„ë³´ 60ê°œì— ëŒ€í•´ AIê°€ Like/Can/Fit ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ê³ , ì¶”ì²œ ì´ìœ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">4</span>
                                <div>
                                    <p class="font-medium text-white">LLM Reporter (ì‹¬ë¦¬ë¶„ì„)</p>
                                    <p class="text-wiki-muted text-[15px]">ë‹¹ì‹ ì˜ ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—…ë¬´ ìŠ¤íƒ€ì¼ê³¼ ì»¤ë¦¬ì–´ ë°©í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì…ë ¥ ë°ì´í„° ìš”ì•½ -->
                    <div class="mb-8">
                        <h4 class="text-xl font-bold mb-4">ğŸ“ ë¶„ì„ì— ì‚¬ìš©ëœ ì…ë ¥ ë°ì´í„°</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-wiki-primary">\${report._factsCount || 0}</div>
                                <div class="text-base text-wiki-muted mt-1">ìˆ˜ì§‘ëœ íŒ©íŠ¸</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-emerald-400">\${report._answeredQuestions || 0}</div>
                                <div class="text-base text-wiki-muted mt-1">ë‹µë³€í•œ ì§ˆë¬¸</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-purple-400">\${(report._totalJobCount || report._candidatesScored || 0).toLocaleString()}</div>
                                <div class="text-base text-wiki-muted mt-1">ë¶„ì„ ëŒ€ìƒ ì§ì—…</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-amber-400">6</div>
                                <div class="text-base text-wiki-muted mt-1">LLM í˜¸ì¶œ íšŸìˆ˜</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI ì¶”ì²œ ì‹œìŠ¤í…œ ì‘ë™ ì›ë¦¬ -->
                    <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2);">
                        <h4 class="text-xl font-bold mb-4" style="color: rgb(165,180,252);">ğŸ¯ AI ì¶”ì²œì€ ì´ë ‡ê²Œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤</h4>
                        <p class="text-[15px] text-wiki-muted mb-5">ì´ ë¦¬í¬íŠ¸ëŠ” ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­ì´ ì•„ë‹Œ, 3ë‹¨ê³„ AI ì‹œìŠ¤í…œì„ ê±°ì³ ìƒì„±ë©ë‹ˆë‹¤.</p>

                        <!-- RAG: ë²¡í„° ê²€ìƒ‰ -->
                        <div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(34,197,94,0.2); color: rgb(34,197,94);">STEP 1</span>
                                <span class="font-bold text-white text-base">RAG â€” ì˜ë¯¸ ê¸°ë°˜ í›„ë³´ ê²€ìƒ‰</span>
                            </div>
                            <p class="text-[14px] text-wiki-muted leading-relaxed mb-2">ë‹¹ì‹ ì˜ ë‹µë³€ ì „ì²´ë¥¼ AI ì„ë² ë”©(ìˆ«ì ë²¡í„°)ìœ¼ë¡œ ë³€í™˜í•œ ë’¤, 7,000ê°œ ì§ì—… DBì—ì„œ <span class="text-emerald-400">ì˜ë¯¸ì ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì§ì—…ë“¤</span>ì„ ì°¾ìŠµë‹ˆë‹¤.</p>
                            <p class="text-[13px] text-wiki-muted/70">"ë°ì´í„° ë¶„ì„ì„ ì¢‹ì•„í•œë‹¤"ê³  ë‹µí•˜ë©´, ì§ì—…ëª…ì— 'ë¶„ì„'ì´ ì—†ë”ë¼ë„ ë°ì´í„° ê´€ë ¨ ì—…ë¬´ë¥¼ í•˜ëŠ” ì§ì—…ì´ í›„ë³´ì— í¬í•¨ë©ë‹ˆë‹¤. ë‹¨ìˆœ í‚¤ì›Œë“œ ê²€ìƒ‰ê³¼ì˜ ì°¨ì´ì…ë‹ˆë‹¤.</p>
                        </div>

                        <!-- TAG: ì ˆëŒ€ ì¡°ê±´ í•„í„° -->
                        <div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(251,191,36,0.2); color: rgb(251,191,36);">STEP 2</span>
                                <span class="font-bold text-white text-base">TAG â€” ì ˆëŒ€ ì¡°ê±´ í•„í„°ë§</span>
                            </div>
                            <p class="text-[14px] text-wiki-muted leading-relaxed mb-2">í›„ë³´ ì§ì—…ë“¤ì˜ ì†ì„± íƒœê·¸ë¥¼ ë‹¹ì‹ ì˜ <span class="text-amber-400">ì œì•½ ì¡°ê±´</span>ê³¼ ëŒ€ì¡°í•©ë‹ˆë‹¤.</p>
                            <p class="text-[13px] text-wiki-muted/70">"ì ˆëŒ€ ì•ˆ ë¼" ìˆ˜ì¤€ì˜ ì œì•½ì€ í•´ë‹¹ ì§ì—…ì„ í›„ë³´ì—ì„œ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤. "ê°€ëŠ¥í•˜ë©´ í”¼í•˜ê³  ì‹¶ë‹¤" ìˆ˜ì¤€ì´ë©´ ì œê±° ëŒ€ì‹  Risk ê°ì ì´ ì ìš©ë˜ì–´ ìˆœìœ„ê°€ ë‚´ë ¤ê°‘ë‹ˆë‹¤. ì˜ˆ: "ì•¼ê·¼ ì ˆëŒ€ ë¶ˆê°€" â†’ ì•¼ê°„ ê·¼ë¬´ ì§ì—… ì œì™¸, "ì¶œì¥ ê°€ëŠ¥í•˜ë©´ ì‹«ë‹¤" â†’ ì¶œì¥ ì§ì—…ì€ ë‚¨ë˜ ê°ì .</p>
                        </div>

                        <!-- CAG: LLM í‰ê°€ -->
                        <div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(99,102,241,0.2); color: rgb(129,140,248);">STEP 3</span>
                                <span class="font-bold text-white text-base">CAG â€” AIê°€ ì§ì ‘ í‰ê°€</span>
                            </div>
                            <p class="text-[14px] text-wiki-muted leading-relaxed mb-2">ë‚¨ì€ í›„ë³´ ì§ì—… ê°ê°ì— ëŒ€í•´, GPT-4o-miniê°€ ë‹¹ì‹ ì˜ í”„ë¡œí•„ ì „ì²´ë¥¼ ì½ê³  <span class="text-indigo-400">Like(ì¢‹ì•„í•  ê°€ëŠ¥ì„±)</span>ì™€ <span class="text-blue-400">Can(ì˜í•  ê°€ëŠ¥ì„±)</span> ì ìˆ˜ë¥¼ ë§¤ê¹ë‹ˆë‹¤.</p>
                            <p class="text-[13px] text-wiki-muted/70">AIëŠ” ë‹¨ìˆœíˆ ìˆ«ìë§Œ ë§¤ê¸°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, "ì™œ ì´ ì§ì—…ì„ ì¢‹ì•„í• ì§€", "ì™œ ì˜í•  ìˆ˜ ìˆëŠ”ì§€"ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì´ìœ ë„ í•¨ê»˜ ìƒì„±í•©ë‹ˆë‹¤. ê° ì§ì—… ì¹´ë“œì— í‘œì‹œë˜ëŠ” Like/Can ì´ìœ ê°€ ë°”ë¡œ ì´ ë‹¨ê³„ì—ì„œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.</p>
                        </div>

                        <!-- ìµœì¢… ì ìˆ˜ -->
                        <div class="p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(168,85,247,0.2); color: rgb(192,132,252);">ìµœì¢…</span>
                                <span class="font-bold text-white text-base">ì¢…í•© ì ìˆ˜ ê³„ì‚° (Fit)</span>
                            </div>
                            <p class="text-[14px] text-wiki-muted leading-relaxed mb-3">AIê°€ ë§¤ê¸´ ì ìˆ˜ë¥¼ ì•„ë˜ ê³µì‹ìœ¼ë¡œ ì¡°í•©í•˜ì—¬ ìµœì¢… ìˆœìœ„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.</p>
                            <div class="p-3 rounded-lg text-center" style="background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);">
                                <p class="text-base font-bold text-white" style="font-family: monospace;">Fit = Like + Can + Background âˆ’ Risk</p>
                            </div>
                            <div class="mt-3 space-y-1 text-[13px] text-wiki-muted/80">
                                <p><span class="text-purple-400 font-medium">Like</span> â€” ì¢‹ì•„í•  ì§ì—…ì„ ì¤‘ìš”í•˜ê²Œ ë°˜ì˜í•©ë‹ˆë‹¤. í¥ë¯¸ì™€ ê°€ì¹˜ê´€ì´ ë§ì•„ì•¼ ì˜¤ë˜ ê°ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>
                                <p><span class="text-blue-400 font-medium">Can</span> â€” ì˜í•  ìˆ˜ ìˆëŠ” ì§ì—…ë„ í•¨ê»˜ ë°˜ì˜í•©ë‹ˆë‹¤. ê°•ì ê³¼ ì—­ëŸ‰ì´ ë§ì•„ì•¼ ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <p><span class="text-amber-400 font-medium">Background</span> â€” ê²½ë ¥, í•™ë ¥, ê²½í—˜ì´ ì§ì—…ê³¼ ì–¼ë§ˆë‚˜ ê´€ë ¨ ìˆëŠ”ì§€ í‰ê°€í•©ë‹ˆë‹¤.</p>
                                <p><span class="text-red-400 font-medium">Risk</span> â€” ë‹¹ì‹ ì´ "ì ˆëŒ€ ì‹«ë‹¤"ê³  í•œ ì¡°ê±´ê³¼ ì¶©ëŒí•˜ë©´ ê°ì ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <!-- ì ìˆ˜ ê³„ì‚° ë°©ì‹ ì„¤ëª… -->
                    <div class="mb-8 rounded-xl overflow-hidden" style="border: 1px solid rgba(255,255,255,0.08);">
                        <div class="px-5 py-3" style="background: rgba(255,255,255,0.04); border-bottom: 1px solid rgba(255,255,255,0.08);">
                            <h4 class="text-base font-bold text-wiki-text">ğŸ’¡ ì ìˆ˜ ê³„ì‚° ë°©ì‹</h4>
                        </div>
                        <div class="divide-y" style="--tw-divide-opacity: 0.06; --tw-divide-color: rgba(255,255,255,var(--tw-divide-opacity));">
                            <div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(52,211,153);">
                                <span class="text-emerald-400 font-bold text-sm w-10 shrink-0 text-center">Fit</span>
                                <span class="text-white text-sm font-medium w-20 shrink-0">ì¢…í•© ì í•©ë„</span>
                                <span class="text-wiki-muted text-[13px]">Like + Can + Background ì¢…í•©, Risk ì°¨ê°</span>
                            </div>
                            <div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(168,85,247);">
                                <span class="text-purple-400 font-bold text-sm w-10 shrink-0 text-center">Like</span>
                                <span class="text-white text-sm font-medium w-20 shrink-0">ì¢‹ì•„í•  ê°€ëŠ¥ì„±</span>
                                <span class="text-wiki-muted text-[13px]">ê´€ì‹¬ ë¶„ì•¼, ê°€ì¹˜ê´€, ìš°ì„ ìˆœìœ„ì™€ ì§ì—… íŠ¹ì„±ì˜ ì¼ì¹˜ë„</span>
                            </div>
                            <div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(96,165,250);">
                                <span class="text-blue-400 font-bold text-sm w-10 shrink-0 text-center">Can</span>
                                <span class="text-white text-sm font-medium w-20 shrink-0">ì˜í•  ê°€ëŠ¥ì„±</span>
                                <span class="text-wiki-muted text-[13px]">ê°•ì , ì—…ë¬´ ìŠ¤íƒ€ì¼, ê²½í—˜ê³¼ ì§ì—… ìš”êµ¬ì‚¬í•­ì˜ ì í•©ë„</span>
                            </div>
                            <div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(251,191,36);">
                                <span class="text-amber-400 font-bold text-sm w-10 shrink-0 text-center">Bg</span>
                                <span class="text-white text-sm font-medium w-20 shrink-0">ë°°ê²½ ì í•©ë„</span>
                                <span class="text-wiki-muted text-[13px]">ê²½ë ¥, ì „ê³µ, ìê²©ì¦, í•´ì™¸ê²½í—˜ ë“± ë°°ê²½ì˜ ë„ì›€ ì •ë„</span>
                            </div>
                            <div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(248,113,113);">
                                <span class="text-red-400 font-bold text-sm w-10 shrink-0 text-center">Risk</span>
                                <span class="text-white text-sm font-medium w-20 shrink-0">ìœ„í—˜ ìš”ì†Œ</span>
                                <span class="text-wiki-muted text-[13px]">í”¼í•˜ê³  ì‹¶ì€ ì¡°ê±´ê³¼ ì§ì—… í™˜ê²½ ì¶©ëŒ ì‹œ í˜ë„í‹°</span>
                            </div>
                        </div>
                    </div>

                    <!-- ë°ì´í„° ì†ŒìŠ¤ -->
                    <div class="p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                        <h4 class="text-xl font-bold mb-4 text-purple-400">ğŸ“š ë°ì´í„° ì†ŒìŠ¤</h4>
                        <div class="grid md:grid-cols-2 gap-4 text-base">
                            <div>
                                <p class="font-medium text-white mb-1">ì§ì—… ì •ë³´</p>
                                <p class="text-wiki-muted text-[15px]">ì»¤ë¦¬ì–´ë„· + ê³ ìš©24 + ì›Œí¬ë„· ë°ì´í„° í†µí•© (ì•½ 7,000ê°œ ì§ì—…)</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">ì§ì—… ì†ì„± íƒœê¹…</p>
                                <p class="text-wiki-muted text-[15px]">job_attributes í…Œì´ë¸”: ì›Œë¼ë°¸, ì„±ì¥ì„±, ìê²©ìš”ê±´ ë“± 15ê°œ ì†ì„±</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">ì„ë² ë”© ëª¨ë¸</p>
                                <p class="text-wiki-muted text-[15px]">OpenAI text-embedding-3-small (1536ì°¨ì›)</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">íŒë‹¨ ëª¨ë¸</p>
                                <p class="text-wiki-muted text-[15px]">GPT-4o-mini (Like/Can/Fit ì ìˆ˜ ë° ì¶”ì²œ ì´ìœ  ìƒì„±)</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨: ì…ë ¥ ìˆ˜ì • + ë‚´ìš© ì¶”ê°€ ë²„íŠ¼ -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center mt-8">
                    <button onclick="showEditWarningModal()"
                        class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-medium transition hover:opacity-80"
                        style="background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3);">
                        <i class="fas fa-edit"></i> ì…ë ¥í•œ ë‚´ìš© ìˆ˜ì •
                    </button>
                    <button onclick="showAddContextModal()"
                        class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-medium transition hover:opacity-80"
                        style="background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-plus"></i> ìƒˆë¡œìš´ ë‚´ìš© ì¶”ê°€
                    </button>
                </div>

                <!-- ì…ë ¥ ìˆ˜ì • ê²½ê³  ëª¨ë‹¬ -->
                <div id="edit-warning-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
                    <div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-lg mx-4 shadow-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="mb-5">
                            <div class="w-12 h-12 mx-auto mb-4 bg-amber-500/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-xl text-amber-400"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white text-center mb-2">ì…ë ¥ ë‚´ìš© ìˆ˜ì • ì•ˆë‚´</h3>
                            <p class="text-sm text-wiki-muted text-center">ê¸°ì¡´ì— ì…ë ¥í–ˆë˜ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ë‹¨, ìˆ˜ì • ë²”ìœ„ì— ë”°ë¼ ì´í›„ ë‹¨ê³„ì˜ ë‹µë³€ì´ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div class="p-3 rounded-lg" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2);">
                                <p class="text-sm font-medium text-amber-300 mb-1">Step 1 (í”„ë¡œí•„ ê¸°ë³¸ì •ë³´) ìˆ˜ì • ì‹œ</p>
                                <p class="text-xs text-wiki-muted">Step 2(ì‹¬ì¸µ ì§ˆë¬¸)ì˜ ì§ˆë¬¸ì´ ìƒˆë¡œ ìƒì„±ë˜ë©°, ê¸°ì¡´ ì‹¬ì¸µ ì§ˆë¬¸ ë‹µë³€ì´ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                            </div>
                            <div class="p-3 rounded-lg" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2);">
                                <p class="text-sm font-medium text-amber-300 mb-1">Step 2 (ì‹¬ì¸µ ì§ˆë¬¸) ë‹µë³€ ìˆ˜ì • ì‹œ</p>
                                <p class="text-xs text-wiki-muted">ìˆ˜ì •í•œ ë¼ìš´ë“œ ì´í›„ì˜ ì§ˆë¬¸ë“¤ì´ ìƒˆë¡œ ìƒì„±ë˜ë©°, í•´ë‹¹ ë¼ìš´ë“œ ì´í›„ ë‹µë³€ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="hideEditWarningModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">
                                ì·¨ì†Œ
                            </button>
                            <button onclick="navigateToEditMode()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium">
                                ìˆ˜ì • ì‹œì‘í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ë‚´ìš© ì¶”ê°€ ëª¨ë‹¬ -->
                <div id="add-context-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
                    <div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-md mx-4 shadow-2xl w-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-bold text-white mb-2">
                                <i class="fas fa-plus text-emerald-400 mr-2"></i>ì¶”ê°€ ì •ë³´ ì…ë ¥
                            </h3>
                            <p class="text-sm text-wiki-muted">í˜„ì¬ ë¶„ì„ì— ë°˜ì˜í•˜ê³  ì‹¶ì€ ì¶”ê°€ ì •ë³´ë¥¼ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        <textarea id="additional-context-text"
                                  class="w-full h-32 p-3 rounded-xl text-sm text-white placeholder-wiki-muted resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
                                  style="background: rgba(15, 15, 35, 0.6); border: 1px solid rgba(148, 163, 184, 0.2);"
                                  placeholder="ì˜ˆ: ìµœê·¼ ë°ì´í„° ë¶„ì„ ë¶€íŠ¸ìº í”„ë¥¼ ìˆ˜ë£Œí–ˆìŠµë‹ˆë‹¤. ì¬íƒê·¼ë¬´ê°€ ê°€ëŠ¥í•œ ì§ì—…ì„ ì„ í˜¸í•©ë‹ˆë‹¤."
                                  minlength="30"></textarea>
                        <p id="context-char-count" class="text-xs mt-1 text-wiki-muted">0 / ìµœì†Œ 30ì</p>
                        <div class="flex gap-3 mt-4">
                            <button onclick="hideAddContextModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">
                                ì·¨ì†Œ
                            </button>
                            <button id="submit-context-btn" onclick="submitAdditionalContext()" disabled
                                    class="flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                ì¶”ê°€ í›„ ì¬ë¶„ì„
                            </button>
                        </div>
                    </div>
                </div>
            \`;
            
            // ìŠ¤íƒ€ì¼ ì¶”ê°€
            addReportStyles();
            
            // ì „ì—­ ë°ì´í„° ì €ì¥ (íƒ­ ì „í™˜ìš© + Evidence ì‹œìŠ¤í…œ)
            // Evidence ë°ì´í„° ë§¤í•‘ (job_id â†’ evidence_links)
            const evidenceMap = {};
            (result.fit_top3 || []).forEach(job => {
                if (job.evidence_links?.length > 0) {
                    evidenceMap[job.job_id] = job.evidence_links;
                }
            });
            
            window.currentReportData = {
                report,
                overallTop5,
                fitTop10,
                likeTop10,
                evidenceMap,  // Evidence ë°ì´í„° ì¶”ê°€
                profileInterpretation,  // í”„ë¡œí•„ í•´ì„ ë°ì´í„°
            };
        }
        
        // íƒ­ ì „í™˜
        function showReportTab(tabId) {
            document.querySelectorAll('.report-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.report-tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId)?.classList.remove('hidden');
            document.querySelector('.report-tab[data-tab="' + tabId + '"]')?.classList.add('active');
        }
        
        // ============================================
        // ì…ë ¥ ìˆ˜ì • / ë‚´ìš© ì¶”ê°€ (V3 ë¦¬í¬íŠ¸ í•˜ë‹¨)
        // ============================================
        function showEditWarningModal() {
            document.getElementById('edit-warning-modal')?.classList.remove('hidden');
        }
        function hideEditWarningModal() {
            document.getElementById('edit-warning-modal')?.classList.add('hidden');
        }
        function navigateToEditMode() {
            if (!currentSessionId) { alert('ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const analyzerPath = selectedAnalysisType === 'major' ? '/analyzer/major' : '/analyzer/job';
            const params = new URLSearchParams({
                session_id: currentSessionId,
                edit_mode: 'true',
            });
            if (currentRequestId) params.set('source_request_id', String(currentRequestId));
            window.location.href = analyzerPath + '?' + params.toString();
        }
        function showAddContextModal() {
            document.getElementById('add-context-modal')?.classList.remove('hidden');
        }
        function hideAddContextModal() {
            document.getElementById('add-context-modal')?.classList.add('hidden');
            const textarea = document.getElementById('additional-context-text');
            if (textarea) textarea.value = '';
            updateContextCharCount();
        }
        function updateContextCharCount() {
            const textarea = document.getElementById('additional-context-text');
            if (!textarea) return;
            const count = textarea.value.length;
            const countEl = document.getElementById('context-char-count');
            if (countEl) countEl.textContent = count + ' / ìµœì†Œ 30ì';
            const btn = document.getElementById('submit-context-btn');
            if (btn) btn.disabled = count < 30;
        }
        document.getElementById('additional-context-text')?.addEventListener('input', updateContextCharCount);

        async function submitAdditionalContext() {
            const textarea = document.getElementById('additional-context-text');
            const text = textarea ? textarea.value.trim() : '';
            if (text.length < 30) return;
            if (!currentRequestId) { alert('ë¶„ì„ ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const btn = document.getElementById('submit-context-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì¬ë¶„ì„ ì¤‘...';
            }

            try {
                const res = await fetch('/api/ai-analyzer/add-context', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: currentRequestId, additional_text: text })
                });
                const data = await res.json();
                if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.success && data.new_request_id) {
                    window.location.href = '/user/ai-results/' + data.new_request_id;
                } else {
                    alert('ì¬ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    if (btn) { btn.disabled = false; btn.innerHTML = 'ì¶”ê°€ í›„ ì¬ë¶„ì„'; }
                }
            } catch (err) {
                alert('ì¬ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                if (btn) { btn.disabled = false; btn.innerHTML = 'ì¶”ê°€ í›„ ì¬ë¶„ì„'; }
            }
        }

        // ============================================
        // ê³µìœ  ê¸°ëŠ¥
        // ============================================
        let _shareUrl = null;
        let _shareToken = null;

        async function shareReport() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('request_id') || urlParams.get('view') || currentRequestId;
            if (!requestId) { alert('ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            try {
                const res = await fetch('/api/ai-analyzer/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: parseInt(requestId) }),
                });
                const json = await res.json();
                if (!json.success) {
                    alert(json.error || 'ê³µìœ  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                _shareUrl = json.share_url;
                _shareToken = json.token;

                // ê¸€ë¡œë²Œ ê³µìœ  ëª¨ë‹¬ ì—´ê¸°
                var ogImage = json.share_url + '/og.png';
                if (window.__openShareModal) {
                    window.__openShareModal(json.share_url, 'AIê°€ ë¶„ì„í•œ ë‚˜ì˜ ì»¤ë¦¬ì–´ DNA', ogImage);
                } else {
                    // fallback: í´ë¦½ë³´ë“œ ë³µì‚¬
                    try {
                        await navigator.clipboard.writeText(json.share_url);
                        alert('ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } catch(e) {
                        prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', json.share_url);
                    }
                }
            } catch (err) {
                alert('ê³µìœ  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²°ê³¼ ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ (ë°ì´í„° ê¸°ë°˜ - DOMì´ ì•„ë‹Œ ì‹¤ì œ ë°ì´í„°ì—ì„œ ì¶”ì¶œ)
        function copyAllReportContent() {
            const data = window.currentReportData;
            if (!data) { alert('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const report = data.report || {};
            const pi = data.profileInterpretation;
            const mm = window.miniModuleResult || {};

            let t = '=== AI ì»¤ë¦¬ì–´ ë¶„ì„ ë¦¬í¬íŠ¸ ===\\n';
            t += 'ìƒì„±ì¼: ' + new Date().toLocaleDateString('ko-KR') + '\\n\\n';

            // â”€â”€ 1. ìš”ì•½ â”€â”€
            t += 'â”â”â” ğŸ“‹ ìš”ì•½ â”â”â”\\n\\n';
            const headline = report.executiveSummary || report.summary_one_page?.headline || '';
            if (headline) t += headline + '\\n\\n';
            const takeaways = report.lifeVersionStatement?.expanded || report.summary_one_page?.top_takeaways || [];
            if (takeaways.length > 0) {
                t += 'â–¸ í•µì‹¬ í¬ì¸íŠ¸\\n';
                takeaways.forEach(function(item) { t += '  â€¢ ' + item + '\\n'; });
                t += '\\n';
            }
            const nextStep = report.expertGuidance?.doNow?.[0] || report.summary_one_page?.recommended_next_step || '';
            if (nextStep) t += 'â–¸ ë‹¤ìŒ ë‹¨ê³„: ' + nextStep + '\\n\\n';

            // ë‚˜ì˜ ì»¤ë¦¬ì–´ í”„ë¡œí•„
            if (pi) {
                t += 'â–¸ ë‚˜ì˜ ì»¤ë¦¬ì–´ í”„ë¡œí•„\\n';
                if (pi.interests?.length) t += '  í¥ë¯¸: ' + pi.interests.map(function(i){return i.label}).join(', ') + '\\n';
                if (pi.strengths?.length) t += '  ê°•ì : ' + pi.strengths.map(function(s){return s.label}).join(', ') + '\\n';
                if (pi.values?.length) t += '  ê°€ì¹˜: ' + pi.values.map(function(v){return v.label}).join(', ') + '\\n';
                if (pi.constraints?.length) t += '  ì œì•½: ' + pi.constraints.map(function(c){return c.label}).join(', ') + '\\n';
                t += '\\n';
            }

            // ìš”ì•½ Top 3 ì§ì—…
            const summaryJobs = (data.overallTop5 || data.fitTop10 || []).slice(0, 3);
            if (summaryJobs.length > 0) {
                t += 'â–¸ ì¶”ì²œ ì§ì—… Top 3\\n';
                summaryJobs.forEach(function(job, i) {
                    const name = job.job_name || job.job_id || '';
                    const fit = job.scores?.fit || job.fit_score || '-';
                    const like = job.scores?.like || job.like_score || '-';
                    const can = job.scores?.can || job.can_score || '-';
                    const bg = job.feasibility_score || job.feasibilityScore || 0;
                    var scoreStr = '(Fit:' + fit + ' Like:' + like + ' Can:' + can;
                    if (bg > 0) scoreStr += ' Bg:' + bg;
                    scoreStr += ')';
                    t += '  ' + (i+1) + '. ' + name + ' ' + scoreStr + '\\n';
                    if (job.like_reason) t += '     Like: ' + job.like_reason + '\\n';
                    if (job.can_reason) t += '     Can: ' + job.can_reason + '\\n';
                });
                t += '\\n';
            }

            // â”€â”€ 2. ë©”íƒ€ì¸ì§€ â”€â”€
            t += 'â”â”â” ğŸ§  ë©”íƒ€ì¸ì§€ â”â”â”\\n\\n';
            const personality = report.workStyleNarrative || report.lifeVersionStatement?.oneLiner || '';
            if (personality) t += 'â–¸ ì„±ê²© ìš”ì•½\\n  ' + personality + '\\n\\n';

            const workInsights = [
                report.workStyleMap?.socialStyle ? translateToKorean(report.workStyleMap.socialStyle) + ' ì—…ë¬´ ìŠ¤íƒ€ì¼' : null,
                report.workStyleMap?.decisionStyle ? translateToKorean(report.workStyleMap.decisionStyle) + ' ì˜ì‚¬ê²°ì •' : null,
                report.growthCurveDescription || null,
            ].filter(Boolean);
            if (workInsights.length > 0) {
                t += 'â–¸ ì—…ë¬´ ìŠ¤íƒ€ì¼\\n';
                workInsights.forEach(function(w) { t += '  â€¢ ' + w + '\\n'; });
                t += '\\n';
            }

            const valuePriorities = mm.value_top?.map(function(v){return translateToKorean(v)}) || report.personal_analysis?.value_priorities || [];
            if (valuePriorities.length > 0) t += 'â–¸ ê°€ì¹˜ ìš°ì„ ìˆœìœ„: ' + valuePriorities.join(', ') + '\\n\\n';

            if (report.innerConflictAnalysis) t += 'â–¸ ë‚´ë©´ ê°ˆë“± ë¶„ì„\\n  ' + report.innerConflictAnalysis + '\\n\\n';
            if (report.conflictPatterns?.length) {
                t += 'â–¸ ê°ˆë“± íŒ¨í„´\\n';
                report.conflictPatterns.forEach(function(p) { t += '  â€¢ ' + p + '\\n'; });
                t += '\\n';
            }

            if (report.stressProfile) t += 'â–¸ ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„: ' + report.stressProfile + '\\n';
            if (report.stressTriggers?.length) {
                t += 'â–¸ ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸\\n';
                report.stressTriggers.forEach(function(s) { t += '  â€¢ ' + s + '\\n'; });
                t += '\\n';
            }
            if (report.failurePattern) t += 'â–¸ ì‹¤íŒ¨ íŒ¨í„´: ' + report.failurePattern + '\\n\\n';

            // ë©”íƒ€ì¸ì§€ (metaCognition)
            const mc = report.metaCognition;
            if (mc) {
                if (mc.strengths?.length) {
                    t += 'â–¸ ë©”íƒ€ì¸ì§€ ê°•ì \\n';
                    mc.strengths.forEach(function(s) { t += '  â€¢ ' + (s.label || s) + (s.detail ? ': ' + s.detail : '') + '\\n'; });
                    t += '\\n';
                }
                if (mc.values?.length) {
                    t += 'â–¸ ë©”íƒ€ì¸ì§€ ê°€ì¹˜\\n';
                    mc.values.forEach(function(v) { t += '  â€¢ ' + (v.label || v) + (v.detail ? ': ' + v.detail : '') + '\\n'; });
                    t += '\\n';
                }
                if (mc.stressPoints?.length) {
                    t += 'â–¸ ìŠ¤íŠ¸ë ˆìŠ¤ í¬ì¸íŠ¸\\n';
                    mc.stressPoints.forEach(function(s) { t += '  â€¢ ' + (s.label || s) + (s.detail ? ': ' + s.detail : '') + '\\n'; });
                    t += '\\n';
                }
            }

            // 5ì¶• ì›Œí¬ìŠ¤íƒ€ì¼ ë§µ
            const wsm = report.workStyleMap;
            if (wsm && (wsm.analytical_vs_creative !== undefined)) {
                t += 'â–¸ 5ì¶• ì›Œí¬ìŠ¤íƒ€ì¼\\n';
                t += '  ë¶„ì„â†”ì°½ì˜: ' + (wsm.analytical_vs_creative || 0) + '\\n';
                t += '  ë…ë¦½â†”í˜‘ì—…: ' + (wsm.solo_vs_team || 0) + '\\n';
                t += '  ì²´ê³„â†”ìœ ì—°: ' + (wsm.structured_vs_flexible || 0) + '\\n';
                t += '  ê¹Šì´â†”ë„“ì´: ' + (wsm.depth_vs_breadth || 0) + '\\n';
                t += '  ê°€ì´ë“œâ†”ììœ¨: ' + (wsm.guided_vs_autonomous || 0) + '\\n\\n';
            }

            // â”€â”€ 3. ì¶”ì²œ ì§ì—… (3ì„¸íŠ¸ ì „ë¶€) â”€â”€
            t += 'â”â”â” ğŸ’¼ ì¶”ì²œ ì§ì—… â”â”â”\\n\\n';

            function formatJobList(jobs, label) {
                if (!jobs || jobs.length === 0) return '';
                let s = 'â–¸ ' + label + '\\n';
                jobs.forEach(function(job, i) {
                    const name = job.job_name || job.job_id || '';
                    const fit = job.scores?.fit || job.fit_score || '-';
                    const like = job.scores?.like || job.like_score || '-';
                    const can = job.scores?.can || job.can_score || '-';
                    const bg = job.feasibility_score || job.feasibilityScore || 0;
                    const desc = (job.job_description || job.description || job.summary || '').replace(/\\n/g, ' ').trim();
                    var scoreStr = '(Fit:' + fit + ' Like:' + like + ' Can:' + can;
                    if (bg > 0) scoreStr += ' Bg:' + bg;
                    scoreStr += ')';
                    s += '  ' + (i+1) + '. ' + name + ' ' + scoreStr + '\\n';
                    if (desc) s += '     ' + desc.substring(0, 100) + (desc.length > 100 ? '...' : '') + '\\n';
                    if (job.like_reason) s += '     ğŸ’œ Like: ' + job.like_reason + '\\n';
                    if (job.can_reason) s += '     ğŸ’ª Can: ' + job.can_reason + '\\n';
                    if (job.dislike_warnings?.length) s += '     âš ï¸ ì£¼ì˜: ' + job.dislike_warnings.join(', ') + '\\n';
                });
                return s + '\\n';
            }

            const overallJobs = (data.overallTop5 || data.fitTop10 || []).slice(0, 5);
            const fitJobs = (data.fitTop10 || []).slice(0, 10);
            const likeJobs = (data.likeTop10 || data.fitTop10 || []).slice(0, 10);

            t += formatJobList(overallJobs, 'ğŸ† ì¢…í•© ì¶”ì²œ Top 5');
            t += formatJobList(fitJobs, 'ğŸ’ª ì˜ í•  ê²ƒ ê°™ì€ ì§ì—… Top 10');
            t += formatJobList(likeJobs, 'ğŸ’– ì¢‹ì•„í• ë§Œí•œ ì§ì—… Top 10');

            // â”€â”€ 4. ì „ë¬¸ê°€ ê°€ì´ë˜ìŠ¤ â”€â”€
            const eg = report.expertGuidance;
            if (eg && (eg.doNow?.length || eg.stopDoing?.length || eg.learnNext?.length || eg.avoidPaths?.length)) {
                t += 'â”â”â” ğŸ¯ ì „ë¬¸ê°€ ê°€ì´ë˜ìŠ¤ â”â”â”\\n\\n';
                if (eg.doNow?.length) { t += 'â–¸ ì§€ê¸ˆ ë‹¹ì¥\\n'; eg.doNow.forEach(function(a){ t += '  â€¢ ' + a + '\\n'; }); t += '\\n'; }
                if (eg.stopDoing?.length) { t += 'â–¸ ë©ˆì¶œ ê²ƒ\\n'; eg.stopDoing.forEach(function(a){ t += '  â€¢ ' + a + '\\n'; }); t += '\\n'; }
                if (eg.learnNext?.length) { t += 'â–¸ ë°°ìš¸ ê²ƒ\\n'; eg.learnNext.forEach(function(a){ t += '  â€¢ ' + a + '\\n'; }); t += '\\n'; }
                if (eg.avoidPaths?.length) { t += 'â–¸ í”¼í•  ê²ƒ\\n'; eg.avoidPaths.forEach(function(a){ t += '  â€¢ ' + a + '\\n'; }); t += '\\n'; }
            }

            // 30/60/90ì¼ ì „í™˜ ê³„íš
            const tt = report.transitionTiming;
            if (tt && (tt.day30?.goal || tt.day60?.goal || tt.day90?.goal)) {
                t += 'â”â”â” ğŸ“… ì „í™˜ ê³„íš â”â”â”\\n\\n';
                ['day30','day60','day90'].forEach(function(key) {
                    const d = tt[key];
                    if (!d?.goal) return;
                    const label = key === 'day30' ? '30ì¼' : key === 'day60' ? '60ì¼' : '90ì¼';
                    t += 'â–¸ ' + label + ': ' + d.goal + '\\n';
                    if (d.actions?.length) d.actions.forEach(function(a){ t += '  â€¢ ' + a + '\\n'; });
                    if (d.milestone) t += '  âœ“ ë§ˆì¼ìŠ¤í†¤: ' + d.milestone + '\\n';
                    t += '\\n';
                });
            }

            // ì¸ìƒ ë²„ì „ ì„ ì–¸ë¬¸
            if (report.lifeVersionStatement?.oneLiner) {
                t += 'â”â”â” âœ¨ ì¸ìƒ ë²„ì „ ì„ ì–¸ë¬¸ â”â”â”\\n\\n';
                t += report.lifeVersionStatement.oneLiner + '\\n\\n';
            }

            // â”€â”€ 5. ë¶„ì„ ìƒì„¸ (DOMì—ì„œ ì¶”ì¶œ - ì ìˆ˜/ê¸°ìˆ  ì •ë³´) â”€â”€
            const detailEl = document.getElementById('tab-details');
            if (detailEl) {
                t += 'â”â”â” ğŸ“Š ë¶„ì„ ìƒì„¸ â”â”â”\\n\\n';
                const wasHidden = detailEl.classList.contains('hidden');
                detailEl.classList.remove('hidden');
                t += detailEl.innerText.trim() + '\\n';
                if (wasHidden) detailEl.classList.add('hidden');
            }

            navigator.clipboard.writeText(t).then(function() {
                alert('ë¦¬í¬íŠ¸ ì „ì²´ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(function(err) {
                const textarea = document.createElement('textarea');
                textarea.value = t;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('ë¦¬í¬íŠ¸ ì „ì²´ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
        
        // ë¶„ì„ ì´ˆê¸°í™” ê¸°ëŠ¥ (í…ŒìŠ¤íŠ¸ìš©)
        function resetAnalyzer() {
            if (!confirm('ì •ë§ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\ní˜„ì¬ê¹Œì§€ì˜ ëª¨ë“  ë‹µë³€ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ draft ë°ì´í„° ì‚­ì œ
            localStorage.removeItem('analyzer_draft');
            localStorage.removeItem('analyzer_draft_timestamp');
            
            // ì„œë²„ì˜ draftë„ ì‚­ì œ ì‹œë„ (ì˜µì…˜)
            fetch('/api/ai-analyzer/draft', {
                method: 'DELETE',
                credentials: 'same-origin'
            }).catch(() => {});
            
            // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            window.currentStep = 1;
            window.currentRound = null;
            window.savedAnswers = {};
            window.collectedCareerState = {};
            window.universalAnswers = {};
            window.narrativeAnswers = {};
            window.roundAnswers = [];
            window.stepScrollPositions = {};
            
            // UI ì´ˆê¸°í™”
            goToStep(1);
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
        }
        
        // ì§ì—… ì„¸íŠ¸ ì „í™˜
        function showJobSet(setId) {
            const data = window.currentReportData;
            if (!data) return;

            let jobList = [];

            if (setId === 'overall') jobList = (data.overallTop5 || data.fitTop10 || []).slice(0, 5);  // ì¢…í•© ì¶”ì²œ: 5ê°œ
            else if (setId === 'fit') jobList = (data.fitTop10 || []).slice(0, 10);  // ì˜ í•  ê²ƒ ê°™ì€ ì§ì—…: 10ê°œ
            else if (setId === 'desire') jobList = (data.likeTop10 || data.fitTop10 || []).slice(0, 10);  // ì¢‹ì•„í• ë§Œí•œ ì§ì—…: 10ê°œ

            // setIdì™€ profileInterpretationì„ ì „ë‹¬í•˜ì—¬ íƒ­ë³„ë¡œ ë‹¤ë¥¸ ì´ìœ  ë° ë§¤ì¹­ íƒœê·¸ í‘œì‹œ
            document.getElementById('job-cards-container').innerHTML = renderJobCardsV3(jobList, setId, data.profileInterpretation);

            document.querySelectorAll('.job-set-tab').forEach(el => el.classList.remove('active'));
            document.querySelector('.job-set-tab[data-set="' + setId + '"]')?.classList.add('active');
        }
        
        // V3 ì§ì—… ì¹´ë“œ ë Œë”ë§ (PremiumReport ë°ì´í„° êµ¬ì¡°ìš©) - ì»´íŒ©íŠ¸ ë””ìì¸
        // setId: 'overall' | 'fit' | 'desire'
        // profileInterp: ProfileInterpretation ë°ì´í„° (ë§¤ì¹­ íƒœê·¸ìš©)
        function renderJobCardsV3(jobs, setId = 'overall', profileInterp = null) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // rationale íŒŒì‹± í—¬í¼ í•¨ìˆ˜
            const extractLikeReason = (r) => {
                if (!r || r.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) return null;
                const match = r.match(/\\[ì¢‹ì•„í•  ì´ìœ \\]\\s*(.+?)(?=\\[|$)/s)
                    || r.match(/\\[1\\]\\s*(.+?)(?=\\[2\\]|$)/s);
                return match ? match[1].trim() : null;
            };
            const extractCanReason = (r) => {
                if (!r || r.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) return null;
                const match = r.match(/\\[ì˜í•  ì´ìœ \\]\\s*(.+?)(?=\\[|$)/s)
                    || r.match(/\\[2\\]\\s*(.+?)(?=\\[3\\]|\\[ë¦¬ìŠ¤í¬\\]|$)/s);
                return match ? match[1].trim() : null;
            };

            return jobs.map((job, idx) => {
                const jobName = job.job_name || job.job_id || 'ì§ì—…';
                const jobSlug = job.slug || job.job_id || '';
                // ì´ë¯¸ì§€ URL ì¸ì½”ë”© (í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬)
                let imageUrl = job.image_url || '';
                if (imageUrl && imageUrl.includes('/uploads/')) {
                    const parts = imageUrl.split('/');
                    const filename = parts.pop();
                    imageUrl = parts.join('/') + '/' + encodeURIComponent(filename);
                }
                const rationale = job.rationale || job.one_line_why || '';
                const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                // fallback 1: rationaleì—ì„œ ì²« ë¬¸ì¥ ì¶”ì¶œ (ìë™ ìƒì„± ì•„ë‹Œ ê²½ìš°)
                // fallback 2: ì§ì—…ëª… ê¸°ë°˜ ê¸°ë³¸ ì„¤ëª…
                const displayDescription = description
                    || (rationale && !rationale.includes('ìë™ ìƒì„±') ? rationale.split('.')[0] + '.' : '')
                    || \`\${jobName} ì§ì—…ì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”.\`;
                const dislikeWarnings = job.dislike_warnings || [];
                const fitScore = job.scores?.fit || job.fit_score || '-';
                const likeScore = job.scores?.like || job.like_score || '-';
                const canScore = job.scores?.can || job.can_score || '-';

                // íƒ­ë³„ ì£¼ì ìˆ˜ ë° ì´ìœ  ê²°ì •
                let mainScore, mainScoreLabel, mainScoreColor;
                let likeReasonText = job.like_reason || extractLikeReason(rationale) || '';
                let canReasonText = job.can_reason || extractCanReason(rationale) || '';

                // ìë™ ìƒì„± ê²°ê³¼ í•„í„°ë§
                const isAutoGenerated = rationale.includes('ìë™ ìƒì„±ëœ ê²°ê³¼') || rationale.includes('LLM ë¶„ì„ì´ ì§„í–‰ë˜ì§€');
                if (likeReasonText.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) likeReasonText = '';
                if (canReasonText.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) canReasonText = '';

                // LLM ë¶„ì„ ì—†ì´ ìë™ ìƒì„±ëœ ê²½ìš°, ì ìˆ˜ ê¸°ë°˜ ê¸°ë³¸ ì´ìœ  ìƒì„±
                if (!likeReasonText && !isAutoGenerated && rationale && !rationale.includes('[')) {
                    likeReasonText = rationale;  // ì¼ë°˜ rationaleì„ like ì´ìœ ë¡œ ì‚¬ìš©
                }
                if (!likeReasonText && likeScore !== '-') {
                    const score = parseInt(likeScore) || 0;
                    if (score >= 70) likeReasonText = 'ë‹¹ì‹ ì˜ ê´€ì‹¬ì‚¬ì™€ ê°€ì¹˜ê´€ì— ì˜ ë§ëŠ” ì§ì—…ì…ë‹ˆë‹¤.';
                    else if (score >= 50) likeReasonText = 'í¥ë¯¸ë¡œìš´ ì—…ë¬´ í™˜ê²½ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (!canReasonText && canScore !== '-') {
                    const score = parseInt(canScore) || 0;
                    if (score >= 70) canReasonText = 'ë‹¹ì‹ ì˜ ê°•ì ì„ ì˜ ë°œíœ˜í•  ìˆ˜ ìˆëŠ” ë¶„ì•¼ì…ë‹ˆë‹¤.';
                    else if (score >= 50) canReasonText = 'ì„±ì¥ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë¶„ì•¼ì…ë‹ˆë‹¤.';
                }

                if (setId === 'desire') {
                    mainScore = likeScore;
                    mainScoreLabel = 'Like';
                    mainScoreColor = 'text-purple-400';
                } else if (setId === 'fit') {
                    mainScore = canScore;
                    mainScoreLabel = 'Can';
                    mainScoreColor = 'text-blue-400';
                } else {
                    mainScore = fitScore;
                    mainScoreLabel = 'Fit';
                    mainScoreColor = 'text-emerald-400';
                }

                // ì´ìœ  HTML ìƒì„± (ì¹´ë“œ ë‚´ë¶€ì— í‘œì‹œ)
                let reasonOuterHtml = '';
                if (setId === 'overall') {
                    if (likeReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">ğŸ’œ Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
                    if (canReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">ğŸ’ª Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
                } else if (setId === 'desire') {
                    if (likeReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">ğŸ’œ Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
                } else {
                    if (canReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">ğŸ’ª Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
                }

                const rankBadge = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : \`\${idx + 1}\`;
                const rankColor = idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,116,139,0.4)';

                // B: í”„ë¡œí•„ ë§¤ì¹­ í¬ì¸íŠ¸ ìƒì„±
                const matchingTags = [];
                const likeNum = parseInt(likeScore) || 0;
                const canNum = parseInt(canScore) || 0;
                const riskPenalty = job.riskPenalty || job.risk_penalty || 0;
                const bgScore = job.feasibility_score || job.feasibilityScore || 0;

                // profileInterpretationì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
                const pi = profileInterp || {};
                const interestLabels = (pi.interests || []).slice(0, 2).map(i => i.label);
                const strengthLabels = (pi.strengths || []).slice(0, 2).map(s => s.label);
                const constraintLabels = (pi.constraints || []).slice(0, 1).map(c => c.label);

                // Like ì ìˆ˜ ê¸°ë°˜ í¥ë¯¸/ê°€ì¹˜ ë§¤ì¹­
                if (likeNum >= 65 && interestLabels.length > 0) {
                    matchingTags.push({ icon: 'ğŸ’š', label: interestLabels[0] + ' í¥ë¯¸', color: 'green' });
                }
                // Can ì ìˆ˜ ê¸°ë°˜ ê°•ì  ë§¤ì¹­
                if (canNum >= 65 && strengthLabels.length > 0) {
                    matchingTags.push({ icon: 'ğŸ’ª', label: strengthLabels[0] + ' ê°•ì ', color: 'blue' });
                }
                // ì œì•½ ì¶©ì¡± (Risk í˜ë„í‹° ì—†ìŒ)
                if (riskPenalty <= 5 && constraintLabels.length > 0) {
                    matchingTags.push({ icon: 'âœ…', label: 'ì œì•½ ì¶©ì¡±', color: 'emerald' });
                }

                const matchingTagsHtml = matchingTags.length > 0 ? \`
                    <div class="flex flex-wrap gap-1.5 mt-2">
                        \${matchingTags.map(tag => \`
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs"
                                  style="background: rgba(\${tag.color === 'green' ? '34,197,94' : tag.color === 'blue' ? '59,130,246' : '16,185,129'},0.15); color: rgb(\${tag.color === 'green' ? '134,239,172' : tag.color === 'blue' ? '147,197,253' : '110,231,183'});">
                                <span>\${tag.icon}</span>
                                <span>\${tag.label}</span>
                            </span>
                        \`).join('')}
                    </div>
                \` : '';

                // ì ìˆ˜ ë°” ë„ˆë¹„ ê³„ì‚° (0-100)
                const fitNum = parseInt(fitScore) || 0;
                const likeNum2 = parseInt(likeScore) || 0;
                const canNum2 = parseInt(canScore) || 0;

                return \`
                <div class="rounded-2xl overflow-hidden group transition-all mb-4" style="background: linear-gradient(135deg, rgba(30,30,50,0.9), rgba(25,25,45,0.95)); border: 1px solid rgba(99,102,241,\${idx < 3 ? '0.25' : '0.12'});">
                    <!-- ìƒë‹¨: ì¸ë„¤ì¼ + ì§ì—… ì •ë³´ -->
                    <div class="flex items-stretch">
                        <!-- ì¸ë„¤ì¼ (ì¹´ë“œ ë†’ì´ ê½‰ ì±„ì›€) -->
                        \${imageUrl && imageUrl.trim() ? \`
                            <div class="flex-shrink-0 w-28 sm:w-32 relative overflow-hidden">
                                <img src="\${imageUrl}" alt="\${jobName}"
                                     class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center\\' style=\\'background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));\\' ><i class=\\'fas fa-briefcase text-2xl text-wiki-muted\\'></i></div>';" />
                                <div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
                                    <span class="\${idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted'}">\${rankBadge}</span>
                                </div>
                            </div>
                        \` : \`
                            <div class="flex-shrink-0 w-28 sm:w-32 relative flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));">
                                <i class="fas fa-briefcase text-2xl text-wiki-muted"></i>
                                <div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6);">
                                    <span class="\${idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted'}">\${rankBadge}</span>
                                </div>
                            </div>
                        \`}

                        <!-- ì§ì—… ì •ë³´ + ì ìˆ˜ -->
                        <div class="flex-1 min-w-0 p-4 flex flex-col justify-between">
                            <div>
                                <!-- ì§ì—…ëª… + ë©”ì¸ ì ìˆ˜ -->
                                <div class="flex items-start justify-between gap-3 mb-1.5">
                                    <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="group-hover:text-wiki-primary transition">
                                        <h4 class="font-bold text-lg text-white leading-tight">\${jobName}</h4>
                                    </a>
                                    <div class="flex-shrink-0 text-right">
                                        <span class="text-xl font-bold \${mainScoreColor}">\${mainScore}</span>
                                        <span class="text-xs text-wiki-muted ml-0.5">\${mainScoreLabel}</span>
                                    </div>
                                </div>

                                <!-- ì§ì—… ì„¤ëª… -->
                                \${displayDescription ? \`<p class="text-[14px] text-wiki-muted line-clamp-2 leading-relaxed mb-2">\${displayDescription}</p>\` : ''}

                                <!-- ë§¤ì¹­ íƒœê·¸ -->
                                \${matchingTagsHtml}
                                \${dislikeWarnings.length > 0 ? \`
                                    <p class="text-[13px] text-orange-400/80 line-clamp-1 mt-1.5">âš ï¸ \${dislikeWarnings[0]?.label || ''}</p>
                                \` : ''}
                            </div>

                            <!-- ì ìˆ˜ ë°” -->
                            <div class="flex items-center gap-3 mt-3 pt-2.5" style="border-top: 1px solid rgba(255,255,255,0.06);">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-emerald-400/80 font-medium">Fit</span>
                                        <span class="text-[11px] text-emerald-400 font-semibold">\${fitScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(fitNum, 100)}%; background: rgb(52,211,153);"></div>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-purple-400/80 font-medium">Like</span>
                                        <span class="text-[11px] text-purple-400 font-semibold">\${likeScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(likeNum2, 100)}%; background: rgb(168,85,247);"></div>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-blue-400/80 font-medium">Can</span>
                                        <span class="text-[11px] text-blue-400 font-semibold">\${canScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(canNum2, 100)}%; background: rgb(96,165,250);"></div>
                                    </div>
                                </div>
                                \${parseInt(bgScore) > 0 ? \`<div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-amber-400/80 font-medium">Bg</span>
                                        <span class="text-[11px] text-amber-400 font-semibold">\${bgScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(parseInt(bgScore) || 0, 100)}%; background: rgb(251,191,36);"></div>
                                    </div>
                                </div>\` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- í•˜ë‹¨: ì¶”ì²œ ì´ìœ  (Like/Can) -->
                    \${reasonOuterHtml ? \`
                    <div class="px-4 pb-4 pt-0">
                        <div class="p-3 rounded-xl space-y-2" style="background: rgba(99,102,241,0.06); border: 1px solid rgba(99,102,241,0.1);">
                            \${reasonOuterHtml}
                        </div>
                    </div>
                    \` : ''}

                    <!-- í•˜ë‹¨ ì•¡ì…˜ ë°” -->
                    <div class="flex items-center justify-between px-4 pb-3 \${reasonOuterHtml ? '' : 'pt-0'}">
                        <button onclick="event.stopPropagation(); toggleJobScoresCompact(this)" class="text-[13px] text-wiki-muted hover:text-wiki-primary transition flex items-center gap-1.5" title="ìƒì„¸ ì ìˆ˜">
                            <i class="fas fa-chart-bar"></i>
                            <span>ìƒì„¸ ì ìˆ˜</span>
                        </button>
                        \${jobSlug ? \`<a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="text-[13px] text-wiki-primary hover:text-indigo-300 font-medium transition flex items-center gap-1">
                            <span>ìƒì„¸ ë³´ê¸°</span>
                            <i class="fas fa-arrow-right text-[11px]"></i>
                        </a>\` : ''}
                    </div>

                    <!-- ì ìˆ˜ ìƒì„¸ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                    <div class="score-details-compact hidden px-4 pb-3">
                        <div class="p-3 rounded-lg" style="background-color: rgba(26,26,46,0.5);">
                            \${getScoreExplanation(likeScore, canScore, fitScore, riskPenalty, bgScore)}
                        </div>
                    </div>
                </div>
                \`;
            }).join('');
        }
        
        // ì»´íŒ©íŠ¸ ì ìˆ˜ í† ê¸€
        function toggleJobScoresCompact(btn) {
            const card = btn.closest('.rounded-2xl');
            if (!card) return;
            const details = card.querySelector('.score-details-compact');
            if (details) {
                details.classList.toggle('hidden');
            }
        }
        window.toggleJobScoresCompact = toggleJobScoresCompact;
        
        // (ê¸°ì¡´ í° ì¹´ë“œìš© í•¨ìˆ˜ ìœ ì§€ - í˜¸í™˜ì„±)
        function renderJobCardsV3Large(jobs) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            return jobs.map((job, idx) => {
                const jobName = job.job_name || job.job_id || 'ì§ì—…';
                const jobSlug = job.slug || job.job_id || '';
                const imageUrl = job.image_url || '';
                const rationale = job.rationale || job.one_line_why || '';
                const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                const growthPath = job.growth_path || job.first30DaysPlan || [];
                const risks = job.risks || [];
                const dislikeWarnings = job.dislike_warnings || [];
                const fitScore = job.scores?.fit || job.fit_score || '-';
                const likeScore = job.scores?.like || job.like_score || '-';
                const canScore = job.scores?.can || job.can_score || '-';
                const riskPenalty = job.riskPenalty || job.risk_penalty || job.scores?.risk_penalty || 0;
                const bgScore = job.feasibility_score || job.feasibilityScore || 0;

                return \`
                <div class="glass-card p-5 rounded-xl group" style="border-left: 4px solid \${idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,100,120,0.3)'};">
                    <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        \${imageUrl ? \`
                            <div class="mb-4 overflow-hidden rounded-lg" style="aspect-ratio: 16/9;">
                                <img src="\${imageUrl}" alt="\${jobName}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">\${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'ğŸ“Œ'}</span>
                                <div>
                                    <h4 class="font-bold text-lg group-hover:text-wiki-primary transition">\${jobName}</h4>
                                    <span class="text-xs text-wiki-primary">ìì„¸íˆ ë³´ê¸° â†’</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    \${dislikeWarnings.length > 0 ? \`
                        <div class="p-2 rounded-lg mb-3" style="background-color: rgba(251,146,60,0.15); border: 1px solid rgba(251,146,60,0.3);">
                            <div class="text-xs space-y-1">
                                \${dislikeWarnings.map(w => \`<div class="\${w.severity === 'high' ? 'text-orange-400 font-medium' : 'text-amber-400/80'}">\${w.label}</div>\`).join('')}
                            </div>
                        </div>
                    \` : ''}
                    \${rationale ? \`
                        <div class="mb-3 p-3 rounded-lg" style="background-color: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.15);">
                            <div class="text-xs font-medium text-emerald-400 mb-1">ğŸ’¡ ì¶”ì²œ ì´ìœ </div>
                            <p class="text-sm text-white/90">\${rationale}</p>
                        </div>
                    \` : ''}
                    \${description ? \`<p class="text-sm text-wiki-muted/80 mb-3 line-clamp-2">\${description}</p>\` : ''}
                    \${growthPath.length > 0 ? \`
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(99,102,241,0.1);">
                            <div class="text-xs font-medium text-indigo-400 mb-2">ğŸš€ ì„±ì¥ ê²½ë¡œ</div>
                            <ol class="text-xs text-wiki-muted space-y-1 list-decimal list-inside">
                                \${growthPath.slice(0, 3).map(p => \`<li>\${p}</li>\`).join('')}
                            </ol>
                        </div>
                    \` : ''}
                    \${risks.length > 0 ? \`
                        <div class="p-2 rounded-lg mb-3" style="background-color: rgba(239,68,68,0.1);">
                            <div class="text-xs text-red-400">\${risks.slice(0, 2).map(r => 'âš ï¸ ' + r).join(' Â· ')}</div>
                        </div>
                    \` : ''}
                    <div class="flex items-center gap-3 mt-2 flex-wrap">
                        <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition">
                            <i class="fas fa-info-circle"></i>
                            <span>ìƒì„¸ ì ìˆ˜</span>
                            <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                        </button>
                        <button onclick="showJobEvidence('\${job.job_id || job.slug}', '\${jobName}')" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-emerald-400 transition evidence-trigger">
                            <i class="fas fa-search"></i>
                            <span>ê·¼ê±° ë³´ê¸°</span>
                        </button>
                    </div>
                    <div class="score-details hidden mt-3 pt-3 border-t border-wiki-border/30">
                        <div class="p-3 rounded-lg" style="background-color: rgba(26,26,46,0.5);">
                            \${getScoreExplanation(likeScore, canScore, fitScore, riskPenalty, bgScore)}
                        </div>
                    </div>
                </div>
                \`;
            }).join('');
        }

        // ì§ì—… ì¹´ë“œ ë Œë”ë§
        function renderJobCards(jobs, setId) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            return jobs.map((job, idx) => \`
                <div class="glass-card p-5 rounded-xl group" style="border-left: 4px solid \${idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,100,120,0.3)'};">
                    <!-- í´ë¦­ ê°€ëŠ¥í•œ ìƒë‹¨ ì˜ì—­ -->
                    <a href="/job/\${job.slug || job.job_id}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ -->
                        \${job.image_url ? \`
                            <div class="mb-4 overflow-hidden rounded-lg">
                                <img src="\${job.image_url}" alt="\${job.job_name}" class="w-full h-40 object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">\${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'ğŸ“Œ'}</span>
                                <div>
                                    <h4 class="font-bold text-lg group-hover:text-wiki-primary transition">\${job.job_name}</h4>
                                    <span class="text-xs text-wiki-primary">ìì„¸íˆ ë³´ê¸° â†’</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    
                    <!-- ì¶”ì²œ ì´ìœ  -->
                    \${job.rationale ? \`
                        <p class="text-sm text-wiki-muted mb-3">\${job.rationale}</p>
                    \` : ''}
                    
                    <!-- 30ì¼ í”Œëœ -->
                    \${job.first30DaysPlan?.length > 0 ? \`
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(99,102,241,0.1);">
                            <div class="text-xs font-medium text-indigo-400 mb-2">ğŸš€ 30ì¼ ì‹¤í–‰ í”Œëœ</div>
                            <ol class="text-xs text-wiki-muted space-y-1 list-decimal list-inside">
                                \${job.first30DaysPlan.map(p => \`<li>\${p}</li>\`).join('')}
                            </ol>
                        </div>
                    \` : ''}
                    
                    <!-- ìƒì„¸ ì ìˆ˜ í† ê¸€ ë²„íŠ¼ -->
                    <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>ìƒì„¸ ì ìˆ˜ ë³´ê¸°</span>
                        <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                    </button>
                    
                    <!-- ì ìˆ˜ ìƒì„¸ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                    <div class="score-details hidden mt-3 pt-3 border-t border-wiki-border/30">
                        <!-- ì ìˆ˜ ì‚°ì¶œ ê³¼ì • -->
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(26,26,46,0.5);">
                            \${getScoreExplanation(job.desireScore || job.like_score, job.feasibilityScore || job.can_score, job.fitScore || job.fit_score, job.riskPenalty || job.risk_penalty || 0, job.feasibilityScore || job.feasibility_score || 0)}
                        </div>
                        
                        <!-- ë¦¬ìŠ¤í¬ í”Œë˜ê·¸ -->
                        \${job.riskFlags?.length > 0 ? \`
                            <div class="flex flex-wrap gap-1 mb-3">
                                \${job.riskFlags.map(f => \`<span class="px-2 py-0.5 bg-red-500/20 text-red-300 rounded text-xs">âš ï¸ \${f}</span>\`).join('')}
                            </div>
                        \` : ''}
                        
                        <!-- ê·¼ê±° ì¸ìš© -->
                        \${job.evidenceQuotes?.length > 0 ? \`
                            <div class="p-3 rounded-lg" style="background-color: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2);">
                                <div class="text-xs font-medium text-amber-400 mb-2">ğŸ“ ê·¼ê±° ì¸ìš©</div>
                                <ul class="text-xs text-wiki-muted space-y-1">
                                    \${job.evidenceQuotes.slice(0, 3).map(eq => \`<li>"<em>\${eq.text}</em>"</li>\`).join('')}
                                </ul>
                            </div>
                        \` : ''}
                    </div>
                </div>
            \`).join('');
        }
        
        // ì ìˆ˜ ì‚°ì¶œ ê³¼ì • ì„¤ëª… ìƒì„±
        function getScoreExplanation(likeVal, canVal, fitVal, riskVal, bgVal) {
            const like = parseInt(likeVal) || 0;
            const can = parseInt(canVal) || 0;
            const fit = parseInt(fitVal) || 0;
            const risk = parseFloat(riskVal) || 0;
            const bg = parseInt(bgVal) || 0;
            let html = '<div class="space-y-2.5 text-[13px]">';
            html += '<div class="flex items-center justify-between"><span class="text-purple-400">ğŸ’œ í¥ë¯¸(Like)</span><span class="text-purple-300 font-medium">' + like + 'ì </span></div>';
            html += '<div class="flex items-center justify-between"><span class="text-blue-400">ğŸ’ª ì—­ëŸ‰(Can)</span><span class="text-blue-300 font-medium">' + can + 'ì </span></div>';
            if (bg > 0) {
                html += '<div class="flex items-center justify-between"><span class="text-amber-400">ğŸ“ ë°°ê²½(Background)</span><span class="text-amber-300 font-medium">' + bg + 'ì </span></div>';
            }
            if (risk > 0) {
                html += '<div class="flex items-center justify-between"><span class="text-red-400">âš ï¸ ë¦¬ìŠ¤í¬ ê°ì </span><span class="text-red-300 font-medium">âˆ’' + risk + '</span></div>';
            }
            html += '<div class="border-t border-wiki-border/30 pt-2 mt-1 flex items-center justify-between"><span class="text-emerald-400 font-medium">= ì í•©ë„(Fit)</span><span class="text-emerald-400 font-bold text-base">' + fit + 'ì </span></div>';
            html += '</div>';
            return html;
        }

        // ì ìˆ˜ ìƒì„¸ í† ê¸€
        function toggleJobScores(btn) {
            const card = btn.closest('.glass-card');
            const details = card.querySelector('.score-details');
            const icon = btn.querySelector('.score-toggle-icon');
            const label = btn.querySelector('span');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                label.textContent = 'ìˆ¨ê¸°ê¸°';
            } else {
                details.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
                label.textContent = 'ìƒì„¸ ì ìˆ˜';
            }
        }
        window.toggleJobScores = toggleJobScores;
        
        // ============================================
        // Evidence ëª¨ë‹¬ ì‹œìŠ¤í…œ
        // ============================================
        function showJobEvidence(jobId, jobName) {
            const data = window.currentReportData;
            if (!data || !data.evidenceMap) {
                showErrorToast('ê·¼ê±° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const evidenceLinks = data.evidenceMap[jobId] || [];
            
            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'evidence-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.cssText = 'background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
            modal.onclick = (e) => { if (e.target === modal) closeEvidenceModal(); };
            
            // ë§¤ì¹­ íƒ€ì…ë³„ ë³´ë” ìƒ‰ìƒ
            const borderColors = {
                positive: 'rgba(16,185,129,0.6)',
                neutral: 'rgba(148,163,184,0.4)',
                negative: 'rgba(239,68,68,0.5)',
            };
            
            // ì¶œì²˜ ë¼ë²¨ ë§¤í•‘
            const sourceLabels = {
                'step1': '1ë‹¨ê³„: ê¸°ë³¸ì •ë³´',
                'step2': '2ë‹¨ê³„: ì„ í˜¸ë„',
                'step3': '3ë‹¨ê³„: ë°©í–¥ì„¤ì •',
                'narrative': 'ì„œìˆ í˜• ì§ˆë¬¸',
                'round1': 'ì‹¬ì¸µì§ˆë¬¸ Round 1',
                'round2': 'ì‹¬ì¸µì§ˆë¬¸ Round 2',
                'round3': 'ì‹¬ì¸µì§ˆë¬¸ Round 3',
                'mini_module': 'ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°',
            };
            
            modal.innerHTML = \`
                <div class="relative max-w-2xl w-full max-h-[85vh] overflow-y-auto rounded-2xl p-6" 
                     style="background: linear-gradient(135deg, rgba(26,26,46,0.98), rgba(15,15,35,0.98)); border: 1px solid rgba(99,102,241,0.3);">
                    <!-- ë‹«ê¸° ë²„íŠ¼ -->
                    <button onclick="closeEvidenceModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-white/10" style="color: rgb(148,163,184);">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <!-- í—¤ë” -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-quote-left text-emerald-400"></i>
                            <span>\${jobName} ì¶”ì²œ ê·¼ê±°</span>
                        </h3>
                        <p class="text-sm text-wiki-muted mt-1">ì•„ë˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ ì§ì—…ì´ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤</p>
                    </div>
                    
                    <!-- Evidence ëª©ë¡ (ì¸ìš© ìŠ¤íƒ€ì¼) -->
                    \${evidenceLinks.length > 0 ? \`
                        <div class="space-y-3">
                            \${evidenceLinks.map((ev, idx) => {
                                const borderColor = borderColors[ev.match_type] || borderColors.neutral;
                                const sourceKey = ev.user_fact?.source?.split('.')[0] || 'unknown';
                                const sourceLabel = sourceLabels[sourceKey] || ev.user_fact?.source || 'ì‚¬ìš©ì ì…ë ¥';
                                
                                return \`
                                    <div class="pl-4 py-2" style="border-left: 3px solid \${borderColor};">
                                        <!-- ì¸ìš©ë¬¸ (ì‚¬ìš©ì ë‹µë³€) -->
                                        <p class="text-sm text-white/90 italic mb-1">
                                            "\${ev.user_fact?.label || ev.user_fact?.value || '(ë°ì´í„° ì—†ìŒ)'}"
                                        </p>
                                        
                                        <!-- ì¶œì²˜ -->
                                        <div class="flex items-center gap-2 text-xs text-wiki-muted">
                                            <i class="fas fa-bookmark"></i>
                                            <span>ì¶œì²˜: \${sourceLabel}</span>
                                        </div>
                                        
                                        <!-- ë§¤ì¹­ ì„¤ëª… (ìˆìœ¼ë©´) -->
                                        \${ev.explanation ? \`
                                            <div class="mt-2 p-2 rounded-lg" style="background-color: rgba(99,102,241,0.08);">
                                                <p class="text-xs text-indigo-300/80">
                                                    <i class="fas fa-link mr-1"></i>
                                                    \${ev.explanation}
                                                </p>
                                            </div>
                                        \` : ''}
                                        
                                        <!-- ì§ì—… íŠ¹ì„± ë§¤ì¹­ -->
                                        \${ev.job_attribute?.label ? \`
                                            <div class="mt-1 text-xs text-wiki-muted/70">
                                                â†’ ì§ì—… íŠ¹ì„±: \${ev.job_attribute.label}
                                            </div>
                                        \` : ''}
                                    </div>
                                \`;
                            }).join('')}
                        </div>
                    \` : \`
                        <div class="text-center py-12">
                            <i class="fas fa-quote-left text-4xl text-wiki-muted/30 mb-4"></i>
                            <p class="text-wiki-muted">ì•„ì§ êµ¬ì²´ì ì¸ ê·¼ê±° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm text-wiki-muted/60 mt-2">ì‹¬ì¸µ ì§ˆë¬¸ì— ë” ìì„¸íˆ ë‹µë³€í•˜ì‹œë©´ ê·¼ê±°ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                        </div>
                    \`}
                    
                    <!-- ë‹«ê¸° ë²„íŠ¼ -->
                    <div class="mt-6 pt-4 border-t border-wiki-border/30 text-center">
                        <button onclick="closeEvidenceModal()" class="px-6 py-2 rounded-lg text-sm font-medium transition" 
                                style="background: rgba(99,102,241,0.2); color: rgb(165,180,252); border: 1px solid rgba(99,102,241,0.3);">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        window.showJobEvidence = showJobEvidence;
        
        function closeEvidenceModal() {
            const modal = document.getElementById('evidence-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        window.closeEvidenceModal = closeEvidenceModal;
        
        // Work Style ë°” ë Œë”ë§
        function renderWorkStyleBar(leftLabel, rightLabel, value) {
            const normalizedValue = ((value || 0) + 100) / 2; // -100~100 â†’ 0~100
            return \`
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-16 text-right text-wiki-muted">\${leftLabel}</span>
                    <div class="flex-1 h-2 bg-wiki-border rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-wiki-primary to-wiki-secondary transition-all" style="width: \${normalizedValue}%"></div>
                    </div>
                    <span class="w-16 text-wiki-muted">\${rightLabel}</span>
                </div>
            \`;
        }
        
        // ì „í™˜ ì¼ì • ë Œë”ë§
        function renderTransitionDay(day, data) {
            if (!data) return '';
            const colors = { 30: 'emerald', 60: 'blue', 90: 'purple' };
            const color = colors[day] || 'gray';
            
            return \`
                <div class="p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(var(--\${color}-rgb, 16,185,129), 0.1), transparent); border: 1px solid rgba(var(--\${color}-rgb, 16,185,129), 0.2);">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-\${color}-500/20 flex items-center justify-center text-\${color}-400 font-bold">\${day}</div>
                        <div>
                            <div class="font-bold">Day \${day}</div>
                            <div class="text-sm text-wiki-muted">\${data.goal}</div>
                        </div>
                    </div>
                    <ul class="text-sm space-y-1 mb-3">
                        \${(data.actions || []).map(a => \`<li>â€¢ \${a}</li>\`).join('')}
                    </ul>
                    <div class="text-xs text-wiki-muted">ğŸ“ ë§ˆì¼ìŠ¤í†¤: \${data.milestone}</div>
                </div>
            \`;
        }
        
        // ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€
        function addReportStyles() {
            if (document.getElementById('report-v3-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'report-v3-styles';
            style.textContent = \`
                .report-tab {
                    background-color: rgba(26,26,46,0.5);
                    color: rgb(148,163,184);
                }
                .report-tab:hover {
                    background-color: rgba(42,42,62,0.5);
                }
                .report-tab.active {
                    background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(168,85,247,0.2));
                    color: white;
                    border: 1px solid rgba(99,102,241,0.5);
                }
                .job-set-tab {
                    background: linear-gradient(135deg, rgba(26,26,46,0.7), rgba(42,42,62,0.5));
                    color: rgb(148,163,184);
                    border: 1px solid rgba(148,163,184,0.15);
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .job-set-tab:hover {
                    background: linear-gradient(135deg, rgba(42,42,62,0.8), rgba(62,62,82,0.6));
                    color: rgb(200,210,220);
                    border-color: rgba(148,163,184,0.3);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
                .job-set-tab.active {
                    background: linear-gradient(135deg, rgba(99,102,241,0.4), rgba(168,85,247,0.25));
                    color: white;
                    border: 1px solid rgba(99,102,241,0.5);
                    box-shadow: 0 4px 16px rgba(99,102,241,0.25);
                }
            \`;
            document.head.appendChild(style);
        }
        
        function displayConfidenceUI(result) {
            const card = document.getElementById('confidence-card');
            if (!card) return;
            
            // confidence_score ê³„ì‚° (ì„œë²„ì—ì„œ ì•ˆ ì™”ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¶”ì •)
            let confidenceScore = result.confidence_score;
            if (confidenceScore === undefined) {
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°„ë‹¨íˆ ì¶”ì •: ì‘ë‹µí•œ ì§ˆë¬¸ ìˆ˜ ê¸°ë°˜
                const answeredCount = Object.keys(universalAnswers).length + 
                                     Object.keys(transitionSignalAnswers).length + 
                                     Object.keys(followupAnswers).length;
                confidenceScore = Math.min(0.4 + (answeredCount * 0.06), 0.95);
            }
            
            const percentage = Math.round(confidenceScore * 100);
            
            // ê²Œì´ì§€ë°” ì—…ë°ì´íŠ¸
            document.getElementById('confidence-score-text').textContent = percentage + '%';
            document.getElementById('confidence-bar').style.width = percentage + '%';
            
            // ì„¤ëª… í…ìŠ¤íŠ¸
            let description = '';
            if (percentage >= 80) {
                description = 'ì¶©ë¶„í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ ë¢°ë„ ë†’ì€ ì¶”ì²œì´ì—ìš”.';
            } else if (percentage >= 60) {
                description = 'ê¸°ë³¸ì ì¸ ì¶”ì²œì€ ê°€ëŠ¥í•˜ì§€ë§Œ, ë” ë§ì€ ì •ë³´ê°€ ìˆìœ¼ë©´ ì •í™•ë„ê°€ ì˜¬ë¼ê°€ìš”.';
            } else {
                description = 'ì œí•œëœ ì •ë³´ë¡œ ì¶”ì²œí–ˆì–´ìš”. ì¶”ê°€ ì§ˆë¬¸ì— ë‹µë³€í•˜ì‹œë©´ ë” ì •í™•í•´ì ¸ìš”.';
            }
            document.getElementById('confidence-description').textContent = description;
            
            // ê²°ì • ë³€ìˆ˜ í‘œì‹œ
            const keyDecisions = result.key_decision_variables || generateKeyDecisions();
            const decisionsHtml = keyDecisions.map(kd => \`
                <div class="flex items-start gap-3 p-2 bg-wiki-bg/50 rounded-lg">
                    <span class="text-amber-400">â€¢</span>
                    <div class="flex-1">
                        <span class="text-sm">\${kd.label || kd.fact_key || kd}</span>
                        \${kd.impact ? \`<span class="text-xs text-wiki-muted ml-2">(ì˜í–¥ë„: \${kd.impact})</span>\` : ''}
                    </div>
                </div>
            \`).join('');
            document.getElementById('key-decisions').innerHTML = decisionsHtml || '<p class="text-wiki-muted text-sm">ê²°ì • ë³€ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            card.classList.remove('hidden');
        }
        
        function generateKeyDecisions() {
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‘ë‹µ ê¸°ë°˜ìœ¼ë¡œ ê²°ì • ë³€ìˆ˜ ìƒì„±
            const decisions = [];
            
            // 5ì¶• ìƒíƒœì—ì„œ
            if (careerState.role_identity) {
                const opt = ROLE_IDENTITY_OPTIONS.find(o => o.value === careerState.role_identity);
                decisions.push({ label: 'í˜„ì¬ ìƒíƒœ: ' + (opt?.label || careerState.role_identity), fact_key: 'state.role_identity' });
            }
            if (careerState.transition_status && careerState.transition_status !== 'none') {
                const opt = TRANSITION_STATUS_OPTIONS.find(o => o.value === careerState.transition_status);
                decisions.push({ label: 'ì „í™˜ ìƒíƒœ: ' + (opt?.label || careerState.transition_status), fact_key: 'state.transition_status' });
            }
            
            // Universal ë‹µë³€ì—ì„œ
            if (universalAnswers.univ_interest?.length > 0) {
                decisions.push({ label: 'ê´€ì‹¬ ë¶„ì•¼: ' + universalAnswers.univ_interest.slice(0, 3).join(', '), fact_key: 'profile.interest' });
            }
            if (universalAnswers.univ_priority) {
                decisions.push({ label: 'ìš°ì„ ìˆœìœ„: ' + universalAnswers.univ_priority, fact_key: 'priority.top1' });
            }
            
            // ì „ì´ ì‹ í˜¸ì—ì„œ
            if (transitionSignalAnswers.trans_desired_type?.length > 0) {
                decisions.push({ label: 'ì›í•˜ëŠ” ë³€í™”: ' + transitionSignalAnswers.trans_desired_type.slice(0, 2).join(', '), fact_key: 'transition.desired_type' });
            }
            if (transitionSignalAnswers.trans_motivation) {
                decisions.push({ label: 'ë³€í™” ë™ê¸°: ' + transitionSignalAnswers.trans_motivation, fact_key: 'transition.motivation_primary' });
            }
            
            return decisions.slice(0, 5);
        }
        
        function displayUserInsight(insight) {
            const card = document.getElementById('user-insight-card');
            if (!insight || !insight.summary) {
                card.classList.add('hidden');
                return;
            }
            
            card.classList.remove('hidden');
            document.getElementById('insight-summary').textContent = insight.summary;
            
            const traitsHtml = (insight.key_traits || []).map(t => \`
                <div class="flex items-start gap-3 p-3 bg-purple-500/10 rounded-lg">
                    <span class="text-xl">ğŸ’¡</span>
                    <div>
                        <div class="font-semibold text-purple-300">\${t.trait}</div>
                        <div class="text-sm text-wiki-muted">\${t.evidence}</div>
                        <div class="text-xs text-green-400 mt-1">â†’ \${t.score_impact}</div>
                    </div>
                </div>
            \`).join('');
            document.getElementById('insight-traits').innerHTML = traitsHtml;
            
            if (insight.applied_facts?.length > 0) {
                document.getElementById('insight-applied-facts').classList.remove('hidden');
                document.getElementById('insight-facts-list').textContent = 
                    insight.applied_facts.map(f => f.effect_summary).join(', ');
            }
        }
        
        function updateDebugPanel(result, data) {
            const debugInfo = result.debug_info;
            
            // 1. Candidate Source
            const sourceEl = document.getElementById('debug-candidate-source');
            if (sourceEl) {
                if (debugInfo) {
                    const sourceLabel = {
                        'tagged': 'ğŸ·ï¸ tagged (DB)',
                        'sample_fallback': 'âš ï¸ sample_fallback',
                        'vector': 'ğŸ” vector',
                        'random': 'ğŸ² random'
                    }[debugInfo.candidate_source] || debugInfo.candidate_source;
                    sourceEl.innerHTML = \`
                        <span class="text-yellow-400">\${sourceLabel}</span> | 
                        Stage: <span class="text-blue-400">\${selectedStage || '-'}</span> | 
                        Tagged: <span class="text-green-400">\${debugInfo.tagged_count}</span> / 
                        Total: <span class="text-white">\${debugInfo.total_in_db}</span>
                    \`;
                } else {
                    sourceEl.textContent = \`Stage: \${selectedStage || '-'}, Candidates: \${result.total_candidates || 0}\`;
                }
            }
            
            // 2. ì ìˆ˜ ë¶„í•´ (TOP3)
            const scoreEl = document.getElementById('debug-score-breakdown');
            if (scoreEl) {
                if (debugInfo?.score_breakdown) {
                    scoreEl.innerHTML = debugInfo.score_breakdown.map((s, i) => \`
                        <div class="mb-2 pb-2 \${i < 2 ? 'border-b border-slate-700' : ''}">
                            <div class="flex justify-between">
                                <span class="text-yellow-300">\${i+1}. \${s.job_name}</span>
                                <span class="text-green-400">Fit: \${s.final_fit}</span>
                            </div>
                            <div class="text-slate-400 text-xs">
                                Base: L\${s.base_like}/C\${s.base_can}/R\${s.base_risk} â†’ 
                                Final: L\${s.final_like}/C\${s.final_can}/R\${s.final_risk}
                            </div>
                            \${s.like_boosts.length > 0 ? \`<div class="text-green-300 text-xs">Like â†‘: \${s.like_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                            \${s.can_boosts.length > 0 ? \`<div class="text-blue-300 text-xs">Can â†‘: \${s.can_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                            \${s.risk_boosts.length > 0 ? \`<div class="text-red-300 text-xs">Risk â†‘: \${s.risk_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                        </div>
                    \`).join('');
                } else {
                    const top1 = result.fit_top3?.[0];
                    if (top1) {
                        scoreEl.innerHTML = \`Like: \${top1.like_score}, Can: \${top1.can_score}, Fit: \${top1.fit_score}\`;
                    }
                }
            }
            
            // 3. Follow-up ê·¼ê±°
            const followupEl = document.getElementById('debug-followup-rationale');
            if (followupEl) {
                if (debugInfo?.followup_rationale) {
                    const fr = debugInfo.followup_rationale;
                    followupEl.innerHTML = \`
                        <span class="text-purple-400">Split Attr:</span> \${fr.split_attribute} | 
                        <span class="text-yellow-400">Gain:</span> \${fr.split_gain.toFixed(2)} | 
                        <span class="text-slate-400">\${fr.reason}</span>
                    \`;
                } else if (result.followup_questions?.[0]) {
                    const fq = result.followup_questions[0];
                    followupEl.innerHTML = \`ì§ˆë¬¸: "\${fq.question.slice(0, 40)}..." â†’ \${fq.fact_key}\`;
                } else {
                    followupEl.textContent = 'ì¶”ê°€ ì§ˆë¬¸ ì—†ìŒ';
                }
            }
            
            // 4. Rank Change
            const rankEl = document.getElementById('debug-rank-change');
            if (rankEl) {
                if (debugInfo?.rank_changes) {
                    const rc = debugInfo.rank_changes;
                    rankEl.innerHTML = \`
                        <div class="text-slate-400">Before: \${rc.before.join(' â†’ ')}</div>
                        <div class="text-green-400">After: \${rc.after.join(' â†’ ')}</div>
                        <div class="text-yellow-400">Changes: \${rc.changes.join(', ') || 'ì—†ìŒ'}</div>
                    \`;
                } else if (previousTop3.length > 0) {
                    const currentTop3 = (result.fit_top3 || []).map(j => j.job_name);
                    rankEl.innerHTML = \`
                        <div class="text-slate-400">Before: \${previousTop3.join(' â†’ ')}</div>
                        <div class="text-green-400">After: \${currentTop3.join(' â†’ ')}</div>
                    \`;
                } else {
                    rankEl.textContent = 'ì²« ë¶„ì„ (ë¹„êµ ëŒ€ìƒ ì—†ìŒ)';
                }
            }
            
            // 5. Applied Facts & Rules
            const factsEl = document.getElementById('debug-applied-facts');
            if (factsEl) {
                if (debugInfo?.applied_facts) {
                    factsEl.innerHTML = debugInfo.applied_facts.map(f => \`
                        <div class="py-1 border-b border-slate-700/50">
                            <span class="text-blue-300">\${f.fact_key}</span>: 
                            <span class="text-white">\${f.value}</span>
                            <span class="text-slate-500">(\${f.effect})</span>
                        </div>
                    \`).join('');
                } else {
                    factsEl.innerHTML = \`Facts: \${result.input_summary?.facts_applied || 0}ê°œ, Rules: \${(result.input_summary?.applied_rules || []).join(', ') || 'ì—†ìŒ'}\`;
                }
            }
            
            // 6. ë²„ì „ ì •ë³´
            const versionsEl = document.getElementById('debug-versions');
            if (versionsEl) {
                const v = debugInfo?.versions || result.versions || {};
                versionsEl.innerHTML = \`
                    <span class="text-slate-400">recipe:</span> \${v.recipe || '-'} | 
                    <span class="text-slate-400">tagger:</span> \${v.tagger || '-'} | 
                    <span class="text-slate-400">scoring:</span> \${v.scoring || '-'} | 
                    <span class="text-slate-400">embedding:</span> \${v.embedding || 'none'}
                \`;
            }
            
            // Phase4 ìƒíƒœ
            const phase4El = document.getElementById('debug-phase4-status');
            if (phase4El) {
                const diversityApplied = debugInfo?.diversity_guard_triggered || result.diversity_guard_active;
                const biasCapApplied = debugInfo?.research_bias_cap_applied || false;
                phase4El.innerHTML = \`
                    <span class="\${diversityApplied ? 'text-green-400' : 'text-slate-500'}">
                        Diversity Guard: \${diversityApplied ? 'âœ“ ì ìš©ë¨' : 'âœ— ë¯¸ì ìš©'}
                    </span> | 
                    <span class="\${biasCapApplied ? 'text-yellow-400' : 'text-slate-500'}">
                        Research Bias Cap: \${biasCapApplied ? 'âœ“ ì ìš©ë¨' : 'âœ— ë¯¸ì ìš©'}
                    </span>
                    \${result.diversity_changes?.length > 0 ? \`<div class="text-xs text-yellow-300 mt-1">ë³€ê²½: \${result.diversity_changes.join(', ')}</div>\` : ''}
                \`;
            }
        }
        
        function displayResultFollowup(question) {
            const section = document.getElementById('result-followup-section');
            section.classList.remove('hidden');
            document.getElementById('result-followup-question').textContent = question.question;
            
            document.getElementById('result-followup-options').innerHTML = (question.options || []).map(opt => \`
                <button onclick="submitResultFollowup('\${question.id}', '\${question.fact_key}', '\${opt.value}')"
                        class="px-4 py-2 bg-wiki-primary hover:bg-blue-600 text-white rounded-lg transition">
                    \${opt.label}
                </button>
            \`).join('');
        }
        
        async function submitResultFollowup(qId, factKey, answer) {
            try {
                await fetch('/api/ai-analyzer/followup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        question_id: qId,
                        fact_key: factKey,
                        answer: answer,
                    })
                });
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
            }
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel-content');
            if (panel) panel.classList.toggle('hidden');
        }
        
        function resetAnalysis() {
            universalAnswers = {};
            followupAnswers = {};
            currentSessionId = null;
            currentRequestId = null;
            previousTop3 = [];
            selectedStage = null;
            goToStep(0);
        }
        
        // ìë™ ì €ì¥ ê¸°ëŠ¥
        // ë³€ê²½ì‚¬í•­ ì¶”ì  í”Œë˜ê·¸
        window.analyzerUnsavedChanges = false;
        
        // ì„¸ì…˜ ìë™ ì—°ì¥ (30ë¶„ë§ˆë‹¤ í™œë™ ê°ì§€ ì‹œ)
        let lastActivityTime = Date.now();
        let sessionExtendInterval = null;
        
        function trackActivity() {
            lastActivityTime = Date.now();
        }
        
        async function extendSessionIfNeeded() {
            // 5ë¶„ ì´ë‚´ì— í™œë™ì´ ìˆì—ˆìœ¼ë©´ ì„¸ì…˜ ì—°ì¥
            if (Date.now() - lastActivityTime < 5 * 60 * 1000) {
                try {
                    await fetch('/auth/refresh', { 
                        method: 'POST', 
                        credentials: 'same-origin' 
                    });
                } catch (e) {
                }
            }
        }
        
        // í™œë™ ê°ì§€ ì´ë²¤íŠ¸ (í´ë¦­, í‚¤ì…ë ¥, ìŠ¤í¬ë¡¤)
        ['click', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, trackActivity, { passive: true });
        });
        
        // 30ë¶„ë§ˆë‹¤ ì„¸ì…˜ ì—°ì¥ ì²´í¬
        sessionExtendInterval = setInterval(extendSessionIfNeeded, 30 * 60 * 1000);
        
        function autoSaveDraft() {
            const draft = {
                currentStep: window.currentStep,
                currentRound: window.currentRound,
                collectedCareerState: window.collectedCareerState || {},
                universalAnswers: window.universalAnswers || {},
                narrativeAnswers: window.narrativeAnswers || {},
                roundAnswers: window.roundAnswers || {},
                selectedStage: selectedStage,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem('analyzer_draft', JSON.stringify(draft));
                localStorage.setItem('analyzer_draft_timestamp', Date.now().toString());
                window.analyzerUnsavedChanges = true; // ë¡œì»¬ì—ë§Œ ì €ì¥ëœ ìƒíƒœ
            } catch (e) {
            }
        }
        
        // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ, UI ì—…ë°ì´íŠ¸ ì—†ìŒ)
        async function saveDraftToServer() {
            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¨¼ì € ì €ì¥
                autoSaveDraft();
                
                // ì„¸ì…˜ ID í™•ë³´
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // ìµœì‹  ë‹µë³€ ìˆ˜ì§‘
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function' 
                    ? collectUniversalAnswers() 
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};
                
                // ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ í˜„ì¬ ê°’ ìˆ˜ì§‘
                const narrativeQ0 = document.getElementById('narrative_q0');
                const narrativeQ1 = document.getElementById('narrative_q1');
                const narrativeQ2 = document.getElementById('narrative_q2');
                const narrativeCareerBg = document.getElementById('narrative_career_bg');
                if (narrativeQ0 || narrativeQ1 || narrativeQ2) {
                    const currentQuestions = typeof getNarrativeQuestions === 'function' ? getNarrativeQuestions() : null;
                    window.narrativeFacts = {
                        storyAnswer: narrativeQ0?.value || '',
                        life_story: narrativeQ0?.value || '',
                        question1Answer: narrativeQ1?.value || '',
                        question2Answer: narrativeQ2?.value || '',
                        highAliveMoment: narrativeQ1?.value || '',
                        lostMoment: narrativeQ2?.value || '',
                        career_background: narrativeCareerBg?.value || window.resumeCareerBackground || '',  // ì „ê³µ/ì§ë¬´ ì •ë³´ ì¶”ê°€
                    };
                    if (currentQuestions) {
                        window.savedNarrativeQuestions = currentQuestions;
                    }
                }
                
                // step4_answers í†µí•© ë°ì´í„°
                const step4Data = {
                    round_answers: window.roundAnswers || [],
                    narrative_facts: window.narrativeFacts || null,
                    narrative_questions: window.savedNarrativeQuestions || null,
                    round_questions: window.roundQuestions || null,
                    current_round: window.currentRound || 0
                };
                
                // career_background í˜„ì¬ ê°’ ìˆ˜ì§‘ (ì´ë ¥ì„œ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥)
                const careerBgInput = document.getElementById('narrative_career_bg');
                const currentCareerBackground = careerBgInput?.value || window.resumeCareerBackground || '';
                
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,  // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í… (1: 5ì¶•, 2: ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°)
                    current_round: window.currentRound || 0,  // ì‹¬ì¸µ ì§ˆë¬¸ ë¼ìš´ë“œ
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 1,  // ë³µì›ìš©
                        currentRound: window.currentRound || 0,  // ì‹¬ì¸µ ì§ˆë¬¸ ë¼ìš´ë“œ ë³µì›ìš©
                        resumeUploaded: window.resumeUploaded || false,  // ì´ë ¥ì„œ ì—…ë¡œë“œ ì—¬ë¶€
                        resumeCareerBackground: window.resumeCareerBackground || ''  // ì´ë ¥ì„œì—ì„œ ì¶”ì¶œí•œ ë°°ê²½
                    },
                    mini_module_result: window.miniModuleResult || null,
                    mini_module_selections: miniModuleSelections || null,
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: step4Data,
                    career_background: currentCareerBackground  // ì „ê³µ/ì§ë¬´ ì •ë³´ (ìµœìƒìœ„ì—ë„ ì €ì¥)
                };
                
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false;
                }
            } catch (error) {
            }
        }
        
        // ìˆ˜ë™ ì„ì‹œì €ì¥ í•¨ìˆ˜ (ë²„íŠ¼ í´ë¦­)
        async function saveDraftNow() {
            const saveBtn = event?.target?.closest('button');
            const originalHtml = saveBtn ? saveBtn.innerHTML : '';
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...';
            }
            
            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
                autoSaveDraft();
                
                // ì„¸ì…˜ ID í™•ë³´ (ì—†ìœ¼ë©´ ìƒì„±)
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // ìµœì‹  ë‹µë³€ ìˆ˜ì§‘
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function' 
                    ? collectUniversalAnswers() 
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};
                
                // ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ í˜„ì¬ ê°’ ìˆ˜ì§‘ (textareaì—ì„œ ì§ì ‘)
                const narrativeQ0 = document.getElementById('narrative_q0');
                const narrativeQ1 = document.getElementById('narrative_q1');
                const narrativeQ2 = document.getElementById('narrative_q2');
                const narrativeCareerBg = document.getElementById('narrative_career_bg');
                if (narrativeQ0 || narrativeQ1 || narrativeQ2) {
                    const currentQuestions = typeof getNarrativeQuestions === 'function' ? getNarrativeQuestions() : null;
                    window.narrativeFacts = {
                        // ìŠ¤í† ë¦¬ ì§ˆë¬¸ (ê³µí†µ)
                        storyAnswer: narrativeQ0?.value || '',
                        life_story: narrativeQ0?.value || '',
                        // ë™ì  ì§ˆë¬¸ 1, 2
                        question1Answer: narrativeQ1?.value || '',
                        question2Answer: narrativeQ2?.value || '',
                        highAliveMoment: narrativeQ1?.value || '',
                        lostMoment: narrativeQ2?.value || '',
                        // ì „ê³µ/ì§ë¬´ ì •ë³´ ì¶”ê°€
                        career_background: narrativeCareerBg?.value || window.resumeCareerBackground || '',
                    };
                    // ì§ˆë¬¸ ìì²´ë„ ì €ì¥ (ë³µì› ì‹œ ë™ì¼í•œ ì§ˆë¬¸ ì‚¬ìš©)
                    if (currentQuestions) {
                        window.savedNarrativeQuestions = currentQuestions;
                    }
                }
                
                // ì„œë²„ì—ë„ ì €ì¥ (API í˜¸ì¶œ)
                // step4_answersì— ëª¨ë“  ì‹¬ì¸µ ì§ˆë¬¸ ê´€ë ¨ ë°ì´í„° í†µí•© (DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ì´)
                const step4Data = {
                    round_answers: window.roundAnswers || [],
                    narrative_facts: window.narrativeFacts || null,
                    narrative_questions: window.savedNarrativeQuestions || null,
                    round_questions: window.roundQuestions || null,
                    current_round: window.currentRound || 0
                };
                
                // career_background í˜„ì¬ ê°’ ìˆ˜ì§‘ (ì´ë ¥ì„œ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥)
                const careerBgInput = document.getElementById('narrative_career_bg');
                const currentCareerBackground = careerBgInput?.value || window.resumeCareerBackground || '';
                
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,  // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í…
                    current_round: window.currentRound || 0,  // ì‹¬ì¸µ ì§ˆë¬¸ ë¼ìš´ë“œ
                    career_state: careerState || {},  // ë¡œì»¬ careerState ì‚¬ìš©
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},  // 5ì¶• ì¢Œí‘œë„ ì €ì¥
                        profileSubStep: profileSubStep || 1,  // ë³µì›ìš©
                        currentRound: window.currentRound || 0,  // ì‹¬ì¸µ ì§ˆë¬¸ ë¼ìš´ë“œ ë³µì›ìš©
                        resumeUploaded: window.resumeUploaded || false,  // ì´ë ¥ì„œ ì—…ë¡œë“œ ì—¬ë¶€
                        resumeCareerBackground: window.resumeCareerBackground || ''  // ì´ë ¥ì„œì—ì„œ ì¶”ì¶œí•œ ë°°ê²½
                    },
                    mini_module_result: window.miniModuleResult || null,  // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: step4Data,  // í†µí•© ë°ì´í„°
                    career_background: currentCareerBackground  // ì „ê³µ/ì§ë¬´ ì •ë³´ (ìµœìƒìœ„ì—ë„ ì €ì¥)
                };
                
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                const responseData = await response.json().catch(() => ({}));
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false; // ì„œë²„ì— ì €ì¥ë¨
                    
                    // ì„±ê³µ í”¼ë“œë°± - ì €ì¥ë¨ ìƒíƒœ ìœ ì§€ (ë‚´ìš© ë³€ê²½ ì „ê¹Œì§€)
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-check mr-2 text-emerald-400"></i>ì €ì¥ë¨';
                        saveBtn.disabled = false;
                        saveBtn.dataset.saved = 'true';
                    }
                } else {
                    throw new Error('Server save failed: ' + (responseData.error || response.status));
                }
            } catch (error) {
                // ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ í‘œì‹œ
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-amber-400"></i>ì˜¤í”„ë¼ì¸ ì €ì¥ë¨';
                    saveBtn.disabled = false;
                    saveBtn.dataset.saved = 'true'; // ì˜¤í”„ë¼ì¸ ì €ì¥ë„ ì €ì¥ë¨ ìƒíƒœë¡œ
                }
            }
        }
        
        // ì €ì¥ ë²„íŠ¼ ë¦¬ì…‹ (ë‚´ìš© ë³€ê²½ ì‹œ í˜¸ì¶œ)
        function resetSaveButtons() {
            document.querySelectorAll('[id$="-save-btn"]').forEach(btn => {
                if (btn.dataset.saved === 'true') {
                    btn.innerHTML = '<i class="fas fa-save mr-2 text-emerald-400"></i>ì„ì‹œì €ì¥';
                    btn.dataset.saved = 'false';
                    window.analyzerUnsavedChanges = true;
                }
            });
        }
        
        // ìë™ ë³µì› ê¸°ëŠ¥ (ëª¨ë‹¬ ì‚¬ìš©)
        let pendingDraft = null;
        let pendingServerDraft = null;
        
        async function autoRestoreDraft() {
            try {
                // 1. ì„œë²„ì—ì„œ ì§„í–‰ì¤‘ì¸ draft í™•ì¸ (ìºì‹œ ë°©ì§€!)
                const serverResponse = await fetch('/api/ai-analyzer/draft/load?_t=' + Date.now(), {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-store',  // ë¸Œë¼ìš°ì € ìºì‹œ ì™„ì „ ë¬´ì‹œ
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const serverData = await serverResponse.json();
                
                if (serverResponse.ok && serverData.found && serverData.draft && serverData.draft.analysis_type !== 'major') {
                    const serverDraft = serverData.draft;
                    pendingServerDraft = serverDraft;

                    // ì„œë²„ì— ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ
                    const stepNames = ['', 'ìƒíƒœ ì„ íƒ', 'ê¸°ë³¸ ì •ë³´', 'ì•ìœ¼ë¡œì˜ ë°©í–¥', 'ì‹¬ì¸µ ì§ˆë¬¸', 'ê²°ê³¼'];
                    const savedDate = new Date(serverDraft.updated_at);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[serverDraft.current_step] + '</strong>ê¹Œì§€ ì§„í–‰ë¨<br>' +
                        '<span class="text-xs">ë§ˆì§€ë§‰ ì‘ì—…: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal';
                }
                
                // ì„œë²„ì— draftê°€ ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ì •ë¦¬ (ì„œë²„ê°€ source of truth)
                // ì´ì „ì— ìœ ì € ë©”ë‰´ì—ì„œ ì‚­ì œí–ˆê±°ë‚˜, ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‚­ì œí•œ ê²½ìš°
                if (serverResponse.ok && !serverData.found) {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    return false;
                }
                
                // 2. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í™•ì¸ (ì„œë²„ ì˜¤ë¥˜ ì‹œ í´ë°±)
                const draftStr = localStorage.getItem('analyzer_draft');
                const timestamp = localStorage.getItem('analyzer_draft_timestamp');
                
                if (!draftStr) return false;
                
                // 24ì‹œê°„ ì´ë‚´ì˜ ë“œë˜í”„íŠ¸ë§Œ ë³µì›
                const savedTime = parseInt(timestamp, 10);
                if (Date.now() - savedTime > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    return false;
                }
                
                const draft = JSON.parse(draftStr);
                pendingDraft = draft;
                
                
                // ë¡œì»¬ì— ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ (step 1ì´ì–´ë„)
                if (draft.currentStep >= 1) {
                    const stepNames = ['', 'ìƒíƒœ ì„ íƒ', 'ê¸°ë³¸ ì •ë³´', 'ì•ìœ¼ë¡œì˜ ë°©í–¥', 'ì‹¬ì¸µ ì§ˆë¬¸', 'ê²°ê³¼'];
                    const savedDate = new Date(savedTime);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[draft.currentStep] + '</strong>ê¹Œì§€ ì§„í–‰ë¨<br>' +
                        '<span class="text-xs">ë§ˆì§€ë§‰ ì‘ì—…: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal'; // ëª¨ë‹¬ í‘œì‹œ ì¤‘
                }
                
                return false;
            } catch (e) {
                return false;
            }
        }
        
        // ì´ì–´ì„œ í•˜ê¸°
        function continueFromDraft() {
            // ì„œë²„ draft ìš°ì„ 
            if (pendingServerDraft) {
                const draft = pendingServerDraft;
                currentSessionId = draft.session_id;
                
                // 5ì¶• ì¢Œí‘œ ë³µì›
                const savedCareerState = draft.step1_answers?.careerState || draft.career_state;
                if (savedCareerState && Object.keys(savedCareerState).length > 0) {
                    Object.assign(careerState, savedCareerState);
                }
                
                // ë‹µë³€ë“¤ ë³µì›
                if (draft.step2_answers) {
                    window.universalAnswers = draft.step2_answers;
                    universalAnswers = draft.step2_answers;
                }
                if (draft.step3_answers) {
                    window.narrativeAnswers = draft.step3_answers;
                    transitionSignalAnswers = draft.step3_answers;
                }
                // step4_answers í†µí•© êµ¬ì¡°ì—ì„œ ê°œë³„ í•„ë“œ ì¶”ì¶œ
                if (draft.step4_answers && typeof draft.step4_answers === 'object') {
                    const step4Data = draft.step4_answers;
                    window.roundAnswers = Array.isArray(step4Data.round_answers) ? step4Data.round_answers : [];
                    if (step4Data.narrative_facts) window.narrativeFacts = step4Data.narrative_facts;
                    if (step4Data.narrative_questions) window.savedNarrativeQuestions = step4Data.narrative_questions;
                    if (step4Data.round_questions) window.roundQuestions = step4Data.round_questions;
                    if (step4Data.current_round > 0) window.currentRound = step4Data.current_round;
                }
                if (draft.step1_answers?.stage) {
                    selectedStage = draft.step1_answers.stage;
                }

                document.getElementById('continue-modal').classList.add('hidden');

                // mini_module_result ë³µì›
                if (draft.mini_module_result) {
                    window.miniModuleResult = draft.mini_module_result;
                }
                
                // UI ë³µì› í›„ í•´ë‹¹ stepìœ¼ë¡œ ì´ë™
                setTimeout(() => {
                    updateStep1Selection();
                    if (draft.current_step >= 2) {
                        renderUniversalQuestions();
                        setTimeout(() => updateStep2Selection(), 100);
                    }
                    if (draft.current_step >= 3) {
                        renderTransitionSignalForm();
                    }
                    // Step 4 (ì‹¬ì¸µ ì§ˆë¬¸) ë³µì› ì¶”ê°€!
                    if (draft.current_step >= 4) {
                        // ì‹¬ì¸µ ì§ˆë¬¸ UI ë Œë”ë§
                        const currentRound = draft.current_round || 1;
                        
                        // ë¼ìš´ë“œ ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
                        setTimeout(() => {
                            if (typeof startV3RoundQuestions === 'function') {
                                startV3RoundQuestions(currentRound);
                            }
                        }, 300);
                    }
                }, 200);
                
                goToStep(draft.current_step, true);
                pendingServerDraft = null;
                return;
            }
            
            // ë¡œì»¬ draft
            if (!pendingDraft) return;
            
            // ìƒíƒœ ë³µì›
            if (pendingDraft.collectedCareerState) {
                Object.assign(careerState, pendingDraft.collectedCareerState);
                window.collectedCareerState = pendingDraft.collectedCareerState;
            }
            if (pendingDraft.universalAnswers) {
                window.universalAnswers = pendingDraft.universalAnswers;
                universalAnswers = pendingDraft.universalAnswers;
            }
            if (pendingDraft.narrativeAnswers) {
                window.narrativeAnswers = pendingDraft.narrativeAnswers;
                transitionSignalAnswers = pendingDraft.narrativeAnswers;
            }
            if (pendingDraft.roundAnswers) {
                window.roundAnswers = pendingDraft.roundAnswers;
            }
            if (pendingDraft.selectedStage) {
                selectedStage = pendingDraft.selectedStage;
            }
            if (pendingDraft.currentRound) {
                window.currentRound = pendingDraft.currentRound;
            }
            
            document.getElementById('continue-modal').classList.add('hidden');
            
            // mini_module_result ë³µì› (ë¡œì»¬)
            if (pendingDraft.miniModuleResult) {
                window.miniModuleResult = pendingDraft.miniModuleResult;
            }
            
            // UI ë³µì›
            setTimeout(() => {
                updateStep1Selection();
                if (pendingDraft.currentStep >= 2) {
                    renderUniversalQuestions();
                    setTimeout(() => updateStep2Selection(), 100);
                }
                if (pendingDraft.currentStep >= 3) {
                    renderTransitionSignalForm();
                }
                // Step 4 (ì‹¬ì¸µ ì§ˆë¬¸) ë³µì› ì¶”ê°€!
                if (pendingDraft.currentStep >= 4) {
                    const currentRound = pendingDraft.currentRound || 1;
                    
                    setTimeout(() => {
                        if (typeof startV3RoundQuestions === 'function') {
                            startV3RoundQuestions(currentRound);
                        }
                    }, 300);
                }
            }, 200);
            
            goToStep(pendingDraft.currentStep, true);
            pendingDraft = null;
        }
        
        // ìƒˆë¡œ ì‹œì‘ ê²½ê³  í‘œì‹œ
        function showRestartWarning() {
            document.getElementById('restart-warning-modal').classList.remove('hidden');
        }
        
        // ìƒˆë¡œ ì‹œì‘ ê²½ê³  ìˆ¨ê¸°ê¸°
        function hideRestartWarning() {
            document.getElementById('restart-warning-modal').classList.add('hidden');
        }
        
        // ìƒˆë¡œ ì‹œì‘ í™•ì¸
        async function confirmRestart() {
            
            // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ
            localStorage.removeItem('analyzer_draft');
            localStorage.removeItem('analyzer_draft_timestamp');
            
            // 2. ì„œë²„ì˜ ëª¨ë“  job íƒ€ì… draft ì‚­ì œ (ë‹¤ë¥¸ ì„¸ì…˜ í¬í•¨)
            try {
                const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const result = await response.json();
                } else {
                }
            } catch (e) {
            }
            
            // 3. ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('restart-warning-modal').classList.add('hidden');
            document.getElementById('continue-modal').classList.add('hidden');
            
            // 4. ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            pendingDraft = null;
            pendingServerDraft = null;
            currentSessionId = '';  // ì„¸ì…˜ ID ì´ˆê¸°í™” (ìƒˆ ì„¸ì…˜ ì‹œì‘)
            window.collectedCareerState = {};
            window.universalAnswers = {};
            window.narrativeAnswers = {};
            window.roundAnswers = [];
            window.miniModuleResult = null;  // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ë„ ì´ˆê¸°í™”
            miniModuleSelections = { interest: [], value: [], strength: [], constraint: [] };
            selectedStage = '';
            window.currentRound = null;
            
            // 5. Step 1ë¶€í„° ì‹œì‘
            goToStep(1);
        }
        
        // goToStep ë˜í•‘í•˜ì—¬ ìë™ ì €ì¥ ì¶”ê°€
        const originalGoToStep = goToStep;
        goToStep = function(step, skipRender = false) {
            originalGoToStep(step, skipRender);
            // ìë™ ì €ì¥
            if (step < 3) {
                // ì§„í–‰ ì¤‘ ë‹¨ê³„: ìë™ ì €ì¥
                setTimeout(autoSaveDraft, 100);
            } else if (step === 3) {
                // ê²°ê³¼ ë„ë‹¬ ì‹œ ì„œë²„ì— ì™„ë£Œ ìƒíƒœ ì €ì¥ í›„ localStorage ì •ë¦¬
                saveDraftAsCompleted().then(() => {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    window.analyzerUnsavedChanges = false;
                }).catch(err => {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                });
            }
        };
        
        // ê²°ê³¼ ë„ë‹¬ ì‹œ ì„œë²„ì— ì™„ë£Œ ìƒíƒœ ì €ì¥
        async function saveDraftAsCompleted() {
            if (!currentSessionId) return;
            
            try {
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: 3,  // ì™„ë£Œ ìƒíƒœ
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 2,  // í”„ë¡œí•„ ì™„ë£Œ
                        completed: true
                    },
                    mini_module_result: window.miniModuleResult || null
                };
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                }
            } catch (error) {
            }
        }
        
        // beforeunload í•¸ë“¤ëŸ¬ (ì €ì¥ í™•ì¸)
        window.addEventListener('beforeunload', (e) => {
            if (window.analyzerUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                return e.returnValue;
            }
        });
        
        // ì„œë²„ì—ì„œ draft ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadDraftFromServer(sessionId) {
            try {
                const url = sessionId 
                    ? '/api/ai-analyzer/draft/load?session_id=' + encodeURIComponent(sessionId)
                    : '/api/ai-analyzer/draft/load';
                    
                const response = await fetch(url, { credentials: 'same-origin' });
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                if (!data.found || !data.draft) {
                    return null;
                }
                
                return data.draft;
            } catch (error) {
                return null;
            }
        }
        
        // ì„œë²„ draftë¥¼ UIì— ì ìš©
        function applyServerDraft(draft) {
            if (!draft) return false;
            
            // ì„¸ì…˜ ID ì„¤ì •
            currentSessionId = draft.session_id;
            
            // Step 1: stageì™€ careerState ë³µì›
            if (draft.step1_answers?.stage) {
                selectedStage = draft.step1_answers.stage;
            }
            
            // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í… ë³µì› (1: 5ì¶•, 2: ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°)
            if (draft.profile_sub_step || draft.step1_answers?.profileSubStep) {
                profileSubStep = draft.profile_sub_step || draft.step1_answers?.profileSubStep || 1;
            }
            
            // 5ì¶• ì¢Œí‘œ ë³µì› (step1_answers.careerState ë˜ëŠ” draft.career_state)
            const savedCareerState = draft.step1_answers?.careerState || draft.career_state;
            if (savedCareerState && Object.keys(savedCareerState).length > 0) {
                // ë¡œì»¬ careerState ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                Object.assign(careerState, savedCareerState);
                window.collectedCareerState = savedCareerState;
            }
            
            // ì´ë ¥ì„œ ì—…ë¡œë“œ ì •ë³´ ë³µì›
            if (draft.step1_answers?.resumeUploaded) {
                window.resumeUploaded = true;
                window.resumeCareerBackground = draft.step1_answers.resumeCareerBackground || '';
            }
            
            // career_background ë³µì› (ìµœìƒìœ„ í•„ë“œ ë˜ëŠ” narrative_factsì—ì„œ)
            if (draft.career_background) {
                window.savedCareerBackground = draft.career_background;
            }
            
            // Step 2: universal answers
            if (draft.step2_answers && Object.keys(draft.step2_answers).length > 0) {
                window.universalAnswers = draft.step2_answers;
                universalAnswers = draft.step2_answers;
            }
            
            // Step 3: narrative/transition answers
            if (draft.step3_answers && Object.keys(draft.step3_answers).length > 0) {
                window.narrativeAnswers = draft.step3_answers;
                transitionSignalAnswers = draft.step3_answers;
            }
            
            // Step 4: ì‹¬ì¸µ ì§ˆë¬¸ ë°ì´í„° ë³µì› (í†µí•© êµ¬ì¡°)
            if (draft.step4_answers && typeof draft.step4_answers === 'object') {
                const step4Data = draft.step4_answers;
                
                // round_answers ë³µì›
                if (step4Data.round_answers) {
                    window.roundAnswers = step4Data.round_answers;
                }
                
                // narrative_facts ë³µì› (ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ ë‹µë³€)
                if (step4Data.narrative_facts) {
                    window.narrativeFacts = step4Data.narrative_facts;
                    // career_backgroundë„ narrative_factsì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë³µì›
                    if (step4Data.narrative_facts.career_background && !window.resumeCareerBackground) {
                        window.savedCareerBackground = step4Data.narrative_facts.career_background;
                    }
                }
                
                // narrative_questions ë³µì› (ë™ì  ì§ˆë¬¸ ì¬ì‚¬ìš©)
                if (step4Data.narrative_questions) {
                    window.savedNarrativeQuestions = step4Data.narrative_questions;
                }
                
                // round_questions ë³µì›
                if (step4Data.round_questions) {
                    window.roundQuestions = step4Data.round_questions;
                }
                
                // current_round ë³µì›
                if (step4Data.current_round && step4Data.current_round > 0) {
                    window.currentRound = step4Data.current_round;
                }
            }
            
            // ì´ì „ ë²„ì „ í˜¸í™˜ì„± (ë³„ë„ í•„ë“œë¡œ ì €ì¥ëœ ê²½ìš°)
            if (draft.narrative_facts && !window.narrativeFacts) {
                window.narrativeFacts = draft.narrative_facts;
            }
            if (draft.narrative_questions && !window.savedNarrativeQuestions) {
                window.savedNarrativeQuestions = draft.narrative_questions;
            }
            if (draft.round_questions && !window.roundQuestions) {
                window.roundQuestions = draft.round_questions;
            }
            if (draft.current_round && draft.current_round > 0 && !window.currentRound) {
                window.currentRound = draft.current_round;
            }
            
            // ============================================
            // ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ ë³µì›
            // ============================================
            if (draft.mini_module_result) {
                window.miniModuleResult = draft.mini_module_result;
            }
            
            // ============================================
            // AggregatedProfile + Memory ë³µì› (ìš”ì•½ ë°°ë„ˆìš©!)
            // ============================================
            if (draft.aggregated_profile) {
                window.aggregatedProfile = draft.aggregated_profile;
            }
            if (draft.memory) {
                // aggregatedProfileì´ ì—†ìœ¼ë©´ ìƒì„±
                if (!window.aggregatedProfile) {
                    window.aggregatedProfile = { memory: draft.memory };
                } else {
                    window.aggregatedProfile.memory = draft.memory;
                }
            }
            
            return draft.current_step || 1;
        }
        
        // Step 1 UI ì—…ë°ì´íŠ¸ (5ì¶• ì¢Œí‘œ ì„ íƒ ìƒíƒœ ë³µì›)
        function updateStep1Selection() {
            // ì¶• 1: ì—­í•  ì •ì²´ì„± ë³µì›
            if (careerState.role_identity) {
                document.querySelectorAll('.role-card, [data-value]').forEach(card => {
                    if (card.closest('#role-options') && card.dataset.value === careerState.role_identity) {
                        card.classList.add('selected');
                        card.style.borderColor = '#4361ee';
                        card.style.backgroundColor = 'rgba(67,97,238,0.2)';
                    }
                });
            }
            
            // ì¶• 2: ê²½ë ¥ ê¸°ê°„ ë³µì›
            if (careerState.career_stage_years) {
                document.querySelectorAll('.career-stage-btn, [data-value]').forEach(card => {
                    if (card.closest('#career-stage-options') && card.dataset.value === careerState.career_stage_years) {
                        card.classList.add('selected');
                        card.style.borderColor = '#4361ee';
                        card.style.backgroundColor = 'rgba(67,97,238,0.2)';
                    }
                });
            }
            
            // ì¶• 3: ì „í™˜ ìƒíƒœ ë³µì› (ë‹¤ì¤‘ ì„ íƒ - ë°°ì—´)
            if (careerState.transition_status && Array.isArray(careerState.transition_status)) {
                document.querySelectorAll('.goal-chip, [data-value]').forEach(card => {
                    if (card.closest('#transition-status-options') && careerState.transition_status.includes(card.dataset.value)) {
                        card.classList.add('selected');
                        card.style.borderColor = '#10b981';
                        card.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    }
                });
            }
            
            // ì¶• 4: ìˆ™ë ¨ë„ ë³µì›
            if (careerState.skill_level !== null && careerState.skill_level !== undefined) {
                document.querySelectorAll('.skill-btn, [data-value]').forEach(card => {
                    if (card.closest('#skill-level-options') && parseInt(card.dataset.value) === careerState.skill_level) {
                        card.classList.add('selected');
                        card.style.borderColor = '#8b5cf6';
                        card.style.backgroundColor = 'rgba(139,92,246,0.2)';
                    }
                });
            }
            
            // ì¶• 5: ì œì•½ ì¡°ê±´ ë³µì› (UI ì§ì ‘ ì—…ë°ì´íŠ¸ - toggleConstraint í˜¸ì¶œí•˜ë©´ í† ê¸€ë˜ì–´ í•´ì œë¨)
            if (careerState.constraints && Object.keys(careerState.constraints).length > 0) {
                setTimeout(() => {
                    // ì €ì¥ëœ ì œì•½ ì¡°ê±´ì„ ì„ì‹œ ì €ì¥í•˜ê³  careerState ì´ˆê¸°í™”
                    const savedConstraints = JSON.parse(JSON.stringify(careerState.constraints));
                    careerState.constraints = {};
                    
                    Object.entries(savedConstraints).forEach(([type, constraint]) => {
                        if (constraint && constraint.has_constraint) {
                            const card = document.querySelector(\`.constraint-card[data-type="\${type}"]\`);
                            if (card) {
                                const headerBtn = card.querySelector('.constraint-header');
                                if (headerBtn) {
                                    // toggleConstraintë¥¼ í˜¸ì¶œí•˜ë©´ careerState.constraintsì— ë‹¤ì‹œ ì„¤ì •ë¨
                                    headerBtn.click();
                                    
                                    // ì„¸ë¶€ íƒœê·¸ ë³µì› (details ë°°ì—´ì´ ìˆëŠ” ê²½ìš°)
                                    if (constraint.details && Array.isArray(constraint.details)) {
                                        setTimeout(() => {
                                            constraint.details.forEach(detailValue => {
                                                const detailTag = card.querySelector(\`.detail-tag[data-value="\${detailValue}"]\`);
                                                if (detailTag && !detailTag.classList.contains('selected')) {
                                                    detailTag.click();
                                                }
                                            });
                                        }, 100);
                                    }
                                }
                            }
                        }
                    });
                }, 150);
            }
            
            // ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™” ì²´í¬
            checkStep1Completion();
        }
        
        // Step 2 UI ì—…ë°ì´íŠ¸ (Universal answers ë³µì›)
        function updateStep2Selection() {
            if (!universalAnswers || Object.keys(universalAnswers).length === 0) return;
            
            Object.entries(universalAnswers).forEach(([questionId, answer]) => {
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) return;
                
                if (Array.isArray(answer)) {
                    // chips/checkbox: ë‹¤ì¤‘ ì„ íƒ
                    answer.forEach(val => {
                        const chip = container.querySelector(\`.chip-option[data-value="\${val}"]\`);
                        if (chip && !chip.classList.contains('selected')) {
                            chip.classList.add('selected');
                            chip.style.borderColor = '#4361ee';
                            chip.style.backgroundColor = 'rgba(67,97,238,0.15)';
                        }
                    });
                } else {
                    // radio: ë‹¨ì¼ ì„ íƒ
                    const radio = container.querySelector(\`.radio-option[data-value="\${answer}"]\`);
                    if (radio && !radio.classList.contains('selected')) {
                        radio.classList.add('selected');
                        radio.style.borderColor = '#4361ee';
                        radio.style.backgroundColor = 'rgba(67,97,238,0.15)';
                    }
                    
                    // text input
                    const textarea = container.querySelector(\`textarea[name="\${questionId}"]\`);
                    if (textarea) {
                        textarea.value = answer;
                    }
                }
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” - /analyzer/jobì€ Step 1(ìƒíƒœ ì„ íƒ)ë¶€í„° ì‹œì‘
        document.addEventListener('DOMContentLoaded', async () => {
            renderStageOptions();  // ìŠ¤í…Œì´ì§€ ì˜µì…˜ ë Œë”ë§
            
            // URLì—ì„œ session_id í™•ì¸ (AI ì¶”ì²œ ë©”ë‰´ì—ì„œ ì§„í–‰ì¤‘ í´ë¦­ ì‹œ)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('session_id');
            const urlEditMode = urlParams.get('edit_mode') === 'true';
            const urlSourceRequestId = urlParams.get('source_request_id');

            // Phase 3: í¸ì§‘ ëª¨ë“œ ì§„ì…
            if (urlSessionId && urlEditMode && urlSourceRequestId) {
                const serverDraft = await loadDraftFromServer(urlSessionId);
                if (!serverDraft) {
                    alert('ì›ë³¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = '/user/ai-results';
                    return;
                }

                const editSessionId = 'edit-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const restoredStep = applyServerDraft(serverDraft);
                currentSessionId = editSessionId;

                window.__editMode = true;
                window.__originalSessionId = urlSessionId;
                window.__editSessionId = editSessionId;
                window.__sourceRequestId = parseInt(urlSourceRequestId, 10);
                window.__editSnapshot = {
                    careerState: JSON.stringify(careerState),
                    universalAnswers: JSON.stringify(universalAnswers),
                    narrativeFacts: JSON.stringify(window.narrativeFacts || {}),
                    roundAnswers: JSON.stringify(window.roundAnswers || []),
                };

                setTimeout(() => {
                    updateStep1Selection();
                    showEditModeBanner();
                    if (restoredStep === 1 && profileSubStep === 2) goToProfileStep2();
                    // step 4ì—ì„œ ë³µì› ì‹œ ë¼ìš´ë“œ ì§ˆë¬¸ UI í‘œì‹œ
                    if (restoredStep >= 4 && typeof startV3RoundQuestions === 'function') {
                        try { startV3RoundQuestions(); } catch(e) { }
                    }
                }, 200);

                goToStep(restoredStep || 1, true);
                return;
            }

            if (urlSessionId) {
                // ì„œë²„ì—ì„œ í•´ë‹¹ sessionì˜ draft ë¶ˆëŸ¬ì˜¤ê¸°
                const serverDraft = await loadDraftFromServer(urlSessionId);
                if (serverDraft) {
                    const restoredStep = applyServerDraft(serverDraft);
                    
                    // DOM ì—…ë°ì´íŠ¸ í›„ UI ì ìš© (setTimeoutìœ¼ë¡œ ë‹¤ìŒ í‹±ì—ì„œ ì‹¤í–‰)
                    setTimeout(() => {
                        updateStep1Selection();  // 5ì¶• ì¢Œí‘œ UI ë³µì›
                        
                        // í”„ë¡œí•„ ì„œë¸ŒìŠ¤í…ì— ë”°ë¼ ì ì ˆí•œ í™”ë©´ í‘œì‹œ
                        if (restoredStep === 1) {
                            if (profileSubStep === 2) {
                                // í”„ë¡œí•„ 2/2 (ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°)ë¡œ ì´ë™
                                goToProfileStep2();
                            }
                        }
                        
                        // Step 2 (ì‹¬ì¸µ ì§ˆë¬¸) ë³µì› - 3ë‹¨ê³„ êµ¬ì¡°
                        if (restoredStep === 2) {
                            // ë¼ìš´ë“œ ì§„í–‰ ì¤‘ì´ë©´ ë¼ìš´ë“œ UI ë Œë”ë§
                            if (window.currentRound > 0 && window.roundQuestions) {
                                const roundMeta = {
                                    1: { title: 'ë‚´ë©´ì˜ ì—ë„ˆì§€ íƒìƒ‰', subtitle: 'ë¬´ì—‡ì´ ë‹¹ì‹ ì„ ì›€ì§ì´ê²Œ í•˜ë‚˜ìš”?', emoji: 'ğŸ”¥', color: 'from-orange-500 to-red-500' },
                                    2: { title: 'ê²½ê³„ì„  í™•ì¸', subtitle: 'ë¬´ì—‡ì„ í”¼í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?', emoji: 'ğŸ›¡ï¸', color: 'from-purple-500 to-indigo-500' },
                                    3: { title: 'ì‹¤í–‰ ê³„íš ì„¤ê³„', subtitle: 'ì–´ë–»ê²Œ ì‹œì‘í•  ìˆ˜ ìˆì„ê¹Œìš”?', emoji: 'ğŸš€', color: 'from-emerald-500 to-teal-500' },
                                };
                                renderV3RoundUI(window.currentRound, window.roundQuestions, roundMeta[window.currentRound]);
                                setTimeout(() => restoreRoundAnswers(), 100);
                            } else {
                                // ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ ë‹¨ê³„ ë³µì›
                                renderNarrativeStep();
                                // ì €ì¥ëœ ë‹µë³€ ë³µì›
                                setTimeout(() => restoreNarrativeAnswers(), 150);
                            }
                        }
                    }, 200);  // ì¡°ê¸ˆ ë” ì—¬ìœ  ìˆê²Œ
                    
                    // ì‹¬ì¸µ ì§ˆë¬¸ ë‹¨ê³„ë©´ Step 3 ì»¨í…Œì´ë„ˆë¥¼ ì§ì ‘ í‘œì‹œ (currentStepì€ 4 ìœ ì§€)
                    if (restoredStep >= 4) {
                        // Step 3 ì»¨í…Œì´ë„ˆë§Œ í‘œì‹œ (goToStep ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - currentStep ë®ì–´ì“°ê¸° ë°©ì§€)
                        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
                        document.getElementById('step3')?.classList.remove('hidden');
                        currentStep = 4;
                        window.currentStep = 4;
                        // ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
                        document.querySelectorAll('.step-dot').forEach((el) => {
                            const circle = el.querySelector('span:first-child');
                            const stepNum = parseInt(el.dataset.step, 10);
                            if (stepNum <= 4) {
                                circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                                circle.classList.add('bg-wiki-primary', 'text-white');
                            }
                        });
                    } else {
                        goToStep(restoredStep, true);
                    }
                    return;
                }
            }
            
            // request_idê°€ ìˆìœ¼ë©´ ê²°ê³¼ ì§ì ‘ ë¡œë“œ (í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ì¡°íšŒìš©)
            const urlRequestId = urlParams.get('request_id');
            if (urlRequestId) {
                try {
                    showLoading();
                    const response = await fetch('/api/ai-analyzer/result/' + urlRequestId);
                    const data = await response.json();
                    hideLoading();

                    if (response.ok && data) {
                        currentRequestId = parseInt(urlRequestId, 10);
                        displayResults(data);
                        goToStep(3);  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                        return;
                    } else {
                        alert('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    hideLoading();
                    alert('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì‹œë‚˜ë¦¬ì˜¤ ìë™ ì‹¤í–‰ (?scenario=stability_seeker ë“±)
            const scenarioId = urlParams.get('scenario');
            if (scenarioId) {
                try {
                    showLoading();

                    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                    const loadingEl = document.querySelector('.loading-overlay');
                    if (loadingEl) {
                        loadingEl.innerHTML = \`
                            <div class="text-center">
                                <div class="animate-spin w-12 h-12 border-4 border-wiki-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                                <p class="text-white text-lg font-medium">ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</p>
                                <p class="text-wiki-muted mt-2">\${scenarioId}</p>
                            </div>
                        \`;
                    }

                    // í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
                    const response = await fetch('/api/ai-analyzer/test/run-scenario', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scenario_id: scenarioId })
                    });
                    const testData = await response.json();

                    if (!testData.success) {
                        throw new Error(testData.error || 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
                    }


                    // ê²°ê³¼ ë¡œë“œ
                    if (testData.request_id) {
                        const resultResponse = await fetch('/api/ai-analyzer/result/' + testData.request_id);
                        const resultData = await resultResponse.json();

                        hideLoading();

                        if (resultResponse.ok && resultData) {
                            currentRequestId = testData.request_id;

                            // ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ë°°ë„ˆ í‘œì‹œ
                            setTimeout(() => {
                                const banner = document.createElement('div');
                                banner.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-purple-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3';
                                banner.innerHTML = \`
                                    <i class="fas fa-flask"></i>
                                    <div>
                                        <div class="font-medium">í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: \${testData.scenario?.name || scenarioId}</div>
                                        <div class="text-sm opacity-80">ê²€ì¦ ì ìˆ˜: \${testData.verification?.score || 0}/100 (\${testData.verification?.passed ? 'í†µê³¼' : 'ì‹¤íŒ¨'})</div>
                                    </div>
                                    <button onclick="goToStep(1); this.closest('.fixed').remove();" class="ml-2 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-sm font-medium transition">
                                        í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
                                    </button>
                                    <button onclick="this.parentElement.remove()" class="hover:bg-white/20 p-1 rounded">
                                        <i class="fas fa-times"></i>
                                    </button>
                                \`;
                                document.body.appendChild(banner);
                            }, 500);

                            displayResults(resultData);
                            goToStep(3);  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                            return;
                        }
                    }

                    hideLoading();
                    alert('ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    hideLoading();
                    alert('ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + e.message);
                }
            }

            // ì €ì¥ëœ ë¦¬í¬íŠ¸ ë·° ëª¨ë“œ í™•ì¸ (?view=requestId)
            const viewResultId = new URLSearchParams(window.location.search).get('view');
            if (viewResultId) {
                showLoading('ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
                try {
                    const res = await fetch('/api/ai-analyzer/saved-result/' + viewResultId);
                    const data = await res.json();
                    hideLoading();
                    if (data.success && data.result) {
                        currentRequestId = data.request_id;
                        displayResults({ result: data.result, request_id: data.request_id });
                        goToStep(3);
                    } else {
                        showErrorToast('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        goToStep(1);
                    }
                } catch (e) {
                    hideLoading();
                    showErrorToast('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    goToStep(1);
                }
            } else {
            // URLì— session_idê°€ ì—†ìœ¼ë©´ ì„œë²„/ë¡œì»¬ì—ì„œ ë³µì› ì‹œë„
            const restoredStep = await autoRestoreDraft();
            if (restoredStep === 'modal') {
                // ëª¨ë‹¬ì´ í‘œì‹œë˜ë¯€ë¡œ ê¸°ë³¸ Stepìœ¼ë¡œ ëŒ€ê¸°
                goToStep(1);
            } else if (restoredStep) {
                // ë³µì›ëœ ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    updateStep1Selection();  // 5ì¶• ì¢Œí‘œ UI ë³µì›
                }, 200);
                goToStep(restoredStep, true);  // skipRender = true
            } else {
                goToStep(1);           // Step 1ë¶€í„° ì‹œì‘
            }
            }
            
            // Step 2 ë²„íŠ¼ ê¸°ë³¸ í•¸ë“¤ëŸ¬ ì„¤ì • (renderNarrativeStep/renderV3RoundUIì—ì„œ ë®ì–´ì”€)
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    goToStep(1);
                    goToProfileStep2();
                };
            }
            if (analyzeBtn) {
                analyzeBtn.onclick = () => {
                    // ê¸°ë³¸ê°’: ì•„ë¬´ ë™ì‘ ì—†ìŒ (renderNarrativeStepì—ì„œ ì„¤ì •ë¨)
                };
            }
            
            // ì…ë ¥ ë³€ê²½ ê°ì§€ - ì €ì¥ ë²„íŠ¼ ë¦¬ì…‹ (ì €ì¥ ë²„íŠ¼ ìì²´ ì œì™¸)
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('[id$="-save-btn"]') || target.closest('#analyze-btn')) return;
                if (target.closest('.role-card, .career-stage-btn, .goal-chip, .skill-btn, .constraint-option, .trans-chip, .trans-radio, .radio-option, .trans-checkbox')) {
                    resetSaveButtons();
                }
            });
            document.addEventListener('input', (e) => {
                if (e.target.matches('input, textarea, select')) {
                    resetSaveButtons();
                }
            });
        });
    </script>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI ì§ì—… ì¶”ì²œ - Careerwiki'))
})

// AI Major Analyzer v2.0.0 - 5ë‹¨ê³„ í”Œë¡œìš° (ì§ì—… ì¶”ì²œê³¼ ë™ì¼ êµ¬ì¡°)
app.get('/analyzer/major', requireAuth, (c) => {
  const debugMode = c.req.query('debug') === 'true'
  
  // ì „ê³µìš© ìŠ¤í…Œì´ì§€
  const majorStagesJson = JSON.stringify([
    { id: 'major_child', label: 'ì–´ë¦°ì´', description: 'í˜¸ê¸°ì‹¬ íƒìƒ‰', emoji: 'ğŸŒˆ' },
    { id: 'major_elementary', label: 'ì´ˆë“±í•™ìƒ', description: 'ê´€ì‹¬ì‚¬ ë°œê²¬', emoji: 'ğŸ§’' },
    { id: 'major_middle', label: 'ì¤‘í•™ìƒ', description: 'ì§„ë¡œ íƒìƒ‰ ì¤‘', emoji: 'ğŸ’' },
    { id: 'major_high', label: 'ê³ ë“±í•™ìƒ', description: 'ëŒ€í•™ ì§„í•™ ì¤€ë¹„', emoji: 'ğŸ“–' },
    { id: 'major_freshman', label: 'ëŒ€í•™ ì‹ ì…ìƒ', description: 'ì „ê³µ íƒìƒ‰ ì¤‘', emoji: 'ğŸ“' },
    { id: 'major_student', label: 'ëŒ€í•™ ì¬í•™ìƒ', description: 'ì „ê³¼/ë³µìˆ˜ì „ê³µ ê³ ë ¤', emoji: 'ğŸ“š' },
    { id: 'major_graduate', label: 'ëŒ€í•™ì› ì§„í•™', description: 'ì„/ë°•ì‚¬ ì¤€ë¹„', emoji: 'ğŸ”¬' },
  ])
  
  // Universal Questions (ì „ê³µìš©)
  const majorQuestionsJson = JSON.stringify([
    { id: 'univ_interest', order: 1, text: 'ì–´ë–¤ ë¶„ì•¼ì— ê´€ì‹¬ì´ ìˆë‚˜ìš”?', ui_type: 'chips', options: [
      { value: 'tech', label: 'ê¸°ìˆ /IT', emoji: 'ğŸ’»' }, { value: 'science', label: 'ìì—°ê³¼í•™', emoji: 'ğŸ”¬' },
      { value: 'humanities', label: 'ì¸ë¬¸í•™', emoji: 'ğŸ“œ' }, { value: 'social', label: 'ì‚¬íšŒê³¼í•™', emoji: 'ğŸ›ï¸' },
      { value: 'art', label: 'ì˜ˆìˆ /ë””ìì¸', emoji: 'ğŸ¨' }, { value: 'business', label: 'ê²½ì˜/ê²½ì œ', emoji: 'ğŸ’¼' },
      { value: 'health', label: 'ì˜ë£Œ/ë³´ê±´', emoji: 'ğŸ¥' }, { value: 'education', label: 'êµìœ¡', emoji: 'ğŸ“š' },
      { value: 'engineering', label: 'ê³µí•™', emoji: 'âš™ï¸' }, { value: 'law', label: 'ë²•í•™', emoji: 'âš–ï¸' },
    ], allow_unknown: true, unknown_label: 'ì˜ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.interest.keywords', required: true, max_selections: 5 },
    { id: 'univ_good_subjects', order: 2, text: 'ìì‹  ìˆê±°ë‚˜ ì¢‹ì•„í•˜ëŠ” ê³¼ëª©ì€?', ui_type: 'chips', options: [
      { value: 'korean', label: 'êµ­ì–´', emoji: 'ğŸ“–' }, { value: 'math', label: 'ìˆ˜í•™', emoji: 'ğŸ”¢' },
      { value: 'english', label: 'ì˜ì–´', emoji: 'ğŸŒ' }, { value: 'science', label: 'ê³¼í•™', emoji: 'ğŸ§ª' },
      { value: 'social', label: 'ì‚¬íšŒ', emoji: 'ğŸ—ºï¸' }, { value: 'history', label: 'ì—­ì‚¬', emoji: 'ğŸ“œ' },
      { value: 'art', label: 'ë¯¸ìˆ ', emoji: 'ğŸ¨' }, { value: 'music', label: 'ìŒì•…', emoji: 'ğŸµ' },
    ], allow_unknown: true, unknown_label: 'ë”±íˆ ì—†ì–´ìš”', fact_key: 'profile.good_subjects', required: true, max_selections: 4 },
    { id: 'univ_weak_subjects', order: 3, text: 'ì–´ë µê±°ë‚˜ í”¼í•˜ê³  ì‹¶ì€ ê³¼ëª©ì€?', ui_type: 'chips', options: [
      { value: 'korean', label: 'êµ­ì–´', emoji: 'ğŸ“–' }, { value: 'math', label: 'ìˆ˜í•™', emoji: 'ğŸ”¢' },
      { value: 'english', label: 'ì˜ì–´', emoji: 'ğŸŒ' }, { value: 'science', label: 'ê³¼í•™', emoji: 'ğŸ§ª' },
      { value: 'social', label: 'ì‚¬íšŒ', emoji: 'ğŸ—ºï¸' }, { value: 'history', label: 'ì—­ì‚¬', emoji: 'ğŸ“œ' },
    ], fact_key: 'profile.weak_subjects', required: true, max_selections: 3 },
    { id: 'univ_workstyle', order: 4, text: 'ê³µë¶€í•  ë•Œ ì–´ë–¤ ë°©ì‹ì´ ë” ë§ë‚˜ìš”?', ui_type: 'radio', options: [
      { value: 'theory', label: 'ì´ë¡ /ê°œë… í•™ìŠµ', emoji: 'ğŸ“š' }, { value: 'practice', label: 'ì‹¤ìŠµ/ì‹¤í—˜', emoji: 'ğŸ”§' },
      { value: 'discuss', label: 'í† ë¡ /ë°œí‘œ', emoji: 'ğŸ’¬' }, { value: 'mixed', label: 'ìƒí™©ì— ë”°ë¼', emoji: 'ğŸ”€' },
    ], allow_unknown: true, unknown_label: 'ëª¨ë¥´ê² ì–´ìš”', fact_key: 'profile.workstyle.study', required: true },
    { id: 'univ_priority', order: 5, text: 'ì „ê³µ ì„ íƒì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê±´?', ui_type: 'radio', options: [
      { value: 'interest', label: 'ë‚´ ê´€ì‹¬ì‚¬ì™€ ë§ëŠ” ê²ƒ', emoji: 'â¤ï¸' }, { value: 'job', label: 'ì·¨ì—… ì˜ ë˜ëŠ” ê²ƒ', emoji: 'ğŸ’¼' },
      { value: 'salary', label: 'ì—°ë´‰ì´ ë†’ì€ ê²ƒ', emoji: 'ğŸ’°' }, { value: 'stable', label: 'ì•ˆì •ì ì¸ ê²ƒ', emoji: 'ğŸ ' },
      { value: 'growth', label: 'ì„±ì¥ ê°€ëŠ¥ì„±', emoji: 'ğŸ“ˆ' }, { value: 'social', label: 'ì‚¬íšŒì— ê¸°ì—¬', emoji: 'ğŸŒ' },
    ], allow_unknown: true, unknown_label: 'ì•„ì§ ëª¨ë¥´ê² ì–´ìš”', fact_key: 'priority.top1', required: true },
  ])
  
  // 5ì¶• ë°ì´í„° JSON (ì „ê³µ ì¶”ì²œìš©)
  const majorStudentOptionsJson = JSON.stringify(MAJOR_STUDENT_OPTIONS)
  const roleIdentityOptionsJson = JSON.stringify(ROLE_IDENTITY_OPTIONS)
  const careerStageOptionsJson = JSON.stringify(CAREER_STAGE_OPTIONS)
  const transitionStatusOptionsJson = JSON.stringify(TRANSITION_STATUS_OPTIONS)
  const skillLevelOptionsJson = JSON.stringify(SKILL_LEVEL_OPTIONS)
  const constraintOptionsJson = JSON.stringify(CONSTRAINT_OPTIONS)
  const transitionSignalQuestionsJson = JSON.stringify(TRANSITION_SIGNAL_QUESTIONS)
  const identityAnchorPatternsJson = JSON.stringify(IDENTITY_ANCHOR_PATTERNS)
  
  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 pt-0 md:pt-2">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-center text-white">
            <i class="fas fa-university mr-2 text-wiki-primary"></i>AI ì „ê³µ ì¶”ì²œ
            ${debugMode ? '<span class="ml-2 text-sm bg-yellow-500 text-black px-2 py-1 rounded">DEBUG MODE</span>' : ''}
        </h1>

        <!-- Step Indicator (5ë‹¨ê³„) -->
        <div class="flex justify-center items-center gap-2 md:gap-4 mb-6 flex-wrap" id="step-indicator">
            <div class="step-dot flex flex-col items-center active" data-step="1">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-primary text-white rounded-full font-bold text-sm md:text-base">1</span>
                <span class="text-xs mt-1">í”„ë¡œí•„</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="2">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-sm md:text-base">2</span>
                <span class="text-xs mt-1">ì‹¬ì¸µ</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="3">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-sm md:text-base">3</span>
                <span class="text-xs mt-1">ê²°ê³¼</span>
            </div>
        </div>
        
        <!-- ë³¸ì¸ ê³„ì • ì‚¬ìš© ì•ˆë‚´ ë°°ë„ˆ (Step 1ì—ì„œë§Œ í‘œì‹œ) -->
        <div id="account-warning-banner" class="mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-amber-400 text-lg"></i>
                <div>
                    <p class="text-amber-300 font-medium">ë°˜ë“œì‹œ ë³¸ì¸ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”</p>
                    <p class="text-sm text-amber-200/70">ì…ë ¥í•œ ì •ë³´ëŠ” í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •ì— ì €ì¥ë©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒì˜ ê³„ì •ìœ¼ë¡œ ì§„í–‰í•˜ë©´ ë°ì´í„°ê°€ ì„ì¼ ìˆ˜ ìˆì–´ìš”.</p>
                </div>
            </div>
        </div>
        
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-wiki-bg/90 z-50 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-wiki-primary mx-auto mb-4"></div>
                <p class="text-xl font-semibold" id="loading-message">ë¶„ì„ ì¤‘...</p>
                <p class="text-wiki-muted text-sm mt-2" id="loading-submessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
        </div>
        
        <!-- ì´ì–´í•˜ê¸°/ìƒˆë¡œì‹œì‘ ëª¨ë‹¬ -->
        <div id="continue-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-wiki-border/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-500 to-wiki-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-history text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">ì§„í–‰ ì¤‘ì¸ ë¶„ì„ì´ ìˆìŠµë‹ˆë‹¤</h3>
                    <p class="text-wiki-muted text-sm" id="continue-modal-info"></p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="continueFromDraft()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-wiki-primary text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-play mr-2"></i>ì´ì–´ì„œ í•˜ê¸°
                    </button>
                    <button type="button" onclick="showRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-redo mr-2"></i>ìƒˆë¡œ ì‹œì‘í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ìƒˆë¡œ ì‹œì‘ ê²½ê³  ëª¨ë‹¬ -->
        <div id="restart-warning-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-red-500/30">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">ì •ë§ ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?</h3>
                    <p class="text-wiki-muted text-sm">ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="confirmRestart()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-trash mr-2"></i>ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘
                    </button>
                    <button type="button" onclick="hideRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-arrow-left mr-2"></i>ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Step 1: í•™ìƒ ìœ í˜• ì„ íƒ (ì „ê³µ ì¶”ì²œ ì „ìš©) -->
        <div id="step1" class="step-content glass-card p-6 md:p-8 rounded-2xl mb-6">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300">
                    í˜„ì¬ í•™ì—… ìƒí™©ì„ ì•Œë ¤ì£¼ì„¸ìš”
                </h2>
                <p class="text-wiki-muted mt-2">í•™ìƒ ìœ í˜•ì— ë§ëŠ” ì „ê³µì„ ì¶”ì²œí•´ë“œë ¤ìš”</p>
            </div>
            
            <div class="space-y-8" id="major-state-form">
                <!-- í•™ìƒ ìœ í˜• -->
                <div class="state-axis-section" data-axis="student_type">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">1</div>
                        <h3 class="text-lg font-bold">ë‚˜ëŠ” í˜„ì¬?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="student-type-options">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </div>
                    <div id="student-sub-options" class="hidden">
                        <!-- ê³ ë“±í•™ìƒ/ëŒ€í•™ìƒ í•˜ìœ„ì˜µì…˜ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì „ê³µ ì„ íƒ ëª©ì  -->
                <div class="state-axis-section" data-axis="major_purpose">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-violet-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">2</div>
                        <h3 class="text-lg font-bold">ì „ê³µì„ ì°¾ëŠ” ì´ìœ ëŠ”?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="career-stage-options"></div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 3: ì „ê³µ ì„ íƒ ìƒí™© (ë‹¤ì¤‘ ì„ íƒ) -->
                <div class="state-axis-section" data-axis="transition_status">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">3</div>
                        <h3 class="text-lg font-bold">ì „ê³µ ì„ íƒ ìƒí™©ì€?</h3>
                        <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">ë³µìˆ˜ ì„ íƒ</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">í•´ë‹¹í•˜ëŠ” ìƒí™©ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="transition-status-options"></div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 4: ìˆ™ë ¨ë„ -->
                <div class="state-axis-section" data-axis="skill_level">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">4</div>
                        <h3 class="text-lg font-bold">ê´€ì‹¬ ë¶„ì•¼ì—ì„œì˜ ìˆ™ë ¨ë„ëŠ”?</h3>
                    </div>
                    <div class="ml-11 mb-4 p-3 bg-violet-500/10 rounded-lg border border-violet-500/20">
                        <p class="text-sm text-violet-300">
                            <i class="fas fa-lightbulb mr-2"></i>
                            í˜„ì¬ í•™ë ¥ê³¼ ë¬´ê´€í•˜ê²Œ, <strong>ì•ìœ¼ë¡œ ê°€ê³  ì‹¶ì€ ë¶„ì•¼</strong> ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”
                        </p>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3" id="skill-level-options"></div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- ì¶• 5: ì œì•½ ì¡°ê±´ -->
                <div class="state-axis-section" data-axis="constraints">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">5</div>
                        <h3 class="text-lg font-bold">í˜„ì¬ ì œì•½ì´ ìˆë‚˜ìš”?</h3>
                        <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full">ì„ íƒì‚¬í•­</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">í•´ë‹¹í•˜ëŠ” ì œì•½ì„ ì„ íƒí•˜ë©´ ë§ì¶¤ ì¶”ì²œì— ë°˜ì˜ë©ë‹ˆë‹¤</p>
                    <div class="max-w-2xl mx-auto" id="constraint-options"></div>
                </div>
            </div>
            
            <!-- êµ¬ë¶„ì„  -->
            <div class="border-t border-wiki-border/30 my-6"></div>

            <!-- ê¸°ë³¸ ì •ë³´ (ê´€ì‹¬ì‚¬) -->
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">6</div>
                <h3 class="text-lg font-bold">ê´€ì‹¬ì‚¬ & ê¸°ë³¸ ì •ë³´</h3>
            </div>
            <form id="universal-form">
                <div id="universal-questions" class="space-y-6"></div>
            </form>

            <!-- êµ¬ë¶„ì„  -->
            <div class="border-t border-wiki-border/30 my-6"></div>

            <!-- ì•ìœ¼ë¡œì˜ ë°©í–¥ (ì „ì´ ì‹ í˜¸) -->
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">7</div>
                <h3 class="text-lg font-bold">ì•ìœ¼ë¡œì˜ ë°©í–¥</h3>
            </div>
            <p class="text-sm text-wiki-muted mb-4 ml-11">ì›í•˜ëŠ” ë³€í™”ì™€ ëª©í‘œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</p>
            <div id="transition-signal-form" class="space-y-6"></div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="flex justify-center gap-4 pt-8 mt-6 border-t border-wiki-border/30">
                <a href="/analyzer" class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>ìœ í˜• ë‹¤ì‹œ ì„ íƒ
                </a>
                <button type="button" id="step1-next-btn" onclick="goToStep2WithLoading()" disabled
                        class="px-10 py-4 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold rounded-xl shadow-lg shadow-wiki-primary/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-wiki-primary/40 hover:scale-[1.02] active:scale-[0.98]">
                    <i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ
                </button>
            </div>
                </div>

        <!-- Step 2: ì‹¬ì¸µ ì¸í„°ë·° (V3) -->
        <div id="step2" class="step-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-comments text-wiki-primary mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm" id="step2-subtitle">ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ë“¤ë ¤ì£¼ì„¸ìš”</p>

            <div id="followup-questions-form" class="space-y-6"></div>

            <div class="flex justify-center gap-4 pt-6">
                <button type="button" id="step2-prev-btn" onclick="goToStep(1)" class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                    <i class="fas fa-arrow-left mr-2"></i>ì´ì „
                </button>
                <button type="button" id="analyze-btn"
                        class="px-12 py-4 bg-gradient-to-r from-purple-500 to-wiki-secondary text-white font-bold rounded-xl hover-glow transition transform hover:scale-105">
                    <i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ
                </button>
            </div>
                </div>

        <!-- Step 3: ê²°ê³¼ -->
        <div id="step3" class="step-content hidden">
            <!-- Confidence UI: ê·¼ê±° ê°•ë„ + ê²°ì •ë³€ìˆ˜ -->
            <div id="confidence-card" class="glass-card p-6 rounded-2xl mb-6 border border-emerald-500/30 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-emerald-400"></i>
                    <span>ì¶”ì²œ ê·¼ê±° ê°•ë„</span>
                </h2>
                
                <!-- ê·¼ê±° ê°•ë„ ê²Œì´ì§€ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-wiki-muted">ì‹ ë¢°ë„</span>
                        <span id="confidence-score-text" class="text-lg font-bold text-emerald-400">--%</span>
                    </div>
                    <div class="w-full bg-wiki-bg rounded-full h-3 overflow-hidden">
                        <div id="confidence-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="confidence-description" class="text-xs text-wiki-muted mt-2">-</p>
                </div>
                
                <!-- ê²°ì • ë³€ìˆ˜ -->
                <div>
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-key text-amber-400"></i>
                        <span>ì´ ë‹µë³€ë“¤ì´ ê²°ê³¼ì— ì˜í–¥ì„ ì£¼ì—ˆì–´ìš”</span>
                    </h3>
                    <div id="key-decisions" class="space-y-2"></div>
                </div>
                </div>
                
            <div class="glass-card p-6 rounded-2xl mb-6">
                <h2 class="text-xl font-bold mb-4 text-center">
                    <i class="fas fa-star text-yellow-400 mr-2"></i>ì¶”ì²œ ì „ê³µ
                </h2>
                <div id="major-results" class="space-y-4"></div>
                </div>
                
            <div class="text-center">
                <button onclick="resetAnalysis()" class="px-6 py-3 bg-wiki-card text-white rounded-lg hover:bg-wiki-primary transition">
                    <i class="fas fa-redo mr-2"></i>ìƒˆë¡œ ë¶„ì„í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const DEBUG_MODE = ${debugMode};
        const UNIVERSAL_QUESTIONS = ${majorQuestionsJson};
        const MAJOR_STAGES = ${majorStagesJson};
        
        // 5ì¶• ë°ì´í„°
        const ROLE_IDENTITY_OPTIONS = ${roleIdentityOptionsJson};
        const CAREER_STAGE_OPTIONS = ${careerStageOptionsJson};
        const TRANSITION_STATUS_OPTIONS = ${transitionStatusOptionsJson};
        const SKILL_LEVEL_OPTIONS = ${skillLevelOptionsJson};
        const CONSTRAINT_OPTIONS = ${constraintOptionsJson};
        const TRANSITION_SIGNAL_QUESTIONS = ${transitionSignalQuestionsJson};
        const IDENTITY_ANCHOR_PATTERNS = ${identityAnchorPatternsJson};
        
        // ìƒíƒœ ê´€ë¦¬
        let currentStep = 1;
        let selectedAnalysisType = 'major';
        let selectedStage = null;
        let universalAnswers = {};
        let followupAnswers = {};
        let transitionSignalAnswers = {};
        let currentSessionId = null;
        let currentRequestId = null;
        window.analyzerUnsavedChanges = false;

        // V3 ì‹¬ì¸µ ì¸í„°ë·° ìƒíƒœ
        window.V3_MODE = true;
        window.currentRound = 0;
        window.roundAnswers = [];
        window.narrativeFacts = null;
        window.roundQuestions = null;
        window.savedNarrativeQuestions = null;
        
        let careerState = {
            role_identity: null,
            career_stage_years: null,
            transition_status: null,
            skill_level: null,
            constraints: {}
        };
        
        // ë¡œë”©
        function showLoading(message, submessage = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-submessage').textContent = submessage;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // ============================================
        // í¸ì§‘ ëª¨ë“œ ìœ í‹¸ë¦¬í‹° (Major)
        // ============================================
        function showEditModeBanner() {
            if (!window.__editMode) return;
            const banner = document.createElement('div');
            banner.id = 'edit-mode-banner';
            banner.className = 'mb-4 p-3 rounded-xl border';
            banner.style.cssText = 'border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.08);';
            banner.innerHTML = \`
              <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2">
                  <i class="fas fa-edit text-amber-400"></i>
                  <span class="text-amber-300 text-sm font-medium">ìˆ˜ì • ëª¨ë“œ</span>
                  <span class="text-amber-200/70 text-xs">ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì´í›„ ë‹¨ê³„ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤</span>
                </div>
                <button onclick="cancelEditMode()" class="px-3 py-1 text-xs rounded-lg border border-wiki-border text-wiki-muted hover:text-white transition">ì·¨ì†Œ</button>
              </div>\`;
            const container = document.querySelector('.max-w-6xl') || document.querySelector('main');
            if (container) container.insertBefore(banner, container.firstChild);
        }

        async function cancelEditMode() {
            if (!window.__editMode) return;
            try {
                await fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                    method: 'DELETE', credentials: 'same-origin'
                });
            } catch (e) {}
            window.location.href = '/user/ai-results/' + window.__sourceRequestId;
        }

        function getEditModePayloadExtras() {
            if (!window.__editMode) return {};
            return {
                session_id: window.__originalSessionId,
                edit_mode: true,
                edit_session_id: window.__editSessionId,
                source_request_id: window.__sourceRequestId,
                version_note: 'ì…ë ¥ ìˆ˜ì •',
            };
        }

        function detectStep1Changes() {
            if (!window.__editMode) return false;
            return JSON.stringify(careerState) !== window.__editSnapshot.careerState;
        }

        function detectStep2Changes() {
            if (!window.__editMode) return false;
            return JSON.stringify(universalAnswers) !== window.__editSnapshot.universalAnswers;
        }

        function detectStep3Changes() {
            if (!window.__editMode) return false;
            return JSON.stringify(transitionSignalAnswers) !== window.__editSnapshot.transitionSignalAnswers;
        }

        function cascadeResetFromStep1() {
            universalAnswers = {};
            transitionSignalAnswers = {};
            followupAnswers = {};
            window.narrativeFacts = null;
            window.roundAnswers = [];
            window.roundQuestions = null;
            window.currentRound = 0;
            window.savedNarrativeQuestions = null;
            window.__editSnapshot.universalAnswers = '{}';
            window.__editSnapshot.transitionSignalAnswers = '{}';
            if (window.__editSnapshot) {
                window.__editSnapshot.narrativeFacts = '{}';
                window.__editSnapshot.roundAnswers = '[]';
            }
        }

        function cascadeResetFromStep2() {
            transitionSignalAnswers = {};
            followupAnswers = {};
            window.__editSnapshot.transitionSignalAnswers = '{}';
        }

        function detectNarrativeChanges() {
            if (!window.__editMode) return false;
            return JSON.stringify(window.narrativeFacts || {}) !== (window.__editSnapshot.narrativeFacts || '{}');
        }

        function detectRoundChanges(roundNumber) {
            if (!window.__editMode) return false;
            const snapRounds = JSON.parse(window.__editSnapshot.roundAnswers || '[]');
            const currRounds = window.roundAnswers || [];
            const snapR = snapRounds.filter(a => a.roundNumber === roundNumber);
            const currR = currRounds.filter(a => a.roundNumber === roundNumber);
            return JSON.stringify(snapR) !== JSON.stringify(currR);
        }

        function cascadeResetFromNarrative() {
            window.roundAnswers = [];
            window.roundQuestions = null;
            window.currentRound = 0;
            if (window.__editSnapshot) {
                window.__editSnapshot.roundAnswers = '[]';
            }
        }

        function cascadeResetFromRound(roundNumber) {
            window.roundAnswers = (window.roundAnswers || []).filter(a => a.roundNumber <= roundNumber);
            window.currentRound = roundNumber;
            if (window.__editSnapshot) {
                window.__editSnapshot.roundAnswers = JSON.stringify(window.roundAnswers);
            }
        }

        function cascadeResetFromStep3() {
            followupAnswers = {};
        }

        // ============================================
        // ì´ë ¥ì„œ ì—…ë¡œë“œ ì²˜ë¦¬ (ì „ê³µ ì¶”ì²œ)
        // ============================================
        async function handleResumeUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showResumeError('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showResumeError('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('resume-loading').classList.remove('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.add('hidden');
            
            try {
                await loadPdfJs();
                const pdfText = await extractTextFromPdf(file);
                
                if (pdfText.length < 100) {
                    showResumeError('ë¬¸ì„œì—ì„œ ì¶©ë¶„í•œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const response = await fetch('/api/ai-analyzer/resume/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: pdfText,
                        session_id: currentSessionId,
                        save_to_draft: false,
                    }),
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'íŒŒì‹± ì‹¤íŒ¨');
                
                applyResumeParseResult(data.career_state, data.data);
                
                document.getElementById('resume-loading').classList.add('hidden');
                document.getElementById('resume-status').classList.remove('hidden');
                
                // ì´ë ¥ì„œ í˜•ì‹ í™•ì¸ (ì¶”ì¶œëœ ë°ì´í„° ê¸°ì¤€)
                const extracted = data.data.extracted || {};
                const hasSkills = extracted.skills?.length > 0;
                const hasCerts = extracted.certifications?.length > 0;
                const hasEducation = !!extracted.education_level;
                const hasExperience = extracted.total_experience_years !== null;
                const hasRole = !!extracted.current_role_type;
                
                const extractedCount = [hasSkills, hasCerts, hasEducation, hasExperience, hasRole].filter(Boolean).length;
                
                if (extractedCount < 2) {
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-amber-400">âš ï¸ ì¶©ë¶„í•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆì–´ìš”. ê·¸ë˜ë„ ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ì°¸ê³ ë©ë‹ˆë‹¤.</span>';
                } else {
                    const infoSummary = [];
                    if (hasSkills) infoSummary.push('ìŠ¤í‚¬ ' + extracted.skills.length + 'ê°œ');
                    if (hasCerts) infoSummary.push('ìê²©ì¦ ' + extracted.certifications.length + 'ê°œ');
                    if (hasEducation) infoSummary.push(extracted.education_level);
                    if (hasExperience) infoSummary.push('ê²½ë ¥ ' + extracted.total_experience_years + 'ë…„');
                    if (hasRole) infoSummary.push(extracted.current_role_type);
                    
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-emerald-400">âœ“ ë¶„ì„ ì™„ë£Œ! (' + infoSummary.slice(0, 3).join(', ') + ')</span>';
                }
                
            } catch (error) {
                showResumeError(error.message || 'ë¬¸ì„œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function showResumeError(message) {
            document.getElementById('resume-loading').classList.add('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.remove('hidden');
            document.getElementById('resume-error-text').textContent = message;
        }
        
        async function loadPdfJs() {
            return new Promise((resolve, reject) => {
                if (window.pdfjsLib) { resolve(); return; }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = () => reject(new Error('PDF.js ë¡œë“œ ì‹¤íŒ¨'));
                document.head.appendChild(script);
            });
        }
        
        async function extractTextFromPdf(file) {
            await loadPdfJs();
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            return fullText.trim();
        }
        
        function applyResumeParseResult(careerStateFromResume, parsedData) {
            // ì „í™˜ ìƒíƒœ ì„ íƒ
            if (careerStateFromResume.transition_status) {
                const transBtn = document.querySelector(\`#transition-status-options [data-value="\${careerStateFromResume.transition_status}"]\`);
                if (transBtn && !transBtn.classList.contains('selected')) transBtn.click();
            }
            
            // ìˆ™ë ¨ë„ ì„ íƒ
            if (careerStateFromResume.skill_level !== undefined && careerStateFromResume.skill_level !== null) {
                const skillBtn = document.querySelector(\`#skill-level-options [data-value="\${careerStateFromResume.skill_level}"]\`);
                if (skillBtn) skillBtn.click();
            }
            
        }
        
        // ============================================
        // ì „ê³µ ì¶”ì²œìš© ë¹„í™œì„±í™” ê·œì¹™
        // ============================================
        const STUDENT_TYPE_DISABLED_RULES = {
            middle: {
                career_stage: ['univ', 'grad', 'work_exp'],
                transition_status: ['major_change', 'double_major'],
                skill_level: [3, 4],
                reasons: {
                    career_stage: 'ì¤‘í•™ìƒì€ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”',
                    transition_status: 'ëŒ€í•™ ì…í•™ í›„ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”',
                    skill_level: 'ì•„ì§ í•´ë‹¹ ë‹¨ê³„ê°€ ì•„ë‹ˆì—ìš”'
                }
            },
            high: {
                career_stage: ['grad', 'work_exp'],
                transition_status: ['major_change', 'double_major'],
                skill_level: [4],
                reasons: {
                    career_stage: 'ê³ ë“±í•™ìƒì€ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”',
                    transition_status: 'ëŒ€í•™ ì…í•™ í›„ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”',
                    skill_level: 'ì•„ì§ í•´ë‹¹ ë‹¨ê³„ê°€ ì•„ë‹ˆì—ìš”'
                }
            },
            univ: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            },
            grad: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            }
        };
        
        let studentType = null;
        let majorPurpose = null;
        
        // ============================================
        // 5ì¶• UI ë Œë”ë§ (ì „ê³µ ì „ìš© - í”„ë¡œí˜ì…”ë„ ë””ìì¸)
        // ============================================
        function renderCareerStateForm() {
            renderStudentTypeOptions();
            renderMajorPurposeOptions();
            updateTransitionStatusOptionsMajor();
            updateSkillLevelOptionsMajor();
            renderConstraintOptionsMajor();
            renderUniversalQuestions();
            renderTransitionSignalForm();
        }
        
        // í•™ìƒ ìœ í˜• ì„ íƒ (ë‹¤í¬ í…Œë§ˆ)
        function renderStudentTypeOptions() {
            const container = document.getElementById('student-type-options');
            if (!container) return;
            
            const studentTypes = [
                { value: 'child', label: 'ì–´ë¦°ì´', description: 'í˜¸ê¸°ì‹¬ íƒìƒ‰', emoji: 'ğŸŒˆ' },
                { value: 'elementary', label: 'ì´ˆë“±í•™ìƒ', description: 'ê´€ì‹¬ì‚¬ ë°œê²¬', emoji: 'ğŸ§’' },
                { value: 'middle', label: 'ì¤‘í•™ìƒ', description: 'ì§„ë¡œ íƒìƒ‰ ì¤‘', emoji: 'ğŸ’' },
                { value: 'high', label: 'ê³ ë“±í•™ìƒ', description: 'ëŒ€í•™ ì§„í•™ ì¤€ë¹„', emoji: 'ğŸ“–' },
                { value: 'univ', label: 'ëŒ€í•™ìƒ', description: 'ì „ê³µ íƒìƒ‰/ì „ê³¼/ëŒ€í•™ì›', emoji: 'ğŸ“' },
            ];
            
            container.innerHTML = studentTypes.map(opt => \`
                <button type="button" onclick="selectStudentType('\${opt.value}', this)"
                        class="student-type-card group relative overflow-hidden rounded-xl border border-wiki-border/50 bg-wiki-card/80 p-4 hover:bg-wiki-card hover:border-cyan-500/50 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/10"
                        data-value="\${opt.value}">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-cyan-500/10 to-transparent rounded-bl-full"></div>
                    <div class="relative z-10">
                        <div class="text-3xl mb-2 transform group-hover:scale-110 transition-transform">\${opt.emoji}</div>
                        <div class="font-semibold text-white">\${opt.label}</div>
                        <div class="text-xs text-wiki-muted mt-1">\${opt.description}</div>
                    </div>
                </button>
            \`).join('');
        }
        
        function selectStudentType(value, btnEl) {
            studentType = value;
            careerState.role_identity = 'student'; // ì „ê³µ ì¶”ì²œì€ í•­ìƒ student

            // studentType â†’ selectedStage ë§¤í•‘
            const stageMap = {
                child: 'major_child',
                elementary: 'major_elementary',
                middle: 'major_middle',
                high: 'major_high',
                univ: 'major_student',
            };
            selectedStage = stageMap[value] || 'major_high';

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('#student-type-options .student-type-card').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'bg-cyan-500/20', 'shadow-lg', 'shadow-cyan-500/20');
                btn.classList.add('border-wiki-border/50');
            });
            btnEl.classList.remove('border-wiki-border/50');
            btnEl.classList.add('border-cyan-500', 'bg-cyan-500/20', 'shadow-lg', 'shadow-cyan-500/20');

            // í•˜ìœ„ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€
            const subContainer = document.getElementById('student-sub-options');
            if (subContainer) {
                if (value === 'high') {
                    subContainer.innerHTML = renderHighSubOptions();
                    subContainer.classList.remove('hidden');
                } else if (value === 'univ') {
                    subContainer.innerHTML = renderUnivSubOptions();
                    subContainer.classList.remove('hidden');
                } else {
                    subContainer.innerHTML = '';
                    subContainer.classList.add('hidden');
                    window.academicState = null;
                }
            }

            // ë‹¤ë¥¸ ì¶•ë“¤ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateTransitionStatusOptionsMajor();
                updateSkillLevelOptionsMajor();
            }, 150);

            checkStep1Completion();
        }

        // ê³ ë“±í•™ìƒ í•˜ìœ„ì˜µì…˜ ë Œë”ë§
        function renderHighSubOptions() {
            const options = [
                { value: 'high_school_early', label: 'ìˆ˜ì‹œ', description: 'ë‚´ì‹ /í•™ìƒë¶€' },
                { value: 'high_school_regular', label: 'ì •ì‹œ', description: 'ìˆ˜ëŠ¥ ì¤€ë¹„' },
                { value: 'high_school_undecided', label: 'ë¯¸ì •', description: 'ì•„ì§ ê²°ì • ì „' },
                { value: 'retake', label: 'ì¬ìˆ˜', description: 'ì¬ìˆ˜/ë°˜ìˆ˜' },
            ];
            return '<div class="mt-3 pl-2 border-l-2 border-cyan-500/30"><p class="text-xs text-wiki-muted mb-2">ì…ì‹œ ì „í˜• ì„ íƒ (ì„ íƒì‚¬í•­)</p><div class="flex flex-wrap gap-2">' +
                options.map(opt =>
                    '<button type="button" onclick="selectHighSubType(\\'' + opt.value + '\\', this)" class="sub-option-btn px-3 py-1.5 text-xs rounded-lg border border-wiki-border/50 bg-wiki-card/60 text-wiki-muted hover:border-cyan-500/50 hover:text-white transition-all" data-value="' + opt.value + '">' +
                    '<span class="font-medium">' + opt.label + '</span> <span class="text-wiki-muted/70">Â· ' + opt.description + '</span></button>'
                ).join('') +
                '</div></div>';
        }

        // ëŒ€í•™ìƒ í•˜ìœ„ì˜µì…˜ ë Œë”ë§
        function renderUnivSubOptions() {
            const options = [
                { value: 'freshman', label: 'ì‹ ì…ìƒ', description: 'ì „ê³µ íƒìƒ‰', stage: 'major_freshman' },
                { value: 'current', label: 'ì¬í•™ìƒ', description: 'ì „ê³¼/ë³µìˆ˜ì „ê³µ', stage: 'major_student' },
                { value: 'graduate', label: 'ëŒ€í•™ì› ì¤€ë¹„', description: 'ì„Â·ë°•ì‚¬ ì§„í•™', stage: 'major_graduate' },
            ];
            return '<div class="mt-3 pl-2 border-l-2 border-cyan-500/30"><p class="text-xs text-wiki-muted mb-2">ìƒì„¸ ìœ í˜• ì„ íƒ (ì„ íƒì‚¬í•­)</p><div class="flex flex-wrap gap-2">' +
                options.map(opt =>
                    '<button type="button" onclick="selectUnivSubType(\\'' + opt.value + '\\', \\'' + opt.stage + '\\', this)" class="sub-option-btn px-3 py-1.5 text-xs rounded-lg border border-wiki-border/50 bg-wiki-card/60 text-wiki-muted hover:border-cyan-500/50 hover:text-white transition-all" data-value="' + opt.value + '">' +
                    '<span class="font-medium">' + opt.label + '</span> <span class="text-wiki-muted/70">Â· ' + opt.description + '</span></button>'
                ).join('') +
                '</div></div>';
        }

        // ê³ ë“±í•™ìƒ í•˜ìœ„ ì„ íƒ
        function selectHighSubType(value, btnEl) {
            window.academicState = value;
            document.querySelectorAll('#student-sub-options .sub-option-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'bg-cyan-500/20', 'text-white');
                btn.classList.add('border-wiki-border/50', 'text-wiki-muted');
            });
            btnEl.classList.remove('border-wiki-border/50', 'text-wiki-muted');
            btnEl.classList.add('border-cyan-500', 'bg-cyan-500/20', 'text-white');
        }

        // ëŒ€í•™ìƒ í•˜ìœ„ ì„ íƒ
        function selectUnivSubType(value, stage, btnEl) {
            selectedStage = stage;
            window.academicState = null;
            document.querySelectorAll('#student-sub-options .sub-option-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'bg-cyan-500/20', 'text-white');
                btn.classList.add('border-wiki-border/50', 'text-wiki-muted');
            });
            btnEl.classList.remove('border-wiki-border/50', 'text-wiki-muted');
            btnEl.classList.add('border-cyan-500', 'bg-cyan-500/20', 'text-white');
        }
        
        // ì „ê³µ ì„ íƒ ëª©ì  (ë‹¤í¬ í…Œë§ˆ)
        function renderMajorPurposeOptions() {
            const container = document.getElementById('career-stage-options');
            if (!container) return;
            
            const purposes = [
                { value: 'explore', label: 'ì§„ë¡œ íƒìƒ‰', description: 'ë‹¤ì–‘í•œ ì „ê³µ ì•Œì•„ë³´ê¸°', emoji: 'ğŸ”' },
                { value: 'decide', label: 'ì „ê³µ ê²°ì •', description: 'ì…í•™/ì „ê³¼ ì¤€ë¹„', emoji: 'âœ…' },
                { value: 'change', label: 'ì „ê³µ ë³€ê²½', description: 'ë³µìˆ˜ì „ê³µ/ì „ê³¼ ê³ ë ¤', emoji: 'ğŸ”„' },
                { value: 'career', label: 'ì§„ë¡œ ì—°ê³„', description: 'ì·¨ì—…ì„ ìœ„í•œ ì „ê³µ', emoji: 'ğŸ’¼' },
            ];
            
            container.innerHTML = purposes.map((opt, idx) => \`
                <button type="button" onclick="selectMajorPurpose('\${opt.value}', this)"
                        class="purpose-btn group relative overflow-hidden rounded-xl p-4 bg-wiki-card/80 border border-wiki-border/50 hover:border-purple-500/50 hover:bg-wiki-card transition-all duration-300"
                        data-value="\${opt.value}">
                    <div class="relative z-10">
                        <div class="text-2xl mb-2">\${opt.emoji}</div>
                        <div class="font-semibold text-sm text-white">\${opt.label}</div>
                        <div class="text-xs text-wiki-muted mt-0.5">\${opt.description}</div>
                    </div>
                </button>
            \`).join('');
        }
        
        function selectMajorPurpose(value, btnEl) {
            majorPurpose = value;
            careerState.career_stage_years = value === 'explore' ? 'none' : value === 'decide' ? '0_3' : value === 'change' ? '0_3' : '3_10';
            
            document.querySelectorAll('#career-stage-options .purpose-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-500/20', 'shadow-lg', 'shadow-purple-500/20');
                btn.classList.add('border-wiki-border/50');
            });
            btnEl.classList.remove('border-wiki-border/50');
            btnEl.classList.add('border-purple-500', 'bg-purple-500/20', 'shadow-lg', 'shadow-purple-500/20');
            
            checkStep1Completion();
        }
        
        // ì „í™˜ ìƒíƒœ (ë‹¤ì¤‘ ì„ íƒ - ë‹¤í¬ í…Œë§ˆ)
        function updateTransitionStatusOptionsMajor() {
            const container = document.getElementById('transition-status-options');
            if (!container) return;

            const MAJOR_TRANSITION_OPTIONS = [
                { value: 'first_choice', label: 'ì²« ì „ê³µ ì„ íƒ', emoji: 'ğŸŒ±', description: 'ì•„ì§ ì „ê³µì„ ì •í•œ ì  ì—†ì–´ìš”' },
                { value: 'exploring', label: 'ì—¬ëŸ¬ ì „ê³µ íƒìƒ‰', emoji: 'ğŸ”', description: 'ê´€ì‹¬ ë¶„ì•¼ë¥¼ ë¹„êµí•˜ëŠ” ì¤‘' },
                { value: 'major_change', label: 'ì „ê³¼/ì „ê³µ ë³€ê²½', emoji: 'ğŸ”„', description: 'í˜„ì¬ ì „ê³µì„ ë°”ê¾¸ê³  ì‹¶ì–´ìš”' },
                { value: 'career_linked', label: 'ëª©í‘œ ì§ì—… ì—°ê³„', emoji: 'ğŸ¯', description: 'ì›í•˜ëŠ” ì§ì—…ì— ë§ëŠ” ì „ê³µ íƒìƒ‰' },
                { value: 'double_major', label: 'ë³µìˆ˜ì „ê³µ/ë¶€ì „ê³µ', emoji: 'â•', description: 'ì¶”ê°€ ì „ê³µì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”' },
                { value: 'undecided', label: 'ì•„ì§ ëª¨ë¥´ê² ì–´ìš”', emoji: 'ğŸ¤”', description: 'ë°©í–¥ì„ ì •í•˜ì§€ ëª»í–ˆì–´ìš”' },
            ];

            const rules = studentType && STUDENT_TYPE_DISABLED_RULES[studentType]
                ? STUDENT_TYPE_DISABLED_RULES[studentType]
                : { transition_status: [], reasons: {} };
            const disabledValues = rules.transition_status || [];
            const reason = rules.reasons?.transition_status || 'í˜„ì¬ ìƒíƒœì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”';

            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            careerState.transition_status = careerState.transition_status.filter(v => !disabledValues.includes(v));

            container.innerHTML = MAJOR_TRANSITION_OPTIONS.map(opt => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.transition_status.includes(opt.value);
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="toggleTransitionStatusMajor('\${opt.value}', this)"\`}
                            class="goal-chip group relative rounded-xl p-4 transition-all duration-300 \${
                                isDisabled 
                                    ? 'bg-wiki-bg/50 cursor-not-allowed opacity-40' 
                                    : isSelected 
                                        ? 'bg-emerald-500/20 border border-emerald-500 shadow-lg shadow-emerald-500/20 transform scale-[1.02]' 
                                        : 'bg-wiki-card/80 border border-wiki-border/50 hover:border-emerald-500/50 hover:bg-wiki-card'
                            }"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-wiki-muted/50" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : isSelected ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        <div class="text-2xl mb-2 \${isDisabled ? 'grayscale opacity-50' : ''}">\${opt.emoji}</div>
                        <div class="font-semibold text-sm \${isDisabled ? 'text-wiki-muted/50' : isSelected ? 'text-emerald-400' : 'text-white'}">\${opt.label}</div>
                        <div class="text-xs mt-1 \${isDisabled ? 'text-wiki-muted/30' : isSelected ? 'text-emerald-300/80' : 'text-wiki-muted'}">\${opt.description}</div>
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-wiki-border/30">
                                ğŸ”’ \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function toggleTransitionStatusMajor(value, btnEl) {
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            
            const idx = careerState.transition_status.indexOf(value);
            if (idx === -1) {
                careerState.transition_status.push(value);
            } else {
                careerState.transition_status.splice(idx, 1);
            }
            
            updateTransitionStatusOptionsMajor();
            checkStep1Completion();
        }
        
        // ìˆ™ë ¨ë„ (ë‹¤í¬ í…Œë§ˆ ë ˆë²¨ ê²Œì´ì§€)
        function updateSkillLevelOptionsMajor() {
            const container = document.getElementById('skill-level-options');
            if (!container) return;
            
            const rules = studentType && STUDENT_TYPE_DISABLED_RULES[studentType] 
                ? STUDENT_TYPE_DISABLED_RULES[studentType] 
                : { skill_level: [], reasons: {} };
            const disabledValues = rules.skill_level || [];
            const reason = rules.reasons?.skill_level || 'í˜„ì¬ ìƒíƒœì—ì„œ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”';
            
            if (disabledValues.includes(careerState.skill_level)) {
                careerState.skill_level = null;
            }
            
            container.innerHTML = SKILL_LEVEL_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.skill_level === opt.value;
                const levelBars = idx + 1;
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectSkillLevelMajor(\${opt.value}, this)"\`}
                            class="skill-btn group relative rounded-xl p-3 transition-all duration-300 \${
                                isDisabled 
                                    ? 'bg-wiki-bg/50 cursor-not-allowed opacity-40' 
                                    : isSelected 
                                        ? 'bg-violet-500/20 border border-violet-500 shadow-lg shadow-violet-500/20' 
                                        : 'bg-wiki-card/80 border border-wiki-border/50 hover:border-violet-500/50 hover:bg-wiki-card'
                            }"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-3.5 h-3.5 text-wiki-muted/50" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        <div class="flex gap-1 mb-2 justify-center">
                            \${[1,2,3,4,5].map(i => \`
                                <div class="w-3 h-6 rounded-sm transition-all duration-300 \${
                                    i <= levelBars 
                                        ? isDisabled ? 'bg-wiki-muted/30' : isSelected ? 'bg-violet-500' : 'bg-wiki-muted/50'
                                        : 'bg-wiki-border/30'
                                }"></div>
                            \`).join('')}
                        </div>
                        <div class="font-semibold text-sm \${isDisabled ? 'text-wiki-muted/50' : isSelected ? 'text-violet-400' : 'text-white'}">\${opt.label}</div>
                        <div class="text-xs \${isDisabled ? 'text-wiki-muted/30' : 'text-wiki-muted'} mt-0.5">\${opt.description}</div>
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-wiki-border/30">
                                ğŸ”’ \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function selectSkillLevelMajor(value, btnEl) {
            careerState.skill_level = value;
            updateSkillLevelOptionsMajor();
            checkStep1Completion();
        }
        
        // ì œì•½ ì¡°ê±´ (ë‹¤í¬ í…Œë§ˆ ì•„ì½”ë””ì–¸ ì¹´ë“œ)
        let noConstraintSelectedMajor = false;
        
        function renderConstraintOptionsMajor() {
            const container = document.getElementById('constraint-options');
            if (!container) return;

            const MAJOR_CONSTRAINT_OPTIONS = [
                { type: 'grades', label: 'ì„±ì /ì…ì‹œ ì œì•½', emoji: 'ğŸ“Š', description: 'ì„±ì  ë²”ìœ„ ë‚´ì—ì„œ ì„ íƒí•´ì•¼ í•´ìš”', placeholder: 'ì˜ˆ: ìˆ˜í•™ ê³¼ëª©ì´ ì•½í•¨, ë‚´ì‹  3ë“±ê¸‰ ì´ë‚´ í•„ìš” ë“±', details: [{ value: 'gpa_limit', label: 'ë‚´ì‹  ì„±ì  ì œí•œ' }, { value: 'exam_limit', label: 'ìˆ˜ëŠ¥ ì ìˆ˜ ì œí•œ' }, { value: 'weak_subject', label: 'íŠ¹ì • ê³¼ëª© ì•½í•¨' }] },
                { type: 'money', label: 'ê²½ì œì  ì œì•½', emoji: 'ğŸ’°', description: 'í•™ë¹„Â·ìƒí™œë¹„ ë¶€ë‹´ì´ ìˆì–´ìš”', placeholder: 'ì˜ˆ: ë“±ë¡ê¸ˆ 500ë§Œì› ì´í•˜, ì¥í•™ê¸ˆ ê°€ëŠ¥í•œ ê³³ë§Œ ë“±', details: [{ value: 'tuition_burden', label: 'í•™ë¹„ ë¶€ë‹´' }, { value: 'scholarship_required', label: 'ì¥í•™ê¸ˆ í•„ìˆ˜' }, { value: 'living_cost', label: 'ìì·¨ë¹„ìš© ê³ ë ¤' }] },
                { type: 'location', label: 'ì§€ì—­ ì œì•½', emoji: 'ğŸ“', description: 'í†µí•™ ê°€ëŠ¥í•œ ì§€ì—­ì´ ì •í•´ì ¸ ìˆì–´ìš”', placeholder: 'ì˜ˆ: ì„œìš¸/ê²½ê¸°ë§Œ ê°€ëŠ¥, ì§‘ì—ì„œ í†µí•™ ê°€ëŠ¥í•œ ê±°ë¦¬ ë“±', details: [{ value: 'capital_only', label: 'ìˆ˜ë„ê¶Œë§Œ ê°€ëŠ¥' }, { value: 'specific_region', label: 'íŠ¹ì • ì§€ì—­ë§Œ ê°€ëŠ¥' }, { value: 'commute_required', label: 'ìíƒ í†µí•™ í•„ìš”' }] },
                { type: 'family', label: 'ê°€ì¡± ì˜ê²¬', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', description: 'ê°€ì¡± ì˜ê²¬ì„ ê³ ë ¤í•´ì•¼ í•´ìš”', placeholder: 'ì˜ˆ: ë¶€ëª¨ë‹˜ì´ íŠ¹ì • ì „ê³µì„ ì›í•˜ì‹¬, ê°€ì—…ì´ ìˆìŒ ë“±', details: [{ value: 'parent_opinion', label: 'ë¶€ëª¨ë‹˜ ì˜ê²¬ ê³ ë ¤' }, { value: 'family_business', label: 'ê°€ì—… ìŠ¹ê³„ ê³ ë ¤' }, { value: 'family_care', label: 'ê°€ì¡± ëŒë´„ í•„ìš”' }] },
                { type: 'subject', label: 'ê³¼ëª©/ì ì„± ì œì•½', emoji: 'ğŸ“', description: 'íŠ¹ì • ê³¼ëª©ì´ë‚˜ í™œë™ì´ ë¶€ë‹´ë¼ìš”', placeholder: 'ì˜ˆ: ìˆ˜í•™ì„ ëª»í•¨, ì‹¤í—˜ ìˆ˜ì—…ì´ ë¶€ë‹´ë¨ ë“±', details: [{ value: 'math_science_hard', label: 'ìˆ˜í•™/ê³¼í•™ ê¸°í”¼' }, { value: 'language_hard', label: 'ì™¸êµ­ì–´ ì–´ë ¤ì›€' }, { value: 'practical_hard', label: 'ì‹¤ê¸°/ì‹¤í—˜ ë¶€ë‹´' }] },
                { type: 'duration', label: 'ê¸°ê°„/ê³¼ì • ì œì•½', emoji: 'â³', description: 'ìˆ˜ì—… ê¸°ê°„ì´ë‚˜ ê³¼ì •ì´ ë¶€ë‹´ë¼ìš”', placeholder: 'ì˜ˆ: 4ë…„ ì´ë‚´ ì¡¸ì—… ì›í•¨, ëŒ€í•™ì› í•„ìˆ˜ ì „ê³µ ê¸°í”¼ ë“±', details: [{ value: 'fast_graduation', label: 'ë¹ ë¥¸ ì¡¸ì—… ì›í•¨' }, { value: 'no_grad_required', label: 'ëŒ€í•™ì› í•„ìˆ˜ ê¸°í”¼' }, { value: 'internship_burden', label: 'ì‹¤ìŠµ ê¸°ê°„ ë¶€ë‹´' }] },
            ];

            container.innerHTML = \`
                <div class="mb-4">
                    <button type="button" onclick="toggleNoConstraintMajor(this)" id="no-constraint-btn"
                            class="w-full p-4 rounded-xl border border-dashed hover:border-emerald-500/50 transition-all duration-300 group"
                            style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.5);">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" style="background-color: rgba(16,185,129,0.2);">âœ…</div>
                            <div class="text-left flex-1">
                                <div class="font-semibold text-white">ì œì•½ ì—†ìŒ</div>
                                <div class="text-sm" style="color: rgb(148,163,184)">íŠ¹ë³„í•œ ì œì•½ ì¡°ê±´ ì—†ì´ ëª¨ë“  ì „ê³µ ê³ ë ¤</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center no-constraint-check opacity-0 transition-opacity" style="border-color: rgba(42,42,62,0.5);">
                                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </button>
                </div>
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                    <span class="text-xs font-medium" style="color: rgb(148,163,184)">ë˜ëŠ” ì œì•½ ì¡°ê±´ ì„ íƒ</span>
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                </div>
                <div id="constraint-list" class="grid gap-3">
                    \${MAJOR_CONSTRAINT_OPTIONS.map(opt => \`
                        <div class="constraint-card rounded-xl border overflow-hidden transition-all duration-300" 
                             style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.9);"
                             data-type="\${opt.type}">
                            <button type="button" onclick="toggleConstraintMajor('\${opt.type}', this)"
                                    class="constraint-header w-full p-4 flex items-center gap-4 text-left transition-colors"
                                    onmouseover="this.style.backgroundColor='rgba(26,26,46,1)';"
                                    onmouseout="this.style.backgroundColor='transparent';">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl flex-shrink-0" style="background-color: rgba(245,158,11,0.2);">\${opt.emoji}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-white">\${opt.label}</div>
                                    <div class="text-sm truncate" style="color: rgb(148,163,184)">\${opt.description}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="constraint-badge hidden px-2 py-1 text-amber-400 text-xs font-medium rounded-full" style="background-color: rgba(245,158,11,0.2);">ì„ íƒë¨</div>
                                    <svg class="constraint-chevron w-5 h-5 transition-transform duration-300" style="color: rgb(148,163,184)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </button>
                            <div class="constraint-detail hidden border-t" style="border-color: rgba(42,42,62,0.3); background-color: rgba(15,15,35,0.5);">
                                <div class="p-4 space-y-4">
                <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">êµ¬ì²´ì ì¸ ìƒí™© (ì„ íƒ)</label>
                                        <div class="flex flex-wrap gap-2">
                                            \${opt.details.map(d => \`
                                                <button type="button" onclick="selectConstraintDetailMajor('\${opt.type}', '\${d.value}', this)"
                                                        class="detail-tag px-3 py-1.5 text-sm rounded-full border"
                                                        data-value="\${d.value}">
                                                    \${d.label}
                                                </button>
                                            \`).join('')}
                </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">ì¶”ê°€ ì„¤ëª… (ì„ íƒ)</label>
                                        <textarea class="w-full px-4 py-3 text-sm border rounded-lg transition-all resize-none"
                                                  style="border-color: rgba(42,42,62,0.5); background-color: rgba(15,15,35,1); color: #fff;"
                                                  rows="2" placeholder="\${opt.placeholder}"
                                                  onfocus="this.style.borderColor='rgba(245,158,11,0.5)';"
                                                  onblur="this.style.borderColor='rgba(42,42,62,0.5)';"
                                                  onchange="updateConstraintCustomDetailMajor('\${opt.type}', this.value)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }
        
        function toggleNoConstraintMajor(btnEl) {
            noConstraintSelectedMajor = !noConstraintSelectedMajor;
            const checkEl = btnEl.querySelector('.no-constraint-check');
            const constraintList = document.getElementById('constraint-list');
            
            if (noConstraintSelectedMajor) {
                btnEl.classList.add('border-solid', 'shadow-lg');
                btnEl.classList.remove('border-dashed');
                btnEl.style.borderColor = '#10b981';
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                checkEl.classList.remove('opacity-0');
                checkEl.classList.add('opacity-100');
                checkEl.style.backgroundColor = '#10b981';
                checkEl.style.borderColor = '#10b981';
                careerState.constraints = {};
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.add('opacity-30', 'pointer-events-none');
                    card.querySelector('.constraint-badge')?.classList.add('hidden');
                    card.querySelector('.constraint-detail')?.classList.add('hidden');
                    card.querySelector('.constraint-chevron')?.classList.remove('rotate-180');
                });
                constraintList.classList.add('opacity-50');
            } else {
                btnEl.classList.remove('border-solid', 'shadow-lg');
                btnEl.classList.add('border-dashed');
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                checkEl.classList.remove('opacity-100');
                checkEl.style.backgroundColor = 'transparent';
                checkEl.style.borderColor = 'rgba(42,42,62,0.5)';
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                constraintList.classList.remove('opacity-50');
            }
        }
        
        function toggleConstraintMajor(type, btnEl) {
            if (noConstraintSelectedMajor) {
                noConstraintSelectedMajor = false;
                const noBtn = document.getElementById('no-constraint-btn');
                const checkEl = noBtn.querySelector('.no-constraint-check');
                noBtn.classList.remove('border-solid', 'shadow-lg');
                noBtn.classList.add('border-dashed');
                noBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noBtn.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                document.getElementById('constraint-list').classList.remove('opacity-50');
            }
            
            const card = btnEl.closest('.constraint-card');
            const badge = card.querySelector('.constraint-badge');
            const detail = card.querySelector('.constraint-detail');
            const chevron = card.querySelector('.constraint-chevron');
            const isSelected = careerState.constraints[type]?.has_constraint;
            
            if (isSelected) {
                delete careerState.constraints[type];
                card.classList.remove('shadow-lg');
                card.style.borderColor = 'rgba(42,42,62,0.5)';
                badge.classList.add('hidden');
                detail.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                detail.querySelectorAll('.detail-tag').forEach(tag => {
                    tag.classList.remove('selected');
                    tag.style.backgroundColor = 'rgba(26,26,46,0.5)';
                    tag.style.borderColor = 'rgba(42,42,62,0.5)';
                    tag.style.color = 'rgb(148,163,184)';
                });
            } else {
                careerState.constraints[type] = { has_constraint: true };
                card.classList.add('shadow-lg');
                card.style.borderColor = '#f59e0b';
                badge.classList.remove('hidden');
                detail.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            }
        }
        
        function selectConstraintDetailMajor(type, value, btnEl) {
            if (!careerState.constraints[type]) return;

            const isCurrentlySelected = btnEl.classList.contains('selected');

            // details ë°°ì—´ ì´ˆê¸°í™”
            if (!careerState.constraints[type].details) {
                careerState.constraints[type].details = [];
            }
            if (!Array.isArray(careerState.constraints[type].details)) {
                careerState.constraints[type].details = careerState.constraints[type].details
                    ? [careerState.constraints[type].details] : [];
            }

            // í† ê¸€: ì„ íƒ/í•´ì œ
            if (isCurrentlySelected) {
                btnEl.classList.remove('selected');
                careerState.constraints[type].details = careerState.constraints[type].details.filter(v => v !== value);
            } else {
                btnEl.classList.add('selected');
                if (!careerState.constraints[type].details.includes(value)) {
                    careerState.constraints[type].details.push(value);
                }
            }
            
            // ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ì ìš©
            applyDetailTagStyle(btnEl, !isCurrentlySelected);
        }
        
        function updateConstraintCustomDetailMajor(type, value) {
            if (!careerState.constraints[type]) return;
            careerState.constraints[type].custom_detail = value;
        }
        
        function selectAxis(axis, value, btnEl) {
            careerState[axis] = value;
            const container = btnEl.parentElement;
            container.querySelectorAll('.axis-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            });
            btnEl.classList.add('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            checkStep1Completion();
        }
        
        function toggleConstraint(type, btnEl) {
            const isSelected = careerState.constraints[type]?.has_constraint;
            if (isSelected) {
                delete careerState.constraints[type];
                btnEl.classList.remove('ring-2', 'ring-amber-400', 'bg-amber-400/10', 'border-amber-400');
            } else {
                careerState.constraints[type] = { has_constraint: true };
                btnEl.classList.add('ring-2', 'ring-amber-400', 'bg-amber-400/10', 'border-amber-400');
            }
        }
        
        function checkStep1Completion() {
            const hasStudentType = studentType !== null;
            const hasMajorPurpose = majorPurpose !== null;
            const hasTransition = Array.isArray(careerState.transition_status) && careerState.transition_status.length > 0;
            const hasSkillLevel = careerState.skill_level !== null;
            const isComplete = hasStudentType && hasMajorPurpose && hasTransition && hasSkillLevel;
            const nextBtn = document.getElementById('step1-next-btn');
            nextBtn.disabled = !isComplete;
            if (isComplete) nextBtn.classList.add('hover-glow');
            else nextBtn.classList.remove('hover-glow');
        }
        
        function goToStep(step, skipRender = false) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('step' + step);
            if (target) target.classList.remove('hidden');
            currentStep = step;

            // ë³¸ì¸ ê³„ì • ê²½ê³  ë°°ë„ˆ: Step 1ì—ì„œë§Œ í‘œì‹œ
            const warningBanner = document.getElementById('account-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = step === 1 ? 'block' : 'none';
            }

            document.querySelectorAll('.step-dot').forEach(dot => {
                const dotStep = parseInt(dot.dataset.step);
                const circle = dot.querySelector('span');
                if (dotStep === step) {
                    dot.classList.add('active');
                    circle.classList.remove('bg-wiki-card', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else if (dotStep < step) {
                    circle.classList.remove('bg-wiki-card', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-secondary', 'text-white');
                } else {
                    dot.classList.remove('active');
                    circle.classList.remove('bg-wiki-primary', 'bg-wiki-secondary', 'text-white');
                    circle.classList.add('bg-wiki-card', 'text-wiki-muted');
                }
            });
        }
        
        async function goToStep2WithLoading() {
            // í¸ì§‘ ëª¨ë“œ: ë³€ê²½ ê°ì§€ â†’ ì´í›„ ë‹¨ê³„ ì´ˆê¸°í™”
            if (window.__editMode && detectStep1Changes()) {
                cascadeResetFromStep1();
            }

            // ê´€ì‹¬ì‚¬ + ì „ì´ì‹ í˜¸ ë‹µë³€ ìˆ˜ì§‘
            collectUniversalAnswers();

            // ì„¸ì…˜ ID ìƒì„±
            currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();

            // V3 ëª¨ë“œ: ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ â†’ 3ë¼ìš´ë“œ ì¸í„°ë·°
            goToStep(2);
            renderNarrativeStepMajor();
        }

        // ì „ì´ ì‹ í˜¸ ë Œë”ë§ (ì „ê³µ ì „ìš©)
        function renderTransitionSignalForm() {
            const container = document.getElementById('transition-signal-form');
            if (!container) {
                return;
            }
            const MAJOR_SIGNAL_QUESTIONS = [
                { question_id: 'trans_desired_type', text: 'ì „ê³µ ì„ íƒ í›„ ì–´ë–¤ ì¤€ë¹„ë¥¼ í•˜ê³  ì‹¶ë‚˜ìš”?', help: 'ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ (ì„ íƒ ìˆœì„œ = ìš°ì„ ìˆœìœ„)', ui_type: 'chips', max_selections: 3, options: [
                    { value: 'campus_life', label: 'ëŒ€í•™ìƒí™œ ê³„íš', emoji: 'ğŸ«' },
                    { value: 'certification', label: 'ìê²©ì¦/ìŠ¤í™ ì¤€ë¹„', emoji: 'ğŸ“œ' },
                    { value: 'internship', label: 'ì¸í„´/í˜„ì¥ê²½í—˜', emoji: 'ğŸ¢' },
                    { value: 'study_abroad', label: 'ìœ í•™/êµí™˜í•™ìƒ', emoji: 'ğŸŒ' },
                    { value: 'grad_school', label: 'ëŒ€í•™ì› ì§„í•™', emoji: 'ğŸ“' },
                    { value: 'employment', label: 'ì·¨ì—… ì¤€ë¹„', emoji: 'ğŸ’¼' },
                    { value: 'double_major', label: 'ë³µìˆ˜ì „ê³µ/ë¶€ì „ê³µ', emoji: 'ğŸ“š' },
                    { value: 'club_activity', label: 'ë™ì•„ë¦¬/ëŒ€ì™¸í™œë™', emoji: 'ğŸ¤' },
                    { value: 'research', label: 'í•™ë¶€ ì—°êµ¬', emoji: 'ğŸ”¬' },
                    { value: 'startup', label: 'ì°½ì—…/í”„ë¡œì íŠ¸', emoji: 'ğŸš€' },
                ], fact_key: 'transition.desired_type' },
                { question_id: 'trans_motivation', text: 'ì „ê³µì„ ê³ ë¯¼í•˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ” ë­”ê°€ìš”?', help: 'ê°€ì¥ ì¤‘ìš”í•œ ì´ìœ  í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', ui_type: 'radio', options: [
                    { value: 'find_aptitude', label: 'ë‚´ ì ì„±ì„ ì°¾ê³  ì‹¶ì–´ì„œ', emoji: 'ğŸ”' },
                    { value: 'employment', label: 'ì·¨ì—…ì´ ì˜ ë˜ëŠ” ì „ê³µì„ ì°¾ê³  ì‹¶ì–´ì„œ', emoji: 'ğŸ’¼' },
                    { value: 'interest', label: 'ì¢‹ì•„í•˜ëŠ” ë¶„ì•¼ë¥¼ ê³µë¶€í•˜ê³  ì‹¶ì–´ì„œ', emoji: 'â¤ï¸' },
                    { value: 'parents', label: 'ë¶€ëª¨ë‹˜/ì£¼ë³€ ì¶”ì²œì´ ìˆì–´ì„œ', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' },
                    { value: 'grades', label: 'ì„±ì ì— ë§ëŠ” ì „ê³µì„ ì°¾ê³  ì‹¶ì–´ì„œ', emoji: 'ğŸ“Š' },
                    { value: 'change', label: 'í˜„ì¬ ì „ê³µ/ì§„ë¡œê°€ ì•ˆ ë§ì•„ì„œ', emoji: 'ğŸ”„' },
                ], fact_key: 'transition.motivation_primary' },
                { question_id: 'trans_blockers', text: 'ì „ê³µ ì„ íƒì—ì„œ ê°€ì¥ ê±±ì •ë˜ëŠ” ê±´ ë­”ê°€ìš”?', help: 'í•´ë‹¹í•˜ëŠ” ê±±ì •ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', ui_type: 'checkbox', options: [
                    { value: 'aptitude', label: 'ì ì„±ì— ì•ˆ ë§ì„ê¹Œ ë´', emoji: 'ğŸ˜°' },
                    { value: 'employment', label: 'ì·¨ì—…ì´ ì•ˆ ë ê¹Œ ë´', emoji: 'ğŸ’¼' },
                    { value: 'grades', label: 'ì„±ì ì´ ë¶€ì¡±í• ê¹Œ ë´', emoji: 'ğŸ“‰' },
                    { value: 'info_lack', label: 'ì „ê³µ ì •ë³´ê°€ ë¶€ì¡±í•´ì„œ', emoji: 'â“' },
                    { value: 'difficulty', label: 'ì „ê³µ ê³µë¶€ê°€ ì–´ë ¤ìš¸ê¹Œ ë´', emoji: 'ğŸ“š' },
                    { value: 'regret', label: 'ë‚˜ì¤‘ì— í›„íšŒí• ê¹Œ ë´', emoji: 'ğŸ˜¥' },
                    { value: 'family', label: 'ê°€ì¡± ì˜ê²¬ê³¼ ë‹¬ë¼ì„œ', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' },
                ], fact_key: 'transition.blocker' },
                { question_id: 'trans_timeline', text: 'ì „ê³µ/ì§„í•™ ê²°ì •ì€ ì–¸ì œê¹Œì§€ í•´ì•¼ í•˜ë‚˜ìš”?', help: 'ì‹œê°„ ì—¬ìœ ì— ë”°ë¼ ì¶”ì²œì´ ë‹¬ë¼ì ¸ìš”.', ui_type: 'radio', options: [
                    { value: '1m', label: '1ê°œì›” ë‚´', emoji: 'ğŸ”¥' },
                    { value: '3m', label: '3ê°œì›” ë‚´', emoji: 'âš¡' },
                    { value: '6m', label: '6ê°œì›” ë‚´', emoji: 'ğŸ“†' },
                    { value: '1y', label: '1ë…„ ë‚´', emoji: 'ğŸ“…' },
                    { value: '2y', label: '2ë…„ ì´ìƒ', emoji: 'ğŸ—“ï¸' },
                    { value: 'no_rush', label: 'ì²œì²œíˆ í•´ë„ ë¼ìš”', emoji: 'ğŸ¢' },
                ], fact_key: 'transition.timeline' },
                { question_id: 'trans_time_invest', text: 'ì¼ì£¼ì¼ì— ì „ê³µ íƒìƒ‰ì— íˆ¬ìí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì€?', help: 'í˜„ì‹¤ì ìœ¼ë¡œ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', ui_type: 'radio', options: [
                    { value: '0', label: 'ê±°ì˜ ì—†ì–´ìš”', emoji: 'ğŸ˜“' },
                    { value: '5', label: '5ì‹œê°„ ì´í•˜', emoji: 'â±ï¸' },
                    { value: '10', label: '5~10ì‹œê°„', emoji: 'ğŸ“–' },
                    { value: '20', label: '10~20ì‹œê°„', emoji: 'ğŸ’ª' },
                    { value: '40', label: '20ì‹œê°„ ì´ìƒ', emoji: 'ğŸƒ' },
                ], fact_key: 'transition.time_invest_hours_bucket' },
            ];
            container.innerHTML = MAJOR_SIGNAL_QUESTIONS.map(q => {
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-2 text-white">\${q.text}</h4>
                            <p class="text-xs mb-3" style="color: rgb(100,116,139)">ìµœëŒ€ \${q.max_selections || 3}ê°œê¹Œì§€ ì„ íƒ (ì„ íƒ ìˆœì„œ = ìš°ì„ ìˆœìœ„)</p>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map((opt, idx) => \`
                                    <button type="button" onclick="selectTransitionChip('\${q.question_id}', '\${opt.value}', this, \${q.max_selections || 3})"
                                            class="trans-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-rank"></div>
                                    </button>
                                \`).join('')}
                            </div>
                            <div class="selected-order mt-3 text-sm hidden p-3 rounded-lg" style="background-color: rgba(16,185,129,0.1); color: #34d399;"></div>
                        </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectTransitionRadio('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-radio group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(148,163,184)"><span class="mr-1">\${opt.emoji}</span>\${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                } else if (q.ui_type === 'checkbox') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleTransitionCheckbox('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-checkbox group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
        }
        
        function selectTransitionChip(questionId, value, btnEl, maxSelections) {
            if (!transitionSignalAnswers[questionId]) transitionSignalAnswers[questionId] = [];
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-rank')?.classList.add('hidden');
                btnEl.querySelector('.chip-rank')?.classList.remove('flex');
            } else if (arr.length < maxSelections) {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
            }
            updateChipOrder(questionId);
        }
        
        function updateChipOrder(questionId) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            if (!container) {
                return;
            }
            const orderEl = container.querySelector('.selected-order');
            if (!orderEl) {
                return;
            }
            const arr = transitionSignalAnswers[questionId] || [];
            
            // ëª¨ë“  ìˆœìœ„ ë°°ì§€ ì´ˆê¸°í™”
            container.querySelectorAll('.trans-chip').forEach(btn => {
                const rank = btn.querySelector('.chip-rank');
                if (rank) {
                    rank.classList.add('hidden');
                    rank.classList.remove('flex');
                }
            });
            
            if (arr.length > 0) {
                const q = TRANSITION_SIGNAL_QUESTIONS.find(q => q.question_id === questionId);
                const labels = arr.map((v, i) => {
                    const opt = q?.options.find(o => o.value === v);
                    const btn = container.querySelector(\`[data-value="\${v}"]\`);
                    if (btn) {
                        const rank = btn.querySelector('.chip-rank');
                        if (rank) {
                            rank.textContent = i + 1;
                            rank.classList.remove('hidden');
                            rank.classList.add('flex');
                        }
                    }
                    return \`\${i + 1}ìˆœìœ„: \${opt?.label || v}\`;
                });
                orderEl.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>' + labels.join(' â†’ ');
                orderEl.classList.remove('hidden');
            } else {
                orderEl.classList.add('hidden');
            }
        }
        
        function selectTransitionRadio(questionId, value, btnEl) {
            const isSelected = transitionSignalAnswers[questionId] === value;
            const container = btnEl.parentElement;
            
            container.querySelectorAll('.trans-radio').forEach(btn => {
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                transitionSignalAnswers[questionId] = value;
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete transitionSignalAnswers[questionId];
            }
        }
        
        function toggleTransitionCheckbox(questionId, value, btnEl) {
            if (!transitionSignalAnswers[questionId]) transitionSignalAnswers[questionId] = [];
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
            } else {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
                btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                btnEl.querySelector('.chip-check')?.classList.add('flex');
            }
        }
        
        async function submitUniversalAndGoToTransition() {
            collectUniversalAnswers();

            // í¸ì§‘ ëª¨ë“œ: Step 2 ë³€ê²½ ê°ì§€ â†’ ì´í›„ ë‹¨ê³„ ì´ˆê¸°í™”
            if (window.__editMode && detectStep2Changes()) {
                cascadeResetFromStep2();
            }

            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();

            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ì „ì´ ì‹ í˜¸ ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');
            setTimeout(() => {
                try {
                    renderTransitionSignalForm();
                    goToStep(3);
                } catch (error) {
                } finally {
                    hideLoading();
                }
            }, 600);
        }
        
        async function submitTransitionAndContinue() {
            // í¸ì§‘ ëª¨ë“œ: Step 3 ë³€ê²½ ê°ì§€ â†’ followup ì´ˆê¸°í™”
            if (window.__editMode && detectStep3Changes()) {
                cascadeResetFromStep3();
            }

            // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
            saveDraftToServer();

            showLoading('ë¶„ì„ ì¤‘...', 'ë§ì¶¤ ì‹¬ì¸µ ì§ˆë¬¸ì„ êµ¬ì„±í•˜ê³  ìˆì–´ìš”');
            
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage || 'major_high',
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        academic_state: window.academicState || undefined,
                        debug: DEBUG_MODE,
                        ...getEditModePayloadExtras(),
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(2);
                } else {
                    // í¸ì§‘ ëª¨ë“œ: ë¶„ì„ ì™„ë£Œ â†’ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                    if (window.__editMode && data.request_id) {
                        fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                            method: 'DELETE', credentials: 'same-origin'
                        }).catch(() => {});
                        window.location.href = '/user/ai-results/' + data.request_id;
                        return;
                    }
                    currentRequestId = data.request_id;
                    displayResults(data);
                    saveDraftAsCompletedMajor();  // ê²°ê³¼ ì €ì¥
                    goToStep(3);
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // Universal Questions ë Œë”ë§ (Majorìš© - ê³ ê¸‰ UI)
        function renderUniversalQuestions() {
            const container = document.getElementById('universal-questions');
            container.innerHTML = UNIVERSAL_QUESTIONS.map(q => {
                const requiredMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : '';
                
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                            <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                            <div class="flex flex-wrap gap-2" data-question-id="\${q.id}" data-max-selections="\${q.max_selections || 99}">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleChipOptionMajor('\${q.id}', '\${opt.value}', this, false)"
                                            class="chip-option group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" onclick="toggleChipOptionMajor('\${q.id}', '_unknown', this, true)"
                                            class="chip-option chip-unknown group relative px-4 py-2.5 rounded-xl border border-dashed transition-all duration-200"
                                            style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5); color: rgb(120,120,140);"
                                            data-value="_unknown">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">â“</span>
                                            <span>\${q.unknown_label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-slate-500 text-white items-center justify-center text-xs font-bold hidden chip-check">âœ“</div>
                                    </button>
                                \` : ''}
                            </div>
                            \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">ìµœëŒ€ \${q.max_selections}ê°œ ì„ íƒ ê°€ëŠ¥</p>\` : ''}
                    </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                            <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3" data-question-id="\${q.id}">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectRadioOptionMajor('\${q.id}', '\${opt.value}', this, false)"
                                            class="radio-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                </div>
                                            <span style="color: rgb(148,163,184)">\${opt.emoji || ''} \${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" onclick="selectRadioOptionMajor('\${q.id}', '_unknown', this, true)"
                                            class="radio-option radio-unknown group relative p-4 rounded-xl border border-dashed text-left transition-all duration-200"
                                            style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5);"
                                            data-value="_unknown">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-slate-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(120,120,140)">â“ \${q.unknown_label}</span>
                                        </div>
                                    </button>
                                \` : ''}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
        }
        
        // ì¹© ì˜µì…˜ í† ê¸€ (Majorìš©)
        function toggleChipOptionMajor(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const maxSelections = parseInt(container.dataset.maxSelections) || 99;
            const isSelected = btnEl.classList.contains('selected');
            
            if (isUnknown) {
                container.querySelectorAll('.chip-option').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.style.backgroundColor = btn.classList.contains('chip-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                    btn.style.borderColor = btn.classList.contains('chip-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                    btn.style.color = btn.classList.contains('chip-unknown') ? 'rgb(120,120,140)' : 'rgb(148,163,184)';
                    btn.querySelector('.chip-check')?.classList.add('hidden');
                    btn.querySelector('.chip-check')?.classList.remove('flex');
                });
                
                if (!isSelected) {
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.style.color = '#94a3b8';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                    universalAnswers[questionId] = ['_unknown'];
                } else {
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                    delete universalAnswers[questionId];
                }
            } else {
                const unknownBtn = container.querySelector('.chip-unknown');
                if (unknownBtn && unknownBtn.classList.contains('selected')) {
                    unknownBtn.classList.remove('selected');
                    unknownBtn.style.backgroundColor = 'rgba(15,15,35,0.5)';
                    unknownBtn.style.borderColor = 'rgba(100,100,120,0.5)';
                    unknownBtn.style.borderStyle = 'dashed';
                    unknownBtn.style.color = 'rgb(120,120,140)';
                    unknownBtn.querySelector('.chip-check')?.classList.add('hidden');
                    unknownBtn.querySelector('.chip-check')?.classList.remove('flex');
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
                
                if (!universalAnswers[questionId]) universalAnswers[questionId] = [];
                
                if (isSelected) {
                    btnEl.classList.remove('selected');
                    btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                    btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                    btnEl.style.color = 'rgb(148,163,184)';
                    btnEl.querySelector('.chip-check')?.classList.add('hidden');
                    btnEl.querySelector('.chip-check')?.classList.remove('flex');
                    const idx = universalAnswers[questionId].indexOf(value);
                    if (idx > -1) universalAnswers[questionId].splice(idx, 1);
                } else {
                    if (universalAnswers[questionId].length >= maxSelections) {
                        const firstSelected = container.querySelector('.chip-option.selected:not(.chip-unknown)');
                        if (firstSelected) {
                            firstSelected.classList.remove('selected');
                            firstSelected.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            firstSelected.style.borderColor = 'rgba(42,42,62,0.5)';
                            firstSelected.style.color = 'rgb(148,163,184)';
                            firstSelected.querySelector('.chip-check')?.classList.add('hidden');
                            firstSelected.querySelector('.chip-check')?.classList.remove('flex');
                            const removeVal = firstSelected.dataset.value;
                            const removeIdx = universalAnswers[questionId].indexOf(removeVal);
                            if (removeIdx > -1) universalAnswers[questionId].splice(removeIdx, 1);
                        }
                    }
                    
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.style.color = '#34d399';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    universalAnswers[questionId].push(value);
                }
            }
        }
        
        // ë¼ë””ì˜¤ ì˜µì…˜ ì„ íƒ (Majorìš©)
        function selectRadioOptionMajor(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const isSelected = btnEl.classList.contains('selected');
            
            container.querySelectorAll('.radio-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = btn.classList.contains('radio-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                btn.style.borderColor = btn.classList.contains('radio-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
                btn.classList.remove('disabled-by-unknown');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
            
            if (!isSelected) {
                btnEl.classList.add('selected');
                
                if (isUnknown) {
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#64748b';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    
                    container.querySelectorAll('.radio-option:not(.radio-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                    universalAnswers[questionId] = '_unknown';
                } else {
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    universalAnswers[questionId] = value;
                }
            } else {
                delete universalAnswers[questionId];
            }
        }
        
        function collectUniversalAnswers() {
            // ì´ë¯¸ universalAnswersì— ìˆ˜ì§‘ë¨
        }
        
        function renderFollowupQuestions(questions) {
            const container = document.getElementById('followup-questions-form');
            container.innerHTML = questions.map((q, i) => \`
                <div class="followup-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="followup_\${q.id || i}">
                    <div class="flex items-start gap-4 mb-4">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white;">\${i + 1}</span>
                        <h4 class="font-semibold text-white text-lg leading-relaxed">\${q.question}</h4>
                    </div>
                    \${q.options ? \`
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 ml-12">
                            \${q.options.map(opt => \`
                                <button type="button" onclick="selectFollowup('\${q.id || i}', '\${opt.value || opt}', this)"
                                        class="followup-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                        data-value="\${opt.value || opt}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                             style="border-color: rgba(100,100,120,0.5);">
                                            <div class="w-2.5 h-2.5 rounded-full hidden radio-dot" style="background: linear-gradient(135deg, #a855f7, #6366f1);"></div>
                                        </div>
                                        <span style="color: rgb(148,163,184)">\${opt.label || opt}</span>
                                    </div>
                    </button>
                            \`).join('')}
                </div>
                    \` : \`
                        <div class="ml-12">
                            <textarea onchange="followupAnswers['\${q.id || i}'] = this.value" rows="3"
                                      class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                      style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                                      onfocus="this.style.borderColor='rgba(168,85,247,0.5)';"
                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)';"></textarea>
        </div>
                    \`}
    </div>
            \`).join('');
        }
        
        function selectFollowup(qid, value, btnEl) {
            const container = btnEl.closest('[data-question-id]');
            const isSelected = btnEl.classList.contains('selected');
            
            container.querySelectorAll('.followup-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                followupAnswers[qid] = value;
                btnEl.classList.add('selected');
                btnEl.style.backgroundColor = 'rgba(168,85,247,0.2)';
                btnEl.style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-circle').style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete followupAnswers[qid];
            }
        }
        
        // ============================================
        // V3: ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ + 3ë¼ìš´ë“œ ì¸í„°ë·° ì‹œìŠ¤í…œ (ì „ê³µ ì¶”ì²œ)
        // ============================================

        // V3: ì „ê³µ ì „ìš© ì„œìˆ í˜• ì§ˆë¬¸ ì„ íƒ
        function getNarrativeQuestionsMajor() {
            // ì „ê³¼/ì „ê³µ ë³€ê²½ì´ë©´ changer ì§ˆë¬¸, ë‚˜ë¨¸ì§€ëŠ” explore ì§ˆë¬¸
            const transStatus = careerState.transition_status;
            if (transStatus === 'major_change') {
                return {
                    question1: {
                        id: 'change_reason',
                        text: 'ì „ê³µì´ë‚˜ ì§„ë¡œë¥¼ ë°”ê¾¸ê³  ì‹¶ì€ ì´ìœ ê°€ ë­”ê°€ìš”?',
                        placeholder: 'ì˜ˆ: ì²˜ìŒì—” ë¶€ëª¨ë‹˜ ê¶Œìœ ë¡œ ì„ íƒí–ˆëŠ”ë°, ê³µë¶€í• ìˆ˜ë¡ ì €ë‘ ì•ˆ ë§ëŠ”ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆì–´ìš”...',
                        emoji: 'ğŸ”„',
                        color: 'from-blue-500 to-cyan-500',
                        fact_key: 'narrative.change_reason',
                    },
                    question2: {
                        id: 'new_interest',
                        text: 'ìƒˆë¡œ ë„ì „í•˜ê³  ì‹¶ì€ ë¶„ì•¼ê°€ ìˆë‚˜ìš”? ì™œ ëŒë¦¬ë‚˜ìš”?',
                        placeholder: 'ì˜ˆ: ë””ìì¸ ìª½ì´ìš”. ë­”ê°€ ë§Œë“¤ì–´ë‚´ëŠ” ì¼ì„ í•  ë•Œ ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥´ê±°ë“ ìš”...',
                        emoji: 'ğŸ¯',
                        color: 'from-violet-500 to-purple-500',
                        fact_key: 'narrative.new_interest',
                    },
                };
            }
            return {
                question1: {
                    id: 'dream_future',
                    text: 'ì–´ë–¤ ì¼ì„ í•˜ëŠ” ì‚¬ëŒì´ ë˜ê³  ì‹¶ë‚˜ìš”? ì™œ ê·¸ëŸ°ê°€ìš”?',
                    placeholder: 'ì˜ˆ: ì‚¬ëŒë“¤ì—ê²Œ ì˜ê°ì„ ì£¼ëŠ” ì¼ì„ í•˜ê³  ì‹¶ì–´ìš”. ì–´ë¦´ ë•Œ ì¢‹ì€ ì„ ìƒë‹˜ì„ ë§Œë‚˜ì„œ ì œ ì¸ìƒì´ ë°”ë€Œì—ˆê±°ë“ ìš”...',
                    emoji: 'ğŸŒŸ',
                    color: 'from-yellow-500 to-orange-500',
                    fact_key: 'narrative.dream_future',
                },
                question2: {
                    id: 'fun_experience',
                    text: 'í•™êµë‚˜ ì¼ìƒì—ì„œ ê°€ì¥ ì¬ë¯¸ìˆì—ˆë˜ í™œë™ì€ ë­ì˜€ë‚˜ìš”? ì™œ ì¬ë¯¸ìˆì—ˆë‚˜ìš”?',
                    placeholder: 'ì˜ˆ: íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ë°œí‘œë¥¼ ë§¡ì•˜ì„ ë•Œìš”. ì œ ì•„ì´ë””ì–´ê°€ íŒ€ì›ë“¤ì—ê²Œ ì¸ì •ë°›ëŠ” ëŠë‚Œì´ ì¢‹ì•˜ì–´ìš”...',
                    emoji: 'âœ¨',
                    color: 'from-pink-500 to-rose-500',
                    fact_key: 'narrative.fun_experience',
                },
            };
        }

        // V3: ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ ë Œë”ë§ (ì „ê³µ ì „ìš©)
        function renderNarrativeStepMajor() {
            const container = document.getElementById('followup-questions-form');
            if (!container) return;

            const questions = window.savedNarrativeQuestions || getNarrativeQuestionsMajor();
            const q1 = questions.question1;
            const q2 = questions.question2;
            window.savedNarrativeQuestions = questions;

            const savedQ0 = window.narrativeFacts?.storyAnswer || window.narrativeFacts?.life_story || '';
            const savedQ1 = window.narrativeFacts?.question1Answer || window.narrativeFacts?.highAliveMoment || '';
            const savedQ2 = window.narrativeFacts?.question2Answer || window.narrativeFacts?.lostMoment || '';
            const savedQ3 = window.narrativeFacts?.existentialAnswer || '';

            const isMinor = ['major_child', 'major_elementary', 'major_middle'].includes(selectedStage);

            // ìƒ‰ìƒ íŒŒì‹±
            const parseGradient = (color) => {
                const colors = color.replace('from-', '').replace(' to-', ',').split(',');
                const colorMap = {
                    'yellow-500': '234,179,8', 'orange-500': '249,115,22', 'red-500': '239,68,68',
                    'pink-500': '236,72,153', 'rose-500': '244,63,94', 'rose-600': '225,29,72',
                    'violet-500': '139,92,246', 'purple-500': '168,85,247', 'purple-600': '147,51,234',
                    'indigo-500': '99,102,241', 'indigo-600': '79,70,229', 'blue-500': '59,130,246',
                    'blue-600': '37,99,235', 'cyan-500': '6,182,212', 'cyan-600': '8,145,178',
                    'teal-500': '20,184,166', 'emerald-500': '16,185,129', 'green-500': '34,197,94',
                    'amber-500': '245,158,11', 'slate-500': '100,116,139',
                };
                return colors.map(c => colorMap[c.trim()] || '139,92,246');
            };

            const q1Colors = parseGradient(q1.color);
            const q2Colors = parseGradient(q2.color);

            // ë¯¸ì„±ë…„(ì¤‘í•™ìƒ ì´í•˜)ì€ ê°„ë‹¨í•œ ì§ˆë¬¸ë§Œ
            const minLenQ = isMinor ? 20 : 50;
            const minLenStory = isMinor ? 20 : 30;

            container.innerHTML = \`
                <!-- ê²©ë ¤ ë¬¸êµ¬ -->
                <div class="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 rounded-xl p-4 mb-6">
                    <p class="text-emerald-300 text-sm">
                        <i class="fas fa-lightbulb mr-2"></i>
                        ìì„¸íˆ (êµ¬ì²´ì ì¸ ìƒí™©, ê°ì •, ì´ìœ ë¥¼ ì†”ì§í•˜ê²Œ) ì‘ì„±í• ìˆ˜ë¡ AIê°€ ë” ì •í™•í•œ ì „ê³µ ì¶”ì²œì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.
                    </p>
                </div>

                <!-- ìŠ¤í† ë¦¬ ì§ˆë¬¸ -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(100,116,139,0.1), rgba(59,130,246,0.05)); border: 1px solid rgba(100,116,139,0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">ğŸ“–</span>
                        ê°„ëµí•˜ê²Œ ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">í•™êµìƒí™œ, ê´€ì‹¬ ë¶„ì•¼, ê³ ë¯¼ ë“± ë°°ê²½ì„ ê°„ëµíˆ ì ì–´ì£¼ì„¸ìš”. AIê°€ ë§¥ë½ì„ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë¼ìš”.</p>
                    <textarea
                        id="narrative_q0"
                        name="narrative_q0"
                        data-fact-key="narrative.life_story"
                        rows="4"
                        minlength="\${minLenStory}"
                        maxlength="5000"
                        placeholder="ì˜ˆ: ê³ ë“±í•™êµ 2í•™ë…„ì¸ë° ì´ê³¼ ìª½ì´ ì¢‹ê¸´ í•œë° ì •í™•íˆ ë­˜ í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ì–´ìš”. ìˆ˜í•™ì´ë‘ ê³¼í•™ì€ ê´œì°®ì€ë° ìƒë¬¼ì€ ë³„ë¡œ..."
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[100px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(100,116,139,0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(100,116,139,0.6)';"
                        onblur="this.style.borderColor='rgba(100,116,139,0.3)';"
                        oninput="updateNarrativeCounterMajor(this, 5000);">\${savedQ0}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q0_hint" class="text-xs text-wiki-muted">ìµœì†Œ \${minLenStory}ì / í˜„ì¬ \${savedQ0.length}ì</span>
                        <span id="narrative_q0_counter" class="text-xs text-wiki-muted">\${savedQ0.length}ì</span>
                    </div>
                </div>

                <!-- ë™ì  ì§ˆë¬¸ 1 -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q1Colors[0]},0.1), rgba(\${q1Colors[1]},0.05)); border: 1px solid rgba(\${q1Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q1.emoji}</span>
                        \${q1.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">êµ¬ì²´ì ì¸ ìƒí™©, ê°ì •, ì´ìœ ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”</p>
                    <textarea
                        id="narrative_q1"
                        name="narrative_q1"
                        data-fact-key="\${q1.fact_key}"
                        data-question-id="\${q1.id}"
                        rows="5"
                        minlength="\${minLenQ}"
                        maxlength="10000"
                        placeholder="\${q1.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q1Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q1Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q1Colors[0]},0.3)';"
                        oninput="updateNarrativeCounterMajor(this, 10000);">\${savedQ1}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q1_hint" class="text-xs text-wiki-muted">ìµœì†Œ \${minLenQ}ì / í˜„ì¬ \${savedQ1.length}ì</span>
                        <span id="narrative_q1_counter" class="text-xs text-wiki-muted">\${savedQ1.length}ì</span>
                    </div>
                </div>

                <!-- ë™ì  ì§ˆë¬¸ 2 -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q2Colors[0]},0.1), rgba(\${q2Colors[1]},0.05)); border: 1px solid rgba(\${q2Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q2.emoji}</span>
                        \${q2.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">êµ¬ì²´ì ì¸ ìƒí™©, ê°ì •, ì´ìœ ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”</p>
                    <textarea
                        id="narrative_q2"
                        name="narrative_q2"
                        data-fact-key="\${q2.fact_key}"
                        data-question-id="\${q2.id}"
                        rows="5"
                        minlength="\${minLenQ}"
                        maxlength="10000"
                        placeholder="\${q2.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q2Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q2Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q2Colors[0]},0.3)';"
                        oninput="updateNarrativeCounterMajor(this, 10000);">\${savedQ2}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q2_hint" class="text-xs text-wiki-muted">ìµœì†Œ \${minLenQ}ì / í˜„ì¬ \${savedQ2.length}ì</span>
                        <span id="narrative_q2_counter" class="text-xs text-wiki-muted">\${savedQ2.length}ì</span>
                    </div>
                </div>

                <!-- ì‹¤ì¡´ì  ê°€ì¹˜ ì§ˆë¬¸ -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.2);">
                    <label class="block text-lg font-semibold mb-3 text-white">
                        <span class="mr-2">\u{1F30C}</span>
                        ë§ˆì§€ë§‰ 7ì¼
                    </label>
                    <div class="text-sm text-slate-300 mb-4 leading-relaxed space-y-2">
                        <p>ì˜¤ëŠ˜ ë°¤ 9ì‹œ, ëª¨ë“  ë°©ì†¡ê³¼ íœ´ëŒ€í°ì— ê¸´ê¸‰ ë‰´ìŠ¤ê°€ ëœ¹ë‹ˆë‹¤.</p>
                        <p>ì •í™•íˆ 7ì¼ ë’¤ ì§€êµ¬ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤. ìƒì¡´ ê°€ëŠ¥ì„±ì€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-white font-medium pt-1">ì´ ì†Œì‹ì„ ë“£ëŠ” ìˆœê°„, ê°€ì¥ ë¨¼ì € ë– ì˜¬ë¦´ í–‰ë™ì€ ë¬´ì—‡ì¼ ê²ƒ ê°™ë‚˜ìš”?</p>
                        <p class="text-white font-medium">ì–´ë””ë¡œ ê°€ê³  ì‹¶ê³ , ëˆ„êµ¬ë¥¼ ë§Œë‚˜ê³  ì‹¶ê³ , ë¬´ì—‡ì„ í•˜ê³  ì‹¶ì„ ê²ƒ ê°™ë‚˜ìš”?</p>
                    </div>
                    <textarea
                        id="narrative_q3"
                        name="narrative_q3"
                        data-fact-key="narrative.existential_answer"
                        rows="4"
                        minlength="20"
                        maxlength="5000"
                        placeholder="ê°€ì¥ ë¨¼ì € ë– ì˜¤ë¥´ëŠ” í–‰ë™, ê°€ê³  ì‹¶ì€ ê³³, ë§Œë‚˜ê³  ì‹¶ì€ ì‚¬ëŒì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”..."
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[100px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(168,85,247,0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(168,85,247,0.6)';"
                        onblur="this.style.borderColor='rgba(168,85,247,0.3)';"
                        oninput="updateNarrativeCounterMajor(this, 5000);">\${savedQ3}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q3_hint" class="text-xs text-wiki-muted">ìµœì†Œ 20ì / í˜„ì¬ \${savedQ3.length}ì</span>
                        <span id="narrative_q3_counter" class="text-xs text-wiki-muted">\${savedQ3.length}ì</span>
                    </div>
                </div>

                <div class="text-center text-xs text-wiki-muted/60 mt-6">
                    <i class="fas fa-shield-alt mr-1"></i>
                    ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ì¶”ì²œì—ë§Œ ì‚¬ìš©ë˜ë©°, ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            \`;

            // Step 2 ì œëª© ì—…ë°ì´íŠ¸
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = '<i class="fas fa-comments text-wiki-primary mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ ê¸°ì´ˆ';
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                step2Subtitle.textContent = 'ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ë“¤ë ¤ì£¼ì„¸ìš”';
            }

            // ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ';
                analyzeBtn.onclick = submitNarrativeAndContinueV3Major;
            }

            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    collectNarrativeAnswersMajor();
                    goToStep(1);
                };
            }

            // ì¹´ìš´í„° ì´ˆê¸°í™”
            setTimeout(() => {
                ['narrative_q0', 'narrative_q1', 'narrative_q2', 'narrative_q3'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value) updateNarrativeCounterMajor(el, id === 'narrative_q0' || id === 'narrative_q3' ? 5000 : 10000);
                });
            }, 100);
        }

        // V3: ì„œìˆ í˜• ê¸€ììˆ˜ ì¹´ìš´í„°
        function updateNarrativeCounterMajor(textarea, maxLength) {
            const counter = document.getElementById(textarea.id + '_counter');
            const hint = document.getElementById(textarea.id + '_hint');
            const current = textarea.value.length;
            const minLength = parseInt(textarea.minLength) || 30;

            if (counter) {
                counter.textContent = current.toLocaleString() + 'ì';
                if (current >= maxLength * 0.9) {
                    counter.style.color = current >= maxLength ? 'rgb(239, 68, 68)' : 'rgb(251, 146, 60)';
                } else if (current >= minLength) {
                    counter.style.color = 'rgb(74, 222, 128)';
                } else {
                    counter.style.color = 'rgb(148, 163, 184)';
                }
            }
            if (hint) {
                if (current >= minLength) {
                    hint.textContent = 'âœ“ ìµœì†Œ ' + minLength + 'ì ì¶©ì¡±';
                    hint.style.color = 'rgb(74, 222, 128)';
                } else {
                    hint.textContent = 'ìµœì†Œ ' + minLength + 'ì / í˜„ì¬ ' + current + 'ì';
                    hint.style.color = 'rgb(148, 163, 184)';
                }
            }
        }

        // V3: ì„œìˆ í˜• ë‹µë³€ ìˆ˜ì§‘
        function collectNarrativeAnswersMajor() {
            const q0 = document.getElementById('narrative_q0');
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');
            const q3 = document.getElementById('narrative_q3');

            if (q1 && q2) {
                window.narrativeFacts = {
                    storyAnswer: q0?.value?.trim() || '',
                    life_story: q0?.value?.trim() || '',
                    highAliveMoment: q1.value.trim(),
                    lostMoment: q2.value.trim(),
                    existentialAnswer: q3?.value?.trim() || '',
                    question1Answer: q1.value.trim(),
                    question2Answer: q2.value.trim(),
                    question1FactKey: q1.dataset.factKey,
                    question2FactKey: q2.dataset.factKey,
                    question1Id: q1.dataset.questionId,
                    question2Id: q2.dataset.questionId,
                };
            }
            return window.narrativeFacts || null;
        }

        // V3: ì„œìˆ í˜• í•„ìˆ˜ ê²€ì¦
        function validateNarrativeRequiredMajor() {
            const isMinor = ['major_child', 'major_elementary', 'major_middle'].includes(selectedStage);
            const minLenQ = isMinor ? 20 : 50;
            const minLenStory = isMinor ? 20 : 30;

            const q0 = document.getElementById('narrative_q0');
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');

            if (!q1 || !q2) return true;

            if (q0 && q0.value.trim().length < minLenStory) {
                q0.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q0.focus();
                alert('ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸°ë¥¼ ' + minLenStory + 'ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (q1.value.trim().length < minLenQ) {
                q1.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q1.focus();
                alert('ì²« ë²ˆì§¸ ì§ˆë¬¸ì— ' + minLenQ + 'ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (q2.value.trim().length < minLenQ) {
                q2.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q2.focus();
                alert('ë‘ ë²ˆì§¸ ì§ˆë¬¸ì— ' + minLenQ + 'ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            const q3 = document.getElementById('narrative_q3');
            if (q3 && q3.value.trim().length > 0 && q3.value.trim().length < 20) {
                q3.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q3.focus();
                alert('ë§ˆì§€ë§‰ ì§ˆë¬¸ì— 20ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return false;
            }

            return true;
        }

        // V3: ì„œìˆ í˜• ë‹µë³€ ì„œë²„ ì €ì¥
        async function saveNarrativeFactsMajor(facts) {
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                const response = await fetch('/api/ai-analyzer/v3/narrative-facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        high_alive_moment: facts.highAliveMoment || facts.question1Answer || '',
                        lost_moment: facts.lostMoment || facts.question2Answer || '',
                        existential_answer: facts.existentialAnswer || undefined,
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (errorText.includes('error code: 1031') || errorText.includes('no such table')) {
                        return true;
                    }
                    showErrorToastMajor('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + errorText.substring(0, 100));
                    return false;
                }

                const data = await response.json();
                if (!data.success) {
                    showErrorToastMajor('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + (data.detail || data.error || 'Unknown error'));
                    return false;
                }
                return true;
            } catch (error) {
                if (error.message && error.message.includes('JSON')) return true;
                showErrorToastMajor('ì„œìˆ í˜• ë‹µë³€ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (error.message || 'Network error'));
                return false;
            }
        }

        // V3: ì—ëŸ¬ í† ìŠ¤íŠ¸
        function showErrorToastMajor(message) {
            const existingToast = document.querySelector('.v3-error-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'v3-error-toast';
            toast.innerHTML = \`
                <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                            background: #ef4444; color: white; padding: 12px 20px; border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; max-width: 90vw;
                            font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>\${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="margin-left: 8px; background: none; border: none; color: white; cursor: pointer;">âœ•</button>
                </div>
            \`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // V3: ì„œìˆ í˜• ì œì¶œ í›„ ë¼ìš´ë“œ ì‹œì‘
        async function submitNarrativeAndContinueV3Major() {
            if (!validateNarrativeRequiredMajor()) return;

            const narrativeFacts = collectNarrativeAnswersMajor();

            if (window.__editMode && detectNarrativeChanges()) {
                cascadeResetFromNarrative();
            }
            if (narrativeFacts) {
                await saveNarrativeFactsMajor(narrativeFacts);
            }

            saveDraftToServer();

            await startV3RoundQuestionsMajor(1);
        }

        // V3: ë¼ìš´ë“œ ì§ˆë¬¸ ì‹œì‘
        async function startV3RoundQuestionsMajor(roundNumber) {
            const roundMeta = {
                1: { title: 'ë‚´ë©´ì˜ ì—ë„ˆì§€ íƒìƒ‰', subtitle: 'ë¬´ì—‡ì´ ë‹¹ì‹ ì„ ì›€ì§ì´ê²Œ í•˜ë‚˜ìš”?', emoji: 'ğŸ”¥', color: 'from-orange-500 to-red-500' },
                2: { title: 'ê²½ê³„ì„  í™•ì¸', subtitle: 'ë¬´ì—‡ì„ í”¼í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?', emoji: 'ğŸ›¡ï¸', color: 'from-purple-500 to-indigo-500' },
                3: { title: 'ì‹¤í–‰ ê³„íš ì„¤ê³„', subtitle: 'ì–´ë–»ê²Œ ì‹œì‘í•  ìˆ˜ ìˆì„ê¹Œìš”?', emoji: 'ğŸš€', color: 'from-emerald-500 to-teal-500' },
            };

            const meta = roundMeta[roundNumber];
            showLoading('ì§ˆë¬¸ êµ¬ì„± ì¤‘...', meta.subtitle);

            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                const response = await fetch('/api/ai-analyzer/v3/round-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        narrative_facts: window.narrativeFacts,
                        previous_round_answers: window.roundAnswers,
                        universal_answers: universalAnswers,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                    })
                });

                hideLoading();

                if (!response.ok) {
                    alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (HTTP ' + response.status + ')\\n\\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const data = await response.json();
                if (data.error) {
                    alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + (data.error || 'Unknown error'));
                    return;
                }

                const questions = data.questions || [];
                if (questions.length > 0) {
                    window.currentRound = roundNumber;
                    window.roundQuestions = questions;
                    renderV3RoundUIMajor(roundNumber, questions, meta);
                    document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
                    document.getElementById('step2')?.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('ì§ˆë¬¸ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                hideLoading();
                alert('ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + (error.message || 'Network error'));
            }
        }

        // V3: ë¼ìš´ë“œ UI ë Œë”ë§
        function renderV3RoundUIMajor(roundNumber, questions, meta) {
            const container = document.getElementById('followup-questions-form');
            if (!container) return;

            container.innerHTML = \`
                <!-- ë¼ìš´ë“œ í—¤ë” -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl mb-4" style="background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(234,88,12,0.1));">
                        <span class="text-3xl">\${meta.emoji}</span>
                        <div class="text-left">
                            <div class="text-lg font-bold text-white">\${meta.title}</div>
                            <div class="text-sm text-wiki-muted">\${meta.subtitle}</div>
                        </div>
                    </div>

                    <!-- ë¼ìš´ë“œ ì§„í–‰ í‘œì‹œ -->
                    <div class="flex items-center justify-center gap-3 mb-4">
                        \${[1, 2, 3].map(r => \`
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all \${r === roundNumber ? 'bg-gradient-to-r ' + meta.color + ' text-white scale-110' : r < roundNumber ? 'bg-emerald-500 text-white' : 'bg-wiki-card text-wiki-muted'}">
                                    \${r < roundNumber ? 'âœ“' : r}
                                </div>
                                \${r < 3 ? '<div class="w-8 h-0.5 ' + (r < roundNumber ? 'bg-emerald-500' : 'bg-wiki-border') + '"></div>' : ''}
                            </div>
                        \`).join('')}
                    </div>
                    <div class="text-xs text-wiki-muted">Round \${roundNumber} / 3</div>
                </div>

                <!-- ì§ˆë¬¸ë“¤ -->
                <div class="space-y-6" id="v3-round-questions">
                    \${questions.map((q, idx) => \`
                        <div class="question-block p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(26,26,46,0.8), rgba(36,36,56,0.5)); border: 1px solid rgba(67,97,238,0.2);">
                            <label class="block text-lg font-semibold mb-3 text-white">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-wiki-primary/20 text-wiki-primary text-sm mr-2">\${idx + 1}</span>
                                \${q.questionText}
                            </label>
                            <textarea
                                id="v3_q_\${q.id}"
                                name="\${q.id}"
                                rows="4"
                                minlength="\${q.minLengthGuidance || 30}"
                                placeholder="ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”..."
                                class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                style="background-color: rgba(15,15,35,1); border-color: rgba(67,97,238,0.3); color: #fff;"
                                onfocus="this.style.borderColor='rgba(67,97,238,0.6)';"
                                onblur="this.style.borderColor='rgba(67,97,238,0.3)';"
                                oninput="updateV3CounterMajor(this)"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-wiki-muted">ìµœì†Œ \${q.minLengthGuidance || 30}ì</span>
                                <span id="v3_q_\${q.id}_counter" class="text-xs text-wiki-muted">0ì</span>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;

            // Step 2 ì œëª© ì—…ë°ì´íŠ¸
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = \`<i class="fas fa-comments text-wiki-primary mr-2"></i>ì‹¬ì¸µ ì§ˆë¬¸ Round \${roundNumber}\`;
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                const subtitleText = roundNumber === 1
                    ? 'ë‹¹ì‹ ì˜ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤ ì§ˆë¬¸ì„ ì¤€ë¹„í–ˆì–´ìš”'
                    : roundNumber === 2
                    ? 'ë” ê¹Šì´ ìˆëŠ” ì´í•´ë¥¼ ìœ„í•œ ì§ˆë¬¸ì´ì—ìš”'
                    : 'ë§ˆì§€ë§‰ìœ¼ë¡œ ëª‡ ê°€ì§€ë§Œ ë” ì—¬ì­¤ë³¼ê²Œìš”';
                step2Subtitle.textContent = subtitleText;
            }

            // ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                if (roundNumber < 3) {
                    analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>ë‹¤ìŒ ë¼ìš´ë“œ';
                    analyzeBtn.onclick = () => submitV3RoundAndContinueMajor(roundNumber, questions);
                } else {
                    analyzeBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>AI ì „ê³µ ì¶”ì²œ ë°›ê¸°';
                    analyzeBtn.onclick = () => submitV3RoundAndAnalyzeMajor(questions);
                }
            }

            // ì´ì „ ë²„íŠ¼ ë™ì‘
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    if (roundNumber === 1) {
                        showPrevWarningModalMajor(() => {
                            renderNarrativeStepMajor();
                        });
                    } else {
                        startV3RoundQuestionsMajor(roundNumber - 1);
                    }
                };
            }
        }

        // V3: ê¸€ììˆ˜ ì¹´ìš´í„°
        function updateV3CounterMajor(textarea) {
            const counter = document.getElementById(textarea.id + '_counter');
            if (counter) {
                counter.textContent = textarea.value.length + 'ì';
                counter.style.color = textarea.value.length >= (parseInt(textarea.minLength) || 30) ? 'rgb(74, 222, 128)' : 'rgb(148,163,184)';
            }
        }

        // V3: ì´ì „ ë²„íŠ¼ ê²½ê³  ëª¨ë‹¬
        function showPrevWarningModalMajor(onConfirm) {
            const existingModal = document.getElementById('prev-warning-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'prev-warning-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.innerHTML = \`
                <div class="bg-wiki-card rounded-2xl p-6 max-w-md w-full border border-wiki-border shadow-2xl">
                    <div class="text-center mb-4">
                        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-yellow-500/20 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-2xl text-yellow-400"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                        <p class="text-wiki-muted text-sm">ì´ì „ ë‹¨ê³„ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ë©´ ì‹¬ì¸µ ì§ˆë¬¸ì´ ìƒˆë¡œ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-yellow-400 text-sm mt-2"><i class="fas fa-info-circle mr-1"></i>ê¸°ì¡´ ë‹µë³€ì´ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="prev-warning-cancel" class="flex-1 px-4 py-3 bg-wiki-bg border border-wiki-border rounded-xl text-white hover:bg-wiki-card transition">
                            ì·¨ì†Œ
                        </button>
                        <button id="prev-warning-confirm" class="flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl text-white font-medium transition">
                            ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            \`;

            document.body.appendChild(modal);

            document.getElementById('prev-warning-cancel').onclick = () => modal.remove();
            document.getElementById('prev-warning-confirm').onclick = () => {
                modal.remove();
                window.currentRound = 0;
                window.roundQuestions = null;
                window.roundAnswers = [];
                onConfirm();
            };
        }

        // V3: ë¼ìš´ë“œ ë‹µë³€ ìˆ˜ì§‘
        function collectV3RoundAnswersMajor(questions) {
            return questions.map(q => {
                const textarea = document.getElementById('v3_q_' + q.id);
                return {
                    question_id: q.id,
                    question_text: q.questionText,
                    purpose_tag: q.purposeTag,
                    answer: textarea ? textarea.value.trim() : '',
                };
            });
        }

        // V3: ë‹µë³€ ê²€ì¦
        function validateV3AnswersMajor(answers, questions) {
            for (let i = 0; i < answers.length; i++) {
                const minLen = questions[i].minLengthGuidance || 30;
                if (answers[i].answer.length < minLen) {
                    const textarea = document.getElementById('v3_q_' + questions[i].id);
                    if (textarea) {
                        textarea.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                        textarea.focus();
                    }
                    alert('ì§ˆë¬¸ ' + (i + 1) + 'ì— ' + minLen + 'ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                    return false;
                }
            }
            return true;
        }

        // V3: ë¼ìš´ë“œ ë‹µë³€ ì €ì¥
        async function saveV3RoundAnswersMajor(roundNumber, answers) {
            for (const ans of answers) {
                window.roundAnswers.push({
                    questionId: ans.question_id,
                    questionText: ans.question_text,
                    roundNumber: roundNumber,
                    answer: ans.answer,
                    answeredAt: new Date().toISOString(),
                });
            }

            try {
                const response = await fetch('/api/ai-analyzer/v3/round-answers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        answers: answers,
                    })
                });

                if (!response.ok) {
                    showErrorToastMajor('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì‹¤íŒ¨ (HTTP ' + response.status + ')');
                    return false;
                }

                const data = await response.json();
                if (!data.success) {
                    showErrorToastMajor('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì‹¤íŒ¨: ' + (data.detail || data.error || 'Unknown error'));
                    return false;
                }
                return true;
            } catch (error) {
                showErrorToastMajor('ë¼ìš´ë“œ ' + roundNumber + ' ë‹µë³€ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (error.message || 'Network error'));
                return false;
            }
        }

        // V3: ë¼ìš´ë“œ ë‹µë³€ ì œì¶œ í›„ ë‹¤ìŒ ë¼ìš´ë“œ
        async function submitV3RoundAndContinueMajor(currentRound, questions) {
            const answers = collectV3RoundAnswersMajor(questions);
            if (!validateV3AnswersMajor(answers, questions)) return;

            if (window.__editMode && detectRoundChanges(currentRound)) {
                cascadeResetFromRound(currentRound);
            }

            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”');

            try {
                await saveV3RoundAnswersMajor(currentRound, answers);
                await startV3RoundQuestionsMajor(currentRound + 1);
            } finally {
                hideLoading();
            }
        }

        // V3: ë§ˆì§€ë§‰ ë¼ìš´ë“œ í›„ ë¶„ì„ ì‹œì‘
        async function submitV3RoundAndAnalyzeMajor(questions) {
            const answers = collectV3RoundAnswersMajor(questions);
            if (!validateV3AnswersMajor(answers, questions)) return;

            showLoading('ë‹µë³€ ì €ì¥ ì¤‘...', 'ë§ˆì§€ë§‰ ë‹µë³€ì„ ì €ì¥í•˜ê³  ìˆì–´ìš”');
            await saveV3RoundAnswersMajor(3, answers);

            showLoading('AIê°€ ë¶„ì„ ì¤‘...', 'ìµœì ì˜ ì „ê³µì„ ì°¾ê³  ìˆì–´ìš”');

            try {
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage || 'major_high',
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        narrative_facts: window.narrativeFacts,
                        round_answers: window.roundAnswers,
                        engine_version: 'v3',
                        academic_state: window.academicState || undefined,
                        debug: DEBUG_MODE,
                        ...getEditModePayloadExtras(),
                    })
                });

                const data = await response.json();
                hideLoading();

                if (window.__editMode && data.request_id) {
                    fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                        method: 'DELETE', credentials: 'same-origin'
                    }).catch(() => {});
                    window.location.href = '/user/ai-results/' + data.request_id;
                    return;
                }

                currentRequestId = data.request_id;
                displayResults(data);
                saveDraftAsCompletedMajor();
                goToStep(3);
            } catch (error) {
                hideLoading();
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function submitFollowupsAndAnalyze() {
            showLoading('AIê°€ ë¶„ì„ ì¤‘...', 'ìµœì ì˜ ì „ê³µì„ ì°¾ê³  ìˆì–´ìš”');
            
            try {
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage || 'major_high',
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        followup_answers: followupAnswers,
                        academic_state: window.academicState || undefined,
                        debug: DEBUG_MODE,
                        ...getEditModePayloadExtras(),
                    })
                });

                const data = await response.json();
                hideLoading();

                // í¸ì§‘ ëª¨ë“œ: ë¶„ì„ ì™„ë£Œ â†’ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                if (window.__editMode && data.request_id) {
                    fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(window.__editSessionId), {
                        method: 'DELETE', credentials: 'same-origin'
                    }).catch(() => {});
                    window.location.href = '/user/ai-results/' + data.request_id;
                    return;
                }

                currentRequestId = data.request_id;
                displayResults(data);
                saveDraftAsCompletedMajor();  // ê²°ê³¼ ì €ì¥
                goToStep(3);
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        function displayResults(data) {
            const result = data.result || data;

            // V3 í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ê°€ ìˆìœ¼ë©´ 4íƒ­ UI í‘œì‹œ
            if (result.premium_report) {
                displayPremiumReportV3Major(result);
                return;
            }

            const container = document.getElementById('major-results');

            // Confidence UI í‘œì‹œ
            displayConfidenceUI(result);

            // ì¶”ì²œ ì „ê³µ ë°°ì—´ ì¶”ì¶œ (ë¼ì´ë¸Œ ì‘ë‹µ vs ì €ì¥ëœ ê²°ê³¼ ë‘˜ ë‹¤ ì²˜ë¦¬)
            let majors = [];
            if (result.recommendations && result.recommendations.top_majors) {
                majors = result.recommendations.top_majors;
            } else if (result.fit_top_majors) {
                majors = result.fit_top_majors;
            } else if (Array.isArray(result.recommendations)) {
                majors = result.recommendations;
            }

            if (!majors || majors.length === 0) {
                container.innerHTML = '<p class="text-center text-wiki-muted">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            container.innerHTML = majors.map((rec, i) => \`
                <a href="/major/\${rec.slug || rec.major_id || rec.id || encodeURIComponent(rec.major_name || rec.name)}" class="block p-4 bg-wiki-bg rounded-lg border border-wiki-border hover:border-wiki-primary transition group \${i === 0 ? 'border-wiki-primary ring-2 ring-wiki-primary/20' : ''}">
                    \${rec.image_url ? \`
                        <div class="mb-3 overflow-hidden rounded-lg">
                            <img src="\${rec.image_url}" alt="\${rec.major_name || rec.name}" class="w-full h-32 object-cover group-hover:scale-105 transition-transform" />
                        </div>
                    \` : ''}
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-2xl font-bold text-wiki-primary">#\${i + 1}</span>
                        <h3 class="text-lg font-bold group-hover:text-wiki-primary transition">\${rec.major_name || rec.name || 'ì¶”ì²œ ì „ê³µ'}</h3>
                    </div>
                    <p class="text-wiki-muted text-sm mb-2">\${rec.reason || rec.match_reason || ''}</p>
                    \${rec.fit_score ? \`<div class="text-sm text-wiki-secondary">ì í•©ë„: \${Math.round(rec.fit_score)}ì </div>\` : ''}
                    \${rec.field_category ? \`<div class="text-xs text-wiki-muted mt-1">\${rec.field_category}</div>\` : ''}
                    <div class="text-xs text-wiki-primary mt-2 opacity-0 group-hover:opacity-100 transition">ìì„¸íˆ ë³´ê¸° â†’</div>
                </a>
            \`).join('');
        }
        

        // ============================================
// V3 Premium Report - Major (ì „ê³µ) Analyzer
// ============================================

function addReportStylesMajor() {
    if (document.getElementById('report-v3-styles-major')) return;

    const style = document.createElement('style');
    style.id = 'report-v3-styles-major';
    style.textContent = \`
        .report-tab {
            background-color: rgba(26,26,46,0.5);
            color: rgb(148,163,184);
        }
        .report-tab:hover {
            background-color: rgba(42,42,62,0.5);
        }
        .report-tab.active {
            background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(168,85,247,0.2));
            color: white;
            border: 1px solid rgba(99,102,241,0.5);
        }
        .major-set-tab {
            background: linear-gradient(135deg, rgba(26,26,46,0.7), rgba(42,42,62,0.5));
            color: rgb(148,163,184);
            border: 1px solid rgba(148,163,184,0.15);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .major-set-tab:hover {
            background: linear-gradient(135deg, rgba(42,42,62,0.8), rgba(62,62,82,0.6));
            color: rgb(200,210,220);
            border-color: rgba(148,163,184,0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .major-set-tab.active {
            background: linear-gradient(135deg, rgba(99,102,241,0.4), rgba(168,85,247,0.25));
            color: white;
            border: 1px solid rgba(99,102,241,0.5);
            box-shadow: 0 4px 16px rgba(99,102,241,0.25);
        }
    \`;
    document.head.appendChild(style);
}

// â”€â”€ í•œêµ­ì–´ ë²ˆì—­ ë ˆì´ë¸” (ì „ê³µ ë¦¬í¬íŠ¸ìš©) â”€â”€
const STAGE_LABELS_M = {
    job_explore: 'íƒìƒ‰ ë‹¨ê³„', job_student: 'í•™ìƒ ë‹¨ê³„', job_prepare: 'ì·¨ì—… ì¤€ë¹„',
    job_early: 'ì´ˆê¸° ì»¤ë¦¬ì–´ (0~3ë…„)', job_mid: 'ê²½ë ¥ì (3ë…„+)',
    job_transition: 'ì „í™˜/ë³µê·€', job_second: 'ì„¸ì»¨ë“œ ì»¤ë¦¬ì–´',
    major_child: 'ì–´ë¦°ì´', major_elementary: 'ì´ˆë“±í•™ìƒ', major_middle: 'ì¤‘í•™ìƒ',
    major_high: 'ê³ ë“±í•™ìƒ', major_freshman: 'ëŒ€í•™ ì‹ ì…ìƒ',
    major_student: 'ëŒ€í•™ ì¬í•™ìƒ', major_graduate: 'ëŒ€í•™ì› ì¤€ë¹„',
};
const VALUE_LABELS_M = {
    recognition: 'ì¸ì •ë°›ê³  ì˜í–¥ë ¥ ë°œíœ˜', stability: 'ì•ˆì •ì„±', income: 'ë†’ì€ ìˆ˜ì…',
    growth: 'ì„±ì¥', autonomy: 'ììœ¨ì„±', meaning: 'ì˜ë¯¸/ì‚¬íšŒ ê¸°ì—¬',
    wlb: 'ì›Œë¼ë°¸', balance: 'ì¼ê³¼ ì‚¶ì˜ ê· í˜•', expertise: 'ì „ë¬¸ì„±', creativity: 'ì°½ì˜ì„±',
};
const WORKSTYLE_LABELS_M = {
    solo: 'í˜¼ì ì§‘ì¤‘', solo_deep: 'í˜¼ì ê¹Šì´ ì§‘ì¤‘', team: 'íŒ€ í˜‘ì—…',
    team_harmony: 'íŒ€ ì¡°í™”', mixed: 'ìƒí™©ì— ë”°ë¼', structured: 'ì²´ê³„ì  í™˜ê²½', flexible: 'ììœ ë¡œìš´ í™˜ê²½',
};
const INTEREST_LABELS_M = {
    problem_solving: 'ë¬¸ì œ í•´ê²°', data_numbers: 'ë°ì´í„°/ìˆ«ì', tech: 'ê¸°ìˆ /IT',
    creative: 'ì°½ì‘/ì˜ˆìˆ ', people: 'ì‚¬ëŒ/ì†Œí†µ', helping: 'ëŒë´„/ë´‰ì‚¬', helping_teaching: 'êµìœ¡/ë´‰ì‚¬',
    business: 'ë¹„ì¦ˆë‹ˆìŠ¤/ê²½ì˜', nature: 'ìì—°/í™˜ê²½', physical: 'ì‹ ì²´ í™œë™',
    research: 'ì—°êµ¬/íƒêµ¬', teaching: 'êµìœ¡/ê°€ë¥´ì¹¨', analysis: 'ë¶„ì„',
    design: 'ë””ìì¸', writing: 'ê¸€ì“°ê¸°', hands_on: 'ì†ìœ¼ë¡œ ë§Œë“¤ê¸°',
    creating: 'ì°½ì‘ í™œë™', organizing: 'ì¡°ì§/ê´€ë¦¬', influencing: 'ì˜í–¥ë ¥ ë°œíœ˜',
};
const STRENGTH_LABELS_M = {
    analytical: 'ë¶„ì„ë ¥', creative: 'ì°½ì˜ë ¥', communication: 'ì†Œí†µë ¥',
    structured_execution: 'ì‹¤í–‰ë ¥', persistence: 'ëˆê¸°', fast_learning: 'í•™ìŠµë ¥',
    leadership: 'ë¦¬ë”ì‹­', detail_oriented: 'ê¼¼ê¼¼í•¨', patience: 'ì¸ë‚´ì‹¬',
    empathy: 'ê³µê° ëŠ¥ë ¥', organization: 'ì²´ê³„ì  ì •ë¦¬', adaptability: 'ì ì‘ë ¥',
    perseverance: 'ëˆê¸°', creativity: 'ì°½ì˜ì„±', strategic: 'ì „ëµì  ì‚¬ê³ ',
    teamwork: 'íŒ€ì›Œí¬', independence: 'ë…ë¦½ì  ì—…ë¬´',
};
const DRAIN_LABELS_M = {
    people_drain: 'ëŒ€ì¸ê´€ê³„ ìŠ¤íŠ¸ë ˆìŠ¤', cognitive_drain: 'ì¸ì§€ í”¼ë¡œ',
    time_pressure_drain: 'ì‹œê°„ ì••ë°• ìŠ¤íŠ¸ë ˆìŠ¤', responsibility_drain: 'ì±…ì„ ìŠ¤íŠ¸ë ˆìŠ¤',
    repetition_drain: 'ë°˜ë³µ í”¼ë¡œ', unpredictability_drain: 'ë¶ˆí™•ì‹¤ì„± ìŠ¤íŠ¸ë ˆìŠ¤',
    routine_drain: 'ë°˜ë³µ ì—…ë¬´ í”¼ë¡œ', bureaucracy_drain: 'ê´€ë£Œì£¼ì˜ ìŠ¤íŠ¸ë ˆìŠ¤',
    pressure_drain: 'ë§ˆê° ì••ë°•', conflict_drain: 'ê°ˆë“± ìƒí™©',
    isolation_drain: 'ê³ ë¦½ëœ í™˜ê²½', physical_drain: 'ì‹ ì²´ì  í”¼ë¡œ', uncertainty_drain: 'ë¶ˆí™•ì‹¤ì„±',
};
const SACRIFICE_LABELS_M = {
    low_initial_income: 'ë‚®ì€ ì´ˆë´‰ ê°ìˆ˜', willing_to_study: 'ì¬í•™ìŠµ ê°ìˆ˜',
    field_change_ok: 'ë¶„ì•¼ ì „í™˜ ê°ìˆ˜', ignore_social_pressure: 'ì£¼ë³€ ì‹œì„  ê°ìˆ˜',
    no_sacrifice: 'í¬ê¸° ë¶ˆê°€', unstable_hours: 'ë¶ˆê·œì¹™í•œ ì‹œê°„ ê°ìˆ˜',
    long_hours_ok: 'ê¸´ ê·¼ë¬´ì‹œê°„ ê°ìˆ˜', long_hours: 'ê¸´ ê·¼ë¬´ì‹œê°„',
    relocation: 'ê±°ì£¼ì§€ ì´ë™', unstable_early: 'ì´ˆê¸° ë¶ˆì•ˆì • ê°ìˆ˜',
};
const CONSTRAINT_LABELS_M = {
    time_constraint: 'ì‹œê°„ ì œì•½', income_constraint: 'ìˆ˜ì… ì¡°ê±´',
    location_constraint: 'ìœ„ì¹˜ ì œì•½', physical_constraint: 'ì²´ë ¥ ì œì•½',
    qualification_constraint: 'ìê²© ì œì•½', uncertainty_constraint: 'ë¶ˆí™•ì‹¤ì„± íšŒí”¼',
    health_constraint: 'ê±´ê°• ì œì•½', math_impossible: 'ìˆ˜í•™ ë¶ˆê°€',
    low_employment_avoid: 'ë‚®ì€ ì·¨ì—…ë¥  íšŒí”¼',
    work_hours_strict: 'ë¶ˆê·œì¹™í•œ ê·¼ë¬´ì‹œê°„', no_travel: 'ì¶œì¥ ë¶ˆê°€',
    no_overtime: 'ì•¼ê·¼ ë¶ˆê°€', remote_only: 'ì¬íƒë§Œ ê°€ëŠ¥',
    remote_preferred: 'ì¬íƒ ì„ í˜¸', prefer_remote: 'ì¬íƒ ì„ í˜¸',
};

function escapeTemplateStringM(str) {
    if (!str) return str;
    const backtick = String.fromCharCode(96);
    return String(str).replace(/\\$/g, '&#36;').replace(new RegExp(backtick, 'g'), '&#96;');
}

function translateToKorean(text) {
    if (!text) return text;
    let result = String(text);
    const ALL_LABELS = {
        ...STAGE_LABELS_M, ...VALUE_LABELS_M, ...WORKSTYLE_LABELS_M,
        ...INTEREST_LABELS_M, ...STRENGTH_LABELS_M, ...DRAIN_LABELS_M,
        ...SACRIFICE_LABELS_M, ...CONSTRAINT_LABELS_M,
    };
    if (ALL_LABELS[result]) return ALL_LABELS[result];
    const sortedEntries = Object.entries(ALL_LABELS).sort((a, b) => b[0].length - a[0].length);
    for (const [eng, kor] of sortedEntries) {
        result = result.replace(new RegExp(eng.replace(/_/g, '[_\\\\s]?'), 'gi'), kor);
    }
    return escapeTemplateStringM(result);
}

function displayPremiumReportV3Major(result) {
    // ê²°ê³¼ ë‹¨ê³„: step indicatorì™€ í˜ì´ì§€ íƒ€ì´í‹€ ìˆ¨ê¹€
    const stepIndicator = document.getElementById('step-indicator');
    if (stepIndicator) stepIndicator.style.display = 'none';
    const pageTitle = document.querySelector('h1.text-3xl');
    if (pageTitle) pageTitle.style.display = 'none';
    const accountBanner = document.getElementById('account-warning-banner');
    if (accountBanner) accountBanner.style.display = 'none';

    const report = result.premium_report || {};

    // PremiumReport íƒ€ì… ë°ì´í„° ë§¤í•‘
    const summary = {
        headline: report.executiveSummary || report.summary_one_page?.headline || '',
        top_takeaways: report.lifeVersionStatement?.expanded || report.summary_one_page?.top_takeaways || [],
        recommended_next_step: report.studyGuidance?.doNow?.[0] || report.summary_one_page?.recommended_next_step || '',
    };

    const mm = window.miniModuleResult || {};

    // learningStyleNarrative í…ìŠ¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜
    function cleanLearningStyleNarrative(text) {
        if (!text) return null;
        let cleaned = text;
        cleaned = cleaned.replace(/\\([^)]*(?:Top2|ì„ í˜¸|ê°•ì )[^)]*\\)/g, '');
        const parts = cleaned.split('ë‹¹ì‹ ì€');
        if (parts.length > 2) {
            cleaned = parts[0] + 'ë‹¹ì‹ ì€' + parts.slice(1).join('');
        }
        cleaned = cleaned.replace(/\\s+/g, ' ').trim();
        return cleaned;
    }

    const personal = {
        personality_summary: cleanLearningStyleNarrative(report.learningStyleNarrative) ||
            (report.lifeVersionStatement?.oneLiner) ||
            (mm.interest_top?.length ? generatePersonalitySummaryMajor(mm) : null),
        work_style_insights: [
            report.learningStyleMap?.solo_vs_collaborative ? \`\${translateToKorean(report.learningStyleMap.solo_vs_collaborative > 0 ? 'í˜‘ì—…í•™ìŠµ' : 'ë…ë¦½í•™ìŠµ')} í•™ìŠµ ìŠ¤íƒ€ì¼ì„ ì„ í˜¸í•©ë‹ˆë‹¤\` : null,
            report.learningStyleMap?.structured_vs_exploratory ? \`í•™ìŠµ ì‹œ \${translateToKorean(report.learningStyleMap.structured_vs_exploratory > 0 ? 'íƒêµ¬ì ' : 'ì²´ê³„ì ')} ì ‘ê·¼ì„ ì·¨í•©ë‹ˆë‹¤\` : null,
            report.growthCurveDescription || null,
            ...(report.personal_analysis?.work_style_insights || []),
        ].filter(Boolean),
        value_priorities: mm.value_top?.map(v => translateToKorean(v)) ||
            report.personal_analysis?.value_priorities || [],
        potential_challenges: [
            ...(report.stressTriggers || []),
            ...(report.conflictPatterns || []),
            ...(report.personal_analysis?.potential_challenges || []),
        ].slice(0, 3),
        blind_spots_to_check: report.failurePattern ? [report.failurePattern] :
            (report.personal_analysis?.blind_spots_to_check || []),
    };

    // í•œêµ­ì–´ ë°›ì¹¨ íŒë³„
    function hasBatchim(word) {
        if (!word || word.length === 0) return false;
        const last = word.charCodeAt(word.length - 1);
        if (last >= 0xAC00 && last <= 0xD7A3) return (last - 0xAC00) % 28 !== 0;
        if (last >= 0x30 && last <= 0x39) return [0, 1, 3, 6, 7, 8].includes(last - 0x30);
        return false;
    }

    // ì„±ê²© ìš”ì•½ ìƒì„± í—¬í¼
    function generatePersonalitySummaryMajor(mm) {
        const parts = [];
        if (mm.interest_top?.length) {
            const items = mm.interest_top.map(t => translateToKorean(t));
            const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? 'ê³¼ ' : 'ì™€ ') + items[items.length - 1] : items[0];
            parts.push(\`\${joined}ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ìˆìœ¼ë©°\`);
        }
        if (mm.value_top?.length) {
            const items = mm.value_top.map(t => translateToKorean(t));
            const lastItem = items[items.length - 1];
            const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? 'ê³¼ ' : 'ì™€ ') + lastItem : lastItem;
            const particle = hasBatchim(lastItem) ? 'ì„' : 'ë¥¼';
            parts.push(\`\${joined}\${particle} ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ”\`);
        }
        if (mm.strength_top?.length) {
            const items = mm.strength_top.map(t => translateToKorean(t));
            parts.push(\`\${items.join(', ')}ì—ì„œ ê°•ì ì„ ë³´ì´ëŠ”\`);
        }
        if (parts.length === 0) return null;
        return parts.join(' ') + ' ë¶„ì…ë‹ˆë‹¤.';
    }

    // V3 ì‹¬ë¦¬ ë¶„ì„ ë°ì´í„° ë§¤í•‘
    const innerConflict = {
        analysis: report.innerConflictAnalysis || '',
        patterns: report.conflictPatterns || [],
    };
    const growthCurve = {
        type: report.growthCurveType || '',
        description: report.growthCurveDescription || '',
    };
    const stressProfile = {
        profile: report.stressProfile || '',
        triggers: report.stressTriggers || [],
        failurePattern: report.failurePattern || '',
    };
    const profileInterpretation = report.profileInterpretation || null;

    // í•™ê¸°ë³„ ë¡œë“œë§µ
    const academicTimeline = report.academicTimeline || {
        semester1: { goal: '', actions: [], milestone: '' },
        semester2: { goal: '', actions: [], milestone: '' },
        semester3_4: { goal: '', actions: [], milestone: '' },
        beyond: { goal: '', actions: [], milestone: '' },
    };

    // ì¸ìƒ ë²„ì „ ì„ ì–¸ë¬¸
    const lifeVersion = {
        oneLiner: report.lifeVersionStatement?.oneLiner || '',
        expanded: report.lifeVersionStatement?.expanded || [],
    };

    // í•™ìŠµ ê°€ì´ë“œ
    const studyGuidance = report.studyGuidance || {
        doNow: [],
        stopDoing: [],
        experiment: [],
        studyTips: [],
    };

    // í•™ìŠµ ìŠ¤íƒ€ì¼ ë§µ (5ì¶•)
    const learningStyleMap = report.learningStyleMap || {
        theoretical_vs_practical: 0,
        solo_vs_collaborative: 0,
        structured_vs_exploratory: 0,
        depth_vs_breadth: 0,
        guided_vs_autonomous: 0,
    };

    // ë©”íƒ€ì¸ì§€ ë¶„ì„ ê²°ê³¼
    const metaCognition = report.metaCognition || null;

    // ì „ê³µ ì¶”ì²œ ë°ì´í„°
    const fitTopMajors = result.fit_top_majors || [];
    const majorRecs = report.majorRecommendations || {};

    const overallTop5 = fitTopMajors.length > 0 ? fitTopMajors.slice(0, 5) : (majorRecs.overallTop5 || []);
    const fitTop10 = (result.can_top10 || fitTopMajors || []).slice(0, 10);
    const likeTop10 = (result.like_top10 || majorRecs.desireTop10 || []).slice(0, 10);

    // ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    const container = document.getElementById('step3');
    if (!container) return;

    // ì „ê³µ ë¹„ì „ ì„¹ì…˜ HTML ì‚¬ì „ ê³„ì‚°
    let careerVisionHtml = '';
    if (lifeVersion.oneLiner) {
        let profileDesc = '';
        if (profileInterpretation) {
            const pi = profileInterpretation;
            const parts = [];
            if (pi.interests?.length > 0) {
                parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>ì— ê´€ì‹¬ì´ ìˆê³ ');
            }
            if (pi.strengths?.length > 0) {
                parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>ì´ ê°•ì ì´ë©°');
            }
            if (pi.values?.length > 0) {
                parts.push('<span class="text-purple-400">' + translateToKorean(pi.values[0].label) + '</span>ì„ ì¤‘ì‹œí•˜ëŠ” ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤ ë¶„ì„ì…ë‹ˆë‹¤.');
            }
            if (parts.length > 0) {
                const joined = parts.join(', ');
                const finalText = joined.endsWith('.') ? joined : joined + 'ì˜ í”„ë¡œí•„ì…ë‹ˆë‹¤.';
                profileDesc = '<p class="text-[15px] text-wiki-muted mt-3 leading-relaxed">' + finalText + '</p>';
            }
        }
        careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.3);"><p class="text-lg md:text-xl font-semibold leading-relaxed" style="color: rgb(251,191,36);">"' + translateToKorean(lifeVersion.oneLiner) + '"</p>' + profileDesc + '</div>';
    } else if (personal.personality_summary) {
        const highlightedText = personal.personality_summary.replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">&#39;$1&#39;</strong>');
        careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">ğŸ’« ' + highlightedText + '</p></div>';
    } else if (profileInterpretation) {
        const pi = profileInterpretation;
        const parts = [];
        if (pi.interests?.length > 0) {
            parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>ì„ ì¢‹ì•„í•˜ê³ ');
        }
        if (pi.strengths?.length > 0) {
            parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>ì— ê°•ì ì„ ê°€ì§„');
        }
        if (pi.values?.length > 0) {
            const valLabel = translateToKorean(pi.values[0].label);
            parts.push('<span class="text-purple-400">' + valLabel + '</span>' + (hasBatchim(valLabel) ? 'ì„' : 'ë¥¼') + ' ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ”');
        }
        const summaryText = parts.length > 0 ? 'ë‹¹ì‹ ì€ ' + parts.join(', ') + ' ì‚¬ëŒì…ë‹ˆë‹¤.' : 'ë‹¹ì‹ ì˜ ì „ê³µ í”„ë¡œí•„ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.';
        careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">ğŸ’« ' + summaryText + '</p></div>';
    }

    // íƒ­ UI ìƒì„±
    container.innerHTML = \`
        <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
        <div class="text-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold mb-2 flex items-center justify-center gap-2">
                <span class="text-2xl">âœ¨</span>
                ë‹¹ì‹ ë§Œì˜ ì „ê³µ ë¶„ì„ ë¦¬í¬íŠ¸
            </h2>
            <p class="text-wiki-muted text-sm">AIê°€ ë¶„ì„í•œ ë‹¹ì‹ ì˜ ì „ê³µ ë°©í–¥ì„±</p>
            <div class="flex justify-center items-center gap-2 mt-3">
                <button onclick="shareReportMajor()" id="share-report-btn" class="inline-flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium transition" style="background: linear-gradient(135deg, #6366f1, #a855f7); color: white; border: none; cursor: pointer;">
                    <i class="fas fa-share-alt"></i> ê³µìœ 
                </button>
                \${DEBUG_MODE ? \`
                <button onclick="copyAllReportContent()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition" style="background: rgba(67, 97, 238, 0.2); color: #64b5f6; border: 1px solid rgba(67, 97, 238, 0.3);">
                    <i class="fas fa-copy"></i> ê²°ê³¼ ì „ì²´ ë³µì‚¬
                </button>
                \` : ''}
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex justify-center gap-1 mb-6 flex-wrap" id="report-tabs">
            <button onclick="showReportTabMajor('summary')" class="report-tab active px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="summary">ìš”ì•½</button>
            <button onclick="showReportTabMajor('psychology')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="psychology">ë©”íƒ€ì¸ì§€</button>
            <button onclick="showReportTabMajor('recommendations')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="recommendations">ì¶”ì²œ ì „ê³µ</button>
            <button onclick="showReportTabMajor('details')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="details" title="ë¶„ì„ ìƒì„¸">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>

        <!-- íƒ­ ì»¨í…ì¸ : ìš”ì•½ -->
        <div id="tab-summary" class="report-tab-content glass-card p-6 rounded-2xl mb-6">
            <div class="mb-8 pb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                    <span class="text-3xl">ğŸ“‹</span>
                    <span class="bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">ìš”ì•½</span>
                </h2>
                <p class="text-center text-wiki-muted text-sm mt-2">ë‹¹ì‹ ì˜ ì „ê³µ ë¶„ì„ í•µì‹¬ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
                <div class="mt-6 h-px bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
            </div>

            <!-- ì „ê³µ ë¹„ì „ -->
            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                <span>âœ¨</span> ì „ê³µ ë¹„ì „
            </h4>
            \${careerVisionHtml}

            <!-- ë©”íƒ€ì¸ì§€ ìš”ì•½ (ìš”ì•½ íƒ­) -->
            \${metaCognition ? \`
                <div class="mt-8 mb-8">
                    <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                        <span>ğŸ“Š</span> ë©”íƒ€ì¸ì§€
                        <button onclick="showReportTabMajor('psychology')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                            <span>ìì„¸íˆ ë³´ê¸°</span>
                            <i class="fas fa-chevron-right text-[10px]"></i>
                        </button>
                    </h4>

                    \${(() => {
                        const metaSummarySections = [
                            metaCognition.myArsenal?.strengths?.length > 0 ? 'strengths' : null,
                            profileInterpretation?.values?.length > 0 ? 'values' : null,
                            metaCognition.stressRecovery?.stressFactors?.length > 0 ? 'stress' : null,
                        ].filter(Boolean);
                        const metaSummaryCount = metaSummarySections.length;
                        const metaSummaryGridClass = metaSummaryCount <= 1 ? 'grid grid-cols-1 gap-4' : metaSummaryCount === 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 md:grid-cols-3 gap-4';
                        return '<div class="' + metaSummaryGridClass + '">';
                    })()}
                        <!-- í•µì‹¬ ê°•ì  -->
                        \${metaCognition.myArsenal?.strengths?.length > 0 ? \`
                            <div class="p-4 rounded-xl" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg">ğŸ’ª</span>
                                    <h5 class="font-bold text-green-400 text-[15px]">í•µì‹¬ ê°•ì </h5>
                                </div>
                                <div class="flex flex-wrap gap-1.5">
                                    \${metaCognition.myArsenal.strengths.slice(0, 3).map(s => \`
                                        <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">\${translateToKorean(s.trait)}</span>
                                    \`).join('')}
                                </div>
                            </div>
                        \` : ''}

                        <!-- í•µì‹¬ ê°€ì¹˜ -->
                        \${profileInterpretation?.values?.length > 0 ? \`
                            <div class="p-4 rounded-xl" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg">â­</span>
                                    <h5 class="font-bold text-purple-400 text-[15px]">í•µì‹¬ ê°€ì¹˜</h5>
                                </div>
                                <div class="flex flex-wrap gap-1.5">
                                    \${profileInterpretation.values.slice(0, 3).map(v => \`
                                        <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(168,85,247,0.15); color: rgb(216,180,254);">\${translateToKorean(v.label)}</span>
                                    \`).join('')}
                                </div>
                            </div>
                        \` : ''}

                        <!-- ìŠ¤íŠ¸ë ˆìŠ¤ ì£¼ì˜ì  -->
                        \${metaCognition.stressRecovery?.stressFactors?.length > 0 ? \`
                            <div class="p-4 rounded-xl" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg">âš ï¸</span>
                                    <h5 class="font-bold text-red-400 text-[15px]">ì£¼ì˜ì </h5>
                                    <span class="relative group cursor-help">
                                        <i class="fas fa-question-circle text-wiki-muted text-xs"></i>
                                        <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 rounded-lg text-xs text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50" style="background: rgba(30,30,40,0.95); border: 1px solid rgba(255,255,255,0.1);">ì´ í•­ëª©ë“¤ì€ ì—ë„ˆì§€ê°€ ì†Œëª¨ë˜ê±°ë‚˜ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ìš”ì¸ì…ë‹ˆë‹¤.<br/>ì „ê³µ ì„ íƒ ì‹œ ì´ ìš”ì¸ë“¤ì„ ê³ ë ¤í•˜ë©´ ë²ˆì•„ì›ƒì„ ì˜ˆë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                    </span>
                                </div>
                                <div class="flex flex-wrap gap-1.5">
                                    \${metaCognition.stressRecovery.stressFactors.slice(0, 2).map(s => \`
                                        <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">\${translateToKorean(s.factor)}</span>
                                    \`).join('')}
                                </div>
                            </div>
                        \` : ''}
                    </div>
                </div>
            \` : ''}

            <!-- ë‚˜ì˜ ì „ê³µ í”„ë¡œí•„ (í”„ë¡œí•„ í•´ì„) -->
            \${profileInterpretation ? \`
                <div class="mt-8 mb-8">
                    <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                        <span>ğŸ§¬</span> ë‚˜ì˜ ì „ê³µ í”„ë¡œí•„
                    </h4>

                    \${(() => {
                        const profileSections = [
                            profileInterpretation.interests?.length > 0 ? 'interests' : null,
                            profileInterpretation.strengths?.length > 0 ? 'strengths' : null,
                            profileInterpretation.values?.length > 0 ? 'values' : null,
                            profileInterpretation.constraints?.length > 0 ? 'constraints' : null
                        ].filter(Boolean);
                        const profileCount = profileSections.length;
                        const profileGridClass = profileCount <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';
                        const profileIsOdd = profileCount > 1 && profileCount % 2 === 1;
                        const profileLastSection = profileSections[profileCount - 1];
                        const interestsSpan = profileIsOdd && profileLastSection === 'interests' ? 'md:col-span-2' : '';
                        const strengthsSpan = profileIsOdd && profileLastSection === 'strengths' ? 'md:col-span-2' : '';
                        const valuesSpan = profileIsOdd && profileLastSection === 'values' ? 'md:col-span-2' : '';
                        const constraintsSpan = profileIsOdd && profileLastSection === 'constraints' ? 'md:col-span-2' : '';
                        return '<div class="' + profileGridClass + '">' +

                        (profileInterpretation.interests?.length > 0 ? '<div class="p-4 rounded-xl ' + interestsSpan + '" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ’š</span><h5 class="font-bold text-green-400 text-[15px]">ì¢‹ì•„í•˜ëŠ” ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.interests_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.interests.map(item => '<div class="pl-3 border-l-2 border-green-500/30"><div class="font-medium text-green-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì— ëŒ€í•œ ê´€ì‹¬ì´ ë†’ìŠµë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                        (profileInterpretation.strengths?.length > 0 ? '<div class="p-4 rounded-xl ' + strengthsSpan + '" style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ’ª</span><h5 class="font-bold text-blue-400 text-[15px]">ì˜í•˜ëŠ” ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.strengths_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.strengths.map(item => '<div class="pl-3 border-l-2 border-blue-500/30"><div class="font-medium text-blue-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì´(ê°€) ê°•ì ì…ë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                        (profileInterpretation.values?.length > 0 ? '<div class="p-4 rounded-xl ' + valuesSpan + '" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">â­</span><h5 class="font-bold text-purple-400 text-[15px]">ì¤‘ìš”í•œ ê°€ì¹˜</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.values_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.values.map(item => '<div class="pl-3 border-l-2 border-purple-500/30"><div class="font-medium text-purple-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning || item.label + 'ì„(ë¥¼) ì¤‘ìš”í•˜ê²Œ ì—¬ê¹ë‹ˆë‹¤.') + '</div></div>').join('') + '</div></div>' : '') +

                        (profileInterpretation.constraints?.length > 0 ? '<div class="p-4 rounded-xl ' + constraintsSpan + '" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸš«</span><h5 class="font-bold text-red-400 text-[15px]">í”¼í•˜ê³  ì‹¶ì€ ê²ƒ</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.constraints_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.constraints.map(item => '<div class="pl-3 border-l-2 border-red-500/30"><div class="font-medium text-red-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div></div>' : '') +

                        '</div>';
                    })()}
                </div>
            \` : ''}

            <!-- í•™ìŠµ ìŠ¤íƒ€ì¼ íŒíŠ¸ -->
            \${learningStyleMap && (learningStyleMap.theoretical_vs_practical !== undefined || learningStyleMap.solo_vs_collaborative !== undefined) ? \`
                <div class="mt-6 flex flex-wrap gap-2 justify-center">
                    \${[
                        learningStyleMap.theoretical_vs_practical < 0 ? 'ğŸ“– ì´ë¡  ì¤‘ì‹¬' : learningStyleMap.theoretical_vs_practical > 0 ? 'ğŸ”§ ì‹¤ìŠµ ì¤‘ì‹¬' : null,
                        learningStyleMap.solo_vs_collaborative < 0 ? 'ğŸ§˜ ë…ë¦½ í•™ìŠµ ì„ í˜¸' : learningStyleMap.solo_vs_collaborative > 0 ? 'ğŸ¤ í˜‘ì—… í•™ìŠµ ì„ í˜¸' : null,
                        learningStyleMap.structured_vs_exploratory < 0 ? 'ğŸ“‹ ì²´ê³„ì  í•™ìŠµ' : learningStyleMap.structured_vs_exploratory > 0 ? 'ğŸ” íƒêµ¬ì  í•™ìŠµ' : null,
                        learningStyleMap.guided_vs_autonomous > 0 ? 'ğŸš€ ìê¸°ì£¼ë„ í•™ìŠµ' : null,
                    ].filter(Boolean).map(hint => \`
                        <span class="px-3 py-1.5 rounded-full text-[13px] font-medium" style="background: rgba(99,102,241,0.1); color: rgb(165,180,252); border: 1px solid rgba(99,102,241,0.2);">\${hint}</span>
                    \`).join('')}
                </div>
            \` : ''}

            <!-- í”„ë¡œí•„ â†’ ì¶”ì²œ ë¸Œë¦¿ì§€ ë¬¸ì¥ -->
            \${profileInterpretation && overallTop5.length > 0 ? \`
                <div class="mt-4 mb-2 p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05)); border: 1px solid rgba(251,191,36,0.2);">
                    <p class="text-base md:text-lg" style="color: rgb(253,224,71);">
                        <span class="font-medium">ğŸ¯ ì´ëŸ° ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì „ê³µ</span>
                    </p>
                    <p class="text-[15px] text-wiki-muted mt-2">
                        \${(() => {
                            const parts = [];
                            const pi = profileInterpretation;
                            if (pi.interests?.length > 0) {
                                parts.push('<span class="text-green-400">"' + translateToKorean(pi.interests[0].label) + '"</span>ì„ ì¢‹ì•„í•˜ê³ ');
                            }
                            if (pi.strengths?.length > 0) {
                                parts.push('<span class="text-blue-400">"' + translateToKorean(pi.strengths[0].label) + '"</span>ì´ ê°•ì ì¸ ë‹¹ì‹ ');
                            }
                            if (pi.constraints?.length > 0) {
                                parts.push('<span class="text-red-400">"' + translateToKorean(pi.constraints[0].label) + '"</span> ì—†ì´ ì„±ì¥í•  ìˆ˜ ìˆëŠ” ì „ê³µì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
                            } else if (parts.length > 0) {
                                parts.push('ì—ê²Œ ë§ëŠ” ì „ê³µì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
                            }
                            return parts.length > 0 ? parts.join(' ') : 'ë‹¹ì‹ ì˜ í”„ë¡œí•„ì„ ë°”íƒ•ìœ¼ë¡œ ì „ê³µì„ ì¶”ì²œí•©ë‹ˆë‹¤.';
                        })()}
                    </p>
                </div>
            \` : ''}

            <!-- TOP 3 ì „ê³µ ì¹´ë“œ (ìš”ì•½ íƒ­) -->
            \${overallTop5.length > 0 ? \`
                <div class="mt-6 pt-4 border-t border-wiki-border/30">
                    <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                        <span>ğŸ†</span> ì¶”ì²œ ì „ê³µ Top 3
                        <button onclick="showReportTabMajor('recommendations')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                            <span>ë”ë³´ê¸°</span>
                            <i class="fas fa-chevron-right text-[10px]"></i>
                        </button>
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        \${overallTop5.slice(0, 3).map((major, idx) => {
                            const majorName = major.major_name || major.major_id || 'ì „ê³µ';
                            const majorSlug = major.slug || encodeURIComponent(majorName);
                            const rationale = major.rationale || major.one_line_why || '';
                            const imageUrl = major.image_url || '';
                            const description = (major.major_description || major.description || major.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                            const displayDescription = description || '';
                            const fitScore = major.scores?.fit || major.fit_score || '-';
                            const likeReason = major.like_reason || '';
                            const canReason = major.can_reason || '';
                            const hasReasons = likeReason || canReason;

                            return \`
                                <a href="/major/\${majorSlug}" target="_blank" rel="noopener noreferrer" class="block p-4 rounded-xl transition-all hover:scale-[1.02] group"
                                   style="background: linear-gradient(135deg, rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.15), rgba(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'},0.05)); border: 1px solid rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.3);">
                                        <div class="mb-3 overflow-hidden rounded-lg" style="aspect-ratio: 16/10;">
                                            \${imageUrl ? \`
                                                <img src="\${imageUrl}" alt="\${majorName}"
                                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                <div class="hidden w-full h-full items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                    <i class="fas fa-graduation-cap text-3xl text-wiki-muted"></i>
                                                </div>
                                            \` : \`
                                                <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                    <i class="fas fa-graduation-cap text-3xl text-wiki-muted"></i>
                                                </div>
                                            \`}
                                        </div>
                                        <div class="flex items-center gap-3 mb-3">
                                            <span class="text-2xl">\${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                                            <span class="font-bold text-lg text-white flex-1 line-clamp-1">\${majorName}</span>
                                            <span class="text-base font-bold" style="color: rgb(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'});">Fit \${fitScore}</span>
                                        </div>
                                        \${major.field_category ? \`<div class="text-xs text-wiki-muted mb-2">\${{engineering:'ê³µí•™',natural_science:'ìì—°ê³¼í•™',social_science:'ì‚¬íšŒê³¼í•™',humanities:'ì¸ë¬¸í•™',arts:'ì˜ˆìˆ /ì²´ìœ¡',medical:'ì˜ì•½/ë³´ê±´',education:'êµìœ¡',business:'ê²½ì˜/ê²½ì œ',law:'ë²•í•™',agriculture:'ë†ë¦¼/ìˆ˜ì‚°',general:'ê¸°íƒ€'}[major.field_category] || major.field_category}</div>\` : ''}
                                        \${displayDescription ? \`<p class="text-base text-wiki-muted line-clamp-3 mb-3">\${displayDescription}</p>\` : ''}
                                        \${hasReasons ? \`
                                            <div class="space-y-1.5 mt-3 p-3 rounded-lg" style="background: rgba(0,0,0,0.2);">
                                                \${likeReason ? \`<p class="text-[13px] leading-relaxed text-purple-300/90"><span class="text-purple-400 font-medium">ğŸ’œ Like:</span> \${likeReason}</p>\` : ''}
                                                \${canReason ? \`<p class="text-[13px] leading-relaxed text-blue-300/90"><span class="text-blue-400 font-medium">ğŸ’ª Can:</span> \${canReason}</p>\` : ''}
                                            </div>
                                        \` : (rationale && !rationale.includes('ìë™ ìƒì„±ëœ ê²°ê³¼') ? \`
                                            <p class="text-[13px] text-emerald-400/80 mt-3">ğŸ’¡ \${rationale}</p>
                                        \` : '')}
                                </a>
                            \`;
                        }).join('')}
                    </div>
                </div>
            \` : ''}

        </div>

        <!-- TAB_PSYCHOLOGY_PLACEHOLDER -->

    \`;

    // --- Phase 2: Psychology tab will be appended ---
    // We build the rest via string concatenation to avoid template literal nesting issues

    // Build psychology tab HTML
    var psychologyHtml = buildPsychologyTabMajor(personal, metaCognition, profileInterpretation, learningStyleMap, innerConflict, growthCurve, academicTimeline, studyGuidance, stressProfile);

    // Build recommendations tab HTML
    var recommendationsHtml = buildRecommendationsTabMajor(profileInterpretation, overallTop5, fitTop10, likeTop10);

    // Build details tab HTML
    var detailsHtml = buildDetailsTabMajor(result, report);

    // Build bottom buttons HTML
    var bottomHtml = buildBottomButtonsMajor();

    // Replace placeholder and append remaining tabs
    var currentHtml = container.innerHTML;
    currentHtml = currentHtml.replace('<!-- TAB_PSYCHOLOGY_PLACEHOLDER -->', psychologyHtml + recommendationsHtml + detailsHtml + bottomHtml);
    container.innerHTML = currentHtml;

    // ìŠ¤íƒ€ì¼ ì¶”ê°€
    addReportStylesMajor();

    // ì „ì—­ ë°ì´í„° ì €ì¥
    window.currentReportData = {
        report,
        overallTop5,
        fitTop10,
        likeTop10,
        profileInterpretation,
    };
}

// ============================================
// Psychology Tab Builder
// ============================================
function buildPsychologyTabMajor(personal, metaCognition, profileInterpretation, learningStyleMap, innerConflict, growthCurve, academicTimeline, studyGuidance, stressProfile) {
    var html = '';

    html += '<div id="tab-psychology" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">';
    html += '<div class="mb-8 pb-6">';
    html += '<h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">';
    html += '<span class="text-3xl">ğŸ“Š</span>';
    html += '<span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ë©”íƒ€ì¸ì§€</span>';
    html += '</h2>';
    html += '<p class="text-center text-wiki-muted text-sm mt-2">ìê¸° ìì‹ ì— ëŒ€í•œ ê¹Šì€ ì´í•´ì™€ ë‚´ë©´ íƒêµ¬.</p>';
    html += '<div class="mt-6 h-px bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>';
    html += '</div>';

    // í•µì‹¬ ìš”ì•½
    if (personal.personality_summary || metaCognition?.innerExploration?.identityInsight) {
        html += '<div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);">';
        html += '<h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">ğŸ’« í•µì‹¬ ìš”ì•½</h4>';
        html += '<p class="text-base md:text-lg leading-relaxed text-white mb-4">';
        var rawText = metaCognition?.innerExploration?.identityInsight || personal.personality_summary || '';
        var styled = rawText.replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">$1</strong>');
        if (profileInterpretation) {
            var pi = profileInterpretation;
            (pi.interests || []).forEach(function(i) {
                var label = translateToKorean(i.label);
                styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-green-400">' + label + '</strong>');
            });
            (pi.strengths || []).forEach(function(s) {
                var label = translateToKorean(s.label);
                styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-blue-400">' + label + '</strong>');
            });
            (pi.values || []).forEach(function(v) {
                var label = translateToKorean(v.label);
                styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-purple-400">' + label + '</strong>');
            });
        }
        html += styled;
        html += '</p>';

        if (metaCognition?.innerExploration?.innerConflicts) {
            html += '<div class="p-4 rounded-xl mb-4" style="background-color: rgba(236,72,153,0.08); border-left: 3px solid rgba(236,72,153,0.5);">';
            html += '<div class="text-[15px] font-medium text-pink-300 mb-2">ğŸ­ ì•Œì•„ë‘ë©´ ì¢‹ì€ ë‚´ì  ê°ˆë“±</div>';
            html += '<p class="text-[15px] text-wiki-muted leading-relaxed">' + translateToKorean(metaCognition.innerExploration.innerConflicts) + '</p>';
            html += '</div>';
        }
        if (metaCognition?.innerExploration?.valueAnalysis) {
            html += '<details class="group">';
            html += '<summary class="cursor-pointer text-[15px] text-violet-400 font-medium hover:text-violet-300 flex items-center gap-2">';
            html += '<span>ğŸ“–</span><span class="group-open:hidden">â–¶ ì¶”ê°€ ì„¤ëª…</span><span class="hidden group-open:inline">â–¼ ì¶”ê°€ ì„¤ëª…</span>';
            html += '</summary>';
            html += '<div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(139,92,246,0.05);">' + translateToKorean(metaCognition.innerExploration.valueAnalysis) + '</div>';
            html += '</details>';
        }
        html += '</div>';
    } else {
        html += '<div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.2);">';
        html += '<h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">ğŸ’« í•µì‹¬ ìš”ì•½</h4>';
        html += '<p class="text-base md:text-lg leading-relaxed text-wiki-muted">ì‹¬ì¸µ ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì‹¬ì¸µ ì§ˆë¬¸ì— ìì„¸íˆ ë‹µë³€í•´ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
        html += '</div>';
    }

    // ë©”íƒ€ì¸ì§€ 5ê°œ ì„¹ì…˜
    if (metaCognition) {
        html += buildMetaCognitionSectionsMajor(metaCognition, profileInterpretation);
    }

    // ì‘ì—… ìŠ¤íƒ€ì¼ ì¸ì‚¬ì´íŠ¸
    if (personal.work_style_insights?.length > 0) {
        html += '<div class="mb-8">';
        html += '<h4 class="text-xl font-bold mb-4 flex items-center gap-2"><span>ğŸ¨</span> í•™ìŠµ ìŠ¤íƒ€ì¼</h4>';
        html += '<div class="grid gap-3">';
        personal.work_style_insights.forEach(function(ws) {
            var text = translateToKorean(ws).trim();
            if (!text.endsWith('.') && !text.endsWith('ë‹¤.') && !text.endsWith('ìš”.') && !text.endsWith('ë‹ˆë‹¤.')) text += '.';
            text = text.replace(/(ì„±ì¥|ë„ì „|í•™ìŠµ|ëª°ì…|ì„±ì·¨ê°|ììœ¨|ì°½ì˜ì„±|ë¶„ì„|ë¬¸ì œ|í•´ê²°|ë…ë¦½|í˜‘ì—…|ë¦¬ë”ì‹­|ê¼¼ê¼¼|ìœ ì—°|ì•ˆì •|ì „ë¬¸ì„±|ì²´ê³„)/g, '<strong class="text-indigo-400">$1</strong>');
            html += '<div class="p-4 rounded-xl bg-wiki-bg/50 flex items-start gap-4" style="border: 1px solid rgba(99,102,241,0.1);"><span class="text-wiki-primary text-lg mt-0.5">âœ“</span><span class="text-[15px] leading-relaxed text-wiki-text">' + text + '</span></div>';
        });
        html += '</div></div>';
    }

    // ê°€ì¹˜ ìš°ì„ ìˆœìœ„
    if (personal.value_priorities?.length > 0) {
        html += '<div class="mb-8">';
        html += '<h4 class="text-xl font-bold mb-4 flex items-center gap-2"><span>â­</span> ê°€ì¹˜ ìš°ì„ ìˆœìœ„</h4>';
        var gridCols = Math.min(personal.value_priorities.length, 3);
        html += '<div class="grid grid-cols-' + gridCols + ' gap-3">';
        var colors = ['rgba(168,85,247,0.2)', 'rgba(99,102,241,0.2)', 'rgba(59,130,246,0.2)', 'rgba(6,182,212,0.2)', 'rgba(16,185,129,0.2)'];
        var textColors = ['rgb(216,180,254)', 'rgb(165,180,252)', 'rgb(147,197,253)', 'rgb(103,232,249)', 'rgb(110,231,183)'];
        personal.value_priorities.slice(0, 5).forEach(function(v, i) {
            var text = translateToKorean(v).trim();
            if (text.length < 10) text = text.replace(/\\.$/, '');
            else if (!text.endsWith('.')) text += '.';
            html += '<div class="p-3 md:p-4 rounded-xl flex items-center gap-2 justify-center" style="background-color: ' + colors[i % colors.length] + '; border: 1px solid ' + colors[i % colors.length].replace('0.2', '0.3') + ';"><span class="text-sm font-bold" style="color: ' + textColors[i % textColors.length] + ';">#' + (i + 1) + '</span><span class="text-[15px] font-semibold text-wiki-text">' + text + '</span></div>';
        });
        html += '</div></div>';
    }

    // ì ì¬ì  ë„ì „
    if (personal.potential_challenges?.length > 0) {
        html += '<div class="mb-8 p-5 rounded-xl" style="background-color: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.2);">';
        html += '<h4 class="text-xl font-bold mb-4 text-orange-400 flex items-center gap-2"><span>âš ï¸</span> ì£¼ì˜í•  ì </h4>';
        html += '<ul class="space-y-3">';
        personal.potential_challenges.forEach(function(c) {
            html += '<li class="flex items-center gap-3"><span class="text-orange-400">â€¢</span><span class="text-[15px] leading-relaxed text-wiki-text">' + c + '</span></li>';
        });
        html += '</ul></div>';
    }

    // ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ
    if (personal.blind_spots_to_check?.length > 0) {
        html += '<div class="mb-8 p-5 rounded-xl" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);">';
        html += '<h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2"><span>ğŸ”</span> ì ê²€í•  ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ</h4>';
        html += '<ul class="space-y-3">';
        personal.blind_spots_to_check.forEach(function(b) {
            html += '<li class="flex items-center gap-3"><span class="text-red-400">â€¢</span><span class="text-[15px] leading-relaxed text-wiki-text">' + b + '</span></li>';
        });
        html += '</ul></div>';
    }

    // í•™ìŠµ ìŠ¤íƒ€ì¼ 5ì¶• ì‹œê°í™”
    if (learningStyleMap && (learningStyleMap.theoretical_vs_practical !== 0 || learningStyleMap.solo_vs_collaborative !== 0)) {
        html += '<div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(6,182,212,0.2);">';
        html += '<h4 class="text-xl font-bold mb-2 text-cyan-400 flex items-center gap-2"><span>ğŸ“Š</span> í•™ìŠµ ìŠ¤íƒ€ì¼ 5ì¶• ë¶„ì„</h4>';
        html += '<p class="text-sm text-wiki-muted mb-5">ê° ì¶•ì˜ ì¤‘ì•™ì€ ê· í˜• ìƒíƒœì´ë©°, ì¢Œìš°ë¡œ ì¹˜ìš°ì¹ ìˆ˜ë¡ í•´ë‹¹ ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤.</p>';
        html += '<div class="space-y-5">';

        var axes = [
            { left: 'ì´ë¡ í˜•', right: 'ì‹¤ìŠµí˜•', value: learningStyleMap.theoretical_vs_practical, color: 'cyan', leftDesc: 'ì´ë¡ ê³¼ ê°œë… ì´í•´ë¥¼ í†µí•œ í•™ìŠµì„ ì„ í˜¸í•©ë‹ˆë‹¤', rightDesc: 'ì‹¤í—˜ê³¼ ì‹¤ìŠµ ì¤‘ì‹¬ì˜ ì²´í—˜ì  í•™ìŠµì„ ì„ í˜¸í•©ë‹ˆë‹¤', balanceDesc: 'ì´ë¡ ê³¼ ì‹¤ìŠµì„ ê· í˜• ìˆê²Œ í™œìš©í•©ë‹ˆë‹¤' },
            { left: 'ë…ë¦½í•™ìŠµ', right: 'í˜‘ì—…í•™ìŠµ', value: learningStyleMap.solo_vs_collaborative, color: 'blue', leftDesc: 'í˜¼ì ê¹Šì´ íŒŒê³ ë“œëŠ” í•™ìŠµì—ì„œ ì—ë„ˆì§€ë¥¼ ì–»ìŠµë‹ˆë‹¤', rightDesc: 'ë™ë£Œë“¤ê³¼ í•¨ê»˜ í† ë¡ í•˜ê³  í˜‘ë ¥í•  ë•Œ ì‹œë„ˆì§€ë¥¼ ëƒ…ë‹ˆë‹¤', balanceDesc: 'ìƒí™©ì— ë”°ë¼ ë…ë¦½ í•™ìŠµê³¼ í˜‘ì—…ì„ ìœ ì—°í•˜ê²Œ ì „í™˜í•©ë‹ˆë‹¤' },
            { left: 'ì²´ê³„ì ', right: 'íƒêµ¬ì ', value: learningStyleMap.structured_vs_exploratory, color: 'violet', leftDesc: 'ëª…í™•í•œ ì»¤ë¦¬í˜ëŸ¼ê³¼ ê³„íš ì•ˆì—ì„œ ì•ˆì •ê°ì„ ëŠë‚ë‹ˆë‹¤', rightDesc: 'ììœ ë¡œìš´ íƒêµ¬ì™€ ë°œê²¬ ì¤‘ì‹¬ì˜ í•™ìŠµì„ ì„ í˜¸í•©ë‹ˆë‹¤', balanceDesc: 'ì²´ê³„ì™€ íƒêµ¬ë¥¼ ìƒí™©ì— ë§ê²Œ ì¡°í•©í•©ë‹ˆë‹¤' },
            { left: 'ì‹¬í™”í˜•', right: 'ìœµí•©í˜•', value: learningStyleMap.depth_vs_breadth, color: 'amber', leftDesc: 'í•œ ë¶„ì•¼ë¥¼ ê¹Šì´ íŒŒê³ ë“¤ì–´ ì „ë¬¸ì„±ì„ í‚¤ìš°ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤', rightDesc: 'ë‹¤ì–‘í•œ ë¶„ì•¼ë¥¼ ìœµí•©í•˜ë©° í•™ì œê°„ ì—°ê²°ì„ ì¦ê¹ë‹ˆë‹¤', balanceDesc: 'ê¹Šì´ì™€ ë„“ì´ë¥¼ ê· í˜• ìˆê²Œ ì¶”êµ¬í•©ë‹ˆë‹¤' },
            { left: 'êµìˆ˜ì£¼ë„', right: 'ìê¸°ì£¼ë„', value: learningStyleMap.guided_vs_autonomous, color: 'emerald', leftDesc: 'êµìˆ˜ì˜ ì²´ê³„ì  ê°€ë¥´ì¹¨ê³¼ í”¼ë“œë°±ì´ ìˆì„ ë•Œ ì„±ì¥ì´ ë¹ ë¦…ë‹ˆë‹¤', rightDesc: 'ìŠ¤ìŠ¤ë¡œ í•™ìŠµ ë°©í–¥ì„ ì„¤ì •í•˜ê³  ì£¼ë„ì ìœ¼ë¡œ ê³µë¶€í•©ë‹ˆë‹¤', balanceDesc: 'ì ì ˆí•œ ê°€ì´ë“œì™€ ììœ¨ì„±ì˜ ê· í˜•ì„ ì¶”êµ¬í•©ë‹ˆë‹¤' },
        ];

        axes.forEach(function(axis) {
            var val = axis.value || 0;
            html += '<div>';
            html += '<div class="flex items-center gap-4">';
            html += '<span class="text-sm w-24 text-right ' + (val < 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted') + '">' + axis.left + '</span>';
            html += '<div class="flex-1 h-3 bg-wiki-border/20 rounded-full relative overflow-hidden">';
            html += '<div class="absolute top-0 left-1/2 w-px h-full bg-wiki-muted/40 z-10"></div>';
            if (val === 0) {
                html += '<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gray-400 rounded-full border-2 border-wiki-bg z-20"></div>';
            } else {
                var barStyle = val >= 0
                    ? 'left: 50%; width: ' + Math.max(val / 2, 3) + '%;'
                    : 'right: 50%; width: ' + Math.max(Math.abs(val) / 2, 3) + '%;';
                html += '<div class="absolute top-0 h-full bg-' + axis.color + '-400/80 rounded-full transition-all" style="' + barStyle + '"></div>';
            }
            html += '</div>';
            html += '<span class="text-sm w-24 ' + (val > 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted') + '">' + axis.right + '</span>';
            html += '</div>';
            html += '<p class="text-xs text-wiki-muted mt-1 text-center">' + (Math.abs(val) >= 15 ? (val < 0 ? axis.leftDesc : axis.rightDesc) : axis.balanceDesc) + '</p>';
            html += '</div>';
        });

        html += '</div></div>';
    }

    // ë‚´ë©´ ê°ˆë“± + ì„±ì¥ ê³¡ì„ 
    if ((innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) || growthCurve.type) {
        var bothExist = (innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) && growthCurve.type;
        html += '<div class="grid grid-cols-1 ' + (bothExist ? 'md:grid-cols-2' : '') + ' gap-6 mb-8">';
        if (innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) {
            html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(168,85,247,0.2);">';
            html += '<h4 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2"><span>ğŸ’­</span> ë‚´ë©´ ê°ˆë“± ë¶„ì„</h4>';
            if (innerConflict.patterns?.length > 0) {
                html += '<p class="text-lg font-bold mb-3" style="color: rgb(216,180,254);">' + innerConflict.patterns[0] + '</p>';
            }
            html += '<p class="text-[15px] leading-relaxed text-wiki-text mb-4">' + innerConflict.analysis + '</p>';
            if (innerConflict.patterns?.length > 1) {
                html += '<div class="mt-4 pt-4 border-t border-purple-400/20"><span class="text-sm text-purple-300 font-semibold">ê¸°íƒ€ ê°ˆë“± íŒ¨í„´:</span><ul class="mt-3 space-y-2">';
                innerConflict.patterns.slice(1).forEach(function(p) {
                    html += '<li class="flex items-center gap-3"><span class="text-purple-400">â€¢</span><span class="text-[15px] leading-relaxed text-wiki-muted">' + p + '</span></li>';
                });
                html += '</ul></div>';
            }
            html += '</div>';
        }
        if (growthCurve.type) {
            html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(52,211,153,0.1)); border: 1px solid rgba(16,185,129,0.2);">';
            html += '<h4 class="text-xl font-bold mb-4 text-emerald-400 flex items-center gap-2"><span>ğŸ“ˆ</span> ì„±ì¥ ê³¡ì„  ìœ í˜•</h4>';
            html += '<p class="text-lg font-bold mb-3" style="color: rgb(52,211,153);">' + translateToKorean(growthCurve.type) + '</p>';
            if (growthCurve.description) {
                html += '<p class="text-[15px] leading-relaxed text-wiki-text">' + growthCurve.description + '</p>';
            }
            html += '</div>';
        }
        html += '</div>';
    }

    // í•™ê¸°ë³„ ë¡œë“œë§µ
    if (academicTimeline.semester1?.goal || academicTimeline.semester2?.goal || academicTimeline.semester3_4?.goal || academicTimeline.beyond?.goal) {
        html += '<div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.2);">';
        html += '<h4 class="text-xl font-bold mb-2 text-blue-400 flex items-center gap-2"><span>ğŸ“…</span> í•™ê¸°ë³„ ë¡œë“œë§µ</h4>';
        html += '<p class="text-sm text-wiki-muted mb-5">í•™ê¸°ë³„ ëª©í‘œì™€ ì‹¤í–‰ ê³„íšì„ í†µí•´ ì²´ê³„ì ìœ¼ë¡œ í•™ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.</p>';
        html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';

        var semesters = [
            { key: 'semester1', data: academicTimeline.semester1, label: '1í•™ê¸°', num: '1', color: 'blue', colorText: 'text-blue-300', colorBg: 'rgba(59,130,246,' },
            { key: 'semester2', data: academicTimeline.semester2, label: '2í•™ê¸°', num: '2', color: 'indigo', colorText: 'text-indigo-300', colorBg: 'rgba(99,102,241,' },
            { key: 'semester3_4', data: academicTimeline.semester3_4, label: '3-4í•™ê¸°', num: '3+', color: 'violet', colorText: 'text-violet-300', colorBg: 'rgba(139,92,246,' },
            { key: 'beyond', data: academicTimeline.beyond, label: 'ì¡¸ì—… ì´í›„', num: 'âˆ', color: 'purple', colorText: 'text-purple-300', colorBg: 'rgba(168,85,247,' },
        ];

        semesters.forEach(function(sem) {
            if (sem.data?.goal) {
                html += '<div class="p-4 rounded-xl" style="background-color: ' + sem.colorBg + '0.1); border: 1px solid ' + sem.colorBg + '0.15);">';
                html += '<div class="text-sm font-bold ' + sem.colorText + ' mb-3 flex items-center gap-2">';
                html += '<span class="w-8 h-8 rounded-full bg-' + sem.color + '-500/20 flex items-center justify-center text-' + sem.color + '-400 font-bold">' + sem.num + '</span>';
                html += sem.label;
                html += '</div>';
                html += '<div class="text-base font-semibold text-white mb-3">' + sem.data.goal + '</div>';
                if (sem.data.actions?.length > 0) {
                    html += '<ul class="text-sm text-wiki-muted space-y-2 mb-3">';
                    sem.data.actions.slice(0, 2).forEach(function(a) {
                        html += '<li class="flex items-center gap-2"><span class="text-' + sem.color + '-400">â€¢</span> ' + a + '</li>';
                    });
                    html += '</ul>';
                }
                if (sem.data.milestone) {
                    html += '<div class="text-sm text-' + sem.color + '-400 font-medium">âœ“ ' + sem.data.milestone + '</div>';
                }
                html += '</div>';
            }
        });

        html += '</div></div>';
    }

    // í•™ìŠµ ê°€ì´ë“œ
    if (studyGuidance.doNow?.length > 0 || studyGuidance.stopDoing?.length > 0 || studyGuidance.experiment?.length > 0 || studyGuidance.studyTips?.length > 0) {
        html += '<div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.2);">';
        html += '<h4 class="text-xl font-bold mb-2 text-green-400 flex items-center gap-2"><span>ğŸ§­</span> í•™ìŠµ ê°€ì´ë“œ</h4>';
        html += '<p class="text-[15px] text-wiki-muted mb-5">ì§€ê¸ˆ ë‹¹ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì¡°ì–¸ì…ë‹ˆë‹¤.</p>';

        var activeSections = [];
        if (studyGuidance.doNow?.length > 0) activeSections.push('doNow');
        if (studyGuidance.stopDoing?.length > 0) activeSections.push('stopDoing');
        if (studyGuidance.experiment?.length > 0) activeSections.push('experiment');
        if (studyGuidance.studyTips?.length > 0) activeSections.push('studyTips');
        var count = activeSections.length;
        var lastSection = activeSections[count - 1];
        var isOdd = count % 2 === 1;
        var gridClass = count <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';

        var doNowSpan = isOdd && lastSection === 'doNow' ? 'md:col-span-2' : '';
        var stopSpan = isOdd && lastSection === 'stopDoing' ? 'md:col-span-2' : '';
        var experimentSpan = isOdd && lastSection === 'experiment' ? 'md:col-span-2' : '';
        var tipsSpan = isOdd && lastSection === 'studyTips' ? 'md:col-span-2' : '';

        html += '<div class="' + gridClass + '">';

        if (studyGuidance.doNow?.length > 0) {
            html += '<div class="p-5 rounded-xl ' + doNowSpan + '" style="background-color: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.15);"><div class="text-base font-bold text-green-400 mb-3 flex items-center gap-2"><span class="text-xl">âœ…</span> ì§€ê¸ˆ ì‹œì‘í•  ê²ƒ</div><ul class="space-y-2">';
            studyGuidance.doNow.slice(0, 3).forEach(function(d) {
                html += '<li class="flex items-center gap-3"><span class="text-green-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(d) + '</span></li>';
            });
            html += '</ul></div>';
        }
        if (studyGuidance.stopDoing?.length > 0) {
            html += '<div class="p-5 rounded-xl ' + stopSpan + '" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.15);"><div class="text-base font-bold text-red-400 mb-3 flex items-center gap-2"><span class="text-xl">ğŸš«</span> ê·¸ë§Œí•´ì•¼ í•  ê²ƒ</div><ul class="space-y-2">';
            studyGuidance.stopDoing.slice(0, 3).forEach(function(s) {
                html += '<li class="flex items-center gap-3"><span class="text-red-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(s) + '</span></li>';
            });
            html += '</ul></div>';
        }
        if (studyGuidance.experiment?.length > 0) {
            html += '<div class="p-5 rounded-xl ' + experimentSpan + '" style="background-color: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.15);"><div class="text-base font-bold text-amber-400 mb-3 flex items-center gap-2"><span class="text-xl">ğŸ§ª</span> ì‹œë„í•´ë³¼ ê²ƒ</div><ul class="space-y-2">';
            studyGuidance.experiment.slice(0, 3).forEach(function(e) {
                html += '<li class="flex items-center gap-3"><span class="text-amber-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(e) + '</span></li>';
            });
            html += '</ul></div>';
        }
        if (studyGuidance.studyTips?.length > 0) {
            html += '<div class="p-5 rounded-xl ' + tipsSpan + '" style="background-color: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15);"><div class="text-base font-bold text-blue-400 mb-3 flex items-center gap-2"><span class="text-xl">ğŸ“š</span> í•™ìŠµ íŒ</div><ul class="space-y-2">';
            studyGuidance.studyTips.slice(0, 3).forEach(function(t) {
                html += '<li class="flex items-center gap-3"><span class="text-blue-400">â€¢</span><span class="text-[15px] text-wiki-text">' + translateToKorean(t) + '</span></li>';
            });
            html += '</ul></div>';
        }

        html += '</div></div>';
    }

    // ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„ ìƒì„¸
    if (stressProfile.profile) {
        html += '<div class="p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,146,60,0.1)); border: 1px solid rgba(239,68,68,0.2);">';
        html += '<h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2"><span>ğŸ˜°</span> ìŠ¤íŠ¸ë ˆìŠ¤ í”„ë¡œí•„</h4>';
        html += '<p class="text-[15px] leading-relaxed text-wiki-text mb-4">' + stressProfile.profile + '</p>';
        if (stressProfile.triggers?.length > 0) {
            html += '<div class="mt-4 pt-4 border-t border-red-400/20"><span class="text-sm text-red-300 font-semibold">ì£¼ìš” íŠ¸ë¦¬ê±°:</span><div class="mt-3 flex flex-wrap gap-2">';
            stressProfile.triggers.forEach(function(t) {
                html += '<span class="px-3 py-1.5 rounded-lg text-sm font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">' + t + '</span>';
            });
            html += '</div></div>';
        }
        html += '</div>';
    }

    html += '</div>'; // close tab-psychology

    return html;
}

// ============================================
// MetaCognition Sections Builder (identical to job version)
// ============================================
function buildMetaCognitionSectionsMajor(metaCognition, profileInterpretation) {
    var html = '';

    // ê°•ì  + ì„ í˜¸ë„ (2ì—´ ê·¸ë¦¬ë“œ)
    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">';

    // 1. ë‚˜ì˜ ë¬´ê¸°ê³  (ê°•ì  + ì•½ì )
    html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(99,102,241,0.05)); border: 1px solid rgba(59,130,246,0.15);">';
    html += '<h4 class="text-lg font-bold mb-4 text-blue-400 flex items-center gap-2"><span>ğŸ’ª</span> ë‚˜ì˜ ê°•ì </h4>';

    if (metaCognition.myArsenal?.strengths?.length > 0) {
        html += '<div class="flex flex-wrap gap-2 mb-4">';
        metaCognition.myArsenal.strengths.forEach(function(s, i) {
            var icons = { 'ë¶„ì„ë ¥': 'ğŸ”', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ì†Œí†µë ¥': 'ğŸ’¬', 'ì²´ê³„ì  ì‹¤í–‰ë ¥': 'ğŸ“‹', 'ëˆê¸°': 'ğŸ’ª', 'ë¹ ë¥¸ í•™ìŠµ': 'âš¡', 'ë¦¬ë”ì‹­': 'ğŸ‘‘', 'ê³µê° ëŠ¥ë ¥': 'ğŸ¤', 'ê¼¼ê¼¼í•¨': 'ğŸ”¬', 'ì ì‘ë ¥': 'ğŸŒŠ' };
            var icon = icons[translateToKorean(s.trait)] || 'âœ¨';
            html += '<button onclick="document.getElementById(\\'strength-detail-' + i + '\\').classList.toggle(\\'hidden\\'); this.classList.toggle(\\'ring-2\\')" class="px-4 py-2 rounded-full text-[15px] font-semibold cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">' + icon + ' ' + translateToKorean(s.trait) + '</button>';
        });
        html += '</div>';
        metaCognition.myArsenal.strengths.forEach(function(s, i) {
            html += '<div id="strength-detail-' + i + '" class="hidden mb-3 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed animate-fadeIn" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);"><span class="font-medium text-green-300">' + translateToKorean(s.trait) + ':</span><span class="ml-1">' + s.meaning + '</span></div>';
        });
        if (metaCognition.myArsenal.counselorNote) {
            html += '<div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);"><div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div><p class="text-[15px] text-wiki-text leading-relaxed italic">' + translateToKorean(metaCognition.myArsenal.counselorNote) + '</p></div>';
        }
    } else {
        html += '<p class="text-[15px] text-wiki-muted">ê°•ì  ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>';
    }

    if (metaCognition.myArsenal?.weaknesses?.length > 0) {
        html += '<div class="mt-5 pt-4 border-t border-wiki-border/20">';
        html += '<div class="text-[15px] font-medium text-orange-400 mb-3 flex items-center gap-2"><span>âš ï¸</span> ê°œì„  ê°€ëŠ¥ ì˜ì—­</div>';
        html += '<div class="flex flex-wrap gap-2 mb-3">';
        metaCognition.myArsenal.weaknesses.forEach(function(w) {
            html += '<span class="px-3 py-1.5 rounded-full text-[15px]" style="background-color: rgba(251,146,60,0.1); color: rgb(253,186,116);">' + translateToKorean(w.trait) + '</span>';
        });
        html += '</div>';
        html += '<details class="group"><summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1"><span class="group-open:hidden">â–¶ ê·¹ë³µ ë°©í–¥ ë³´ê¸°</span><span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span></summary>';
        html += '<div class="mt-3 space-y-2 pl-2 border-l-2 border-orange-500/20">';
        metaCognition.myArsenal.weaknesses.forEach(function(w) {
            html += '<div class="text-[15px]"><span class="font-medium text-orange-300">' + translateToKorean(w.trait) + ':</span><span class="text-wiki-muted ml-1">' + w.meaning + '</span></div>';
        });
        html += '</div></details></div>';
    }

    html += '</div>'; // close ë‚˜ì˜ ê°•ì 

    // 2. ì„ í˜¸ë„ ì§€ë„
    html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.15);">';
    html += '<h4 class="text-lg font-bold mb-4 text-purple-400 flex items-center gap-2"><span>ğŸ¯</span> ì„ í˜¸ë„ ìš”ì•½</h4>';
    html += '<div class="space-y-4">';

    // ì¢‹ì•„í•˜ëŠ” ê²ƒ
    if (metaCognition.preferenceMap?.likes?.length > 0) {
        html += '<div><div class="text-[15px] font-medium text-green-400 mb-2">ğŸ’š ì¢‹ì•„í•˜ëŠ” ê²ƒ</div><div class="flex flex-wrap gap-1.5 mb-2">';
        metaCognition.preferenceMap.likes.forEach(function(l, i) {
            var icons = { 'ê¸°ìˆ /IT': 'ğŸ’»', 'ë¬¸ì œí•´ê²°': 'ğŸ§©', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ë°ì´í„°/ìˆ«ì': 'ğŸ“Š', 'ì‚¬ëŒ ë•ê¸°': 'ğŸ¤²', 'ì¡°ì§/ê´€ë¦¬': 'ğŸ“‹', 'ì˜í–¥ë ¥': 'ğŸ“¢', 'ì—°êµ¬/íƒêµ¬': 'ğŸ”¬', 'ë¦¬ë”©': 'ğŸ‘‘', 'ë¹Œë”©': 'ğŸ—ï¸' };
            var icon = icons[translateToKorean(l.item)] || 'ğŸ’š';
            html += '<button onclick="document.getElementById(\\'like-detail-' + i + '\\').classList.toggle(\\'hidden\\'); this.classList.toggle(\\'ring-2\\')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.12); color: rgb(134,239,172);">' + icon + ' ' + translateToKorean(l.item) + '</button>';
        });
        html += '</div>';
        metaCognition.preferenceMap.likes.forEach(function(l, i) {
            html += '<div id="like-detail-' + i + '" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);"><span class="font-medium text-green-300">' + translateToKorean(l.item) + ':</span><span class="ml-1">' + translateToKorean(l.why) + '</span></div>';
        });
        html += '</div>';
    }

    // í”¼í•˜ê³  ì‹¶ì€ ê²ƒ
    if (metaCognition.preferenceMap?.dislikes?.length > 0) {
        html += '<div><div class="text-[15px] font-medium text-red-400 mb-2">ğŸš« í”¼í•˜ê³  ì‹¶ì€ ê²ƒ</div><div class="flex flex-wrap gap-1.5 mb-2">';
        metaCognition.preferenceMap.dislikes.forEach(function(d, i) {
            var icons = { 'ë¶ˆê·œì¹™í•œ ê·¼ë¬´ì‹œê°„': 'â°', 'ì¬íƒ ì„ í˜¸': 'ğŸ ', 'ì•¼ê·¼ ì—†ìŒ': 'ğŸŒ™', 'ì¶œì¥ ì—†ìŒ': 'âœˆï¸', 'êµëŒ€ê·¼ë¬´ ì—†ìŒ': 'ğŸ”„', 'ì‹œê°„ ì œì•½': 'â³', 'ìˆ˜ì… ì œì•½': 'ğŸ’°', 'ì²´ë ¥ ì œì•½': 'ğŸ‹ï¸', 'ë¶ˆí™•ì‹¤ì„± ì œì•½': 'â“' };
            var icon = icons[translateToKorean(d.item)] || 'ğŸš«';
            html += '<button onclick="document.getElementById(\\'dislike-detail-' + i + '\\').classList.toggle(\\'hidden\\'); this.classList.toggle(\\'ring-2\\')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">' + icon + ' ' + translateToKorean(d.item) + '</button>';
        });
        html += '</div>';
        metaCognition.preferenceMap.dislikes.forEach(function(d, i) {
            html += '<div id="dislike-detail-' + i + '" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);"><span class="font-medium text-red-300">' + translateToKorean(d.item) + ':</span><span class="ml-1">' + translateToKorean(d.why) + '</span></div>';
        });
        html += '</div>';
    }

    // ì˜ ë§ëŠ” ê²ƒ
    if (metaCognition.preferenceMap?.fits?.length > 0) {
        html += '<div><div class="text-[15px] font-medium text-blue-400 mb-2">ğŸ’™ ì˜ ë§ëŠ” ê²ƒ</div><div class="flex flex-wrap gap-1.5 mb-2">';
        metaCognition.preferenceMap.fits.forEach(function(f, i) {
            html += '<button onclick="document.getElementById(\\'fit-detail-' + i + '\\').classList.toggle(\\'hidden\\'); this.classList.toggle(\\'ring-2\\')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(59,130,246,0.12); color: rgb(147,197,253);">ğŸ’™ ' + translateToKorean(f.item) + '</button>';
        });
        html += '</div>';
        metaCognition.preferenceMap.fits.forEach(function(f, i) {
            html += '<div id="fit-detail-' + i + '" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(59,130,246,0.05); border-left: 2px solid rgba(59,130,246,0.3);"><span class="font-medium text-blue-300">' + translateToKorean(f.item) + ':</span><span class="ml-1">' + translateToKorean(f.why) + '</span></div>';
        });
        html += '</div>';
    }

    html += '</div>'; // close space-y-4

    // ìƒë‹´ì‚¬ ë…¸íŠ¸
    if (metaCognition.preferenceMap?.counselorNote) {
        html += '<div class="mt-4 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);"><div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div><p class="text-[15px] text-wiki-text leading-relaxed italic">' + translateToKorean(metaCognition.preferenceMap.counselorNote) + '</p></div>';
    }

    html += '</div>'; // close ì„ í˜¸ë„ ìš”ì•½
    html += '</div>'; // close 2-col grid

    // ìŠ¤íŠ¸ë ˆìŠ¤ + ì„±ì¥ (2ì—´ ê·¸ë¦¬ë“œ)
    var hasStress = metaCognition.stressRecovery?.stressFactors?.length > 0;
    var hasGrowth = !!metaCognition.growthPotential;
    html += '<div class="grid grid-cols-1 ' + (hasStress && hasGrowth ? 'md:grid-cols-2' : '') + ' gap-6 mb-6">';

    // 4. ìŠ¤íŠ¸ë ˆìŠ¤ & íšŒë³µ
    if (hasStress) {
        html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(251,146,60,0.05)); border: 1px solid rgba(239,68,68,0.15);">';
        html += '<h4 class="text-lg font-bold mb-4 text-red-400 flex items-center gap-2"><span>âš¡</span> ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸</h4>';
        html += '<div class="flex flex-wrap gap-2 mb-4">';
        metaCognition.stressRecovery.stressFactors.forEach(function(s, i) {
            var icons = { 'ë°˜ë³µ ì—…ë¬´ í”¼ë¡œ': 'ğŸ”„', 'ê´€ë£Œì£¼ì˜ ìŠ¤íŠ¸ë ˆìŠ¤': 'ğŸ“‘', 'ì‚¬ëŒ ìƒëŒ€ í”¼ë¡œ': 'ğŸ‘¥', 'ì¸ì§€ ê³¼ë¶€í•˜': 'ğŸ§ ', 'ì‹œê°„ ì••ë°•': 'â°', 'ì±…ì„ê° ë¶€ë‹´': 'âš–ï¸', 'ì˜ˆì¸¡ ë¶ˆê°€': 'ğŸŒªï¸', 'ê°ˆë“± ìƒí™©': 'ğŸ’¢', 'ë©€í‹°íƒœìŠ¤í‚¹': 'ğŸ”€', 'ë¶ˆí™•ì‹¤ì„±': 'â“' };
            var icon = icons[translateToKorean(s.factor)] || 'âš¡';
            html += '<button onclick="document.getElementById(\\'stress-detail-' + i + '\\').classList.toggle(\\'hidden\\'); this.classList.toggle(\\'ring-2\\')" class="px-3 py-1.5 rounded-full text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">' + icon + ' ' + translateToKorean(s.factor) + '</button>';
        });
        html += '</div>';
        metaCognition.stressRecovery.stressFactors.forEach(function(s, i) {
            html += '<div id="stress-detail-' + i + '" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);"><span class="font-medium text-red-300">' + translateToKorean(s.factor) + ':</span><span class="ml-1">' + translateToKorean(s.why) + '</span></div>';
        });
        if (metaCognition.stressRecovery.counselorNote) {
            html += '<div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);"><div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div><p class="text-[15px] text-wiki-text leading-relaxed italic">' + translateToKorean(metaCognition.stressRecovery.counselorNote) + '</p></div>';
        }
        if (metaCognition.stressRecovery?.recoveryMethods?.length > 0) {
            html += '<div class="mt-4 pt-4 border-t border-wiki-border/20">';
            html += '<div class="text-[15px] font-medium text-emerald-400 mb-2 flex items-center gap-2"><span>ğŸŒ¿</span> íšŒë³µ ë°©ë²•</div>';
            html += '<div class="flex flex-wrap gap-2 mb-3">';
            metaCognition.stressRecovery.recoveryMethods.forEach(function(r) {
                html += '<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">' + translateToKorean(r.factor) + '</span>';
            });
            html += '</div>';
            html += '<details class="group"><summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1"><span class="group-open:hidden">â–¶ ì™œ íšŒë³µë˜ëŠ”ì§€ ì´í•´í•˜ê¸°</span><span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span></summary>';
            html += '<div class="mt-3 space-y-2 text-[15px]">';
            metaCognition.stressRecovery.recoveryMethods.forEach(function(r) {
                html += '<div class="p-3 rounded-lg" style="background-color: rgba(16,185,129,0.05);"><span class="font-medium text-emerald-300">' + translateToKorean(r.factor) + ':</span><span class="text-wiki-muted ml-1">' + translateToKorean(r.why) + '</span></div>';
            });
            html += '</div></details></div>';
        }
        html += '</div>';
    }

    // 5. ì„±ì¥ ê°€ëŠ¥ì„±
    if (hasGrowth) {
        html += '<div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(52,211,153,0.05)); border: 1px solid rgba(16,185,129,0.15);">';
        html += '<h4 class="text-lg font-bold mb-4 text-emerald-400 flex items-center gap-2"><span>ğŸŒ±</span> ì„±ì¥ ê°€ëŠ¥ì„±</h4>';
        if (metaCognition.growthPotential.leveragePoints?.length > 0) {
            html += '<div class="flex flex-wrap gap-2 mb-4">';
            metaCognition.growthPotential.leveragePoints.forEach(function(p) {
                var icons = { 'ë¶„ì„ë ¥': 'ğŸ”', 'ì°½ì‘/ì˜ˆìˆ ': 'ğŸ¨', 'ì†Œí†µë ¥': 'ğŸ’¬', 'ì²´ê³„ì  ì‹¤í–‰ë ¥': 'ğŸ“‹', 'ëˆê¸°': 'ğŸ’ª', 'ë¹ ë¥¸ í•™ìŠµ': 'âš¡', 'ë¦¬ë”ì‹­': 'ğŸ‘‘', 'ê³µê° ëŠ¥ë ¥': 'ğŸ¤', 'ê¼¼ê¼¼í•¨': 'ğŸ”¬', 'ì ì‘ë ¥': 'ğŸŒŠ' };
                var icon = icons[translateToKorean(p)] || 'âœ¨';
                html += '<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">' + icon + ' ' + translateToKorean(p) + '</span>';
            });
            html += '</div>';
        }
        if (metaCognition.growthPotential.counselorNote) {
            html += '<div class="p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);"><div class="text-[15px] font-medium mb-2" style="color: rgb(251,191,36);">ğŸ’¡ ìƒë‹´ì‚¬ ë…¸íŠ¸</div><p class="text-[15px] text-wiki-text leading-relaxed italic">' + translateToKorean(metaCognition.growthPotential.counselorNote) + '</p></div>';
        }
        if (metaCognition.growthPotential.direction) {
            html += '<details class="group"><summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1"><span class="group-open:hidden">â–¶ ì„±ì¥ ë°©í–¥ ìƒì„¸ ë³´ê¸°</span><span class="hidden group-open:inline">â–¼ ì ‘ê¸°</span></summary>';
            html += '<div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(16,185,129,0.05);">ğŸ¯ ' + translateToKorean(metaCognition.growthPotential.direction) + '</div>';
            html += '</details>';
        }
        html += '</div>';
    }

    html += '</div>'; // close stress+growth grid
    html += '<hr class="border-wiki-border/20 my-8" />';

    return html;
}

// ============================================
// Recommendations Tab Builder
// ============================================
function buildRecommendationsTabMajor(profileInterpretation, overallTop5, fitTop10, likeTop10) {
    var html = '';

    html += '<div id="tab-recommendations" class="report-tab-content hidden glass-card p-6 rounded-2xl mb-6">';
    html += '<div class="mb-8 pb-6">';
    html += '<h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">';
    html += '<span class="text-3xl">ğŸ“</span>';
    html += '<span class="bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">ì¶”ì²œ ì „ê³µ</span>';
    html += '</h2>';
    html += '<p class="text-center text-wiki-muted text-sm mt-2">ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì „ê³µì„ AIê°€ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>';
    html += '<div class="mt-6 h-px bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>';
    html += '</div>';

    // í”„ë¡œí•„ ê¸°ë°˜ ì¶”ì²œ ìš”ì•½
    if (profileInterpretation) {
        html += '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.08)); border: 1px solid rgba(99,102,241,0.2);">';
        html += '<h4 class="text-lg font-bold mb-3 flex items-center gap-2" style="color: rgb(165,180,252);"><span>ğŸ“Œ</span> ë‹¹ì‹ ì˜ í”„ë¡œí•„ ê¸°ë°˜ ì¶”ì²œ</h4>';
        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">';
        if (profileInterpretation.interests?.length > 0) {
            html += '<div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(34,197,94,0.1);"><span class="text-green-400">ğŸ’š</span><div><div class="text-base font-semibold text-green-400">í¥ë¯¸</div><div class="text-[15px] text-white">' + profileInterpretation.interests.slice(0, 2).map(function(i) { return i.label; }).join(', ') + '</div></div></div>';
        }
        if (profileInterpretation.strengths?.length > 0) {
            html += '<div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(59,130,246,0.1);"><span class="text-blue-400">ğŸ’ª</span><div><div class="text-base font-semibold text-blue-400">ê°•ì </div><div class="text-[15px] text-white">' + profileInterpretation.strengths.slice(0, 2).map(function(s) { return s.label; }).join(', ') + '</div></div></div>';
        }
        if (profileInterpretation.values?.length > 0) {
            html += '<div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(168,85,247,0.1);"><span class="text-purple-400">â­</span><div><div class="text-base font-semibold text-purple-400">ê°€ì¹˜</div><div class="text-[15px] text-white">' + profileInterpretation.values.slice(0, 2).map(function(v) { return v.label; }).join(', ') + '</div></div></div>';
        }
        if (profileInterpretation.constraints?.length > 0) {
            html += '<div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(239,68,68,0.1);"><span class="text-red-400">ğŸš«</span><div><div class="text-base font-semibold text-red-400">ì œì•½</div><div class="text-[15px] text-white">' + profileInterpretation.constraints.slice(0, 2).map(function(c) { return c.label; }).join(', ') + '</div></div></div>';
        }
        html += '</div>';
        html += '<p class="text-[15px] text-wiki-muted">ì´ ì¡°ê±´ë“¤ì„ ì¢…í•©í•˜ì—¬ <span class="text-wiki-primary font-medium">' + (overallTop5.length || fitTop10.length) + 'ê°œ</span>ì˜ ì „ê³µì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>';
        html += '</div>';
    }

    // 3ì„¸íŠ¸ íƒ­
    html += '<div class="flex gap-3 mb-6">';
    html += '<button onclick="showMajorSet(\\'overall\\')" class="major-set-tab active flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="overall"><span class="flex items-center justify-center gap-2"><span class="text-lg">ğŸ†</span><span>ì¢…í•© ì¶”ì²œ</span></span></button>';
    html += '<button onclick="showMajorSet(\\'fit\\')" class="major-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="fit"><span class="flex items-center justify-center gap-2"><span class="text-lg">ğŸ’ª</span><span>ì˜ ë§ì„ ê²ƒ ê°™ì€ ì „ê³µ</span></span></button>';
    html += '<button onclick="showMajorSet(\\'desire\\')" class="major-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="desire"><span class="flex items-center justify-center gap-2"><span class="text-lg">ğŸ’–</span><span>ì¢‹ì•„í• ë§Œí•œ ì „ê³µ</span></span></button>';
    html += '</div>';

    // ì „ê³µ ì¹´ë“œë“¤
    html += '<div id="major-cards-container">';
    var initialMajors = (overallTop5.length > 0 ? overallTop5 : fitTop10).slice(0, 5);
    html += renderMajorCardsV3(initialMajors, 'overall', profileInterpretation);
    html += '</div>';

    html += '</div>'; // close tab-recommendations

    return html;
}

// ============================================
// Details Tab Builder
// ============================================
function buildDetailsTabMajor(result, report) {
    var html = '';

    html += '<div id="tab-details" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">';
    html += '<div class="mb-8 pb-6">';
    html += '<h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3"><span class="text-3xl">ğŸ“Š</span><span class="bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">ë¶„ì„ ìƒì„¸ ì •ë³´</span></h2>';
    html += '<p class="text-center text-wiki-muted text-sm mt-2">AI ì¶”ì²œì˜ ê·¼ê±°ì™€ ê¸°ìˆ ì  ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
    html += '<p class="text-center text-wiki-muted text-xs mt-1">ì—”ì§„ ë²„ì „: ' + (result.engine_version || 'unknown') + '</p>';
    html += '<div class="mt-6 h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>';
    html += '</div>';
    html += '<p class="text-base text-wiki-muted mb-6">ì´ ì„¹ì…˜ì€ AI ì¶”ì²œì˜ ê·¼ê±°, ì‚¬ìš©ëœ ì•Œê³ ë¦¬ì¦˜, ê·¸ë¦¬ê³  ì ìˆ˜ ì‚°ì¶œ ê³¼ì •ì„ ìƒì„¸íˆ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>';

    // ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì„¤ëª…
    html += '<div class="mb-8 p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.05)); border: 1px solid rgba(34,197,94,0.2);">';
    html += '<h4 class="text-xl font-bold mb-4 text-emerald-400">ğŸ”¬ ë¶„ì„ íŒŒì´í”„ë¼ì¸</h4>';
    html += '<div class="space-y-4 text-base">';
    html += '<div class="flex items-start gap-3"><span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">1</span><div><p class="font-medium text-white">ë²¡í„° ê²€ìƒ‰ (Vectorize)</p><p class="text-wiki-muted text-[15px]">ë‹¹ì‹ ì˜ ë‹µë³€ì„ ì„ë² ë”©ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ê³µ DBì—ì„œ ì˜ë¯¸ì ìœ¼ë¡œ ìœ ì‚¬í•œ í›„ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p></div></div>';
    html += '<div class="flex items-start gap-3"><span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">2</span><div><p class="font-medium text-white">TAG í•„í„°ë§ (Hard Constraints)</p><p class="text-wiki-muted text-[15px]">í•™ìŠµ í™˜ê²½, ì„ í˜¸ë„ ë“± ì ˆëŒ€ ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ì „ê³µì„ ì œì™¸í•©ë‹ˆë‹¤.</p></div></div>';
    html += '<div class="flex items-start gap-3"><span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">3</span><div><p class="font-medium text-white">LLM Judge (GPT-4o-mini)</p><p class="text-wiki-muted text-[15px]">ë‚¨ì€ í›„ë³´ ì „ê³µì— ëŒ€í•´ AIê°€ Like/Can/Fit ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ê³ , ì¶”ì²œ ì´ìœ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p></div></div>';
    html += '<div class="flex items-start gap-3"><span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">4</span><div><p class="font-medium text-white">LLM Reporter (ì‹¬ë¦¬ë¶„ì„)</p><p class="text-wiki-muted text-[15px]">ë‹¹ì‹ ì˜ ë¯¸ë‹ˆëª¨ë“ˆ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìŠµ ìŠ¤íƒ€ì¼ê³¼ ì „ê³µ ë°©í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p></div></div>';
    html += '</div></div>';

    // ì…ë ¥ ë°ì´í„° ìš”ì•½
    html += '<div class="mb-8">';
    html += '<h4 class="text-xl font-bold mb-4">ğŸ“ ë¶„ì„ì— ì‚¬ìš©ëœ ì…ë ¥ ë°ì´í„°</h4>';
    html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
    html += '<div class="p-4 rounded-xl bg-wiki-bg/50 text-center"><div class="text-3xl font-bold text-wiki-primary">' + (report._factsCount || 0) + '</div><div class="text-base text-wiki-muted mt-1">ìˆ˜ì§‘ëœ íŒ©íŠ¸</div></div>';
    html += '<div class="p-4 rounded-xl bg-wiki-bg/50 text-center"><div class="text-3xl font-bold text-emerald-400">' + (report._answeredQuestions || 0) + '</div><div class="text-base text-wiki-muted mt-1">ë‹µë³€í•œ ì§ˆë¬¸</div></div>';
    html += '<div class="p-4 rounded-xl bg-wiki-bg/50 text-center"><div class="text-3xl font-bold text-purple-400">' + (report._totalJobCount || report._candidatesScored || 0).toLocaleString() + '</div><div class="text-base text-wiki-muted mt-1">ë¶„ì„ ëŒ€ìƒ ì „ê³µ</div></div>';
    html += '<div class="p-4 rounded-xl bg-wiki-bg/50 text-center"><div class="text-3xl font-bold text-amber-400">6</div><div class="text-base text-wiki-muted mt-1">LLM í˜¸ì¶œ íšŸìˆ˜</div></div>';
    html += '</div></div>';

    // AI ì¶”ì²œ ì‹œìŠ¤í…œ ì‘ë™ ì›ë¦¬
    html += '<div class="mb-8 p-5 rounded-xl" style="background-color: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2);">';
    html += '<h4 class="text-xl font-bold mb-4" style="color: rgb(165,180,252);">ğŸ¯ AI ì¶”ì²œì€ ì´ë ‡ê²Œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤</h4>';
    html += '<p class="text-[15px] text-wiki-muted mb-5">ì´ ë¦¬í¬íŠ¸ëŠ” ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­ì´ ì•„ë‹Œ, 3ë‹¨ê³„ AI ì‹œìŠ¤í…œì„ ê±°ì³ ìƒì„±ë©ë‹ˆë‹¤.</p>';

    // STEP 1 RAG
    html += '<div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(34,197,94,0.2); color: rgb(34,197,94);">STEP 1</span><span class="font-bold text-white text-base">RAG â€” ì˜ë¯¸ ê¸°ë°˜ í›„ë³´ ê²€ìƒ‰</span></div><p class="text-[14px] text-wiki-muted leading-relaxed mb-2">ë‹¹ì‹ ì˜ ë‹µë³€ ì „ì²´ë¥¼ AI ì„ë² ë”©(ìˆ«ì ë²¡í„°)ìœ¼ë¡œ ë³€í™˜í•œ ë’¤, ì „ê³µ DBì—ì„œ <span class="text-emerald-400">ì˜ë¯¸ì ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì „ê³µë“¤</span>ì„ ì°¾ìŠµë‹ˆë‹¤.</p><p class="text-[13px] text-wiki-muted/70">"ë°ì´í„° ë¶„ì„ì„ ì¢‹ì•„í•œë‹¤"ê³  ë‹µí•˜ë©´, ì „ê³µëª…ì— \\'ë¶„ì„\\'ì´ ì—†ë”ë¼ë„ ë°ì´í„° ê´€ë ¨ í•™ìŠµì„ í•˜ëŠ” ì „ê³µì´ í›„ë³´ì— í¬í•¨ë©ë‹ˆë‹¤.</p></div>';

    // STEP 2 TAG
    html += '<div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(251,191,36,0.2); color: rgb(251,191,36);">STEP 2</span><span class="font-bold text-white text-base">TAG â€” ì ˆëŒ€ ì¡°ê±´ í•„í„°ë§</span></div><p class="text-[14px] text-wiki-muted leading-relaxed mb-2">í›„ë³´ ì „ê³µë“¤ì˜ ì†ì„± íƒœê·¸ë¥¼ ë‹¹ì‹ ì˜ <span class="text-amber-400">ì œì•½ ì¡°ê±´</span>ê³¼ ëŒ€ì¡°í•©ë‹ˆë‹¤.</p><p class="text-[13px] text-wiki-muted/70">"ì ˆëŒ€ ì•ˆ ë¼" ìˆ˜ì¤€ì˜ ì œì•½ì€ í•´ë‹¹ ì „ê³µì„ í›„ë³´ì—ì„œ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.</p></div>';

    // STEP 3 CAG
    html += '<div class="mb-5 p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(99,102,241,0.2); color: rgb(129,140,248);">STEP 3</span><span class="font-bold text-white text-base">CAG â€” AIê°€ ì§ì ‘ í‰ê°€</span></div><p class="text-[14px] text-wiki-muted leading-relaxed mb-2">ë‚¨ì€ í›„ë³´ ì „ê³µ ê°ê°ì— ëŒ€í•´, GPT-4o-miniê°€ ë‹¹ì‹ ì˜ í”„ë¡œí•„ ì „ì²´ë¥¼ ì½ê³  <span class="text-indigo-400">Like(ì¢‹ì•„í•  ê°€ëŠ¥ì„±)</span>ì™€ <span class="text-blue-400">Can(ì˜í•  ê°€ëŠ¥ì„±)</span> ì ìˆ˜ë¥¼ ë§¤ê¹ë‹ˆë‹¤.</p><p class="text-[13px] text-wiki-muted/70">AIëŠ” ë‹¨ìˆœíˆ ìˆ«ìë§Œ ë§¤ê¸°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, "ì™œ ì´ ì „ê³µì„ ì¢‹ì•„í• ì§€", "ì™œ ì˜í•  ìˆ˜ ìˆëŠ”ì§€"ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì´ìœ ë„ í•¨ê»˜ ìƒì„±í•©ë‹ˆë‹¤.</p></div>';

    // ìµœì¢… ì ìˆ˜
    html += '<div class="p-4 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded" style="background: rgba(168,85,247,0.2); color: rgb(192,132,252);">ìµœì¢…</span><span class="font-bold text-white text-base">ì¢…í•© ì ìˆ˜ ê³„ì‚° (Fit)</span></div><p class="text-[14px] text-wiki-muted leading-relaxed mb-3">AIê°€ ë§¤ê¸´ ì ìˆ˜ë¥¼ ì•„ë˜ ê³µì‹ìœ¼ë¡œ ì¡°í•©í•˜ì—¬ ìµœì¢… ìˆœìœ„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.</p>';
    html += '<div class="p-3 rounded-lg text-center" style="background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);"><p class="text-base font-bold text-white" style="font-family: monospace;">Fit = Like + Can + Background</p></div>';
    html += '<div class="mt-3 space-y-1 text-[13px] text-wiki-muted/80"><p><span class="text-purple-400 font-medium">Like</span> â€” ì¢‹ì•„í•  ì „ê³µì„ ì¤‘ìš”í•˜ê²Œ ë°˜ì˜í•©ë‹ˆë‹¤. í¥ë¯¸ì™€ ê°€ì¹˜ê´€ì´ ë§ì•„ì•¼ ì˜¤ë˜ ê°ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p><p><span class="text-blue-400 font-medium">Can</span> â€” ì˜í•  ìˆ˜ ìˆëŠ” ì „ê³µë„ í•¨ê»˜ ë°˜ì˜í•©ë‹ˆë‹¤. ê°•ì ê³¼ ì—­ëŸ‰ì´ ë§ì•„ì•¼ ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><span class="text-amber-400 font-medium">Background</span> â€” ê²½ë ¥, í•™ë ¥, ê²½í—˜ì´ ì „ê³µê³¼ ì–¼ë§ˆë‚˜ ê´€ë ¨ ìˆëŠ”ì§€ í‰ê°€í•©ë‹ˆë‹¤.</p></div>';
    html += '</div></div>';

    // ì ìˆ˜ ê³„ì‚° ë°©ì‹
    html += '<div class="mb-8 rounded-xl overflow-hidden" style="border: 1px solid rgba(255,255,255,0.08);">';
    html += '<div class="px-5 py-3" style="background: rgba(255,255,255,0.04); border-bottom: 1px solid rgba(255,255,255,0.08);"><h4 class="text-base font-bold text-wiki-text">ğŸ’¡ ì ìˆ˜ ê³„ì‚° ë°©ì‹</h4></div>';
    html += '<div class="divide-y" style="--tw-divide-opacity: 0.06; --tw-divide-color: rgba(255,255,255,var(--tw-divide-opacity));">';
    html += '<div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(52,211,153);"><span class="text-emerald-400 font-bold text-sm w-10 shrink-0 text-center">Fit</span><span class="text-white text-sm font-medium w-20 shrink-0">ì¢…í•© ì í•©ë„</span><span class="text-wiki-muted text-[13px]">Like + Can + Background ì¢…í•©</span></div>';
    html += '<div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(168,85,247);"><span class="text-purple-400 font-bold text-sm w-10 shrink-0 text-center">Like</span><span class="text-white text-sm font-medium w-20 shrink-0">ì¢‹ì•„í•  ê°€ëŠ¥ì„±</span><span class="text-wiki-muted text-[13px]">ê´€ì‹¬ ë¶„ì•¼, ê°€ì¹˜ê´€, ìš°ì„ ìˆœìœ„ì™€ ì „ê³µ íŠ¹ì„±ì˜ ì¼ì¹˜ë„</span></div>';
    html += '<div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(96,165,250);"><span class="text-blue-400 font-bold text-sm w-10 shrink-0 text-center">Can</span><span class="text-white text-sm font-medium w-20 shrink-0">ì˜í•  ê°€ëŠ¥ì„±</span><span class="text-wiki-muted text-[13px]">ê°•ì , í•™ìŠµ ìŠ¤íƒ€ì¼, ê²½í—˜ê³¼ ì „ê³µ ìš”êµ¬ì‚¬í•­ì˜ ì í•©ë„</span></div>';
    html += '<div class="flex items-center gap-4 px-5 py-3" style="border-left: 3px solid rgb(251,191,36);"><span class="text-amber-400 font-bold text-sm w-10 shrink-0 text-center">Bg</span><span class="text-white text-sm font-medium w-20 shrink-0">ë°°ê²½ ì í•©ë„</span><span class="text-wiki-muted text-[13px]">ê²½ë ¥, í•™ë ¥, ìê²©ì¦, ê²½í—˜ ë“± ë°°ê²½ì˜ ë„ì›€ ì •ë„</span></div>';
    html += '</div></div>';

    // ë°ì´í„° ì†ŒìŠ¤
    html += '<div class="p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05)); border: 1px solid rgba(139,92,246,0.2);">';
    html += '<h4 class="text-xl font-bold mb-4 text-purple-400">ğŸ“š ë°ì´í„° ì†ŒìŠ¤</h4>';
    html += '<div class="grid md:grid-cols-2 gap-4 text-base">';
    html += '<div><p class="font-medium text-white mb-1">ì „ê³µ ì •ë³´</p><p class="text-wiki-muted text-[15px]">ì»¤ë¦¬ì–´ë„· + ëŒ€í•™ ì •ë³´ ë°ì´í„° í†µí•©</p></div>';
    html += '<div><p class="font-medium text-white mb-1">ì „ê³µ ì†ì„± íƒœê¹…</p><p class="text-wiki-muted text-[15px]">major_attributes í…Œì´ë¸”: í•™ìŠµí™˜ê²½, ì§„ë¡œ ë°©í–¥ ë“± ì†ì„±</p></div>';
    html += '<div><p class="font-medium text-white mb-1">ì„ë² ë”© ëª¨ë¸</p><p class="text-wiki-muted text-[15px]">OpenAI text-embedding-3-small (1536ì°¨ì›)</p></div>';
    html += '<div><p class="font-medium text-white mb-1">íŒë‹¨ ëª¨ë¸</p><p class="text-wiki-muted text-[15px]">GPT-4o-mini (Like/Can/Fit ì ìˆ˜ ë° ì¶”ì²œ ì´ìœ  ìƒì„±)</p></div>';
    html += '</div></div>';

    html += '</div>'; // close tab-details

    return html;
}

// ============================================
// Bottom Buttons Builder
// ============================================
function buildBottomButtonsMajor() {
    var html = '';

    html += '<div class="flex flex-col sm:flex-row gap-3 justify-center mt-8">';
    html += '<button onclick="showEditWarningModal()" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-medium transition hover:opacity-80" style="background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3);"><i class="fas fa-edit"></i> ì…ë ¥í•œ ë‚´ìš© ìˆ˜ì •</button>';
    html += '<button onclick="showAddContextModal()" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-medium transition hover:opacity-80" style="background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);"><i class="fas fa-plus"></i> ìƒˆë¡œìš´ ë‚´ìš© ì¶”ê°€</button>';
    html += '</div>';

    // ì…ë ¥ ìˆ˜ì • ê²½ê³  ëª¨ë‹¬
    html += '<div id="edit-warning-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">';
    html += '<div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-lg mx-4 shadow-2xl w-full max-h-[90vh] overflow-y-auto">';
    html += '<div class="mb-5"><div class="w-12 h-12 mx-auto mb-4 bg-amber-500/20 rounded-full flex items-center justify-center"><i class="fas fa-exclamation-triangle text-xl text-amber-400"></i></div>';
    html += '<h3 class="text-lg font-bold text-white text-center mb-2">ì…ë ¥ ë‚´ìš© ìˆ˜ì • ì•ˆë‚´</h3>';
    html += '<p class="text-sm text-wiki-muted text-center">ê¸°ì¡´ì— ì…ë ¥í–ˆë˜ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ë‹¨, ìˆ˜ì • ë²”ìœ„ì— ë”°ë¼ ì´í›„ ë‹¨ê³„ì˜ ë‹µë³€ì´ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>';
    html += '<div class="space-y-4 mb-6">';
    html += '<div class="p-3 rounded-lg" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2);"><p class="text-sm font-medium text-amber-300 mb-1">Step 1 (í”„ë¡œí•„ ê¸°ë³¸ì •ë³´) ìˆ˜ì • ì‹œ</p><p class="text-xs text-wiki-muted">Step 2(ì‹¬ì¸µ ì§ˆë¬¸)ì˜ ì§ˆë¬¸ì´ ìƒˆë¡œ ìƒì„±ë˜ë©°, ê¸°ì¡´ ì‹¬ì¸µ ì§ˆë¬¸ ë‹µë³€ì´ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p></div>';
    html += '<div class="p-3 rounded-lg" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2);"><p class="text-sm font-medium text-amber-300 mb-1">Step 2 (ì‹¬ì¸µ ì§ˆë¬¸) ë‹µë³€ ìˆ˜ì • ì‹œ</p><p class="text-xs text-wiki-muted">ìˆ˜ì •í•œ ë¼ìš´ë“œ ì´í›„ì˜ ì§ˆë¬¸ë“¤ì´ ìƒˆë¡œ ìƒì„±ë˜ë©°, í•´ë‹¹ ë¼ìš´ë“œ ì´í›„ ë‹µë³€ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p></div>';
    html += '</div>';
    html += '<div class="flex gap-3">';
    html += '<button onclick="hideEditWarningModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">ì·¨ì†Œ</button>';
    html += '<button onclick="navigateToEditMode()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium">ìˆ˜ì • ì‹œì‘í•˜ê¸°</button>';
    html += '</div></div></div>';

    // ë‚´ìš© ì¶”ê°€ ëª¨ë‹¬
    html += '<div id="add-context-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">';
    html += '<div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-md mx-4 shadow-2xl w-full">';
    html += '<div class="mb-5"><h3 class="text-lg font-bold text-white mb-2"><i class="fas fa-plus text-emerald-400 mr-2"></i>ì¶”ê°€ ì •ë³´ ì…ë ¥</h3>';
    html += '<p class="text-sm text-wiki-muted">í˜„ì¬ ë¶„ì„ì— ë°˜ì˜í•˜ê³  ì‹¶ì€ ì¶”ê°€ ì •ë³´ë¥¼ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p></div>';
    html += '<textarea id="additional-context-text" class="w-full h-32 p-3 rounded-xl text-sm text-white placeholder-wiki-muted resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500/50" style="background: rgba(15, 15, 35, 0.6); border: 1px solid rgba(148, 163, 184, 0.2);" placeholder="ì˜ˆ: ìˆ˜í•™ì— ê´€ì‹¬ì´ ë§ê³  í”„ë¡œê·¸ë˜ë°ì„ ì¢‹ì•„í•©ë‹ˆë‹¤. ì‹¤í—˜ë³´ë‹¤ëŠ” ì´ë¡  í•™ìŠµì„ ì„ í˜¸í•©ë‹ˆë‹¤." minlength="30"></textarea>';
    html += '<p id="context-char-count" class="text-xs mt-1 text-wiki-muted">0 / ìµœì†Œ 30ì</p>';
    html += '<div class="flex gap-3 mt-4">';
    html += '<button onclick="hideAddContextModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">ì·¨ì†Œ</button>';
    html += '<button id="submit-context-btn" onclick="submitAdditionalContext()" disabled class="flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">ì¶”ê°€ í›„ ì¬ë¶„ì„</button>';
    html += '</div></div></div>';

    return html;
}

// ============================================
// Tab Switching (Major)
// ============================================
function showReportTabMajor(tabId) {
    document.querySelectorAll('.report-tab-content').forEach(function(el) { el.classList.add('hidden'); });
    document.querySelectorAll('.report-tab').forEach(function(el) { el.classList.remove('active'); });

    var tab = document.getElementById('tab-' + tabId);
    if (tab) tab.classList.remove('hidden');
    var btn = document.querySelector('.report-tab[data-tab="' + tabId + '"]');
    if (btn) btn.classList.add('active');
}

// ============================================
// Major Set Switching (recommendation sub-tabs)
// ============================================
function showMajorSet(setId) {
    var data = window.currentReportData;
    if (!data) return;

    var majorList = [];

    if (setId === 'overall') majorList = (data.overallTop5 || data.fitTop10 || []).slice(0, 5);
    else if (setId === 'fit') majorList = (data.fitTop10 || []).slice(0, 10);
    else if (setId === 'desire') majorList = (data.likeTop10 || data.fitTop10 || []).slice(0, 10);

    var container = document.getElementById('major-cards-container');
    if (container) container.innerHTML = renderMajorCardsV3(majorList, setId, data.profileInterpretation);

    document.querySelectorAll('.major-set-tab').forEach(function(el) { el.classList.remove('active'); });
    var activeBtn = document.querySelector('.major-set-tab[data-set="' + setId + '"]');
    if (activeBtn) activeBtn.classList.add('active');
}

// ============================================
// Major Card Rendering (V3 compact design)
// ============================================
function renderMajorCardsV3(majors, setId, profileInterp) {
    if (!majors || majors.length === 0) {
        return '<p class="text-wiki-muted text-center py-8">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    setId = setId || 'overall';
    profileInterp = profileInterp || null;

    return majors.map(function(major, idx) {
        var majorName = major.major_name || major.major_id || 'ì „ê³µ';
        var majorSlug = major.slug || major.major_id || '';
        var imageUrl = major.image_url || '';
        if (imageUrl && imageUrl.includes('/uploads/')) {
            var parts = imageUrl.split('/');
            var filename = parts.pop();
            imageUrl = parts.join('/') + '/' + encodeURIComponent(filename);
        }
        var rationale = major.rationale || major.one_line_why || '';
        var description = (major.major_description || major.description || major.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
        var displayDescription = description || '';
        var fitScore = major.scores?.fit || major.fit_score || '-';
        var likeScore = major.scores?.like || major.like_score || '-';
        var canScore = major.scores?.can || major.can_score || '-';
        var fieldCategory = major.field_category || '';

        // íƒ­ë³„ ì£¼ì ìˆ˜ ê²°ì •
        var mainScore, mainScoreLabel, mainScoreColor;
        var likeReasonText = major.like_reason || '';
        var canReasonText = major.can_reason || '';

        var isAutoGenerated = rationale.includes('ìë™ ìƒì„±ëœ ê²°ê³¼') || rationale.includes('LLM ë¶„ì„ì´ ì§„í–‰ë˜ì§€');
        if (likeReasonText.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) likeReasonText = '';
        if (canReasonText.includes('ìë™ ìƒì„±ëœ ê²°ê³¼')) canReasonText = '';

        if (!likeReasonText && !isAutoGenerated && rationale && !rationale.includes('[')) {
            likeReasonText = rationale;
        }
        if (!likeReasonText && likeScore !== '-') {
            var ls = parseInt(likeScore) || 0;
            if (ls >= 70) likeReasonText = 'ë‹¹ì‹ ì˜ ê´€ì‹¬ì‚¬ì™€ ê°€ì¹˜ê´€ì— ì˜ ë§ëŠ” ì „ê³µì…ë‹ˆë‹¤.';
            else if (ls >= 50) likeReasonText = 'í¥ë¯¸ë¡œìš´ í•™ìŠµ í™˜ê²½ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        }
        if (!canReasonText && canScore !== '-') {
            var cs = parseInt(canScore) || 0;
            if (cs >= 70) canReasonText = 'ë‹¹ì‹ ì˜ ê°•ì ì„ ì˜ ë°œíœ˜í•  ìˆ˜ ìˆëŠ” ë¶„ì•¼ì…ë‹ˆë‹¤.';
            else if (cs >= 50) canReasonText = 'ì„±ì¥ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë¶„ì•¼ì…ë‹ˆë‹¤.';
        }

        if (setId === 'desire') {
            mainScore = likeScore; mainScoreLabel = 'Like'; mainScoreColor = 'text-purple-400';
        } else if (setId === 'fit') {
            mainScore = canScore; mainScoreLabel = 'Can'; mainScoreColor = 'text-blue-400';
        } else {
            mainScore = fitScore; mainScoreLabel = 'Fit'; mainScoreColor = 'text-emerald-400';
        }

        // ì´ìœ  HTML ìƒì„±
        var reasonOuterHtml = '';
        if (setId === 'overall') {
            if (likeReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">ğŸ’œ Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
            if (canReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">ğŸ’ª Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
        } else if (setId === 'desire') {
            if (likeReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">ğŸ’œ Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
        } else {
            if (canReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">ğŸ’ª Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
        }

        var rankBadge = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : '' + (idx + 1);

        // í”„ë¡œí•„ ë§¤ì¹­ í¬ì¸íŠ¸
        var matchingTags = [];
        var likeNum = parseInt(likeScore) || 0;
        var canNum = parseInt(canScore) || 0;
        var pi = profileInterp || {};
        var interestLabels = (pi.interests || []).slice(0, 2).map(function(i) { return i.label; });
        var strengthLabels = (pi.strengths || []).slice(0, 2).map(function(s) { return s.label; });

        if (likeNum >= 65 && interestLabels.length > 0) {
            matchingTags.push({ icon: 'ğŸ’š', label: interestLabels[0] + ' í¥ë¯¸', color: 'green' });
        }
        if (canNum >= 65 && strengthLabels.length > 0) {
            matchingTags.push({ icon: 'ğŸ’ª', label: strengthLabels[0] + ' ê°•ì ', color: 'blue' });
        }

        var matchingTagsHtml = '';
        if (matchingTags.length > 0) {
            matchingTagsHtml = '<div class="flex flex-wrap gap-1.5 mt-2">';
            matchingTags.forEach(function(tag) {
                var rgb = tag.color === 'green' ? '34,197,94' : '59,130,246';
                var textRgb = tag.color === 'green' ? '134,239,172' : '147,197,253';
                matchingTagsHtml += '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs" style="background: rgba(' + rgb + ',0.15); color: rgb(' + textRgb + ');"><span>' + tag.icon + '</span><span>' + tag.label + '</span></span>';
            });
            matchingTagsHtml += '</div>';
        }

        // ì ìˆ˜ ë°”
        var fitNum = parseInt(fitScore) || 0;
        var likeNum2 = parseInt(likeScore) || 0;
        var canNum2 = parseInt(canScore) || 0;
        var bgScore = major.feasibility_score || major.feasibilityScore || 0;

        var cardHtml = '';
        cardHtml += '<div class="rounded-2xl overflow-hidden group transition-all mb-4" style="background: linear-gradient(135deg, rgba(30,30,50,0.9), rgba(25,25,45,0.95)); border: 1px solid rgba(99,102,241,' + (idx < 3 ? '0.25' : '0.12') + ');">';

        // ìƒë‹¨: ì¸ë„¤ì¼ + ì „ê³µ ì •ë³´
        cardHtml += '<div class="flex items-stretch">';

        // ì¸ë„¤ì¼
        if (imageUrl && imageUrl.trim()) {
            cardHtml += '<div class="flex-shrink-0 w-28 sm:w-32 relative overflow-hidden">';
            cardHtml += '<img src="' + imageUrl + '" alt="' + majorName + '" class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.onerror=null; this.parentElement.innerHTML=\\'<div class=\\\\\\'w-full h-full flex items-center justify-center\\\\\\' style=\\\\\\'background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));\\\\\\' ><i class=\\\\\\'fas fa-graduation-cap text-2xl text-wiki-muted\\\\\\'></i></div>\\';" />';
            cardHtml += '<div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);"><span class="' + (idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted') + '">' + rankBadge + '</span></div>';
            cardHtml += '</div>';
        } else {
            cardHtml += '<div class="flex-shrink-0 w-28 sm:w-32 relative flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));">';
            cardHtml += '<i class="fas fa-graduation-cap text-2xl text-wiki-muted"></i>';
            cardHtml += '<div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6);"><span class="' + (idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted') + '">' + rankBadge + '</span></div>';
            cardHtml += '</div>';
        }

        // ì „ê³µ ì •ë³´ + ì ìˆ˜
        cardHtml += '<div class="flex-1 min-w-0 p-4 flex flex-col justify-between"><div>';
        cardHtml += '<div class="flex items-start justify-between gap-3 mb-1.5">';
        cardHtml += '<a href="/major/' + majorSlug + '" target="_blank" rel="noopener noreferrer" class="group-hover:text-wiki-primary transition"><h4 class="font-bold text-lg text-white leading-tight">' + majorName + '</h4></a>';
        cardHtml += '<div class="flex-shrink-0 text-right"><span class="text-xl font-bold ' + mainScoreColor + '">' + mainScore + '</span><span class="text-xs text-wiki-muted ml-0.5">' + mainScoreLabel + '</span></div>';
        cardHtml += '</div>';

        if (fieldCategory) {
            var fieldCategoryKr = {engineering:'ê³µí•™',natural_science:'ìì—°ê³¼í•™',social_science:'ì‚¬íšŒê³¼í•™',humanities:'ì¸ë¬¸í•™',arts:'ì˜ˆìˆ /ì²´ìœ¡',medical:'ì˜ì•½/ë³´ê±´',education:'êµìœ¡',business:'ê²½ì˜/ê²½ì œ',law:'ë²•í•™',agriculture:'ë†ë¦¼/ìˆ˜ì‚°',general:'ê¸°íƒ€'}[fieldCategory] || fieldCategory;
            cardHtml += '<div class="text-xs text-wiki-muted mb-1.5">' + fieldCategoryKr + '</div>';
        }
        if (displayDescription) {
            cardHtml += '<p class="text-[14px] text-wiki-muted line-clamp-2 leading-relaxed mb-2">' + displayDescription + '</p>';
        }
        cardHtml += matchingTagsHtml;
        cardHtml += '</div>';

        // ì ìˆ˜ ë°”
        cardHtml += '<div class="flex items-center gap-3 mt-3 pt-2.5" style="border-top: 1px solid rgba(255,255,255,0.06);">';
        cardHtml += '<div class="flex-1"><div class="flex items-center justify-between mb-1"><span class="text-[11px] text-emerald-400/80 font-medium">Fit</span><span class="text-[11px] text-emerald-400 font-semibold">' + fitScore + '</span></div><div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);"><div class="h-full rounded-full transition-all" style="width: ' + Math.min(fitNum, 100) + '%; background: rgb(52,211,153);"></div></div></div>';
        cardHtml += '<div class="flex-1"><div class="flex items-center justify-between mb-1"><span class="text-[11px] text-purple-400/80 font-medium">Like</span><span class="text-[11px] text-purple-400 font-semibold">' + likeScore + '</span></div><div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);"><div class="h-full rounded-full transition-all" style="width: ' + Math.min(likeNum2, 100) + '%; background: rgb(168,85,247);"></div></div></div>';
        cardHtml += '<div class="flex-1"><div class="flex items-center justify-between mb-1"><span class="text-[11px] text-blue-400/80 font-medium">Can</span><span class="text-[11px] text-blue-400 font-semibold">' + canScore + '</span></div><div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);"><div class="h-full rounded-full transition-all" style="width: ' + Math.min(canNum2, 100) + '%; background: rgb(96,165,250);"></div></div></div>';
        if (parseInt(bgScore) > 0) {
            cardHtml += '<div class="flex-1"><div class="flex items-center justify-between mb-1"><span class="text-[11px] text-amber-400/80 font-medium">Bg</span><span class="text-[11px] text-amber-400 font-semibold">' + bgScore + '</span></div><div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);"><div class="h-full rounded-full transition-all" style="width: ' + Math.min(parseInt(bgScore) || 0, 100) + '%; background: rgb(251,191,36);"></div></div></div>';
        }
        cardHtml += '</div>';

        cardHtml += '</div></div>'; // close flex items-stretch + info div

        // í•˜ë‹¨: ì¶”ì²œ ì´ìœ 
        if (reasonOuterHtml) {
            cardHtml += '<div class="px-4 pb-4 pt-0"><div class="p-3 rounded-xl space-y-2" style="background: rgba(99,102,241,0.06); border: 1px solid rgba(99,102,241,0.1);">' + reasonOuterHtml + '</div></div>';
        }

        // í•˜ë‹¨ ì•¡ì…˜ ë°”
        cardHtml += '<div class="flex items-center justify-between px-4 pb-3 ' + (reasonOuterHtml ? '' : 'pt-0') + '">';
        cardHtml += '<button onclick="event.stopPropagation(); toggleMajorScoresCompact(this)" class="text-[13px] text-wiki-muted hover:text-wiki-primary transition flex items-center gap-1.5" title="ìƒì„¸ ì ìˆ˜"><i class="fas fa-chart-bar"></i><span>ìƒì„¸ ì ìˆ˜</span></button>';
        if (majorSlug) {
            cardHtml += '<a href="/major/' + majorSlug + '" target="_blank" rel="noopener noreferrer" class="text-[13px] text-wiki-primary hover:text-indigo-300 font-medium transition flex items-center gap-1"><span>ìƒì„¸ ë³´ê¸°</span><i class="fas fa-arrow-right text-[11px]"></i></a>';
        }
        cardHtml += '</div>';

        // ì ìˆ˜ ìƒì„¸ (ê¸°ë³¸ ìˆ¨ê¹€)
        cardHtml += '<div class="score-details-compact hidden px-4 pb-3"><div class="p-3 rounded-lg" style="background-color: rgba(26,26,46,0.5);">';
        cardHtml += getScoreExplanationMajor(likeScore, canScore, fitScore, bgScore);
        cardHtml += '</div></div>';

        cardHtml += '</div>'; // close card

        return cardHtml;
    }).join('');
}

// ============================================
// Score Explanation (Major - no risk_penalty)
// ============================================
function getScoreExplanationMajor(likeVal, canVal, fitVal, bgVal) {
    var like = parseInt(likeVal) || 0;
    var can = parseInt(canVal) || 0;
    var fit = parseInt(fitVal) || 0;
    var bg = parseInt(bgVal) || 0;
    var html = '<div class="space-y-2.5 text-[13px]">';
    html += '<div class="flex items-center justify-between"><span class="text-purple-400">ğŸ’œ í¥ë¯¸(Like)</span><span class="text-purple-300 font-medium">' + like + 'ì </span></div>';
    html += '<div class="flex items-center justify-between"><span class="text-blue-400">ğŸ’ª ì—­ëŸ‰(Can)</span><span class="text-blue-300 font-medium">' + can + 'ì </span></div>';
    if (bg > 0) {
        html += '<div class="flex items-center justify-between"><span class="text-amber-400">ğŸ“ ë°°ê²½(Background)</span><span class="text-amber-300 font-medium">' + bg + 'ì </span></div>';
    }
    html += '<div class="border-t border-wiki-border/30 pt-2 mt-1 flex items-center justify-between"><span class="text-emerald-400 font-medium">= ì í•©ë„(Fit)</span><span class="text-emerald-400 font-bold text-base">' + fit + 'ì </span></div>';
    html += '</div>';
    return html;
}

// ============================================
// Toggle Major Scores (compact)
// ============================================
function toggleMajorScoresCompact(btn) {
    var card = btn.closest('.rounded-2xl');
    if (!card) return;
    var details = card.querySelector('.score-details-compact');
    if (details) {
        details.classList.toggle('hidden');
    }
}
window.toggleMajorScoresCompact = toggleMajorScoresCompact;

        // ============================================
        // ì…ë ¥ ìˆ˜ì • / ë‚´ìš© ì¶”ê°€ (ì „ê³µ ë¦¬í¬íŠ¸ í•˜ë‹¨)
        // ============================================
        function showEditWarningModal() {
            document.getElementById('edit-warning-modal')?.classList.remove('hidden');
        }
        function hideEditWarningModal() {
            document.getElementById('edit-warning-modal')?.classList.add('hidden');
        }
        function navigateToEditMode() {
            if (!currentSessionId) { alert('ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const params = new URLSearchParams({
                session_id: currentSessionId,
                edit_mode: 'true',
            });
            if (currentRequestId) params.set('source_request_id', String(currentRequestId));
            window.location.href = '/analyzer/major?' + params.toString();
        }
        function showAddContextModal() {
            document.getElementById('add-context-modal')?.classList.remove('hidden');
        }
        function hideAddContextModal() {
            document.getElementById('add-context-modal')?.classList.add('hidden');
            const textarea = document.getElementById('additional-context-text');
            if (textarea) textarea.value = '';
            updateContextCharCount();
        }
        function updateContextCharCount() {
            const textarea = document.getElementById('additional-context-text');
            if (!textarea) return;
            const count = textarea.value.length;
            const countEl = document.getElementById('context-char-count');
            if (countEl) countEl.textContent = count + ' / ìµœì†Œ 30ì';
            const btn = document.getElementById('submit-context-btn');
            if (btn) btn.disabled = count < 30;
        }
        document.getElementById('additional-context-text')?.addEventListener('input', updateContextCharCount);

        async function submitAdditionalContext() {
            const textarea = document.getElementById('additional-context-text');
            const text = textarea ? textarea.value.trim() : '';
            if (text.length < 30) return;
            if (!currentRequestId) { alert('ë¶„ì„ ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const btn = document.getElementById('submit-context-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì¬ë¶„ì„ ì¤‘...';
            }

            try {
                const res = await fetch('/api/ai-analyzer/add-context', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: currentRequestId, additional_text: text })
                });
                const data = await res.json();
                if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.success && data.new_request_id) {
                    window.location.href = '/user/ai-results/' + data.new_request_id;
                } else {
                    alert('ì¬ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    if (btn) { btn.disabled = false; btn.innerHTML = 'ì¶”ê°€ í›„ ì¬ë¶„ì„'; }
                }
            } catch (err) {
                alert('ì¬ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                if (btn) { btn.disabled = false; btn.innerHTML = 'ì¶”ê°€ í›„ ì¬ë¶„ì„'; }
            }
        }

        // ============================================
        // ê³µìœ  ê¸°ëŠ¥ (ì „ê³µ)
        // ============================================
        let _shareUrlMajor = null;
        let _shareTokenMajor = null;

        async function shareReportMajor() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('request_id') || urlParams.get('view') || currentRequestId;
            if (!requestId) { alert('ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            try {
                const res = await fetch('/api/ai-analyzer/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: parseInt(requestId) }),
                });
                const json = await res.json();
                if (!json.success) {
                    alert(json.error || 'ê³µìœ  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                _shareUrlMajor = json.share_url;
                _shareTokenMajor = json.token;

                // ê¸€ë¡œë²Œ ê³µìœ  ëª¨ë‹¬ ì—´ê¸°
                var ogImage = json.share_url + '/og.png';
                if (window.__openShareModal) {
                    window.__openShareModal(json.share_url, 'AIê°€ ë¶„ì„í•œ ë‚˜ì˜ ì „ê³µ ì ì„±', ogImage);
                } else {
                    // fallback: í´ë¦½ë³´ë“œ ë³µì‚¬
                    try {
                        await navigator.clipboard.writeText(json.share_url);
                        alert('ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } catch(e) {
                        prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', json.share_url);
                    }
                }
            } catch (err) {
                alert('ê³µìœ  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayConfidenceUI(result) {
            const card = document.getElementById('confidence-card');
            if (!card) return;

            // confidence_score ê³„ì‚°
            let confidenceScore = result?.confidence_score;
            if (confidenceScore === undefined) {
                const answeredCount = Object.keys(universalAnswers).length + 
                                     Object.keys(transitionSignalAnswers).length + 
                                     Object.keys(followupAnswers).length;
                confidenceScore = Math.min(0.4 + (answeredCount * 0.06), 0.95);
            }
            
            const percentage = Math.round(confidenceScore * 100);
            
            document.getElementById('confidence-score-text').textContent = percentage + '%';
            document.getElementById('confidence-bar').style.width = percentage + '%';
            
            let description = '';
            if (percentage >= 80) {
                description = 'ì¶©ë¶„í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ ë¢°ë„ ë†’ì€ ì¶”ì²œì´ì—ìš”.';
            } else if (percentage >= 60) {
                description = 'ê¸°ë³¸ì ì¸ ì¶”ì²œì€ ê°€ëŠ¥í•˜ì§€ë§Œ, ë” ë§ì€ ì •ë³´ê°€ ìˆìœ¼ë©´ ì •í™•ë„ê°€ ì˜¬ë¼ê°€ìš”.';
            } else {
                description = 'ì œí•œëœ ì •ë³´ë¡œ ì¶”ì²œí–ˆì–´ìš”. ì¶”ê°€ ì§ˆë¬¸ì— ë‹µë³€í•˜ì‹œë©´ ë” ì •í™•í•´ì ¸ìš”.';
            }
            document.getElementById('confidence-description').textContent = description;
            
            // ê²°ì • ë³€ìˆ˜
            const keyDecisions = result?.key_decision_variables || generateKeyDecisions();
            const decisionsHtml = keyDecisions.map(kd => \`
                <div class="flex items-start gap-3 p-2 bg-wiki-bg/50 rounded-lg">
                    <span class="text-amber-400">â€¢</span>
                    <div class="flex-1">
                        <span class="text-sm">\${kd.label || kd.fact_key || kd}</span>
                    </div>
                </div>
            \`).join('');
            document.getElementById('key-decisions').innerHTML = decisionsHtml || '<p class="text-wiki-muted text-sm">ê²°ì • ë³€ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            card.classList.remove('hidden');
        }
        
        function generateKeyDecisions() {
            const decisions = [];
            
            if (careerState.role_identity) {
                const opt = ROLE_IDENTITY_OPTIONS.find(o => o.value === careerState.role_identity);
                decisions.push({ label: 'í˜„ì¬ ìƒíƒœ: ' + (opt?.label || careerState.role_identity) });
            }
            if (careerState.transition_status && careerState.transition_status.length > 0) {
                const MAJOR_TR_LABELS = { first_choice: 'ì²« ì „ê³µ ì„ íƒ', exploring: 'ì—¬ëŸ¬ ì „ê³µ íƒìƒ‰', major_change: 'ì „ê³¼/ì „ê³µ ë³€ê²½', career_linked: 'ëª©í‘œ ì§ì—… ì—°ê³„', double_major: 'ë³µìˆ˜ì „ê³µ/ë¶€ì „ê³µ', undecided: 'ì•„ì§ ëª¨ë¥´ê² ì–´ìš”' };
                const labels = (Array.isArray(careerState.transition_status) ? careerState.transition_status : [careerState.transition_status]).map(v => MAJOR_TR_LABELS[v] || v);
                decisions.push({ label: 'ì „ê³µ ì„ íƒ ìƒí™©: ' + labels.join(', ') });
            }
            if (universalAnswers.univ_interest?.length > 0) {
                decisions.push({ label: 'ê´€ì‹¬ ë¶„ì•¼: ' + universalAnswers.univ_interest.slice(0, 3).join(', ') });
            }
            if (universalAnswers.univ_priority) {
                decisions.push({ label: 'ìš°ì„ ìˆœìœ„: ' + universalAnswers.univ_priority });
            }
            if (transitionSignalAnswers.trans_motivation) {
                decisions.push({ label: 'ë³€í™” ë™ê¸°: ' + transitionSignalAnswers.trans_motivation });
            }
            
            return decisions.slice(0, 5);
        }
        
        function resetAnalysis() {
            currentStep = 1;
            selectedStage = null;
            universalAnswers = {};
            followupAnswers = {};
            transitionSignalAnswers = {};
            careerState = { role_identity: null, career_stage_years: null, transition_status: null, skill_level: null, constraints: {} };
            
            document.querySelectorAll('.axis-btn, .constraint-btn, .chip-btn, .radio-btn, .trans-chip, .trans-radio, .trans-checkbox').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'ring-emerald-400', 'ring-amber-400', 'bg-wiki-primary/10', 'bg-emerald-400/10', 'bg-amber-400/10', 'border-wiki-primary', 'border-emerald-400', 'border-amber-400');
            });
            
            document.getElementById('step1-next-btn').disabled = true;
            goToStep(1);
        }
        
        // ìë™ ë³µì› ê¸°ëŠ¥ (ëª¨ë‹¬ ì‚¬ìš©) - ì „ê³µìš©
        let pendingDraft = null;
        let pendingServerDraft = null;
        
        async function autoRestoreDraft() {
            try {
                // 1. ì„œë²„ì—ì„œ ì§„í–‰ì¤‘ì¸ draft í™•ì¸ (major íƒ€ì…, ìºì‹œ ë°©ì§€!)
                const serverResponse = await fetch('/api/ai-analyzer/draft/load?_t=' + Date.now(), {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-store',  // ë¸Œë¼ìš°ì € ìºì‹œ ì™„ì „ ë¬´ì‹œ
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const serverData = await serverResponse.json();
                
                if (serverResponse.ok && serverData.found && serverData.draft && serverData.draft.analysis_type === 'major') {
                    const serverDraft = serverData.draft;
                    pendingServerDraft = serverDraft;

                    const stepNamesMap = { 1: 'í”„ë¡œí•„', 2: 'í”„ë¡œí•„', 3: 'í”„ë¡œí•„', 4: 'ì‹¬ì¸µ ì§ˆë¬¸', 5: 'ê²°ê³¼' };
                    const savedDate = new Date(serverDraft.updated_at);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' +
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('continue-modal-info').innerHTML =
                        '<strong class="text-white">' + (stepNamesMap[serverDraft.current_step] || 'í”„ë¡œí•„') + '</strong>ê¹Œì§€ ì§„í–‰ë¨<br>' +
                        '<span class="text-xs">ë§ˆì§€ë§‰ ì‘ì—…: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal';
                }
                
                // ì„œë²„ì— major draftê°€ ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ì •ë¦¬
                if (serverResponse.ok && !serverData.found) {
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                    return false;
                }
                
                // 2. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸ (ì„œë²„ ì˜¤ë¥˜ ì‹œ í´ë°±)
                const draftStr = localStorage.getItem('analyzer_draft_major');
                const timestamp = localStorage.getItem('analyzer_draft_major_timestamp');
                
                if (!draftStr) return false;
                
                const savedTime = parseInt(timestamp, 10);
                if (Date.now() - savedTime > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                    return false;
                }
                
                const draft = JSON.parse(draftStr);
                pendingDraft = draft;

                if (draft.currentStep >= 1) {
                    const stepNamesMap = { 1: 'í”„ë¡œí•„', 2: 'í”„ë¡œí•„', 3: 'í”„ë¡œí•„', 4: 'ì‹¬ì¸µ ì§ˆë¬¸', 5: 'ê²°ê³¼' };
                    const savedDate = new Date(savedTime);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' +
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('continue-modal-info').innerHTML =
                        '<strong class="text-white">' + (stepNamesMap[draft.currentStep] || 'í”„ë¡œí•„') + '</strong>ê¹Œì§€ ì§„í–‰ë¨<br>' +
                        '<span class="text-xs">ë§ˆì§€ë§‰ ì‘ì—…: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal';
                }
                
                return false;
            } catch (e) {
                return false;
            }
        }
        
        // ì´ì–´ì„œ í•˜ê¸°
        function continueFromDraft() {
            if (pendingServerDraft) {
                const draft = pendingServerDraft;
                currentSessionId = draft.session_id;
                
                if (draft.step1_answers?.careerState || draft.career_state) {
                    Object.assign(careerState, draft.step1_answers?.careerState || draft.career_state);
                }
                if (draft.step2_answers) {
                    universalAnswers = draft.step2_answers;
                }
                if (draft.step3_answers) {
                    transitionSignalAnswers = draft.step3_answers;
                }
                // step4_answers í†µí•© êµ¬ì¡°ì—ì„œ ê°œë³„ í•„ë“œ ì¶”ì¶œ
                if (draft.step4_answers && typeof draft.step4_answers === 'object' && Object.keys(draft.step4_answers).length > 0) {
                    const step4Data = draft.step4_answers;
                    window.roundAnswers = Array.isArray(step4Data.round_answers) ? step4Data.round_answers : [];
                    if (step4Data.narrative_facts) window.narrativeFacts = step4Data.narrative_facts;
                    if (step4Data.narrative_questions) window.savedNarrativeQuestions = step4Data.narrative_questions;
                    if (step4Data.round_questions) window.roundQuestions = step4Data.round_questions;
                    if (step4Data.current_round > 0) window.currentRound = step4Data.current_round;
                } else {
                    // í•˜ìœ„í˜¸í™˜: step4_answersê°€ ë¹„ì–´ìˆìœ¼ë©´ top-level í•„ë“œì—ì„œ ë³µì›
                    if (Array.isArray(draft.round_answers) && draft.round_answers.length > 0) {
                        window.roundAnswers = draft.round_answers;
                    }
                    if (draft.narrative_facts) {
                        window.narrativeFacts = draft.narrative_facts;
                    }
                    if (draft.saved_narrative_questions) {
                        window.savedNarrativeQuestions = draft.saved_narrative_questions;
                    }
                    if (draft.current_round > 0) {
                        window.currentRound = draft.current_round;
                    }
                }
                if (draft.step1_answers?.stage) {
                    selectedStage = draft.step1_answers.stage;
                }
                if (draft.step1_answers?.studentType) {
                    studentType = draft.step1_answers.studentType;
                }
                if (draft.step1_answers?.academicState) {
                    window.academicState = draft.step1_answers.academicState;
                }

                // mini_module_result ë³µì›
                if (draft.mini_module_result) {
                    window.miniModuleResult = draft.mini_module_result;
                }

                document.getElementById('continue-modal').classList.remove('hidden');
                document.getElementById('continue-modal').classList.add('hidden');

                setTimeout(() => {
                    updateStep1Selection();
                    // í•˜ìœ„ì˜µì…˜ UI ë³µì›
                    if (studentType === 'high' || studentType === 'univ') {
                        const subContainer = document.getElementById('student-sub-options');
                        if (subContainer) {
                            subContainer.innerHTML = studentType === 'high' ? renderHighSubOptions() : renderUnivSubOptions();
                            subContainer.classList.remove('hidden');
                            // í•˜ìœ„ì˜µì…˜ ì„ íƒ ìƒíƒœ ë³µì›
                            const savedAcademicState = window.academicState;
                            if (savedAcademicState) {
                                const subBtn = subContainer.querySelector('[data-value="' + savedAcademicState + '"]');
                                if (subBtn) {
                                    subBtn.classList.remove('border-wiki-border/50', 'text-wiki-muted');
                                    subBtn.classList.add('border-cyan-500', 'bg-cyan-500/20', 'text-white');
                                }
                            }
                            // ëŒ€í•™ìƒ í•˜ìœ„: selectedStageë¡œ ë³µì›
                            if (studentType === 'univ' && selectedStage) {
                                const stageToValue = { major_freshman: 'freshman', major_student: 'current', major_graduate: 'graduate' };
                                const subVal = stageToValue[selectedStage];
                                if (subVal) {
                                    const subBtn = subContainer.querySelector('[data-value="' + subVal + '"]');
                                    if (subBtn) {
                                        subBtn.classList.remove('border-wiki-border/50', 'text-wiki-muted');
                                        subBtn.classList.add('border-cyan-500', 'bg-cyan-500/20', 'text-white');
                                    }
                                }
                            }
                        }
                    }
                    // Step 2 (ì‹¬ì¸µ ì§ˆë¬¸) ë³µì›
                    if (draft.current_step >= 2 && window.currentRound > 0) {
                        setTimeout(() => {
                            if (typeof startV3RoundQuestions === 'function') {
                                startV3RoundQuestions(window.currentRound);
                            }
                        }, 300);
                    }
                }, 200);

                // ê¸°ì¡´ 5ë‹¨ê³„ â†’ 3ë‹¨ê³„ ë§¤í•‘: old 1â†’1, old 2-3â†’1, old 4â†’2, old 5â†’3
                const mappedStep = draft.current_step <= 3 ? 1 : draft.current_step === 4 ? 2 : 3;
                goToStep(mappedStep, true);
                pendingServerDraft = null;
                return;
            }
            
            if (!pendingDraft) return;
            
            if (pendingDraft.collectedCareerState) {
                Object.assign(careerState, pendingDraft.collectedCareerState);
            }
            if (pendingDraft.universalAnswers) {
                universalAnswers = pendingDraft.universalAnswers;
            }
            if (pendingDraft.narrativeAnswers) {
                transitionSignalAnswers = pendingDraft.narrativeAnswers;
            }
            if (pendingDraft.roundAnswers) {
                window.roundAnswers = pendingDraft.roundAnswers;
            }
            if (pendingDraft.selectedStage) {
                selectedStage = pendingDraft.selectedStage;
            }
            
            document.getElementById('continue-modal').classList.add('hidden');
            
            setTimeout(() => {
                updateStep1Selection();
            }, 200);

            // ê¸°ì¡´ 5ë‹¨ê³„ â†’ 3ë‹¨ê³„ ë§¤í•‘
            const mappedStep = pendingDraft.currentStep <= 3 ? 1 : pendingDraft.currentStep === 4 ? 2 : 3;
            goToStep(mappedStep, true);
            pendingDraft = null;
        }
        
        // ìƒˆë¡œ ì‹œì‘ ê²½ê³  í‘œì‹œ
        function showRestartWarning() {
            document.getElementById('restart-warning-modal').classList.remove('hidden');
        }
        
        // ìƒˆë¡œ ì‹œì‘ ê²½ê³  ìˆ¨ê¸°ê¸°
        function hideRestartWarning() {
            document.getElementById('restart-warning-modal').classList.add('hidden');
        }

        // ì €ì¥ ë²„íŠ¼ ë¦¬ì…‹ (ë‚´ìš© ë³€ê²½ ì‹œ í˜¸ì¶œ)
        function resetSaveButtons() {
            document.querySelectorAll('[id$="-save-btn"]').forEach(btn => {
                if (btn.dataset.saved === 'true') {
                    btn.innerHTML = '<i class="fas fa-save mr-2 text-emerald-400"></i>ì„ì‹œì €ì¥';
                    btn.dataset.saved = 'false';
                    window.analyzerUnsavedChanges = true;
                }
            });
        }

        // beforeunload í•¸ë“¤ëŸ¬ (ì €ì¥ í™•ì¸)
        window.addEventListener('beforeunload', (e) => {
            if (window.analyzerUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                return e.returnValue;
            }
        });

        // ì„œë²„ì— ìë™ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ, UI ì—…ë°ì´íŠ¸ ì—†ìŒ)
        async function saveDraftToServer() {
            try {
                // ì„¸ì…˜ ID í™•ë³´
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // ìµœì‹  ë‹µë³€ ìˆ˜ì§‘
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function'
                    ? collectUniversalAnswers()
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};

                // ì„œìˆ í˜• ì‹¬ì¸µ ì§ˆë¬¸ í˜„ì¬ ê°’ ìˆ˜ì§‘
                const narrativeQ0 = document.getElementById('narrative_q0');
                const narrativeQ1 = document.getElementById('narrative_q1');
                const narrativeQ2 = document.getElementById('narrative_q2');
                const narrativeCareerBg = document.getElementById('narrative_career_bg');
                if (narrativeQ0 || narrativeQ1 || narrativeQ2) {
                    const currentQuestions = typeof getNarrativeQuestionsMajor === 'function' ? getNarrativeQuestionsMajor() : null;
                    window.narrativeFacts = {
                        storyAnswer: narrativeQ0?.value || '',
                        life_story: narrativeQ0?.value || '',
                        question1Answer: narrativeQ1?.value || '',
                        question2Answer: narrativeQ2?.value || '',
                        highAliveMoment: narrativeQ1?.value || '',
                        lostMoment: narrativeQ2?.value || '',
                        career_background: narrativeCareerBg?.value || '',
                    };
                    if (currentQuestions) {
                        window.savedNarrativeQuestions = currentQuestions;
                    }
                }

                // step4_answers í†µí•© ë°ì´í„°
                const step4Data = {
                    round_answers: window.roundAnswers || [],
                    narrative_facts: window.narrativeFacts || null,
                    narrative_questions: window.savedNarrativeQuestions || null,
                    round_questions: window.roundQuestions || null,
                    current_round: window.currentRound || 0
                };

                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: 'major',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,
                    current_round: window.currentRound || 0,
                    career_state: careerState || {},
                    step1_answers: {
                        stage: selectedStage,
                        studentType: studentType,
                        academicState: window.academicState || null,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 1,
                        currentRound: window.currentRound || 0
                    },
                    mini_module_result: window.miniModuleResult || null,
                    mini_module_selections: typeof miniModuleSelections !== 'undefined' ? miniModuleSelections : null,
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: step4Data,
                    narrative_facts: window.narrativeFacts || null,
                    round_answers: window.roundAnswers || [],
                    saved_narrative_questions: window.savedNarrativeQuestions || null,
                };
                
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false;
                }
            } catch (error) {
            }
        }

        // ê²°ê³¼ ë„ë‹¬ ì‹œ ì„œë²„ì— ì™„ë£Œ ìƒíƒœ ì €ì¥ (major)
        async function saveDraftAsCompletedMajor() {
            if (!currentSessionId) return;
            
            try {
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: 'major',
                    current_step: 3,  // majorëŠ” step 3ì´ ê²°ê³¼
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 2,
                        completed: true
                    },
                    mini_module_result: window.miniModuleResult || null
                };
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false;
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                }
            } catch (error) {
            }
        }
        
        // ìƒˆë¡œ ì‹œì‘ í™•ì •
        async function confirmRestart() {
            
            // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ
            localStorage.removeItem('analyzer_draft_major');
            localStorage.removeItem('analyzer_draft_major_timestamp');
            
            // 2. ì„œë²„ì˜ ëª¨ë“  draft ì‚­ì œ (ë‹¤ë¥¸ ì„¸ì…˜ í¬í•¨)
            try {
                const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const result = await response.json();
                } else {
                }
            } catch (e) {
            }
            
            // 3. ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('restart-warning-modal').classList.add('hidden');
            document.getElementById('continue-modal').classList.add('hidden');
            
            // 4. ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            pendingDraft = null;
            pendingServerDraft = null;
            currentSessionId = '';  // ì„¸ì…˜ ID ì´ˆê¸°í™”
            careerState = { role_identity: null, career_stage_years: null, transition_status: null, skill_level: null, constraints: {} };
            universalAnswers = {};
            transitionSignalAnswers = {};
            window.roundAnswers = [];
            selectedStage = '';
            
            // 5. Step 1ë¶€í„° ì‹œì‘
            goToStep(1);
        }
        
        // Step 1 UI ë³µì›
        function updateStep1Selection() {
            // 5ì¶• ì¢Œí‘œ UI ë³µì› (ê°„ë‹¨ ë²„ì „)
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            renderCareerStateForm();

            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('session_id');

            // ============================================
            // í¸ì§‘ ëª¨ë“œ ì´ˆê¸°í™” (Major)
            // ============================================
            const urlEditMode = urlParams.get('edit_mode') === 'true';
            const urlSourceRequestId = urlParams.get('source_request_id');

            if (urlSessionId && urlEditMode && urlSourceRequestId) {
                const serverDraft = await loadDraftFromServer(urlSessionId);
                if (!serverDraft) {
                    alert('ì›ë³¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = '/user/ai-results';
                    return;
                }

                const editSessionId = 'edit-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                // Draft ì ìš©
                currentSessionId = editSessionId;
                if (serverDraft.step1_answers?.careerState || serverDraft.career_state) {
                    Object.assign(careerState, serverDraft.step1_answers?.careerState || serverDraft.career_state);
                }
                if (serverDraft.step2_answers) {
                    universalAnswers = serverDraft.step2_answers;
                }
                if (serverDraft.step3_answers) {
                    transitionSignalAnswers = serverDraft.step3_answers;
                }
                if (serverDraft.step1_answers?.stage) {
                    selectedStage = serverDraft.step1_answers.stage;
                }

                // í¸ì§‘ ëª¨ë“œ ì „ì—­ ìƒíƒœ
                window.__editMode = true;
                window.__originalSessionId = urlSessionId;
                window.__editSessionId = editSessionId;
                window.__sourceRequestId = parseInt(urlSourceRequestId, 10);

                // ë³€ê²½ ê°ì§€ìš© ìŠ¤ëƒ…ìƒ·
                window.__editSnapshot = {
                    careerState: JSON.stringify(careerState),
                    universalAnswers: JSON.stringify(universalAnswers),
                    transitionSignalAnswers: JSON.stringify(transitionSignalAnswers),
                    narrativeFacts: JSON.stringify(window.narrativeFacts || {}),
                    roundAnswers: JSON.stringify(window.roundAnswers || []),
                };

                // UI ë³µì› + ë°°ë„ˆ
                setTimeout(() => {
                    updateStep1Selection();
                    showEditModeBanner();
                }, 200);

                goToStep(1);
                return;
            }

            if (urlSessionId) {
                const serverDraft = await loadDraftFromServer(urlSessionId);
                if (serverDraft) {
                    currentSessionId = serverDraft.session_id;
                    if (serverDraft.step1_answers?.careerState || serverDraft.career_state) {
                        Object.assign(careerState, serverDraft.step1_answers?.careerState || serverDraft.career_state);
                    }
                    setTimeout(() => updateStep1Selection(), 200);
                    // ê¸°ì¡´ 5ë‹¨ê³„ â†’ 3ë‹¨ê³„ ë§¤í•‘
                    const ms = serverDraft.current_step <= 3 ? 1 : serverDraft.current_step === 4 ? 2 : 3;
                    goToStep(ms, true);
                    return;
                }
            }

            // ì €ì¥ëœ ë¦¬í¬íŠ¸ ë·° ëª¨ë“œ í™•ì¸ (?view=requestId)
            const viewResultId = urlParams.get('view');
            if (viewResultId) {
                showLoading('ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
                try {
                    const res = await fetch('/api/ai-analyzer/saved-result/' + viewResultId);
                    if (!res.ok) {
                        hideLoading();
                        console.error('[view] API error:', res.status, res.statusText);
                        showErrorToastMajor('ê²°ê³¼ API ì˜¤ë¥˜: ' + res.status);
                        goToStep(1);
                    } else {
                        const data = await res.json();
                        hideLoading();
                        if (data.success && data.result) {
                            currentRequestId = data.request_id;
                            // mini_module_result ë³µì› (í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ ë Œë”ì— í•„ìš”)
                            if (data.result.mini_module_result) {
                                window.miniModuleResult = data.result.mini_module_result;
                            }
                            try {
                                displayResults({ result: data.result, request_id: data.request_id });
                            } catch (renderErr) {
                                console.error('[view] displayResults error:', renderErr);
                                showErrorToastMajor('ë¦¬í¬íŠ¸ ë Œë”ë§ ì‹¤íŒ¨: ' + renderErr.message);
                            }
                            goToStep(3);
                        } else {
                            console.error('[view] API returned:', data);
                            showErrorToastMajor('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (data.error || 'unknown'));
                            goToStep(1);
                        }
                    }
                } catch (e) {
                    hideLoading();
                    console.error('[view] Exception:', e);
                    showErrorToastMajor('ê²°ê³¼ ë¡œë”© ì‹¤íŒ¨: ' + (e.message || e));
                    goToStep(1);
                }
            } else {
            const restoredStep = await autoRestoreDraft();
            if (restoredStep === 'modal') {
                goToStep(1);
            } else {
                goToStep(1);
            }
            }

            // ì…ë ¥ ë³€ê²½ ê°ì§€ - ì €ì¥ ë²„íŠ¼ ë¦¬ì…‹ (ì €ì¥ ë²„íŠ¼ ìì²´ ì œì™¸)
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('[id$="-save-btn"]') || target.closest('#analyze-btn')) return;
                if (target.closest('.student-option, .role-card, .career-stage-btn, .goal-chip, .skill-btn, .constraint-option, .trans-chip, .trans-radio, .radio-option, .trans-checkbox')) {
                    resetSaveButtons();
                }
            });
            document.addEventListener('input', (e) => {
                if (e.target.matches('input, textarea, select')) {
                    resetSaveButtons();
                }
            });
        });
        
        async function loadDraftFromServer(sessionId) {
            try {
                const response = await fetch('/api/ai-analyzer/draft/load?session_id=' + sessionId, {
                    method: 'GET', credentials: 'same-origin'
                });
                const data = await response.json();
                return response.ok && data.found ? data.draft : null;
            } catch (e) {
                return null;
            }
        }
    </script>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI ì „ê³µ ì¶”ì²œ - Careerwiki'))
})

// Community Guidelines Help Page
app.get('/help/community-guidelines', (c) => {
  const policy = resolveCommentPolicy()
  const governanceItems = buildCommentGovernanceItems(policy)
  const overviewList = governanceItems
    .map((item) => `<li class="flex gap-2 text-sm text-wiki-muted leading-relaxed"><i class="fas fa-check-circle text-wiki-secondary mt-0.5" aria-hidden="true"></i><span>${escapeHtml(item)}</span></li>`)
    .join('')
  const bestDetails = [
    `ì¢‹ì•„ìš” ${policy.bestLikeThreshold}ê°œ ì´ìƒì´ë©´ BESTë¡œ ìŠ¹ê²©ë©ë‹ˆë‹¤.`,
    `BEST ì˜ì—­ì€ ìµœëŒ€ ${policy.bestLimit}ê±´ìœ¼ë¡œ ìœ ì§€ë˜ë©° ìƒˆë¡œìš´ BESTê°€ ë“±ë¡ë˜ë©´ ë§¤ì¼ ê°±ì‹ ë©ë‹ˆë‹¤.`,
    'BEST ëŒ“ê¸€ì€ ëª©ë¡ ìƒë‹¨ì— ê³ ì •ë˜ì–´ ëˆ„êµ¬ë‚˜ ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')
  const reportDetails = [
    `ì‹ ê³  ${policy.reportBlindThreshold}íšŒ ì´ìƒ ì‹œ ëŒ“ê¸€ì´ ìë™ìœ¼ë¡œ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ë©ë‹ˆë‹¤.`,
    policy.moderatorIpBlockEnabled
      ? 'ëª¨ë”ë ˆì´í„°ëŠ” ì‹ ê³ ê°€ ëˆ„ì ëœ IPë¥¼ ì°¨ë‹¨í•˜ì—¬ ì•…ì„± í™œë™ì„ ì„ ì œì ìœ¼ë¡œ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
      : null,
    `ëª¨ë”ë ˆì´í„° ê¶Œí•œ ê³„ì¸µ: ${policy.moderatorRoles.join(' > ')}`
  ]
    .filter(Boolean)
    .map((item) => `<li>${escapeHtml(String(item))}</li>`)
    .join('')
  const voteDetails = [
    'ê³µê°/ë¹„ê³µê°ì€ ë¡œê·¸ì¸ ì—†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹ ê³ ëŠ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.',
    'ì—¬ëŸ¬ ëŒ“ê¸€ì— ê³µê°/ë¹„ê³µê°ì„ í‘œì‹œí•˜ëŠ” ê²ƒì€ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
    'ë‹¨, í•œ ëŒ“ê¸€ì—ëŠ” ê³µê° ë˜ëŠ” ë¹„ê³µê° ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    'ìì‹ ì´ ì‘ì„±í•œ ëŒ“ê¸€ì—ëŠ” ê³µê°/ë¹„ê³µê°ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
    'ë¹„ê³µê°ì„ ë‚¨ë°œí•˜ê±°ë‚˜ ì§‘ë‹¨ì ìœ¼ë¡œ íŠ¹ì • ëŒ“ê¸€ì„ ê³µê²©í•˜ë©´ ì œì¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')

  const commentRules = [
    'ëŒ“ê¸€ì€ ìµœëŒ€ 500ìê¹Œì§€ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    'ë‹µê¸€ì€ ìµœëŒ€ 3ë‹¨ê³„ê¹Œì§€ ë‹¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    'ìµëª… ëŒ“ê¸€ ì‘ì„± ì‹œ 4ìë¦¬ ìˆ«ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì•¼ í•˜ë©°, ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”í•©ë‹ˆë‹¤.',
    'ìµëª… ì‚¬ìš©ìëŠ” í•˜ë£¨ ìµœëŒ€ 5ê°œì˜ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    'ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± íšŸìˆ˜ ì œí•œì´ ì—†ìœ¼ë©°, ìµëª…ìœ¼ë¡œë„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.',
    'ìš•ì„¤, ë¹„ë°©, ê´‘ê³ ì„± ëŒ“ê¸€ì€ ìë™ í•„í„°ë§ë˜ê±°ë‚˜ ì œì¬ ëŒ€ìƒì´ ë©ë‹ˆë‹¤.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')

  const canonicalUrl = buildCanonicalUrl(c.req.url, '/help/community-guidelines')
  const content = `
    <div class="max-w-[1400px] mx-auto px-4 pb-10">
      <section class="space-y-10">
      <header class="mb-8 space-y-3">
        <div class="flex items-center gap-2 text-xs text-blue-300 font-semibold uppercase tracking-[0.2em]">
          <i class="fas fa-users-gear"></i><span>ì»¤ë®¤ë‹ˆí‹° ì´ìš© ì •ì±…</span>
        </div>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h1 class="text-3xl md:text-4xl font-bold text-white">ì»¤ë®¤ë‹ˆí‹° ì´ìš© ì •ì±…</h1>
          <p class="text-wiki-muted text-[15px]">Careerwiki ëŒ“ê¸€ ì»¤ë®¤ë‹ˆí‹° ìš´ì˜ ì›ì¹™</p>
        </div>
      </header>
      <section class="grid gap-6 md:grid-cols-2">
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">ê¸°ë³¸ ìš´ì˜ ì›ì¹™</h2>
          <ul class="space-y-3">${overviewList}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">ëŒ“ê¸€ ì‘ì„± ê·œì¹™</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${commentRules}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">BEST ëŒ“ê¸€ ì •ì±…</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${bestDetails}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">ì‹ ê³  &amp; ëª¨ë”ë ˆì´ì…˜</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${reportDetails}</ul>
          <p class="text-xs text-wiki-muted/80">ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ ì´í›„ ëª¨ë”ë ˆì´í„° ê²€í† ì—ì„œ ë³µêµ¬ ë˜ëŠ” ì œì¬ ì—¬ë¶€ê°€ í™•ì •ë©ë‹ˆë‹¤.</p>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4 md:col-span-2">
          <h2 class="text-lg font-semibold text-wiki-text">ê³µê°/ë¹„ê³µê° ì •ì±…</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${voteDetails}</ul>
        </article>
      </section>
      <section class="glass-card p-6 rounded-xl space-y-4">
        <h2 class="text-lg font-semibold text-wiki-text">ìƒí˜¸ì‘ìš© íë¦„ ìš”ì•½</h2>
        <ol class="space-y-2 text-sm text-wiki-muted list-decimal pl-5">
          <li>ë¡œê·¸ì¸ ì—†ì´ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìµëª… ì‘ì„± ì‹œ 4ìë¦¬ ìˆ«ì ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•˜ë©°, í•˜ë£¨ ìµœëŒ€ 5ê°œê¹Œì§€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± íšŸìˆ˜ ì œí•œ ì—†ì´ ììœ ë¡­ê²Œ ì‘ì„±í•  ìˆ˜ ìˆìœ¼ë©°, ì›í•˜ë©´ ìµëª…ìœ¼ë¡œë„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ë‹µê¸€ì€ ìµœëŒ€ 3ë‹¨ê³„ê¹Œì§€ ë‹¬ ìˆ˜ ìˆìœ¼ë©°, ëŒ“ê¸€ í•œ ê±´ë‹¹ ìµœëŒ€ 500ìê¹Œì§€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>ì¢‹ì•„ìš” ${policy.bestLikeThreshold}ê°œ ì´ìƒì„ ë°›ì€ ëŒ“ê¸€ì€ BESTë¡œ ìŠ¹ê²©ë˜ì–´ ëª©ë¡ ìƒë‹¨ì— ê³ ì •ë©ë‹ˆë‹¤.</li>
          <li>ì‹ ê³  ${policy.reportBlindThreshold}íšŒ ì´ìƒ ëˆ„ì  ì‹œ ìë™ìœ¼ë¡œ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ë˜ë©°, ëª¨ë”ë ˆì´í„°ê°€ ìµœì¢… ê²€í† í•©ë‹ˆë‹¤.</li>
        </ol>
        <p class="text-xs text-wiki-muted">ì •ì±…ì€ ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë©°, ë³€ê²½ ì‚¬í•­ì€ ì´ í˜ì´ì§€ì— ë¨¼ì € ë°˜ì˜ë©ë‹ˆë‹¤.</p>
      </section>
      <footer class="text-xs text-wiki-muted">
        <p>ì •ì±… ê´€ë ¨ ë¬¸ì˜ëŠ” <a href="mailto:contact@careerwiki.org" class="text-wiki-primary hover:text-wiki-secondary">contact@careerwiki.org</a>ë¡œ ì—°ë½í•´ ì£¼ì„¸ìš”.</p>
      </footer>
      </section>
    </div>
  `

  return c.html(
    renderLayoutWithContext(c,
      content,
      'ì»¤ë®¤ë‹ˆí‹° ì´ìš© ì •ì±… - Careerwiki',
      'Careerwiki ëŒ“ê¸€ ì»¤ë®¤ë‹ˆí‹° ìš´ì˜ ì›ì¹™ê³¼ BEST/ì‹ ê³ /ê³µê° ì •ì±… ì•ˆë‚´',
      false,
      { canonical: canonicalUrl, ogUrl: canonicalUrl }
    )
  )
})

// Job Template Design Page
app.get('/job-template-design', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // ë³€í˜¸ì‚¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const jobRow = await db.prepare(`
      SELECT id, name FROM jobs WHERE name = 'ë³€í˜¸ì‚¬' LIMIT 1
    `).first<{ id: string; name: string }>()

    if (!jobRow) {
      c.status(404)
      return c.text('ë³€í˜¸ì‚¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ETL ì‹œë”©ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.')
    }

    // job_sources ê°€ì ¸ì˜¤ê¸°
    // job_idë¡œ ë¨¼ì € ì‹œë„
    let sources = await db.prepare(`
      SELECT * FROM job_sources WHERE job_id = ?
    `).bind(jobRow.id).all<JobSourceRow>()
    
    // job_idê°€ nullì¸ ê²½ìš° ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­ (ë” ì •í™•í•˜ê²Œ)
    if (!sources.results || sources.results.length === 0) {
      
      // JSON_EXTRACTë¡œ ì§ì ‘ ë§¤ì¹­ (SQLite ì§€ì›)
      // normalized_payloadì™€ raw_payload ëª¨ë‘ í™•ì¸
      try {
        sources = await db.prepare(`
          SELECT * FROM job_sources 
          WHERE JSON_EXTRACT(normalized_payload, '$.name') = ?
             OR JSON_EXTRACT(raw_payload, '$.dJobNm') = ?
             OR JSON_EXTRACT(raw_payload, '$.jobNm') = ?
             OR JSON_EXTRACT(raw_payload, '$.duty.job_nm') = ?
        `).bind(jobRow.name, jobRow.name, jobRow.name, jobRow.name).all<JobSourceRow>()
      } catch (e) {
        // JSON_EXTRACT ì•ˆë˜ë©´ ì „ì²´ ê²€ìƒ‰
        const allSources = await db.prepare(`
          SELECT * FROM job_sources WHERE normalized_payload LIKE ? OR raw_payload LIKE ?
        `).bind(`%"name":"${jobRow.name}"%`, `%"${jobRow.name}"%`).all<JobSourceRow>()
        
        const matchedSources = allSources.results?.filter(source => {
          try {
            const normalized = JSON.parse(source.normalized_payload || '{}')
            const raw = JSON.parse(source.raw_payload || '{}')
            return normalized.name === jobRow.name || 
                   raw.dJobNm === jobRow.name || 
                   raw.jobNm === jobRow.name ||
                   raw.duty?.job_nm === jobRow.name
          } catch {
            return false
          }
        }) || []
        
        sources = { results: matchedSources, success: true, meta: allSources.meta }
      }
    }
    

    if (!sources.results || sources.results.length === 0) {
      c.status(404)
      return c.text('ë³€í˜¸ì‚¬ì˜ ì†ŒìŠ¤ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    }

    const html = renderJobTemplateDesignPage(jobRow.name, sources.results)
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// Job Merge Designer Page (ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë³‘í•© ê·œì¹™ ì„¤ê³„)
app.get('/job-template-design2', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // ì‹¤ì œ DBì— ìˆëŠ” ì§ì—…ë“¤ì˜ ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë‹¤ì–‘í•œ ì˜ˆì‹œ í™•ë³´)
    // ê° ì†ŒìŠ¤ ì‹œìŠ¤í…œì—ì„œ ê· ë“±í•˜ê²Œ ìƒ˜í”Œë§
    // SQLiteì—ì„œëŠ” UNION ALL ì•ˆì˜ ê° SELECTì— ORDER BYë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„œë¸Œì¿¼ë¦¬ë¡œ ê°ì‹¸ì•¼ í•¨
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM (
        -- ì»¤ë¦¬ì–´ë„· ìƒ˜í”Œ (20ê°œ)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'CAREERNET' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- ê³ ìš©24 ì§ì—…ì •ë³´ ìƒ˜í”Œ (20ê°œ)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'WORK24_JOB' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- ê³ ìš©24 ì§ì—…ì‚¬ì „ ìƒ˜í”Œ (20ê°œ)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'WORK24_DJOB' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
      ) js
      LEFT JOIN jobs j ON js.job_id = j.id
    `).all<JobSourceRow & { job_name: string }>()


    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text('ìƒ˜í”Œ ì§ì—… ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ETL ì‹œë”©ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.')
    }

    // ì†ŒìŠ¤ë³„ë¡œ ë°ì´í„° í†µí•©
    const careernetSamples: any[] = []
    const work24JobSamples: any[] = []
    const work24DJobSamples: any[] = []

    allSources.results.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: row.job_name })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: row.job_name })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: row.job_name })
        }
      } catch (e) {
      }
    })

    const { renderJobMergeDesigner } = await import('./templates/jobMergeDesigner')
    const html = renderJobMergeDesigner(careernetSamples, work24JobSamples, work24DJobSamples)
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// ì§ì—…ë³„ ë””ìì´ë„ˆ í˜ì´ì§€: /job-template-design2/:slug
app.get('/job-template-design2/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slugë¡œ ì§ì—… ì°¾ê¸°
    const job = await db.prepare(`
      SELECT id, name, slug FROM jobs WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string }>()
    
    if (!job) {
      c.status(404)
      return c.text(`ì§ì—… "${slug}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // í•´ë‹¹ ì§ì—…ì˜ ëª¨ë“  ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM job_sources js
      LEFT JOIN jobs j ON js.job_id = j.id
      WHERE (
        js.job_id = ?
        OR JSON_EXTRACT(js.normalized_payload, '$.name') = ?
        OR (js.source_system = 'WORK24_DJOB' AND JSON_EXTRACT(js.raw_payload, '$.dJobNm') = ?)
        OR (js.source_system = 'WORK24_JOB' AND JSON_EXTRACT(js.raw_payload, '$.jobNm') = ?)
      )
    `).bind(job.id, job.name, job.name, job.name).all<JobSourceRow & { job_name: string }>()


    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`ì§ì—… "${job.name}"ì˜ ì†ŒìŠ¤ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // ë‹¤ë¥¸ ì§ì—…ë“¤ì˜ ì˜ˆì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ ì§ì—…ì— ì—†ëŠ” í•„ë“œìš©)
    // ê° ì†ŒìŠ¤ë³„ë¡œ ê· ë“±í•˜ê²Œ ìƒ˜í”Œë§í•˜ì—¬ ëª¨ë“  í•„ë“œì— ì˜ˆì‹œ ë°ì´í„°ê°€ ìˆë„ë¡ í•¨
    const otherSamples = await db.prepare(`
      SELECT source_system, raw_payload, job_name FROM (
        -- CAREERNET ìƒ˜í”Œ 15ê°œ
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.normalized_payload, '$.name')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'CAREERNET'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, raw_payload, job_name FROM (
        -- WORK24_JOB ìƒ˜í”Œ 15ê°œ
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.raw_payload, '$.jobNm')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'WORK24_JOB'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, raw_payload, job_name FROM (
        -- WORK24_DJOB ìƒ˜í”Œ 20ê°œ (í•„ë“œê°€ ë§ì•„ì„œ ë” ë§ì´)
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.raw_payload, '$.dJobNm')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'WORK24_DJOB'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 20
      )
    `).bind(job.id, job.id, job.id).all<{ source_system: string; raw_payload: string; job_name: string }>()

    // ì†ŒìŠ¤ë³„ë¡œ ë°ì´í„° í†µí•©
    const careernetSamples: any[] = []
    const work24JobSamples: any[] = []
    const work24DJobSamples: any[] = []

    // í˜„ì¬ ì§ì—… ë°ì´í„° ì¶”ê°€ (ìš°ì„  í‘œì‹œ)
    allSources.results.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        }
      } catch (e) {
      }
    })

    // ë‹¤ë¥¸ ì§ì—… ì˜ˆì‹œ ë°ì´í„° ì¶”ê°€ (ì˜ˆì‹œìš©)
    otherSamples.results?.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: `[ì˜ˆì‹œ] ${row.job_name}`, _isCurrentJob: false })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: `[ì˜ˆì‹œ] ${row.job_name}`, _isCurrentJob: false })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: `[ì˜ˆì‹œ] ${row.job_name}`, _isCurrentJob: false })
        }
      } catch (e) {
      }
    })

    const { renderJobMergeDesigner } = await import('./templates/jobMergeDesigner')
    const html = renderJobMergeDesigner(
      careernetSamples,
      work24JobSamples,
      work24DJobSamples,
      job.name,
      job.slug
    )
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// Major Merge Designer Page (ì „ê³µ ë°ì´í„° í•„ë“œ ë³‘í•© ê·œì¹™ ì„¤ê³„)
app.get('/major-template-design', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // ì‹¤ì œ DBì— ìˆëŠ” ì „ê³µë“¤ì˜ ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const allSources = await db.prepare(`
      SELECT ms.*, 
             COALESCE(
               m.name,
               JSON_EXTRACT(ms.normalized_payload, '$.name'),
               JSON_EXTRACT(ms.raw_payload, '$.major'),
               JSON_EXTRACT(ms.raw_payload, '$.majorName')
             ) as major_name
      FROM (
        -- ì»¤ë¦¬ì–´ë„· ìƒ˜í”Œ (20ê°œ)
        SELECT * FROM (
          SELECT * FROM major_sources 
          WHERE source_system = 'CAREERNET' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- ê³ ìš©24 í•™ê³¼ì •ë³´ ìƒ˜í”Œ (20ê°œ)
        SELECT * FROM (
          SELECT * FROM major_sources 
          WHERE source_system = 'WORK24_MAJOR' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
      ) ms
      LEFT JOIN majors m ON ms.major_id = m.id
    `).all<MajorSourceRow & { major_name: string }>()


    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text('ìƒ˜í”Œ ì „ê³µ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ETL ì‹œë”©ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.')
    }

    // ì†ŒìŠ¤ë³„ë¡œ ë°ì´í„° í†µí•©
    const careernetSamples: any[] = []
    const work24MajorSamples: any[] = []

    // normalized_payload ì‚¬ìš© (ë³‘í•© ë¡œì§ê³¼ ë™ì¼í•œ í•„ë“œëª… í‘œì‹œ)
    allSources.results.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: row.major_name })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: row.major_name })
        }
      } catch (e) {
      }
    })

    const { renderMajorMergeDesigner } = await import('./templates/majorMergeDesigner')
    const html = renderMajorMergeDesigner(careernetSamples, work24MajorSamples)
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// ì „ê³µë³„ ë””ìì´ë„ˆ í˜ì´ì§€: /major-template-design/:slug
app.get('/major-template-design/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slugë¡œ ì „ê³µ ì°¾ê¸°
    const major = await db.prepare(`
      SELECT id, name, slug FROM majors WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string }>()
    
    if (!major) {
      c.status(404)
      return c.text(`ì „ê³µ "${slug}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // í•´ë‹¹ ì „ê³µì˜ ëª¨ë“  ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const allSources = await db.prepare(`
      SELECT ms.*, 
             COALESCE(
               m.name,
               JSON_EXTRACT(ms.normalized_payload, '$.name'),
               JSON_EXTRACT(ms.raw_payload, '$.major'),
               JSON_EXTRACT(ms.raw_payload, '$.majorName')
             ) as major_name
      FROM major_sources ms
      LEFT JOIN majors m ON ms.major_id = m.id
      WHERE (
        ms.major_id = ?
        OR JSON_EXTRACT(ms.normalized_payload, '$.name') = ?
        OR JSON_EXTRACT(ms.raw_payload, '$.major') = ?
        OR JSON_EXTRACT(ms.raw_payload, '$.majorName') = ?
      )
    `).bind(major.id, major.name, major.name, major.name).all<MajorSourceRow & { major_name: string }>()


    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`ì „ê³µ "${major.name}"ì˜ ì†ŒìŠ¤ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // ë‹¤ë¥¸ ì „ê³µë“¤ì˜ ì˜ˆì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (normalized_payload ì‚¬ìš©)
    const otherSamples = await db.prepare(`
      SELECT source_system, normalized_payload, major_name FROM (
        SELECT ms.source_system, ms.normalized_payload,
               COALESCE(m.name, JSON_EXTRACT(ms.normalized_payload, '$.name')) as major_name
        FROM major_sources ms
        LEFT JOIN majors m ON ms.major_id = m.id
        WHERE ms.source_system = 'CAREERNET'
          AND ms.major_id != ?
          AND ms.normalized_payload IS NOT NULL 
          AND ms.normalized_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, normalized_payload, major_name FROM (
        SELECT ms.source_system, ms.normalized_payload,
               COALESCE(m.name, JSON_EXTRACT(ms.normalized_payload, '$.name')) as major_name
        FROM major_sources ms
        LEFT JOIN majors m ON ms.major_id = m.id
        WHERE ms.source_system = 'WORK24_MAJOR'
          AND ms.major_id != ?
          AND ms.normalized_payload IS NOT NULL 
          AND ms.normalized_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
    `).bind(major.id, major.id).all<{ source_system: string; normalized_payload: string; major_name: string }>()

    // ì†ŒìŠ¤ë³„ë¡œ ë°ì´í„° í†µí•©
    const careernetSamples: any[] = []
    const work24MajorSamples: any[] = []

    // í˜„ì¬ ì „ê³µ ë°ì´í„° ì¶”ê°€ (ìš°ì„  í‘œì‹œ) - normalized_payload ì‚¬ìš©
    allSources.results.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: row.major_name, _isCurrentMajor: true })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: row.major_name, _isCurrentMajor: true })
        }
      } catch (e) {
      }
    })

    // ë‹¤ë¥¸ ì „ê³µì˜ ì˜ˆì‹œ ë°ì´í„° ì¶”ê°€ (í•„ë“œ ì˜ˆì‹œìš©) - normalized_payload ì‚¬ìš©
    otherSamples.results?.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        const displayName = `[ì˜ˆì‹œ] ${row.major_name}`
        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: displayName, _isCurrentMajor: false })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: displayName, _isCurrentMajor: false })
        }
      } catch (e) {
        // Skip invalid JSON
      }
    })

    const { renderMajorMergeDesigner } = await import('./templates/majorMergeDesigner')
    const html = renderMajorMergeDesigner(
      careernetSamples, 
      work24MajorSamples,
      major.name,
      major.slug
    )
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// ETL ë³‘í•© ë¡œì§ ì ê²€ í˜ì´ì§€: /job-template-design3/:slug
app.get('/job-template-design3/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slugë¡œ ì§ì—… ì°¾ê¸°
    const job = await db.prepare(`
      SELECT id, name, slug, merged_profile_json FROM jobs WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string; merged_profile_json: string | null }>()
    
    if (!job) {
      c.status(404)
      return c.text(`ì§ì—… "${slug}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // í•´ë‹¹ ì§ì—…ì˜ ëª¨ë“  ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM job_sources js
      LEFT JOIN jobs j ON js.job_id = j.id
      WHERE (
        js.job_id = ?
        OR JSON_EXTRACT(js.normalized_payload, '$.name') = ?
        OR (js.source_system = 'WORK24_DJOB' AND JSON_EXTRACT(js.raw_payload, '$.dJobNm') = ?)
        OR (js.source_system = 'WORK24_JOB' AND JSON_EXTRACT(js.raw_payload, '$.jobNm') = ?)
      )
    `).bind(job.id, job.name, job.name, job.name).all<JobSourceRow & { job_name: string }>()


    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`ì§ì—… "${job.name}"ì˜ ì†ŒìŠ¤ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
    }

    // Merged profile íŒŒì‹±
    let mergedProfile: UnifiedJobDetail | null = null
    if (job.merged_profile_json) {
      try {
        mergedProfile = JSON.parse(job.merged_profile_json) as UnifiedJobDetail
      } catch (e) {
      }
    }

    const html = renderJobETLInspectionPage(
      job.name,
      job.id,
      allSources.results,
      mergedProfile
    )
    return c.html(html)
  } catch (error) {
    c.status(500)
    return c.text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// ë¡œê·¸ì¸ í˜ì´ì§€ (Google OAuthë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
app.get('/login', (c) => {
  const queryRedirect = c.req.query('redirect')
  const referer = c.req.header('Referer')
  const loginError = c.req.query('error')
  let redirect = queryRedirect || '/'

  // Refererê°€ ìˆê³  ë‚´ë¶€ URLì´ë©´ ì‚¬ìš©
  if (!queryRedirect && referer) {
    try {
      const refererUrl = new URL(referer)
      const currentUrl = new URL(c.req.url)
      // ê°™ì€ ë„ë©”ì¸ì´ë©´ Referer ì‚¬ìš©
      if (refererUrl.origin === currentUrl.origin && refererUrl.pathname !== '/login') {
        redirect = refererUrl.pathname + refererUrl.search
      }
    } catch (e) {
      // URL íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
    }
  }

  const user = getOptionalUser(c)

  // ì´ë¯¸ ë¡œê·¸ì¸í•œ ê²½ìš° ë¦¬ë‹¤ì´ë ‰íŠ¸
  if (user) {
    return c.redirect(redirect)
  }

  const errorMsg = loginError === '1' ? 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
    : loginError === '2' ? 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
    : ''

  const content = `
    <div class="min-h-[60vh] flex items-center justify-center px-4 pt-16 md:pt-0">
      <div class="max-w-md w-full">
        <div class="bg-wiki-card/60 border border-wiki-border/40 rounded-2xl p-8 text-center backdrop-blur-sm">
          <!-- ë¡œê³ /ì•„ì´ì½˜ -->
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-primary/10 mb-6">
            <i class="fas fa-user-circle text-3xl text-wiki-primary"></i>
          </div>

          <h1 class="text-2xl font-bold text-white mb-2">ë¡œê·¸ì¸</h1>
          <p class="text-wiki-muted mb-6">ê³„ì†í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”</p>

          <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
          <a href="/auth/google?return_url=${encodeURIComponent(redirect)}"
             class="flex items-center justify-center gap-3 w-full px-6 py-3.5 bg-white hover:bg-gray-50 text-gray-800 font-medium rounded-xl transition shadow-sm">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Googleë¡œ ê³„ì†í•˜ê¸°</span>
          </a>

          <!-- êµ¬ë¶„ì„  -->
          <div class="flex items-center gap-3 my-6">
            <div class="flex-1 h-px bg-wiki-border/40"></div>
            <span class="text-xs text-wiki-muted">ë˜ëŠ”</span>
            <div class="flex-1 h-px bg-wiki-border/40"></div>
          </div>

          <!-- í…ŒìŠ¤íŠ¸ ê³„ì • ë¡œê·¸ì¸ -->
          <form method="POST" action="/auth/test-login" class="text-left">
            <input type="hidden" name="redirect" value="${redirect.replace(/"/g, '&quot;')}" />

            <div class="space-y-3">
              <div>
                <label class="block text-xs text-wiki-muted mb-1.5">ì•„ì´ë””</label>
                <input type="text" name="id" autocomplete="username"
                  class="w-full px-4 py-2.5 bg-wiki-bg/80 border border-wiki-border/50 rounded-lg text-white text-sm placeholder-wiki-muted/60 focus:border-wiki-primary focus:outline-none transition"
                  placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
              </div>
              <div>
                <label class="block text-xs text-wiki-muted mb-1.5">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" name="pw" autocomplete="current-password"
                  class="w-full px-4 py-2.5 bg-wiki-bg/80 border border-wiki-border/50 rounded-lg text-white text-sm placeholder-wiki-muted/60 focus:border-wiki-primary focus:outline-none transition"
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
              </div>
            </div>

            ${errorMsg ? `
              <p class="mt-3 text-xs text-red-400 text-center">
                <i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}
              </p>
            ` : ''}

            <button type="submit"
              class="w-full mt-4 px-6 py-2.5 bg-wiki-primary hover:bg-wiki-primary/80 text-white font-medium rounded-lg transition text-sm">
              ë¡œê·¸ì¸
            </button>
          </form>

          <p class="text-xs text-wiki-muted mt-6 leading-relaxed">
            ë¡œê·¸ì¸í•˜ë©´ <a href="/terms" class="text-wiki-primary hover:underline py-1 inline-block">ì´ìš©ì•½ê´€</a> ë°
            <a href="/privacy" class="text-wiki-primary hover:underline py-1 inline-block">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•˜ê²Œ ë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
  `
  
  return c.html(
    renderLayoutWithContext(c,
      content,
      'ë¡œê·¸ì¸ - Careerwiki',
      'Careerwikiì— ë¡œê·¸ì¸í•˜ì„¸ìš”'
    )
  )
})

// ì´ìš©ì•½ê´€ í˜ì´ì§€ (ë ˆê±°ì‹œ URL â†’ /legal/terms ë¦¬ë‹¤ì´ë ‰íŠ¸)
app.get('/terms', (c) => c.redirect('/legal/terms', 301))

// ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€ (ë ˆê±°ì‹œ URL â†’ /legal/privacy ë¦¬ë‹¤ì´ë ‰íŠ¸)
app.get('/privacy', (c) => c.redirect('/legal/privacy', 301))


// ë‚´ ì‘ì„± ê°€ì´ë“œ ëª©ë¡ í˜ì´ì§€ (ìƒˆ URL)
app.get('/user/drafts', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/drafts')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // ë‚´ ê°€ì´ë“œ ì¡°íšŒ (draft_published + published)
  const allGuidesResult = await c.env.DB.prepare(`
    SELECT id, slug, title, summary, status, created_at, updated_at
    FROM pages 
    WHERE page_type = 'guide' AND author_id = ? AND status IN ('published', 'draft_published')
    ORDER BY created_at DESC
  `).bind(user.id).all()
  const allGuides = allGuidesResult.results || []
  const draftPublished = allGuides.filter((p: any) => p.status === 'draft_published')
  const published = allGuides.filter((p: any) => p.status === 'published')
  
  // í•„í„° ì ìš©
  const showDraftPublished = filter === 'all' || filter === 'draft_published'
  const showPublished = filter === 'all' || filter === 'published'
  
  const innerContent = `
      <div class="flex items-center justify-between gap-4 mb-6">
        <p class="text-wiki-muted">ì„ì‹œ ë°œí–‰ ë° ë°œí–‰í•œ ê°€ì´ë“œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        <a href="/howto/write" class="px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition flex items-center gap-2 shrink-0 text-sm">
          <i class="fas fa-plus"></i>
          ìƒˆ ê°€ì´ë“œ ì‘ì„±
        </a>
      </div>
      
      <!-- í•„í„° íƒ­ -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4">
        <a href="/user/drafts?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          ì „ì²´ <span class="ml-1 opacity-70">(${allGuides.length})</span>
        </a>
        <a href="/user/drafts?filter=draft_published" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'draft_published' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          ì„ì‹œ ë°œí–‰ <span class="ml-1 opacity-70">(${draftPublished.length})</span>
        </a>
        <a href="/user/drafts?filter=published" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'published' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          ë°œí–‰ë¨ <span class="ml-1 opacity-70">(${published.length})</span>
        </a>
      </div>
      
        <div class="space-y-4">
        <!-- ì„ì‹œ ë°œí–‰ëœ ê°€ì´ë“œ -->
        ${showDraftPublished && draftPublished.length > 0 ? draftPublished.map((p: any) => `
          <div class="p-4 bg-wiki-card/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
            <div class="flex items-start justify-between gap-4">
              <a href="/howto/${p.slug}" class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-white group-hover:text-wiki-primary transition truncate">
                  ${escapeHtml(p.title || 'ì œëª© ì—†ìŒ')}
                </h3>
                ${p.summary ? `<p class="text-sm text-wiki-muted mt-1 line-clamp-2">${escapeHtml(p.summary)}</p>` : ''}
                <div class="flex items-center gap-3 mt-2 text-xs text-wiki-muted">
                  <span>
                    <i class="far fa-clock mr-1"></i>
                    ${p.created_at ? formatDateSafe(p.created_at) : 'ë‚ ì§œ ì—†ìŒ'}
                  </span>
                  <span class="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-400 border border-purple-500/30">
                    <i class="fas fa-eye-slash mr-1"></i>ì„ì‹œ ë°œí–‰
                  </span>
                </div>
              </a>
              <div class="flex items-center gap-2">
                <a href="/howto/${p.slug}/edit" class="p-2 text-wiki-muted hover:text-amber-400 transition" title="í¸ì§‘">
                  <i class="fas fa-edit text-sm"></i>
                </a>
                <button type="button" onclick="deletePublished(${p.id}, '${escapeHtml(p.title || 'ì œëª© ì—†ìŒ').replace(/'/g, "\\'")}', this)" class="p-2 text-wiki-muted hover:text-red-400 transition" title="ì‚­ì œ">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('') : ''}
        
        <!-- ë°œí–‰ëœ ê°€ì´ë“œ -->
        ${showPublished && published.length > 0 ? published.map((p: any) => `
          <div class="p-4 bg-wiki-card/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
            <div class="flex items-start justify-between gap-4">
              <a href="/howto/${p.slug}" class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-white group-hover:text-wiki-primary transition truncate">
                  ${escapeHtml(p.title || 'ì œëª© ì—†ìŒ')}
                </h3>
                ${p.summary ? `<p class="text-sm text-wiki-muted mt-1 line-clamp-2">${escapeHtml(p.summary)}</p>` : ''}
                <div class="flex items-center gap-3 mt-2 text-xs text-wiki-muted">
                  <span>
                    <i class="far fa-clock mr-1"></i>
                    ${p.created_at ? formatDateSafe(p.created_at) : 'ë‚ ì§œ ì—†ìŒ'}
                  </span>
                  ${p.status === 'draft_published' ? `
                    <span class="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-400 border border-purple-500/30">
                      <i class="fas fa-eye-slash mr-1"></i>ì„ì‹œ ë°œí–‰
                    </span>
                  ` : `
                    <span class="px-2 py-0.5 rounded-full bg-green-500/10 text-green-400 border border-green-500/30">
                      <i class="fas fa-check-circle mr-1"></i>ë°œí–‰ë¨
                    </span>
                  `}
                </div>
              </a>
              <div class="flex items-center gap-2">
                <a href="/howto/${p.slug}/edit" class="p-2 text-wiki-muted hover:text-amber-400 transition" title="í¸ì§‘">
                  <i class="fas fa-edit text-sm"></i>
                </a>
                <button type="button" onclick="deletePublished(${p.id}, '${escapeHtml(p.title?.replace(/'/g, "\\'") || '')}', this)" 
                        class="p-2 text-wiki-muted hover:text-red-400 transition" title="ì‚­ì œ">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('') : ''}
        
        <!-- ë¹ˆ ìƒíƒœ -->
        ${allGuides.length === 0 || (filter === 'draft_published' && draftPublished.length === 0) || (filter === 'published' && published.length === 0) ? `
          <div class="text-center py-16">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-card/50 mb-4">
              <i class="fas fa-file-alt text-2xl text-wiki-muted"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">
              ${filter === 'draft_published' ? 'ì„ì‹œ ë°œí–‰ëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤' : filter === 'published' ? 'ë°œí–‰ëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì•„ì§ ì‘ì„±í•œ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
            </h3>
            <p class="text-wiki-muted">ìœ„ì˜ "ìƒˆ ê°€ì´ë“œ ì‘ì„±" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!</p>
          </div>
        ` : ''}
        </div>
        
        <script>
          async function deleteDraft(draftId, title, btn) {
            if (!confirm('ì •ë§ "' + title + '" ì´ˆì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‚­ì œëœ ì´ˆì•ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
              return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
            
            try {
              const res = await fetch('/api/howto/drafts/' + draftId, {
                method: 'DELETE'
              });
              const data = await res.json();
              
              if (data.success) {
                const card = btn.closest('[data-draft-id]');
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';
                card.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                  card.remove();
                if (!document.querySelector('[data-draft-id]') && !document.querySelector('.space-y-4 > div:not([data-draft-id])')) {
                    location.reload();
                  }
                }, 300);
              } else {
                alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
              }
            } catch (err) {
              alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
            }
          }
        
        async function deletePublished(pageId, title, btn) {
          if (!confirm('ì •ë§ "' + title + '" ê°€ì´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‚­ì œëœ ê°€ì´ë“œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
          }
          
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
          
          try {
            const res = await fetch('/api/howto/' + pageId, {
              method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.success) {
              const card = btn.closest('.bg-wiki-card\\\\/50');
              if (card) {
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';
                card.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                  card.remove();
                  location.reload();
                }, 300);
              } else {
                location.reload();
              }
            } else {
              alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
            }
          } catch (err) {
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
          }
        }
        </script>
  `
  
  const pageContent = renderUserLayoutContent({
    title: 'ì‘ì„± ê°€ì´ë“œ',
    currentPath: '/user/drafts',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, 'ì‘ì„± ê°€ì´ë“œ - ë§ˆì´í˜ì´ì§€ - Careerwiki', 'ë‚´ ì´ˆì•ˆê³¼ ê°€ì´ë“œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤')
  )
})







const formatPerfAlertLine = (alert: PerfAlert): string => {
  const severityIcon = alert.severity === 'critical' ? 'ğŸš¨' : 'âš ï¸'
  const isScoreMetric = alert.metric.toLowerCase().includes('cls')
  const rounding = (value: number) => (isScoreMetric ? value.toFixed(2) : `${Math.round(value)}ms`)
  const contextParts: string[] = []
  if (alert.context?.page) {
    contextParts.push(`page=${alert.context.page}`)
  }
  if (alert.context?.action) {
    contextParts.push(`action=${alert.context.action}`)
  }
  if (alert.context?.category) {
    contextParts.push(`cat=${alert.context.category}`)
  }
  const contextSuffix = contextParts.length ? ` (${contextParts.join(' Â· ')})` : ''
  return `${severityIcon} ${alert.metric}: ${rounding(alert.value)} > ${rounding(alert.threshold)}${contextSuffix}`
}

const sendPerfAlertsToSlack = async (
  webhook: string,
  options: {
    alerts: PerfAlert[]
    url?: string
    reason?: string
    id: string
  }
): Promise<void> => {
  try {
    const header = options.reason ? `Perf alert (${options.reason})` : 'Perf alert detected'
    const urlLine = options.url ? `URL: ${options.url}` : null
    const lines = options.alerts.slice(0, 6).map((alert) => formatPerfAlertLine(alert))
    const bodyLines = [header, `Log ID: ${options.id}`, ...(urlLine ? [urlLine] : []), ...lines]
    const payload = { text: bodyLines.join('\n') }
    await fetch(webhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
  } catch (error) {
  }
}

// API ì—”ë“œí¬ì¸íŠ¸ë“¤

// í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ í™•ì¸ìš©)
app.get('/api/me', async (c) => {
  const user = c.get('user')
  
  if (!user) {
    return c.json({ user: null })
  }
  
  return c.json({
    user: {
      id: user.id,
      name: user.name,
      username: user.username,
      role: user.role,
      pictureUrl: user.custom_picture_url || user.picture_url || null
    }
  })
})

app.post('/api/perf-metrics', async (c) => {
  let payload: PerfMetricsPayload
  try {
    payload = await c.req.json<PerfMetricsPayload>()
  } catch (error) {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  try {
    // ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” KVê°€ ì—†ì„ ìˆ˜ ìˆìŒ
    if (!c.env.KV) {
      return c.json({
        success: true,
        data: { id: 'local-dev-skip' },
        alerts: []
      })
    }

    const rawIp = c.req.header('cf-connecting-ip') ?? null
    const ipHash = await hashIpAddress(rawIp)
    const result = await storePerfMetrics(c.env.KV, payload, { ip: ipHash ?? undefined })

    if (result.alerts && result.alerts.length && c.env.PERF_ALERT_WEBHOOK) {
      c.executionCtx.waitUntil(
        sendPerfAlertsToSlack(c.env.PERF_ALERT_WEBHOOK, {
          alerts: result.alerts,
          url: payload.url,
          reason: payload.reason,
          id: result.id
        })
      )
    }

    return c.json({
      success: true,
      data: {
        id: result.id
      },
      alerts: result.alerts ?? []
    })
  } catch (error) {
    return c.json({ success: false, error: 'failed to store metrics' }, 500)
  }
})

// Phase 3 Day 4: í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œ ë°˜í™˜ API
app.get('/api/client-ip', (c) => {
  const ipAddress = getClientIp(c)
  return c.json({ ip: ipAddress || '127.0.0.1' })
})

app.post('/api/perf-metrics', async (c) => {
  let body: PerfMetricsPayload
  try {
    body = await c.req.json<PerfMetricsPayload>()
  } catch (error) {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  try {
    // ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” KVê°€ ì—†ì„ ìˆ˜ ìˆìŒ
    if (!c.env.KV) {
      return c.json({ success: true, id: 'local-dev-skip' })
    }

    const ip = c.req.header('cf-connecting-ip') ?? undefined
    const { id } = await storePerfMetrics(c.env.KV, body, { ip })
    return c.json({ success: true, id })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'perf metrics store failed'
    const status = message === 'Invalid payload' || message === 'No metrics provided' ? 400 : 500
    return c.json({ success: false, error: message }, status)
  }
})

app.post('/api/analyzer/sessions', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!body || typeof body !== 'object') {
    return c.json({ success: false, error: 'invalid body' }, 400)
  }

  try {
    const session = await createOrUpdateSession(c.env.DB, {
      sessionId: typeof body.sessionId === 'string' ? body.sessionId : undefined,
      userIdentifier: typeof body.userIdentifier === 'string' ? body.userIdentifier : undefined,
      traitsSnapshot: body.traits ?? body.traitsSnapshot
    })

    const includeRequests = Boolean(body.includeRequests)
    const response: Record<string, unknown> = { session }

    if (includeRequests) {
      const limitInput = typeof body.requestLimit === 'number' ? Math.floor(body.requestLimit) : 10
      const limit = Number.isFinite(limitInput) ? Math.min(Math.max(limitInput, 1), 100) : 10
      const requests = await listRequestsBySession(c.env.DB, session.id, limit)
      response.requests = requests
    }

    return c.json({ success: true, data: response })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'session upsert failed'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/sessions/:id', async (c) => {
  const sessionId = c.req.param('id')
  const includeRequests = c.req.query('includeRequests') === '1'
  const limit = parseNumberParam(c.req.query('limit'), 20, { min: 1, max: 50 })

  const session = await getAiSession(c.env.DB, sessionId)
  if (!session) {
    return c.json({ success: false, error: 'session not found' }, 404)
  }

  const result: Record<string, unknown> = { session }
  if (includeRequests) {
    const requests = await listRequestsBySession(c.env.DB, sessionId, limit)
    result.requests = requests
  }

  return c.json({ success: true, data: result })
})

app.post('/api/analyzer/requests', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const sessionId = typeof body.sessionId === 'string' ? body.sessionId : ''
  const analysisType = body.analysisType
  const promptPayload = body.promptPayload

  if (!sessionId) {
    return c.json({ success: false, error: 'sessionId is required' }, 400)
  }

  if (!isAnalysisType(analysisType)) {
    return c.json({ success: false, error: 'analysisType must be "job" or "major"' }, 400)
  }

  if (promptPayload === undefined) {
    return c.json({ success: false, error: 'promptPayload is required' }, 400)
  }

  const session = await getAiSession(c.env.DB, sessionId)
  if (!session) {
    return c.json({ success: false, error: 'session not found' }, 404)
  }

  const pricingTier = isPricingTier(body.pricingTier) ? body.pricingTier : 'free'
  const initialStatus = isRequestStatus(body.status) ? body.status : 'pending'

  try {
    const request = await createAnalysisRequest(c.env.DB, {
      sessionId,
      analysisType,
      pricingTier,
      promptPayload,
      status: initialStatus
    })

    return c.json({ success: true, data: { request } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to create analysis request'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/requests/:id', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  const record = await getAnalysisRequestWithResult(c.env.DB, requestId)
  if (!record) {
    return c.json({ success: false, error: 'request not found' }, 404)
  }

  return c.json({ success: true, data: record })
})

app.post('/api/analyzer/requests/:id/result', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (typeof body.provider !== 'string' || !body.provider) {
    return c.json({ success: false, error: 'provider is required' }, 400)
  }

  if (body.responsePayload === undefined) {
    return c.json({ success: false, error: 'responsePayload is required' }, 400)
  }

  const requestStatus = body.requestStatus
  if (requestStatus !== undefined && !isRequestStatus(requestStatus)) {
    return c.json({ success: false, error: 'invalid requestStatus' }, 400)
  }

  try {
    const { request, result } = await createAnalysisResult(c.env.DB, {
      requestId,
      provider: body.provider,
      model: typeof body.model === 'string' ? body.model : null,
      completionTokens: typeof body.completionTokens === 'number' ? body.completionTokens : null,
      promptTokens: typeof body.promptTokens === 'number' ? body.promptTokens : null,
      totalTokens: typeof body.totalTokens === 'number' ? body.totalTokens : null,
      latencyMs: typeof body.latencyMs === 'number' ? body.latencyMs : null,
      responseSummary: typeof body.responseSummary === 'string' ? body.responseSummary : null,
      responsePayload: body.responsePayload,
      requestStatus
    })

    return c.json({ success: true, data: { request, result } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to store analysis result'
    return c.json({ success: false, error: message }, 500)
  }
})

app.post('/api/analyzer/requests/:id/status', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!isRequestStatus(body.status)) {
    return c.json({ success: false, error: 'invalid status' }, 400)
  }

  const processedAt = typeof body.processedAt === 'string'
    ? body.processedAt
    : (body.status === 'completed' || body.status === 'failed' ? new Date().toISOString() : null)

  try {
    const request = await updateRequestStatus(c.env.DB, requestId, body.status, processedAt)
    return c.json({ success: true, data: { request } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to update status'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/sessions/:id/requests', async (c) => {
  const sessionId = c.req.param('id')
  const limit = parseNumberParam(c.req.query('limit'), 20, { min: 1, max: 50 })
  const requests = await listRequestsBySession(c.env.DB, sessionId, limit)
  return c.json({ success: true, data: { requests } })
})

app.post('/api/serp-interactions', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!isAnalysisType(body.pageType)) {
    return c.json({ success: false, error: 'pageType must be "job" or "major"' }, 400)
  }

  if (typeof body.action !== 'string' || !body.action.trim()) {
    return c.json({ success: false, error: 'action is required' }, 400)
  }

  try {
    const record = await recordSerpInteraction(c.env.DB, {
      pageType: body.pageType,
      action: body.action,
      keywordLength: toIntegerOrNull(body.keywordLength, { min: 0 }),
      category: typeof body.category === 'string' ? body.category : null,
      perPage: toIntegerOrNull(body.perPage, { min: 1, max: 50 }),
      results: toIntegerOrNull(body.results, { min: 0, max: 500 }),
      cacheStatus: typeof body.cacheStatus === 'string' ? body.cacheStatus : null,
      durationMs: toIntegerOrNull(body.durationMs, { min: 0 }),
      sampled: typeof body.sampled === 'boolean' ? body.sampled : null,
      source: typeof body.source === 'string' ? body.source : null
    })

    return c.json({ success: true, data: { record } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to record interaction'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/serp-interactions/recent', async (c) => {
  const limit = parseNumberParam(c.req.query('limit'), 50, { min: 1, max: 200 })
  const records = await listRecentSerpInteractions(c.env.DB, limit)
  return c.json({ success: true, data: { records } })
})

app.get('/api/serp-interactions/summary', async (c) => {
  const startDate = c.req.query('startDate') || undefined
  const endDate = c.req.query('endDate') || undefined
  const pageType = c.req.query('pageType') as ('job' | 'major') | undefined
  const action = c.req.query('action') || undefined
  const limit = parseNumberParam(c.req.query('limit'), 50, { min: 1, max: 200 })

  const summaries = await getDailySerpSummary(c.env.DB, {
    startDate,
    endDate,
    pageType,
    action,
    limit
  })

  return c.json({ success: true, data: { summaries } })
})

app.get('/api/freshness/status', async (c) => {
  try {
    const status = await getFreshnessStatus(c.env.KV)
    return c.json({
      success: true,
      data: status
    })
  } catch (error) {
    return c.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'freshness status fetch failed'
      },
      500
    )
  }
})

app.post('/api/freshness/run', async (c) => {
  try {
    let body: { targetId?: string; force?: boolean; reason?: string } = {}
    try {
      body = await c.req.json<{ targetId?: string; force?: boolean; reason?: string }>()
    } catch {
      body = {}
    }

    const targetId = body.targetId || c.req.query('targetId')
    if (!targetId) {
      return c.json({ success: false, error: 'targetId required' }, 400)
    }

    const target = resolveFreshnessTargetById(targetId)
    if (!target) {
      return c.json({ success: false, error: 'unknown targetId' }, 404)
    }

    const result = await attemptScheduledRefresh(c.env.KV, c.env, target, {
      force: body.force ?? c.req.query('force') === '1',
      reason: body.reason || 'manual-trigger'
    })

    return c.json({
      success: result.outcome === 'success',
      result
    })
  } catch (error) {
    return c.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'freshness run failed'
      },
      500
    )
  }
})

// í•™ê³¼ì •ë³´ ê²€ìƒ‰ API
app.get('/api/majors', async (c) => {
  try {
    const mark = c.get('mark') as ((k: string) => void) | undefined
    mark?.('parse-query')
    const keyword = c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 8, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const dataVersion = 'v1'
    const seed = `${TEMPLATE_VERSIONS.MAJOR}:${dataVersion}:${toNFC(keyword)}:${page}:${perPage}`
    const etag = weakETag(seed)
    const inm = c.req.header('If-None-Match')
    const hasMatch = matchETag(inm, etag)
    if (hasMatch) {
      c.header('ETag', etag)
      c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
      c.header('X-Cache-Status', 'HIT')
      return c.body(null, 304)
    }

    mark?.('build-sql')
    const result = await searchUnifiedMajors({
      keyword,
      page,
      perPage,
      includeSources
    }, c.env)
    mark?.('db-read')

    mark?.('post-filter')
    mark?.('serialize')
    // logging removed per request
    c.header('ETag', etag)
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'í•™ê³¼ ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨'
    }, 500)
  }
})

// í•™ê³¼ ê²€ìƒ‰ API (ë³„ë„ ì—”ë“œí¬ì¸íŠ¸) - :id ë¼ìš°íŠ¸ë³´ë‹¤ ë¨¼ì € ì •ì˜í•´ì•¼ í•¨
app.get('/api/majors/search', async (c) => {
  try {
    const q = c.req.query('q') || c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const sort = c.req.query('sort') || 'relevance'
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    // RAG ê²€ìƒ‰ (ë²¡í„° + LIKE í´ë°±)
    const result = await ragSearchMajors(c.env, q, { page, perPage })

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword: q,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'í•™ê³¼ ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨'
    }, 500)
  }
})

// í•™ê³¼ ìƒì„¸ ì •ë³´ API
app.get('/api/majors/:id', async (c) => {
  try {
    const id = c.req.param('id')
    let userContributedJson: any = {}
    const careernetId = c.req.query('careernetId') || undefined
    const goyongMajorGb = c.req.query('goyongMajorGb') as ('1' | '2') | undefined
    const goyongDepartmentId = c.req.query('goyongDepartmentId') || undefined
    const goyongMajorId = c.req.query('goyongMajorId') || undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const goyongParams = goyongMajorGb && goyongDepartmentId && goyongMajorId
      ? {
          majorGb: goyongMajorGb as '1' | '2',
          departmentId: goyongDepartmentId,
          majorId: goyongMajorId
        }
      : undefined

    const result = await getUnifiedMajorDetail(
      {
        id,
        careernetId,
        goyong24Params: goyongParams,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: 'í•™ê³¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'í•™ê³¼ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨'
    }, 500)
  }
})

// ì§ì—…ì •ë³´ ê²€ìƒ‰ API
app.get('/api/jobs', async (c) => {
  try {
    const mark = c.get('mark') as ((k: string) => void) | undefined
    mark?.('parse-query')
    const keyword = c.req.query('keyword') || ''
    const category = c.req.query('category') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 8, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const dataVersion = 'v1'
    const seed = `${TEMPLATE_VERSIONS.JOB}:${dataVersion}:${toNFC(keyword)}:${page}:${perPage}:${category}`
    const etag = weakETag(seed)
    const inm = c.req.header('If-None-Match')
    const hasMatch = matchETag(inm, etag)
    if (hasMatch) {
      c.header('ETag', etag)
      c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
      c.header('X-Cache-Status', 'HIT')
      return c.body(null, 304)
    }

    mark?.('build-sql')
    const result = await searchUnifiedJobs({
      keyword,
      category,
      page,
      perPage,
      includeSources
    }, c.env)
    mark?.('db-read')

    mark?.('post-filter')
    mark?.('serialize')
    // logging removed per request
    c.header('ETag', etag)
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        category,
        page,
        perPage
      },
      categories: JOB_CATEGORIES
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'ì§ì—… ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨'
    }, 500)
  }
})

// ì§ì—… ê²€ìƒ‰ API (ë³„ë„ ì—”ë“œí¬ì¸íŠ¸) - :id ë¼ìš°íŠ¸ë³´ë‹¤ ë¨¼ì € ì •ì˜í•´ì•¼ í•¨
app.get('/api/jobs/search', async (c) => {
  try {
    const q = c.req.query('q') || c.req.query('keyword') || ''
    const category = c.req.query('category') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const sort = c.req.query('sort') || 'relevance'
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    // RAG ê²€ìƒ‰ (ë²¡í„° + LIKE í´ë°±)
    const result = await ragSearchJobs(c.env, q, { page, perPage })

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword: q,
        category,
        page,
        perPage
      },
      categories: JOB_CATEGORIES
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'ì§ì—… ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨'
    }, 500)
  }
})

// ì§ì—… ìƒì„¸ ì •ë³´ API
app.get('/api/jobs/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const careernetId = c.req.query('careernetId') || undefined
    const goyongJobId = c.req.query('goyongJobId') || undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await getUnifiedJobDetail(
      {
        id,
        careernetId,
        goyong24JobId: goyongJobId || undefined,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: 'ì§ì—… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'ì§ì—… ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨'
    }, 500)
  }
})

// í¸ì§‘ ëª¨ë“œìš© ë°ì´í„° ì¡°íšŒ API (ì‹¤ì œ ë Œë”ë§ì— ì‚¬ìš©ë˜ëŠ” ë°ì´í„° ë°˜í™˜)
app.get('/api/job/:id/edit-data', async (c) => {
  try {
    // ìºì‹œ ë°©ì§€ (í¸ì§‘ ì§í›„ ìµœì‹  ë°ì´í„° ë³´ì¥)
    c.header('Cache-Control', 'no-store')
    c.header('Pragma', 'no-cache')
    c.header('Expires', '0')

    const id = c.req.param('id')
    let userContributedJson: any = {}
    
    const result = await getUnifiedJobDetailWithRawData(
      {
        id,
        careernetId: undefined,
        goyong24JobId: undefined,
        includeSources: ['CAREERNET', 'GOYONG24']
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: 'ì§ì—… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      }, 404)
    }

    const profile = result.profile
    const careernetSummary = result.partials?.CAREERNET?.summary
    const goyong24Summary = result.partials?.GOYONG24?.summary
    const heroDescription =
      (profile as any).heroSummary ||
      (profile.summary || careernetSummary || goyong24Summary)?.split('\n')[0]?.trim() ||
      ''
    let rawApiData = result.rawApiData || { careernet: null, goyong24: null }
    
    // í—¬í¼ í•¨ìˆ˜: ë°°ì—´ì—ì„œ ì´ë¦„/í…ìŠ¤íŠ¸ ì¶”ì¶œ (í•µì‹¬ ì—­ëŸ‰, ì ì„±, í¥ë¯¸, ê´€ë ¨í•™ê³¼, êµìœ¡ê³¼ì •, ì§„ë¡œíƒìƒ‰ ë“±)
    const extractListItems = (list: any[] | null | undefined): string[] => {
      if (!list || !Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          // ETLì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í•„ë“œëª… ì§€ì›
          return (
            item?.name || 
            item?.majorNm ||           // ê³ ìš©24 ê´€ë ¨í•™ê³¼
            item?.depart_name ||       // ì»¤ë¦¬ì–´ë„· ê´€ë ¨í•™ê³¼
            item?.curriculum ||        // ì •ê·œêµìœ¡ê³¼ì •
            item?.research ||          // ì§„ë¡œíƒìƒ‰í™œë™
            item?.recruit ||           // ì±„ìš©ì •ë³´
            item?.training ||          // í•„ìš” êµìœ¡/í›ˆë ¨
            item?.certificate ||       // ìê²©ì¦
            item?.ability_name ||      // ì»¤ë¦¬ì–´ë„· í•µì‹¬ì—­ëŸ‰
            item?.aptitude || 
            item?.interest || 
            item?.ability || 
            item?.text || 
            item?.value || 
            ''
          ).trim()
        })
        .filter(Boolean)
    }
    
    // í—¬í¼ í•¨ìˆ˜: detailReady ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì±„ìš©ì •ë³´, êµìœ¡í›ˆë ¨ ë“±)
    // í…œí”Œë¦¿ì˜ extractReadyItemê³¼ ë™ì¼í•œ ë¡œì§
    const extractReadyListItems = (list: any[] | null | undefined, key: string): string[] => {
      if (!list || !Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          if (item && typeof item === 'object') {
            return (item[key] || item.name || item.value || item.title || '').trim()
          }
          return ''
        })
        .filter(Boolean)
    }
    
    // ğŸ†• api_data_jsonì„ ì§ì ‘ ì½ì–´ì„œ rawApiData ë³´ì™„
    // getUnifiedJobDetailWithRawDataê°€ careernetì´ nullì´ë©´ rawCareernetDataë¥¼ ì„¤ì •í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
    // í•˜ì§€ë§Œ ì‹¤ì œ api_data_jsonì—ëŠ” { careernet: null, goyong24: {...} } í˜•ì‹ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ
    if (c.env.DB) {
      try {
        // ì‹¤ì œ DB IDë¡œ ì¡°íšŒ
        let dbResult = await c.env.DB.prepare(
          'SELECT id, api_data_json FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
        ).bind(id).first<{ id: string; api_data_json: string | null }>()
        
        if (!dbResult && id.includes(':')) {
          const parts = id.split(':')
          if (parts.length > 1) {
            const extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
            dbResult = await c.env.DB.prepare(
              'SELECT id, api_data_json FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
            ).bind(extractedId).first<{ id: string; api_data_json: string | null }>()
          }
        }
        
        if (!dbResult) {
          const normalizedSlug = id.toLowerCase()
          dbResult = await c.env.DB.prepare(
            'SELECT id, api_data_json FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "Â·", ""), "ã†", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first<{ id: string; api_data_json: string | null }>()
        }
        
        if (dbResult?.api_data_json) {
          try {
            const apiDataFromDb = JSON.parse(dbResult.api_data_json)
            // api_data_jsonì˜ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (careernetì´ nullì´ì–´ë„ í¬í•¨)
            rawApiData = {
              careernet: apiDataFromDb.careernet ?? null,
              goyong24: apiDataFromDb.goyong24 ?? null
            }
          } catch (parseError) {
          }
        }
      } catch (dbError) {
      }
    }

    // ì‹¤ì œ ë Œë”ë§ì— ì‚¬ìš©ë˜ëŠ” ë³‘í•© ë°ì´í„° ìƒì„±
    const { mergeJobData } = await import('./services/jobDataMerger')
    const mergedData = mergeJobData(rawApiData)

    // ğŸ†• í…œí”Œë¦¿ê³¼ ì •í™•íˆ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ í•„ë“œ ì¶”ì¶œ (renderUnifiedJobDetailê³¼ ì¼ì¹˜)
    // í…œí”Œë¦¿ì—ì„œëŠ” profileì´ ì´ë¯¸ user_contributed_jsonê³¼ admin_data_jsonì´ ë³‘í•©ëœ ê²°ê³¼ë¥¼ ì‚¬ìš©
    
    // íˆì–´ë¡œ ì„¤ëª…: í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ìš°ì„ ìˆœìœ„ (heroIntro > summary > goyong24)
    // í…œí”Œë¦¿: const heroDescription = profile.heroIntro?.split('\n')[0]?.trim() || profile.summary || ...
    // í¸ì§‘ ëª¨ë“œì—ì„œë„ ì‹¤ì œ í‘œì‹œë˜ëŠ” ë°ì´í„°ì™€ ë™ì¼í•˜ê²Œ í‘œì‹œ
    const summaryForEdit = 
      profile.heroIntro ||  // heroIntroê°€ ìˆìœ¼ë©´ ì´ê²ƒì„ ìš°ì„  ì‚¬ìš©
      profile.summary || 
      rawApiData?.goyong24?.duty?.jobSum || ''

    // "í•˜ëŠ” ì¼" ì„¹ì…˜: í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¡œì§
    // í…œí”Œë¦¿: const workSummary = mergedData.work.summary || profile.summary
    const workSummary = mergedData.work.summary || profile.summary || ''
    
    // ì£¼ìš” ì—…ë¬´: í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¡œì§
    // í…œí”Œë¦¿: workSimpleì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©, ì—†ìœ¼ë©´ profile.duties
    const workSimple = mergedData.work.simple
    let duties = ''
    if (workSimple && Array.isArray(workSimple) && workSimple.length > 0) {
      // workSimpleì´ ìˆìœ¼ë©´ í…œí”Œë¦¿ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
      duties = workSimple
        .map((item: any) => {
          const text = typeof item === 'string' ? item : item.work || item.list_content || ''
          return text?.trim() || ''
        })
        .filter(Boolean)
        .join('\n')
    } else if (profile.duties?.trim()) {
      // workSimpleì´ ì—†ìœ¼ë©´ profile.duties ì‚¬ìš© (í…œí”Œë¦¿ê³¼ ë™ì¼)
      duties = profile.duties
    }

    // íƒœê·¸: í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¡œì§ (rawApiData.careernet.encyclopedia.tagList)
    // í…œí”Œë¦¿ì—ì„œëŠ” tagListë¥¼ rawApiData.careernet.encyclopedia.tagListì—ì„œ ê°€ì ¸ì˜´
    const tagList = rawApiData?.careernet?.encyclopedia?.tagList || []
    const tagText = Array.isArray(tagList) 
      ? tagList.map((tag: any) => {
          // í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¡œì§: stringì´ë©´ ê·¸ëŒ€ë¡œ, objectë©´ tag ë˜ëŠ” list_content ì¶”ì¶œ
          const tagText = typeof tag === 'string' ? tag : (tag?.tag || tag?.list_content || '')
          return tagText?.trim() || ''
        }).filter(Boolean).join('\n')
      : ''

    // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ID ì¡°íšŒ (profile.idëŠ” API IDì¼ ìˆ˜ ìˆìŒ)
    let actualDbId = id
    if (c.env.DB) {
      try {
        // slugë¡œ ì¡°íšŒ ì‹œë„
        const normalizedSlug = id.toLowerCase()
        const dbResult = await c.env.DB.prepare(
          'SELECT id FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "Â·", ""), "ã†", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first<{ id: string }>()
        
        if (dbResult?.id) {
          actualDbId = dbResult.id
        } else {
          // IDë¡œ ì§ì ‘ ì¡°íšŒ ì‹œë„
          const directResult = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
          ).bind(id).first<{ id: string }>()
          
          if (directResult?.id) {
            actualDbId = directResult.id
          }
        }
      } catch (dbError) {
        // DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì›ë³¸ id ì‚¬ìš©
      }
    }

    // heroTags ì²˜ë¦¬: profile.heroTags ë˜ëŠ” tagList ì‚¬ìš©
    let heroTags: string[] = []
    if (Array.isArray(profile.heroTags)) {
      heroTags = profile.heroTags
    } else if (Array.isArray(tagList) && tagList.length > 0) {
      heroTags = tagList.map((tag: any) => {
        const t = typeof tag === 'string' ? tag : (tag?.tag || tag?.list_content || '')
        return t?.trim() || ''
      }).filter(Boolean)
    }
    
    // heroCategory ì²˜ë¦¬: breadcrumb í˜•ì‹ì¸ì§€ í™•ì¸
    let heroCategory = ''
    let isCategoryBreadcrumb = false
    
    if (typeof profile.heroCategory === 'string') {
      heroCategory = profile.heroCategory
    } else if (profile.heroCategory && typeof profile.heroCategory === 'object') {
      const cat = profile.heroCategory as any
      // breadcrumb í˜•ì‹: large, medium, small ë“± ê³„ì¸µ êµ¬ì¡°ê°€ ìˆëŠ” ê²½ìš°
      if (cat.large || cat.medium || cat.small) {
        isCategoryBreadcrumb = true
        // breadcrumb ì „ì²´ë¥¼ í‘œì‹œ (í¸ì§‘ ë¶ˆê°€)
        const parts = [cat.large, cat.medium, cat.small].filter(Boolean)
        heroCategory = parts.join(' â€º ')
      } else if (cat.value) {
        heroCategory = cat.value
      }
    }
    
    // í¸ì§‘ ê°€ëŠ¥í•œ í•„ë“œë§Œ ì¶”ì¶œ (í¸ì§‘ ëª¨ë“œ UI í•„ë“œ êµ¬ì¡°ì— ë§ì¶¤)
    const editData: Record<string, any> = {
      name: profile.name || '',
      summary: summaryForEdit, // ì „ì²´ summary (heroIntro > summary > goyong24)
      heroTags: heroTags, // íƒœê·¸ ë°°ì—´
      heroCategory: heroCategory, // ì§ì—… ë¶„ë¥˜
      isCategoryBreadcrumb: isCategoryBreadcrumb, // breadcrumb í˜•ì‹ ì—¬ë¶€ (trueë©´ í¸ì§‘ ë¶ˆê°€)
      
      // ê°œìš” - ì£¼ìš” ì—…ë¬´
      // mainì€ ë¬¸ìì—´ â†’ ë°°ì—´ë¡œ ë³€í™˜ (ë¦¬ìŠ¤íŠ¸ í¸ì§‘ìš©)
      // í…œí”Œë¦¿ì˜ renderDutyBulletListì™€ ë™ì¼í•œ ë¡œì§ ì ìš©
      overviewWork: {
        main: (() => {
          const raw = profile.overviewWork?.main || duties || ''
          if (Array.isArray(raw)) {
            return raw
          }
          if (typeof raw === 'string' && raw.trim()) {
            const normalized = raw.replace(/\r/g, '\n')
            // 1ì°¨: ì¤„ë°”ê¿ˆ, ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ë¶„ë¦¬
            let sentences = normalized
              .split(/\n+|â€¢|â–¶|â–º|â– |â—|â—†/)
              .map((s: string) => s.trim().replace(/^[\d\-\.\)\(]+\s*/, ''))
              .filter(Boolean)
            // 2ì°¨: 1ì¤„ì´ë©´ ë§ˆì¹¨í‘œ/ëŠë‚Œí‘œ/ë¬¼ìŒí‘œë¡œ ë¶„ë¦¬
            if (sentences.length <= 1) {
              const sentenceSplit = normalized
                .replace(/([.!?])\s+(?=[^\s])/g, '$1|')
                .split('|')
                .map((s: string) => s.trim().replace(/^[\d\-\.\)\(]+\s*/, ''))
                .filter(Boolean)
              if (sentenceSplit.length > sentences.length) {
                sentences = sentenceSplit
              }
            }
            return sentences
          }
          return []
        })(),
        workStrong: profile.overviewWork?.workStrong || profile.workStrong || '',
        workPlace: profile.overviewWork?.workPlace || profile.workPlace || '',
        physicalAct: profile.overviewWork?.physicalAct || profile.physicalAct || ''
      },
      
      // ê°œìš” - ì»¤ë¦¬ì–´ ì „ë§
      overviewProspect: {
        main: profile.overviewProspect?.main || mergedData.prospect.primary || profile.prospect || ''
      },
      
      // ê°œìš” - í•µì‹¬ ëŠ¥ë ¥Â·ìê²©
      overviewAbilities: {
        abilityList: extractListItems(profile.overviewAbilities?.abilityList) 
          || extractListItems(profile.abilityList),
        technKnow: profile.overviewAbilities?.technKnow || profile.technKnow || '',
        eduLevel: profile.overviewAbilities?.eduLevel || profile.eduLevel || '',
        skillYear: profile.overviewAbilities?.skillYear || profile.skillYear || ''
      },
      
      // ê°œìš” - ì ì„± ë° í¥ë¯¸
      overviewAptitude: {
        aptitudeList: extractListItems(profile.overviewAptitude?.aptitudeList)
          || extractListItems(profile.aptitudeList),
        interestList: extractListItems(profile.overviewAptitude?.interestList)
          || extractListItems(profile.interestList)
      },
      
      // ê°œìš” - ì—¬ë‹´ (ë¦¬ìŠ¤íŠ¸ í˜•ì‹)
      trivia: typeof profile.trivia === 'string' 
        ? profile.trivia.split(/\n|â€¢/).map((s: string) => s.trim()).filter(Boolean)
        : (Array.isArray(profile.trivia) ? profile.trivia : []),
      
      // ìƒì„¸ì •ë³´ - ì§ì—… ì¤€ë¹„í•˜ê¸°
      detailReady: {
        curriculum: extractListItems(profile.detailReady?.curriculum),
        recruit: extractListItems(profile.detailReady?.recruit),
        training: extractListItems(profile.detailReady?.training),
        researchList: extractListItems(profile.detailReady?.researchList)
      },
      
      // ì‚¬ì´ë“œë°” - ì—°ê´€ ì •ë³´
      sidebarJobs: extractListItems(profile.sidebarJobs),
      sidebarMajors: extractListItems(profile.sidebarMajors),
      sidebarCerts: extractListItems(profile.sidebarCerts),
      
      // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì¶œì²˜ (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)
      _sources: (profile as any)._sources || {}
    }

    // ë””ë²„ê¹…: ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    const dataKeys = Object.keys(editData)
    const nonEmptyKeys = dataKeys.filter(key => {
      const value = editData[key as keyof typeof editData]
      return value !== null && value !== undefined && value !== ''
    })
    
    
    return c.json({
      success: true,
      data: editData,
      entityId: actualDbId, // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ID ì‚¬ìš©
      entityType: 'job'
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'í¸ì§‘ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨'
    }, 500)
  }
})

// ì „ê³µ í¸ì§‘ ëª¨ë“œìš© ë°ì´í„° ì¡°íšŒ API
app.get('/api/major/:id/edit-data', async (c) => {
  try {
    // ìºì‹œ ë°©ì§€ (í¸ì§‘ ì§í›„ ìµœì‹  ë°ì´í„° ë³´ì¥)
    c.header('Cache-Control', 'no-store')
    c.header('Pragma', 'no-cache')
    c.header('Expires', '0')

    const id = c.req.param('id')
    let userContributedJson: any = {} // ì „ì²´ ìŠ¤ì½”í”„ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ ì„ ì–¸
    
    
    // ì‚¬ìš©ì ìƒì„± ì „ê³µ (U_ prefix)ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    let resolvedId = id
    if (!id.startsWith('U_')) {
      // ì „ê³µ ìƒì„¸í˜ì´ì§€ì™€ ë™ì¼í•œ ID í•´ê²° ë¡œì§ ì‚¬ìš©
      resolvedId = resolveDetailIdFromSlug('major', id)
    }
    
    
    // ì‹¤ì œ DB ID ì°¾ê¸° (ì „ê³µ ìƒì„¸í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
    let actualDbId = resolvedId
    if (c.env.DB) {
      try {
        // composite IDì¸ ê²½ìš° (major:C_xxx ë˜ëŠ” major:G_xxx)
        if (resolvedId.includes(':')) {
          const parts = resolvedId.split(':')
          if (parts.length > 1) {
            const sourceId = parts[parts.length - 1].replace(/^C_/, '').replace(/^G_/, '')
            // careernet_idë‚˜ goyong24_idë¡œ ì‹¤ì œ DB ID ì°¾ê¸°
            const dbResult = await c.env.DB.prepare(
              'SELECT id FROM majors WHERE careernet_id = ? OR goyong24_id = ? LIMIT 1'
            ).bind(sourceId, sourceId).first() as { id: string } | null
            if (dbResult?.id) {
              actualDbId = dbResult.id
            } else {
            }
          }
        } else {
          // resolvedIdê°€ composite IDê°€ ì•„ë‹Œ ê²½ìš° DBì—ì„œ ì°¾ê¸°
          // IDë¡œ ì§ì ‘ ì¡°íšŒ ì‹œë„
          let dbResult = await c.env.DB.prepare(
            'SELECT id FROM majors WHERE id = ? AND is_active = 1 LIMIT 1'
          ).bind(resolvedId).first() as { id: string } | null
          
          
          if (!dbResult) {
            // slugë¡œ ì¡°íšŒ ì‹œë„ (ì •ê·œí™”ëœ ì´ë¦„ìœ¼ë¡œ)
            const decodedSlug = decodeURIComponent(id)
            const normalizedSlug = decodedSlug.toLowerCase()
            
            // ë°©ë²• 1: ì •ê·œí™”ëœ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ
            dbResult = await c.env.DB.prepare(
              'SELECT id FROM majors WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "Â·", ""), "ã†", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
            ).bind(normalizedSlug).first() as { id: string } | null
            
            
            if (!dbResult) {
              // ë°©ë²• 2: ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ì¡°íšŒ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
              dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
              ).bind(normalizedSlug).first() as { id: string } | null
              
            }
            
            if (!dbResult) {
              // ë°©ë²• 3: ì›ë³¸ slugë¡œ ì¡°íšŒ
              dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
              ).bind(decodedSlug).first() as { id: string } | null
              
            }
          }
          
          if (dbResult?.id) {
            actualDbId = dbResult.id
          } else {
            actualDbId = resolvedId
          }
        }
      } catch (dbError) {
        // DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ resolvedId ì‚¬ìš©
        actualDbId = resolvedId
      }
    }
    
    // ì‚¬ìš©ì ê¸°ì—¬ ë°ì´í„° ìš°ì„  ë¡œë“œ (ì—­ì‚¬/í¸ì§‘ ë°ì´í„° ì¼ì¹˜ ë³´ì¥)
    if (c.env.DB) {
      try {
        const ucRow = await c.env.DB.prepare(
          'SELECT user_contributed_json FROM majors WHERE id = ? LIMIT 1'
        ).bind(actualDbId).first<{ user_contributed_json: string | null }>()
        if (ucRow?.user_contributed_json) {
          userContributedJson = JSON.parse(ucRow.user_contributed_json)
        }
      } catch (ucError) {
      }
    }
    
    // ì „ê³µ ìƒì„¸í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ì¡°íšŒ
    // actualDbIdê°€ ì‹¤ì œ DB IDì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ resolvedId ì‚¬ìš©
    const searchId = actualDbId !== resolvedId ? actualDbId : resolvedId
    const result = await getUnifiedMajorDetail(
      {
        id: searchId, // ì‹¤ì œ DB ID ë˜ëŠ” resolvedId
        careernetId: undefined,
        goyong24Params: undefined
      },
      c.env
    )

    if (!result.profile) {
      // ì›ë³¸ slugë¡œë„ ì‹œë„ (composite IDê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
      if (searchId !== id && !id.includes(':')) {
        const retryResult = await getUnifiedMajorDetail(
          {
            id: id,
            careernetId: undefined,
            goyong24Params: undefined
          },
          c.env
        )
        if (retryResult.profile) {
          // retryResult ì‚¬ìš©
          const profile = retryResult.profile
          
          // í—¬í¼ í•¨ìˆ˜: ë°°ì—´ì—ì„œ ì´ë¦„/í…ìŠ¤íŠ¸ ì¶”ì¶œ
          const extractListItems = (list: any[] | undefined): string[] => {
            if (!Array.isArray(list)) return []
            return list
              .map((item: any) => {
                if (typeof item === 'string') return item.trim()
                return (item?.name || item?.value || '').trim()
              })
              .filter(Boolean)
          }
          
          const heroTags = Array.isArray((profile as any).heroTags) ? (profile as any).heroTags : []
          const categoryName = typeof (profile as any).categoryName === 'string' ? (profile as any).categoryName : ((profile as any).categoryName?.value || '')
          
          const editData = {
            name: profile.name || '',
            summary: profile.summary || '',
            heroTags: heroTags,
            categoryName: categoryName,
            property: profile.property || '',
            aptitude: profile.aptitude || '',
            relatedMajors: extractListItems(profile.relatedMajors),
            mainSubjects: extractListItems(profile.mainSubjects),
            relatedJobs: extractListItems(profile.relatedJobs),
            whatStudy: profile.whatStudy || '',
            mainSubject: profile.mainSubject || '',
            relateSubject: profile.relateSubject || '',
            enterField: typeof profile.enterField === 'string' ? profile.enterField : (profile.enterField ? JSON.stringify(profile.enterField, null, 2) : ''),
            jobProspect: profile.jobProspect || '',
            careerAct: profile.careerAct || ''
          }
          
          // í”„ë¡œí•„ ì´ë¦„ìœ¼ë¡œ ì‹¤ì œ DB ID ì°¾ê¸°
          if (c.env.DB && profile.name) {
            try {
              const dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
              ).bind(profile.name).first() as { id: string } | null
              if (dbResult?.id) {
                actualDbId = dbResult.id
              }
            } catch (e) {
            }
          }
          
          return c.json({
            success: true,
            data: editData,
            entityId: actualDbId || id,
            entityType: 'major'
          })
        }
      }
      return c.json({
        success: false,
        error: 'ì „ê³µ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      }, 404)
    }
    
    // í”„ë¡œí•„ì„ ì°¾ì€ ê²½ìš°, ì‹¤ì œ DB IDë¥¼ ë‹¤ì‹œ í™•ì¸
    if (actualDbId === resolvedId && !actualDbId.includes(':') && c.env.DB) {
      try {
        // í”„ë¡œí•„ ì´ë¦„ìœ¼ë¡œ ì‹¤ì œ DB ID ì°¾ê¸°
        const profileName = result.profile.name
        if (profileName) {
          const dbResult = await c.env.DB.prepare(
            'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(profileName).first() as { id: string } | null
          if (dbResult?.id) {
            actualDbId = dbResult.id
          }
        }
      } catch (e) {
      }
    }

    const profile = result.profile
    
    // í—¬í¼ í•¨ìˆ˜: ë°°ì—´ì—ì„œ ì´ë¦„/í…ìŠ¤íŠ¸ ì¶”ì¶œ
    const extractListItems = (list: any[] | undefined): string[] => {
      if (!Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          return (item?.name || item?.value || '').trim()
        })
        .filter(Boolean)
    }
    
    // heroTags ì²˜ë¦¬: profile.heroTags ë˜ëŠ” tagList
    let heroTags: string[] = []
    if (Array.isArray((profile as any).heroTags)) {
      heroTags = (profile as any).heroTags
    }
    
    // categoryName ì²˜ë¦¬
    let categoryName = ''
    if (typeof (profile as any).categoryName === 'string') {
      categoryName = (profile as any).categoryName
    } else if ((profile as any).categoryName?.value) {
      categoryName = (profile as any).categoryName.value
    }
    
    // í¸ì§‘ ê°€ëŠ¥í•œ í•„ë“œë§Œ ì¶”ì¶œ (í¸ì§‘ ëª¨ë“œ UI í•„ë“œ êµ¬ì¡°ì— ë§ì¶¤)
    const extractListItemsWithSubjects = (list: any[] | undefined): string[] => {
      if (!Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          return (
            item?.name ||
            item?.value ||
            item?.subject_name ||
            item?.SUBJECT_NM ||
            ''
          ).trim()
        })
        .filter(Boolean)
    }
    const toStringList = (val: any): string[] => {
      if (Array.isArray(val)) {
        return val.map(v => (typeof v === 'string' ? v : (v?.text || v?.value || v?.name || ''))).filter(Boolean)
      }
      if (typeof val === 'string') {
        return val.split(/\n+/).map(s => s.trim()).filter(Boolean)
      }
      return []
    }
    
    const toPairList = (list: any): Array<{ title: string; description: string }> => {
      if (!list) return []
      if (typeof list === 'string') {
        return list.split(/\n+/).map(line => line.trim()).filter(Boolean).map(line => ({ title: line, description: '' }))
      }
      if (Array.isArray(list)) {
        return list.map(item => {
          const anyItem = item as any
          const title =
            anyItem.title ||
            anyItem.name ||
            anyItem.gradeuate ||
            anyItem.field_name ||
            anyItem.act_name ||
            anyItem.ACT_NM ||
            anyItem.SBJECT_NM ||    // ì»¤ë¦¬ì–´ë„· ì‹¤ì œ í‚¤ (U ì—†ìŒ)
            anyItem.SUBJECT_NM ||
            anyItem.subject_name ||
            ''
          const description =
            anyItem.description ||
            anyItem.desc ||
            anyItem.text ||
            anyItem.field_description ||
            anyItem.field_desc ||
            anyItem.act_description ||
            anyItem.ACT_SUMRY ||
            anyItem.SBJECT_SUMRY || // ì»¤ë¦¬ì–´ë„· ì‹¤ì œ í‚¤ (U ì—†ìŒ)
            anyItem.subject_description ||
            anyItem.SUBJECT_SUMRY ||
            ''
          if (!title && !description) return null
          return { title, description }
        }).filter(Boolean) as Array<{ title: string; description: string }>
      }
      return []
    }
    
    // hero description: í…œí”Œë¦¿ê³¼ ë™ì¼ (heroSummary ìš°ì„ , ì—†ìœ¼ë©´ summary/CAREERNET/GOYONG24 ì²« ë¬¸ì¥)
    const heroDescription =
      (profile as any).heroSummary ||
      (profile.summary || result.partials?.CAREERNET?.summary || result.partials?.GOYONG24?.summary)
        ?.split('\n')[0]
        ?.trim() ||
      ''
    
    // overview summary: DB user_contributed_json ìš°ì„ , ê·¸ ë‹¤ìŒ merged â†’ summaryê¹Œì§€ í´ë°± (í…œí”Œë¦¿ê³¼ ë™ì¼)
    const isUserCreatedMajor = (profile.id || '').startsWith('U_')
    const overviewSummary = (userContributedJson?.overview?.summary)
      || (profile as any).overview?.summary
      || profile.summary
      || (isUserCreatedMajor ? profile.summary : '')
      || ''
    // ì‚¬ì´ë“œë°” ë°ì´í„°
    const mapAutocompleteItems = (arr: any[] | undefined, type: 'job' | 'major' | 'howto') => {
      if (!Array.isArray(arr)) return []
      return arr.map(item => {
        if (typeof item === 'string') return { name: item, slug: item }
        return { name: item?.name || item?.title || '', slug: item?.slug || item?.id || item?.name || item?.title || '' }
      }).filter(i => i.name)
    }
    
    // êµìœ¡ê³¼ì •: ê¸°ì´ˆ/ì‹¬í™” ê¸°ë³¸ê°’ + mainSubjects íŒŒì‹± (í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ìˆœì„œ)
    let basicSubjectsParsed = extractListItemsWithSubjects((profile as any).basicSubjects)
    let advancedSubjectsParsed = extractListItemsWithSubjects((profile as any).advancedSubjects)
    let relateSubjectParsed = extractListItemsWithSubjects(profile.relateSubject)
    // mainSubjectsê°€ pairList í˜•íƒœë©´ ì œëª©ë§Œ íƒœê·¸ë¡œ ë…¸ì¶œ (ìƒì„¸ëŠ” mainSubject pairListë¡œ ë³„ë„ ì €ì¥)
    const mainSubjectsRaw = profile.mainSubjects
    if (Array.isArray(mainSubjectsRaw) && mainSubjectsRaw.length > 0) {
      const hasPairListShape = mainSubjectsRaw.some((i: any) => typeof i === 'object' && (i.title || i.subject_name || i.SUBJECT_NM))
      if (hasPairListShape) {
        const titles = mainSubjectsRaw
          .map((i: any) => i.title || i.subject_name || i.SUBJECT_NM || '')
          .filter(Boolean)
          .map((t: string) => t.trim())
          .filter(Boolean)
        if (basicSubjectsParsed.length === 0 && titles.length > 0) {
          basicSubjectsParsed = [...titles]
        }
      } else if (basicSubjectsParsed.length === 0 && advancedSubjectsParsed.length === 0) {
        // ë¬¸ìì—´/ë°°ì—´ ê¸°ë°˜ íŒŒì‹± (â€¡ êµ¬ë¶„ì)
        const firstSubject = mainSubjectsRaw[0]
        if (typeof firstSubject === 'string' && firstSubject.includes('â€¡')) {
          const sections = firstSubject.split('â€¡').filter((s: string) => s.trim())
          sections.forEach(section => {
            if (section.includes('ê¸°ì´ˆê³¼ëª©')) {
              const subjects = section.replace(/^.*?ê¸°ì´ˆê³¼ëª©\s*[:ï¼š]\s*/i, '')
                .split(/[,ã€]\s*/)
                .map((s: string) => s.trim())
                .filter((s: string) => s && s !== 'ë“±')
              basicSubjectsParsed.push(...subjects)
            } else if (section.includes('ì‹¬í™”ê³¼ëª©')) {
              const subjects = section.replace(/^.*?ì‹¬í™”ê³¼ëª©\s*[:ï¼š]\s*/i, '')
                .split(/[,ã€]\s*/)
                .map((s: string) => s.trim())
                .filter((s: string) => s && s !== 'ë“±')
              advancedSubjectsParsed.push(...subjects)
            }
          })
        }
      }
    }

    const editData = {
      name: profile.name || '',
      heroSummary: heroDescription || profile.summary || '',  // íˆì–´ë¡œ ì„¹ì…˜ ì „ìš© (ê°œìš”ì™€ ë¶„ë¦¬)
      heroTags: heroTags,
      categoryName: categoryName,
      
      // ê°œìš”
      'overview.summary': overviewSummary,
      property: profile.property || '',
      aptitude: profile.aptitude || '',
      enterField: toPairList(profile.enterField),
      // ì—¬ë‹´ì€ trivia í•„ë“œë§Œ ì‚¬ìš© (ì§„ë¡œì „ë§ jobProspectì™€ ë¶„ë¦¬)
      trivia: toStringList((profile as any).trivia),
      
      // ìƒì„¸ì •ë³´ - êµìœ¡ê³¼ì •
      whatStudy: profile.whatStudy || '',
      basicSubjects: basicSubjectsParsed,
      advancedSubjects: advancedSubjectsParsed,
      // ëŒ€í•™ ì£¼ìš” êµê³¼ëª© ìƒì„¸: mainSubject ìš°ì„ , ì—†ìœ¼ë©´ main_subject, ì—†ìœ¼ë©´ mainSubjects
      mainSubject: toPairList(
        (profile as any).mainSubject ||
        (profile as any).main_subject ||
        (profile as any).mainSubjects
      ),
      // ê³ êµ ì¶”ì²œ êµê³¼ëª©: pairListë¡œ ì œê³µ (ì œëª©/ì„¤ëª…), [ì¶œì²˜]ë¡œ ì‹œì‘í•˜ëŠ” í•­ëª©ì€ ì œì™¸
      relateSubject: toPairList(profile.relateSubject || (profile as any).relate_subject).filter(
        (item) => item.title && !item.title.trim().startsWith('[ì¶œì²˜')
      ),
      
      // ìƒì„¸ì •ë³´ - ì§„ë¡œ íƒìƒ‰ í™œë™
      careerAct: toPairList(profile.careerAct),
      
      // ì‚¬ì´ë“œë°”
      sidebarJobs: mapAutocompleteItems((profile as any).sidebarJobs || profile.relatedJobs, 'job'),
      sidebarMajors: mapAutocompleteItems((profile as any).sidebarMajors || profile.relatedMajors, 'major'),
      sidebarHowtos: mapAutocompleteItems((profile as any).sidebarHowtos, 'howto'),
      
      // ì‚¬ìš©ì ì¶œì²˜ (í¸ì§‘ì°½ì—ì„œ ë‹¤ì¤‘ ì…ë ¥ ì§€ì›)
      _sources: (profile as any)._sources || {}
    }

    return c.json({
      success: true,
      data: editData,
      entityId: actualDbId, // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ID ì‚¬ìš©
      entityType: 'major'
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'í¸ì§‘ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨'
    }, 500)
  }
})

// ë¯¸ë¦¬ë³´ê¸° API ì œê±°ë¨ (í¸ì§‘ ëª¨ë“œì—ì„œ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ ì—†ìŒ)

// ì§ì—… ì¹´í…Œê³ ë¦¬ ëª©ë¡ API
app.get('/api/categories', async (c) => {
  return c.json({
    success: true,
    jobCategories: JOB_CATEGORIES,
    aptitudeTypes: APTITUDE_TYPES
  })
})

// ============================================================================
// ì¹´ë“œ HTML ë Œë”ë§ API (í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ ì‹œ ì‚¬ìš©)
// ============================================================================

// ì§ì—… ì¹´ë“œ HTML ë°˜í™˜ API
app.post('/api/job/cards', async (c) => {
  try {
    const body = await c.req.json<{ items: Array<{ profile: any; display?: any }> }>()
    const items = body.items || []
    
    if (!Array.isArray(items) || items.length === 0) {
      return c.json({ html: '', count: 0 })
    }
    
    const html = items.map((item) => renderJobCard(item)).join('')
    
    return c.json({
      html,
      count: items.length
    })
  } catch (error) {
    return c.json({
      error: error instanceof Error ? error.message : 'ì¹´ë“œ ë Œë”ë§ ì‹¤íŒ¨',
      html: '',
      count: 0
    }, 500)
  }
})

// ì „ê³µ ì¹´ë“œ HTML ë°˜í™˜ API
app.post('/api/major/cards', async (c) => {
  try {
    const body = await c.req.json<{ items: Array<{ profile: any; display?: any }> }>()
    const items = body.items || []
    
    if (!Array.isArray(items) || items.length === 0) {
      return c.json({ html: '', count: 0 })
    }
    
    const html = items.map((item) => renderMajorCard(item)).join('')
    
    return c.json({
      html,
      count: items.length
    })
  } catch (error) {
    return c.json({
      error: error instanceof Error ? error.message : 'ì¹´ë“œ ë Œë”ë§ ì‹¤íŒ¨',
      html: '',
      count: 0
    }, 500)
  }
})

// ============================================================================
// ì „ê³µ(í•™ê³¼) ê´€ë ¨ API
// ============================================================================

// ì „ê³µ ê²€ìƒ‰ API
app.get('/api/majors', async (c) => {
  try {
    const keyword = c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await searchUnifiedMajors({
      keyword,
      page,
      perPage,
      includeSources
    }, c.env)

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'ì „ê³µ ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨'
    }, 500)
  }
})

// ì „ê³µ ìƒì„¸ ì •ë³´ API
app.get('/api/majors/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const careernetId = c.req.query('careernetId') || undefined
    const goyong24Params = c.req.query('goyong24Params') 
      ? JSON.parse(c.req.query('goyong24Params') || '{}')
      : undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await getUnifiedMajorDetail(
      {
        id,
        careernetId,
        goyong24Params,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: 'ì „ê³µ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : 'ì „ê³µ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨'
    }, 500)
  }
})


// ============================================================================
// ì‚¬ìš©ì ì„¤ì • í˜ì´ì§€ (ë§ˆì´í˜ì´ì§€)
// ============================================================================

// ë§ˆì´í˜ì´ì§€ ë©”ì¸ - AI ì¶”ì²œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
app.get('/user', requireAuth, async (c) => {
  return c.redirect('/user/ai-results')
})

// ============================================================================
// ì‚¬ìš©ì í”„ë¡œí•„ - AI ì¶”ì²œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
// ============================================================================
app.get('/user/profile', requireAuth, (c) => {
  return c.redirect('/user/ai-results?tab=profile')
})

// ============================================================================
// í”„ë¡œí•„ ì»¨í…ì¸  HTML ìƒì„± í•¨ìˆ˜
// ============================================================================
function generateProfileContentHtml(): string {
  return `
    <!-- í”„ë¡œí•„ ìš”ì•½ í—¤ë” -->
    <div id="profile-summary" class="mb-6">
      <div class="animate-pulse">
        <div class="h-4 bg-wiki-border/30 rounded w-1/3 mb-2"></div>
        <div class="h-3 bg-wiki-border/20 rounded w-1/2"></div>
      </div>
    </div>
    
    <!-- ë³€ê²½ì‚¬í•­ ì•Œë¦¼ ë°°ë„ˆ -->
    <div id="changes-banner" class="hidden mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
      <div class="flex items-start gap-3">
        <i class="fas fa-exclamation-circle text-amber-400 mt-0.5"></i>
        <div class="flex-1">
          <h4 class="font-medium text-amber-300 mb-1">í”„ë¡œí•„ ë³€ê²½ ê°ì§€</h4>
          <p id="changes-message" class="text-sm text-wiki-muted mb-3"></p>
          <button onclick="quickReanalyze()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-black font-medium rounded-lg transition text-sm">
            <i class="fas fa-redo mr-2"></i>ë³€ê²½ì‚¬í•­ ì ìš©í•˜ì—¬ ì¬ë¶„ì„
          </button>
        </div>
      </div>
    </div>
    
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto" style="scrollbar-width: none;">
      <button onclick="switchTab('career')" data-tab="career" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap bg-wiki-primary text-white">
        <i class="fas fa-briefcase mr-2"></i>ê¸°ë³¸ ì •ë³´
      </button>
      <button onclick="switchTab('universal')" data-tab="universal" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-heart mr-2"></i>ê´€ì‹¬ì‚¬/ì„±í–¥
      </button>
      <button onclick="switchTab('transition')" data-tab="transition" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-exchange-alt mr-2"></i>ì „í™˜ ì˜í–¥
      </button>
      <button onclick="switchTab('narrative')" data-tab="narrative" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-pen-fancy mr-2"></i>ì‹¬ì¸µ ë‹µë³€
      </button>
      <button onclick="switchTab('resume')" data-tab="resume" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-file-alt mr-2"></i>ì´ë ¥ì„œ ì •ë³´
      </button>
    </div>
    
    <!-- íƒ­ ì»¨í…ì¸  ì˜ì—­ -->
    <div id="tab-content">
      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="loading-state" class="py-8 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-wiki-primary"></div>
        <p class="mt-4 text-wiki-muted">í”„ë¡œí•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      
      <!-- ë¹ˆ ìƒíƒœ -->
      <div id="empty-state" class="hidden py-12 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: rgba(67, 97, 238, 0.1);">
          <i class="fas fa-user-plus text-2xl text-wiki-primary"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-3">í”„ë¡œí•„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="mb-6 text-wiki-muted">AI ë¶„ì„ì„ í†µí•´ í”„ë¡œí•„ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
        <a href="/analyzer/job" class="inline-flex items-center gap-2 px-5 py-2.5 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition">
          <i class="fas fa-magic"></i> AI ë¶„ì„ ì‹œì‘í•˜ê¸°
        </a>
      </div>
      
      <!-- Career State íƒ­ -->
      <div id="tab-career" class="tab-panel hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ì—­í•  ì •ì²´ì„±</h4>
              <button onclick="editField('career_state', 'role_identity')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-role_identity" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê²½ë ¥ ë‹¨ê³„</h4>
              <button onclick="editField('career_state', 'career_stage_years')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-career_stage_years" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ì „í™˜ ìƒíƒœ</h4>
              <button onclick="editField('career_state', 'transition_status')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-transition_status" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ìŠ¤í‚¬ ë ˆë²¨</h4>
              <button onclick="editField('career_state', 'skill_level')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-skill_level" class="flex items-center gap-2">
              <div class="flex gap-1">
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
              </div>
              <span class="text-wiki-muted text-sm">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Universal Answers íƒ­ -->
      <div id="tab-universal" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê´€ì‹¬ ë¶„ì•¼</h4>
              <button onclick="editField('universal_answers', 'interest')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-interest" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê°•ì </h4>
              <button onclick="editField('universal_answers', 'strength')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-strength" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê¸°í”¼ ìš”ì†Œ</h4>
              <button onclick="editField('universal_answers', 'dislike')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-dislike" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ìš°ì„ ìˆœìœ„</h4>
              <button onclick="editField('universal_answers', 'priority')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-priority" class="text-white font-medium">-</p>
          </div>
          
          <!-- ë‚˜ë¥¼ ì•Œì•„ê°€ê¸° ì„¹ì…˜ (Q8-Q15) -->
          <div class="mt-6 pt-4 border-t border-wiki-border/30">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fas fa-brain text-purple-400"></i> ë‚˜ë¥¼ ì•Œì•„ê°€ê¸°
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ì—…ë¬´ ìŠ¤íƒ€ì¼</h4>
                <p id="field-workstyle_social" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ì–¸ì–´ ëŠ¥ë ¥</h4>
                <div id="field-language" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸ”¥ ê°ìˆ˜ ê°€ëŠ¥</h4>
                <div id="field-mm_sacrifice" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">âš¡ ì—ë„ˆì§€ ì†Œëª¨ì›</h4>
                <div id="field-mm_energy_drain" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸ† ì„±ì·¨ í”¼ë“œë°±</h4>
                <div id="field-mm_achievement" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸƒ ì‹¤í–‰ ìŠ¤íƒ€ì¼</h4>
                <p id="field-mm_execution" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸŒ ì˜í–¥ ë²”ìœ„</h4>
                <p id="field-mm_impact_scope" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸ’¥ ì‹¤íŒ¨ ë°˜ì‘</h4>
                <p id="field-mm_failure" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸ›¡ï¸ ë²„íŒ€ ì•µì»¤</h4>
                <p id="field-mm_anchor" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">ğŸ‘ï¸ ì™¸ë¶€ ê¸°ëŒ€ ë°˜ì‘</h4>
                <p id="field-mm_external" class="text-white font-medium">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Transition Signal íƒ­ -->
      <div id="tab-transition" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">í¬ë§ ì „í™˜ ìœ í˜•</h4>
              <button onclick="editField('transition_signal', 'desired_types')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-desired_types" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ì „í™˜ ë™ê¸°</h4>
              <button onclick="editField('transition_signal', 'motivation')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-motivation" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ëª©í‘œ ê¸°ê°„</h4>
              <button onclick="editField('transition_signal', 'timeline')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-timeline" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ì¥ì•  ìš”ì†Œ</h4>
              <button onclick="editField('transition_signal', 'blockers')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-blockers" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Narrative/Round Answers íƒ­ -->
      <div id="tab-narrative" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê°€ì¥ ìƒìƒí–ˆë˜ ìˆœê°„</h4>
            </div>
            <p id="field-highAliveMoment" class="text-white leading-relaxed">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê°€ì¥ ì§€ì³¤ë˜ ìˆœê°„</h4>
            </div>
            <p id="field-lostMoment" class="text-white leading-relaxed">-</p>
          </div>
          <div id="round-answers-container" class="space-y-4">
            <!-- ë¼ìš´ë“œ ë‹µë³€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
          </div>
        </div>
      </div>
      
      <!-- Resume Data íƒ­ -->
      <div id="tab-resume" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ë³´ìœ  ìŠ¤í‚¬</h4>
            </div>
            <div id="field-skills" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ìê²©ì¦</h4>
            </div>
            <div id="field-certifications" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">ê²½í—˜ ì—…ì¢…</h4>
            </div>
            <div id="field-industries" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
              <h4 class="text-sm font-medium text-wiki-muted mb-3">í•™ë ¥ ìˆ˜ì¤€</h4>
              <p id="field-education_level" class="text-white font-medium">-</p>
            </div>
            <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
              <h4 class="text-sm font-medium text-wiki-muted mb-3">ì—­í•  ìœ í˜•</h4>
              <p id="field-role_type" class="text-white font-medium">-</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- í¸ì§‘ ëª¨ë‹¬ -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70" onclick="closeEditModal()"></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-wiki-bg border border-wiki-border rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="modal-title" class="text-lg font-semibold text-white">í•„ë“œ ìˆ˜ì •</h3>
          <button onclick="closeEditModal()" class="text-wiki-muted hover:text-white transition">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="modal-content" class="mb-6">
          <!-- ë™ì ìœ¼ë¡œ í¼ í•„ë“œ ì‚½ì… -->
        </div>
        <div class="flex justify-end gap-3">
          <button onclick="closeEditModal()" class="px-4 py-2 text-wiki-muted hover:text-white transition">ì·¨ì†Œ</button>
          <button onclick="saveField()" class="px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition">ì €ì¥</button>
        </div>
      </div>
    </div>
    
    <!-- ë©”íƒ€ë°ì´í„° ì˜ì—­ -->
    <div class="mt-6 pt-6 border-t border-wiki-border/30">
      <div class="flex flex-wrap items-center justify-between gap-4 text-sm text-wiki-muted">
        <div class="flex items-center gap-4">
          <span id="meta-updated"><i class="far fa-clock mr-1"></i>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
          <span id="meta-analysis"><i class="fas fa-chart-line mr-1"></i>ë§ˆì§€ë§‰ ë¶„ì„: -</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="meta-completeness" class="flex items-center gap-2">
            ì™„ì„±ë„: <div class="w-24 h-2 bg-wiki-border/30 rounded-full overflow-hidden"><div class="h-full bg-wiki-primary rounded-full" style="width: 0%"></div></div> 0%
          </span>
        </div>
      </div>
    </div>
    
    <script>
      // ì „ì—­ ìƒíƒœ
      let profileData = null;
      let currentCategory = null;
      let currentField = null;
      
      // í•„ë“œ ë¼ë²¨ ë§µ
      const fieldLabels = {
        role_identity: 'ì—­í•  ì •ì²´ì„±',
        career_stage_years: 'ê²½ë ¥ ë‹¨ê³„',
        transition_status: 'ì „í™˜ ìƒíƒœ',
        skill_level: 'ìŠ¤í‚¬ ë ˆë²¨',
        interest: 'ê´€ì‹¬ ë¶„ì•¼',
        strength: 'ê°•ì ',
        dislike: 'ê¸°í”¼ ìš”ì†Œ',
        priority: 'ìš°ì„ ìˆœìœ„',
        desired_types: 'í¬ë§ ì „í™˜ ìœ í˜•',
        motivation: 'ì „í™˜ ë™ê¸°',
        timeline: 'ëª©í‘œ ê¸°ê°„',
        blockers: 'ì¥ì•  ìš”ì†Œ'
      };
      
      // ê°’ ë¼ë²¨ ë§µ
      const valueLabels = {
        // role_identity
        worker: 'ì§ì¥ì¸',
        student: 'í•™ìƒ',
        jobseeker: 'êµ¬ì§ì',
        career_changer: 'ì´ì§ ì¤€ë¹„ìƒ',
        freelancer: 'í”„ë¦¬ëœì„œ',
        // career_stage_years
        '0_3': '0~3ë…„ (ì´ˆê¸°)',
        '3_7': '3~7ë…„ (ì„±ì¥ê¸°)',
        '7_15': '7~15ë…„ (ì „ë¬¸ê°€)',
        '15_plus': '15ë…„ ì´ìƒ (ì‹œë‹ˆì–´)',
        // transition_status
        exploring: 'íƒìƒ‰ ì¤‘',
        decided: 'ê²°ì •ë¨',
        preparing: 'ì¤€ë¹„ ì¤‘',
        transitioning: 'ì „í™˜ ì¤‘',
        stable: 'ì•ˆì •ì ',
        changer: 'ì „í™˜ ê³ ë ¤ ì¤‘',
        returner: 'ë³µê·€ ì¤€ë¹„ ì¤‘',
        // priority
        stability: 'ì•ˆì •ì„±',
        growth: 'ì„±ì¥',
        balance: 'ì›Œë¼ë°¸',
        income: 'ì†Œë“',
        purpose: 'ì˜ë¯¸/ëª©ì ',
        // timeline
        '3m': '3ê°œì›” ì´ë‚´',
        '6m': '6ê°œì›” ì´ë‚´',
        '1y': '1ë…„ ì´ë‚´',
        '2y_plus': '2ë…„ ì´ìƒ',
        undecided: 'ë¯¸ì •',
        // motivation
        dissatisfaction: 'í˜„ì¬ ì§ë¬´ ë¶ˆë§Œì¡±',
        better_opportunity: 'ë” ì¢‹ì€ ê¸°íšŒ',
        passion: 'ìƒˆë¡œìš´ ë¶„ì•¼ ì—´ì •',
        life_change: 'ìƒí™œ ë³€í™”',
        skill_growth: 'ì—­ëŸ‰ í–¥ìƒ',
        // ========== ë‚˜ë¥¼ ì•Œì•„ê°€ê¸° (Q8-Q15) ==========
        // ì—…ë¬´ ìŠ¤íƒ€ì¼ (Q7)
        alone_work: 'í˜¼ì ì§‘ì¤‘',
        team_work: 'í•¨ê»˜ í˜‘ì—…',
        mixed_work: 'ìƒí™©ì— ë”°ë¼',
        // í¬ê¸° ê°€ëŠ¥ (Q8 - sacrifice)
        low_initial_income: 'ë‚®ì€ ì´ˆë´‰ ê°ìˆ˜',
        willing_to_study: 'ì¬í•™ìŠµ ê°ìˆ˜',
        field_change_ok: 'ë¶„ì•¼ ì „í™˜ ê°ìˆ˜',
        ignore_social_pressure: 'ì£¼ë³€ ì‹œì„  ê°ìˆ˜',
        no_sacrifice: 'í¬ê¸° ë¶ˆê°€',
        // ì—ë„ˆì§€ ì†Œëª¨ (Q9 - energy_drain)
        people_drain: 'ëŒ€ì¸ê´€ê³„ ìŠ¤íŠ¸ë ˆìŠ¤',
        cognitive_drain: 'ì¸ì§€ í”¼ë¡œ',
        time_pressure_drain: 'ì‹œê°„ ì••ë°•',
        responsibility_drain: 'ì±…ì„ ìŠ¤íŠ¸ë ˆìŠ¤',
        repetition_drain: 'ë°˜ë³µ í”¼ë¡œ',
        unpredictability_drain: 'ë¶ˆí™•ì‹¤ì„±',
        // ì„±ì·¨ í”¼ë“œë°± (Q10)
        metric_feedback: 'ìˆ˜ì¹˜ ì„±ê³¼',
        helping_feedback: 'ì§ì ‘ ë„ì›€',
        problem_solved_feedback: 'ë¬¸ì œ í•´ê²°',
        tangible_output_feedback: 'ê²°ê³¼ë¬¼ ì‚°ì¶œ',
        growth_feedback: 'ì„±ì¥ ì‹¤ê°',
        // ì‹¤í–‰ ìŠ¤íƒ€ì¼ (Q11)
        action_first: 'ì¼ë‹¨ í•´ë³´ê¸°',
        plan_first: 'ê³„íš ìš°ì„ ',
        flexible_execution: 'ìƒí™© ë”°ë¼',
        // ì˜í–¥ ë²”ìœ„ (Q12)
        individual_scope: 'ê°œì¸',
        team_scope: 'íŒ€/ì¡°ì§',
        company_scope: 'íšŒì‚¬/ì‚°ì—…',
        society_scope: 'ì‚¬íšŒ ì „ë°˜',
        unknown_scope: 'ì˜ ëª¨ë¥´ê² ë‹¤',
        // ì‹¤íŒ¨ ë°˜ì‘ (Q13)
        iterate_on_failure: 'êµ¬ì¡° ê°œì„ ',
        pivot_on_failure: 'ë¹ ë¥´ê²Œ ì „í™˜',
        pause_on_failure: 'ì ì‹œ ì •ë¦¬',
        emotionally_affected: 'í¬ê²Œ í”ë“¤ë¦¼',
        // ë²„íŒ€ ì•µì»¤ (Q14)
        reward_anchor: 'ë³´ìƒ',
        growth_anchor: 'ì„±ì¥',
        people_anchor: 'ì‚¬ëŒ',
        meaning_anchor: 'ì˜ë¯¸/ë°©í–¥ì„±',
        stability_anchor: 'ì•ˆì •ì„±',
        // ì™¸ë¶€ ê¸°ëŒ€ ë°˜ì‘ (Q15)
        external_structure_ok: 'ê¸°ì¤€ì´ ìˆìœ¼ë©´ í¸í•¨',
        neutral_to_expectation: 'ìƒê´€ì—†ìŒ',
        expectation_pressure: 'ë¶€ë‹´ë¨',
        // ê´€ì‹¬ ë¶„ì•¼
        problem_solving: 'ë¬¸ì œí•´ê²°',
        creating: 'ì°½ì‘/ë””ìì¸',
        helping_teaching: 'ë„ì›€/ê°€ë¥´ì¹¨',
        data_numbers: 'ë°ì´í„°/ìˆ«ì',
        organizing: 'ì¡°ì§/ê´€ë¦¬',
        influencing: 'ì˜í–¥ë ¥/ì„¤ë“',
        // ê°•ì 
        analytical: 'ë¶„ì„ë ¥',
        creative: 'ì°½ì˜ë ¥',
        communication: 'ì†Œí†µë ¥',
        structured_execution: 'ì‹¤í–‰ë ¥',
        persistence: 'ëˆê¸°',
        fast_learning: 'í•™ìŠµë ¥'
      };
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      document.addEventListener('DOMContentLoaded', loadProfile);
      
      async function loadProfile() {
        try {
          const res = await fetch('/api/ai-analyzer/profile');
          const data = await res.json();
          
          if (!data.success) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            return;
          }
          
          profileData = data.profile;
          
          // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
          updateMetadata(data.metadata);
          
          // ë°ì´í„° ë Œë”ë§
          renderProfile(data.profile);
          
          // ë³€ê²½ì‚¬í•­ ì²´í¬
          checkForChanges();
          
          // ë¡œë”© ìˆ¨ê¸°ê³  ì²« ë²ˆì§¸ íƒ­ í‘œì‹œ
          document.getElementById('loading-state').classList.add('hidden');
          document.getElementById('tab-career').classList.remove('hidden');
          
        } catch (error) {
          document.getElementById('loading-state').innerHTML = '<p class="text-red-400">í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
      }
      
      function updateMetadata(metadata) {
        if (metadata.last_updated_at) {
          const updatedDate = new Date(metadata.last_updated_at);
          document.getElementById('meta-updated').innerHTML = '<i class="far fa-clock mr-1"></i>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + updatedDate.toLocaleDateString('ko-KR');
        }
        if (metadata.last_analysis_at) {
          const analysisDate = new Date(metadata.last_analysis_at);
          document.getElementById('meta-analysis').innerHTML = '<i class="fas fa-chart-line mr-1"></i>ë§ˆì§€ë§‰ ë¶„ì„: ' + analysisDate.toLocaleDateString('ko-KR');
        }
        const completeness = Math.round((metadata.data_completeness || 0) * 100);
        document.getElementById('meta-completeness').innerHTML = 'ì™„ì„±ë„: <div class="w-24 h-2 bg-wiki-border/30 rounded-full overflow-hidden"><div class="h-full bg-wiki-primary rounded-full" style="width: ' + completeness + '%"></div></div> ' + completeness + '%';
        
        // ìš”ì•½ í—¤ë” ì—…ë°ì´íŠ¸
        const summaryEl = document.getElementById('profile-summary');
        summaryEl.innerHTML = '<p class="text-wiki-muted">ì´ ' + (metadata.total_facts_count || 0) + 'ê°œì˜ í”„ë¡œí•„ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
      }
      
      function renderProfile(profile) {
        if (!profile) return;
        
        // Career State
        if (profile.career_state) {
          const cs = profile.career_state;
          setText('field-role_identity', valueLabels[cs.role_identity] || cs.role_identity || '-');
          setText('field-career_stage_years', valueLabels[cs.career_stage_years] || cs.career_stage_years || '-');
          setText('field-transition_status', valueLabels[cs.transition_status] || cs.transition_status || '-');
          renderSkillLevel(cs.skill_level);
        }
        
        // Universal Answers
        if (profile.universal_answers) {
          const ua = profile.universal_answers;
          renderTags('field-interest', ua.interest, 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30');
          renderTags('field-strength', ua.strength, 'bg-blue-500/20 text-blue-300 border-blue-500/30');
          renderTags('field-dislike', ua.dislike, 'bg-red-500/20 text-red-300 border-red-500/30');
          setText('field-priority', valueLabels[ua.priority] || ua.priority || '-');
          
          // ë‚˜ë¥¼ ì•Œì•„ê°€ê¸° (Q8-Q15)
          setText('field-workstyle_social', valueLabels[ua.workstyle_social] || ua.workstyle_social || '-');
          renderLanguageTags('field-language', ua.language);
          renderTagsWithLabel('field-mm_sacrifice', ua.mm_sacrifice, 'bg-orange-500/20 text-orange-300 border-orange-500/30');
          renderTagsWithLabel('field-mm_energy_drain', ua.mm_energy_drain, 'bg-red-500/20 text-red-300 border-red-500/30');
          renderTagsWithLabel('field-mm_achievement', ua.mm_achievement, 'bg-green-500/20 text-green-300 border-green-500/30');
          setText('field-mm_execution', valueLabels[ua.mm_execution] || ua.mm_execution || '-');
          setText('field-mm_impact_scope', valueLabels[ua.mm_impact_scope] || ua.mm_impact_scope || '-');
          setText('field-mm_failure', valueLabels[ua.mm_failure] || ua.mm_failure || '-');
          setText('field-mm_anchor', valueLabels[ua.mm_anchor] || ua.mm_anchor || '-');
          setText('field-mm_external', valueLabels[ua.mm_external] || ua.mm_external || '-');
        }
        
        // Transition Signal
        if (profile.transition_signal) {
          const ts = profile.transition_signal;
          renderTags('field-desired_types', ts.desired_types, 'bg-purple-500/20 text-purple-300 border-purple-500/30');
          setText('field-motivation', valueLabels[ts.motivation] || ts.motivation || '-');
          setText('field-timeline', valueLabels[ts.timeline] || ts.timeline || '-');
          renderTags('field-blockers', ts.blockers, 'bg-orange-500/20 text-orange-300 border-orange-500/30');
        }
        
        // Narrative Facts
        if (profile.narrative_facts) {
          setText('field-highAliveMoment', profile.narrative_facts.highAliveMoment || '-');
          setText('field-lostMoment', profile.narrative_facts.lostMoment || '-');
        }
        
        // Round Answers
        if (profile.round_answers && profile.round_answers.length > 0) {
          const container = document.getElementById('round-answers-container');
          container.innerHTML = profile.round_answers.map((ra, i) => 
            '<div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">' +
              '<h4 class="text-sm font-medium text-wiki-muted mb-3">ë¼ìš´ë“œ ' + ra.round + ' ë‹µë³€ #' + (i + 1) + '</h4>' +
              '<p class="text-white leading-relaxed">' + escapeHtml(ra.answer || '-') + '</p>' +
            '</div>'
          ).join('');
        }
        
        // Resume Data
        if (profile.resume_data) {
          const rd = profile.resume_data;
          renderTags('field-skills', rd.skills, 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30');
          renderTags('field-certifications', rd.certifications, 'bg-amber-500/20 text-amber-300 border-amber-500/30');
          renderTags('field-industries', rd.industries, 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30');
          setText('field-education_level', rd.education_level || '-');
          setText('field-role_type', rd.role_type || '-');
        }
      }
      
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }
      
      function renderTags(id, items, colorClass) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || items.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        el.innerHTML = items.map(item => 
          '<span class="px-3 py-1 text-sm rounded-full border ' + colorClass + '">' + escapeHtml(item) + '</span>'
        ).join('');
      }
      
      // í† í°ì„ í•œêµ­ì–´ ë¼ë²¨ë¡œ ë³€í™˜í•˜ì—¬ íƒœê·¸ ë Œë”ë§
      function renderTagsWithLabel(id, items, colorClass) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || items.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        el.innerHTML = items.map(item => {
          const label = valueLabels[item] || item;
          return '<span class="px-3 py-1 text-sm rounded-full border ' + colorClass + '">' + escapeHtml(label) + '</span>';
        }).join('');
      }
      
      // ì–¸ì–´ íƒœê·¸ ë Œë”ë§ (ìˆ˜ì¤€ í¬í•¨)
      function renderLanguageTags(id, langData) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!langData) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        
        // ë°°ì—´ì¸ ê²½ìš° (ë‹¨ìˆœ ì–¸ì–´ ëª©ë¡)
        if (Array.isArray(langData)) {
          if (langData.length === 0 || (langData.length === 1 && langData[0] === 'none')) {
            el.innerHTML = '<span class="text-wiki-muted">ì—†ìŒ</span>';
            return;
          }
          el.innerHTML = langData.filter(l => l !== 'none').map(lang => 
            '<span class="px-3 py-1 text-sm rounded-full border bg-indigo-500/20 text-indigo-300 border-indigo-500/30">' + escapeHtml(lang) + '</span>'
          ).join('');
          return;
        }
        
        // ê°ì²´ì¸ ê²½ìš° (ì–¸ì–´: {level, label} í˜•íƒœ)
        const entries = Object.entries(langData);
        if (entries.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        
        const langLabels = {
          korean: 'í•œêµ­ì–´', english: 'ì˜ì–´', japanese: 'ì¼ë³¸ì–´', chinese: 'ì¤‘êµ­ì–´',
          spanish: 'ìŠ¤í˜ì¸ì–´', german: 'ë…ì¼ì–´', french: 'í”„ë‘ìŠ¤ì–´', russian: 'ëŸ¬ì‹œì•„ì–´',
          italian: 'ì´íƒˆë¦¬ì•„ì–´', portuguese: 'í¬ë¥´íˆ¬ê°ˆì–´', arabic: 'ì•„ëì–´', hindi: 'íŒë””ì–´',
          vietnamese: 'ë² íŠ¸ë‚¨ì–´', thai: 'íƒœêµ­ì–´', indonesian: 'ì¸ë„ë„¤ì‹œì•„ì–´', turkish: 'í„°í‚¤ì–´'
        };
        const levelLabels = {
          beginner: 'ì´ˆê¸‰', intermediate: 'ì¤‘ê¸‰', advanced: 'ê³ ê¸‰', native: 'ì›ì–´ë¯¼'
        };
        
        el.innerHTML = entries.map(([lang, info]) => {
          const langName = langLabels[lang] || lang;
          const levelName = levelLabels[info?.level] || info?.level || '';
          return '<span class="px-3 py-1 text-sm rounded-full border bg-indigo-500/20 text-indigo-300 border-indigo-500/30">' + 
            escapeHtml(langName) + (levelName ? ' (' + levelName + ')' : '') + '</span>';
        }).join('');
      }
      
      function renderSkillLevel(level) {
        const el = document.getElementById('field-skill_level');
        if (!el) return;
        const lvl = level || 0;
        const labels = ['ë¯¸ì„¤ì •', 'ì…ë¬¸', 'ì´ˆê¸‰', 'ì¤‘ê¸‰', 'ê³ ê¸‰', 'ì „ë¬¸ê°€'];
        el.innerHTML = '<div class="flex gap-1">' +
          [1,2,3,4,5].map(i => 
            '<span class="skill-dot w-3 h-3 rounded-full ' + (i <= lvl ? 'bg-wiki-primary' : 'bg-wiki-border/50') + '"></span>'
          ).join('') +
          '</div><span class="text-wiki-muted text-sm ml-2">' + labels[lvl] + '</span>';
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // íƒ­ ì „í™˜
      function switchTab(tabName) {
        // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('.profile-tab').forEach(btn => {
          btn.classList.remove('bg-wiki-primary', 'text-white');
          btn.classList.add('text-wiki-muted', 'hover:bg-wiki-card/50');
        });
        
        // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
        const activeBtn = document.querySelector('[data-tab="' + tabName + '"]');
        if (activeBtn) {
          activeBtn.classList.add('bg-wiki-primary', 'text-white');
          activeBtn.classList.remove('text-wiki-muted', 'hover:bg-wiki-card/50');
        }
        
        // ëª¨ë“  íƒ­ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        
        // ì„ íƒëœ íƒ­ íŒ¨ë„ í‘œì‹œ
        const activePanel = document.getElementById('tab-' + tabName);
        if (activePanel) {
          activePanel.classList.remove('hidden');
        }
      }
      
      // ë³€ê²½ì‚¬í•­ ì²´í¬
      async function checkForChanges() {
        try {
          const res = await fetch('/api/ai-analyzer/profile/diff');
          const data = await res.json();
          
          if (data.success && data.has_changes) {
            const banner = document.getElementById('changes-banner');
            const message = document.getElementById('changes-message');
            banner.classList.remove('hidden');
            message.textContent = data.recommendation || 'í”„ë¡œí•„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
          }
        } catch (error) {
        }
      }
      
      // í•„ë“œ í¸ì§‘
      function editField(category, field) {
        currentCategory = category;
        currentField = field;
        
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        
        title.textContent = fieldLabels[field] || field;
        
        let currentValue = '';
        if (profileData && profileData[category]) {
          currentValue = profileData[category][field];
        }
        
        // í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì…ë ¥ í¼ ìƒì„±
        if (Array.isArray(currentValue)) {
          content.innerHTML = '<textarea id="edit-value" rows="4" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥">' + (currentValue.join(', ')) + '</textarea>';
        } else if (typeof currentValue === 'number') {
          content.innerHTML = '<input type="number" id="edit-value" value="' + (currentValue || '') + '" min="0" max="5" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" />';
        } else {
          content.innerHTML = '<input type="text" id="edit-value" value="' + (currentValue || '') + '" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" />';
        }
        
        document.getElementById('edit-modal').classList.remove('hidden');
      }
      
      function closeEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
        currentCategory = null;
        currentField = null;
      }
      
      async function saveField() {
        if (!currentCategory || !currentField) return;
        
        const inputEl = document.getElementById('edit-value');
        let newValue = inputEl.value;
        
        // ë°°ì—´ íƒ€ì… ì²˜ë¦¬
        if (inputEl.tagName === 'TEXTAREA') {
          newValue = newValue.split(',').map(s => s.trim()).filter(Boolean);
        } else if (inputEl.type === 'number') {
          newValue = parseInt(newValue, 10);
        }
        
        try {
          const res = await fetch('/api/ai-analyzer/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              updates: {
                [currentCategory]: {
                  [currentField]: newValue
                }
              }
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            closeEditModal();
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°ì´í„° ë°˜ì˜
            loadProfile();
          } else {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (error) {
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
      
      // ë¹ ë¥¸ ì¬ë¶„ì„
      async function quickReanalyze() {
        try {
          const btn = event.target;
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì²˜ë¦¬ ì¤‘...';
          }
          
          const res = await fetch('/api/ai-analyzer/profile/quick-reanalyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              use_existing_data: true,
              skip_unchanged_steps: true
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            // analyzer_urlì´ ìˆìœ¼ë©´ ë¶„ì„ í˜ì´ì§€ë¡œ, ì—†ìœ¼ë©´ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
            if (data.analyzer_url) {
              window.location.href = data.analyzer_url;
            } else {
              window.location.href = '/user/ai-results';
            }
          } else {
            alert('ì¬ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-redo mr-2"></i>ë³€ê²½ì‚¬í•­ ì ìš©í•˜ì—¬ ì¬ë¶„ì„';
            }
          }
        } catch (error) {
          alert('ì¬ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
    </script>
    
    <style>
      .profile-tab::-webkit-scrollbar { display: none; }
      .tab-panel { animation: fadeIn 0.2s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  `
}

// AI ì¶”ì²œ í˜ì´ì§€ (ê²°ê³¼ + í”„ë¡œí•„ íƒ­)
app.get('/user/ai-results', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/ai-results')
  }
  
  const activeTab = (c.req.query('tab') || 'results') as 'results' | 'profile'
  const filter = (c.req.query('filter') || 'all') as 'all' | 'job' | 'major'
  const page = parseInt(c.req.query('page') || '1', 10)
  const limit = 10
  const offset = (page - 1) * limit
  
  try {
    // ì§„í–‰ì¤‘ì¸ ëª¨ë“  draft ì¡°íšŒ (ì™„ë£Œëœ ê²ƒì€ request_idë„ í•¨ê»˜ ì¡°íšŒ)
    // LEFT JOINìœ¼ë¡œ ai_analysis_requestsì™€ ì—°ê²°í•˜ì—¬ request_id ê°€ì ¸ì˜¤ê¸°
    const draftResults = await c.env.DB.prepare(`
      SELECT
        d.id, d.session_id, d.analysis_type, d.current_step,
        d.step1_answers_json, d.step4_answers_json, d.updated_at,
        latest_req.id as request_id
      FROM analyzer_drafts d
      LEFT JOIN (
        SELECT session_id, MAX(id) as id
        FROM ai_analysis_requests
        WHERE status = 'completed'
        GROUP BY session_id
      ) latest_req ON d.session_id = latest_req.session_id
      WHERE d.user_id = ? AND d.session_id NOT LIKE 'edit-%'
      ORDER BY d.updated_at DESC
    `).bind(user.id).all<{
      id: number
      session_id: string
      analysis_type: string
      current_step: number
      step1_answers_json: string | null
      step4_answers_json: string | null
      updated_at: string
      request_id: number | null
    }>()
    
    // ì´ ê°œìˆ˜ ì¡°íšŒ
    const countResult = await c.env.DB.prepare(`
      SELECT COUNT(*) as total
      FROM ai_analysis_results r
      JOIN ai_analysis_requests req ON r.request_id = req.id
      WHERE req.user_id = ?
      ${filter !== 'all' ? 'AND req.analysis_type = ?' : ''}
    `).bind(...(filter !== 'all' ? [user.id, filter] : [user.id])).first<{ total: number }>()
    
    const total = countResult?.total || 0
    const totalPages = Math.ceil(total / limit)
    
    // ê²°ê³¼ ì¡°íšŒ (ë²„ì „ ì •ë³´ í¬í•¨)
    const results = await c.env.DB.prepare(`
      SELECT
        r.id,
        r.request_id,
        r.result_json,
        r.confidence_score,
        r.created_at,
        r.engine_version,
        CASE WHEN r.premium_report_json IS NOT NULL THEN 1 ELSE 0 END as has_premium_report,
        req.session_id,
        req.analysis_type,
        req.version_number,
        req.version_note,
        req.parent_request_id
      FROM ai_analysis_results r
      JOIN ai_analysis_requests req ON r.request_id = req.id
      WHERE req.user_id = ?
      ${filter !== 'all' ? 'AND req.analysis_type = ?' : ''}
      ORDER BY r.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(...(filter !== 'all' ? [user.id, filter, limit, offset] : [user.id, limit, offset])).all<{
      id: number
      request_id: number
      result_json: string
      confidence_score: number | null
      created_at: string
      engine_version: string | null
      has_premium_report: number
      session_id: string
      analysis_type: string
      version_number: number | null
      version_note: string | null
      parent_request_id: number | null
    }>()
    
    // ê²°ê³¼ íŒŒì‹±
    const parsedResults: AiResultItem[] = (results.results || []).map(r => {
      let topRecs: Array<{ name: string; score?: number }> = []
      try {
        const parsed = JSON.parse(r.result_json)
        const fitTop3 = parsed.fit_top3 || []
        topRecs = fitTop3.slice(0, 3).map((j: any) => ({
          name: j.job_name || j.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
          score: j.fit_score
        }))
      } catch { }
      
      return {
        id: r.id,
        request_id: r.request_id,
        session_id: r.session_id,
        analysis_type: r.analysis_type as 'job' | 'major',
        top_recommendations: topRecs,
        confidence_score: r.confidence_score,
        created_at: r.created_at,
        engine_version: r.engine_version || 'v2',
        has_premium_report: r.has_premium_report === 1,
        version_number: r.version_number || 1,
        version_note: r.version_note || null,
        parent_request_id: r.parent_request_id || null
      }
    })
    
    const resultsContent = renderUserAiResultsContent({
      results: parsedResults,
      filter,
      totalCount: total,
      page,
      totalPages,
      drafts: (draftResults?.results || []).map(d => {
        // step1_answers_jsonì—ì„œ profileSubStep, currentRound ì¶”ì¶œ
        let profileSubStep = 1
        let currentRound = 0
        try {
          if (d.step1_answers_json) {
            const step1 = JSON.parse(d.step1_answers_json)
            profileSubStep = step1.profileSubStep || 1
            currentRound = step1.currentRound || 0
          }
          // step4_answers_jsonì—ì„œë„ currentRound í™•ì¸ (fallback)
          if (!currentRound && d.step4_answers_json) {
            const step4 = JSON.parse(d.step4_answers_json)
            currentRound = step4.current_round || 0
          }
        } catch { /* ignore parse errors */ }
        
        return {
          id: d.id,
          session_id: d.session_id,
          analysis_type: d.analysis_type as 'job' | 'major',
          current_step: d.current_step,
          profile_sub_step: profileSubStep,
          current_round: currentRound,
          updated_at: d.updated_at,
          request_id: d.request_id  // ì™„ë£Œëœ ë¶„ì„ì˜ request_id (ê²°ê³¼ í˜ì´ì§€ ë§í¬ìš©)
        }
      })
    })
    
    // í”„ë¡œí•„ ì»¨í…ì¸  HTML
    const profileContent = generateProfileContentHtml()
    
    // íƒ­ êµ¬ì¡° ì»¨í…ì¸ 
    const tabbedContent = `
      <!-- ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="flex items-center gap-2 sm:gap-4 mb-6 border-b border-wiki-border/40 pb-4">
        <a href="/user/ai-results?tab=results"
           class="flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition ${activeTab === 'results' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:text-white hover:bg-wiki-card/50'}">
          <i class="fas fa-robot"></i>
          <span>AI ì¶”ì²œ</span>
        </a>
        <a href="/user/ai-results?tab=profile"
           class="flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition ${activeTab === 'profile' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:text-white hover:bg-wiki-card/50'}">
          <i class="fas fa-user-circle"></i>
          <span>ë‚´ í”„ë¡œí•„</span>
        </a>
      </div>
      
      <!-- íƒ­ ì»¨í…ì¸  -->
      ${activeTab === 'results' ? `
        <p class="text-wiki-muted mb-6">AI ì¶”ì²œì„ ë°›ìœ¼ë©´ ì—¬ê¸°ì„œ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        ${resultsContent}
        
        <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
        <div id="delete-draft-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
          <div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
            <div class="text-center mb-6">
              <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center">
                <i class="fas fa-trash text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold text-white mb-2">ì§„í–‰ì¤‘ì¸ ì¶”ì²œ ì‚­ì œ</h3>
              <p class="text-wiki-muted text-sm">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì‘ì„±í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
            </div>
            <div class="flex gap-3">
              <button onclick="hideDeleteModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">
                ì·¨ì†Œ
              </button>
              <button onclick="confirmDeleteDraft()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium">
                ì‚­ì œ
              </button>
            </div>
          </div>
        </div>
        
        <script>
          let pendingDeleteSessionId = null;
          
          function deleteDraft(sessionId) {
            pendingDeleteSessionId = sessionId;
            document.getElementById('delete-draft-modal').classList.remove('hidden');
          }
          
          function hideDeleteModal() {
            document.getElementById('delete-draft-modal').classList.add('hidden');
            pendingDeleteSessionId = null;
          }
          
          async function confirmDeleteDraft() {
            if (!pendingDeleteSessionId) return;
            
            try {
              const response = await fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(pendingDeleteSessionId), {
                method: 'DELETE',
                credentials: 'same-origin'
              });
              
              if (response.ok) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ì‚­ì œ (job/major ë‘˜ ë‹¤)
                localStorage.removeItem('analyzer_draft');
                localStorage.removeItem('analyzer_draft_timestamp');
                localStorage.removeItem('analyzer_draft_major');
                localStorage.removeItem('analyzer_draft_major_timestamp');
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ ê°±ì‹ 
                window.location.reload();
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              }
            } catch (error) {
              alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            
            hideDeleteModal();
          }
          
          async function deleteAllDrafts() {
            if (!confirm('ì§„í–‰ì¤‘ì¸ ëª¨ë“  ë¶„ì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
              return;
            }
            
            try {
              const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                method: 'DELETE',
                credentials: 'same-origin'
              });
              
              if (response.ok) {
                const data = await response.json();
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ëª¨ë‘ ì‚­ì œ
                localStorage.removeItem('analyzer_draft');
                localStorage.removeItem('analyzer_draft_timestamp');
                localStorage.removeItem('analyzer_draft_major');
                localStorage.removeItem('analyzer_draft_major_timestamp');
                
                alert(data.deleted_count + 'ê°œì˜ ì§„í–‰ì¤‘ ë¶„ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.reload();
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              }
            } catch (error) {
              alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }
        </script>
      ` : profileContent}
    `
    
    const pageContent = renderUserLayoutContent({
      title: 'AI ì¶”ì²œ',
      currentPath: '/user/ai-results',
      children: tabbedContent,
      username: user.username || user.email || 'user_' + user.id,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    
    return c.html(renderLayoutWithContext(c, pageContent, 'AI ì¶”ì²œ - ë§ˆì´í˜ì´ì§€ - Careerwiki'))
    
  } catch (error) {
    const errorContent = renderUserLayoutContent({
      title: 'AI ì¶”ì²œ',
      currentPath: '/user/ai-results',
      children: `<div class="text-center py-16"><p class="text-wiki-muted">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>`,
      username: user.username || user.email,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    return c.html(renderLayoutWithContext(c, errorContent, 'AI ì¶”ì²œ - ë§ˆì´í˜ì´ì§€ - Careerwiki'))
  }
})

// AI ì¶”ì²œ ê²°ê³¼ ìƒì„¸ í˜ì´ì§€
app.get('/user/ai-results/:requestId', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=' + encodeURIComponent(c.req.path))
  }

  const requestId = parseInt(c.req.param('requestId'), 10)

  try {
    // ê²°ê³¼ ì¡°íšŒ - analysis_typeë§Œ í™•ì¸í•˜ì—¬ ì ì ˆí•œ analyzer í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    const result = await c.env.DB.prepare(`
      SELECT req.analysis_type
      FROM ai_analysis_requests req
      LEFT JOIN analyzer_drafts d ON req.session_id = d.session_id
      WHERE req.id = ? AND (req.user_id = ? OR d.user_id = ?)
    `).bind(requestId, user.id, user.id).first<{
      analysis_type: string
    }>()
    
    if (!result) {
      return c.redirect('/user/ai-results')
    }

    const analyzerPath = result.analysis_type === 'job' ? '/analyzer/job' : '/analyzer/major'
    return c.redirect(`${analyzerPath}?view=${requestId}`)
    
  } catch (error) {
    const errorPageContent = renderUserLayoutContent({
      title: 'ì˜¤ë¥˜',
      currentPath: '/user/ai-results',
      children: `<div class="text-center py-16"><p class="text-wiki-muted">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>`,
      username: user.username || user.email,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    return c.html(renderLayoutWithContext(c, errorPageContent, 'ì˜¤ë¥˜ - ë§ˆì´í˜ì´ì§€ - Careerwiki'))
  }
})

// ë‚´ ì‘ì„± ëŒ“ê¸€ í˜ì´ì§€
app.get('/user/comments', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/comments')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // ë‚´ ëŒ“ê¸€ ì¡°íšŒ (pages í…Œì´ë¸”ê³¼ ì¡°ì¸)
  // author_idëŠ” ìˆ«ìë¡œ ì €ì¥ë˜ë¯€ë¡œ CASTë¡œ ë¹„êµ
  const comments = await c.env.DB.prepare(`
    SELECT c.id, c.content, c.created_at, p.page_type, p.slug, p.title as page_title
    FROM comments c
    JOIN pages p ON c.page_id = p.id
    WHERE CAST(c.author_id AS INTEGER) = ? AND c.status != 'deleted'
    ORDER BY c.created_at DESC
    LIMIT 100
  `).bind(user.id).all<{
    id: number; content: string; created_at: string; page_type: string; 
    slug: string; page_title: string | null
  }>()
  
  const allComments = comments.results || []
  
  // í˜ì´ì§€ íƒ€ì…ë³„ ë¶„ë¥˜ (guideëŠ” howtoë¡œ ì·¨ê¸‰)
  const jobComments = allComments.filter(c => c.page_type === 'job')
  const majorComments = allComments.filter(c => c.page_type === 'major')
  const guideComments = allComments.filter(c => c.page_type === 'guide' || c.page_type === 'howto')
  
  // í•„í„° ì ìš©
  let filteredComments = allComments
  if (filter === 'job') filteredComments = jobComments
  else if (filter === 'major') filteredComments = majorComments
  else if (filter === 'howto') filteredComments = guideComments
  
  // í˜ì´ì§€ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ê³¼ ìƒ‰ìƒ
  const getTypeInfo = (pageType: string) => {
    switch (pageType) {
      case 'job': return { icon: 'fa-briefcase', color: 'text-blue-400', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/30', label: 'ì§ì—…' }
      case 'major': return { icon: 'fa-university', color: 'text-emerald-400', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/30', label: 'ì „ê³µ' }
      case 'guide':
      case 'howto': return { icon: 'fa-lightbulb', color: 'text-amber-400', bgColor: 'bg-amber-500/10', borderColor: 'border-amber-500/30', label: 'HowTo' }
      default: return { icon: 'fa-file', color: 'text-wiki-muted', bgColor: 'bg-wiki-card/50', borderColor: 'border-wiki-border/40', label: 'ê¸°íƒ€' }
    }
  }
  
  // slugì—ì„œ type prefix ì œê±°í•˜ê³  ì‹¤ì œ URL path ìƒì„±
  const getCommentUrl = (pageType: string, slug: string) => {
    // slugê°€ "guide:some-slug" ë˜ëŠ” "job:some-slug" í˜•íƒœë¡œ ì €ì¥ë¨
    const cleanSlug = slug.replace(/^(guide|job|major):/, '')
    // guideëŠ” howtoë¡œ ë¼ìš°íŒ…
    const urlPath = pageType === 'guide' ? 'howto' : pageType
    return `/${urlPath}/${cleanSlug}`
  }
  
  const innerContent = `
      <p class="text-wiki-muted mb-6">ë‚´ê°€ ì‘ì„±í•œ ëŒ“ê¸€ë“¤ì„ í™•ì¸í•©ë‹ˆë‹¤</p>
      
      <!-- í•„í„° íƒ­ -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto">
        <a href="/user/comments?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          ì „ì²´ <span class="ml-1 opacity-70">(${allComments.length})</span>
        </a>
        <a href="/user/comments?filter=job" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'job' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-briefcase mr-1.5"></i>ì§ì—… <span class="ml-1 opacity-70">(${jobComments.length})</span>
        </a>
        <a href="/user/comments?filter=major" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'major' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-university mr-1.5"></i>ì „ê³µ <span class="ml-1 opacity-70">(${majorComments.length})</span>
        </a>
        <a href="/user/comments?filter=howto" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'howto' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-lightbulb mr-1.5"></i>HowTo <span class="ml-1 opacity-70">(${guideComments.length})</span>
        </a>
      </div>
      
      ${filteredComments.length > 0 ? `
        <div class="space-y-4">
          ${filteredComments.map(comment => {
            const typeInfo = getTypeInfo(comment.page_type)
            const commentUrl = getCommentUrl(comment.page_type, comment.slug)
            return `
            <a href="${escapeHtml(commentUrl)}#comment-${comment.id}" 
               class="block p-4 bg-wiki-bg/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
              <div class="flex items-start justify-between gap-4 mb-2">
                <div class="flex items-center gap-2 min-w-0">
                  <span class="px-2 py-0.5 rounded-full text-xs ${typeInfo.bgColor} ${typeInfo.color} ${typeInfo.borderColor} border shrink-0">
                    <i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.label}
                  </span>
                  <span class="text-sm text-wiki-primary group-hover:underline truncate">
                    ${escapeHtml(comment.page_title || comment.slug.replace(/^(guide|job|major):/, ''))}
                  </span>
                </div>
                <span class="text-xs text-wiki-muted shrink-0">${formatDateSafe(comment.created_at)}</span>
              </div>
              <p class="text-wiki-text text-sm line-clamp-2">${escapeHtml(comment.content)}</p>
            </a>
          `}).join('')}
        </div>
      ` : `
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-bg/50 mb-4">
            <i class="fas fa-comments text-2xl text-wiki-muted"></i>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">
            ${filter === 'all' ? 'ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤' : `ì‘ì„±í•œ ${filter === 'job' ? 'ì§ì—…' : filter === 'major' ? 'ì „ê³µ' : 'HowTo'} ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤`}
          </h3>
          <p class="text-wiki-muted">
            ${filter === 'all' 
              ? 'ì§ì—…, ì „ê³µ, HowTo í˜ì´ì§€ì—ì„œ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!' 
              : `${filter === 'job' ? 'ì§ì—…ìœ„í‚¤' : filter === 'major' ? 'ì „ê³µìœ„í‚¤' : 'HowTo ê°€ì´ë“œ'}ì—ì„œ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!`}
          </p>
          <div class="mt-4">
            <a href="/${filter === 'all' ? 'job' : (filter === 'howto' ? 'howto' : filter)}" class="inline-flex items-center gap-2 px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white rounded-lg text-sm transition">
              <i class="fas fa-arrow-right"></i>
              ${filter === 'job' ? 'ì§ì—…ìœ„í‚¤' : filter === 'major' ? 'ì „ê³µìœ„í‚¤' : filter === 'howto' ? 'HowTo ê°€ì´ë“œ' : 'ì§ì—…ìœ„í‚¤'} ë‘˜ëŸ¬ë³´ê¸°
            </a>
          </div>
        </div>
      `}
  `
  
  const pageContent = renderUserLayoutContent({
    title: 'ì‘ì„± ëŒ“ê¸€',
    currentPath: '/user/comments',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, 'ì‘ì„± ëŒ“ê¸€ - ë§ˆì´í˜ì´ì§€ - Careerwiki', 'ë‚´ê°€ ì‘ì„±í•œ ëŒ“ê¸€')
  )
})

// ì €ì¥í•¨ í˜ì´ì§€
app.get('/user/bookmarks', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/bookmarks')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // ì €ì¥ëœ í•­ëª© ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ ìˆìŒ)
  let bookmarkList: Array<{ id: number; item_type: string; item_slug: string; item_title: string; created_at: string }> = []
  try {
    const bookmarks = await c.env.DB.prepare(`
      SELECT b.id, b.item_type, b.item_slug, b.item_title, b.created_at
      FROM user_bookmarks b
      WHERE b.user_id = ?
      ORDER BY b.created_at DESC
      LIMIT 100
    `).bind(user.id).all<{
      id: number; item_type: string; item_slug: string; item_title: string; created_at: string
    }>()
    bookmarkList = bookmarks.results || []
  } catch (e) {
    // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
  }
  
  // íƒ€ì…ë³„ë¡œ ë¶„ë¥˜
  const jobs = bookmarkList.filter(b => b.item_type === 'job')
  const majors = bookmarkList.filter(b => b.item_type === 'major')
  const howtos = bookmarkList.filter(b => b.item_type === 'howto')
  
  // í•„í„° ì ìš©
  let filteredBookmarks = bookmarkList
  if (filter === 'job') filteredBookmarks = jobs
  else if (filter === 'major') filteredBookmarks = majors
  else if (filter === 'howto') filteredBookmarks = howtos
  
  // íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ê³¼ ìƒ‰ìƒ
  const getTypeInfo = (itemType: string) => {
    switch (itemType) {
      case 'job': return { icon: 'fa-briefcase', color: 'text-blue-400', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/30', label: 'ì§ì—…', path: 'job' }
      case 'major': return { icon: 'fa-university', color: 'text-emerald-400', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/30', label: 'ì „ê³µ', path: 'major' }
      case 'howto': return { icon: 'fa-lightbulb', color: 'text-amber-400', bgColor: 'bg-amber-500/10', borderColor: 'border-amber-500/30', label: 'HowTo', path: 'howto' }
      default: return { icon: 'fa-file', color: 'text-wiki-muted', bgColor: 'bg-wiki-card/50', borderColor: 'border-wiki-border/40', label: 'ê¸°íƒ€', path: '' }
    }
  }
  
  const innerContent = `
      <p class="text-wiki-muted mb-6">ì €ì¥í•œ ì§ì—…, ì „ê³µ, HowToë¥¼ í™•ì¸í•©ë‹ˆë‹¤</p>
      
      <!-- í•„í„° íƒ­ -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto">
        <a href="/user/bookmarks?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          ì „ì²´ <span class="ml-1 opacity-70">(${bookmarkList.length})</span>
        </a>
        <a href="/user/bookmarks?filter=job" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'job' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-briefcase mr-1.5"></i>ì§ì—… <span class="ml-1 opacity-70">(${jobs.length})</span>
        </a>
        <a href="/user/bookmarks?filter=major" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'major' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-university mr-1.5"></i>ì „ê³µ <span class="ml-1 opacity-70">(${majors.length})</span>
        </a>
        <a href="/user/bookmarks?filter=howto" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'howto' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-lightbulb mr-1.5"></i>HowTo <span class="ml-1 opacity-70">(${howtos.length})</span>
        </a>
      </div>
      
      ${filteredBookmarks.length > 0 ? `
        <div class="space-y-4">
          ${filteredBookmarks.map(bookmark => {
            const typeInfo = getTypeInfo(bookmark.item_type)
            return `
            <a href="/${typeInfo.path}/${escapeHtml(bookmark.item_slug)}" 
               class="block p-4 bg-wiki-bg/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
              <div class="flex items-center sm:items-start justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0">
                  <span class="px-2 py-0.5 rounded-full text-xs ${typeInfo.bgColor} ${typeInfo.color} ${typeInfo.borderColor} border shrink-0">
                    <i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.label}
                  </span>
                  <span class="text-wiki-text group-hover:text-wiki-primary transition truncate">
                    ${escapeHtml(bookmark.item_title)}
                  </span>
                </div>
                <div class="flex items-center gap-3 shrink-0">
                  <span class="text-xs text-wiki-muted">${new Date(Number(bookmark.created_at) * 1000).toLocaleDateString('ko-KR')}</span>
                  <i class="fas fa-chevron-right text-wiki-muted text-xs group-hover:text-wiki-primary transition"></i>
                </div>
              </div>
            </a>
          `}).join('')}
        </div>
      ` : `
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-bg/50 mb-4">
            <i class="fas fa-bookmark text-2xl text-wiki-muted"></i>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">
            ${filter === 'all' ? 'ì €ì¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤' : `ì €ì¥í•œ ${filter === 'job' ? 'ì§ì—…' : filter === 'major' ? 'ì „ê³µ' : 'HowTo'}ì´ ì—†ìŠµë‹ˆë‹¤`}
          </h3>
          <p class="text-wiki-muted">
            ${filter === 'all' 
              ? 'ì§ì—…, ì „ê³µ, HowTo í˜ì´ì§€ì—ì„œ ë¶ë§ˆí¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•´ë³´ì„¸ìš”!' 
              : `${filter === 'job' ? 'ì§ì—…ìœ„í‚¤' : filter === 'major' ? 'ì „ê³µìœ„í‚¤' : 'HowTo ê°€ì´ë“œ'}ì—ì„œ ë¶ë§ˆí¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•´ë³´ì„¸ìš”!`}
          </p>
          <div class="mt-4">
            <a href="/${filter === 'all' ? 'job' : filter}" class="inline-flex items-center gap-2 px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white rounded-lg text-sm transition">
              <i class="fas fa-arrow-right"></i>
              ${filter === 'job' ? 'ì§ì—…ìœ„í‚¤' : filter === 'major' ? 'ì „ê³µìœ„í‚¤' : filter === 'howto' ? 'HowTo ê°€ì´ë“œ' : 'ì§ì—…ìœ„í‚¤'} ë‘˜ëŸ¬ë³´ê¸°
            </a>
          </div>
        </div>
      `}
  `
  
  const pageContent = renderUserLayoutContent({
    title: 'ì €ì¥í•¨',
    currentPath: '/user/bookmarks',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, 'ì €ì¥í•¨ - ë§ˆì´í˜ì´ì§€ - Careerwiki', 'ì €ì¥í•œ ì§ì—…, ì „ê³µ, HowTo')
  )
})

// ============================================================================
// ë¶ë§ˆí¬ API (ì €ì¥ í† ê¸€)
// ============================================================================

// ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸ API
app.get('/api/bookmark/:type/:slug', async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ saved: false, error: 'not_logged_in' })
  }
  
  const { type, slug } = c.req.param()
  if (!['job', 'major', 'howto'].includes(type)) {
    return c.json({ saved: false, error: 'invalid_type' }, 400)
  }
  
  try {
    const existing = await c.env.DB.prepare(`
      SELECT id FROM user_bookmarks WHERE user_id = ? AND item_type = ? AND item_slug = ?
    `).bind(user.id, type, slug).first()
    
    return c.json({ saved: !!existing })
  } catch (e) {
    return c.json({ saved: false, error: 'db_error' }, 500)
  }
})

// ë¶ë§ˆí¬ í† ê¸€ API (ì €ì¥/í•´ì œ)
app.post('/api/bookmark', async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'not_logged_in', message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  let body: { type: string; slug: string; title?: string }
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'invalid_body' }, 400)
  }
  
  const { type, slug, title } = body
  if (!type || !slug) {
    return c.json({ success: false, error: 'missing_params' }, 400)
  }
  if (!['job', 'major', 'howto'].includes(type)) {
    return c.json({ success: false, error: 'invalid_type' }, 400)
  }
  
  try {
    // ê¸°ì¡´ ë¶ë§ˆí¬ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT id FROM user_bookmarks WHERE user_id = ? AND item_type = ? AND item_slug = ?
    `).bind(user.id, type, slug).first<{ id: number }>()
    
    if (existing) {
      // ì´ë¯¸ ì €ì¥ë¨ -> ì‚­ì œ (í† ê¸€)
      await c.env.DB.prepare(`
        DELETE FROM user_bookmarks WHERE id = ?
      `).bind(existing.id).run()
      
      return c.json({ success: true, saved: false, message: 'ì €ì¥ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤' })
    } else {
      // ì €ì¥ë˜ì§€ ì•ŠìŒ -> ì¶”ê°€
      await c.env.DB.prepare(`
        INSERT INTO user_bookmarks (user_id, item_type, item_slug, item_title)
        VALUES (?, ?, ?, ?)
      `).bind(user.id, type, slug, title || null).run()
      
      return c.json({ success: true, saved: true, message: 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤' })
    }
  } catch (e) {
    return c.json({ success: false, error: 'db_error' }, 500)
  }
})

// ===== í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ API =====
// POST /api/user/profile-image - í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
app.post('/api/user/profile-image', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'unauthorized' }, 401)
  }
  
  try {
    const formData = await c.req.formData()
    const file = formData.get('image') as File | null
    
    if (!file) {
      return c.json({ success: false, error: 'ì´ë¯¸ì§€ íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // íŒŒì¼ ê²€ì¦
    const { validateContentType, validateFileSize, validateMagicNumber, uploadToR2 } = await import('./services/uploadService')
    
    const typeResult = validateContentType(file.type)
    if (!typeResult.valid) {
      return c.json({ success: false, error: typeResult.error }, 400)
    }
    
    // í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” 2MBë¡œ ì œí•œ
    const MAX_PROFILE_SIZE = 2 * 1024 * 1024
    if (file.size > MAX_PROFILE_SIZE) {
      return c.json({ success: false, error: 'í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” 2MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    const sizeResult = validateFileSize(file.size)
    if (!sizeResult.valid) {
      return c.json({ success: false, error: sizeResult.error }, 400)
    }
    
    // ë§¤ì§ ë„˜ë²„ ê²€ì¦
    const buffer = await file.arrayBuffer()
    if (!validateMagicNumber(buffer, file.type)) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ íŒŒì¼ì…ë‹ˆë‹¤' }, 400)
    }
    
    // íŒŒì¼ í‚¤ ìƒì„± (profile/userId/timestamp.ext)
    const now = new Date()
    const timestamp = now.getTime()
    const ext = typeResult.ext || 'jpg'
    const fileKey = `profile/${user.id}/${timestamp}.${ext}`
    
    // R2ì— ì—…ë¡œë“œ
    const uploadResult = await uploadToR2(
      c.env.UPLOADS,
      fileKey,
      buffer,
      file.type,
      { userId: String(user.id), type: 'profile' }
    )
    
    if (!uploadResult.success) {
      return c.json({ success: false, error: uploadResult.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨' }, 500)
    }
    
    // ê³µê°œ URL ìƒì„±
    const publicUrl = `/uploads/${fileKey}`
    
    // DB ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE users SET custom_picture_url = ?, updated_at = ? WHERE id = ?
    `).bind(publicUrl, Math.floor(Date.now() / 1000), user.id).run()
    
    return c.json({ 
      success: true, 
      url: publicUrl,
      message: 'í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤' 
    })
  } catch (e) {
    return c.json({ success: false, error: 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// DELETE /api/user/profile-image - í”„ë¡œí•„ ì´ë¯¸ì§€ ì´ˆê¸°í™” (ê¸°ë³¸ ì•„ì´ì½˜ìœ¼ë¡œ)
app.delete('/api/user/profile-image', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'unauthorized' }, 401)
  }
  
  try {
    // ê¸°ì¡´ custom_picture_urlì´ ìˆìœ¼ë©´ R2ì—ì„œ ì‚­ì œ ì‹œë„ (ì„ íƒì )
    if (user.custom_picture_url && user.custom_picture_url.startsWith('/uploads/')) {
      const fileKey = user.custom_picture_url.replace('/uploads/', '')
      const { deleteFromR2 } = await import('./services/uploadService')
      await deleteFromR2(c.env.UPLOADS, fileKey).catch(() => {})
    }
    
    // DBì—ì„œ custom_picture_url ì œê±°
    await c.env.DB.prepare(`
      UPDATE users SET custom_picture_url = NULL, updated_at = ? WHERE id = ?
    `).bind(Math.floor(Date.now() / 1000), user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ê¸°ë³¸ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤' 
    })
  } catch (e) {
    return c.json({ success: false, error: 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ===== ì„¸ì…˜ ê´€ë¦¬ API =====
import { listUserSessions, destroySession, destroyAllUserSessions, getUserSessionEntries } from './utils/session'

// GET /api/user/sessions - ë‚´ í™œì„± ì„¸ì…˜ ëª©ë¡
app.get('/api/user/sessions', requireAuth, async (c) => {
  const user = c.get('user')
  const currentToken = c.get('sessionToken')
  if (!user) return c.json({ error: 'unauthorized' }, 401)

  try {
    const sessions = await listUserSessions(c.env.KV, user.id, currentToken || undefined)
    return c.json({ sessions })
  } catch (e) {
    return c.json({ sessions: [], error: 'Failed to load sessions' }, 200)
  }
})

// DELETE /api/user/sessions/:prefix - íŠ¹ì • ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ
app.delete('/api/user/sessions/:prefix', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) return c.json({ error: 'unauthorized' }, 401)

  const prefix = c.req.param('prefix')
  const entries = await getUserSessionEntries(c.env.KV, user.id)
  const target = entries.find(s => s.token.substring(0, 8) === prefix)
  if (!target) return c.json({ error: 'Session not found' }, 404)

  // í˜„ì¬ ì„¸ì…˜ì€ ì‚­ì œ ë¶ˆê°€
  const currentToken = c.get('sessionToken')
  if (currentToken === target.token) {
    return c.json({ error: 'Cannot delete current session. Use logout instead.' }, 400)
  }

  await destroySession(c.env.KV, c.env.DB, target.token, 'user_logout', user.id)
  return c.json({ success: true })
})

// POST /api/user/sessions/logout-others - ë‹¤ë¥¸ ê¸°ê¸° ì „ì²´ ë¡œê·¸ì•„ì›ƒ
app.post('/api/user/sessions/logout-others', requireAuth, async (c) => {
  const user = c.get('user')
  const currentToken = c.get('sessionToken')
  if (!user) return c.json({ error: 'unauthorized' }, 401)

  const entries = await getUserSessionEntries(c.env.KV, user.id)
  if (entries.length === 0) return c.json({ success: true, destroyed: 0 })

  const others = entries.filter(s => s.token !== currentToken)
  if (others.length === 0) return c.json({ success: true, destroyed: 0 })

  // ì„¸ì…˜ KVë§Œ ì§ì ‘ ì‚­ì œ (destroySession Në²ˆ í˜¸ì¶œ ëŒ€ì‹  ë³‘ë ¬ ì‚­ì œ)
  await Promise.all(others.map(s => c.env.KV.delete(`session:${s.token}`)))

  // ì¸ë±ìŠ¤ë¥¼ í˜„ì¬ ì„¸ì…˜ë§Œ ë‚¨ê¸´ ê²ƒìœ¼ë¡œ ê°±ì‹ 
  const current = entries.find(s => s.token === currentToken)
  if (current) {
    await c.env.KV.put(
      `user-sessions:${user.id}`,
      JSON.stringify({ sessions: [current] }),
      { expirationTtl: 30 * 24 * 60 * 60 }
    )
  } else {
    await c.env.KV.delete(`user-sessions:${user.id}`)
  }

  // ê°ì‚¬ ë¡œê·¸ ì¼ê´„ ì—…ë°ì´íŠ¸ (ë¹„ì°¨ë‹¨)
  c.executionCtx.waitUntil(
    c.env.DB.prepare(`
      UPDATE user_sessions SET expired_at = ?, logout_reason = ? WHERE user_id = ? AND expired_at IS NULL
    `).bind(Math.floor(Date.now() / 1000), 'all_devices_logout', user.id).run().catch(() => {})
  )

  return c.json({ success: true, destroyed: others.length })
})

// Phase 3 Day 4: ê°œì¸ ì„¤ì • í˜ì´ì§€
app.get('/user/settings', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect(`/login?redirect=${encodeURIComponent(c.req.path + c.req.query())}`)
  }
  
  const userData = {
    id: user.id,
    name: user.name,
    email: user.email,
    username: user.username,
    picture_url: user.picture_url,
    custom_picture_url: user.custom_picture_url,
    role: user.role,
    created_at: user.created_at
  }
  
  // í”„ë¡œí•„ ì´ë¯¸ì§€ ìš°ì„ ìˆœìœ„: custom > OAuth > ê¸°ë³¸ ì•„ì´ì½˜
  const profileImageUrl = userData.custom_picture_url || userData.picture_url || null
  
  const innerContent = `
      <div class="space-y-6">
        <!-- í”„ë¡œí•„ ì •ë³´ ì„¹ì…˜ -->
        <div class="bg-wiki-bg/50 p-6 rounded-xl border border-wiki-border">
          <h2 class="text-xl font-semibold mb-4 text-wiki-text">
            <i class="fas fa-user mr-2 text-wiki-primary"></i>í”„ë¡œí•„ ì •ë³´
          </h2>
          
          <div class="space-y-4">
            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
            <div class="flex items-start gap-4">
              <div class="relative group">
                <div 
                  id="profile-image-container"
                  class="w-20 h-20 rounded-full overflow-hidden border-2 border-wiki-border cursor-pointer hover:border-wiki-primary transition-colors"
                  title="í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½"
                >
                  ${profileImageUrl ? `
                    <img 
                      id="profile-image"
                      src="${profileImageUrl}" 
                      alt="${userData.name || 'User'}"
                      class="w-full h-full object-cover"
                    />
                  ` : `
                    <div id="profile-image" class="w-full h-full bg-wiki-card flex items-center justify-center">
                      <i class="fas fa-user-circle text-4xl text-wiki-muted"></i>
                    </div>
                  `}
                  <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-full">
                    <i class="fas fa-camera text-white text-xl"></i>
                  </div>
                </div>
                <input 
                  type="file" 
                  id="profile-image-input" 
                  accept="image/jpeg,image/png,image/gif,image/webp"
                  class="hidden"
                />
              </div>
              <div class="flex-1 space-y-2">
                <p class="text-sm text-wiki-text font-medium">í”„ë¡œí•„ ì‚¬ì§„</p>
                <p class="text-xs text-wiki-muted">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ë³€ê²½í•˜ì„¸ìš”. (ìµœëŒ€ 2MB, JPG/PNG/GIF/WEBP)</p>
                <div class="flex flex-wrap gap-2 mt-2">
                  <button 
                    id="profile-image-upload-btn"
                    type="button"
                    class="px-4 py-2.5 min-h-[44px] text-sm bg-wiki-primary text-white rounded-lg hover:bg-blue-600 transition-colors"
                  >
                    <i class="fas fa-upload mr-1.5"></i>ì´ë¯¸ì§€ ë³€ê²½
                  </button>
                  ${userData.custom_picture_url ? `
                    <button 
                      id="profile-image-reset-btn"
                      type="button"
                      class="px-4 py-2.5 min-h-[44px] text-sm bg-wiki-card border border-wiki-border text-wiki-text rounded-lg hover:bg-wiki-bg transition-colors"
                    >
                      <i class="fas fa-undo mr-1.5"></i>ê¸°ë³¸ìœ¼ë¡œ ì´ˆê¸°í™”
                    </button>
                  ` : ''}
                </div>
                <div id="profile-image-status" class="text-xs mt-2 hidden"></div>
              </div>
            </div>
            
            <!-- ì´ë©”ì¼ (í…ŒìŠ¤íŠ¸ ê³„ì •ì€ ìˆ¨ê¹€) -->
            ${user.google_id !== 'test-account' ? `
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">ì´ë©”ì¼</label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.email}
              </div>
              <p class="text-xs text-wiki-muted mt-1">Google ê³„ì • ì´ë©”ì¼ì…ë‹ˆë‹¤.</p>
            </div>
            ` : ''}
          </div>
        </div>
        
        <!-- ê³„ì • ì„¤ì • ì„¹ì…˜ -->
        <div class="bg-wiki-bg/50 p-6 rounded-xl border border-wiki-border">
          <h2 class="text-xl font-semibold mb-4 text-wiki-text">
            <i class="fas fa-id-card mr-2 text-wiki-primary"></i>ê³„ì • ì„¤ì •
          </h2>
          
          <div class="space-y-4">
            <!-- ì‚¬ìš©ì ì•„ì´ë”” ë³€ê²½ -->
            <div>
              <label for="username" class="block text-sm font-medium text-wiki-text mb-2">
                ì‚¬ìš©ì ì•„ì´ë”” (ë‹‰ë„¤ì„)
              </label>
              <form id="username-form" class="flex flex-col sm:flex-row gap-2">
                <input
                  type="text"
                  id="username"
                  name="username"
                  value="${userData.username || ''}"
                  placeholder="user_abc123"
                  pattern="[a-z0-9_]{3,20}"
                  class="flex-1 px-4 py-3 min-h-[48px] bg-wiki-card border border-wiki-border rounded-lg text-wiki-text focus:outline-none focus:border-wiki-primary focus:ring-1 focus:ring-wiki-primary"
                  style="font-size: 16px;"
                  required
                />
                <button
                  type="submit"
                  class="px-6 py-3 min-h-[48px] bg-wiki-primary text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                >
                  ë³€ê²½
                </button>
              </form>
              <p class="text-xs text-wiki-muted mt-2">
                3-20ì, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </p>
              <div id="username-message" class="mt-2 text-sm hidden"></div>
            </div>
            
            <!-- ê°€ì…ì¼ -->
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">ê°€ì…ì¼</label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.created_at ? new Date(Number(userData.created_at) * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }) : 'ì•Œ ìˆ˜ ì—†ìŒ'}
              </div>
            </div>
            
            <!-- ì—­í•  -->
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">ì—­í• </label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.role === 'admin' ? 'ê´€ë¦¬ì' : userData.role === 'expert' ? 'ì „ë¬¸ê°€' : 'ì¼ë°˜ ì‚¬ìš©ì'}
              </div>
            </div>
          </div>
        </div>
        
        <!-- ë³´ì•ˆ ì„¹ì…˜: ì„¸ì…˜ ê´€ë¦¬ -->
        ${renderSecurityPage()}
      </div>
    </div>
    
    <script>
      (function() {
        const form = document.getElementById('username-form');
        const input = document.getElementById('username');
        const message = document.getElementById('username-message');
        
        if (!form || !input || !message) return;
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const newUsername = input.value.trim().toLowerCase();
          
          // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬
          if (!/^[a-z0-9_]{3,20}$/.test(newUsername)) {
            message.className = 'mt-2 text-sm text-red-400';
            message.textContent = 'ì‚¬ìš©ì ì•„ì´ë””ëŠ” 3-20ìì˜ ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            message.classList.remove('hidden');
            return;
          }
          
          // ë²„íŠ¼ ë¹„í™œì„±í™”
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ë³€ê²½ ì¤‘...';
          }
          
          try {
            const response = await fetch('/api/user/username', {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username: newUsername })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
              message.className = 'mt-2 text-sm text-green-400';
              message.textContent = 'ì‚¬ìš©ì ì•„ì´ë””ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
              message.classList.remove('hidden');
              
              // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              message.className = 'mt-2 text-sm text-red-400';
              message.textContent = data.error || 'ì‚¬ìš©ì ì•„ì´ë”” ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              message.classList.remove('hidden');
            }
          } catch (error) {
            message.className = 'mt-2 text-sm text-red-400';
            message.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            message.classList.remove('hidden');
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'ë³€ê²½';
            }
          }
        });
      })();
      
      // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸
      (function() {
        const container = document.getElementById('profile-image-container');
        const imageInput = document.getElementById('profile-image-input');
        const uploadBtn = document.getElementById('profile-image-upload-btn');
        const resetBtn = document.getElementById('profile-image-reset-btn');
        const status = document.getElementById('profile-image-status');
        
        if (!container || !imageInput) return;
        
        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
        container.addEventListener('click', () => imageInput.click());
        if (uploadBtn) {
          uploadBtn.addEventListener('click', () => imageInput.click());
        }
        
        // íŒŒì¼ ì„ íƒ ì‹œ ì—…ë¡œë“œ
        imageInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          // íŒŒì¼ í¬ê¸° ê²€ì¦ (2MB)
          if (file.size > 2 * 1024 * 1024) {
            showStatus('í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” 2MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
          }
          
          // íŒŒì¼ í˜•ì‹ ê²€ì¦
          const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            showStatus('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤ (JPG/PNG/GIF/WEBPë§Œ ê°€ëŠ¥)', 'error');
            return;
          }
          
          showStatus('ì—…ë¡œë“œ ì¤‘...', 'loading');
          
          try {
            const formData = new FormData();
            formData.append('image', file);
            
            const response = await fetch('/api/user/profile-image', {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
              showStatus('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
              // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆ ì´ë¯¸ì§€ í‘œì‹œ
              setTimeout(() => window.location.reload(), 1000);
            } else {
              showStatus(data.error || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
          } catch (error) {
            showStatus('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
          }
          
          // ì…ë ¥ ì´ˆê¸°í™”
          imageInput.value = '';
        });
        
        // ì´ˆê¸°í™” ë²„íŠ¼
        if (resetBtn) {
          resetBtn.addEventListener('click', async () => {
            if (!confirm('í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showStatus('ì´ˆê¸°í™” ì¤‘...', 'loading');
            
            try {
              const response = await fetch('/api/user/profile-image', {
                method: 'DELETE'
              });
              
              const data = await response.json();
              
              if (response.ok && data.success) {
                showStatus('ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                setTimeout(() => window.location.reload(), 1000);
              } else {
                showStatus(data.error || 'ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
              }
            } catch (error) {
              showStatus('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
          });
        }
        
        function showStatus(message, type) {
          if (!status) return;
          status.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-wiki-muted');
          if (type === 'success') {
            status.className = 'text-xs mt-2 text-green-400';
          } else if (type === 'error') {
            status.className = 'text-xs mt-2 text-red-400';
          } else {
            status.className = 'text-xs mt-2 text-wiki-muted';
          }
          status.textContent = message;
        }
      })();
    </script>
  `
  
  const pageContent = renderUserLayoutContent({
    title: 'ê°œì¸ ì„¤ì •',
    currentPath: '/user/settings',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(renderLayoutWithContext(c,
    pageContent,
    'ê°œì¸ ì„¤ì • - ë§ˆì´í˜ì´ì§€ - Careerwiki',
    'ê³„ì • ì„¤ì • ë° í”„ë¡œí•„ ê´€ë¦¬',
    false,
    { user: userData }
  ))
})

// ===== ë³´ì•ˆ ì„¤ì • (ì„¸ì…˜ ê´€ë¦¬) í˜ì´ì§€ =====
import { renderSecurityPage } from './templates/user/userSecurity'

// /user/security â†’ /user/settings ë¦¬ë‹¤ì´ë ‰íŠ¸ (í•˜ìœ„ í˜¸í™˜)
app.get('/user/security', (c) => c.redirect('/user/settings', 301))


// SEO skeleton (dev/local only)
app.get('/robots.txt', (c) => {
  const url = new URL(c.req.url)
  const origin = `${url.protocol}//${url.host}`
  const body = `User-agent: *

Allow: /
Sitemap: ${origin}/sitemap.xml
`
  return c.text(body, 200, { 'content-type': 'text/plain; charset=utf-8' })
})

app.get('/sitemap.xml', async (c) => {
  const origin = buildCanonicalUrl(c.req.url, '')

  const staticPaths = [
    '/',
    '/job',
    '/major',
    '/howto',
    '/help',
    '/analyzer',
    '/feedback',
    '/legal/terms',
    '/legal/privacy',
  ]

  const entries: Array<{ loc: string; lastmod?: string }> = staticPaths.map((p) => ({ loc: `${origin}${p}` }))

  try {
    const [jobRows, majorRows, howtoRows] = await Promise.all([
      c.env.DB.prepare('SELECT id, name FROM jobs WHERE is_active = 1').all<{ id: string; name: string }>(),
      c.env.DB.prepare('SELECT id, name FROM majors WHERE is_active = 1').all<{ id: string; name: string }>(),
      c.env.DB.prepare(
        "SELECT slug, updated_at FROM pages WHERE page_type = 'guide' AND status IN ('published', 'draft_published')"
      ).all<{ slug: string; updated_at: string | null }>(),
    ])

    for (const row of jobRows.results) {
      const slug = composeDetailSlug('job', row.name, row.id)
      entries.push({ loc: `${origin}/job/${encodeURIComponent(slug)}` })
    }

    for (const row of majorRows.results) {
      const slug = composeDetailSlug('major', row.name, row.id)
      entries.push({ loc: `${origin}/major/${encodeURIComponent(slug)}` })
    }

    for (const row of howtoRows.results) {
      if (row.slug) {
        entries.push({
          loc: `${origin}/howto/${encodeURIComponent(row.slug)}`,
          lastmod: row.updated_at ? row.updated_at.split('T')[0] : undefined,
        })
      }
    }
  } catch {
    // DB unavailable â€” return static pages only
  }

  const urlTags = entries
    .map((e) => {
      const lastmod = e.lastmod ? `<lastmod>${e.lastmod}</lastmod>` : ''
      return `<url><loc>${e.loc}</loc>${lastmod}</url>`
    })
    .join('\n')

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urlTags}
</urlset>`
  return c.text(xml, 200, {
    'content-type': 'application/xml; charset=utf-8',
    'cache-control': 'public, max-age=3600',
  })
})

// Global 404 fallback
app.notFound((c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderNotFoundPage({ userMenuHtml, requestedPath: c.req.path }), 404)
})

export default app

export const scheduled: ExportedHandlerScheduledHandler<Bindings> = async (event, env, ctx) => {
  // SERP freshness ê°±ì‹ 
  const serpRun = Promise.all(
    SERP_FRESHNESS_TARGETS.map(async (target) => {
      try {
        const result = await attemptScheduledRefresh(env.KV, env, target, {
          reason: event.cron ? `cron:${event.cron}` : 'scheduled-cron'
        })
        if (result.outcome === 'error') {
        }
      } catch (error) {
      }
    })
  )

  // ë¯¸ì¸ë±ì‹± í•­ëª© ìë™ Vectorize ì¸ë±ì‹± (ì§ì—…/ì „ê³µ/HowTo)
  const indexRun = (async () => {
    const openaiApiKey = (env as any).OPENAI_API_KEY as string | undefined
    if (!openaiApiKey || !env.VECTORIZE) return
    try {
      const { incrementalUpsertToVectorize, incrementalUpsertMajorsToVectorize, incrementalUpsertHowtosToVectorize } =
        await import('./services/ai-analyzer/vectorize-pipeline')
      await Promise.all([
        incrementalUpsertToVectorize(env.DB, env.VECTORIZE, openaiApiKey, { maxJobs: 20 }),
        incrementalUpsertMajorsToVectorize(env.DB, env.VECTORIZE, openaiApiKey, { maxItems: 20 }),
        incrementalUpsertHowtosToVectorize(env.DB, env.VECTORIZE, openaiApiKey, { maxItems: 20 }),
      ])
    } catch {}
  })()

  const allRun = Promise.all([serpRun, indexRun])
  ctx.waitUntil(allRun)
  await allRun
}
