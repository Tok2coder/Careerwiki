import { Hono } from 'hono'
import type { Context } from 'hono'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import { renderer } from './renderer'
import auth from './routes/auth'
import { authMiddleware, requireAuth, requireAdmin, requireRole, requireJobMajorEdit, requireHowToEdit } from './middleware/auth'
import { JOB_CATEGORIES, APTITUDE_TYPES } from './api/careernetAPI'
import {
  ROLE_IDENTITY_OPTIONS,
  CAREER_STAGE_OPTIONS,
  TRANSITION_STATUS_OPTIONS,
  SKILL_LEVEL_OPTIONS,
  SKILL_LEVEL_NOTICE,
  CONSTRAINT_OPTIONS,
  TRANSITION_SIGNAL_QUESTIONS,
  IDENTITY_ANCHOR_PATTERNS,
  MAJOR_STUDENT_OPTIONS,
} from './services/ai-analyzer/career-tree-types'
import { getUnifiedJobDetail, getUnifiedJobDetailWithRawData, getUnifiedMajorDetail, searchUnifiedJobs, searchUnifiedMajors } from './services/profileDataService'
import type { SourceStatusRecord } from './services/profileDataService'
import type { DataSource, UnifiedJobDetail, UnifiedMajorDetail } from './types/unifiedProfiles'
import { renderUnifiedJobDetail, createJobJsonLd } from './templates/unifiedJobDetail'
import { renderJobTemplateDesignPage } from './templates/jobTemplateDesignPage'
import { renderJobETLInspectionPage } from './templates/jobETLInspectionPage'
import { renderUnifiedMajorDetail, createMajorJsonLd } from './templates/unifiedMajorDetail'
import type { JobSourceRow, MajorSourceRow } from './types/database'
import { renderHowtoGuideDetail } from './templates/howtoDetail'
import { buildCommentGovernanceItems, resolveCommentPolicy } from './templates/detailTemplateUtils'
import {
  getSampleJobDetail,
  getSampleMajorDetail,
  listSampleJobSummaries,
  listSampleMajorSummaries,
  listSampleHowtoSummaries,
  getSampleHowtoGuide
} from './data/sampleRegistry'
import { composeDetailSlug, resolveDetailIdFromSlug } from './utils/slug'
import {
  withKvCache,
  buildListCacheKey,
  secondsToHuman,
  formatTimestamp,
  type CacheState
} from './services/cacheService'
import type { 
  ExportedHandlerScheduledHandler,
  D1Database,
  KVNamespace,
  R2Bucket,
  R2ObjectBody,
  VectorizeIndex,
  Ai
} from '@cloudflare/workers-types'
import { LIST_CACHE_STALE_SECONDS, LIST_CACHE_MAX_AGE_SECONDS } from './config/cachePolicy'
import { recordListFreshness, attemptScheduledRefresh, getFreshnessStatus, resolveFreshnessTargetById } from './services/freshnessService'
import { SERP_FRESHNESS_TARGETS } from './config/freshnessConfig'
import { storePerfMetrics, type PerfMetricsPayload, type PerfAlert } from './services/perfMetricsService'
import {
  createOrUpdateSession,
  createAnalysisRequest,
  createAnalysisResult,
  getAnalysisRequestWithResult,
  getSession as getAiSession,
  listRequestsBySession,
  updateRequestStatus
} from './services/aiAnalysisService'
// Phase 0: AI Analyzer Service (scoring-v0.2.1-final)
import { analyzerRoutes } from './services/ai-analyzer'
import {
  recordSerpInteraction,
  getDailySerpSummary,
  listRecentSerpInteractions
} from './services/serpInteractionService'
import {
  type PageType,
  type UserRole,
  blockIpAddress,
  createComment,
  deleteComment,
  getCommentsBySlug,
  isIpBlocked,
  listIpBlocks,
  releaseIpAddress,
  reportComment,
  setCommentVote,
  updateComment,
  listFlaggedComments,
  setCommentStatus,
  resetCommentReports,
  deleteOrphanReplies
} from './services/commentService'
import { listHowtoReports } from './services/howtoReportService'
import type { AnalysisType, PricingTier, RequestStatus } from './types/aiAnalysis'
import { getOrGeneratePage, invalidatePageCache } from './utils/page-cache'
import { editJob, editMajor, editHowTo, createHowTo, createJob, createMajor } from './services/editService'
import { getRevisionById, listRevisions, restoreRevision } from './services/revisionService'
import { validateUrl } from './utils/editValidation'
import { findSimilarNames, saveNameMappings, deleteNameMapping, getExistingMappings } from './services/similarNamesService'
import { renderAdminSimilarNamesPage } from './templates/adminSimilarNames'
import { renderAdminDashboard } from './templates/admin/adminDashboard'
import { renderUserLayoutContent } from './templates/user/userLayout'
import { renderUserAiResultsContent, type AiResultItem } from './templates/user/userAiResults'
import { renderAdminUsers } from './templates/admin/adminUsers'
import { renderAdminUserDetail } from './templates/admin/adminUserDetail'
import { renderAdminFeedbackPage } from './templates/admin/adminFeedback'
import { renderAdminFeedbackDetail } from './templates/admin/adminFeedbackDetail'
import {
  isValidFeedbackStatus,
  updateFeedbackStatus,
  listFeedbackWithCommentCount,
  listComments,
  addComment,
  deleteComment as deleteFeedbackComment,
  getCommentById,
  updateLastActivity,
  autoCloseFeedback,
} from './services/feedbackService'
import { renderFeedbackDetailPage } from './templates/feedbackDetail'
import { renderOnboardingPage } from './templates/onboarding'
import { renderTermsPage } from './templates/legal/terms'
import { renderPrivacyPage } from './templates/legal/privacy'
import { renderHelpPage } from './templates/help'
import { renderFeedbackPage } from './templates/feedback'
import { renderNav, renderNavStyles, renderNavScripts } from './templates/partials/nav'
import { renderNotFoundPage } from './templates/notFound'
import {
  createFeedback,
  deleteReply,
  deleteFeedback,
  getFeedbackById,
  listFeedback,
  setVisibility,
  upsertReply,
  validateFeedbackInput,
} from './services/feedbackService'
import {
  getOnboardingStatus,
  checkNicknameAvailability,
  submitOnboarding,
  getUserAttribution,
  getUserConsents
} from './services/onboardingService'
import { renderAdminContent } from './templates/admin/adminContent'
import { renderAdminStats } from './templates/admin/adminStats'
import { getUsers, updateUserRole, banUser, unbanUser, getRevisions, restoreRevision as restoreRevisionAdmin, getStats, getAnalyticsStats } from './services/adminService'
import { weakETag, toNFC, matchETag } from './utils/etag'
import { TEMPLATE_VERSIONS } from './constants/template-versions'

// Dev-only helpers (instrumentation, safety)
const isDevEnv = (env?: any) => {
  const flag = env?.ENVIRONMENT || process?.env?.ENVIRONMENT || process?.env?.NODE_ENV
  return !flag || ['dev', 'development', 'local'].includes(String(flag).toLowerCase())
}

const timingMiddleware = async (c: any, next: any) => {
  if (!isDevEnv(c?.env)) {
    await next()
    return
  }
  const t0 = Date.now()
  const marks: Record<string, number> = {}
  c.set('mark', (k: string) => {
    marks[k] = Date.now()
  })
  await next()
  const parts = Object.entries(marks).map(([k, v]) => `${k};dur=${Date.now() - Number(v)}`)
  if (parts.length > 0) {
    c.header('Server-Timing', parts.join(', '))
  }
  c.header('X-Response-Duration', String(Date.now() - t0))
}

const apiCacheHintMiddleware = async (c: any, next: any) => {
  await next()
  const path = c.req.path || ''
  if (path.startsWith('/api/') && !c.res.headers.get('Cache-Control')) {
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
  }
}

const errorLoggingMiddleware = async (c: any, next: any) => {
  try {
    await next()
  } catch (e: any) {
    console.error(
      JSON.stringify({
        ts: new Date().toISOString(),
        route: c?.req?.path,
        msg: String(e),
        stack: e?.stack,
      })
    )
    return c.text('Internal Error', 500)
  }
}


// Types
type Bindings = {
  DB: D1Database;
  KV: KVNamespace;
  UPLOADS: R2Bucket;  // R2 이미지 업로드
  VECTORIZE?: VectorizeIndex;  // Vectorize 인덱스 (AI 분석기 후보 검색)
  AI?: Ai;  // Workers AI (임베딩 생성)
  CAREER_NET_API_KEY?: string;
  GOYONG24_MAJOR_API_KEY?: string;
  GOYONG24_JOB_API_KEY?: string;
  PERF_ALERT_WEBHOOK?: string;
  ADMIN_SECRET?: string;
  ENVIRONMENT?: string;
  // Z-Image Turbo API (이미지 생성)
  EVOLINK_API_KEY?: string;
  // Phase 3: Google OAuth 환경 변수
  GOOGLE_CLIENT_ID: string;
  GOOGLE_CLIENT_SECRET: string;
  GOOGLE_CALLBACK_URL: string;
  JWT_SECRET: string;
  // Releases page: Cloudflare Pages API
  CF_ACCOUNT_ID?: string;
  CF_PAGES_API_TOKEN?: string;
}

// User 타입 (auth-helpers에서 정의)
interface User {
  id: number;
  google_id: string;
  provider?: string;
  provider_user_id?: string;
  email: string;
  name: string | null;
  picture_url: string | null;
  custom_picture_url: string | null;  // 사용자가 직접 업로드한 프로필 이미지
  role: 'user' | 'expert' | 'admin';
  username: string | null;
  ban_reason: string | null;
  onboarded?: number;  // 온보딩 완료 여부 (0 or 1)
  created_at: string;
  updated_at: string;
}

type Variables = {
  title?: string;
  description?: string;
  user?: User | null;
  mark?: (key: string) => void;
}

const app = new Hono<{ Bindings: Bindings; Variables: Variables }>()

// Middleware
app.use('*', cors())
app.use('*', renderer)
app.use('*', errorLoggingMiddleware)
app.use('*', timingMiddleware)
app.use('*', apiCacheHintMiddleware)

// Serve static files from public directory
// All static assets including JS, CSS, images are served from /static/* path
// @ts-ignore - Cloudflare Workers types mismatch
app.use('/static/*', serveStatic({ root: './public' }))

// Serve images from public/images directory
// @ts-ignore - Cloudflare Workers types mismatch
app.use('/images/*', serveStatic({ root: './public' }))

// Phase 3: 인증 Middleware (모든 라우트에 적용)
app.use('*', authMiddleware)

// Phase 3: 인증 라우트
app.route('/auth', auth)

// ============================================
// Phase 0: AI Analyzer API (scoring-v0.2.1-final)
// POST /api/ai-analyzer/analyze   - 분석 요청
// POST /api/ai-analyzer/followup  - follow-up 응답
// GET  /api/ai-analyzer/result/:id - 결과 조회
// GET  /api/ai-analyzer/session/:id - 세션 이력
// ============================================
app.route('/api/ai-analyzer', analyzerRoutes)

// ============================================
// 온보딩 라우트
// ============================================

// 온보딩 페이지 (첫 로그인 사용자)
import { getCookie, deleteCookie } from 'hono/cookie'

app.get('/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  
  // 이미 온보딩 완료한 사용자는 메인으로 리다이렉트
  if (user && (user as any).onboarded === 1) {
    return c.redirect('/')
  }
  
  // 온보딩 완료 후 돌아갈 URL
  const returnUrl = getCookie(c, 'onboarding_return_url') || '/'
  
  const html = renderOnboardingPage({
    userName: user?.name,
    returnUrl
  })
  
  return c.html(html)
})

// 온보딩 상태 조회 API
app.get('/api/me/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const status = await getOnboardingStatus(c.env.DB, user.id)
    return c.json(status)
  } catch (error) {
    console.error('[Onboarding] Error getting status:', error)
    return c.json({ error: 'Failed to get onboarding status' }, 500)
  }
})

// 닉네임 가용성 체크 API
app.get('/api/nickname/check', async (c) => {
  const value = c.req.query('value')
  
  if (!value || typeof value !== 'string') {
    return c.json({ ok: false, reason: 'invalid', message: '닉네임을 입력해주세요.' })
  }
  
  try {
    const result = await checkNicknameAvailability(c.env.DB, value)
    return c.json(result)
  } catch (error) {
    console.error('[Onboarding] Error checking nickname:', error)
    return c.json({ ok: false, reason: 'invalid', message: '검증 중 오류가 발생했습니다.' })
  }
})

// 온보딩 제출 API
app.post('/api/onboarding', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'Unauthorized' }, 401)
  }
  
  let body: any
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'Invalid JSON body' }, 400)
  }
  
  // IP 및 User-Agent 수집
  const ip = c.req.header('CF-Connecting-IP') || c.req.header('X-Forwarded-For')?.split(',')[0] || undefined
  const ua = c.req.header('User-Agent') || undefined
  
  try {
    const result = await submitOnboarding(c.env.DB, user.id, body, { ip, ua })
    
    if (result.success) {
      // 온보딩 완료 후 리턴 URL 쿠키 삭제
      deleteCookie(c, 'onboarding_return_url')
    }
    
    return c.json(result)
  } catch (error) {
    console.error('[Onboarding] Error submitting:', error)
    return c.json({ success: false, error: '온보딩 처리 중 오류가 발생했습니다.' }, 500)
  }
})

// 약관 페이지
app.get('/legal/terms', async (c) => {
  return c.html(renderTermsPage())
})

// 개인정보처리방침 페이지
app.get('/legal/privacy', async (c) => {
  return c.html(renderPrivacyPage())
})

// Help Center
app.get('/help', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderHelpPage({ userMenuHtml }))
})

// Feedback Board
app.get('/feedback', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
  const pageSize = parseNumberParam(c.req.query('pageSize'), 20, { min: 1, max: 50 })
  const typeParam = c.req.query('type') || undefined
  const statusParam = c.req.query('status') || undefined
  const type = typeParam && ['bug', 'suggestion', 'question', 'other'].includes(typeParam) ? (typeParam as any) : undefined
  const status = statusParam && ['open', 'closed'].includes(statusParam) ? (statusParam as any) : undefined

  // 자동 종료 처리 (14일 미활동)
  await autoCloseFeedback(c.env.DB, 14)

  const list = await listFeedbackWithCommentCount(c.env.DB, {
    page,
    pageSize,
    type,
    status,
    includePrivate: false,
    userId: user?.id,
  })
  return c.html(
    renderFeedbackPage({
      userMenuHtml,
      isLoggedIn: Boolean(user),
      posts: list.items as any,
      page,
      total: list.total,
      pageSize,
    }),
  )
})

// 피드백 상세
app.get('/feedback/:id', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  const isAdmin = isAdminRole(user?.role)
  const id = Number(c.req.param('id'))

  if (!Number.isFinite(id)) return c.redirect('/feedback')

  const feedback = await getFeedbackById(c.env.DB, id, { includePrivate: true })
  if (!feedback) return c.redirect('/feedback')

  // 비공개 피드백은 작성자 또는 관리자만 열람 가능
  if (feedback.is_private && !isAdmin && user?.id !== feedback.user_id) {
    return c.redirect('/feedback')
  }

  // 작성자 정보 조회
  const authorRow = await c.env.DB.prepare(
    `SELECT name, username, picture_url FROM users WHERE id = ?`
  ).bind(feedback.user_id).first<{ name: string | null; username: string | null; picture_url: string | null }>()

  const comments = await listComments(c.env.DB, id)
  const hasAdminComment = comments.some((c) => c.is_admin)

  return c.html(
    renderFeedbackDetailPage({
      userMenuHtml,
      isLoggedIn: Boolean(user),
      currentUserId: user?.id,
      isAdmin: Boolean(isAdmin),
      post: {
        ...feedback,
        author_name: authorRow?.username || authorRow?.name || `user_${feedback.user_id}`,
        author_picture: authorRow?.picture_url || null,
        last_activity_at: feedback.last_activity_at || feedback.created_at,
      },
      comments,
      hasAdminComment,
    }),
  )
})

// Releases placeholder (with shared header)
app.get('/releases', async (c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)

  // --- Cloudflare Pages API로 배포 이력 가져오기 ---
  const accountId = c.env.CF_ACCOUNT_ID || ''
  const apiToken = c.env.CF_PAGES_API_TOKEN || ''
  const projectName = 'careerwiki-phase1'

  interface DeploymentMeta {
    branch: string
    commitHash: string
    commitMessage: string
    createdOn: string
    status: string
    environment: string
  }

  let deployments: DeploymentMeta[] = []
  let fetchError = false

  if (accountId && apiToken) {
    try {
      const cacheKey = new Request('https://releases-cache.internal/deployments')
      const cache = typeof caches !== 'undefined' ? (caches as any).default as Cache | undefined : null

      let cachedResponse = cache ? await cache.match(cacheKey) : null
      if (cachedResponse) {
        deployments = await cachedResponse.json() as DeploymentMeta[]
      } else {
        const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/pages/projects/${projectName}/deployments?per_page=30`
        const apiRes = await fetch(apiUrl, {
          headers: { 'Authorization': `Bearer ${apiToken}`, 'Content-Type': 'application/json' }
        })
        if (apiRes.ok) {
          const data = await apiRes.json() as { result?: any[] }
          const raw = (data.result || [])
            .filter((d: any) => d.environment === 'production')
            .slice(0, 20)

          deployments = raw.map((d: any) => ({
            branch: d.deployment_trigger?.metadata?.branch || '',
            commitHash: d.deployment_trigger?.metadata?.commit_hash || '',
            commitMessage: d.deployment_trigger?.metadata?.commit_message || '직접 배포',
            createdOn: d.created_on || '',
            status: d.latest_stage?.status || 'unknown',
            environment: d.environment || 'production'
          }))

          if (cache) {
            const cacheResponse = new Response(JSON.stringify(deployments), {
              headers: { 'Cache-Control': 'public, max-age=600' }
            })
            await cache.put(cacheKey, cacheResponse)
          }
        } else {
          fetchError = true
        }
      }
    } catch (e) {
      console.error('[Releases] API fetch error:', e)
      fetchError = true
    }
  } else {
    fetchError = true
  }

  // 날짜 포맷 (한국어)
  const fmtDate = (iso: string): string => {
    if (!iso) return ''
    const d = new Date(iso)
    const y = d.getFullYear()
    const m = d.getMonth() + 1
    const day = d.getDate()
    const h = d.getHours()
    const min = String(d.getMinutes()).padStart(2, '0')
    const ampm = h >= 12 ? '오후' : '오전'
    const h12 = h % 12 || 12
    return `${y}년 ${m}월 ${day}일 ${ampm} ${h12}:${min}`
  }

  // 상태 뱃지
  const statusBadge = (status: string): string => {
    switch (status) {
      case 'success': return '<span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 font-medium">성공</span>'
      case 'failure': return '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 font-medium">실패</span>'
      case 'active': case 'idle': return '<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 font-medium">진행 중</span>'
      default: return `<span class="text-xs px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-400 font-medium">${status}</span>`
    }
  }

  const dotClass = (status: string): string => {
    switch (status) {
      case 'success': return 'rl-dot-ok'
      case 'failure': return 'rl-dot-fail'
      case 'active': case 'idle': return 'rl-dot-prog'
      default: return 'rl-dot-ok'
    }
  }

  const esc = (s: string): string => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')

  // 커밋 메시지 정리 (첫 줄, 120자 제한)
  const trimMsg = (msg: string): string => {
    const line = msg.split('\n')[0].trim()
    return line.length > 120 ? line.slice(0, 117) + '...' : line
  }

  // 타임라인 HTML 생성
  let timelineHtml: string
  if (fetchError || deployments.length === 0) {
    timelineHtml = `
      <div class="glass-card rounded-xl p-8 text-center" style="background:rgba(26,26,46,0.82);border:1px solid rgba(148,163,184,0.22);backdrop-filter:blur(14px);">
        <i class="fas fa-server text-3xl text-slate-400 mb-4 block"></i>
        <p class="text-white font-semibold mb-2">${fetchError ? '배포 이력을 불러올 수 없습니다' : '배포 이력이 없습니다'}</p>
        <p class="text-sm text-slate-400">${fetchError ? 'API 연결을 확인해 주세요. 잠시 후 다시 시도하세요.' : '아직 프로덕션 배포가 없습니다.'}</p>
      </div>`
  } else {
    const cards = deployments.map((d, i) => {
      const shortHash = d.commitHash ? d.commitHash.slice(0, 7) : ''
      const commitLink = shortHash
        ? `<a href="https://github.com/Tok2coder/Careerwiki/commit/${esc(d.commitHash)}" class="font-mono hover:underline" style="color:#64b5f6;" target="_blank" rel="noopener"><i class="fas fa-code-commit mr-1"></i>${shortHash}</a>`
        : ''
      const branchHtml = d.branch ? `<span><i class="fas fa-code-branch mr-1"></i>${esc(d.branch)}</span>` : ''

      return `
        <div class="relative pl-10 sm:pl-12 ${i < deployments.length - 1 ? 'pb-6' : ''}">
          <div class="rl-dot ${dotClass(d.status)}"></div>
          <div class="glass-card rounded-xl p-4 sm:p-5" style="background:rgba(26,26,46,0.82);border:1px solid rgba(148,163,184,0.22);backdrop-filter:blur(14px);">
            <div class="flex flex-wrap items-center gap-2 mb-2">
              ${statusBadge(d.status)}
              <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 font-medium" style="color:#93c5fd;">production</span>
              <span class="text-xs ml-auto" style="color:#9aa3c5;">${fmtDate(d.createdOn)}</span>
            </div>
            <p class="text-white font-medium text-sm sm:text-base mb-1">${esc(trimMsg(d.commitMessage))}</p>
            <div class="flex flex-wrap items-center gap-3 text-xs" style="color:#9aa3c5;">
              ${branchHtml}
              ${commitLink}
            </div>
          </div>
        </div>`
    }).join('')

    timelineHtml = `<div class="relative"><div class="rl-line"></div>${cards}</div>`
  }

  return c.html(`<!DOCTYPE html>
  <html lang="ko">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>배포 이력 | CareerWiki</title>
      <link href="/static/style.css" rel="stylesheet" />
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
      ${renderNavStyles()}
      <style>
        .rl-line{position:absolute;left:15px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,#4361ee 0%,#64b5f6 50%,rgba(67,97,238,0.1) 100%);}
        .rl-dot{width:12px;height:12px;border-radius:50%;position:absolute;left:10px;top:20px;z-index:1;}
        .rl-dot-ok{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.4);}
        .rl-dot-fail{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4);}
        .rl-dot-prog{background:#eab308;box-shadow:0 0 8px rgba(234,179,8,0.4);animation:rl-pulse 2s infinite;}
        @keyframes rl-pulse{0%,100%{opacity:1}50%{opacity:.5}}
        @media(max-width:640px){.rl-line{left:11px;}.rl-dot{left:6px;}}
      </style>
    </head>
    <body class="bg-wiki-bg text-wiki-text min-h-screen" style="background-color:#0b1220;color:#e6e8f5;">
      ${renderNav(userMenuHtml)}
      <main class="max-w-[900px] mx-auto px-4 pt-20 pb-20 sm:pt-12">
        <div class="text-center mb-8">
          <p class="text-xs uppercase tracking-[0.2em] font-semibold mb-2" style="color:#93c5fd;">Releases</p>
          <h1 class="text-3xl md:text-4xl font-bold text-white">배포 이력</h1>
          <p class="text-sm mt-2" style="color:#9aa3c5;">프로덕션 환경에 배포된 최근 업데이트 내역입니다.</p>
        </div>
        ${timelineHtml}
      </main>
      ${renderNavScripts()}
    </body>
  </html>`)
})

// Phase 3 Day 4: 사용자 정보에 따른 헤더 UI 생성 함수
const renderUserMenu = (
  user: { id: number; name: string | null; email: string; role: string; picture_url: string | null; custom_picture_url?: string | null; username: string | null } | null,
  _ipAddress: string | null = null
) => {
  // 프로필 이미지 우선순위: custom > OAuth > 기본 아이콘
  const profileImageUrl = user ? (user.custom_picture_url || user.picture_url) : null
  
  // 프로필 이미지 URL이 상대 경로인 경우 절대 경로로 변환
  const getAbsoluteImageUrl = (url: string | null): string | null => {
    if (!url) return null
    if (url.startsWith('http://') || url.startsWith('https://')) return url
    if (url.startsWith('/')) return url
    return `/${url}`
  }
  
  const absoluteImageUrl = profileImageUrl ? getAbsoluteImageUrl(profileImageUrl) : null
  
  // 프로필 이미지 또는 기본 아이콘 렌더링 (버튼용 - 24x24 고정)
  const userIconHtml = absoluteImageUrl
    ? `<img src="${absoluteImageUrl}" alt="${user?.name || 'User'}" class="rounded-full object-cover" style="width: 24px; height: 24px;" />`
    : user
      ? `<div class="rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-bold" style="width: 24px; height: 24px; font-size: 12px;">${(user.username || user.name || 'U').charAt(0).toUpperCase()}</div>`
      : `<i class="fas fa-user-circle" style="font-size: 16px;"></i>`
  
  // 유저 아이콘 버튼 + 빈 드롭다운 (내용은 클라이언트에서 nav.ts가 렌더링)
  const menuHtml = `
    <!-- 유저 메뉴 드롭다운 -->
    <div class="relative" id="user-menu-container">
      <button 
        id="user-menu-btn" 
        class="header-icon-button flex items-center justify-center" 
        title="사용자 메뉴"
        aria-label="사용자 메뉴"
        aria-expanded="false"
        aria-haspopup="true"
      >
        ${userIconHtml}
      </button>
      <div 
        id="user-menu-dropdown" 
        class="hidden absolute right-0 top-full mt-1 w-56 glass-card rounded-lg border border-wiki-border/50 shadow-xl py-1 z-50"
        role="menu"
        style="background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(16px);"
      >
        <!-- 드롭다운 내용은 클라이언트에서 nav.ts의 hydrateUserMenu()가 렌더링 -->
        <div class="px-4 py-3 text-center text-wiki-muted text-sm">
          <i class="fas fa-spinner fa-spin mr-2"></i>로딩 중...
        </div>
      </div>
    </div>
  `
  
  return menuHtml
}


// Helper function for logo image (PNG 파일 사용)
const getLogoImage = (size: 'large' | 'small' = 'large') => {
  const isLarge = size === 'large'
  const src = isLarge ? '/images/CWmainlogo.png' : '/images/CWheaderlogo.png'
  const width = isLarge ? 360 : 180
  const height = isLarge ? 90 : 40
  
  return `<img src="${src}" alt="Careerwiki" width="${width}" height="${height}" class="logo-image" style="object-fit: contain;" />`
}

// Legacy alias for backward compatibility
const getLogoSVG = getLogoImage

const isAdminRole = (role?: string | null) =>
  role === 'admin' || role === 'super-admin' || role === 'operator'

// Helper function to render layout
const renderLayout = (
  content: string,
  title = 'Careerwiki - AI 진로 분석 플랫폼',
  description = 'AI 기반 개인 맞춤형 진로 분석과 전략 리포트를 제공하는 플랫폼',
  isHomepage = false,
  options?: {
    extraHead?: string
    canonical?: string
    ogUrl?: string
    user?: { id: number; name: string | null; email: string; role: string; picture_url: string | null; custom_picture_url?: string | null; username: string | null } | null
    context?: Context<{ Bindings: Bindings; Variables: Variables }>  // Phase 3 Day 4: Context를 통해 사용자 정보 자동 가져오기
    ipAddress?: string | null  // Phase 3 Day 4: IP 주소 (비로그인 상태에서 표시)
  }
) => {
  const canonicalUrl = options?.canonical ?? 'https://careerwiki.org'
  const ogUrl = options?.ogUrl ?? canonicalUrl
  const extraHead = options?.extraHead ?? ''
  
  // Phase 3 Day 4: 사용자 정보 가져오기 (options.user 우선, 없으면 context에서 가져오기)
  let user = options?.user ?? null
  if (!user && options?.context) {
    const contextUser = options.context.get('user')
    if (contextUser) {
      user = {
        id: contextUser.id,
        name: contextUser.name,
        email: contextUser.email,
        role: contextUser.role,
        picture_url: contextUser.picture_url,
        custom_picture_url: contextUser.custom_picture_url,
        username: contextUser.username
      }
    }
  }
  
  // 디버깅: 사용자 정보 확인
  // console.log('[renderLayout] User:', user ? { id: user.id, username: user.username } : 'null')

  return `
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${title}</title>
        <meta name="description" content="${description}">
        <meta property="og:title" content="${title}">
        <meta property="og:description" content="${description}">
        <meta property="og:type" content="website">
        <meta property="og:url" content="${ogUrl}">
        <meta name="robots" content="index, follow">
        <link rel="canonical" href="${canonicalUrl}">
        <link rel="icon" type="image/png" href="/images/CWfavicon.png">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://unpkg.com/lucide@latest"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
          tailwind.config = {
            darkMode: 'class',
            theme: {
              extend: {
                colors: {
                  'wiki-bg': '#0f0f23',
                  'wiki-card': '#1a1a2e',
                  'wiki-border': '#2a2a3e',
                  'wiki-primary': '#4361ee',
                  'wiki-secondary': '#64b5f6',
                  'wiki-text': '#e0e0e0',
                  'wiki-muted': '#9ca3af',
                }
              }
            }
          }
        </script>
        <script>
          // 서버에서 주입하는 사용자 정보 (초기값, ISR 캐시 페이지에서는 null일 수 있음)
          window.__USER__ = ${user ? JSON.stringify({ id: user.id, username: user.username, role: user.role, pictureUrl: user.custom_picture_url || user.picture_url || null }) : 'null'};
          window.__USER_LOADED__ = false;
          
          // 클라이언트에서 동적으로 로그인 상태 확인 (ISR 캐시 페이지 대응)
          (function() {
            fetch('/api/me', { credentials: 'same-origin', cache: 'no-store', headers: { 'Cache-Control': 'no-store' } })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                window.__USER__ = data.user;
                window.__USER_LOADED__ = true;
                // 로그인 상태 변경 이벤트 발생
                window.dispatchEvent(new CustomEvent('userLoaded', { detail: data.user }));
              })
              .catch(function() {
                window.__USER_LOADED__ = true;
              });
          })();
        </script>
        <script src="/static/perf-metrics.js" defer></script>
        ${extraHead}
        <style>
          body { background: #0f0f23; color: #e0e0e0; }
          
          /* 기본 콘텐츠 폰트 크기 정의 */
          .content-text { 
            font-size: 15px; 
            line-height: 1.7;
            color: #d1d5db;
          }
          
          /* 소제목 스타일 - 명확하고 구분되게, 풀너비 얇은 보더 */
          .content-heading { 
            font-size: 16px;
            font-weight: 700;
            color: #f3f4f6;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(100, 181, 246, 0.15);
            display: block;
            width: 100%;
          }
          
          /* 섹션 제목 - 더 강조되고 트렌디하게, 풀너비 굵은 보더 */
          .section-title { 
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.01em;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(100, 181, 246, 0.3);
            width: 100%;
          }
          
          /* 모바일 최적화 */
          @media (max-width: 768px) {
            .section-title {
              font-size: 18px;
            }
            .content-heading {
              font-size: 16px;
            }
            /* 모바일 네비게이션 로고 크기 조정 */
            nav img[alt*="로고"] {
              max-width: 120px;
              height: auto;
            }
            /* 모바일 홈페이지 로고 크기 - 검색창 너비의 60% */
            .hero-inner > div:first-child {
              width: 60%;
              max-width: 60%;
            }
            .hero-inner > div:first-child svg {
              width: 100%;
              height: auto;
            }
          }
          
          /* 탭 패널 표시/숨김 - SEO 최적화: hidden 속성 대신 CSS 사용 */
          .cw-tab-panel.is-hidden {
            display: none;
          }
          .cw-tab-panel.is-active {
            display: block;
          }
          
          /* 플로팅 네비게이션 버튼 */
          .floating-nav {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
          }
          .floating-nav.hidden {
            display: none;
          }
          .floating-nav-scroll-top {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
          }
          .floating-nav-scroll-top.visible {
            opacity: 1;
            pointer-events: auto;
          }
          .floating-nav-btn {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(26, 26, 46, 0.75);
            border: 1px solid rgba(100, 181, 246, 0.3);
            color: #64b5f6;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
          }
          .floating-nav-btn:hover {
            background: rgba(67, 97, 238, 0.85);
            border-color: rgba(100, 181, 246, 0.6);
            color: #ffffff;
            transform: translateX(-4px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
          }
          .floating-nav-btn .label {
            position: absolute;
            right: 64px;
            white-space: nowrap;
            padding: 8px 14px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(100, 181, 246, 0.4);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #e0e0e0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          }
          .floating-nav-btn:hover .label {
            opacity: 1;
          }
          
          .gradient-text {
            background: linear-gradient(135deg, #4361ee 0%, #64b5f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
          }
          .glass-card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(67, 97, 238, 0.2);
          }
          .hover-glow:hover {
            box-shadow: 0 0 30px rgba(67, 97, 238, 0.3);
            transition: all 0.3s ease;
          }
          
          /* ============================================
           * AI Analyzer Professional UI Styles
           * ============================================ */
          
          /* 비활성화 스트라이프 패턴 */
          .bg-stripes {
            background: repeating-linear-gradient(
              -45deg,
              transparent,
              transparent 4px,
              rgba(156, 163, 175, 0.15) 4px,
              rgba(156, 163, 175, 0.15) 8px
            );
          }
          
          /* 선택 카드 애니메이션 */
          .role-card {
            will-change: transform, box-shadow;
          }
          .role-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(67, 97, 238, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
          }
          .role-card:hover::before {
            opacity: 1;
          }
          
          /* 제약 카드 펼침 애니메이션 */
          .constraint-card {
            will-change: height;
          }
          .constraint-detail {
            animation: slideDown 0.3s ease-out;
          }
          @keyframes slideDown {
            from {
              opacity: 0;
              transform: translateY(-10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          /* 레벨 바 채움 애니메이션 */
          .skill-btn .w-3.h-6 {
            transition: background-color 0.3s ease, transform 0.2s ease;
          }
          .skill-btn:hover .w-3.h-6:not(.bg-gray-200) {
            transform: scaleY(1.1);
          }
          
          /* 목표 칩 선택 효과 */
          .goal-chip {
            will-change: transform, background;
          }
          .goal-chip:not(:disabled):active {
            transform: scale(0.98);
          }
          
          /* 제약조건 세부 태그 스타일 */
          .detail-tag {
            background-color: rgba(26,26,46,0.5);
            border-color: rgba(42,42,62,0.5);
            color: rgb(148,163,184);
            transition: all 0.15s ease;
          }
          .detail-tag:hover:not(.selected) {
            /* hover 스타일: 선택 스타일보다 연하게 (구분 가능하도록) */
            background-color: rgba(100,116,139,0.15);
            border-color: rgba(100,116,139,0.4);
            color: rgb(200,210,220);
          }
          .detail-tag.selected {
            background-color: rgba(245,158,11,0.2) !important;
            border-color: rgba(245,158,11,0.5) !important;
            color: #f59e0b !important;
          }
          
          /* 툴팁 arrow */
          .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
          }
          
          /* 비활성화 요소 호버 시 툴팁 */
          .disabled-tooltip {
            white-space: nowrap;
          }
          
          /* 전이 신호 카드 스타일 */
          .transition-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(26, 26, 46, 0.7) 100%);
            border: 1px solid rgba(67, 97, 238, 0.2);
            transition: all 0.3s ease;
          }
          .transition-card:hover {
            border-color: rgba(67, 97, 238, 0.4);
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.15);
          }
          
          /* 진행 표시 도트 */
          .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(156, 163, 175, 0.3);
            transition: all 0.3s ease;
          }
          .progress-dot.active {
            background: #4361ee;
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.5);
          }
          .progress-dot.completed {
            background: #34d399;
          }
          
          /* 제약 태그 선택 효과 */
          .detail-tag.selected,
          .detail-tag:focus {
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
            color: #92400e !important;
          }
          .wiki-link {
            color: #64b5f6;
            text-decoration: none;
            transition: all 0.2s;
          }
          .wiki-link:hover {
            color: #4361ee;
            text-decoration: underline;
          }
          .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
          }
          .scrollbar-hide::-webkit-scrollbar {
            display: none;
          }
          nav[aria-label="페이지네이션"]::-webkit-scrollbar,
          div:has(nav[aria-label="페이지네이션"])::-webkit-scrollbar {
            display: none;
          }
          .menu-button {
            background: rgba(26, 26, 46, 0.9);
            border: 1px solid rgba(67, 97, 238, 0.3);
            padding: 16px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            min-height: 80px;
          }
          .menu-button:hover {
            background: #4361ee;
            border-color: #4361ee;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4);
          }
          .menu-button:focus-visible {
            outline: 2px solid #64b5f6;
            outline-offset: 2px;
          }
          /* 모바일에서 AI 분석(첫 번째)만 가로 배치 */
          @media (max-width: 479px) {
            .pillar-grid > a:first-child.menu-button {
              display: flex;
              flex-direction: row;
              align-items: center;
              justify-content: center;
              gap: 12px;
              padding: 10px 18px;
              min-height: auto;
              text-align: center;
            }
            .pillar-grid > a:first-child.menu-button i {
              margin-bottom: 0 !important;
              font-size: 1.25rem !important;
            }
            .pillar-grid > a:first-child.menu-button div {
              font-size: 0.9rem;
            }
            /* 나머지(직업위키, 전공위키, HowTo)는 세로 배치 */
            .pillar-grid > a:not(:first-child).menu-button {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 8px;
              padding: 12px 8px;
              min-height: auto;
              text-align: center;
            }
            .pillar-grid > a:not(:first-child).menu-button i {
              margin-bottom: 0 !important;
              font-size: 1.5rem !important;
            }
            .pillar-grid > a:not(:first-child).menu-button div {
              font-size: 0.75rem;
            }
          }
          .homepage-header {
            width: 100%;
            padding: 12px 0;
          }
          .homepage-header > div {
            display: flex;
            align-items: center;
          }
          @media (max-width: 767px) {
            .homepage-header {
              padding: 8px 0;
            }
          }
          .hero-shell {
            min-height: calc(100vh - 260px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 16px 40px;
          }
          .hero-inner {
            max-width: 640px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 36px;
            align-items: center;
            text-align: center;
          }
          .search-shell {
            width: 100%;
            max-width: 820px;
          }
          .search-shell form {
            width: 100%;
          }
          .search-shell .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 16px;
            border-radius: 9999px;
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(100, 181, 246, 0.28);
            box-shadow: 0 10px 28px rgba(15, 15, 35, 0.35);
            transition: border 0.2s ease, box-shadow 0.2s ease;
          }
          .search-shell .search-bar:focus-within {
            border-color: #4361ee;
            box-shadow: 0 16px 40px rgba(67, 97, 238, 0.25);
          }
          .search-shell input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 15px;
            line-height: 1.4;
            padding: 0;
          }
          .search-shell input::placeholder {
            color: #a0a8c0;
            font-size: 14px;
          }
          .search-shell input:focus {
            outline: none;
          }
          .search-button {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 9999px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: linear-gradient(135deg, #4361ee 0%, #64b5f6 100%);
            color: #ffffff;
            box-shadow: 0 10px 22px rgba(67, 97, 238, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
          }
          .search-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 32px rgba(67, 97, 238, 0.45);
          }
          .search-button:focus-visible {
            outline: 2px solid #64b5f6;
            outline-offset: 3px;
          }
          /* 헤더 아이콘 버튼 - 터치 타겟 44px 보장 */
          .header-icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 44px;
            padding: 10px;
            border-radius: 8px;
            color: #9ca3af;
            transition: color 0.2s ease, background-color 0.2s ease;
          }
          .header-icon-button:hover {
            color: #e0e0e0;
            background-color: rgba(67, 97, 238, 0.1);
          }
          .header-icon-button:focus-visible {
            outline: 2px solid #64b5f6;
            outline-offset: 2px;
          }
          .header-icon-button {
            padding: 8px;
          }
          /* 유저 아이콘 크기는 nav.ts renderNavStyles()에서 통합 관리 */
          .pillar-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            width: 100%;
            max-width: 520px;
          }
          .pillar-grid > a:first-child {
            grid-column: 1 / -1;
          }
          @media (min-width: 480px) {
            .pillar-grid {
              gap: 16px;
            }
          }
          @media (min-width: 768px) {
            .pillar-grid {
              grid-template-columns: repeat(4, minmax(0, 1fr));
            }
            .pillar-grid > a:first-child {
              grid-column: auto;
            }
            .homepage-header {
              padding: 32px 0 0;
            }
            .hero-shell {
              padding-top: 40px;
              padding-bottom: 60px;
            }
            #main-nav {
              position: sticky !important;
              transform: translateY(0) !important;
            }
          }
        </style>
        ${renderNavStyles()}
    </head>
    <body class="bg-wiki-bg text-wiki-text min-h-screen">
        ${!isHomepage ? `${renderNav(renderUserMenu(user))}` : ''}
        
        <!-- Main Content -->
        <main class="${isHomepage ? '' : 'mx-auto pt-[65px] md:pt-0'}">
            ${content}
        </main>
        ${renderNavScripts()}
        
        <!-- Footer - Minimal with Beaver Nest Style -->
        <style>
            .footer-nav-link {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 0.8125rem;
                font-weight: 500;
                letter-spacing: 0.02em;
                color: rgba(200, 210, 255, 0.85);
                background: transparent;
                border: none;
                transition: all 0.2s ease;
                position: relative;
                white-space: nowrap;
            }
            .footer-nav-link::after {
                content: '';
                position: absolute;
                bottom: 4px;
                left: 14px;
                right: 14px;
                height: 2px;
                background: linear-gradient(90deg, #4361ee, #64b5f6);
                border-radius: 1px;
                transform: scaleX(0);
                transition: transform 0.2s ease;
            }
            .footer-nav-link:hover {
                color: #ffffff;
                background: rgba(100, 181, 246, 0.1);
            }
            .footer-nav-link:hover::after {
                transform: scaleX(1);
            }
        </style>
        <footer class="relative mt-20 border-t border-wiki-border/30">
            <div class="max-w-6xl mx-auto px-6 py-10">
                <!-- Mobile: Logo top, Buttons in 2x2 grid below -->
                <div class="flex md:hidden flex-col gap-6">
                    <!-- Logo - centered (모바일에서 숨김) -->
                    <a href="/" class="hidden mx-auto opacity-80 hover:opacity-100 transition-opacity">
                        ${getLogoSVG('small')}
                    </a>
                    
                    <!-- Navigation Links - Single row on mobile -->
                    <nav class="flex flex-wrap items-center justify-center gap-2">
                        <a href="/analyzer" class="footer-nav-link">AI 추천</a>
                        <a href="/job" class="footer-nav-link">직업위키</a>
                        <a href="/major" class="footer-nav-link">전공위키</a>
                        <a href="/howto" class="footer-nav-link">HowTo</a>
                    </nav>
                </div>
                    
                <!-- Mobile: Copyright & Links (below) -->
                <div class="flex md:hidden flex-col items-center gap-3 pt-6 border-t border-wiki-border/20">
                    <div class="flex items-center gap-4 text-wiki-muted/60" style="font-size: 14px;">
                        <a href="/terms" class="hover:text-wiki-muted transition-colors">이용약관</a>
                        <span class="text-wiki-muted/30">|</span>
                        <a href="/privacy" class="hover:text-wiki-muted transition-colors">개인정보처리방침</a>
                    </div>
                    <span class="text-wiki-text font-semibold" style="font-size: 15px;">© 2025 Careerwiki</span>
                </div>
                
                <!-- Desktop: Original horizontal layout -->
                <div class="hidden md:flex items-center justify-between gap-8">
                    <!-- Logo -->
                    <a href="/" class="shrink-0 opacity-80 hover:opacity-100 transition-opacity">
                        ${getLogoSVG('small')}
                    </a>
                    
                    <!-- Navigation Links - Horizontal -->
                    <nav class="flex flex-wrap items-center gap-4">
                        <a href="/analyzer" class="footer-nav-link">AI 추천</a>
                        <a href="/job" class="footer-nav-link">직업위키</a>
                        <a href="/major" class="footer-nav-link">전공위키</a>
                        <a href="/howto" class="footer-nav-link">HowTo</a>
                    </nav>
                    
                    <!-- Copyright & Links -->
                    <div class="flex flex-col items-end gap-2">
                        <div class="flex items-center gap-4 text-wiki-muted/60" style="font-size: 14px;">
                            <a href="/terms" class="hover:text-wiki-muted transition-colors">이용약관</a>
                            <span class="text-wiki-muted/30">|</span>
                            <a href="/privacy" class="hover:text-wiki-muted transition-colors">개인정보처리방침</a>
                        </div>
                        <span class="text-wiki-text font-semibold" style="font-size: 15px;">© 2025 Careerwiki</span>
                    </div>
                </div>
            </div>
        </footer>
        
        <script>
            // Mobile header auto-hide on scroll
            let lastScrollTop = 0;
            let isNavVisible = true;
            const nav = document.getElementById('main-nav');
            const mobileMenu = document.getElementById('mobile-menu');
            const isMobile = window.innerWidth < 768;
            
            if (isMobile && nav) {
                window.addEventListener('scroll', () => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    if (scrollTop > lastScrollTop && scrollTop > 100) {
                        // Scrolling down & past 100px
                        nav.style.transform = 'translateY(-100%)';
                        isNavVisible = false;
                        if (mobileMenu) mobileMenu.classList.add('hidden');
                    } else if (scrollTop < lastScrollTop) {
                        // Scrolling up
                        nav.style.transform = 'translateY(0)';
                        isNavVisible = true;
                    }
                    
                    lastScrollTop = scrollTop;
                });
                
                // Show nav on empty area tap
                document.addEventListener('click', (e) => {
                    if (!isNavVisible && 
                        !e.target.closest('a') && 
                        !e.target.closest('button') && 
                        !e.target.closest('input') && 
                        !e.target.closest('nav')) {
                        nav.style.transform = 'translateY(0)';
                        isNavVisible = true;
                    }
                });
            }
            
            // Mobile menu toggle
            const menuBtn = document.getElementById('mobile-menu-btn');
            if(menuBtn) {
                menuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            // 로그아웃 시 현재 페이지로 돌아오도록 return_url 설정
            document.querySelectorAll('.logout-return-url').forEach(input => {
                input.value = window.location.pathname + window.location.search;
            });
        </script>
        
        <!-- 플로팅 네비게이션 버튼 -->
        <div class="floating-nav" id="floating-nav">
            <button class="floating-nav-btn floating-nav-scroll-top" id="scroll-top-btn" onclick="scrollToTop()" aria-label="맨 위로 이동">
                <i class="fas fa-arrow-up"></i>
                <span class="label">맨 위로</span>
            </button>
            <button class="floating-nav-btn" id="toc-btn" onclick="scrollToTOC()" aria-label="목차로 이동">
                <i class="fas fa-list"></i>
                <span class="label">목차</span>
            </button>
            <button class="floating-nav-btn" id="comments-btn" onclick="scrollToComments()" aria-label="댓글로 이동">
                <i class="fas fa-comment"></i>
                <span class="label">댓글</span>
            </button>
        </div>
        
        <script>
            // 플로팅 네비게이션 함수
            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            function scrollToTOC() {
                // 탭 네비게이션 (개요 상세정보 탭)으로 이동
                const tablist = document.querySelector('[role="tablist"][aria-label*="직업"][aria-label*="탭"], [role="tablist"][aria-label*="전공"][aria-label*="탭"]');
                if (tablist) {
                    // 헤더 높이 고려 (약 80px + 여유 20px)
                    const headerOffset = 100;
                    const elementPosition = tablist.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                } else {
                    // 탭리스트가 없으면 첫 번째 카드로
                    const firstCard = document.querySelector('[data-cw-detail-card]');
                    if (firstCard) {
                        const headerOffset = 100;
                        const elementPosition = firstCard.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    } else {
                        scrollToTop();
                    }
                }
            }
            
            function scrollToComments() {
                const comments = document.getElementById('cw-comments');
                if (comments) {
                    // 헤더 높이 고려 (약 80px + 여유 20px)
                    const headerOffset = 100;
                    const elementPosition = comments.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                } else {
                    // 댓글이 없으면 페이지 하단으로
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }
            }
            
            // 페이지 타입 감지 및 플로팅 네비게이션 설정
            (function() {
                const path = window.location.pathname;
                const isDetailPage = path.startsWith('/job/') || path.startsWith('/major/') || path.startsWith('/howto/');
                
                const scrollTopBtn = document.getElementById('scroll-top-btn');
                const tocBtn = document.getElementById('toc-btn');
                const commentsBtn = document.getElementById('comments-btn');
                
                if (!isDetailPage) {
                    // 상세 페이지가 아니면 목차와 댓글 버튼 숨기기
                    if (tocBtn) tocBtn.style.display = 'none';
                    if (commentsBtn) commentsBtn.style.display = 'none';
                    
                    // 맨위로 버튼은 스크롤 시 표시
                    if (scrollTopBtn) {
                        scrollTopBtn.classList.remove('floating-nav-scroll-top');
                        scrollTopBtn.style.display = 'none';
                        
                        window.addEventListener('scroll', function() {
                            if (window.pageYOffset > 300) {
                                scrollTopBtn.style.display = 'flex';
                            } else {
                                scrollTopBtn.style.display = 'none';
                            }
                        });
                    }
                } else {
                    // 상세 페이지에서는 맨위로 버튼 스크롤에 따라 표시
                    if (scrollTopBtn) {
                        window.addEventListener('scroll', function() {
                            if (window.pageYOffset > 300) {
                                scrollTopBtn.classList.add('visible');
                            } else {
                                scrollTopBtn.classList.remove('visible');
                            }
                        });
                    }
            }
          })();
        </script>
        
        <script src="/static/api-client.js?v=${Date.now()}"></script>
        
        <!-- 편집 시스템 -->
        <link rel="stylesheet" href="/static/edit-mode.css?v=${Date.now()}">
        <script src="/static/edit-mode.js?v=${Date.now()}"></script>
        
        <!-- 북마크(저장) 기능 -->
        <script>
          (function() {
            const SAVED_CLASS = 'bookmark-saved';
            const SAVED_COLOR = 'text-amber-400';
            const SAVED_BORDER = 'border-amber-400/50';
            
            async function initBookmarks() {
              const btns = document.querySelectorAll('[data-bookmark-btn]');
              if (btns.length === 0) return;
              
              // 각 버튼의 저장 상태 확인
              for (const btn of btns) {
                const type = btn.dataset.bookmarkType;
                const slug = btn.dataset.bookmarkSlug;
                if (!type || !slug) continue;
                
                try {
                  const res = await fetch('/api/bookmark/' + type + '/' + encodeURIComponent(slug));
                  const data = await res.json();
                  if (data.saved) {
                    markAsSaved(btn, true);
                  }
                } catch (e) {
                  // 무시
                }
              }
              
              // 클릭 이벤트 등록
              document.addEventListener('click', handleBookmarkClick);
            }
            
            async function handleBookmarkClick(e) {
              const btn = e.target.closest('[data-bookmark-btn]');
              if (!btn) return;
              
              const type = btn.dataset.bookmarkType;
              const slug = btn.dataset.bookmarkSlug;
              const title = btn.dataset.bookmarkTitle;
              
              if (!type || !slug) return;
              
              // 비로그인 사용자 체크
              btn.disabled = true;
              
              try {
                const res = await fetch('/api/bookmark', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ type, slug, title })
                });
                
                const data = await res.json();
                
                if (data.error === 'not_logged_in') {
                  alert('로그인이 필요합니다.');
                  const currentPath = window.location.pathname + window.location.search;
                  window.location.href = '/auth/google?return_url=' + encodeURIComponent(currentPath);
                  return;
                }
                
                if (data.success) {
                  // saved가 true면 +1, false면 -1
                  const countDelta = data.saved ? 1 : -1;
                  markAsSaved(btn, data.saved, countDelta);
                }
              } catch (e) {
                console.error('[bookmark]', e);
                alert('저장 중 오류가 발생했습니다.');
              } finally {
                btn.disabled = false;
              }
            }
            
            function markAsSaved(btn, saved, countDelta = 0) {
              const icon = btn.querySelector('i.fa-bookmark');
              const countEl = btn.querySelector('[data-bookmark-count]');
              
              // 카운트 업데이트
              if (countEl && countDelta !== 0) {
                const currentCount = parseInt(countEl.textContent) || 0;
                countEl.textContent = Math.max(0, currentCount + countDelta);
              }
              
              if (saved) {
                btn.classList.add(SAVED_CLASS, SAVED_COLOR, SAVED_BORDER);
                btn.classList.remove('text-wiki-muted', 'border-wiki-border/40');
                if (icon) icon.classList.add(SAVED_COLOR);
                btn.title = '저장 해제';
              } else {
                btn.classList.remove(SAVED_CLASS, SAVED_COLOR, SAVED_BORDER);
                btn.classList.add('text-wiki-muted', 'border-wiki-border/40');
                if (icon) icon.classList.remove(SAVED_COLOR);
                btn.title = '저장함에 추가';
              }
            }
            
            // 초기화
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', initBookmarks);
            } else {
              initBookmarks();
            }
          })();
        </script>
    </body>
    </html>
  `
}

const SOURCE_LABEL_MAP: Record<DataSource, string> = {
  CAREERNET: '커리어넷',
  GOYONG24: '고용24',
  WORK24_JOB: '고용24 직업정보',
  WORK24_DJOB: '고용24 직업사전',
  WORK24_MAJOR: '고용24 학과정보',
  AI: 'AI 생성',
  USER_CONTRIBUTED: '사용자 기여',
  ADMIN_OVERRIDE: '관리자'
}

const DEFAULT_CANONICAL_ORIGIN = 'https://careerwiki.org'

const buildCanonicalUrl = (requestUrl: string, path: string): string => {
  try {
    const url = new URL(requestUrl)
    const { protocol, host, hostname } = url
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return `${protocol}//${host}${path}`
    }
    if (hostname.endsWith('.pages.dev') || hostname === 'careerwiki.org' || hostname.endsWith('.careerwiki.org')) {
      return `${protocol}//${host}${path}`
    }
  } catch {
    // Ignore parsing errors and fall back to default origin
  }
  return `${DEFAULT_CANONICAL_ORIGIN}${path}`
}

const isAnalysisType = (value: unknown): value is AnalysisType => value === 'job' || value === 'major'
const isPricingTier = (value: unknown): value is PricingTier => value === 'free' || value === 'pro'
const isRequestStatus = (value: unknown): value is RequestStatus =>
  value === 'pending' || value === 'processing' || value === 'completed' || value === 'failed'
const isPageType = (value: unknown): value is PageType => value === 'job' || value === 'major' || value === 'guide'
// guide 타입은 pages 테이블에 prefix 없이 저장되므로 prefix 붙이지 않음
const buildCommentPageSlug = (type: PageType, slug: string): string => {
  const trimmedSlug = slug.trim()
  // guide(HowTo)는 실제 페이지가 prefix 없이 저장되므로 그대로 사용
  if (type === 'guide') return trimmedSlug
  return `${type}:${trimmedSlug}`
}
// slug에서 guide: prefix를 제거하는 헬퍼 함수
const cleanGuidePrefix = (slug: string): string => slug ? slug.replace(/^(guide:)+/g, '') : ''
const toParentId = (value: unknown): number | null => {
  if (value === null || value === undefined) {
    return null
  }
  const parsed = Number(value)
  if (!Number.isFinite(parsed)) {
    return null
  }
  const normalized = Math.floor(parsed)
  return normalized > 0 ? normalized : null
}

// Phase 3 Day 4: IP 주소 가져오기 헬퍼 함수
const getClientIp = (c: Context): string => {
  // Cloudflare Workers에서는 CF-Connecting-IP 사용
  const cfIp = c.req.header('cf-connecting-ip')
  if (cfIp) return cfIp
  
  // X-Forwarded-For 헤더 확인 (첫 번째 IP만 사용)
  const forwarded = c.req.header('x-forwarded-for')
  if (forwarded) {
    const ips = forwarded.split(',').map(ip => ip.trim()).filter(Boolean)
    if (ips.length > 0) return ips[0]
  }
  
  // X-Real-IP 헤더 확인
  const realIp = c.req.header('x-real-ip')
  if (realIp) return realIp
  
  // 로컬 환경 fallback - 127.0.0.1 사용
  return '127.0.0.1'
}

// Homepage - Google style with menu buttons
app.get('/', (c) => {
  // Phase 3 Day 4: 사용자 정보 가져오기
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  
  const content = `
    <div class="w-full min-h-screen flex flex-col">
        <header class="homepage-header">
            <div class="mx-auto w-full max-w-[1400px] px-3 flex items-center">
                <div class="flex-grow"></div>
                <div class="flex items-center gap-0">
                    <a href="/help" class="header-icon-button px-2" title="도움말">
                        <i class="fas fa-question-circle text-base"></i>
                    </a>
                    ${renderUserMenu(userData)}
                </div>
            </div>
        </header>

        <section class="hero-shell flex-grow">
            <div class="hero-inner">
                <div class="flex justify-center">
                    ${getLogoSVG('large')}
                </div>
                <div class="search-shell">
                    <form action="/search" method="get">
                        <div class="search-bar">
                            <input type="text" name="q" 
                                   placeholder="직업 · 전공 검색" 
                                   autofocus>
                            <button type="submit" class="search-button" aria-label="검색">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <div class="pillar-grid w-full">
                    <a href="/analyzer" class="menu-button text-center group">
                        <i class="fas fa-brain text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">AI 추천</div>
                    </a>
                    <a href="/job" class="menu-button text-center group">
                        <i class="fas fa-briefcase text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">직업위키</div>
                    </a>
                    <a href="/major" class="menu-button text-center group">
                        <i class="fas fa-university text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">전공위키</div>
                    </a>
                    <a href="/howto" class="menu-button text-center group">
                        <i class="fas fa-route text-2xl mb-2 text-wiki-secondary group-hover:text-white"></i>
                        <div class="text-sm">HowTo</div>
                    </a>
                </div>
            </div>
        </section>
    </div>
  `
  
  return c.html(renderLayout(content, 'Careerwiki - AI 진로 분석 플랫폼', 'AI 기반 개인 맞춤형 진로 분석과 전략 리포트를 제공하는 플랫폼', true, { user: userData }))
})

// Phase 3 Day 4: renderLayout 헬퍼 함수 (자동으로 context 전달)
const renderLayoutWithContext = (
  c: Context,
  content: string,
  title?: string,
  description?: string,
  isHomepage?: boolean,
  options?: {
    extraHead?: string
    canonical?: string
    ogUrl?: string
    user?: { id: number; name: string | null; email: string; role: string; picture_url: string | null; custom_picture_url?: string | null; username: string | null } | null
  }
) => {
  return renderLayout(content, title, description, isHomepage, { ...options, context: c })
}

// AI Analyzer Page - Choose between Job or Major (로그인 불필요 - 안내만)
app.get('/analyzer', (c) => {
  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 md:mt-8">
        <h1 class="text-4xl font-bold mb-8 gradient-text text-center">
            <i class="fas fa-brain mr-3"></i>AI 추천기
        </h1>
        
        <div class="glass-card p-8 rounded-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center">무엇을 추천받고 싶으신가요?</h2>
            
            <div class="grid md:grid-cols-2 gap-8 mt-8">
                <!-- Job Recommendation -->
                <a href="/analyzer/job" class="glass-card p-8 rounded-xl hover-glow block text-center group relative overflow-hidden">
                    <div class="absolute top-3 right-3 px-3 py-1.5 bg-emerald-500/20 border border-emerald-500/40 rounded-full text-xs font-bold text-emerald-400">
                        <i class="fas fa-gift mr-1"></i>베타 무료
                    </div>
                    <i class="fas fa-briefcase text-6xl mb-4 text-wiki-secondary group-hover:text-wiki-primary transition"></i>
                    <h3 class="text-2xl font-bold mb-3">직업 추천</h3>
                    <p class="text-wiki-muted">
                        나의 성향, 능력, 가치관을 바탕으로<br>
                        적합한 직업을 AI가 추천해드립니다
                    </p>
                    <div class="mt-4 flex items-center justify-center gap-2">
                        <span class="text-wiki-muted line-through text-sm">₩50,000</span>
                        <span class="text-emerald-400 font-bold text-lg">무료</span>
                    </div>
                    <p class="text-xs text-emerald-400/70 mt-1">베타 기간 한정 무료 제공</p>
                    <div class="mt-4">
                        <span class="px-6 py-3 bg-wiki-primary text-white rounded-lg inline-block group-hover:bg-blue-600 transition">
                            직업 추천받기 →
                        </span>
                    </div>
                </a>

                <!-- Major Recommendation -->
                <a href="/analyzer/major" class="glass-card p-8 rounded-xl hover-glow block text-center group relative overflow-hidden">
                    <div class="absolute top-3 right-3 px-3 py-1.5 bg-emerald-500/20 border border-emerald-500/40 rounded-full text-xs font-bold text-emerald-400">
                        <i class="fas fa-gift mr-1"></i>베타 무료
                    </div>
                    <i class="fas fa-university text-6xl mb-4 text-wiki-secondary group-hover:text-wiki-primary transition"></i>
                    <h3 class="text-2xl font-bold mb-3">전공 추천</h3>
                    <p class="text-wiki-muted">
                        나의 적성, 흥미, 목표를 분석하여<br>
                        최적의 전공을 AI가 추천해드립니다
                    </p>
                    <div class="mt-4 flex items-center justify-center gap-2">
                        <span class="text-wiki-muted line-through text-sm">₩10,000</span>
                        <span class="text-emerald-400 font-bold text-lg">무료</span>
                    </div>
                    <p class="text-xs text-emerald-400/70 mt-1">베타 기간 한정 무료 제공</p>
                    <div class="mt-4">
                        <span class="px-6 py-3 bg-wiki-primary text-white rounded-lg inline-block group-hover:bg-blue-600 transition">
                            전공 추천받기 →
                        </span>
                    </div>
                </a>
            </div>
            
            <!-- 로그인 필요 안내 -->
            <div class="mt-8 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl text-center">
                <p class="text-amber-400 font-semibold mb-1">
                    <i class="fas fa-lock mr-2"></i>AI 추천을 받으려면 로그인이 필요합니다
                </p>
                <p class="text-wiki-muted text-sm">
                    로그인하시면 분석 결과 저장, 이력서 첨부, 맞춤 추천 등의 기능을 이용하실 수 있습니다.
                </p>
            </div>
            
            <div class="mt-6 text-center text-wiki-muted text-sm">
                <p>AI 추천은 개인정보를 안전하게 처리하며, 결과는 참고용으로만 활용하시기 바랍니다.</p>
            </div>
        </div>
    </div>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI 추천기 - Careerwiki'))
})

// AI Job Analyzer v2.0.0 (Stage-based Universal Intake + Follow-up) - 로그인 필수
app.get('/analyzer/job', requireAuth, (c) => {
  const debugMode = c.req.query('debug') === 'true'
  
  // ============================================
  // 통합 질문 데이터 (3단계 구조: 프로필 → 심층 → 결과)
  // Step 1 프로필에서 5축 상태 + 아래 통합 질문을 함께 수집
  // ============================================
  const universalQuestionsJson = JSON.stringify([
    // ============================================
    // 1. 관심분야 (통합: 미니모듈 interest + 기존 univ_interest)
    // ============================================
    { id: 'univ_interest', order: 1, text: '어떤 것에 관심이 있거나 재미있다고 느끼나요?', ui_type: 'chips', options: [
      { value: 'problem_solving', label: '문제해결/분석', emoji: '🔍', token: 'problem_solving' },
      { value: 'creating', label: '창작/디자인', emoji: '🎨', token: 'creating' },
      { value: 'helping', label: '사람/소통/돕기', emoji: '🤝', token: 'helping_teaching' },
      { value: 'data', label: '데이터/숫자', emoji: '📊', token: 'data_numbers' },
      { value: 'tech', label: '기술/IT', emoji: '💻', token: 'tech' },
      { value: 'organizing', label: '조직/관리', emoji: '📋', token: 'organizing' },
      { value: 'influencing', label: '영향력/설득', emoji: '📢', token: 'influencing' },
      { value: 'nature', label: '자연/환경', emoji: '🌿', token: 'nature' },
      { value: 'health', label: '건강/의료', emoji: '🏥', token: 'health' },
      { value: 'media', label: '미디어/콘텐츠', emoji: '📱', token: 'media' },
    ], allow_unknown: true, unknown_label: '잘 모르겠어요', fact_key: 'profile.interest.keywords', required: true, max_selections: 3 },

    // ============================================
    // 2. 중요 가치 (통합: 미니모듈 value + 기존 univ_priority)
    // ============================================
    { id: 'univ_priority', order: 2, text: '일에서 가장 중요하게 생각하는 건 뭔가요?', ui_type: 'chips', options: [
      { value: 'autonomy', label: '자율/자유', emoji: '🦋', token: 'autonomy' },
      { value: 'growth', label: '성장/발전', emoji: '🌱', token: 'growth' },
      { value: 'stability', label: '안정/예측가능', emoji: '🏠', token: 'stability' },
      { value: 'income', label: '높은 수입', emoji: '💰', token: 'income' },
      { value: 'meaning', label: '의미/사회기여', emoji: '🌍', token: 'meaning' },
      { value: 'recognition', label: '인정/영향력', emoji: '⭐', token: 'recognition' },
      { value: 'wlb', label: '워라밸', emoji: '⚖️', token: 'wlb' },
    ], allow_unknown: true, unknown_label: '아직 모르겠어요', fact_key: 'priority.top1', required: true, max_selections: 2 },

    // ============================================
    // 3. 강점 (통합: 미니모듈 strength + 기존 univ_strength)
    // ============================================
    { id: 'univ_strength', order: 3, text: '실제로 잘하거나 남들이 인정해준 것은?', ui_type: 'chips', options: [
      { value: 'analytical', label: '분석/논리', emoji: '🧠', token: 'analytical' },
      { value: 'creative', label: '창의/아이디어', emoji: '💡', token: 'creative' },
      { value: 'communication', label: '소통/설명', emoji: '💬', token: 'communication' },
      { value: 'structured_execution', label: '계획/실행', emoji: '📑', token: 'structured_execution' },
      { value: 'persistence', label: '끈기/인내', emoji: '🏋️', token: 'persistence' },
      { value: 'fast_learning', label: '빠른 학습', emoji: '📖', token: 'fast_learning' },
      { value: 'empathy', label: '공감/배려', emoji: '❤️', token: 'empathy' },
      { value: 'leadership', label: '리더십', emoji: '👑', token: 'leadership' },
    ], allow_unknown: true, unknown_label: '잘 모르겠어요', fact_key: 'profile.strength.keywords', required: true, max_selections: 3 },

    // ============================================
    // 4. 피하고 싶은 것 (Soft Dislike - 선호도 반영)
    // ============================================
    { id: 'univ_dislike', order: 4, text: '이건 피하고 싶다고 느끼는 게 있나요?', ui_type: 'chips', options: [
      { value: 'meeting', label: '회의 많음', emoji: '🗣️' },
      { value: 'sales', label: '영업/설득', emoji: '🤝' },
      { value: 'routine', label: '단순 반복', emoji: '🔄' },
      { value: 'pressure', label: '압박/마감', emoji: '⏰' },
      { value: 'public', label: '발표/앞에 서기', emoji: '🎤' },
      { value: 'conflict', label: '갈등/대립', emoji: '⚡' },
      { value: 'uncertainty', label: '불확실함', emoji: '❓' },
    ], allow_unknown: true, unknown_label: '딱히 없어요', fact_key: 'profile.dislike.keywords', required: true, max_selections: 3 },

    // ============================================
    // 5. 업무 스타일 (협업+환경 통합)
    // ============================================
    { id: 'univ_workstyle_social', order: 5, text: '일할 때 어떤 방식이 더 편한가요?', ui_type: 'chips', options: [
      // 협업 방식
      { value: 'solo', label: '혼자 집중', emoji: '🧘', group: 'collaboration' },
      { value: 'team', label: '팀워크', emoji: '👫', group: 'collaboration' },
      // 환경 구조 선호
      { value: 'structured', label: '규칙/절차 있는 환경', emoji: '📋', group: 'structure' },
      { value: 'flexible', label: '자유로운 환경', emoji: '🦋', group: 'structure' },
    ], allow_unknown: true, unknown_label: '모르겠어요', fact_key: 'profile.workstyle', required: true, max_selections: 2 },

    // ============================================
    // 6. 배경 정보 (선택)
    // ============================================
    { id: 'univ_special_experience', order: 6, text: '특별한 경험이나 배경이 있나요?', ui_type: 'chips', options: [
      { value: 'overseas_living', label: '해외 거주/유학', emoji: '🌍' },
      { value: 'license_cert', label: '전문 자격증/면허', emoji: '📜' },
      { value: 'startup_experience', label: '창업/사업 경험', emoji: '🚀' },
      { value: 'research_academic', label: '연구/학술 경험', emoji: '🔬' },
      { value: 'volunteer_ngo', label: '봉사/NGO 활동', emoji: '🤝' },
    ], allow_unknown: true, unknown_label: '없어요', allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.background.special_experience', required: true, max_selections: 3 },

    // ============================================
    // 7. 언어 능력 (복원) - 수준 선택 포함
    // ============================================
    { id: 'univ_language', order: 7, text: '한국어 외에 사용 가능한 언어가 있나요?', ui_type: 'language_chips', options: [
      { value: 'english', label: '영어', emoji: '🇺🇸' },
      { value: 'chinese', label: '중국어', emoji: '🇨🇳' },
      { value: 'japanese', label: '일본어', emoji: '🇯🇵' },
      { value: 'spanish', label: '스페인어', emoji: '🇪🇸' },
      { value: 'french', label: '프랑스어', emoji: '🇫🇷' },
      { value: 'german', label: '독일어', emoji: '🇩🇪' },
      { value: 'vietnamese', label: '베트남어', emoji: '🇻🇳' },
      { value: 'thai', label: '태국어', emoji: '🇹🇭' },
    ], other_languages: [
      { value: 'indonesian', label: '인도네시아어' },
      { value: 'russian', label: '러시아어' },
      { value: 'portuguese', label: '포르투갈어' },
      { value: 'arabic', label: '아랍어' },
      { value: 'hindi', label: '힌디어' },
      { value: 'italian', label: '이탈리아어' },
      { value: 'dutch', label: '네덜란드어' },
      { value: 'polish', label: '폴란드어' },
      { value: 'turkish', label: '터키어' },
      { value: 'swedish', label: '스웨덴어' },
    ], levels: [
      { value: 'basic', label: '일상회화', emoji: '💬' },
      { value: 'business', label: '업무가능', emoji: '💼' },
      { value: 'native', label: '원어민급', emoji: '🏆' },
    ], allow_unknown: true, unknown_label: '없어요', fact_key: 'profile.background.language', required: true, max_selections: 5 },

    // ============================================
    // 🔥 Q8. 포기 가능성 (Hard Bias - 매우 중요)
    // 전공 vs 직업, 안정 vs 성장, 현실 vs 이상 분기
    // ============================================
    { id: 'mm_sacrifice', order: 8, text: '진로를 위해 감수할 수 있는 것은?', ui_type: 'chips', options: [
      { value: 'low_initial_income', label: '초반 연봉이 낮아도 괜찮다', emoji: '📉', token: 'low_initial_income' },
      { value: 'willing_to_study', label: '다시 공부/훈련하는 건 괜찮다', emoji: '📚', token: 'willing_to_study' },
      { value: 'field_change_ok', label: '완전히 다른 분야로 가도 괜찮다', emoji: '🔄', token: 'field_change_ok' },
      { value: 'social_pressure_ok', label: '주변의 시선을 감수할 수 있다', emoji: '🧑‍🤝‍🧑', token: 'social_pressure_ok' },
      { value: 'no_sacrifice', label: '아무것도 포기하고 싶지 않다', emoji: '⛔', token: 'no_sacrifice' },
    ], allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.sacrifice_flags', required: true, max_selections: 2,
       help_text: '💡 이 질문 하나로 추천 방향이 크게 달라져요' },

    // ============================================
    // ⚡ Q9. 에너지 소모원 (Hard Bias - 스트레스 타입)
    // ============================================
    { id: 'mm_energy_drain', order: 9, text: '이럴 때 가장 빨리 지치나요?', ui_type: 'chips', options: [
      { value: 'people_drain', label: '사람 상대', emoji: '😵', token: 'people_drain' },
      { value: 'cognitive_drain', label: '계속 생각해야 하는 일', emoji: '🧠', token: 'cognitive_drain' },
      { value: 'time_pressure_drain', label: '시간 압박', emoji: '⏱️', token: 'time_pressure_drain' },
      { value: 'responsibility_drain', label: '책임이 큰 결정', emoji: '📊', token: 'responsibility_drain' },
      { value: 'repetition_drain', label: '반복 작업', emoji: '🔁', token: 'repetition_drain' },
      { value: 'unpredictability_drain', label: '예측 불가한 상황', emoji: '❓', token: 'unpredictability_drain' },
    ], allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.energy_drain_flags', required: true, max_selections: 2,
       help_text: '💡 버틸 수 있는 직업을 찾는 핵심 질문이에요' },

    // ============================================
    // 🧭 Q10. 성취 피드백 타입 (Soft Bias)
    // 직업 만족도 예측 정확도 향상
    // ============================================
    { id: 'mm_achievement', order: 10, text: '일을 잘하고 있다는 느낌은 언제 드나요?', ui_type: 'chips', options: [
      { value: 'metric_feedback', label: '결과가 수치로 보일 때', emoji: '🏆', token: 'metric_feedback' },
      { value: 'helping_feedback', label: '누군가에게 직접 도움이 됐을 때', emoji: '🙌', token: 'helping_feedback' },
      { value: 'problem_solved_feedback', label: '어려운 문제를 해결했을 때', emoji: '🧩', token: 'problem_solved_feedback' },
      { value: 'tangible_output_feedback', label: '내가 만든 결과물이 남을 때', emoji: '🎨', token: 'tangible_output_feedback' },
      { value: 'growth_feedback', label: '시간이 지날수록 성장할 때', emoji: '📈', token: 'growth_feedback' },
    ], allow_unknown: true, unknown_label: '잘 모르겠어요', fact_key: 'profile.achievement_feedback_top', required: true, max_selections: 2 },

    // ============================================
    // 🏃 Q11. 실행 속도 성향 (Soft Bias)
    // 스타트업/기획 vs 운영/관리/전문직 분기
    // ============================================
    { id: 'mm_execution', order: 11, text: '새로운 일을 시작할 때 나는?', ui_type: 'radio', options: [
      { value: 'action_first', label: '일단 해보며 배우는 편', emoji: '🚀', token: 'action_first' },
      { value: 'plan_first', label: '계획이 서야 시작하는 편', emoji: '🧱', token: 'plan_first' },
      { value: 'depends', label: '둘 다 상황 따라 다름', emoji: '🔄', token: 'execution_depends' },
    ], fact_key: 'profile.execution_style', required: true },

    // ============================================
    // 🌍 Q12. 영향 범위 선호 (Soft Bias)
    // 의미 지향 직업 추천 정확도 보강
    // ============================================
    { id: 'mm_impact', order: 12, text: '내 일이 영향을 미치길 바라는 범위는?', ui_type: 'radio', options: [
      { value: 'impact_individual', label: '개인 한 명', emoji: '👤', token: 'impact_individual' },
      { value: 'impact_team', label: '작은 팀/조직', emoji: '🧑‍🤝‍🧑', token: 'impact_team' },
      { value: 'impact_industry', label: '회사/산업', emoji: '🏢', token: 'impact_industry' },
      { value: 'impact_society', label: '사회 전반', emoji: '🌏', token: 'impact_society' },
      { value: 'impact_unsure', label: '잘 모르겠다', emoji: '🤷', token: 'impact_unsure' },
    ], fact_key: 'profile.impact_scope', required: true },

    // ============================================
    // 💥 Q13. 실패 반응 (Hard Bias급 보정자)
    // '버틸 수 있는 직업' 결정 핵심
    // ============================================
    { id: 'mm_failure', order: 13, text: '일이 잘 안 됐을 때, 나는 보통 어떤 반응에 가깝나요?', ui_type: 'radio', options: [
      { value: 'iterate_on_failure', label: '다시 구조를 고쳐본다', emoji: '🔄', token: 'iterate_on_failure' },
      { value: 'pivot_on_failure', label: '다른 방식으로 빠르게 바꾼다', emoji: '🧪', token: 'pivot_on_failure' },
      { value: 'pause_on_failure', label: '잠시 멈추고 정리한다', emoji: '⏸️', token: 'pause_on_failure' },
      { value: 'emotionally_affected', label: '크게 흔들린다', emoji: '💥', token: 'emotionally_affected' },
    ], allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.failure_response', required: true,
       help_text: '💡 스트레스 질문과 함께 버틸 수 있는 직업을 찾아요' },

    // ============================================
    // 🛡️ Q14. 버팀 앵커 (Desire ↔ Feasibility 갈등 해소)
    // ============================================
    { id: 'mm_anchor', order: 14, text: '아래 중 하나만 유지된다면, 힘들어도 일을 계속할 수 있다면?', ui_type: 'radio', options: [
      { value: 'reward_anchor', label: '보상이 명확함', emoji: '💰', token: 'reward_anchor' },
      { value: 'growth_anchor', label: '성장 체감', emoji: '📈', token: 'growth_anchor' },
      { value: 'people_anchor', label: '함께하는 사람', emoji: '🤝', token: 'people_anchor' },
      { value: 'meaning_anchor', label: '의미/방향성', emoji: '🧭', token: 'meaning_anchor' },
      { value: 'stability_anchor', label: '안정성', emoji: '🛡️', token: 'stability_anchor' },
    ], allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.persistence_anchor', required: true,
       help_text: '💡 싫은 게 많지만 이건 견딘다를 알려주세요' },

    // ============================================
    // 👁️ Q15. 타인 기대 반응 (직업 형태 분기)
    // 전문직 / 조직 / 프리랜서 / 창작직 분기
    // ============================================
    { id: 'mm_expectation', order: 15, text: '주변의 기대나 기준이 있을 때 나는?', ui_type: 'radio', options: [
      { value: 'external_structure_ok', label: '기준이 있으면 편하다', emoji: '🧱', token: 'external_structure_ok' },
      { value: 'neutral_to_expectation', label: '상관없다', emoji: '😐', token: 'neutral_to_expectation' },
      { value: 'expectation_pressure', label: '부담이 된다', emoji: '😣', token: 'expectation_pressure' },
    ], allow_other: true, other_label: '기타 (직접 입력)', fact_key: 'profile.external_expectation', required: true },
  ])
  
  // Job Stages 메타데이터
  const jobStagesJson = JSON.stringify([
    { id: 'job_explore', label: '탐색 단계', description: '아직 경험이 거의 없어요', emoji: '🔍' },
    { id: 'job_student', label: '학생 (전공 연계)', description: '현재 학생이에요', emoji: '🎓' },
    { id: 'job_prepare', label: '취업 준비 중', description: '곧 취업 예정이에요', emoji: '📝' },
    { id: 'job_early', label: '초기 커리어 (0~3년)', description: '일 시작한 지 얼마 안 됐어요', emoji: '🌱' },
    { id: 'job_mid', label: '경력자 (3년+)', description: '경력이 좀 쌓였어요', emoji: '🚀' },
    { id: 'job_transition', label: '전환/복귀', description: '업종 전환 또는 재취업', emoji: '🔄' },
    { id: 'job_second', label: '세컨드 커리어', description: '은퇴 후 새 시작', emoji: '🌅' },
  ])
  
  // 미성년/탐색 단계 목록
  const minorStages = ['job_explore', 'major_child', 'major_elementary', 'major_middle']
  
  // 5축 상태좌표 데이터 (Career Tree)
  const roleIdentityOptionsJson = JSON.stringify(ROLE_IDENTITY_OPTIONS)
  const careerStageOptionsJson = JSON.stringify(CAREER_STAGE_OPTIONS)
  const transitionStatusOptionsJson = JSON.stringify(TRANSITION_STATUS_OPTIONS)
  const skillLevelOptionsJson = JSON.stringify(SKILL_LEVEL_OPTIONS)
  const constraintOptionsJson = JSON.stringify(CONSTRAINT_OPTIONS)
  
  // 전이 신호 질문 데이터
  const transitionSignalQuestionsJson = JSON.stringify(TRANSITION_SIGNAL_QUESTIONS)
  
  // identity anchor 질문 데이터
  const identityAnchorPatternsJson = JSON.stringify(IDENTITY_ANCHOR_PATTERNS)
  
  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 md:mt-8">
        <h1 class="text-3xl font-bold mb-6 text-center">
            <i class="fas fa-briefcase mr-3 text-wiki-secondary"></i>AI 직업 추천
            ${debugMode ? '<span class="ml-2 text-sm bg-yellow-500 text-black px-2 py-1 rounded">DEBUG MODE</span>' : ''}
        </h1>

        <!-- 🧪 개발자 테스트 버튼 (DEBUG MODE에서만 표시) -->
        ${debugMode ? `
        <div class="mb-6 p-4 rounded-xl border-2 border-dashed border-green-500/50 bg-green-500/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-flask text-2xl text-green-400"></i>
                    <div>
                        <h3 class="font-bold text-green-300">🧪 샘플 테스트 모드</h3>
                        <p class="text-xs text-green-400/70">버튼을 누르면 샘플 데이터로 바로 결과를 확인합니다</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="runSampleTest('developer')"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-laptop-code"></i> 개발자형
                    </button>
                    <button onclick="runSampleTest('creative')"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-palette"></i> 창작형
                    </button>
                    <button onclick="runSampleTest('helper')"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-hands-helping"></i> 도움형
                    </button>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- Step Indicator (3단계: 프로필→심층→결과) -->
        <div class="flex justify-center items-center gap-2 md:gap-4 mb-6 flex-wrap" id="step-indicator">
            <div class="step-dot flex flex-col items-center active" data-step="1">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-primary text-white rounded-full font-bold text-sm md:text-base">1</span>
                <span class="text-xs mt-1">프로필</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="2">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-border text-wiki-muted rounded-full font-bold text-sm md:text-base">2</span>
                <span class="text-xs mt-1">심층</span>
            </div>
            <div class="w-8 md:w-12 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="3">
                <span class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-wiki-border text-wiki-muted rounded-full font-bold text-sm md:text-base">3</span>
                <span class="text-xs mt-1">결과</span>
            </div>
        </div>
        
        <!-- 본인 계정 사용 안내 배너 (Step 1에서만 표시) -->
        <div id="account-warning-banner" class="mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-amber-400 text-lg"></i>
                <div>
                    <p class="text-amber-300 font-medium">반드시 본인 계정으로 진행해주세요</p>
                    <p class="text-sm text-amber-200/70">입력한 정보는 현재 로그인된 계정에 저장됩니다. 다른 사람의 계정으로 진행하면 데이터가 섞일 수 있어요.</p>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- 로딩 오버레이 -->
        <!-- ============================================ -->
        <div id="loading-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-8 rounded-2xl text-center max-w-sm mx-4">
                <div class="relative w-16 h-16 mx-auto mb-4">
                    <div class="absolute inset-0 border-4 border-wiki-primary/30 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-transparent border-t-wiki-primary rounded-full animate-spin"></div>
                </div>
                <p id="loading-message" class="text-lg font-semibold text-white mb-2">처리 중...</p>
                <p id="loading-submessage" class="text-sm text-wiki-muted">잠시만 기다려주세요</p>
            </div>
        </div>
        
        <!-- 이어하기/새로시작 모달 -->
        <div id="continue-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-wiki-border/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-500 to-wiki-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-history text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">진행 중인 분석이 있습니다</h3>
                    <p class="text-wiki-muted text-sm" id="continue-modal-info">
                        <!-- 동적으로 채워짐 -->
                    </p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="continueFromDraft()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-wiki-primary text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-play mr-2"></i>이어서 하기
                    </button>
                    <button type="button" onclick="showRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-redo mr-2"></i>새로 시작하기
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 새로 시작 경고 모달 -->
        <div id="restart-warning-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-amber-500/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">정말 새로 시작하시겠습니까?</h3>
                    <p class="text-wiki-muted text-sm">
                        이전에 입력한 모든 내용이 삭제됩니다.<br>
                        이 작업은 되돌릴 수 없습니다.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="hideRestartWarning()"
                            class="flex-1 px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition whitespace-nowrap">
                        취소
                    </button>
                    <button type="button" onclick="confirmRestart()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:opacity-90 transition whitespace-nowrap">
                        삭제 후 시작
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 0: 추천 유형 선택 (이미 /analyzer에서 선택됨 - 숨김) -->
        <!-- ============================================ -->
        <div id="step0" class="step-content hidden glass-card p-8 rounded-2xl mb-6">
            <!-- /analyzer/job으로 직접 접근했으므로 유형 선택은 생략 -->
        </div>
        
        <!-- ============================================ -->
        <!-- Step 1: 프로필 단계 (2라운드 구조) -->
        <!-- ============================================ -->
        <div id="step1" class="step-content">
            <!-- ========================================== -->
            <!-- 프로필 1-1: 당신에 대해 알려주세요 (5축 상태좌표) -->
            <!-- ========================================== -->
            <div id="profile-step-1" class="glass-card p-6 md:p-8 rounded-2xl mb-6">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2));">
                        <span class="text-xs text-purple-300">프로필 1/2</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300">
                        <i class="fas fa-user-circle text-wiki-primary mr-3"></i>당신에 대해 알려주세요
                    </h2>
                    <p class="text-wiki-muted mt-2">현재 상황을 파악해요 (1~2분)</p>
                </div>
                
                <!-- 이력서 업로드 섹션 (선택사항) -->
                <div class="mb-8 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px dashed rgba(99,102,241,0.3);">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">이력서로 빠르게 시작하기</h3>
                            <p class="text-xs" style="color: rgb(148,163,184)">PDF 이력서를 업로드하면 아래 항목을 자동으로 채워드려요</p>
                        </div>
                        <span class="ml-auto px-3 py-1 text-xs rounded-full" style="background-color: rgba(99,102,241,0.2); color: rgb(165,180,252);">선택사항</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="file" id="resume-upload" accept=".pdf" class="hidden" onchange="handleResumeUpload(this)">
                            <div class="flex items-center justify-center gap-3 px-4 py-3 rounded-xl border-2 border-dashed transition-all hover:border-indigo-400"
                                 style="background-color: rgba(26,26,46,0.5); border-color: rgba(99,102,241,0.3);">
                                <i class="fas fa-cloud-upload-alt text-xl" style="color: rgb(165,180,252);"></i>
                                <span style="color: rgb(148,163,184);">PDF 파일 선택</span>
                            </div>
                        </label>
                        
                        <div id="resume-status" class="hidden flex items-center gap-2 px-4 py-3 rounded-xl" style="background-color: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);">
                            <i class="fas fa-check-circle text-emerald-400"></i>
                            <span class="text-emerald-400 text-sm" id="resume-status-text">분석 완료!</span>
                        </div>
                    </div>
                    
                    <p class="text-xs mt-2" style="color: rgb(100,116,139);">
                        <i class="fas fa-info-circle mr-1"></i>
                        파일은 저장되지 않으며, 분석 참고용으로만 사용됩니다. 임시저장 시 분석 결과만 저장됩니다.
                    </p>
                    
                    <div id="resume-loading" class="hidden mt-3 flex items-center justify-center gap-3 py-3">
                        <i class="fas fa-spinner fa-spin text-indigo-400"></i>
                        <span style="color: rgb(165,180,252);">이력서 분석 중...</span>
                    </div>
                    
                    <div id="resume-error" class="hidden mt-3 p-3 rounded-lg" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);">
                        <p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i><span id="resume-error-text"></span></p>
                    </div>
                </div>
                
                <!-- 5축 상태좌표 입력 영역 -->
                <div class="space-y-8" id="career-state-form">
                
                <!-- 축 1: 역할 정체성 -->
                <div class="state-axis-section" data-axis="role_identity">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-wiki-primary to-wiki-secondary rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">1</div>
                        <h3 class="text-lg font-bold">현재 나는?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="role-options">
                <!-- JS로 동적 생성 -->
                    </div>
            </div>
            
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 2: 경력 연차 -->
                <div class="state-axis-section" data-axis="career_stage_years">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">2</div>
                        <h3 class="text-lg font-bold">경력은?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="career-stage-options">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 3: 현재 목표 (다중 선택) -->
                <div class="state-axis-section" data-axis="transition_status">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">3</div>
                        <h3 class="text-lg font-bold">현재 목표는?</h3>
                        <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">복수 선택</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">원하는 목표를 모두 선택해주세요</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="transition-status-options">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 4: 숙련도 (관심 분야 기준) -->
                <div class="state-axis-section" data-axis="skill_level">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">4</div>
                        <h3 class="text-lg font-bold">관심 분야에서의 숙련도는?</h3>
                    </div>
                    <div class="ml-11 mb-4 p-3 bg-violet-500/10 rounded-lg border border-violet-500/20">
                        <p class="text-sm text-violet-300">
                            <i class="fas fa-lightbulb mr-2"></i>
                            현재 경력과 무관하게, <strong>앞으로 가고 싶은 분야</strong> 기준으로 선택해주세요
                        </p>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3" id="skill-level-options">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 5: 제약 조건 (다중 선택) -->
                <div class="state-axis-section" data-axis="constraints">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">5</div>
                        <h3 class="text-lg font-bold">현재 제약이 있나요?</h3>
                        <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full">선택사항</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">해당하는 제약을 선택하면 맞춤 추천에 반영됩니다</p>
                    <div class="max-w-2xl mx-auto" id="constraint-options">
                        <!-- JS로 동적 생성 (카드형 아코디언) -->
                    </div>
                </div>
                
                </div>
                
                <!-- 프로필 1-1 하단 버튼 -->
                <div class="flex justify-center gap-3 pt-8 mt-6 border-t border-wiki-border/30">
                    <a href="/analyzer"
                       class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>유형 다시 선택
                    </a>
                    <button type="button" onclick="saveDraftNow()" id="profile1-save-btn"
                            class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                        <i class="fas fa-save mr-2 text-emerald-400"></i>임시저장
                    </button>
                    <button type="button" id="profile1-next-btn" onclick="goToProfileStep2()"
                            class="px-10 py-4 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold rounded-xl shadow-lg shadow-wiki-primary/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-wiki-primary/40 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-arrow-right mr-2"></i>다음
                    </button>
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- 프로필 1-2: 나를 알아가기 (통합 질문) -->
            <!-- ========================================== -->
            <div id="profile-step-2" class="glass-card p-6 md:p-8 rounded-2xl mb-6 hidden">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(249,115,22,0.2));">
                        <span class="text-xs text-amber-300">프로필 2/2</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-orange-300">
                        <i class="fas fa-compass text-amber-400 mr-3"></i>나를 알아가기
                    </h2>
                    <p class="text-wiki-muted mt-2">각 질문에서 가장 끌리는 것을 선택해주세요 (2~3분)</p>
                </div>
                
                <!-- 통합 질문 컨테이너 -->
                <div class="space-y-6" id="integrated-questions-section">
                    <div id="integrated-questions-container">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>
                
                <!-- 프로필 1-2 하단 버튼 -->
                <div class="flex justify-center gap-3 pt-8 mt-6 border-t border-wiki-border/30">
                    <button type="button" onclick="goToProfileStep1()"
                            class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>이전
                    </button>
                    <button type="button" onclick="saveDraftNow()" id="profile2-save-btn"
                            class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                        <i class="fas fa-save mr-2 text-emerald-400"></i>임시저장
                    </button>
                    <button type="button" id="step1-next-btn" onclick="goToStep2Direct()" disabled
                            class="px-10 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl shadow-lg shadow-amber-500/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-amber-500/40 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-arrow-right mr-2"></i>심층 질문으로
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 2: 심층 질문 (LLM Follow-up) -->
        <!-- ============================================ -->
        <div id="step2" class="step-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-user-astronaut text-purple-400 mr-2"></i>심층 질문 (1~2분)
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm" id="step2-subtitle">
                더 정확한 추천을 위한 맞춤 질문이에요
            </p>
            
            <div id="followup-questions-form" class="space-y-6">
                <!-- JS로 동적 생성 -->
            </div>
            
            <div class="flex justify-center gap-3 pt-6">
                <button type="button" id="step2-prev-btn"
                        class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                    <i class="fas fa-arrow-left mr-2"></i>이전
                </button>
                <button type="button" onclick="saveDraftNow()" id="step2-save-btn"
                        class="px-5 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg hover:border-emerald-500/50 transition inline-flex items-center">
                    <i class="fas fa-save mr-2 text-emerald-400"></i>임시저장
                </button>
                <button type="button" id="analyze-btn"
                        class="px-12 py-4 bg-gradient-to-r from-purple-500 to-wiki-secondary text-white font-bold rounded-xl hover-glow transition transform hover:scale-105">
                    <i class="fas fa-magic mr-2"></i>AI 추천 받기
                </button>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- Step 3: 결과 영역 -->
        <!-- ============================================ -->
        <div id="step3" class="step-content hidden">
            <!-- User Insight 카드 -->
            <div id="user-insight-card" class="glass-card p-6 rounded-2xl mb-6 border border-purple-500/50 hidden">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">✨</span>
                    <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        당신에 대한 인사이트
                    </span>
                </h2>
                <p id="insight-summary" class="text-lg mb-4">-</p>
                
                <div id="insight-traits" class="space-y-3 mb-4">
                    <!-- JS로 채워짐 -->
                </div>
                
                <div id="insight-applied-facts" class="text-sm text-wiki-muted border-t border-wiki-border pt-3 hidden">
                    <span class="font-semibold">적용된 정보:</span>
                    <span id="insight-facts-list">-</span>
                </div>
            </div>
            
            <!-- Confidence UI: 근거 강도 + 결정변수 -->
            <div id="confidence-card" class="glass-card p-6 rounded-2xl mb-6 border border-emerald-500/30 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-emerald-400"></i>
                    <span>추천 근거 강도</span>
                </h2>
                
                <!-- 근거 강도 게이지 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-wiki-muted">신뢰도</span>
                        <span id="confidence-score-text" class="text-lg font-bold text-emerald-400">--%</span>
                    </div>
                    <div class="w-full bg-wiki-bg rounded-full h-3 overflow-hidden">
                        <div id="confidence-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="confidence-description" class="text-xs text-wiki-muted mt-2">-</p>
                </div>
                
                <!-- 결정 변수 (Key Decision Variables) -->
                <div>
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-key text-amber-400"></i>
                        <span>이 답변들이 결과에 영향을 주었어요</span>
                    </h3>
                    <div id="key-decisions" class="space-y-2">
                        <!-- JS로 채워짐 -->
                    </div>
                </div>
            </div>
            
            <!-- TOP3 추천 결과 -->
            <div class="glass-card p-8 rounded-2xl mb-6">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-trophy text-yellow-400 mr-2"></i>TOP 3 추천 직업
                </h2>
                <div id="top3-results" class="grid md:grid-cols-3 gap-4">
                    <!-- JS로 채워짐 -->
                </div>
            </div>
            
            <!-- 디버그 패널 (debug=true일 때만) -->
            ${debugMode ? `
            <div class="glass-card p-6 rounded-2xl mb-6 border border-yellow-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-400">
                        <i class="fas fa-bug mr-2"></i>디버그 패널 (Stage-based V3)
                    </h3>
                    <button onclick="toggleDebugPanel()" class="text-sm text-wiki-muted hover:text-white">접기/펼치기</button>
                </div>
                <div id="debug-panel-content">
                    <!-- 1. Candidate Source -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-database mr-1"></i>1. Candidate Source
                        </h4>
                        <div id="debug-candidate-source" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 2. 점수 분해 -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-chart-bar mr-1"></i>2. 점수 분해 (TOP3)
                        </h4>
                        <div id="debug-score-breakdown" class="text-white font-mono text-xs overflow-x-auto">-</div>
                    </div>
                    
                    <!-- 3. Follow-up 근거 -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-question mr-1"></i>3. Follow-up 근거
                        </h4>
                        <div id="debug-followup-rationale" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 4. Rank Change -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-exchange-alt mr-1"></i>4. Rank Change
                        </h4>
                        <div id="debug-rank-change" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- 5. Applied Facts & Rules -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-cog mr-1"></i>5. Applied Facts & Rules
                        </h4>
                        <div id="debug-applied-facts" class="text-white font-mono text-xs max-h-32 overflow-y-auto">-</div>
                    </div>
                    
                    <!-- 6. 버전 정보 -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-code-branch mr-1"></i>6. 버전 정보
                        </h4>
                        <div id="debug-versions" class="text-white font-mono text-sm">-</div>
                    </div>
                    
                    <!-- Diversity/Phase4 상태 -->
                    <div class="p-3 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-semibold text-slate-400 mb-2">
                            <i class="fas fa-shield-alt mr-1"></i>Phase4 상태
                        </h4>
                        <div id="debug-phase4-status" class="text-white font-mono text-sm">-</div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- 추가 Follow-up 질문 (결과 후) -->
            <div id="result-followup-section" class="glass-card p-6 rounded-2xl mb-6 hidden">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-question-circle text-blue-400 mr-2"></i>더 정확한 추천을 위해
                </h3>
                <p id="result-followup-question" class="text-lg mb-4">-</p>
                <div id="result-followup-options" class="flex flex-wrap gap-3">
                    <!-- JS로 채워짐 -->
                </div>
            </div>
            
            <!-- 새 분석 버튼 -->
            <div class="text-center">
                <button onclick="resetAnalysis()" class="px-6 py-3 bg-wiki-card text-white rounded-lg hover:bg-wiki-primary transition">
                    <i class="fas fa-redo mr-2"></i>새로 분석하기
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // V3 Stage-based AI Analyzer
        // ============================================
        const DEBUG_MODE = ${debugMode};
        const UNIVERSAL_QUESTIONS = ${universalQuestionsJson};
        const JOB_STAGES = ${jobStagesJson};
        const MINOR_STAGES = ${JSON.stringify(minorStages)};
        
        // 5축 상태좌표 데이터 (Career Tree)
        const ROLE_IDENTITY_OPTIONS = ${roleIdentityOptionsJson};
        const CAREER_STAGE_OPTIONS = ${careerStageOptionsJson};
        const TRANSITION_STATUS_OPTIONS = ${transitionStatusOptionsJson};
        const SKILL_LEVEL_OPTIONS = ${skillLevelOptionsJson};
        const CONSTRAINT_OPTIONS = ${constraintOptionsJson};
        
        // 전이 신호 질문 데이터
        const TRANSITION_SIGNAL_QUESTIONS = ${transitionSignalQuestionsJson};

        // identity anchor 질문 데이터
        const IDENTITY_ANCHOR_PATTERNS = ${identityAnchorPatternsJson};

        // ============================================
        // 🧪 샘플 테스트 페르소나 (개발자용)
        // ============================================
        const SAMPLE_PERSONAS = {
            developer: {
                name: '개발자형 김코딩',
                description: '문제해결과 분석을 좋아하고, 기술 성장을 중시하는 개발자 지망생',
                miniModuleResult: {
                    interest_top: ['problem_solving', 'data_numbers'],
                    value_top: ['growth', 'autonomy'],
                    strength_top: ['analytical', 'fast_learning'],
                    constraint_flags: [],
                    sacrifice_flags: ['low_initial_income', 'willing_to_study'],
                    energy_drain_flags: ['people_drain', 'repetition_drain'],
                    achievement_feedback_top: ['problem_solved_feedback', 'growth_feedback'],
                    execution_style: 'action_first',
                    impact_scope: 'impact_team',
                    failure_response: 'iterate_on_failure',
                    persistence_anchor: 'growth_anchor',
                    external_expectation: 'neutral_to_expectation',
                },
                universalAnswers: {
                    univ_interest: ['problem_solving', 'data', 'tech'],
                    univ_priority: ['growth', 'autonomy'],
                    univ_strength: ['analytical', 'fast_learning'],
                    univ_dislike: ['routine', 'meeting'],
                    univ_workstyle_social: ['solo', 'flexible'],
                },
                careerState: {
                    role_identity: 'student',
                    career_stage_years: 'year_0',
                    transition_status: ['first_job'],
                    skill_level: 'level_2',
                },
            },
            creative: {
                name: '창작형 박아트',
                description: '창의적 결과물을 만들어내고, 의미 있는 일을 하고 싶은 디자이너',
                miniModuleResult: {
                    interest_top: ['creating', 'influencing'],
                    value_top: ['meaning', 'recognition'],
                    strength_top: ['creative', 'communication'],
                    constraint_flags: ['time_constraint'],
                    sacrifice_flags: ['field_change_ok'],
                    energy_drain_flags: ['time_pressure_drain', 'cognitive_drain'],
                    achievement_feedback_top: ['tangible_output_feedback', 'helping_feedback'],
                    execution_style: 'flexible_execution',
                    impact_scope: 'impact_society',
                    failure_response: 'pivot_on_failure',
                    persistence_anchor: 'meaning_anchor',
                    external_expectation: 'expectation_pressure',
                },
                universalAnswers: {
                    univ_interest: ['creating', 'media', 'influencing'],
                    univ_priority: ['meaning', 'autonomy'],
                    univ_strength: ['creative', 'communication'],
                    univ_dislike: ['routine', 'pressure'],
                    univ_workstyle_social: ['solo', 'flexible'],
                },
                careerState: {
                    role_identity: 'worker_junior',
                    career_stage_years: 'year_1_3',
                    transition_status: ['career_change'],
                    skill_level: 'level_3',
                },
            },
            helper: {
                name: '도움형 이상담',
                description: '사람을 돕고 가르치는 것을 좋아하며, 안정을 중시하는 사회복지 관심자',
                miniModuleResult: {
                    interest_top: ['helping_teaching', 'organizing'],
                    value_top: ['stability', 'meaning'],
                    strength_top: ['communication', 'persistence'],
                    constraint_flags: ['time_constraint', 'income_constraint'],
                    sacrifice_flags: ['no_sacrifice'],
                    energy_drain_flags: ['responsibility_drain', 'unpredictability_drain'],
                    achievement_feedback_top: ['helping_feedback', 'metric_feedback'],
                    execution_style: 'plan_first',
                    impact_scope: 'impact_individual',
                    failure_response: 'pause_on_failure',
                    persistence_anchor: 'people_anchor',
                    external_expectation: 'external_structure_ok',
                },
                universalAnswers: {
                    univ_interest: ['helping', 'health', 'organizing'],
                    univ_priority: ['stability', 'meaning'],
                    univ_strength: ['communication', 'persistence', 'empathy'],
                    univ_dislike: ['uncertainty', 'pressure'],
                    univ_workstyle_social: ['team', 'structured'],
                },
                careerState: {
                    role_identity: 'career_explorer',
                    career_stage_years: 'year_0',
                    transition_status: ['first_job'],
                    skill_level: 'level_1',
                },
            },
        };

        // 🧪 샘플 테스트 실행 함수
        async function runSampleTest(personaType) {
            const persona = SAMPLE_PERSONAS[personaType];
            if (!persona) {
                alert('알 수 없는 페르소나: ' + personaType);
                return;
            }

            console.log('[🧪 Sample Test] Starting with persona:', persona.name);
            showLoading('샘플 테스트 실행 중...', persona.description);

            // 세션 ID 생성
            const testSessionId = 'test_' + Date.now() + '_' + personaType;
            currentSessionId = testSessionId;
            window.miniModuleResult = persona.miniModuleResult;
            universalAnswers = persona.universalAnswers;
            careerState = persona.careerState;

            try {
                // SearchProfile 구성
                const mm = persona.miniModuleResult;
                const ua = persona.universalAnswers;
                const searchProfile = {
                    desiredThemes: [
                        ...(mm.interest_top || []),
                        ...(mm.value_top || []),
                        ...(ua.univ_interest || []),
                    ].filter(Boolean),
                    dislikedThemes: ua.univ_dislike || [],
                    strengthsHypothesis: mm.strength_top || [],
                    environmentPreferences: ua.univ_workstyle_social || [],
                    hardConstraints: mm.constraint_flags || [],
                    riskSignals: [],
                    keywords: [
                        ...(mm.interest_top || []),
                        ...(ua.univ_interest || []),
                        ...(mm.strength_top || []),
                    ].filter(Boolean),
                };

                console.log('[🧪 Sample Test] Calling v3/recommend API...');
                console.log('[🧪 Sample Test] searchProfile:', searchProfile);
                console.log('[🧪 Sample Test] mini_module_result:', mm);

                // v3/recommend API 직접 호출
                const response = await fetch('/api/ai-analyzer/v3/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: testSessionId,
                        searchProfile: searchProfile,
                        mini_module_result: mm,
                        topK: 800,
                        judgeTopN: 20,
                        debug: true,
                    })
                });

                const data = await response.json();
                console.log('[🧪 Sample Test] API Response:', data);

                hideLoading();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'API 오류: ' + response.status);
                }

                if (data.success && data.recommendations) {
                    // API에서 받은 premium_report 사용 (없으면 fallback)
                    const premiumReport = data.premium_report || {
                        executiveSummary: '🧪 샘플 테스트 결과입니다. (' + persona.name + ')',
                        lifeVersionStatement: {
                            oneLiner: persona.description,
                            expanded: [
                                '관심사: ' + mm.interest_top.join(', '),
                                '핵심 가치: ' + mm.value_top.join(', '),
                                '강점: ' + mm.strength_top.join(', '),
                            ],
                        },
                    };

                    console.log('[🧪 Sample Test] Premium Report from API:', data.premium_report);

                    // 결과를 표시용 데이터로 변환
                    const mapJobData = (job) => ({
                        job_id: job.job_id,
                        job_name: job.job_name,
                        job_description: job.job_description || '',
                        slug: job.slug || '',
                        image_url: job.image_url || '',
                        fit_score: job.fit_score,
                        like_score: job.like_score,
                        can_score: job.can_score,
                        rationale: job.rationale || '',
                        evidence_quotes: job.evidence_quotes || [],
                    });

                    // 🔍 DEBUG: API 응답 데이터 확인
                    if (data.recommendations.like_top10?.[0]) {
                        console.log('[🧪 Sample Test] 🔍 like_top10[0]:', {
                            job_name: data.recommendations.like_top10[0].job_name,
                            image_url: data.recommendations.like_top10[0].image_url,
                            job_description: data.recommendations.like_top10[0].job_description,
                        });
                    }

                    const analyzeData = {
                        request_id: testSessionId,
                        result: {
                            engine_version: 'v3',
                            fit_top3: (data.recommendations.top_jobs || []).slice(0, 10).map(mapJobData),
                            like_top10: (data.recommendations.like_top10 || []).map(mapJobData),
                            can_top10: (data.recommendations.can_top10 || []).map(mapJobData),
                            premium_report: premiumReport,
                            user_insight: {
                                summary: premiumReport.workStyleNarrative || premiumReport.executiveSummary || persona.description,
                                traits: [
                                    { name: '관심사', values: mm.interest_top },
                                    { name: '가치', values: mm.value_top },
                                    { name: '강점', values: mm.strength_top },
                                ],
                            },
                        },
                        _recommendation_mode: {
                            enabled: true,
                            total_candidates: data.recommendations.total_candidates,
                            filtered_count: data.recommendations.filtered_count,
                            search_duration_ms: data.recommendations.search_duration_ms,
                            persona_used: personaType,
                        },
                    };

                    console.log('[🧪 Sample Test] Displaying results...');
                    currentRequestId = testSessionId;
                    displayResults(analyzeData);
                    goToStep(3);

                    // 테스트 정보 배너 표시
                    showTestResultBanner(persona, data.recommendations);
                } else {
                    throw new Error('추천 결과가 없습니다: ' + JSON.stringify(data));
                }

            } catch (error) {
                hideLoading();
                console.error('[🧪 Sample Test] Error:', error);
                alert('샘플 테스트 오류: ' + error.message);
            }
        }

        // 테스트 결과 배너 표시
        function showTestResultBanner(persona, recommendations) {
            const banner = document.createElement('div');
            banner.id = 'test-result-banner';
            banner.className = 'mb-4 p-4 rounded-xl border-2 border-green-500/50 bg-green-500/10';
            banner.innerHTML = \`
                <div class="flex items-center gap-3">
                    <i class="fas fa-flask text-2xl text-green-400"></i>
                    <div class="flex-1">
                        <h3 class="font-bold text-green-300">🧪 샘플 테스트 결과</h3>
                        <p class="text-sm text-green-400/80">페르소나: <strong>\${persona.name}</strong> | 총 \${recommendations.total_candidates}개 후보 → \${recommendations.filtered_count}개 필터링 → Top \${recommendations.top_jobs?.length || 0}개 추천</p>
                        <p class="text-xs text-green-400/60 mt-1">검색 시간: \${recommendations.search_duration_ms}ms</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">닫기</button>
                </div>
            \`;

            // 기존 배너가 있으면 제거
            const existingBanner = document.getElementById('test-result-banner');
            if (existingBanner) existingBanner.remove();

            // 결과 영역 맨 위에 삽입
            const step3 = document.getElementById('step3');
            if (step3) {
                step3.insertBefore(banner, step3.firstChild);
            }
        }

        // ============================================
        // 동적 서술형 질문 시스템 (상황 + 경력 + 목표 기반)
        // ============================================
        const NARRATIVE_QUESTIONS = {
            'student_explore': {
                question1: { id: 'dream_future', text: '어떤 일을 하는 사람이 되고 싶나요? 왜 그런가요?', placeholder: '예: 사람들에게 영감을 주는 일을 하고 싶어요. 어릴 때 좋은 선생님을 만나서 제 인생이 바뀌었거든요...', emoji: '🌟', color: 'from-yellow-500 to-orange-500', fact_key: 'narrative.dream_future' },
                question2: { id: 'fun_experience', text: '학교나 일상에서 가장 재미있었던 활동은 뭐였나요? 왜 재미있었나요?', placeholder: '예: 팀 프로젝트에서 발표를 맡았을 때요. 제 아이디어가 팀원들에게 인정받는 느낌이 좋았어요...', emoji: '✨', color: 'from-pink-500 to-rose-500', fact_key: 'narrative.fun_experience' },
            },
            'student_changer': {
                question1: { id: 'change_reason', text: '전공이나 진로를 바꾸고 싶은 이유가 뭔가요?', placeholder: '예: 처음엔 부모님 권유로 선택했는데, 공부할수록 저랑 안 맞는다는 생각이 들었어요...', emoji: '🔄', color: 'from-blue-500 to-cyan-500', fact_key: 'narrative.change_reason' },
                question2: { id: 'new_interest', text: '새로 도전하고 싶은 분야가 있나요? 왜 끌리나요?', placeholder: '예: 디자인 쪽이요. 뭔가 만들어내는 일을 할 때 시간 가는 줄 모르거든요...', emoji: '🎯', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.new_interest' },
            },
            // === student + first_job 시나리오 (새로 추가) ===
            'student_first_job': {
                question1: { id: 'student_first_job_dream', text: '졸업 후 어떤 회사나 환경에서 일하고 싶나요?', placeholder: '예: 스타트업에서 일해보고 싶어요. 빠르게 배우면서 여러 일을 경험할 수 있을 것 같아서...', emoji: '🏢', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.student_first_job_dream' },
                question2: { id: 'student_first_job_prep', text: '취업 준비를 위해 지금 하고 있는 것이 있나요?', placeholder: '예: 인턴 경험을 쌓으려고 해요. 자격증도 준비 중이고, 포트폴리오도 만들고 있어요...', emoji: '📝', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.student_first_job_prep' },
            },
            'worker_junior': {
                question1: { id: 'rewarding_moment', text: '현재 일에서 가장 보람 있는 순간은 언제인가요?', placeholder: '예: 제가 맡은 기능이 실제로 배포되고 사용자 반응을 볼 때요. 내가 만든 게 누군가에게 도움이 된다는 게...', emoji: '💪', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.rewarding_moment' },
                question2: { id: 'future_vision', text: '3년 후 어떤 모습이고 싶나요? 구체적으로 상상해본다면?', placeholder: '예: 팀에서 인정받는 중간 역할이요. 후배도 가르치고, 제 의견이 반영되는 위치...', emoji: '🔮', color: 'from-indigo-500 to-blue-500', fact_key: 'narrative.future_vision' },
            },
            'worker_junior_changer': {
                question1: { id: 'change_trigger', text: '이직이나 전환을 생각하게 된 계기가 있나요?', placeholder: '예: 반복되는 업무에 성장이 멈춘 느낌이 들었어요. 매일 같은 일만 하니까...', emoji: '💭', color: 'from-amber-500 to-orange-500', fact_key: 'narrative.change_trigger' },
                question2: { id: 'next_must_have', text: '다음 직장에서 꼭 얻고 싶은 것은 뭔가요?', placeholder: '예: 새로운 기술을 배울 수 있는 환경이요. 그리고 야근 없이 제 시간을 가질 수 있으면...', emoji: '🎁', color: 'from-green-500 to-emerald-500', fact_key: 'narrative.next_must_have' },
            },
            'worker_mid': {
                question1: { id: 'proud_achievement', text: '지금까지 커리어에서 가장 자랑스러운 성과가 있다면?', placeholder: '예: 처음으로 프로젝트 리드를 맡아서 성공적으로 마무리했을 때요. 힘들었지만 뿌듯했어요...', emoji: '🏆', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.proud_achievement' },
                question2: { id: 'current_gap', text: '현재 위치에서 아쉬운 점이 있다면 뭔가요?', placeholder: '예: 관리 업무가 늘면서 실무 역량이 정체된 느낌이에요. 예전처럼 깊이 파고들 시간이 없어서...', emoji: '🤔', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.current_gap' },
            },
            'worker_mid_changer': {
                question1: { id: 'change_motivation', text: '변화를 생각하게 된 계기가 있나요? (작은 불편함이든 큰 전환점이든)', placeholder: '예: 최근 프로젝트가 끝나고 나니 다음 단계를 고민하게 됐어요. 성장이 정체된 느낌도 있고...', emoji: '💭', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.change_motivation' },
                question2: { id: 'must_avoid', text: '다음 단계에서 반드시 피하고 싶은 것은?', placeholder: '예: 정치가 심한 조직이요. 실력보다 눈치가 중요한 환경에서는 못 버틸 것 같아요...', emoji: '🚫', color: 'from-orange-600 to-red-500', fact_key: 'narrative.must_avoid' },
            },
            'worker_senior': {
                question1: { id: 'legacy', text: '지금까지 쌓아온 것 중 가장 소중한 것은 뭔가요?', placeholder: '예: 업계에서의 네트워크요. 어디서든 도움 주고받을 수 있는 관계들이 큰 자산이에요...', emoji: '💎', color: 'from-purple-600 to-indigo-600', fact_key: 'narrative.legacy' },
                question2: { id: 'remaining_goal', text: '남은 커리어에서 꼭 이루고 싶은 것이 있다면?', placeholder: '예: 후배들을 키우는 일이요. 제가 받은 도움을 다음 세대에 돌려주고 싶어요...', emoji: '🌱', color: 'from-teal-600 to-cyan-600', fact_key: 'narrative.remaining_goal' },
            },
            'worker_senior_changer': {
                question1: { id: 'senior_change_reason', text: '이 시점에서 변화를 생각하게 된 이유는 뭔가요?', placeholder: '예: 더 이상 이 분야에서 성장할 게 없다는 생각이 들었어요. 새로운 도전이 필요한 시기...', emoji: '🔄', color: 'from-blue-600 to-purple-600', fact_key: 'narrative.senior_change_reason' },
                question2: { id: 'non_negotiable', text: '새로운 시작에서 절대 포기할 수 없는 조건은?', placeholder: '예: 연봉 수준은 유지해야 해요. 가족 부양 책임이 있어서 너무 큰 리스크는 못 져요...', emoji: '⚖️', color: 'from-slate-600 to-zinc-600', fact_key: 'narrative.non_negotiable' },
            },
            'entrepreneur': {
                question1: { id: 'entrepreneur_why', text: '왜 독립적인 일을 선택하셨나요? (혹은 선택하려 하나요?)', placeholder: '예: 제 아이디어를 직접 실현하고 싶었어요. 조직에서는 항상 누군가의 결정을 기다려야 해서...', emoji: '🚀', color: 'from-orange-500 to-red-500', fact_key: 'narrative.entrepreneur_why' },
                question2: { id: 'entrepreneur_challenge', text: '독립적으로 일하면서 가장 힘든 점은 뭔가요?', placeholder: '예: 수입이 불안정한 거요. 잘될 때와 안 될 때의 차이가 너무 커서 스트레스...', emoji: '🏔️', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.entrepreneur_challenge' },
            },
            'inactive_returner': {
                question1: { id: 'gap_reflection', text: '경력 단절 기간 동안 어떤 생각이 들었나요?', placeholder: '예: 처음엔 쉬는 게 좋았는데, 시간이 지나니까 불안해졌어요. 사회와 단절된 느낌...', emoji: '💭', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.gap_reflection' },
                question2: { id: 'comeback_worry', text: '복귀하면서 가장 걱정되는 부분은 뭔가요?', placeholder: '예: 기술이 많이 바뀌었을 것 같아요. 따라갈 수 있을지, 나이 때문에 편견이 있을지...', emoji: '😰', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.comeback_worry' },
            },
            'manager_10plus_second': {
                question1: { id: 'accumulated_value', text: '지금까지 쌓은 것 중 가장 가치 있는 것은 뭔가요?', placeholder: '예: 사람을 보는 눈이요. 수많은 면접과 평가를 하면서 인재를 알아보는 감각이 생겼어요...', emoji: '💎', color: 'from-purple-600 to-pink-600', fact_key: 'narrative.accumulated_value' },
                question2: { id: 'second_career_dream', text: '은퇴 후 또는 다음 단계에서 꼭 해보고 싶은 일은?', placeholder: '예: 컨설팅이요. 제 경험을 후배 경영자들에게 나눠주고 싶어요. 돈보다는 의미가 중요...', emoji: '🌅', color: 'from-amber-500 to-orange-500', fact_key: 'narrative.second_career_dream' },
            },
            // === manager 역할 추가 시나리오 (새로 추가) ===
            'manager_growth': {
                question1: { id: 'leadership_proudest', text: '리더로서 가장 뿌듯했던 순간은 언제인가요?', placeholder: '예: 팀원이 성장해서 독립적으로 프로젝트를 이끌게 됐을 때요. 제가 한 것이 아닌데도 뿌듯했어요...', emoji: '👑', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.leadership_proudest' },
                question2: { id: 'leadership_challenge', text: '리더십에서 가장 어려운 점은 뭔가요?', placeholder: '예: 팀원들의 서로 다른 기대를 조율하는 거요. 모두를 만족시킬 수 없다는 걸 알면서도...', emoji: '🤔', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.leadership_challenge' },
            },
            'manager_changer': {
                question1: { id: 'manager_change_reason', text: '관리자로서 새로운 분야로 전환하려는 이유는 뭔가요?', placeholder: '예: 현재 조직에서 더 성장하기 어려워요. 새로운 도전이 필요한 시점인 것 같아요...', emoji: '🔄', color: 'from-blue-600 to-purple-600', fact_key: 'narrative.manager_change_reason' },
                question2: { id: 'manager_transferable', text: '다른 분야에서도 활용 가능한 본인의 강점은 뭘까요?', placeholder: '예: 사람을 이끄는 경험이요. 어떤 분야든 팀을 만들고 키우는 건 비슷할 것 같아요...', emoji: '💼', color: 'from-emerald-500 to-teal-500', fact_key: 'narrative.manager_transferable' },
            },
            'worker_changer': {
                question1: { id: 'change_trigger_general', text: '이직이나 전환을 생각하게 된 계기가 있나요?', placeholder: '예: 성장이 멈춘 느낌이 들었어요. 매일 같은 일만 반복하니까 무기력해지더라고요...', emoji: '💭', color: 'from-blue-500 to-cyan-500', fact_key: 'narrative.change_trigger' },
                question2: { id: 'next_priority', text: '다음 직장/커리어에서 가장 중요하게 생각하는 것은?', placeholder: '예: 배울 수 있는 환경이요. 정체되지 않고 계속 성장할 수 있는 곳이면 좋겠어요...', emoji: '⭐', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.next_priority' },
            },
            // === job_seeker 역할 시나리오 (새로 추가) ===
            'job_seeker_first': {
                question1: { id: 'first_job_expectation', text: '첫 직장에서 가장 기대하는 것은 뭔가요?', placeholder: '예: 실무 경험을 쌓으면서 전문성을 키우고 싶어요. 좋은 멘토를 만났으면 좋겠어요...', emoji: '🌟', color: 'from-yellow-500 to-amber-500', fact_key: 'narrative.first_job_expectation' },
                question2: { id: 'first_job_worry', text: '취업 준비 중 가장 걱정되거나 어려운 점은 뭔가요?', placeholder: '예: 스펙이 부족한 것 같아서 걱정이에요. 어디서부터 시작해야 할지 막막하고...', emoji: '😰', color: 'from-slate-500 to-gray-600', fact_key: 'narrative.first_job_worry' },
            },
            'job_seeker_return': {
                question1: { id: 'return_gap_experience', text: '경력 공백 기간 동안 어떤 경험을 하셨나요?', placeholder: '예: 육아에 집중했어요. 힘들었지만 아이와 함께한 시간이 소중했어요. 그 외에도...', emoji: '💭', color: 'from-blue-500 to-indigo-500', fact_key: 'narrative.return_gap_experience' },
                question2: { id: 'return_concern', text: '복귀하면서 가장 걱정되는 부분은 뭔가요?', placeholder: '예: 업계가 많이 변했을 것 같아요. 제 경력이 아직 유효한지, 적응할 수 있을지...', emoji: '🤔', color: 'from-amber-500 to-yellow-500', fact_key: 'narrative.return_concern' },
            },
            'job_seeker_second': {
                question1: { id: 'second_career_motivation', text: '새로운 커리어를 시작하려는 이유는 뭔가요?', placeholder: '예: 은퇴 후에도 의미 있는 일을 하고 싶어요. 그동안 쌓은 경험을 다른 방식으로 활용하고...', emoji: '🌅', color: 'from-orange-500 to-amber-500', fact_key: 'narrative.second_career_motivation' },
                question2: { id: 'second_career_vision', text: '새로운 커리어에서 이루고 싶은 것이 있다면?', placeholder: '예: 젊은 세대에게 도움이 되고 싶어요. 컨설팅이나 강의 같은 것도 생각하고 있어요...', emoji: '🎯', color: 'from-purple-500 to-pink-500', fact_key: 'narrative.second_career_vision' },
            },
            'job_seeker_explore': {
                question1: { id: 'explore_interest', text: '요즘 관심이 가거나 끌리는 분야가 있나요?', placeholder: '예: IT 쪽에 관심이 가요. 비전공자도 할 수 있는 것들이 있다고 들어서...', emoji: '🔍', color: 'from-cyan-500 to-blue-500', fact_key: 'narrative.explore_interest' },
                question2: { id: 'explore_blocker', text: '방향을 정하기 어려운 이유가 뭘까요?', placeholder: '예: 뭘 좋아하는지 잘 모르겠어요. 이것저것 해보고 싶은데 어디서부터 시작해야 할지...', emoji: '❓', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.explore_blocker' },
            },
            'default': {
                question1: { id: 'high_alive', text: '최근 6개월 중 가장 "살아있다"고 느낀 순간은 언제였나요? 왜 그랬나요?', placeholder: '예: 팀 프로젝트에서 제 아이디어가 채택됐을 때요. 처음으로 제 생각이 인정받은 느낌이었고...', emoji: '🔥', color: 'from-orange-500 to-red-500', fact_key: 'narrative.high_alive_moment' },
                question2: { id: 'lost_moment', text: '반대로 가장 "나를 잃었다"고 느낀 순간은 언제였나요? 왜 그랬나요?', placeholder: '예: 매일 같은 보고서를 작성할 때요. 제가 누군지, 왜 이 일을 하는지 모르겠었어요...', emoji: '🌫️', color: 'from-violet-500 to-purple-500', fact_key: 'narrative.lost_moment' },
            },
        };
        
        // 컨텍스트 키 생성 함수
        function getNarrativeContextKey(roleIdentity, careerStage, transitionStatus) {
            // transitionStatus를 배열로 정규화 (문자열/배열 모두 지원)
            const statusArray = Array.isArray(transitionStatus) 
                ? transitionStatus 
                : (transitionStatus ? [transitionStatus] : []);
            const hasStatus = (status) => statusArray.includes(status);
            
            // 1. job_seeker 역할 전용 (새로 추가)
            if (roleIdentity === 'job_seeker') {
                if (hasStatus('first_job')) return 'job_seeker_first';
                if (hasStatus('return_work')) return 'job_seeker_return';
                if (hasStatus('second_career')) return 'job_seeker_second';
                if (hasStatus('explore')) return 'job_seeker_explore';
                return 'job_seeker_first'; // 기본값
            }
            
            // 2. manager 역할 처리 (확장)
            if (roleIdentity === 'manager') {
                if (careerStage === '10_plus' && hasStatus('second_career')) return 'manager_10plus_second';
                if (hasStatus('field_change')) return 'manager_changer';
                return 'manager_growth';
            }
            
            // 3. 특수 역할 처리
            // Note: 'inactive' 역할은 UI에 존재하지 않으므로 inactive_returner 체크 제거
            // 경력 복귀자는 job_seeker + return_work → job_seeker_return 시나리오 사용
            if (roleIdentity === 'entrepreneur') return 'entrepreneur';
            
            // 4. 학생 역할 처리 (확장)
            if (roleIdentity === 'student') {
                if (hasStatus('first_job')) return 'student_first_job';
                if (hasStatus('field_change')) return 'student_changer';
                return 'student_explore';
            }
            
            // 5. 이직/전환 의사가 있는 경우 (worker)
            if (hasStatus('field_change') || transitionStatus === 'changer') {
                if (careerStage === '0_3') return 'worker_junior_changer';
                if (careerStage === '3_10') return 'worker_mid_changer';
                if (careerStage === '10_plus') return 'worker_senior_changer';
                return 'worker_changer';
            }
            
            // 6. 경력 기반
            if (careerStage === 'none' || careerStage === '0_3') return 'worker_junior';
            if (careerStage === '3_10') return 'worker_mid';
            if (careerStage === '10_plus') return 'worker_senior';
            
            // 7. 기본값
            return 'default';
        }
        
        // 서술형 질문 가져오기
        function getNarrativeQuestions() {
            const key = getNarrativeContextKey(
                careerState.role_identity,
                careerState.career_stage_years,
                careerState.transition_status
            );
            console.log('[V3] Narrative context key:', key, { role: careerState.role_identity, career: careerState.career_stage_years, transition: careerState.transition_status });
            return NARRATIVE_QUESTIONS[key] || NARRATIVE_QUESTIONS['default'];
        }
        
        // 상태 관리 - /analyzer/job으로 진입했으므로 Step 1(상태 선택)부터 시작
        let currentStep = 1;
        let profileSubStep = 1;  // 프로필 서브스텝 (1: 5축 상태, 2: 나를 알아가기)
        let selectedAnalysisType = 'job';
        let selectedStage = null;  // 기존 호환성
        let universalAnswers = {};
        let followupAnswers = {};
        let transitionSignalAnswers = {};  // 전이 신호 답변
        let currentSessionId = null;
        let currentRequestId = null;
        let previousTop3 = [];
        
        // 프로필 서브스텝 이동 함수
        function goToProfileStep1() {
            profileSubStep = 1;
            document.getElementById('profile-step-1')?.classList.remove('hidden');
            document.getElementById('profile-step-2')?.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function goToProfileStep2() {
            // 5축 중 최소 1개 선택 확인
            if (!careerState.role_identity) {
                alert('현재 상태를 선택해주세요.');
                return;
            }
            
            profileSubStep = 2;
            document.getElementById('profile-step-1')?.classList.add('hidden');
            document.getElementById('profile-step-2')?.classList.remove('hidden');
            
            // 통합 질문 렌더링 (학생/어른에 따라 항상 다시 렌더링)
            renderIntegratedQuestions();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 5축 상태좌표 저장
        let careerState = {
            role_identity: null,
            career_stage_years: null,
            transition_status: null,
            skill_level: null,
            constraints: {}
        };
        
        // ============================================
        // 로딩 오버레이
        // ============================================
        function showLoading(message, submessage = '잠시만 기다려주세요') {
            const overlay = document.getElementById('loading-overlay');
            const msgEl = document.getElementById('loading-message');
            const subEl = document.getElementById('loading-submessage');
            if (msgEl) msgEl.textContent = message;
            if (subEl) subEl.textContent = submessage;
            if (overlay) overlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }
        
        // ============================================
        // 이력서 업로드 처리
        // ============================================
        async function handleResumeUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // PDF 파일 확인
            if (file.type !== 'application/pdf') {
                showResumeError('PDF 파일만 업로드 가능합니다.');
                return;
            }
            
            // 파일 크기 제한 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showResumeError('파일 크기는 5MB 이하만 가능합니다.');
                return;
            }
            
            // UI 상태 변경
            document.getElementById('resume-loading').classList.remove('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.add('hidden');
            
            try {
                // pdf.js로 텍스트 추출 (CDN 사용)
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                if (!pdfjsLib) {
                    // pdf.js 동적 로드
                    await loadPdfJs();
                }
                
                const pdfText = await extractTextFromPdf(file);
                
                if (pdfText.length < 100) {
                    showResumeError('이력서에서 충분한 텍스트를 추출하지 못했습니다. 텍스트 기반 PDF인지 확인해주세요.');
                    return;
                }
                
                // 서버로 파싱 요청
                const response = await fetch('/api/ai-analyzer/resume/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: pdfText,
                        session_id: currentSessionId,
                        save_to_draft: false,
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || '파싱 실패');
                }
                
                // 파싱 결과로 UI 업데이트
                applyResumeParseResult(data.career_state, data.data);
                
                // 성공 상태 표시
                document.getElementById('resume-loading').classList.add('hidden');
                document.getElementById('resume-status').classList.remove('hidden');
                
                // 이력서 형식 확인 (추출된 데이터 기준)
                const extracted = data.data.extracted || {};
                const hasSkills = extracted.skills?.length > 0;
                const hasCerts = extracted.certifications?.length > 0;
                const hasEducation = !!extracted.education_level;
                const hasExperience = extracted.total_experience_years !== null;
                const hasRole = !!extracted.current_role_type;
                
                // 2개 이상의 정보가 추출되었으면 이력서로 인정
                const extractedCount = [hasSkills, hasCerts, hasEducation, hasExperience, hasRole].filter(Boolean).length;
                
                if (extractedCount < 2) {
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-amber-400">⚠️ 충분한 정보를 추출하지 못했어요. 그래도 입력하신 내용은 참고됩니다.</span>';
                } else {
                    const infoSummary = [];
                    if (hasSkills) infoSummary.push('스킬 ' + extracted.skills.length + '개');
                    if (hasCerts) infoSummary.push('자격증 ' + extracted.certifications.length + '개');
                    if (hasEducation) infoSummary.push(extracted.education_level);
                    if (hasExperience) infoSummary.push('경력 ' + extracted.total_experience_years + '년');
                    if (hasRole) infoSummary.push(extracted.current_role_type);
                    
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-emerald-400">✓ 분석 완료! (' + infoSummary.slice(0, 3).join(', ') + ')</span>';
                }
                
            } catch (error) {
                console.error('Resume upload error:', error);
                showResumeError(error.message || '이력서 분석 중 오류가 발생했습니다.');
            }
        }
        
        function showResumeError(message) {
            document.getElementById('resume-loading').classList.add('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.remove('hidden');
            document.getElementById('resume-error-text').textContent = message;
        }
        
        // pdf.js 동적 로드
        async function loadPdfJs() {
            return new Promise((resolve, reject) => {
                if (window.pdfjsLib) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = () => reject(new Error('PDF.js 로드 실패'));
                document.head.appendChild(script);
            });
        }
        
        // PDF에서 텍스트 추출
        async function extractTextFromPdf(file) {
            await loadPdfJs();
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            return fullText.trim();
        }
        
        // 파싱 결과를 UI에 적용
        function applyResumeParseResult(careerStateFromResume, parsedData) {
            // 이력서 업로드 플래그 설정
            window.resumeUploaded = true;
            
            // 이력서에서 추출한 배경 정보 저장 (심층 질문에서 사용)
            const extracted = parsedData.extracted || {};
            const bgParts = [];
            if (extracted.education_level) bgParts.push(extracted.education_level);
            if (extracted.major) bgParts.push(extracted.major + ' 전공');
            if (extracted.current_role_type) bgParts.push(extracted.current_role_type);
            if (extracted.total_experience_years) bgParts.push('경력 ' + extracted.total_experience_years + '년');
            if (extracted.industry) bgParts.push(extracted.industry + ' 분야');
            if (extracted.skills?.length > 0) bgParts.push('스킬: ' + extracted.skills.slice(0, 3).join(', '));
            
            window.resumeCareerBackground = bgParts.join(', ');
            console.log('[Resume] Career background extracted:', window.resumeCareerBackground);
            
            // 역할 정체성 선택
            if (careerStateFromResume.role_identity) {
                const roleBtn = document.querySelector(\`#role-options [data-value="\${careerStateFromResume.role_identity}"]\`);
                if (roleBtn) roleBtn.click();
            }
            
            // 경력 연차 선택
            if (careerStateFromResume.career_stage_years) {
                const stageBtn = document.querySelector(\`#career-stage-options [data-value="\${careerStateFromResume.career_stage_years}"]\`);
                if (stageBtn) stageBtn.click();
            }
            
            // 전환 상태 선택
            if (careerStateFromResume.transition_status) {
                const transBtn = document.querySelector(\`#transition-status-options [data-value="\${careerStateFromResume.transition_status}"]\`);
                if (transBtn && !transBtn.classList.contains('selected')) transBtn.click();
            }
            
            // 숙련도 선택
            if (careerStateFromResume.skill_level !== undefined && careerStateFromResume.skill_level !== null) {
                const skillBtn = document.querySelector(\`#skill-level-options [data-value="\${careerStateFromResume.skill_level}"]\`);
                if (skillBtn) skillBtn.click();
            }
            
            console.log('Resume parsed successfully:', parsedData);
        }
        
        // ============================================
        // Step 네비게이션
        // ============================================
        const visitedSteps = {};  // 방문 기록 및 스크롤 위치 저장
        
        // ============================================
        // Summary Banner: 누적 메모리 요약 표시
        // ============================================
        function renderSummaryBanner(containerId, memory) {
            const container = document.getElementById(containerId);
            if (!container || !memory) return;
            
            // 기존 배너 제거
            const existingBanner = container.querySelector('.summary-banner');
            if (existingBanner) existingBanner.remove();
            
            const summaryItems = [];
            
            // 안정적 동기 (confidence 높은 것)
            if (memory.stable_drivers && memory.stable_drivers.length > 0) {
                const topDrivers = memory.stable_drivers
                    .filter(d => d.confidence >= 0.6)
                    .slice(0, 2)
                    .map(d => d.text);
                if (topDrivers.length > 0) {
                    summaryItems.push('✨ 에너지 올라가는 순간: ' + topDrivers.join(', '));
                }
            }
            
            // 반복 두려움
            if (memory.recurring_fears && memory.recurring_fears.length > 0) {
                const topFears = memory.recurring_fears
                    .filter(f => f.confidence >= 0.6)
                    .slice(0, 2)
                    .map(f => f.text);
                if (topFears.length > 0) {
                    summaryItems.push('💭 피하고 싶은 것: ' + topFears.join(', '));
                }
            }
            
            // 가치 충돌
            if (memory.contradictions && memory.contradictions.length > 0) {
                summaryItems.push('⚡ 탐색 중인 갈등: ' + memory.contradictions[0].text);
            }
            
            // 의사결정 기준
            if (memory.decision_rules && memory.decision_rules.length > 0) {
                const topRule = memory.decision_rules.find(r => r.confidence >= 0.7);
                if (topRule) {
                    summaryItems.push('📋 확인된 기준: ' + topRule.text);
                }
            }
            
            if (summaryItems.length === 0) return;
            
            const banner = document.createElement('div');
            banner.className = 'summary-banner bg-wiki-card/50 border border-wiki-border/50 rounded-xl p-4 mb-6';
            banner.innerHTML = \`
                <div class="text-sm text-wiki-muted mb-2 font-medium">💡 지금까지 파악된 당신의 기준</div>
                <div class="space-y-1">
                    \${summaryItems.map(item => \`<div class="text-wiki-text text-sm">\${item}</div>\`).join('')}
                </div>
            \`;
            
            // 컨테이너 최상단에 삽입
            const firstChild = container.firstChild;
            container.insertBefore(banner, firstChild);
        }
        
        function goToStep(step, skipRender = false) {
            // 현재 Step의 스크롤 위치 저장 (떠나기 전)
            if (currentStep && visitedSteps[currentStep] !== undefined) {
                visitedSteps[currentStep] = window.scrollY;
            }
            
            currentStep = step;
            window.currentStep = step; // 전역 변수도 업데이트 (임시저장용)
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            const stepEl = document.getElementById('step' + step);
            if (stepEl) stepEl.classList.remove('hidden');
            
            // 본인 계정 경고 배너: Step 1에서만 표시
            const warningBanner = document.getElementById('account-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = step === 1 ? 'block' : 'none';
            }
            
            // ============================================
            // 요약 배너 표시 (Step 2 이상 + memory 있을 때)
            // 3단계 구조: Step 1 = 프로필, Step 2 = 심층, Step 3 = 결과
            // ============================================
            if (step >= 2 && window.aggregatedProfile?.memory) {
                const containerMap = { 2: 'step2', 3: 'step3' };
                const containerId = containerMap[step];
                if (containerId) {
                    setTimeout(() => {
                        renderSummaryBanner(containerId, window.aggregatedProfile.memory);
                    }, 100);
                }
            }

            // Step별 렌더링 복원 (3단계 구조)
            if (!skipRender) {
                try {
                    if (step === 1) {
                        setTimeout(() => {
                            restoreConstraintDetails();
                            // profileSubStep이 2인 경우에만 나를알아가기 질문 렌더링
                            if (profileSubStep === 2) {
                                renderIntegratedQuestions();
                            }
                        }, 100);
                    }
                    // Step 2는 심층 질문 (generateFollowupQuestions에서 렌더링)
                    // Step 3는 결과 (submitFollowupsAndAnalyze에서 렌더링)
                } catch (error) {
                    console.error('[goToStep] Error during render:', error);
                }
            }

            // 인디케이터 업데이트
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= step) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            // 스크롤 위치 관리: 처음 방문 → 맨 위, 재방문 → 이전 위치
            setTimeout(() => {
                if (visitedSteps[step] !== undefined) {
                    window.scrollTo(0, visitedSteps[step]);
                } else {
                    window.scrollTo(0, 0);
                    visitedSteps[step] = 0;
                }
            }, 50);
        }
        
        // ============================================
        // Step 0: 분석 유형 선택
        // ============================================
        function selectAnalysisType(type) {
            selectedAnalysisType = type;
            if (type === 'job') {
                renderStageOptions();
                goToStep(1);
            }
        }
        
        // ============================================
        // Step 1: Stage 선택
        // ============================================
        // ============================================
        // Step 1: 5축 상태좌표 UI 렌더링
        // ============================================
        // ============================================
        // 비활성화 규칙 + 비활성화 사유
        // ============================================
        const ROLE_DISABLED_RULES = {
            student: {
                career_stage: ['3_10', '10_plus'],
                transition_status: ['return_work', 'second_career'],
                skill_level: [3, 4],
                reasons: {
                    career_stage: '학생 상태에서는 선택할 수 없어요',
                    transition_status: '학생 상태에서는 해당하지 않아요',
                    skill_level: '학생 상태에서는 선택할 수 없어요'
                }
            },
            worker: {
                career_stage: [],
                transition_status: ['first_job'],
                skill_level: [],
                reasons: { transition_status: '이미 직장인이에요' }
            },
            manager: {
                career_stage: ['none'],
                transition_status: ['first_job'],
                skill_level: [0],
                reasons: {
                    career_stage: '관리자는 경험이 있어야 해요',
                    transition_status: '이미 직장인이에요',
                    skill_level: '관리자는 경험이 있어야 해요'
                }
            },
            entrepreneur: {
                career_stage: [],
                transition_status: ['first_job'],
                skill_level: [],
                reasons: { transition_status: '이미 사업을 운영 중이에요' }
            },
            job_seeker: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            }
        };
        
        // ============================================
        // 전문적인 UI 렌더링 함수들
        // ============================================
        function renderCareerStateForm() {
            renderRoleOptions();
            updateCareerStageOptions();
            updateTransitionStatusOptions();
            updateSkillLevelOptions();
            renderConstraintOptions();
            // 통합 질문은 goToProfileStep2()에서 학생/직장인 선택 후 렌더링
        }
        
        // 축 1: 역할 정체성 (다크 테마 카드 디자인)
        function renderRoleOptions() {
            const container = document.getElementById('role-options');
            if (!container) return;
            
            container.innerHTML = ROLE_IDENTITY_OPTIONS.map((opt, idx) => \`
                <button type="button" onclick="selectRole('\${opt.value}', this)"
                        class="role-card group relative overflow-hidden rounded-xl border p-4 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg"
                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                        data-value="\${opt.value}"
                        onmouseover="this.style.borderColor='rgba(67,97,238,0.5)'; this.style.backgroundColor='rgba(26,26,46,1)';"
                        onmouseout="if(!this.classList.contains('selected')){this.style.borderColor='rgba(42,42,62,0.5)'; this.style.backgroundColor='rgba(26,26,46,0.9)';}">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-blue-500/10 to-transparent rounded-bl-full"></div>
                    <div class="relative z-10">
                        <div class="text-3xl mb-2 transform group-hover:scale-110 transition-transform">\${opt.emoji}</div>
                        <div class="font-semibold text-white">\${opt.label}</div>
                        <div class="text-xs text-slate-400 mt-1 leading-relaxed">\${opt.description}</div>
                    </div>
                    <div class="tooltip-content absolute left-1/2 -translate-x-1/2 bottom-full mb-3 px-4 py-2 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none w-56 text-center z-50 shadow-xl border border-slate-700">
                        \${opt.help}
                    </div>
                </button>
            \`).join('');
        }
        
        function selectRole(value, btnEl) {
            careerState.role_identity = value;
            
            // 애니메이션과 함께 선택 상태 업데이트
            document.querySelectorAll('#role-options .role-card').forEach(btn => {
                btn.classList.remove('selected', 'shadow-lg');
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
            });
            btnEl.classList.add('selected', 'shadow-lg');
            btnEl.style.borderColor = '#4361ee';
            btnEl.style.backgroundColor = 'rgba(67,97,238,0.2)';
            
            // 다른 축들 업데이트 (애니메이션 효과)
            setTimeout(() => {
                updateCareerStageOptions();
                updateTransitionStatusOptions();
                updateSkillLevelOptions();
            }, 150);
            
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // 축 2: 경력 기간 (다크 테마 프로그레스 바)
        function updateCareerStageOptions() {
            const container = document.getElementById('career-stage-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { career_stage: [], reasons: {} };
            const disabledValues = rules.career_stage || [];
            const reason = rules.reasons?.career_stage || '현재 상태에서 선택할 수 없어요';
            
            container.innerHTML = CAREER_STAGE_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.career_stage_years === opt.value;
                const progressWidth = [0, 33, 66, 100][idx];
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(67,97,238,0.2); border-color: #4361ee;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectCareerStage('\${opt.value}', this)"\`}
                            class="career-stage-btn group relative overflow-hidden rounded-xl p-4 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute inset-0 bg-stripes opacity-20"></div>
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#4361ee' : '#fff'}">\${opt.label}</span>
                                \${isSelected ? '<span style="color: #4361ee" class="text-lg">✓</span>' : ''}
                            </div>
                            <div class="text-xs mb-3" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                            
                            <!-- 프로그레스 바 -->
                            <div class="h-1.5 rounded-full overflow-hidden" style="background-color: rgba(42,42,62,0.3)">
                                <div class="h-full rounded-full transition-all duration-500" 
                                     style="width: \${progressWidth}%; background-color: \${isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? '#4361ee' : 'rgba(148,163,184,0.5)'}"></div>
                            </div>
                        </div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                🔒 \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
            
            // 선택값 초기화 (비활성화된 경우)
            if (disabledValues.includes(careerState.career_stage_years)) {
                careerState.career_stage_years = null;
            }
        }
        
        function selectCareerStage(value, btnEl) {
            careerState.career_stage_years = value;
            updateCareerStageOptions();
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // 축 3: 현재 목표 (다크 테마 칩 스타일)
        function updateTransitionStatusOptions() {
            const container = document.getElementById('transition-status-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { transition_status: [], reasons: {} };
            const disabledValues = rules.transition_status || [];
            const reason = rules.reasons?.transition_status || '현재 상태에서 선택할 수 없어요';
            
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = careerState.transition_status ? [careerState.transition_status] : [];
            }
            
            // 비활성화된 값 제거
            careerState.transition_status = careerState.transition_status.filter(v => !disabledValues.includes(v));
            
            container.innerHTML = TRANSITION_STATUS_OPTIONS.map(opt => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.transition_status.includes(opt.value);
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(16,185,129,0.2); border-color: #10b981;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="toggleTransitionStatus('\${opt.value}', this)"\`}
                            class="goal-chip group relative rounded-xl p-4 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : isSelected ? 'shadow-lg transform scale-[1.02]' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : isSelected ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <div class="text-2xl mb-2 \${isDisabled ? 'grayscale opacity-50' : ''}">\${opt.emoji}</div>
                        <div class="font-semibold text-sm" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#34d399' : '#fff'}">\${opt.label}</div>
                        <div class="text-xs mt-1" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? 'rgba(110,231,183,0.8)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                🔒 \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function toggleTransitionStatus(value, btnEl) {
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            
            const idx = careerState.transition_status.indexOf(value);
            if (idx === -1) {
                careerState.transition_status.push(value);
            } else {
                careerState.transition_status.splice(idx, 1);
            }
            
            updateTransitionStatusOptions();
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // 축 4: 숙련도 (다크 테마 레벨 게이지)
        function updateSkillLevelOptions() {
            const container = document.getElementById('skill-level-options');
            if (!container) return;
            
            const role = careerState.role_identity;
            const rules = role && ROLE_DISABLED_RULES[role] ? ROLE_DISABLED_RULES[role] : { skill_level: [], reasons: {} };
            const disabledValues = rules.skill_level || [];
            const reason = rules.reasons?.skill_level || '현재 상태에서 선택할 수 없어요';
            
            // 비활성화된 값 초기화
            if (disabledValues.includes(careerState.skill_level)) {
                careerState.skill_level = null;
            }
            
            container.innerHTML = SKILL_LEVEL_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.skill_level === opt.value;
                const levelBars = idx + 1;
                
                const bgStyle = isDisabled 
                    ? 'background-color: rgba(15,15,35,0.5);' 
                    : isSelected 
                        ? 'background-color: rgba(139,92,246,0.2); border-color: #8b5cf6;' 
                        : 'background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);';
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectSkillLevel(\${opt.value}, this)"\`}
                            class="skill-btn group relative rounded-xl p-3 border transition-all duration-300 \${isDisabled ? 'cursor-not-allowed opacity-40' : isSelected ? 'shadow-lg' : ''}"
                            style="\${bgStyle}"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-3.5 h-3.5 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        
                        <!-- 레벨 바 -->
                        <div class="flex gap-1 mb-2 justify-center">
                            \${[1,2,3,4,5].map(i => \`
                                <div class="w-3 h-6 rounded-sm transition-all duration-300" 
                                     style="background-color: \${i <= levelBars 
                                        ? isDisabled ? 'rgba(148,163,184,0.3)' : isSelected ? '#8b5cf6' : 'rgba(148,163,184,0.5)'
                                        : 'rgba(42,42,62,0.3)'}"></div>
                            \`).join('')}
                        </div>
                        
                        <div class="font-semibold text-sm" style="color: \${isDisabled ? 'rgba(148,163,184,0.5)' : isSelected ? '#a78bfa' : '#fff'}">\${opt.label}</div>
                        <div class="text-xs mt-0.5" style="color: \${isDisabled ? 'rgba(148,163,184,0.3)' : 'rgb(148,163,184)'}">\${opt.description}</div>
                        
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/95 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-slate-700">
                                🔒 \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function selectSkillLevel(value, btnEl) {
            careerState.skill_level = value;
            updateSkillLevelOptions();
            checkStep1Completion();
        }
        
        function selectAxis(axis, value, btnEl) {
            careerState[axis] = value;
            const container = btnEl.parentElement;
            container.querySelectorAll('.axis-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            });
            btnEl.classList.add('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            updateSelectedStageFromCareerState();
            checkStep1Completion();
        }
        
        // ============================================
        // 축 5: 제약 조건 (다크 테마 아코디언 카드)
        // ============================================
        let noConstraintSelected = false;
        
        function renderConstraintOptions() {
            const container = document.getElementById('constraint-options');
            if (!container) return;
            
            container.innerHTML = \`
                <!-- 제약 없음 카드 -->
                <div class="mb-4">
                    <button type="button" onclick="toggleNoConstraint(this)" id="no-constraint-btn"
                            class="w-full p-4 rounded-xl border border-dashed hover:border-emerald-500/50 transition-all duration-300 group"
                            style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.5);">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" style="background-color: rgba(16,185,129,0.2);">
                                ✅
                            </div>
                            <div class="text-left flex-1">
                                <div class="font-semibold text-white">제약 없음</div>
                                <div class="text-sm" style="color: rgb(148,163,184)">특별한 제약 조건 없이 모든 옵션을 고려해요</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center no-constraint-check opacity-0 transition-opacity" style="border-color: rgba(42,42,62,0.5);">
                                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </button>
                </div>
                
                <!-- 구분선 -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                    <span class="text-xs font-medium" style="color: rgb(148,163,184)">또는 제약 조건 선택</span>
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                </div>
                
                <!-- 제약 조건 카드들 -->
                <div id="constraint-list" class="grid gap-3 transition-all duration-300">
                    \${CONSTRAINT_OPTIONS.map(opt => \`
                        <div class="constraint-card rounded-xl border overflow-hidden transition-all duration-300" 
                             style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.9);"
                             data-type="\${opt.type}">
                            
                            <!-- 헤더 (클릭 영역) -->
                            <button type="button" onclick="toggleConstraint('\${opt.type}', this)"
                                    class="constraint-header w-full p-4 flex items-center gap-4 text-left transition-colors"
                                    onmouseover="this.style.backgroundColor='rgba(26,26,46,1)';"
                                    onmouseout="this.style.backgroundColor='transparent';">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl flex-shrink-0" style="background-color: rgba(245,158,11,0.2);">
                                    \${opt.emoji}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-white">\${opt.label}</div>
                                    <div class="text-sm truncate" style="color: rgb(148,163,184)">\${opt.description}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="constraint-badge hidden px-2 py-1 text-amber-400 text-xs font-medium rounded-full" style="background-color: rgba(245,158,11,0.2);">
                                        선택됨
                                    </div>
                                    <svg class="constraint-chevron w-5 h-5 transition-transform duration-300" style="color: rgb(148,163,184)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </button>
                            
                            <!-- 상세 내용 (펼침) -->
                            <div class="constraint-detail hidden border-t" style="border-color: rgba(42,42,62,0.3); background-color: rgba(15,15,35,0.5);">
                                <div class="p-4 space-y-4">
                                    <!-- 빠른 선택 태그 -->
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">구체적인 상황 (선택)</label>
                                        <div class="flex flex-wrap gap-2">
                                            \${opt.details.map(d => \`
                                                <button type="button" onclick="selectConstraintDetail('\${opt.type}', '\${d.value}', this)"
                                                        class="detail-tag px-3 py-1.5 text-sm rounded-full border"
                                                        data-value="\${d.value}">
                                                    \${d.label}
                                                </button>
                                            \`).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- 상세 설명 입력 -->
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">추가 설명 (선택)</label>
                                        <div class="relative">
                                            <textarea class="constraint-textarea w-full px-4 py-3 text-sm border rounded-lg transition-all resize-none"
                                                      style="border-color: rgba(42,42,62,0.5); background-color: rgba(15,15,35,1); color: #fff;"
                                                      rows="2"
                                                      placeholder="\${opt.placeholder}"
                                                      onfocus="this.style.borderColor='rgba(245,158,11,0.5)';"
                                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)';"
                                                      onchange="updateConstraintCustomDetail('\${opt.type}', this.value)"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }
        
        function toggleNoConstraint(btnEl) {
            noConstraintSelected = !noConstraintSelected;
            const checkEl = btnEl.querySelector('.no-constraint-check');
            const constraintList = document.getElementById('constraint-list');
            
            if (noConstraintSelected) {
                // 선택 상태
                btnEl.classList.add('border-solid', 'shadow-lg');
                btnEl.classList.remove('border-dashed');
                btnEl.style.borderColor = '#10b981';
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                checkEl.classList.remove('opacity-0');
                checkEl.classList.add('opacity-100');
                checkEl.style.backgroundColor = '#10b981';
                checkEl.style.borderColor = '#10b981';
                
                // 모든 제약 해제
                careerState.constraints = {};
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.add('opacity-30', 'pointer-events-none');
                    card.querySelector('.constraint-badge')?.classList.add('hidden');
                    card.querySelector('.constraint-detail')?.classList.add('hidden');
                    card.querySelector('.constraint-chevron')?.classList.remove('rotate-180');
                });
                constraintList.classList.add('opacity-50');
            } else {
                // 선택 해제
                btnEl.classList.remove('border-solid', 'shadow-lg');
                btnEl.classList.add('border-dashed');
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                checkEl.classList.remove('opacity-100');
                checkEl.style.backgroundColor = 'transparent';
                checkEl.style.borderColor = 'rgba(42,42,62,0.5)';
                
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                constraintList.classList.remove('opacity-50');
            }
        }
        
        function toggleConstraint(type, btnEl) {
            // "제약 없음" 자동 해제
            if (noConstraintSelected) {
                noConstraintSelected = false;
                const noBtn = document.getElementById('no-constraint-btn');
                const checkEl = noBtn.querySelector('.no-constraint-check');
                noBtn.classList.remove('border-solid', 'shadow-lg');
                noBtn.classList.add('border-dashed');
                noBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noBtn.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                document.getElementById('constraint-list').classList.remove('opacity-50');
            }
            
            const card = btnEl.closest('.constraint-card');
            const badge = card.querySelector('.constraint-badge');
            const detail = card.querySelector('.constraint-detail');
            const chevron = card.querySelector('.constraint-chevron');
            const isSelected = careerState.constraints[type]?.has_constraint;
            
            if (isSelected) {
                // 제약 해제
                delete careerState.constraints[type];
                card.classList.remove('shadow-lg');
                card.style.borderColor = 'rgba(42,42,62,0.5)';
                badge.classList.add('hidden');
                detail.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                
                // 태그 선택 초기화
                detail.querySelectorAll('.detail-tag').forEach(tag => {
                    tag.classList.remove('selected');
                    tag.style.backgroundColor = 'rgba(26,26,46,0.5)';
                    tag.style.borderColor = 'rgba(42,42,62,0.5)';
                    tag.style.color = 'rgb(148,163,184)';
                });
            } else {
                // 제약 선택
                careerState.constraints[type] = { has_constraint: true };
                card.classList.add('shadow-lg');
                card.style.borderColor = '#f59e0b';
                badge.classList.remove('hidden');
                detail.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            }
        }
        
        function selectConstraintDetail(type, value, btnEl) {
            if (!careerState.constraints[type]) return;

            const isCurrentlySelected = btnEl.classList.contains('selected');

            // details 배열 초기화
            if (!careerState.constraints[type].details) {
                careerState.constraints[type].details = [];
            }
            if (!Array.isArray(careerState.constraints[type].details)) {
                careerState.constraints[type].details = careerState.constraints[type].details
                    ? [careerState.constraints[type].details] : [];
            }

            // 토글: 선택/해제
            if (isCurrentlySelected) {
                btnEl.classList.remove('selected');
                careerState.constraints[type].details = careerState.constraints[type].details.filter(v => v !== value);
            } else {
                btnEl.classList.add('selected');
                if (!careerState.constraints[type].details.includes(value)) {
                    careerState.constraints[type].details.push(value);
                }
            }
            
            // 스타일 즉시 적용 (브라우저 리페인트 지연 방지)
            applyDetailTagStyle(btnEl, !isCurrentlySelected);
        }
        
        // 제약조건 세부 버튼 스타일 적용 (requestAnimationFrame으로 즉시 반영)
        function applyDetailTagStyle(btn, isSelected) {
            const styles = isSelected
                ? { bg: 'rgba(245,158,11,0.2)', border: 'rgba(245,158,11,0.5)', color: '#f59e0b' }
                : { bg: 'rgba(26,26,46,0.5)', border: 'rgba(42,42,62,0.5)', color: 'rgb(148,163,184)' };
            
            const applyStyles = () => {
                btn.style.setProperty('background-color', styles.bg, 'important');
                btn.style.setProperty('border-color', styles.border, 'important');
                btn.style.setProperty('color', styles.color, 'important');
            };
            
            applyStyles();
            requestAnimationFrame(applyStyles);
        }
        
        function updateConstraintCustomDetail(type, value) {
            if (!careerState.constraints[type]) return;
            careerState.constraints[type].custom_detail = value;
        }
        
        // 제약조건 세부사항 복원 함수
        function restoreConstraintDetails() {
            if (!careerState.constraints) return;
            
            for (const [type, constraint] of Object.entries(careerState.constraints)) {
                const card = document.querySelector(\`.constraint-card[data-type="\${type}"]\`);
                if (card && constraint.has_constraint) {
                    const detail = card.querySelector('.constraint-detail');
                    const chevron = card.querySelector('.constraint-chevron');
                    const badge = card.querySelector('.constraint-badge');
                    
                    // 카드 선택 상태 표시
                    card.style.borderColor = 'rgba(245,158,11,0.5)';
                    card.style.backgroundColor = 'rgba(245,158,11,0.05)';
                    
                    if (badge) badge.classList.remove('hidden');
                    if (detail && chevron) {
                        detail.classList.remove('hidden');
                        chevron.classList.add('rotate-180');
                    }
                    
                    // 세부사항 버튼 선택 상태 복원
                    if (constraint.details && Array.isArray(constraint.details)) {
                        for (const value of constraint.details) {
                            const btn = card.querySelector(\`.detail-tag[data-value="\${value}"]\`);
                            if (btn && !btn.classList.contains('selected')) {
                                btn.classList.add('selected');
                                applyDetailTagStyle(btn, true);
                            }
                        }
                    }
                    
                    // 추가 설명 복원
                    if (constraint.custom_detail) {
                        const textarea = card.querySelector('.constraint-textarea');
                        if (textarea) textarea.value = constraint.custom_detail;
                    }
                }
            }
        }
        
        function updateSelectedStageFromCareerState() {
            // 기존 로직과 호환성을 위해 careerState를 기반으로 selectedStage 설정
            const { role_identity, career_stage_years, transition_status } = careerState;
            
            if (role_identity === 'student') {
                selectedStage = 'job_student';
            } else if (transition_status === 'changer' || transition_status === 'returner') {
                selectedStage = 'job_transition';
            } else if (transition_status === 'second_career') {
                selectedStage = 'job_second';
            } else if (career_stage_years === 'none') {
                selectedStage = 'job_explore';
            } else if (career_stage_years === '0_3') {
                selectedStage = 'job_early';
            } else {
                selectedStage = 'job_mid';
            }
        }
        
        function checkStep1Completion() {
            const { role_identity, career_stage_years, transition_status, skill_level } = careerState;
            
            // 5축 상태 확인
            const stateComplete = role_identity && career_stage_years && transition_status && skill_level !== null;
            
            // 통합 질문 확인 (필수: 관심분야, 가치, 업무스타일)
            const hasInterest = integratedAnswers.univ_interest && integratedAnswers.univ_interest.length > 0;
            const hasPriority = integratedAnswers.univ_priority && 
                (Array.isArray(integratedAnswers.univ_priority) ? integratedAnswers.univ_priority.length > 0 : !!integratedAnswers.univ_priority);
            const hasWorkstyle = !!integratedAnswers.univ_workstyle_social;
            
            const questionsComplete = hasInterest && hasPriority && hasWorkstyle;
            const isComplete = stateComplete && questionsComplete;
            
            const nextBtn = document.getElementById('step1-next-btn');
            if (nextBtn) {
                nextBtn.disabled = !isComplete;
                if (isComplete) {
                    nextBtn.classList.add('hover-glow');
                } else {
                    nextBtn.classList.remove('hover-glow');
                }
            }
        }
        
        // validateStep1은 checkStep1Completion의 별칭
        function validateStep1() {
            checkStep1Completion();
        }
        
        // 기존 함수 (하위 호환성)
        function renderStageOptions() {
            renderCareerStateForm();
        }
        
        function selectStage(stageId) {
            selectedStage = stageId;
        }
        
        // ============================================
        // 통합 질문 데이터 (기존 미니모듈 토큰 매핑 유지)
        // ============================================
        const TOKEN_MAPPING = {
            // interest 매핑
            problem_solving: 'problem_solving',
            creating: 'creating',
            helping: 'helping_teaching',
            data: 'data_numbers',
            tech: 'tech',
            organizing: 'organizing',
            influencing: 'influencing',
            nature: 'nature',
            health: 'health',
            media: 'media',
            // value 매핑
            autonomy: 'autonomy',
            growth: 'growth',
            stability: 'stability',
            income: 'income',
            meaning: 'meaning',
            recognition: 'recognition',
            wlb: 'wlb',
            // strength 매핑
            analytical: 'analytical',
            creative: 'creative',
            communication: 'communication',
            structured_execution: 'structured_execution',
            persistence: 'persistence',
            fast_learning: 'fast_learning',
            empathy: 'empathy',
            leadership: 'leadership',
        };
        
        // 통합 질문 결과 저장 (기존 미니모듈과 호환)
        window.miniModuleResult = null;
        let integratedAnswers = {};
        
        // 통합 질문 렌더링 함수
        // 학생용 질문 텍스트 변환 매핑
        const studentQuestionTexts = {
            'univ_priority': '나중에 일을 하게 된다면 가장 중요하게 생각하는 건 뭔가요?',
            'univ_workstyle_social': '무언가를 할 때 어떤 방식이 더 편한가요?',
            'mm_sacrifice': '꿈을 위해 감수할 수 있는 것은?',
            'mm_energy_drain': '어떨 때 가장 빨리 지치나요?',
            'mm_achievement': '잘하고 있다는 느낌은 언제 드나요?',
            'mm_execution': '새로운 것을 시작할 때 나는?',
            'mm_failure': '일이나 공부가 잘 안 됐을 때, 나는 보통 어떤 반응에 가깝나요?',
            'mm_anchor': '힘들어도 계속할 수 있게 해주는 건?',
        };
        
        function renderIntegratedQuestions() {
            const container = document.getElementById('integrated-questions-container');
            if (!container) return;
            
            const questions = JSON.parse('${universalQuestionsJson}');
            
            // 학생 여부 확인
            const isStudent = careerState.role_identity === 'student';
            
            container.innerHTML = questions.map((q, idx) => {
                const isRequired = q.required;
                const maxSel = q.max_selections || 3;
                
                // 학생용 질문 텍스트 적용
                const questionText = isStudent && studentQuestionTexts[q.id] 
                    ? studentQuestionTexts[q.id] 
                    : q.text;
                
                return \`
                    <div class="integrated-question mb-6 p-5 rounded-xl" 
                         style="background: linear-gradient(135deg, rgba(99,102,241,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(99,102,241,0.2);"
                         data-question-id="\${q.id}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-6 h-6 bg-wiki-primary/30 text-wiki-primary rounded-full flex items-center justify-center text-xs font-bold">\${idx + 1}</span>
                            <h4 class="font-semibold text-white">\${questionText}</h4>
                            \${isRequired ? '<span class="text-red-400 text-xs">*필수</span>' : ''}
                        </div>
                        \${q.help_text ? \`<p class="text-xs text-emerald-400 mb-3 ml-8">\${q.help_text}</p>\` : ''}
                        \${q.ui_type === 'chips' ? \`
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" 
                                            onclick="toggleIntegratedChip('\${q.id}', '\${opt.value}', this, \${maxSel})"
                                            class="int-chip px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}"
                                            data-token="\${opt.token || opt.value}">
                                        <span class="mr-1">\${opt.emoji || ''}</span>\${opt.label}
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" 
                                            onclick="toggleIntegratedChip('\${q.id}', 'unknown', this, \${maxSel})"
                                            class="int-chip px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="unknown">
                                        <span class="mr-1">❓</span>\${q.unknown_label || '모르겠어요'}
                                    </button>
                                \` : ''}
                                \${q.allow_other ? \`
                                    <button type="button" 
                                            onclick="showIntegratedOtherInput('\${q.id}', this)"
                                            class="int-chip int-other-btn px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="other">
                                        <span class="mr-1">✏️</span>\${q.other_label || '기타'}
                                    </button>
                                \` : ''}
                            </div>
                            \${q.allow_other ? \`
                            <div id="\${q.id}-other-input" class="hidden mt-3">
                                <input type="text" 
                                       id="\${q.id}-other-text"
                                       placeholder="직접 입력해주세요" 
                                       class="w-full px-3 py-2 rounded-lg border text-sm"
                                       style="background: rgba(15,15,35,0.8); border-color: rgba(99,102,241,0.5); color: white;"
                                       onkeyup="updateIntegratedOtherValue('\${q.id}')"
                                       maxlength="50">
                            </div>
                            \` : ''}
                            <p class="text-xs text-wiki-muted mt-2">최대 \${maxSel}개 선택</p>
                        \` : q.ui_type === 'radio' ? \`
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" 
                                            onclick="selectIntegratedRadio('\${q.id}', '\${opt.value}', this)"
                                            class="int-radio px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <span class="mr-1">\${opt.emoji || ''}</span>\${opt.label}
                                    </button>
                                \`).join('')}
                                \${q.allow_other ? \`
                                    <button type="button" 
                                            onclick="showIntegratedOtherInput('\${q.id}', this, true)"
                                            class="int-radio int-other-btn px-3 py-2 rounded-lg border transition-all text-sm"
                                            style="background: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                            data-value="other">
                                        <span class="mr-1">✏️</span>\${q.other_label || '기타'}
                                    </button>
                                \` : ''}
                            </div>
                            \${q.allow_other ? \`
                            <div id="\${q.id}-other-input" class="hidden mt-3">
                                <input type="text" 
                                       id="\${q.id}-other-text"
                                       placeholder="직접 입력해주세요" 
                                       class="w-full px-3 py-2 rounded-lg border text-sm"
                                       style="background: rgba(15,15,35,0.8); border-color: rgba(99,102,241,0.5); color: white;"
                                       onkeyup="updateIntegratedOtherValue('\${q.id}', true)"
                                       maxlength="50">
                            </div>
                            \` : ''}
                        \` : q.ui_type === 'language_chips' ? \`
                            <div class="language-selector-integrated" data-question-id="\${q.id}">
                                <!-- 주요 언어 버튼들 -->
                                <div class="flex flex-wrap gap-2 mb-3">
                                    \${q.options.map(opt => \`
                                        <button type="button" 
                                                onclick="toggleIntegratedLanguage('\${q.id}', '\${opt.value}', '\${opt.label}', this)"
                                                class="int-lang-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                                data-value="\${opt.value}">
                                            <span class="flex items-center gap-2">
                                                <span class="text-lg">\${opt.emoji || ''}</span>
                                                <span style="color: rgb(148,163,184);">\${opt.label}</span>
                                            </span>
                                            <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden lang-check">✓</div>
                                        </button>
                                    \`).join('')}
                                    \${q.allow_unknown ? \`
                                        <button type="button" 
                                                onclick="toggleIntegratedLanguageNone('\${q.id}', this)"
                                                class="int-lang-chip int-lang-none px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                                data-value="none">
                                            <span class="flex items-center gap-2">
                                                <span class="text-lg">❌</span>
                                                <span style="color: rgb(148,163,184);">\${q.unknown_label || '없어요'}</span>
                                            </span>
                                        </button>
                                    \` : ''}
                                    <button type="button" 
                                            onclick="showIntegratedOtherLanguages('\${q.id}')"
                                            class="int-lang-other-btn px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">🌐</span>
                                            <span style="color: rgb(148,163,184);">기타 언어</span>
                                        </span>
                                    </button>
                                </div>
                                
                                <!-- 수준 선택 패널 -->
                                <div id="\${q.id}-level-panel" class="hidden mt-3 p-4 rounded-xl animate-fadeIn" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                                    <p class="text-sm mb-3" style="color: rgb(148,163,184);">
                                        <span id="\${q.id}-level-label" class="font-semibold text-white">영어</span> 수준을 선택해주세요:
                                    </p>
                                    <div class="flex flex-wrap gap-3">
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'basic')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="basic">
                                            <span class="text-lg">💬</span>
                                            <span style="color: rgb(148,163,184);">일상회화</span>
                                        </button>
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'business')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="business">
                                            <span class="text-lg">💼</span>
                                            <span style="color: rgb(148,163,184);">업무가능</span>
                                        </button>
                                        <button type="button" onclick="selectIntegratedLanguageLevel('\${q.id}', 'native')" 
                                                class="int-level-btn flex items-center gap-2 px-4 py-2.5 rounded-xl border transition-all duration-200"
                                                style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);" data-level="native">
                                            <span class="text-lg">🏆</span>
                                            <span style="color: rgb(148,163,184);">원어민급</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 기타 언어 선택 패널 -->
                                <div id="\${q.id}-other-panel" class="hidden mt-3 p-4 rounded-xl animate-fadeIn" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.3);">
                                    <p class="text-sm mb-3" style="color: rgb(148,163,184);">어떤 언어인가요?</p>
                                    <div class="flex flex-wrap gap-2">
                                        \${(q.other_languages || []).map(lang => \`
                                            <button type="button" onclick="selectIntegratedOtherLanguage('\${q.id}', '\${lang.value}', '\${lang.label}')"
                                                    class="int-other-lang-btn px-3 py-2 rounded-lg border transition-all duration-200 text-sm"
                                                    style="background: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);">
                                                \${lang.label}
                                            </button>
                                        \`).join('')}
                                    </div>
                                </div>
                                
                                <!-- 선택된 언어 표시 -->
                                <div id="\${q.id}-selected" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>
                        \` : ''}
                    </div>
                \`;
            }).join('');
            
            // 기존 선택 답변 복원
            restoreIntegratedAnswers();
        }
        
        // 기존 통합 질문 답변 복원 함수
        function restoreIntegratedAnswers() {
            if (!integratedAnswers || Object.keys(integratedAnswers).length === 0) return;
            
            console.log('[restoreIntegratedAnswers] Restoring:', integratedAnswers);
            
            Object.keys(integratedAnswers).forEach(questionId => {
                const value = integratedAnswers[questionId];
                if (!value) return;
                
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) return;
                
                // 배열인 경우 (chips)
                if (Array.isArray(value)) {
                    value.forEach(v => {
                        const btn = container.querySelector(\`[data-value="\${v}"]\`);
                        if (btn && !btn.classList.contains('selected')) {
                            btn.classList.add('selected');
                            btn.style.background = 'linear-gradient(135deg, rgba(67,97,238,0.3), rgba(168,85,247,0.2))';
                            btn.style.borderColor = 'rgba(67,97,238,0.5)';
                        }
                    });
                } 
                // 문자열인 경우 (radio)
                else if (typeof value === 'string') {
                    const btn = container.querySelector(\`[data-value="\${value}"]\`);
                    if (btn && !btn.classList.contains('selected')) {
                        btn.classList.add('selected');
                        btn.style.background = 'linear-gradient(135deg, rgba(67,97,238,0.3), rgba(168,85,247,0.2))';
                        btn.style.borderColor = 'rgba(67,97,238,0.5)';
                    }
                }
            });
        }
        
        function toggleIntegratedChip(questionId, value, btn, maxSel) {
            if (!integratedAnswers[questionId]) {
                integratedAnswers[questionId] = [];
            }
            
            const arr = integratedAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx >= 0) {
                // 선택 해제
                arr.splice(idx, 1);
                btn.style.background = 'rgba(26,26,46,0.7)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.classList.remove('selected');
            } else {
                // 선택 추가
                if (arr.length >= maxSel) {
                    // 가장 오래된 선택 제거
                    const oldValue = arr.shift();
                    const container = btn.closest('.integrated-question');
                    const oldBtn = container.querySelector(\`[data-value="\${oldValue}"]\`);
                    if (oldBtn) {
                        oldBtn.style.background = 'rgba(26,26,46,0.7)';
                        oldBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        oldBtn.classList.remove('selected');
                    }
                }
                arr.push(value);
                btn.style.background = 'rgba(99,102,241,0.2)';
                btn.style.borderColor = 'rgba(99,102,241,0.5)';
                btn.classList.add('selected');
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function selectIntegratedRadio(questionId, value, btn) {
            // 같은 질문의 다른 라디오 버튼 해제
            const container = btn.closest('.integrated-question');
            container.querySelectorAll('.int-radio').forEach(b => {
                b.style.background = 'rgba(26,26,46,0.7)';
                b.style.borderColor = 'rgba(42,42,62,0.5)';
                b.classList.remove('selected');
            });
            
            // 선택
            btn.style.background = 'rgba(99,102,241,0.2)';
            btn.style.borderColor = 'rgba(99,102,241,0.5)';
            btn.classList.add('selected');
            
            integratedAnswers[questionId] = value;
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // 통합 질문 언어 선택 (수준 선택 포함)
        let integratedLanguageSelection = {};  // { questionId: { lang: { level, label } } }
        let currentIntegratedLangQuestion = null;
        let currentIntegratedLangValue = null;
        let currentIntegratedLangLabel = null;
        
        function toggleIntegratedLanguage(questionId, langValue, langLabel, btn) {
            if (!integratedLanguageSelection[questionId]) {
                integratedLanguageSelection[questionId] = {};
            }
            
            const langData = integratedLanguageSelection[questionId];
            
            // '없어요' 선택 해제
            const noneBtn = btn.closest('.language-selector-integrated')?.querySelector('.int-lang-none');
            if (noneBtn) {
                noneBtn.style.background = 'rgba(26,26,46,0.9)';
                noneBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noneBtn.classList.remove('selected');
            }
            integratedAnswers[questionId + '_none'] = false;
            
            if (langData[langValue]) {
                // 이미 선택된 언어 → 선택 해제
                delete langData[langValue];
                btn.style.background = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.lang-check')?.classList.add('hidden');
                
                // 패널 숨기기
                document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
                document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            } else {
                // 새 언어 선택 → 수준 선택 UI 표시
                currentIntegratedLangQuestion = questionId;
                currentIntegratedLangValue = langValue;
                currentIntegratedLangLabel = langLabel;
                
                // 라벨 업데이트
                const labelEl = document.getElementById(questionId + '-level-label');
                if (labelEl) labelEl.textContent = langLabel;
                
                // 기타 패널 숨기고 수준 패널 표시
                document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
                const levelPanel = document.getElementById(questionId + '-level-panel');
                if (levelPanel) {
                    levelPanel.classList.remove('hidden');
                    levelPanel.querySelectorAll('.int-level-btn').forEach(b => {
                        b.style.background = 'rgba(26,26,46,0.9)';
                        b.style.borderColor = 'rgba(42,42,62,0.5)';
                    });
                }
            }
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
        }
        
        function toggleIntegratedLanguageNone(questionId, btn) {
            const container = btn.closest('.language-selector-integrated');
            
            // 모든 언어 선택 해제
            integratedLanguageSelection[questionId] = {};
            container?.querySelectorAll('.int-lang-chip').forEach(b => {
                b.style.background = 'rgba(26,26,46,0.9)';
                b.style.borderColor = 'rgba(42,42,62,0.5)';
                b.querySelector('.lang-check')?.classList.add('hidden');
            });
            
            // '없어요' 버튼 선택
            btn.style.background = 'rgba(239,68,68,0.2)';
            btn.style.borderColor = 'rgba(239,68,68,0.5)';
            btn.classList.add('selected');
            
            // 패널 숨기기
            document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            
            integratedAnswers[questionId] = ['none'];
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function showIntegratedOtherLanguages(questionId) {
            // 수준 패널 숨기기
            document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            // 기타 언어 패널 표시
            const otherPanel = document.getElementById(questionId + '-other-panel');
            if (otherPanel) {
                otherPanel.classList.toggle('hidden');
            }
        }
        
        function selectIntegratedOtherLanguage(questionId, langValue, langLabel) {
            currentIntegratedLangQuestion = questionId;
            currentIntegratedLangValue = langValue;
            currentIntegratedLangLabel = langLabel;
            
            // 라벨 업데이트
            const labelEl = document.getElementById(questionId + '-level-label');
            if (labelEl) labelEl.textContent = langLabel;
            
            // 기타 패널 숨기고 수준 패널 표시
            document.getElementById(questionId + '-other-panel')?.classList.add('hidden');
            const levelPanel = document.getElementById(questionId + '-level-panel');
            if (levelPanel) {
                levelPanel.classList.remove('hidden');
                levelPanel.querySelectorAll('.int-level-btn').forEach(b => {
                    b.style.background = 'rgba(26,26,46,0.9)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                });
            }
        }
        
        function selectIntegratedLanguageLevel(questionId, level) {
            if (!currentIntegratedLangValue) return;
            
            const langValue = currentIntegratedLangValue;
            const langLabel = currentIntegratedLangLabel;
            
            if (!integratedLanguageSelection[questionId]) {
                integratedLanguageSelection[questionId] = {};
            }
            
            // '없어요' 선택 해제
            const container = document.querySelector(\`.language-selector-integrated[data-question-id="\${questionId}"]\`);
            const noneBtn = container?.querySelector('.int-lang-none');
            if (noneBtn) {
                noneBtn.style.background = 'rgba(26,26,46,0.9)';
                noneBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noneBtn.classList.remove('selected');
            }
            
            // 언어에 수준 설정
            integratedLanguageSelection[questionId][langValue] = { level, label: langLabel };
            
            // 버튼 스타일 업데이트 (주요 언어인 경우)
            const langBtn = container?.querySelector(\`.int-lang-chip[data-value="\${langValue}"]\`);
            if (langBtn) {
                langBtn.style.background = 'rgba(99,102,241,0.2)';
                langBtn.style.borderColor = 'rgba(99,102,241,0.5)';
                langBtn.querySelector('.lang-check')?.classList.remove('hidden');
            }
            
            // 수준 버튼 강조
            const levelPanel = document.getElementById(questionId + '-level-panel');
            levelPanel?.querySelectorAll('.int-level-btn').forEach(b => {
                if (b.dataset.level === level) {
                    b.style.background = 'rgba(99,102,241,0.2)';
                    b.style.borderColor = 'rgba(99,102,241,0.5)';
                } else {
                    b.style.background = 'rgba(26,26,46,0.9)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                }
            });
            
            // 잠시 후 패널 숨기기
            setTimeout(() => {
                document.getElementById(questionId + '-level-panel')?.classList.add('hidden');
            }, 300);
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
            currentIntegratedLangValue = null;
            currentIntegratedLangLabel = null;
        }
        
        function updateIntegratedLanguageDisplay(questionId) {
            const selectedContainer = document.getElementById(questionId + '-selected');
            if (!selectedContainer) return;
            
            const langData = integratedLanguageSelection[questionId] || {};
            const levelLabels = { basic: '일상회화', business: '업무가능', native: '원어민급' };
            
            selectedContainer.innerHTML = Object.entries(langData).map(([lang, data]) => \`
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm" 
                     style="background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3);">
                    <span class="text-white font-medium">\${data.label || lang}</span>
                    <span style="color: rgb(148,163,184);">·</span>
                    <span style="color: rgb(129,140,248);">\${levelLabels[data.level] || data.level}</span>
                    <button type="button" onclick="removeIntegratedLanguage('\${questionId}', '\${lang}')" 
                            class="ml-1 text-red-400 hover:text-red-300">×</button>
                </div>
            \`).join('');
        }
        
        function removeIntegratedLanguage(questionId, langValue) {
            if (integratedLanguageSelection[questionId]) {
                delete integratedLanguageSelection[questionId][langValue];
            }
            
            // 버튼 스타일 복원
            const container = document.querySelector(\`.language-selector-integrated[data-question-id="\${questionId}"]\`);
            const langBtn = container?.querySelector(\`.int-lang-chip[data-value="\${langValue}"]\`);
            if (langBtn) {
                langBtn.style.background = 'rgba(26,26,46,0.9)';
                langBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                langBtn.querySelector('.lang-check')?.classList.add('hidden');
            }
            
            updateIntegratedLanguageDisplay(questionId);
            updateIntegratedLanguageAnswers(questionId);
        }
        
        function updateIntegratedLanguageAnswers(questionId) {
            const langData = integratedLanguageSelection[questionId] || {};
            const values = Object.entries(langData).map(([lang, data]) => \`\${lang}_\${data.level}\`);
            
            if (values.length > 0) {
                integratedAnswers[questionId] = values;
            } else {
                delete integratedAnswers[questionId];
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // 통합 질문 '기타' 입력 처리
        let integratedOtherValues = {};  // { questionId: '기타 입력값' }
        
        function showIntegratedOtherInput(questionId, btn, isRadio = false) {
            const container = btn.closest('.integrated-question');
            const inputDiv = document.getElementById(questionId + '-other-input');
            const textInput = document.getElementById(questionId + '-other-text');
            
            if (isRadio) {
                // radio: 기존 선택 해제
                container.querySelectorAll('.int-radio').forEach(b => {
                    b.style.background = 'rgba(26,26,46,0.7)';
                    b.style.borderColor = 'rgba(42,42,62,0.5)';
                    b.classList.remove('selected');
                });
            }
            
            // 버튼 선택 표시
            btn.style.background = 'rgba(99,102,241,0.2)';
            btn.style.borderColor = 'rgba(99,102,241,0.5)';
            btn.classList.add('selected');
            
            // 입력 필드 표시
            if (inputDiv) {
                inputDiv.classList.remove('hidden');
                textInput?.focus();
            }
            
            // 기존 값 있으면 설정
            if (isRadio) {
                integratedAnswers[questionId] = integratedOtherValues[questionId] 
                    ? 'other:' + integratedOtherValues[questionId] 
                    : 'other';
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        function updateIntegratedOtherValue(questionId, isRadio = false) {
            const textInput = document.getElementById(questionId + '-other-text');
            const value = textInput?.value?.trim() || '';
            
            integratedOtherValues[questionId] = value;
            
            if (isRadio) {
                // radio: 기타값으로 설정
                integratedAnswers[questionId] = value ? 'other:' + value : 'other';
            } else {
                // chips: 기존 배열에 기타값 추가/갱신
                if (!integratedAnswers[questionId]) {
                    integratedAnswers[questionId] = [];
                }
                // 기존 other: 값 제거
                integratedAnswers[questionId] = integratedAnswers[questionId].filter(v => !v.startsWith('other:') && v !== 'other');
                if (value) {
                    integratedAnswers[questionId].push('other:' + value);
                }
            }
            
            updateIntegratedUniversalAnswers();
            validateStep1();
        }
        
        // 통합 질문 답변을 universalAnswers와 miniModuleResult에 반영
        function updateIntegratedUniversalAnswers() {
            // universalAnswers에 반영
            for (const [key, value] of Object.entries(integratedAnswers)) {
                universalAnswers[key] = value;
            }
            
            // miniModuleResult 계산 (LLM 앵커용)
            const interest_top = (integratedAnswers.univ_interest || [])
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            const value_top = (Array.isArray(integratedAnswers.univ_priority) 
                ? integratedAnswers.univ_priority 
                : [integratedAnswers.univ_priority])
                .filter(Boolean)
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            const strength_top = (integratedAnswers.univ_strength || [])
                .slice(0, 2)
                .map(v => TOKEN_MAPPING[v] || v);
            
            // Step 1의 제약조건에서 constraint_flags 추출
            const constraint_flags = [];
            if (careerState.constraints) {
                for (const [type, data] of Object.entries(careerState.constraints)) {
                    if (data.has_constraint) {
                        constraint_flags.push(type + '_constraint');
                    }
                }
            }
            
            window.miniModuleResult = {
                interest_top,
                value_top,
                strength_top,
                constraint_flags,
                raw_selections: {
                    interest: integratedAnswers.univ_interest || [],
                    value: Array.isArray(integratedAnswers.univ_priority) 
                        ? integratedAnswers.univ_priority 
                        : [integratedAnswers.univ_priority].filter(Boolean),
                    strength: integratedAnswers.univ_strength || [],
                    constraint: constraint_flags,
                }
            };
            
            console.log('[IntegratedQuestions] miniModuleResult updated:', window.miniModuleResult);
        }
        
        // Step 1 → Step 2 (심층 질문) 직접 이동
        async function goToStep2Direct() {
            // 통합 질문 결과 계산
            updateIntegratedUniversalAnswers();
            
            // 저장
            saveDraftToServer();
            
            // Step 2 (심층 질문)로 이동
            goToStep(2);
            
            // V3 모드: 기초 서술형 질문 → 라운드 1,2,3
            if (window.V3_MODE !== false) {
                renderNarrativeStep();
            } else {
                // V2 폴백: 기본 선택형 질문
                await generateFollowupQuestions();
            }
        }
        
        // 심층 질문 생성 함수
        async function generateFollowupQuestions() {
            showLoading('질문 구성 중...', '맞춤 심층 질문을 준비하고 있어요');
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        career_state: careerState,
                        mini_module_result: window.miniModuleResult || null,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                console.log('[generateFollowupQuestions] API response:', data);
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                } else {
                    // 질문이 없으면 기본 질문 표시
                    renderDefaultFollowupQuestions();
                }
            } catch (error) {
                hideLoading();
                console.error('[generateFollowupQuestions] Error:', error);
                // 에러 시 기본 질문 표시
                renderDefaultFollowupQuestions();
            }
        }
        
        // 기본 심층 질문 (API 실패 시 폴백)
        function renderDefaultFollowupQuestions() {
            const defaultQuestions = [
                {
                    id: 'default_work_preference',
                    question: '하루 업무 중 가장 보람을 느끼는 순간은 언제인가요?',
                    fact_key: 'preference.work_satisfaction',
                    options: [
                        { value: 'problem_solved', label: '어려운 문제를 해결했을 때' },
                        { value: 'helped_someone', label: '누군가에게 도움이 됐을 때' },
                        { value: 'learned_new', label: '새로운 것을 배웠을 때' },
                        { value: 'completed_task', label: '일을 깔끔하게 마무리했을 때' },
                        { value: 'recognized', label: '성과를 인정받았을 때' },
                    ]
                },
                {
                    id: 'default_challenge',
                    question: '가장 힘들게 느껴지는 업무 상황은?',
                    fact_key: 'aversion.work_challenge',
                    options: [
                        { value: 'unclear_direction', label: '방향이 불명확할 때' },
                        { value: 'too_many_people', label: '많은 사람과 조율해야 할 때' },
                        { value: 'repetitive', label: '반복적인 일이 계속될 때' },
                        { value: 'tight_deadline', label: '촉박한 마감에 쫓길 때' },
                        { value: 'no_feedback', label: '피드백이 없을 때' },
                    ]
                },
                {
                    id: 'default_growth',
                    question: '앞으로 어떤 방향으로 성장하고 싶으세요?',
                    fact_key: 'goal.growth_direction',
                    options: [
                        { value: 'specialist', label: '한 분야의 전문가가 되고 싶다' },
                        { value: 'generalist', label: '다양한 경험을 쌓고 싶다' },
                        { value: 'leader', label: '팀을 이끄는 리더가 되고 싶다' },
                        { value: 'entrepreneur', label: '나만의 사업을 하고 싶다' },
                        { value: 'balance', label: '일과 삶의 균형을 찾고 싶다' },
                    ]
                }
            ];
            
            renderFollowupQuestions(defaultQuestions);
        }
        
        // ============================================
        // [DEPRECATED] 레거시 미니모듈 함수들
        // 3단계 구조에서는 통합 질문으로 대체됨
        // Draft 복원 및 major 페이지 호환을 위해 유지
        // ============================================
        const MINI_MODULE_DATA = {};  // 빈 객체로 대체
        const MINI_MODULE_ORDER = [];  // 빈 배열로 대체
        let currentMiniModuleIndex = 0;
        let miniModuleSelections = { interest: [], value: [], strength: [], constraint: [] };
        
        function renderMiniModule() {
            // DEPRECATED: 3단계 구조에서는 renderIntegratedQuestions() 사용
            const moduleKey = MINI_MODULE_ORDER[currentMiniModuleIndex];
            const module = MINI_MODULE_DATA[moduleKey];
            const container = document.getElementById('mini-module-container');
            if (!container) return;
            
            // 프로그레스 바 업데이트
            MINI_MODULE_ORDER.forEach((key, idx) => {
                const bar = document.getElementById(\`mm-progress-\${idx + 1}\`);
                if (bar) {
                    if (idx < currentMiniModuleIndex) {
                        bar.className = 'w-16 h-1 rounded-full bg-emerald-500';
                    } else if (idx === currentMiniModuleIndex) {
                        bar.className = 'w-16 h-1 rounded-full bg-amber-500';
                    } else {
                        bar.className = 'w-16 h-1 rounded-full bg-wiki-border/50';
                    }
                }
            });
            
            // 버튼 텍스트 업데이트
            const btnText = document.getElementById('mm-btn-text');
            if (btnText) {
                if (currentMiniModuleIndex === MINI_MODULE_ORDER.length - 1) {
                    btnText.textContent = '완료';
                } else {
                    btnText.textContent = '다음 영역';
                }
            }
            
            const colorMap = {
                amber: { bg: 'rgba(245, 158, 11, 0.1)', border: 'rgba(245, 158, 11, 0.3)', text: 'rgb(252, 211, 77)' },
                emerald: { bg: 'rgba(16, 185, 129, 0.1)', border: 'rgba(16, 185, 129, 0.3)', text: 'rgb(110, 231, 183)' },
                blue: { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', text: 'rgb(147, 197, 253)' },
                red: { bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)', text: 'rgb(252, 165, 165)' },
            };
            const colors = colorMap[module.color] || colorMap.amber;
            
            // 제약 모듈은 선택 제한 없음, 나머지는 2개
            const isConstraint = moduleKey === 'constraint';
            const selectionLimit = isConstraint ? 6 : 2;
            const selectionHint = isConstraint ? '해당하는 것을 모두 선택해주세요 (없으면 건너뛰기 가능)' : '가장 끌리는 것 2개를 선택해주세요';
            
            container.innerHTML = \`
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-3" style="background: \${colors.bg}; border: 2px solid \${colors.border};">
                        <span class="text-3xl">\${module.emoji}</span>
                    </div>
                    <h3 class="text-lg font-bold text-white">\${module.title}</h3>
                    <p class="text-sm" style="color: \${colors.text};">\${module.subtitle}</p>
                    <p class="text-xs text-wiki-muted mt-1">\${selectionHint}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    \${module.questions.map(q => \`
                        <button type="button" onclick="selectMiniModuleItem('\${moduleKey}', '\${q.token}', this, \${selectionLimit})"
                                class="mm-chip p-4 rounded-xl border-2 transition-all duration-200 text-left group"
                                style="background-color: rgba(26,26,46,0.7); border-color: rgba(42,42,62,0.5);"
                                data-token="\${q.token}">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl group-hover:scale-110 transition-transform">\${q.emoji}</span>
                                <span class="text-white text-sm">\${q.text}</span>
                            </div>
                        </button>
                    \`).join('')}
                </div>
                
                <div class="text-center mt-4">
                    <span id="mm-selection-count" class="text-sm text-wiki-muted">
                        선택: 0\${isConstraint ? '' : '/2'}
                    </span>
                </div>
            \`;
            
            // 이전 선택 복원
            const currentSelections = miniModuleSelections[moduleKey];
            if (currentSelections.length > 0) {
                currentSelections.forEach(token => {
                    const chip = container.querySelector(\`[data-token="\${token}"]\`);
                    if (chip) {
                        chip.style.backgroundColor = colors.bg;
                        chip.style.borderColor = colors.border;
                        chip.classList.add('mm-selected');
                    }
                });
                updateMiniModuleCount(moduleKey);
            }
            
            // 버튼 상태 업데이트
            updateMiniModuleNextButton();
        }
        
        function selectMiniModuleItem(moduleKey, token, btn, limit) {
            const module = MINI_MODULE_DATA[moduleKey];
            const colorMap = {
                amber: { bg: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.5)' },
                emerald: { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.5)' },
                blue: { bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.5)' },
                red: { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.5)' },
            };
            const colors = colorMap[module.color] || colorMap.amber;
            
            const selections = miniModuleSelections[moduleKey];
            const isSelected = selections.includes(token);
            
            if (isSelected) {
                // 선택 해제
                const idx = selections.indexOf(token);
                selections.splice(idx, 1);
                btn.style.backgroundColor = 'rgba(26,26,46,0.7)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.classList.remove('mm-selected');
            } else {
                // 선택 추가 (제한 확인)
                if (selections.length >= limit) {
                    // 제한 초과 시 가장 오래된 선택 제거
                    const oldToken = selections.shift();
                    const oldBtn = document.querySelector(\`[data-token="\${oldToken}"]\`);
                    if (oldBtn) {
                        oldBtn.style.backgroundColor = 'rgba(26,26,46,0.7)';
                        oldBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        oldBtn.classList.remove('mm-selected');
                    }
                }
                selections.push(token);
                btn.style.backgroundColor = colors.bg;
                btn.style.borderColor = colors.border;
                btn.classList.add('mm-selected');
            }
            
            updateMiniModuleCount(moduleKey);
            updateMiniModuleNextButton();
        }
        
        function updateMiniModuleCount(moduleKey) {
            const countEl = document.getElementById('mm-selection-count');
            if (!countEl) return;
            
            const isConstraint = moduleKey === 'constraint';
            const count = miniModuleSelections[moduleKey].length;
            
            if (isConstraint) {
                countEl.textContent = \`선택: \${count}\`;
            } else {
                countEl.textContent = \`선택: \${count}/2\`;
            }
        }
        
        function updateMiniModuleNextButton() {
            const btn = document.getElementById('mm-next-btn');
            if (!btn) return;
            
            const moduleKey = MINI_MODULE_ORDER[currentMiniModuleIndex];
            const isConstraint = moduleKey === 'constraint';
            const count = miniModuleSelections[moduleKey].length;
            
            // 제약 모듈은 0개도 허용, 나머지는 2개 필수
            const isValid = isConstraint ? true : count === 2;
            btn.disabled = !isValid;
        }
        
        // 미니모듈에서 "이전" 버튼 클릭 시 동작
        function goBackMiniModuleOrStep1() {
            if (currentMiniModuleIndex > 0) {
                // 이전 미니모듈로 이동
                currentMiniModuleIndex--;
                renderMiniModule();
            } else {
                // 첫 미니모듈이면 Step 1(상태 단계)로 이동
                goToStep(1);
            }
        }
        
        function nextMiniModule() {
            currentMiniModuleIndex++;
            
            if (currentMiniModuleIndex >= MINI_MODULE_ORDER.length) {
                // 미니모듈 완료 → 결과 계산 후 Step 2로
                finishMiniModule();
            } else {
                // 다음 모듈 렌더링
                renderMiniModule();
            }
        }
        
        function finishMiniModule() {
            // 미니모듈 결과 계산
            const result = calculateMiniModuleResultFromSelections();
            window.miniModuleResult = result;
            
            console.log('[MiniModule] 결과:', result);
            console.log('[MiniModule] 요약:', summarizeMiniModuleResultLocal(result));
            
            // Step 2로 전환
            goToStep2WithLoading();
        }
        
        function calculateMiniModuleResultFromSelections() {
            const getTopN = (selections, n) => {
                // 선택된 순서대로 상위 N개 반환
                return selections.slice(0, n);
            };
            
            const interest_top = getTopN(miniModuleSelections.interest, 2);
            const value_top = getTopN(miniModuleSelections.value, 2);
            const strength_top = getTopN(miniModuleSelections.strength, 2);
            const constraint_flags = [...miniModuleSelections.constraint];
            
            // 내부 충돌 체크
            const conflictPairs = [
                ['autonomy', 'stability', 'autonomy_vs_stability'],
                ['growth', 'income', 'growth_vs_income'],
                ['meaning', 'income', 'meaning_vs_income'],
            ];
            
            const internal_conflict_flags = [];
            for (const [val1, val2, conflictName] of conflictPairs) {
                if (value_top.includes(val1) && value_top.includes(val2)) {
                    internal_conflict_flags.push(conflictName);
                }
            }
            
            return {
                interest_top,
                value_top,
                strength_top,
                constraint_flags,
                internal_conflict_flags: internal_conflict_flags.length > 0 ? internal_conflict_flags : undefined,
                raw_selections: { ...miniModuleSelections },
            };
        }
        
        function summarizeMiniModuleResultLocal(result) {
            const tokenToKorean = {
                problem_solving: '문제해결', creating: '창작', helping_teaching: '도움/가르침',
                data_numbers: '데이터', organizing: '조직/관리', influencing: '영향력',
                autonomy: '자율', growth: '성장', stability: '안정', income: '수입', meaning: '의미', recognition: '인정',
                analytical: '분석력', creative: '창의력', communication: '소통력',
                structured_execution: '실행력', persistence: '끈기', fast_learning: '학습력',
                time_constraint: '시간', income_constraint: '수입', location_constraint: '위치',
                physical_constraint: '체력', qualification_constraint: '자격', uncertainty_constraint: '불확실성',
            };
            
            const format = (arr) => arr.map(t => tokenToKorean[t] || t).join(', ') || '없음';
            
            return \`흥미: \${format(result.interest_top)} | 가치: \${format(result.value_top)} | 강점: \${format(result.strength_top)} | 제약: \${format(result.constraint_flags)}\`;
        }
        
        function goBackToMiniModule() {
            // Step 2에서 미니모듈로 돌아가기
            currentMiniModuleIndex = MINI_MODULE_ORDER.length - 1; // 마지막 모듈부터 시작
            renderMiniModule();
            
            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            document.getElementById('step1-5')?.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Step 1 → Step 2 전환 (로딩 포함)
        function goToStep2WithLoading() {
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            showLoading('질문 구성 중...', '상황에 맞는 질문을 준비하고 있어요');
            setTimeout(() => {
            renderUniversalQuestions();
            goToStep(2);
                hideLoading();
            }, 600);
        }
        
        // ============================================
        // Step 3: 전이 신호 UI 렌더링 (고급 UI)
        // ============================================
        function renderTransitionSignalForm() {
            const container = document.getElementById('transition-signal-form');
            if (!container) return;
            
            // Step3 제목 복원 (V3 라운드에서 돌아온 경우)
            const step3Title = document.querySelector('#step3 h2');
            if (step3Title) {
                step3Title.innerHTML = '<i class="fas fa-compass text-emerald-400 mr-2"></i>앞으로의 방향 (1~2분)';
            }
            
            // 버튼 텍스트 복원
            const nextBtn = document.getElementById('step3-next-btn');
            if (nextBtn) {
                nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>다음';
                nextBtn.onclick = submitTransitionAndContinue;
            }
            
            // 이전 버튼: Step 2로 돌아가기
            const prevBtn = document.getElementById('step3-prev-btn');
            if (prevBtn) {
                prevBtn.onclick = () => goToStep(2);
            }

            container.innerHTML = TRANSITION_SIGNAL_QUESTIONS.map(q => {
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-2 text-white">\${q.text}</h4>
                            <p class="text-xs mb-3" style="color: rgb(100,116,139)">최대 \${q.max_selections || 3}개까지 선택 (선택 순서 = 우선순위)</p>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map((opt, idx) => \`
                                    <button type="button" onclick="selectTransitionChip('\${q.question_id}', '\${opt.value}', this, \${q.max_selections || 3})"
                                            class="trans-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-rank"></div>
                                    </button>
                                \`).join('')}
                            </div>
                            <div class="selected-order mt-3 text-sm hidden p-3 rounded-lg" style="background-color: rgba(16,185,129,0.1); color: #34d399;"></div>
                        </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectTransitionRadio('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-radio group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(148,163,184)"><span class="mr-1">\${opt.emoji}</span>\${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                } else if (q.ui_type === 'checkbox') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleTransitionCheckbox('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-checkbox group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
            
            // 저장된 값 복원
            restoreTransitionSignalAnswers();
        }
        
        // 전이 신호 답변 복원
        function restoreTransitionSignalAnswers() {
            if (!transitionSignalAnswers || Object.keys(transitionSignalAnswers).length === 0) return;
            
            for (const [questionId, values] of Object.entries(transitionSignalAnswers)) {
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) continue;
                
                if (Array.isArray(values)) {
                    // 칩 선택 복원
                    for (const val of values) {
                        const btn = container.querySelector(\`[data-value="\${val}"]\`);
                        if (btn) {
                            // 선택 상태로 스타일 적용
                            btn.style.backgroundColor = 'rgba(16,185,129,0.2)';
                            btn.style.borderColor = '#10b981';
                            btn.style.color = '#34d399';
                        }
                    }
                    // 순서 업데이트
                    updateChipOrder(questionId);
                } else if (typeof values === 'string') {
                    // 라디오 버튼 복원 (selectTransitionRadio와 동일한 스타일)
                    const btn = container.querySelector(\`[data-value="\${values}"]\`);
                    if (btn) {
                        btn.style.backgroundColor = 'rgba(16,185,129,0.2)';
                        btn.style.borderColor = '#10b981';
                        const radioCircle = btn.querySelector('.radio-circle');
                        const radioDot = btn.querySelector('.radio-dot');
                        if (radioCircle) radioCircle.style.borderColor = '#10b981';
                        if (radioDot) radioDot.classList.remove('hidden');
                    }
                }
            }
        }
        
        // 전이 신호 답변 수집
        function collectTransitionSignalAnswers() {
            // transitionSignalAnswers는 selectTransitionChip 등에서 이미 업데이트됨
            // 슬라이더 값 수집
            document.querySelectorAll('.trans-slider').forEach(slider => {
                const questionId = slider.closest('[data-question-id]')?.dataset.questionId;
                if (questionId) {
                    transitionSignalAnswers[questionId] = slider.value;
                }
            });
        }
        
        // 전이 신호 선택 핸들러들 (고급 UI)
        function selectTransitionChip(questionId, value, btnEl, maxSelections) {
            if (!transitionSignalAnswers[questionId]) {
                transitionSignalAnswers[questionId] = [];
            }
            
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                // 이미 선택됨 → 제거
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-rank')?.classList.add('hidden');
                btnEl.querySelector('.chip-rank')?.classList.remove('flex');
            } else if (arr.length < maxSelections) {
                // 새로 선택
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
            }
            
            // 선택 순서 표시 및 순위 배지 업데이트
            updateChipOrder(questionId);
        }
        
        function updateChipOrder(questionId) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            if (!container) {
                console.warn('[updateChipOrder] Container not found for:', questionId);
                return;
            }
            const orderEl = container.querySelector('.selected-order');
            if (!orderEl) {
                console.warn('[updateChipOrder] Order element not found for:', questionId);
                return;
            }
            const arr = transitionSignalAnswers[questionId] || [];
            
            // 모든 순위 배지 초기화
            container.querySelectorAll('.trans-chip').forEach(btn => {
                const rank = btn.querySelector('.chip-rank');
                if (rank) {
                    rank.classList.add('hidden');
                    rank.classList.remove('flex');
                }
            });
            
            if (arr.length > 0) {
                const q = TRANSITION_SIGNAL_QUESTIONS.find(q => q.question_id === questionId);
                const labels = arr.map((v, i) => {
                    const opt = q?.options.find(o => o.value === v);
                    // 해당 버튼에 순위 배지 표시
                    const btn = container.querySelector(\`[data-value="\${v}"]\`);
                    if (btn) {
                        const rank = btn.querySelector('.chip-rank');
                        if (rank) {
                            rank.textContent = i + 1;
                            rank.classList.remove('hidden');
                            rank.classList.add('flex');
                        }
                    }
                    return \`\${i + 1}순위: \${opt?.label || v}\`;
                });
                orderEl.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>' + labels.join(' → ');
                orderEl.classList.remove('hidden');
            } else {
                orderEl.classList.add('hidden');
            }
        }
        
        function selectTransitionRadio(questionId, value, btnEl) {
            const isSelected = transitionSignalAnswers[questionId] === value;
            
            // 같은 질문의 다른 버튼들 선택 해제
            const container = btnEl.parentElement;
            container.querySelectorAll('.trans-radio').forEach(btn => {
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                transitionSignalAnswers[questionId] = value;
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete transitionSignalAnswers[questionId];
            }
        }
        
        function toggleTransitionCheckbox(questionId, value, btnEl) {
            if (!transitionSignalAnswers[questionId]) {
                transitionSignalAnswers[questionId] = [];
            }
            
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
            } else {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
                btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                btnEl.querySelector('.chip-check')?.classList.add('flex');
            }
        }
        
        // Step 2 → Step 3 전환 (전이 신호)
        async function submitUniversalAndGoToTransition() {
            collectUniversalAnswers();
            
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            showLoading('답변 저장 중...', '전이 신호 질문을 준비하고 있어요');
            
            setTimeout(() => {
                try {
                    renderTransitionSignalForm();
                    goToStep(3);
                } catch (error) {
                    console.error('[submitUniversalAndGoToTransition] Error:', error);
                } finally {
                    hideLoading();
                }
            }, 600);
        }
        
        // Step 3 → 서술형 질문 단계 전환 (V3)
        async function submitTransitionAndContinue() {
            // 전이 신호 답변 수집 (임시 저장용)
            collectTransitionSignalAnswers();
            
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            // V3 모드: 서술형 심층 질문 단계로 진행
            const isMinor = MINOR_STAGES.includes(selectedStage);

            if (!isMinor && window.V3_MODE !== false) {
                showLoading('준비 중...', '심층 질문을 구성하고 있어요');
                setTimeout(() => {
                    renderNarrativeStep();
                    hideLoading();
                }, 400);
                return;
            }
            
            // 기존 V2 로직
            showLoading('분석 중...', '맞춤 심층 질문을 구성하고 있어요');
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                console.log('Analysis response (for followups):', data);
                hideLoading();
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(2); // 심층 질문 (3단계 구조)
                } else {
                    // Follow-up 질문이 없으면 바로 결과로
                    currentRequestId = data.request_id;
                    displayResults(data);
                    goToStep(3); // 결과 (3단계 구조)
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        // ============================================
        // V3: 3라운드 심층 질문 시스템
        // ============================================
        window.V3_MODE = true; // V3 모드 활성화 플래그
        window.currentRound = 1;
        window.roundAnswers = [];
        window.narrativeFacts = null;
        
        // V3: 서술형 답변 저장 (P0-1: 에러 표시 강화)
        async function saveNarrativeFacts(facts) {
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                // P0-1: session_id 유효성 검사
                if (!currentSessionId || currentSessionId.trim() === '') {
                    console.error('[V3] saveNarrativeFacts: session_id is invalid');
                    showErrorToast('세션 ID가 유효하지 않습니다. 페이지를 새로고침해주세요.');
                    return false;
                }

                console.log('[V3] Saving narrative facts:', { session_id: currentSessionId });

                const response = await fetch('/api/ai-analyzer/v3/narrative-facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        high_alive_moment: facts.highAliveMoment || facts.question1Answer || '',
                        lost_moment: facts.lostMoment || facts.question2Answer || '',
                    })
                });

                // P0-1: 응답 상태 확인
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[V3] Narrative facts save HTTP error:', response.status, errorText);
                    // 테이블 없음 등의 D1 에러는 무시하고 계속 진행 (테스트 환경)
                    if (errorText.includes('error code: 1031') || errorText.includes('no such table')) {
                        console.warn('[V3] DB table may not exist, continuing without saving narrative facts');
                        return true; // 테스트를 위해 계속 진행
                    }
                    showErrorToast('서술형 답변 저장 실패: ' + errorText.substring(0, 100));
                    return false;
                }

                const data = await response.json();

                // P0-1: 상세 에러 표시
                if (!data.success) {
                    console.error('[V3] Narrative facts save failed:', data);
                    showErrorToast('서술형 답변 저장 실패: ' + (data.detail || data.error || 'Unknown error'));
                    return false;
                }

                console.log('[V3] Narrative facts saved successfully:', data);
                return true;

            } catch (error) {
                console.error('[V3] Failed to save narrative facts:', error);
                // JSON 파싱 에러 등은 무시하고 계속 진행 (테스트 환경)
                if (error.message && error.message.includes('JSON')) {
                    console.warn('[V3] JSON parse error, continuing without saving narrative facts');
                    return true;
                }
                showErrorToast('서술형 답변 저장 중 오류 발생: ' + (error.message || 'Network error'));
                return false;
            }
        }
        
        // P0-1: 에러 토스트 표시 함수
        function showErrorToast(message) {
            // 기존 토스트 제거
            const existingToast = document.querySelector('.v3-error-toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'v3-error-toast';
            toast.innerHTML = \`
                <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                            background: #ef4444; color: white; padding: 12px 20px; border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; max-width: 90vw;
                            font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>\${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-left: 8px; background: none; border: none; color: white; cursor: pointer;">✕</button>
                </div>
            \`;
            document.body.appendChild(toast);
            
            // 5초 후 자동 제거
            setTimeout(() => toast.remove(), 5000);
        }
        
        // V3: 라운드 질문 시작
        async function startV3RoundQuestions(roundNumber) {
            const roundMeta = {
                1: { title: '내면의 에너지 탐색', subtitle: '무엇이 당신을 움직이게 하나요?', emoji: '🔥', color: 'from-orange-500 to-red-500' },
                2: { title: '경계선 확인', subtitle: '무엇을 피하고 싶으신가요?', emoji: '🛡️', color: 'from-purple-500 to-indigo-500' },
                3: { title: '실행 계획 설계', subtitle: '어떻게 시작할 수 있을까요?', emoji: '🚀', color: 'from-emerald-500 to-teal-500' },
            };
            
            const meta = roundMeta[roundNumber];
            showLoading('질문 구성 중...', meta.subtitle);
            
            try {
                currentSessionId = currentSessionId || 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/v3/round-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        narrative_facts: window.narrativeFacts,
                        previous_round_answers: window.roundAnswers,
                        universal_answers: universalAnswers,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        // 미니모듈 결과 (LLM 판단 앵커 - 이게 핵심!)
                        mini_module_result: window.miniModuleResult || null,
                    })
                });
                
                hideLoading();
                
                // 먼저 HTTP 상태 체크 (500 에러 등)
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown server error');
                    console.error('[V3] Round questions HTTP error:', response.status, errorText);
                    alert('질문 생성 중 서버 오류가 발생했습니다 (HTTP ' + response.status + ')\\n\\n잠시 후 다시 시도해주세요.');
                    return;
                }
                
                const data = await response.json();
                console.log('[V3] Round questions response:', data);
                
                // API 에러 처리
                if (data.error) {
                    console.error('[V3] API error:', data.error);
                    alert('질문 생성 중 오류가 발생했습니다: ' + (data.error || 'Unknown error') + '\\n\\n페이지를 새로고침하고 다시 시도해주세요.');
                    return;
                }
                
                // LLM 생성 질문 사용
                const questions = data.questions || [];
                
                if (questions.length > 0) {
                    window.currentRound = roundNumber;
                    window.roundQuestions = questions;  // 질문 저장 (복원용)
                    
                    console.log('[V3] Generated by:', data.generated_by);
                    
                    renderV3RoundUI(roundNumber, questions, meta);
                    // Step 2에 라운드 표시 (3단계 구조)
                    document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
                    document.getElementById('step2')?.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // 질문이 없으면 에러 표시
                    console.error('[V3] No questions generated');
                    alert('질문을 생성하지 못했습니다. 페이지를 새로고침하고 다시 시도해주세요.');
                }
            } catch (error) {
                hideLoading();
                console.error('[V3] Round questions error:', error);
                alert('질문 생성 중 오류가 발생했습니다: ' + (error.message || 'Network error') + '\\n\\n페이지를 새로고침하고 다시 시도해주세요.');
            }
        }
        
        // V3: 라운드 UI 렌더링
        function renderV3RoundUI(roundNumber, questions, meta) {
            // Step 2에서 호출 시 followup-questions-form 사용
            const container = document.getElementById('followup-questions-form') || document.getElementById('transition-signal-form');
            if (!container) return;
            
            const progressWidth = (roundNumber / 3) * 100;
            
            container.innerHTML = \`
                <!-- 라운드 헤더 -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl mb-4" style="background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(234,88,12,0.1));">
                        <span class="text-3xl">\${meta.emoji}</span>
                        <div class="text-left">
                            <div class="text-lg font-bold text-white">\${meta.title}</div>
                            <div class="text-sm text-wiki-muted">\${meta.subtitle}</div>
                        </div>
                    </div>
                    
                    <!-- 라운드 진행 표시 -->
                    <div class="flex items-center justify-center gap-3 mb-4">
                        \${[1, 2, 3].map(r => \`
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all \${r === roundNumber ? 'bg-gradient-to-r ' + meta.color + ' text-white scale-110' : r < roundNumber ? 'bg-emerald-500 text-white' : 'bg-wiki-card text-wiki-muted'}">
                                    \${r < roundNumber ? '✓' : r}
                                </div>
                                \${r < 3 ? '<div class="w-8 h-0.5 ' + (r < roundNumber ? 'bg-emerald-500' : 'bg-wiki-border') + '"></div>' : ''}
                            </div>
                        \`).join('')}
                    </div>
                    <div class="text-xs text-wiki-muted">Round \${roundNumber} / 3</div>
                </div>
                
                <!-- 질문들 -->
                <div class="space-y-6" id="v3-round-questions">
                    \${questions.map((q, idx) => \`
                        <div class="question-block p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(26,26,46,0.8), rgba(36,36,56,0.5)); border: 1px solid rgba(67,97,238,0.2);">
                            <label class="block text-lg font-semibold mb-3 text-white">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-wiki-primary/20 text-wiki-primary text-sm mr-2">\${idx + 1}</span>
                                \${q.questionText}
                            </label>
                            <textarea 
                                id="v3_q_\${q.id}"
                                name="\${q.id}" 
                                rows="4" 
                                minlength="\${q.minLengthGuidance || 30}"
                                placeholder="자유롭게 적어주세요..."
                                class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                style="background-color: rgba(15,15,35,1); border-color: rgba(67,97,238,0.3); color: #fff;"
                                onfocus="this.style.borderColor='rgba(67,97,238,0.6)';"
                                onblur="this.style.borderColor='rgba(67,97,238,0.3)';"
                                oninput="updateV3Counter(this)"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-wiki-muted">최소 \${q.minLengthGuidance || 30}자</span>
                                <span id="v3_q_\${q.id}_counter" class="text-xs text-wiki-muted">0자</span>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
            
            // Step 2 제목 및 서브타이틀 업데이트 (3단계 구조)
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = \`<i class="fas fa-comments text-wiki-primary mr-2"></i>심층 질문 Round \${roundNumber}\`;
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                const subtitleText = roundNumber === 1 
                    ? '당신의 답변을 바탕으로 맞춤 질문을 준비했어요' 
                    : roundNumber === 2 
                    ? '더 깊이 있는 이해를 위한 질문이에요' 
                    : '마지막으로 몇 가지만 더 여쭤볼게요';
                step2Subtitle.textContent = subtitleText;
            }
            
            // Step 인디케이터 업데이트 - 심층 단계(2) 표시
            currentStep = 2;
            window.currentStep = 2;
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= 2) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            // Step 2 버튼 텍스트 업데이트
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                if (roundNumber < 3) {
                    analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>다음 라운드';
                    analyzeBtn.onclick = () => submitV3RoundAndContinue(roundNumber, questions);
                } else {
                    analyzeBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>분석 시작';
                    analyzeBtn.onclick = () => submitV3RoundAndAnalyze(questions);
                }
            }
            
            // 이전 버튼 동작 업데이트 (라운드별 분기)
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    if (roundNumber === 1) {
                        // Round 1 -> 서술형 질문으로
                        showPrevWarningModal(() => {
                            renderNarrativeStep();
                        });
                    } else {
                        // Round 2/3 -> 이전 라운드로 (경고 없이 바로 이동)
                        startV3RoundQuestions(roundNumber - 1);
                    }
                };
            }
        }
        
        // 이전 버튼 경고 모달 표시
        function showPrevWarningModal(onConfirm) {
            // 기존 모달 제거
            const existingModal = document.getElementById('prev-warning-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'prev-warning-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.innerHTML = \`
                <div class="bg-wiki-card rounded-2xl p-6 max-w-md w-full border border-wiki-border shadow-2xl">
                    <div class="text-center mb-4">
                        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-yellow-500/20 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-2xl text-yellow-400"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">이전 단계로 돌아가시겠습니까?</h3>
                        <p class="text-wiki-muted text-sm">이전 단계의 내용을 수정하면 심층 질문이 새로 생성될 수 있습니다.</p>
                        <p class="text-yellow-400 text-sm mt-2"><i class="fas fa-info-circle mr-1"></i>기존 답변이 초기화될 수 있습니다.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="prev-warning-cancel" class="flex-1 px-4 py-3 bg-wiki-bg border border-wiki-border rounded-xl text-white hover:bg-wiki-card transition">
                            취소
                        </button>
                        <button id="prev-warning-confirm" class="flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl text-white font-medium transition">
                            이전으로 돌아가기
                        </button>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            
            document.getElementById('prev-warning-cancel').onclick = () => modal.remove();
            document.getElementById('prev-warning-confirm').onclick = () => {
                modal.remove();
                // 심층 질문 상태 초기화
                window.currentRound = 0;
                window.roundQuestions = null;
                window.roundAnswers = [];
                onConfirm();
            };
        }
        
        // V3: 심층 질문 기초 답변 복원
        function restoreNarrativeAnswers() {
            if (!window.narrativeFacts) {
                console.log('[restoreNarrativeAnswers] No narrative facts to restore');
                return;
            }
            
            const facts = window.narrativeFacts;
            console.log('[restoreNarrativeAnswers] Restoring narrative answers:', facts);
            
            // Q0: 스토리 질문
            const q0 = document.getElementById('narrative_q0');
            if (q0 && (facts.storyAnswer || facts.life_story)) {
                q0.value = facts.storyAnswer || facts.life_story || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q0, 5000);
                }
            }
            
            // Career background (선택)
            const careerBg = document.getElementById('narrative_career_bg');
            if (careerBg && facts.career_background) {
                careerBg.value = facts.career_background;
            }
            
            // Q1: 동적 질문 1
            const q1 = document.getElementById('narrative_q1');
            if (q1 && (facts.question1Answer || facts.highAliveMoment)) {
                q1.value = facts.question1Answer || facts.highAliveMoment || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q1, 10000);
                }
            }
            
            // Q2: 동적 질문 2
            const q2 = document.getElementById('narrative_q2');
            if (q2 && (facts.question2Answer || facts.lostMoment)) {
                q2.value = facts.question2Answer || facts.lostMoment || '';
                if (typeof updateNarrativeCounter === 'function') {
                    updateNarrativeCounter(q2, 10000);
                }
            }
            
            console.log('[restoreNarrativeAnswers] Narrative answers restored successfully');
        }
        
        // V3: 라운드 답변 복원
        function restoreRoundAnswers() {
            if (!window.roundAnswers || !window.currentRound) return;
            
            // 현재 라운드의 답변 찾기
            const currentRoundAnswers = window.roundAnswers.filter(a => a.roundNumber === window.currentRound);
            
            currentRoundAnswers.forEach(answer => {
                const textarea = document.getElementById('v3_q_' + answer.questionId);
                if (textarea && answer.answer) {
                    textarea.value = answer.answer;
                    // 카운터 업데이트
                    if (typeof updateV3Counter === 'function') {
                        updateV3Counter(textarea);
                    }
                }
            });
            
            console.log('[ServerRestore] Round answers restored:', currentRoundAnswers.length);
        }
        
        // V3: 글자수 카운터
        function updateV3Counter(textarea) {
            const counter = document.getElementById(textarea.id + '_counter');
            if (counter) {
                counter.textContent = textarea.value.length + '자';
                counter.style.color = textarea.value.length >= (parseInt(textarea.minLength) || 30) ? 'rgb(74, 222, 128)' : 'rgb(148,163,184)';
            }
        }
        
        // V3: 라운드 답변 제출 후 다음 라운드
        async function submitV3RoundAndContinue(currentRound, questions) {
            const answers = collectV3RoundAnswers(questions);
            if (!validateV3Answers(answers, questions)) return;
            
            const nextBtn = document.getElementById('step3-next-btn');
            const prevBtn = document.getElementById('step3-prev-btn');
            const originalNextHtml = nextBtn?.innerHTML;
            
            // 저장 구간부터 로딩 표시 (기존에는 없었음)
            showLoading('답변 저장 중...', '다음 라운드를 준비하고 있어요');
            
            try {
                // 버튼 비활성화
                if (nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...';
                }
                if (prevBtn) prevBtn.setAttribute('disabled', 'true');
                
                // 답변 저장
                await saveV3RoundAnswers(currentRound, answers, questions);
                
                // 다음 라운드 시작 (startV3RoundQuestions 내부에서 showLoading('질문 구성 중...') → hideLoading() 처리됨)
                await startV3RoundQuestions(currentRound + 1);
            } finally {
                // 버튼 복원
                if (nextBtn) {
                    nextBtn.disabled = false;
                    if (originalNextHtml) nextBtn.innerHTML = originalNextHtml;
                }
                if (prevBtn) prevBtn.removeAttribute('disabled');
                // 안전장치: 오류로 startV3RoundQuestions로 못 갔을 때를 대비
                hideLoading();
            }
        }
        
        // V3: 마지막 라운드 후 분석 시작
        async function submitV3RoundAndAnalyze(questions) {
            const answers = collectV3RoundAnswers(questions);
            if (!validateV3Answers(answers, questions)) return;
            
            const nextBtn = document.getElementById('step3-next-btn');
            const prevBtn = document.getElementById('step3-prev-btn');
            
            // 저장부터 로딩 표시
            showLoading('답변 저장 중...', '마지막 답변을 저장하고 있어요');
            
            // 버튼 비활성화
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...';
            }
            if (prevBtn) prevBtn.setAttribute('disabled', 'true');
            
            // 마지막 라운드 답변 저장
            await saveV3RoundAnswers(3, answers, questions);
            
            // ============================================
            // Freeze v1.1: Recommendation Mode 통합
            // - 기존 분석 API 호출 (리포트 생성용)
            // - 새 Recommend API 호출 (최신 Vectorize+TAG 기반 추천)
            // ============================================
            showLoading('분석 중...', '전문가급 리포트를 생성하고 있어요');
            
            try {
                // 1. 기존 분석 API (리포트 생성)
                const analyzeResponse = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        narrative_facts: window.narrativeFacts,
                        round_answers: window.roundAnswers,
                        engine_version: 'v3',
                        debug: DEBUG_MODE,
                    })
                });
                
                const analyzeData = await analyzeResponse.json();
                
                // ★★★ LLM 모듈 확인용 콘솔 로그 ★★★
                console.log('======================================');
                console.log('★★★ /analyze API 응답 (LLM 확인) ★★★');
                console.log('======================================');
                console.log('llm_modules:', analyzeData.result?.llm_modules || analyzeData.llm_modules);
                console.log('전체 응답:', analyzeData);
                console.log('======================================');
                
                // 2. Recommendation Mode API (최신 Vectorize+TAG 추천)
                showLoading('추천 생성 중...', 'AI가 최적의 직업을 찾고 있어요');
                
                try {
                    // SearchProfile 구성
                    const miniModule = window.miniModuleResult || {};
                    const searchProfile = {
                        desiredThemes: [
                            ...(miniModule.interest_top || []),
                            ...(miniModule.value_top || []),
                            ...(universalAnswers.univ_interest || []),
                        ].filter(Boolean),
                        dislikedThemes: universalAnswers.univ_dislike || [],
                        strengthsHypothesis: miniModule.strength_top || [],
                        environmentPreferences: [],
                        hardConstraints: miniModule.constraint_flags || [],
                        riskSignals: [],
                        keywords: [
                            ...(miniModule.interest_top || []),
                            ...(universalAnswers.univ_interest || []),
                        ].filter(Boolean),
                    };
                    
                    const recommendResponse = await fetch('/api/ai-analyzer/v3/recommend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            searchProfile: searchProfile,
                            mini_module_result: miniModule,
                            topK: 800,
                            judgeTopN: 20,
                            debug: DEBUG_MODE,
                        })
                    });
                    
                    const recommendData = await recommendResponse.json();

                    // 🔍 DEBUG: API 응답 확인
                    console.log('[V3.1] 🔍 recommendData 전체:', recommendData);
                    if (recommendData.recommendations?.like_top10?.[0]) {
                        console.log('[V3.1] 🔍 like_top10[0] 샘플:', {
                            job_id: recommendData.recommendations.like_top10[0].job_id,
                            job_name: recommendData.recommendations.like_top10[0].job_name,
                            image_url: recommendData.recommendations.like_top10[0].image_url,
                            job_description: recommendData.recommendations.like_top10[0].job_description,
                            rationale: recommendData.recommendations.like_top10[0].rationale,
                        });
                    }

                    // 3. 결과 병합: Recommendation Mode 결과를 우선 사용
                    if (recommendData.success && recommendData.recommendations) {
                        console.log('[V3.1] Recommendation Mode 결과 사용:', recommendData.recommendations.top_jobs?.length, '개 직업');

                        // analyzeData.result가 없으면 초기화
                        if (!analyzeData.result) {
                            analyzeData.result = {};
                        }

                        // fit_top3에 Recommendation Mode 결과 병합 (result 안에 저장)
                        if (recommendData.recommendations.top_jobs) {
                            const newTopJobs = recommendData.recommendations.top_jobs.slice(0, 10);
                            analyzeData.result.fit_top3 = newTopJobs.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                                evidence_quotes: job.evidence_quotes || [],
                                risk_details: [],
                                evidence_links: [],
                            }));
                            console.log('[V3.1] fit_top3 merged:', analyzeData.result.fit_top3.length, '개, top:', analyzeData.result.fit_top3[0]?.job_name);
                        }

                        // like_top10에 Recommendation Mode 결과 병합 (result 안에 저장)
                        if (recommendData.recommendations.like_top10) {
                            analyzeData.result.like_top10 = recommendData.recommendations.like_top10.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                            }));
                            console.log('[V3.1] like_top10 merged:', analyzeData.result.like_top10.length, '개');
                        }

                        // can_top10에 Recommendation Mode 결과 병합 (result 안에 저장)
                        if (recommendData.recommendations.can_top10) {
                            analyzeData.result.can_top10 = recommendData.recommendations.can_top10.map(job => ({
                                job_id: job.job_id,
                                job_name: job.job_name,
                                job_description: job.job_description || '',
                                slug: job.slug || '',
                                image_url: job.image_url || '',
                                fit_score: job.fit_score,
                                like_score: job.like_score,
                                can_score: job.can_score,
                                rationale: job.rationale || '',
                                like_reason: job.like_reason || '',
                                can_reason: job.can_reason || '',
                            }));
                            console.log('[V3.1] can_top10 merged:', analyzeData.result.can_top10.length, '개');
                        }

                        // premium_report 병합 (추천 모드의 LLM 리포트가 더 정확함)
                        if (recommendData.premium_report) {
                            analyzeData.result.premium_report = recommendData.premium_report;
                            console.log('[V3.1] premium_report merged from recommendation mode');
                        }

                        // request_id 업데이트 (추천 모드에서 갱신된 ID 사용)
                        if (recommendData.request_id) {
                            analyzeData.request_id = recommendData.request_id;
                        }

                        // 메타데이터 추가
                        analyzeData._recommendation_mode = {
                            enabled: true,
                            total_candidates: recommendData.recommendations.total_candidates,
                            filtered_count: recommendData.recommendations.filtered_count,
                            search_duration_ms: recommendData.recommendations.search_duration_ms,
                        };
                    }
                } catch (recommendError) {
                    // Recommendation Mode 실패해도 기존 결과는 표시
                    console.warn('[V3.1] Recommendation Mode 실패, 기존 결과 사용:', recommendError);
                }
                
                hideLoading();
                
                currentRequestId = analyzeData.request_id;
                displayResults(analyzeData);
                goToStep(3); // 결과 (3단계 구조)
                
            } catch (error) {
                hideLoading();
                console.error('[V3] Analysis error:', error);
                alert('분석 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // V3: 라운드 답변 수집
        function collectV3RoundAnswers(questions) {
            return questions.map(q => {
                const textarea = document.getElementById('v3_q_' + q.id);
                return {
                    question_id: q.id,
                    question_text: q.questionText,
                    purpose_tag: q.purposeTag,
                    answer: textarea ? textarea.value.trim() : '',
                };
            });
        }
        
        // V3: 답변 검증
        function validateV3Answers(answers, questions) {
            for (let i = 0; i < answers.length; i++) {
                const minLen = questions[i].minLengthGuidance || 30;
                if (answers[i].answer.length < minLen) {
                    const textarea = document.getElementById('v3_q_' + questions[i].id);
                    if (textarea) {
                        textarea.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                        textarea.focus();
                    }
                    alert('질문 ' + (i + 1) + '에 ' + minLen + '자 이상 작성해주세요.');
                    return false;
                }
            }
            return true;
        }
        
        // V3: 라운드 답변 저장 (P0-1: 에러 표시 강화)
        async function saveV3RoundAnswers(roundNumber, answers, questions) {
            // 로컬 저장 (항상 수행) - 질문 텍스트도 함께 저장!
            for (const ans of answers) {
                window.roundAnswers.push({
                    questionId: ans.question_id,
                    questionText: ans.question_text,  // 질문 텍스트 추가 (다음 라운드에서 사용)
                    roundNumber: roundNumber,
                    answer: ans.answer,
                    answeredAt: new Date().toISOString(),
                });
            }
            
            // P0-1: session_id 유효성 검사
            if (!currentSessionId || currentSessionId.trim() === '') {
                console.error('[V3] saveV3RoundAnswers: session_id is invalid');
                showErrorToast('세션 ID가 유효하지 않습니다. 페이지를 새로고침해주세요.');
                return false;
            }
            
            console.log('[V3] Saving round answers:', { 
                session_id: currentSessionId, 
                round_number: roundNumber,
                answers_count: answers.length 
            });
            
            // 서버 저장
            try {
                const response = await fetch('/api/ai-analyzer/v3/round-answers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        round_number: roundNumber,
                        answers: answers,
                    })
                });
                
                // 먼저 HTTP 상태 체크 (500 에러 등)
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('[V3] Round answers save HTTP error:', response.status, errorText);
                    showErrorToast('라운드 ' + roundNumber + ' 답변 저장 실패 (HTTP ' + response.status + ')');
                    // 로컬에는 저장되었으므로 진행은 계속
                    return false;
                }
                
                const data = await response.json();
                
                // P0-1: 상세 에러 표시
                if (!data.success) {
                    console.error('[V3] Round answers save failed:', data);
                    showErrorToast('라운드 ' + roundNumber + ' 답변 저장 실패: ' + (data.detail || data.error || 'Unknown error'));
                    // 로컬에는 저장되었으므로 진행은 계속
                    return false;
                }
                
                console.log('[V3] Round answers saved successfully:', data);
                return true;
                
            } catch (error) {
                console.error('[V3] Failed to save round answers:', error);
                showErrorToast('라운드 ' + roundNumber + ' 답변 저장 중 오류 발생: ' + (error.message || 'Network error'));
                // 로컬에는 저장되었으므로 진행은 계속
                return false;
            }
        }
        
        // ============================================
        // Step 2: Universal Questions 렌더링 (서술형은 Step 3.5로 이동)
        // ============================================
        function renderUniversalQuestions() {
            const container = document.getElementById('universal-questions');
            const isMinor = MINOR_STAGES.includes(selectedStage);
            
            // ============================================
            // 중복 옵션 필터링 맵 생성 (미니모듈/Step1 → Step2)
            // ============================================
            const duplicateOptionsMap = {};
            
            // 미니모듈 constraint → univ_life_constraint 중복 매핑
            const constraintToLifeConstraintMap = {
                'income_constraint': 'finance_pressure',     // 경제적 제약
                'physical_constraint': 'health',             // 건강/체력 제약
                'time_constraint': 'caregiving',             // 시간 제약 → 돌봄
            };
            
            // 미니모듈 interest → univ_interest 중복 매핑
            const interestToUnivInterestMap = {
                'creative': 'creative',                      // 창작/아이디어
                'analysis': 'science',                       // 분석/연구 → 과학/연구
                'helping': 'social',                         // 돕기/서비스 → 사회/복지
                'data_handling': 'tech',                     // 데이터 → 기술/IT
            };
            
            // 미니모듈 value → univ_priority 중복 매핑 (이미 전체 질문 제외됨)
            
            // 미니모듈 결과가 있으면 중복 옵션 추출
            if (window.miniModuleResult) {
                const mm = window.miniModuleResult;
                
                // constraint_flags → univ_life_constraint 중복
                if (mm.constraint_flags?.length > 0) {
                    duplicateOptionsMap['univ_life_constraint'] = mm.constraint_flags
                        .map(c => constraintToLifeConstraintMap[c])
                        .filter(Boolean);
                }
                
                // interest_top → univ_interest 중복
                if (mm.interest_top?.length > 0) {
                    duplicateOptionsMap['univ_interest'] = mm.interest_top
                        .map(i => interestToUnivInterestMap[i])
                        .filter(Boolean);
                }
            }
            
            // Step 1에서 제약조건이 선택되었는지 확인하는 헬퍼 함수
            function hasStep1Constraints() {
                if (!careerState.constraints) return false;
                return Object.values(careerState.constraints).some(c => c?.has_constraint === true);
            }
            
            // 미성년 단계에서는 오픈텍스트 질문 숨김 + 미니모듈 중복 질문 제거
            const filteredQuestions = UNIVERSAL_QUESTIONS.filter(q => {
                if (isMinor && q.ui_type === 'text') return false;
                
                // === 미니모듈과 중복되는 질문 제거 ===
                // univ_priority (가치) - 미니모듈 value_top과 중복
                if (q.id === 'univ_priority' && window.miniModuleResult?.value_top?.length > 0) {
                    return false;
                }
                // univ_interest (관심사) - 미니모듈 interest_top과 중복
                if (q.id === 'univ_interest' && window.miniModuleResult?.interest_top?.length > 0) {
                    return false;
                }
                // univ_strength (강점) - 미니모듈 strength_top과 중복
                if (q.id === 'univ_strength' && window.miniModuleResult?.strength_top?.length > 0) {
                    return false;
                }
                // univ_life_constraint (생활 제약) - Step 1 제약 또는 미니모듈 constraint_flags와 중복
                if (q.id === 'univ_life_constraint' && 
                    (window.miniModuleResult?.constraint_flags?.length > 0 || hasStep1Constraints())) {
                    return false;
                }
                
                return true;
            });
            
            // 값 복원: universalAnswers에 저장된 값 복원
            // 중복 옵션 맵을 전역에 저장하여 renderUniversalQuestion에서 사용
            window._duplicateOptionsMap = duplicateOptionsMap;
            
            // 질문을 order 필드에 따라 정렬
            const sortedQuestions = filteredQuestions.sort((a, b) => (a.order || 999) - (b.order || 999));
            container.innerHTML = sortedQuestions.map(q => renderUniversalQuestion(q, isMinor)).join('');
            
            // 저장된 값 복원
            restoreUniversalAnswers();
        }
        
        // 저장된 Universal 답변 복원
        function restoreUniversalAnswers() {
            if (!universalAnswers || Object.keys(universalAnswers).length === 0) return;
            
            for (const [questionId, values] of Object.entries(universalAnswers)) {
                if (Array.isArray(values)) {
                    // 칩/체크박스 선택
                    for (const val of values) {
                        const btn = document.querySelector(\`[data-question-id="\${questionId}"] [data-value="\${val}"]\`);
                        if (btn && !btn.classList.contains('chip-selected')) {
                            btn.click();
                        }
                    }
                } else if (typeof values === 'string') {
                    // 라디오 버튼 선택
                    const radioBtn = document.querySelector(\`[data-question-id="\${questionId}"] [data-value="\${values}"]\`);
                    if (radioBtn && !radioBtn.classList.contains('radio-selected')) {
                        radioBtn.click();
                    }
                    
                    // 텍스트 입력
                    const textarea = document.querySelector(\`[data-question-id="\${questionId}"] textarea, textarea[name="\${questionId}"]\`);
                    if (textarea) textarea.value = values;
                }
            }
        }
        
        // V3: 서술형 심층 질문 단계 렌더링 (Step 3.5 - 전이 신호 다음)
        // 상황 + 경력 + 목표에 따라 동적으로 질문 선택
        function renderNarrativeStep() {
            // Step 2에서 호출 시 followup-questions-form 사용
            const container = document.getElementById('followup-questions-form') || document.getElementById('transition-signal-form');
            if (!container) return;
            
            // 저장된 질문이 있으면 재사용, 없으면 새로 생성
            const questions = window.savedNarrativeQuestions || getNarrativeQuestions();
            const q1 = questions.question1;
            const q2 = questions.question2;
            
            // 현재 사용 중인 질문 저장 (나중에 임시저장 시 사용)
            window.savedNarrativeQuestions = questions;
            
            // 저장된 값 복원 (fact_key 기반)
            const savedQ0 = window.narrativeFacts?.storyAnswer || window.narrativeFacts?.life_story || '';
            const savedQ1 = window.narrativeFacts?.question1Answer || window.narrativeFacts?.highAliveMoment || '';
            const savedQ2 = window.narrativeFacts?.question2Answer || window.narrativeFacts?.lostMoment || '';
            const savedCareerBg = window.narrativeFacts?.career_background || '';
            
            // 스토리 질문 (공통 - 모든 템플릿에서 첫 번째 질문)
            const storyQuestion = {
                id: 'life_story',
                text: '간략하게 지금까지의 이야기를 들려주세요',
                placeholder: '예: 대학에서 경영학을 전공하고 마케팅 회사에서 3년 일했어요. 숫자보다는 사람들과 소통하는 일이 좋아서 기획 쪽으로 옮겼고, 지금은 새로운 도전을 찾고 있어요...',
                emoji: '📖',
                color: 'from-slate-500 to-blue-500',
                fact_key: 'narrative.life_story'
            };
            
            // 전공/이전 직업 질문 (선택 - 구조화 입력)
            const careerBackgroundQuestion = {
                id: 'career_background',
                text: '전공/최근 직무 정보 (선택)',
                placeholder: '예: 컴퓨터공학 전공, 마케팅 회사 3년 근무, 데이터 분석 업무',
                hint: '전공/학과, 최근 직무/업종, 경력 기간을 간략히 적어주세요. AI가 더 정확한 추천을 드리는 데 도움이 됩니다.',
                emoji: '📋',
                color: 'from-cyan-500 to-blue-500',
                fact_key: 'narrative.career_background',
                required: false
            };
            
            // 색상 파싱 함수
            const parseGradient = (color) => {
                const colors = color.replace('from-', '').replace(' to-', ',').split(',');
                const colorMap = {
                    'yellow-500': '234,179,8', 'orange-500': '249,115,22', 'red-500': '239,68,68',
                    'pink-500': '236,72,153', 'rose-500': '244,63,94', 'rose-600': '225,29,72',
                    'violet-500': '139,92,246', 'purple-500': '168,85,247', 'purple-600': '147,51,234',
                    'indigo-500': '99,102,241', 'indigo-600': '79,70,229', 'blue-500': '59,130,246',
                    'blue-600': '37,99,235', 'cyan-500': '6,182,212', 'cyan-600': '8,145,178',
                    'teal-500': '20,184,166', 'teal-600': '13,148,136', 'emerald-500': '16,185,129',
                    'green-500': '34,197,94', 'amber-500': '245,158,11', 'slate-500': '100,116,139',
                    'slate-600': '71,85,105', 'gray-600': '75,85,99', 'zinc-600': '82,82,91', 'pink-600': '219,39,119',
                };
                return colors.map(c => colorMap[c.trim()] || '139,92,246');
            };
            
            const q0Colors = parseGradient(storyQuestion.color);
            const careerBgColors = parseGradient(careerBackgroundQuestion.color);
            const q1Colors = parseGradient(q1.color);
            const q2Colors = parseGradient(q2.color);
            
            container.innerHTML = \`
                <!-- 격려 문구 -->
                <div class="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 rounded-xl p-4 mb-6">
                    <p class="text-emerald-300 text-sm">
                        <i class="fas fa-lightbulb mr-2"></i>
                        자세히 (구체적인 상황, 감정, 이유를 솔직하게) 작성할수록 AI가 당신을 더 잘 이해하고, 더 정확한 추천을 드릴 수 있어요.
                    </p>
                </div>
                
                <!-- 서술형 질문 0 (스토리 - 공통) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q0Colors[0]},0.1), rgba(\${q0Colors[1]},0.05)); border: 1px solid rgba(\${q0Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${storyQuestion.emoji}</span>
                        \${storyQuestion.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">학력, 경력, 현재 상황 등 배경을 간략히 적어주세요. AI가 맥락을 이해하는 데 도움이 돼요.</p>
                    <textarea 
                        id="narrative_q0"
                        name="narrative_q0" 
                        data-fact-key="\${storyQuestion.fact_key}"
                        data-question-id="\${storyQuestion.id}"
                        rows="4" 
                        minlength="30"
                        maxlength="5000"
                        placeholder="\${storyQuestion.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[100px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q0Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q0Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q0Colors[0]},0.3)'; validateNarrativeLength(this, 30);"
                        oninput="updateNarrativeCounter(this, 5000);">\${savedQ0}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q0_hint" class="text-xs text-wiki-muted">최소 30자 / 현재 \${savedQ0.length}자</span>
                        <span id="narrative_q0_counter" class="text-xs text-wiki-muted">\${savedQ0.length}자</span>
                    </div>
                </div>
                
                <!-- 전공/이전 직업 정보 (이력서 업로드 시 자동 입력 or 숨김) -->
                \${window.resumeUploaded && window.resumeCareerBackground ? \`
                    <!-- 이력서에서 추출된 정보 표시 (읽기 전용) -->
                    <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3);">
                        <label class="block text-lg font-semibold mb-2 text-white">
                            <span class="mr-2">📋</span>
                            이력서에서 추출된 배경 정보
                            <span class="text-xs text-emerald-400 ml-2">✓ 자동 입력됨</span>
                        </label>
                        <div class="px-4 py-3 rounded-xl" style="background-color: rgba(15,15,35,0.7); border: 1px solid rgba(16,185,129,0.2);">
                            <p class="text-white">\${window.resumeCareerBackground}</p>
                        </div>
                        <input type="hidden" id="narrative_career_bg" name="narrative_career_bg" 
                               data-fact-key="\${careerBackgroundQuestion.fact_key}"
                               value="\${window.resumeCareerBackground}" />
                    </div>
                \` : \`
                    <!-- 수동 입력 필드 (이력서 미업로드 시) -->
                    <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${careerBgColors[0]},0.1), rgba(\${careerBgColors[1]},0.05)); border: 1px solid rgba(\${careerBgColors[0]},0.2);">
                        <label class="block text-lg font-semibold mb-2 text-white">
                            <span class="mr-2">\${careerBackgroundQuestion.emoji}</span>
                            \${careerBackgroundQuestion.text}
                            <span class="text-xs text-wiki-muted ml-2">(선택사항)</span>
                        </label>
                        <p class="text-sm text-wiki-muted mb-4">\${careerBackgroundQuestion.hint}</p>
                        <input 
                            type="text"
                            id="narrative_career_bg"
                            name="narrative_career_bg" 
                            data-fact-key="\${careerBackgroundQuestion.fact_key}"
                            data-question-id="\${careerBackgroundQuestion.id}"
                            maxlength="500"
                            placeholder="\${careerBackgroundQuestion.placeholder}"
                            value="\${savedCareerBg}"
                            class="w-full px-4 py-3 rounded-xl border transition-all"
                            style="background-color: rgba(15,15,35,1); border-color: rgba(\${careerBgColors[0]},0.3); color: #fff;"
                            onfocus="this.style.borderColor='rgba(\${careerBgColors[0]},0.6)';"
                            onblur="this.style.borderColor='rgba(\${careerBgColors[0]},0.3)';"
                        />
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-wiki-muted/60">전공, 직무, 업종, 경력 기간 등 정확한 추천에 도움이 됩니다</span>
                        </div>
                    </div>
                \`}
                
                <!-- 서술형 질문 1 (동적) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q1Colors[0]},0.1), rgba(\${q1Colors[1]},0.05)); border: 1px solid rgba(\${q1Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q1.emoji}</span>
                        \${q1.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">구체적인 상황, 그때의 감정, 왜 그렇게 느꼈는지 자유롭게 적어주세요</p>
                    <textarea 
                        id="narrative_q1"
                        name="narrative_q1" 
                        data-fact-key="\${q1.fact_key}"
                        data-question-id="\${q1.id}"
                        rows="5" 
                        minlength="50"
                        maxlength="10000"
                        placeholder="\${q1.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q1Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q1Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q1Colors[0]},0.3)'; validateNarrativeLength(this, 50);"
                        oninput="updateNarrativeCounter(this, 10000);">\${savedQ1}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q1_hint" class="text-xs text-wiki-muted">최소 50자 / 현재 \${savedQ1.length}자</span>
                        <span id="narrative_q1_counter" class="text-xs text-wiki-muted">\${savedQ1.length}자</span>
                    </div>
                </div>
                
                <!-- 서술형 질문 2 (동적) -->
                <div class="question-block p-5 rounded-2xl mb-5" style="background: linear-gradient(135deg, rgba(\${q2Colors[0]},0.1), rgba(\${q2Colors[1]},0.05)); border: 1px solid rgba(\${q2Colors[0]},0.2);">
                    <label class="block text-lg font-semibold mb-2 text-white">
                        <span class="mr-2">\${q2.emoji}</span>
                        \${q2.text}
                        <span class="text-red-400 ml-1">*</span>
                    </label>
                    <p class="text-sm text-wiki-muted mb-4">구체적인 상황, 그때의 감정, 왜 그렇게 느꼈는지 자유롭게 적어주세요</p>
                    <textarea 
                        id="narrative_q2"
                        name="narrative_q2" 
                        data-fact-key="\${q2.fact_key}"
                        data-question-id="\${q2.id}"
                        rows="5" 
                        minlength="50"
                        maxlength="10000"
                        placeholder="\${q2.placeholder}"
                        class="w-full px-4 py-3 rounded-xl border transition-all resize-y min-h-[120px]"
                        style="background-color: rgba(15,15,35,1); border-color: rgba(\${q2Colors[0]},0.3); color: #fff;"
                        onfocus="this.style.borderColor='rgba(\${q2Colors[0]},0.6)';"
                        onblur="this.style.borderColor='rgba(\${q2Colors[0]},0.3)'; validateNarrativeLength(this, 50);"
                        oninput="updateNarrativeCounter(this, 10000);">\${savedQ2}</textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="narrative_q2_hint" class="text-xs text-wiki-muted">최소 50자 / 현재 \${savedQ2.length}자</span>
                        <span id="narrative_q2_counter" class="text-xs text-wiki-muted">\${savedQ2.length}자</span>
                    </div>
                </div>
                
                <!-- 추가 격려 문구 -->
                <div class="text-center text-xs text-wiki-muted/60 mt-6">
                    <i class="fas fa-shield-alt mr-1"></i>
                    입력하신 내용은 추천에만 사용되며, 외부에 공개되지 않습니다.
                </div>
            \`;
            
            // Step 2 제목 및 서브타이틀 업데이트 (3단계 구조)
            const step2Title = document.querySelector('#step2 h2');
            if (step2Title) {
                step2Title.innerHTML = '<i class="fas fa-comments text-wiki-primary mr-2"></i>심층 질문 기초';
            }
            const step2Subtitle = document.getElementById('step2-subtitle');
            if (step2Subtitle) {
                step2Subtitle.textContent = '당신의 이야기를 자유롭게 들려주세요';
            }
            
            // Step 인디케이터 업데이트 - 심층 단계 (Step 2) 표시
            currentStep = 2;
            window.currentStep = 2;
            document.querySelectorAll('.step-dot').forEach((el) => {
                const circle = el.querySelector('span:first-child');
                const stepNum = parseInt(el.dataset.step, 10);
                if (stepNum <= 2) {
                    circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else {
                    circle.classList.add('bg-wiki-border', 'text-wiki-muted');
                    circle.classList.remove('bg-wiki-primary', 'text-white');
                }
            });
            
            console.log('[renderNarrativeStep] currentStep set to 2, window.currentStep:', window.currentStep);
            
            // Step 2 버튼 업데이트
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>다음';
                analyzeBtn.onclick = submitNarrativeAndContinueV3;
            }
            
            // 이전 버튼: 프로필로 돌아가기
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    // 서술형 답변 임시 저장
                    collectNarrativeAnswers();
                    // 프로필로 돌아가기
                    goToStep(1);
                    goToProfileStep2();  // 프로필 2/2로 이동
                };
            }
            
            // 저장된 값이 있으면 카운터/힌트 업데이트
            setTimeout(() => {
                const q0 = document.getElementById('narrative_q0');
                const q1 = document.getElementById('narrative_q1');
                const q2 = document.getElementById('narrative_q2');
                if (q0 && q0.value) {
                    updateNarrativeCounter(q0, 5000);
                    validateNarrativeLength(q0, 30);
                }
                if (q1 && q1.value) {
                    updateNarrativeCounter(q1, 10000);
                    validateNarrativeLength(q1, 50);
                }
                if (q2 && q2.value) {
                    updateNarrativeCounter(q2, 10000);
                    validateNarrativeLength(q2, 50);
                }
            }, 100);
        }
        
        // 서술형 글자수 카운터 업데이트 (상한선 근접 시에만 표시)
        function updateNarrativeCounter(textarea, maxLength) {
            const counter = document.getElementById(textarea.id + '_counter');
            const hint = document.getElementById(textarea.id + '_hint');
            const current = textarea.value.length;
            const minLength = parseInt(textarea.minLength) || 30;
            
            if (counter) {
                // 항상 글자수 표시
                counter.textContent = current.toLocaleString() + '자';
                counter.classList.remove('hidden');
                
                // 색상 (최소 충족 여부에 따라)
                if (current >= maxLength * 0.9) {
                    counter.style.color = current >= maxLength ? 'rgb(239, 68, 68)' : 'rgb(251, 146, 60)';
                } else if (current >= minLength) {
                    counter.style.color = 'rgb(74, 222, 128)';  // 최소 충족: 초록색
                } else {
                    counter.style.color = 'rgb(148, 163, 184)';  // 미충족: 회색
                }
            }
            
            // 힌트 텍스트 업데이트 (최소 글자수 표시)
            if (hint) {
                if (current >= minLength) {
                    hint.textContent = '✓ 최소 ' + minLength + '자 충족';
                    hint.style.color = 'rgb(74, 222, 128)';
                } else {
                    hint.textContent = '최소 ' + minLength + '자 / 현재 ' + current + '자';
                    hint.style.color = 'rgb(148, 163, 184)';
                }
            }
        }
        
        // 서술형 최소 길이 검증 (압박 제거, 권장 메시지로 변경)
        function validateNarrativeLength(textarea, minLength) {
            const hint = document.getElementById(textarea.id + '_hint');
            const current = textarea.value.length;
            if (hint) {
                // 항상 부드러운 톤으로 안내
                hint.textContent = '💡 자세히 적을수록 추천 정확도가 높아집니다';
                hint.style.color = 'rgb(148,163,184)';
            }
        }
        
        // 서술형 답변 제출 후 V3 라운드로 진행
        async function submitNarrativeAndContinueV3() {
            // 서술형 답변 검증
            if (!validateNarrativeRequired()) {
                return;
            }
            
            // 서술형 답변 수집 및 저장
            const narrativeFacts = collectNarrativeAnswers();
            if (narrativeFacts) {
                await saveNarrativeFacts(narrativeFacts);
            }
            
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            // 3라운드 심층 질문 시작
            await startV3RoundQuestions(1);
        }
        
        // 서술형 답변 수집 (동적 질문 지원)
        function collectNarrativeAnswers() {
            const q0 = document.getElementById('narrative_q0');
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');
            const careerBg = document.getElementById('narrative_career_bg');
            
            // 레거시 지원 (이전 버전 호환)
            const legacyHighAlive = document.getElementById('narrative_high_alive');
            const legacyLost = document.getElementById('narrative_lost');

            if (q1 && q2) {
                // 새로운 동적 질문 형식
                window.narrativeFacts = {
                    // 스토리 질문 (공통)
                    storyAnswer: q0?.value?.trim() || '',
                    life_story: q0?.value?.trim() || '',
                    // 전공/이전 직업 (선택)
                    career_background: careerBg?.value?.trim() || '',
                    // 레거시 호환성 유지
                    highAliveMoment: q1.value.trim(),
                    lostMoment: q2.value.trim(),
                    // 새로운 구조
                    question1Answer: q1.value.trim(),
                    question2Answer: q2.value.trim(),
                    question1FactKey: q1.dataset.factKey,
                    question2FactKey: q2.dataset.factKey,
                    question1Id: q1.dataset.questionId,
                    question2Id: q2.dataset.questionId,
                };
            } else if (legacyHighAlive && legacyLost) {
                // 레거시 형식
                window.narrativeFacts = {
                    highAliveMoment: legacyHighAlive.value.trim(),
                    lostMoment: legacyLost.value.trim()
                };
            }
            return window.narrativeFacts || null;
        }

        // 서술형 필수 검증 (동적 질문 지원)
        function validateNarrativeRequired() {
            const isMinor = MINOR_STAGES.includes(selectedStage);
            if (isMinor) return true; // 미성년은 서술형 없음

            // 스토리 질문 (공통)
            const q0 = document.getElementById('narrative_q0');
            
            // 새로운 동적 질문 형식
            const q1 = document.getElementById('narrative_q1');
            const q2 = document.getElementById('narrative_q2');
            
            // 레거시 지원
            const legacyHighAlive = document.getElementById('narrative_high_alive');
            const legacyLost = document.getElementById('narrative_lost');
            
            const textarea1 = q1 || legacyHighAlive;
            const textarea2 = q2 || legacyLost;

            if (!textarea1 || !textarea2) return true; // 요소 없으면 패스

            // 스토리 질문 검증 (최소 30자)
            if (q0 && q0.value.trim().length < 30) {
                q0.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                q0.focus();
                alert('지금까지의 이야기를 30자 이상 작성해주세요.');
                return false;
            }

            const q1Valid = textarea1.value.trim().length >= 50;
            const q2Valid = textarea2.value.trim().length >= 50;

            if (!q1Valid) {
                textarea1.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                textarea1.focus();
                alert('첫 번째 질문에 50자 이상 작성해주세요.');
                return false;
            }

            if (!q2Valid) {
                textarea2.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                textarea2.focus();
                alert('두 번째 질문에 50자 이상 작성해주세요.');
                return false;
            }
            
            return true;
        }
        
        function renderUniversalQuestion(q, isMinor) {
            let optionsHtml = '';
            const requiredMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : '';
            const qId = q.question_id || q.id;  // question_id 또는 id 사용
            
            // 특별한 상황 질문인 경우 추가 설명 필드 포함
            const isLifeConstraint = qId === 'univ_life_constraint';
            
            if (q.ui_type === 'language_chips') {
                // 언어 선택 UI (수준 선택 + 기타 언어 입력 지원)
                const levels = q.levels || [
                    { value: 'basic', label: '일상회화' },
                    { value: 'business', label: '업무가능' },
                    { value: 'native', label: '원어민급' },
                ];
                optionsHtml = \`
                    <div class="language-selector" data-question-id="\${qId}" data-max-selections="\${q.max_selections || 5}">
                        <div class="flex flex-wrap gap-2 mb-3">
                            \${(q.options || []).map(opt => \`
                                <button type="button" onclick="toggleLanguageChip('\${qId}', '\${opt.value}', this, \${opt.hasInput || false})"
                                        class="lang-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                        data-value="\${opt.value}" data-has-level="\${opt.hasLevel || false}" data-has-input="\${opt.hasInput || false}">
                                    <span class="flex items-center gap-2">
                                        \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                        <span>\${opt.label}</span>
                                    </span>
                                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                </button>
                            \`).join('')}
                        </div>
                        
                        <!-- 언어 수준 선택 패널 (언어 선택 시 표시) -->
                        <div id="lang-level-panel-\${qId}" class="hidden mt-3 p-4 rounded-xl" style="background-color: rgba(15,15,35,0.8); border: 1px solid rgba(42,42,62,0.5);">
                            <p class="text-sm mb-3" style="color: rgb(148,163,184);">
                                <span id="lang-level-label-\${qId}">영어</span> 수준을 선택해주세요:
                            </p>
                            <div class="flex flex-wrap gap-2">
                                \${levels.map(lvl => \`
                                    <button type="button" onclick="selectLanguageLevel('\${qId}', '\${lvl.value}', this)"
                                            class="level-option px-4 py-2 rounded-lg border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-level="\${lvl.value}">
                                        \${lvl.label}
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                        
                        <!-- 기타 언어 입력 패널 -->
                        <div id="lang-other-panel-\${qId}" class="hidden mt-3 p-4 rounded-xl" style="background-color: rgba(15,15,35,0.8); border: 1px solid rgba(42,42,62,0.5);">
                            <p class="text-sm mb-3" style="color: rgb(148,163,184);">어떤 언어인가요?</p>
                            <div class="flex gap-2 flex-wrap">
                                <select id="lang-other-select-\${qId}" onchange="selectOtherLanguage('\${qId}', this.value)"
                                        class="px-4 py-2 rounded-lg border flex-shrink-0"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);">
                                    <option value="">선택...</option>
                                    <option value="vietnamese">베트남어</option>
                                    <option value="thai">태국어</option>
                                    <option value="indonesian">인도네시아어</option>
                                    <option value="russian">러시아어</option>
                                    <option value="portuguese">포르투갈어</option>
                                    <option value="arabic">아랍어</option>
                                    <option value="hindi">힌디어</option>
                                    <option value="italian">이탈리아어</option>
                                    <option value="dutch">네덜란드어</option>
                                    <option value="custom">직접 입력...</option>
                                </select>
                                <input type="text" id="lang-other-input-\${qId}" 
                                       placeholder="언어명 입력" 
                                       class="hidden px-4 py-2 rounded-lg border flex-1 min-w-[150px]"
                                       style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: #fff;"
                                       onchange="setCustomLanguage('\${qId}', this.value)">
                            </div>
                            <div class="mt-3">
                                <p class="text-sm mb-2" style="color: rgb(148,163,184);">수준:</p>
                                <div class="flex flex-wrap gap-2">
                                    \${levels.map(lvl => \`
                                        <button type="button" onclick="selectOtherLanguageLevel('\${qId}', '\${lvl.value}', this)"
                                                class="other-level-option px-4 py-2 rounded-lg border transition-all duration-200"
                                                style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                                data-level="\${lvl.value}">
                                            \${lvl.label}
                                        </button>
                                    \`).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 선택된 언어 표시 -->
                        <div id="lang-selected-\${qId}" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>
                    \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">최대 \${q.max_selections}개 선택 가능</p>\` : ''}
                \`;
            } else if (q.ui_type === 'chips' || q.ui_type === 'checkbox') {
                // 중복 옵션 필터링 (미니모듈에서 이미 선택된 항목)
                const duplicateOptions = window._duplicateOptionsMap?.[qId] || [];
                
                optionsHtml = \`
                    <div class="flex flex-wrap gap-2" data-question-id="\${qId}" data-max-selections="\${q.max_selections || 99}">
                        \${(q.options || []).map(opt => {
                            const isDuplicate = duplicateOptions.includes(opt.value);
                            if (isDuplicate) {
                                // 중복 옵션: 비활성화 상태로 표시 + "이미 선택됨" 표시
                                return \`
                                    <button type="button" disabled
                                            class="chip-option chip-duplicate group relative px-4 py-2.5 rounded-xl border transition-all duration-200 cursor-not-allowed"
                                            style="background-color: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.3); color: rgb(165,180,252); opacity: 0.7;"
                                            data-value="\${opt.value}" title="나를 알아가기 단계에서 이미 선택됨">
                                        <span class="flex items-center gap-2">
                                            \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                            <span>\${opt.label}</span>
                                            <span class="text-xs ml-1" style="color: rgb(129,140,248);">✓ 선택됨</span>
                                        </span>
                                    </button>
                                \`;
                            }
                            return \`
                                <button type="button" onclick="toggleChipOption('\${qId}', '\${opt.value}', this, false)"
                                        class="chip-option group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                        data-value="\${opt.value}">
                                    <span class="flex items-center gap-2">
                                        \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                        <span>\${opt.label}</span>
                                    </span>
                                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                </button>
                            \`;
                        }).join('')}
                        \${q.allow_unknown ? \`
                            <button type="button" onclick="toggleChipOption('\${qId}', '_unknown', this, true)"
                                    class="chip-option chip-unknown group relative px-4 py-2.5 rounded-xl border border-dashed transition-all duration-200"
                                    style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5); color: rgb(120,120,140);"
                                    data-value="_unknown">
                                <span class="flex items-center gap-2">
                                    <span class="text-lg">❓</span>
                                    <span>\${q.unknown_label}</span>
                                </span>
                                <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-slate-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                            </button>
                        \` : ''}
                    </div>
                    \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">최대 \${q.max_selections}개 선택 가능</p>\` : ''}
                    \${isLifeConstraint ? \`
                        <div id="life-constraint-detail" class="mt-4 hidden">
                            <label class="text-sm font-medium mb-2 block" style="color: rgb(148,163,184)">
                                <i class="fas fa-info-circle mr-1"></i>선택한 상황에 대해 더 자세히 알려주세요 (선택)
                            </label>
                            <textarea id="life_constraint_detail" 
                                      name="life_constraint_detail" 
                                      rows="3"
                                      placeholder="예: 장애의 종류, 돌봄 대상과 시간, 경제적 상황 등 구체적으로 적어주시면 더 정확한 추천이 가능해요"
                                      class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                      style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                                      onfocus="this.style.borderColor='rgba(67,97,238,0.5)';"
                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)'; updateLifeConstraintDetail(this.value);"></textarea>
                            <p class="text-xs mt-1" style="color: rgba(148,163,184,0.6)">입력한 내용은 추천 정확도를 높이는 데에만 사용됩니다</p>
                        </div>
                    \` : ''}
                \`;
            } else if (q.ui_type === 'radio') {
                optionsHtml = \`
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3" data-question-id="\${q.id}">
                        \${(q.options || []).map(opt => \`
                            <button type="button" onclick="selectRadioOption('\${q.id}', '\${opt.value}', this, false)"
                                    class="radio-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                    style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                    data-value="\${opt.value}">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                    </div>
                                    <span style="color: rgb(148,163,184)">\${opt.emoji || ''} \${opt.label}</span>
                                </div>
                            </button>
                        \`).join('')}
                        \${q.allow_unknown ? \`
                            <button type="button" onclick="selectRadioOption('\${q.id}', '_unknown', this, true)"
                                    class="radio-option radio-unknown group relative p-4 rounded-xl border border-dashed text-left transition-all duration-200"
                                    style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5);"
                                    data-value="_unknown">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full bg-slate-500 hidden radio-dot"></div>
                                    </div>
                                    <span style="color: rgb(120,120,140)">❓ \${q.unknown_label}</span>
                                </div>
                            </button>
                        \` : ''}
                    </div>
                \`;
            } else if (q.ui_type === 'text') {
                const privacyWarning = isMinor ? \`
                    <p class="text-xs text-yellow-400 mt-2">⚠️ 민감한 개인정보(주소/학교 이름/연락처/실명 등)는 작성하지 마세요.</p>
                \` : '';
                optionsHtml = \`
                    <textarea name="\${q.id}" rows="3" placeholder="\${q.placeholder || ''}"
                              class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                              style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                              onfocus="this.style.borderColor='rgba(67,97,238,0.5)';"
                              onblur="this.style.borderColor='rgba(42,42,62,0.5)';"></textarea>
                    \${privacyWarning}
                \`;
            }
            
            // help_text 표시
            const helpTextHtml = q.help_text ? \`<p class="text-xs mt-3 px-2 py-1.5 rounded-lg" style="color: rgb(147,197,253); background-color: rgba(59,130,246,0.1);">\${q.help_text}</p>\` : '';
            
            return \`
                <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                    <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                    \${optionsHtml}
                    \${helpTextHtml}
                </div>
            \`;
        }
        
        // 칩 옵션 토글 (복수 선택)
        function toggleChipOption(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const maxSelections = parseInt(container.dataset.maxSelections) || 99;
            const isSelected = btnEl.classList.contains('selected');
            
            if (isUnknown) {
                // "모르겠어요" 류 선택 시: 다른 모든 선택 해제
                container.querySelectorAll('.chip-option').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.style.backgroundColor = btn.classList.contains('chip-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                    btn.style.borderColor = btn.classList.contains('chip-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                    btn.style.color = btn.classList.contains('chip-unknown') ? 'rgb(120,120,140)' : 'rgb(148,163,184)';
                    btn.querySelector('.chip-check')?.classList.add('hidden');
                    btn.querySelector('.chip-check')?.classList.remove('flex');
                });
                
                if (!isSelected) {
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.style.color = '#94a3b8';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    
                    // 다른 옵션들 비활성화 표시
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                } else {
                    // 다른 옵션들 다시 활성화
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
            } else {
                // 일반 옵션 선택 시
                // 먼저 "모르겠어요" 해제
                const unknownBtn = container.querySelector('.chip-unknown');
                if (unknownBtn && unknownBtn.classList.contains('selected')) {
                    unknownBtn.classList.remove('selected');
                    unknownBtn.style.backgroundColor = 'rgba(15,15,35,0.5)';
                    unknownBtn.style.borderColor = 'rgba(100,100,120,0.5)';
                    unknownBtn.style.borderStyle = 'dashed';
                    unknownBtn.style.color = 'rgb(120,120,140)';
                    unknownBtn.querySelector('.chip-check')?.classList.add('hidden');
                    unknownBtn.querySelector('.chip-check')?.classList.remove('flex');
                    // 다른 옵션들 다시 활성화
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
                
                if (isSelected) {
                    // 선택 해제
                    btnEl.classList.remove('selected');
                    btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                    btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                    btnEl.style.color = 'rgb(148,163,184)';
                    btnEl.querySelector('.chip-check')?.classList.add('hidden');
                    btnEl.querySelector('.chip-check')?.classList.remove('flex');
                } else {
                    // 최대 선택 수 체크
                    const selectedCount = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)').length;
                    if (selectedCount >= maxSelections) {
                        // 가장 먼저 선택된 것 해제
                        const firstSelected = container.querySelector('.chip-option.selected:not(.chip-unknown)');
                        if (firstSelected) {
                            firstSelected.classList.remove('selected');
                            firstSelected.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            firstSelected.style.borderColor = 'rgba(42,42,62,0.5)';
                            firstSelected.style.color = 'rgb(148,163,184)';
                            firstSelected.querySelector('.chip-check')?.classList.add('hidden');
                            firstSelected.querySelector('.chip-check')?.classList.remove('flex');
                        }
                    }
                    
                    // 새 선택
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.style.color = '#34d399';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                }
            }
            
            // 특별한 상황 (univ_life_constraint) 추가 설명 필드 표시/숨김
            if (questionId === 'univ_life_constraint') {
                const detailContainer = document.getElementById('life-constraint-detail');
                if (detailContainer) {
                    const selectedCount = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)').length;
                    if (selectedCount > 0) {
                        detailContainer.classList.remove('hidden');
                    } else {
                        detailContainer.classList.add('hidden');
                    }
                }
            }
        }
        
        // 특별한 상황 추가 설명 업데이트
        function updateLifeConstraintDetail(value) {
            universalAnswers['life_constraint_detail'] = value;
        }
        
        // ============================================
        // 언어 선택 관련 함수들
        // ============================================
        // 선택된 언어 데이터 저장
        window.selectedLanguages = {};
        window.currentLangSelection = {};  // 현재 선택 중인 언어 정보
        
        // 언어 칩 토글
        function toggleLanguageChip(questionId, langValue, btnEl, hasInput) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const maxSelections = parseInt(container?.dataset?.maxSelections || '5');
            const isSelected = btnEl.classList.contains('selected');
            const hasLevel = btnEl.dataset.hasLevel === 'true';
            
            // 수준 패널 숨기기 (다른 언어 선택 시)
            const levelPanel = document.getElementById(\`lang-level-panel-\${questionId}\`);
            const otherPanel = document.getElementById(\`lang-other-panel-\${questionId}\`);
            
            if (isSelected) {
                // 선택 해제
                btnEl.classList.remove('selected');
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
                
                // 저장된 언어 데이터에서 제거
                if (window.selectedLanguages[questionId]) {
                    delete window.selectedLanguages[questionId][langValue];
                }
                
                // 패널 숨기기
                if (levelPanel) levelPanel.classList.add('hidden');
                if (otherPanel) otherPanel.classList.add('hidden');
                
                updateLanguageDisplay(questionId);
            } else {
                // 최대 선택 수 체크
                const currentCount = Object.keys(window.selectedLanguages[questionId] || {}).length;
                if (currentCount >= maxSelections) {
                    alert(\`최대 \${maxSelections}개까지 선택 가능합니다.\`);
                    return;
                }
                
                // 현재 선택 중인 언어 정보 저장
                window.currentLangSelection[questionId] = { 
                    lang: langValue, 
                    btnEl: btnEl,
                    hasLevel: hasLevel,
                    hasInput: hasInput
                };
                
                if (hasInput) {
                    // 기타 언어: 입력 패널 표시
                    if (levelPanel) levelPanel.classList.add('hidden');
                    if (otherPanel) {
                        otherPanel.classList.remove('hidden');
                        // 초기화
                        const select = document.getElementById(\`lang-other-select-\${questionId}\`);
                        const input = document.getElementById(\`lang-other-input-\${questionId}\`);
                        if (select) select.value = '';
                        if (input) { input.value = ''; input.classList.add('hidden'); }
                    }
                } else if (hasLevel) {
                    // 수준 선택 패널 표시
                    if (otherPanel) otherPanel.classList.add('hidden');
                    if (levelPanel) {
                        levelPanel.classList.remove('hidden');
                        const label = document.getElementById(\`lang-level-label-\${questionId}\`);
                        if (label) label.textContent = btnEl.querySelector('span span:last-child')?.textContent || langValue;
                        // 수준 버튼 초기화
                        levelPanel.querySelectorAll('.level-option').forEach(opt => {
                            opt.classList.remove('selected');
                            opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            opt.style.borderColor = 'rgba(42,42,62,0.5)';
                            opt.style.color = 'rgb(148,163,184)';
                        });
                    }
                } else {
                    // 수준 선택 없는 언어: 바로 선택 완료
                    completeLanguageSelection(questionId, langValue, 'business', btnEl);
                }
            }
        }
        window.toggleLanguageChip = toggleLanguageChip;
        
        // 언어 수준 선택
        function selectLanguageLevel(questionId, levelValue, btnEl) {
            const current = window.currentLangSelection[questionId];
            if (!current) return;
            
            // 수준 버튼 스타일 업데이트
            const panel = document.getElementById(\`lang-level-panel-\${questionId}\`);
            panel?.querySelectorAll('.level-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                opt.style.borderColor = 'rgba(42,42,62,0.5)';
                opt.style.color = 'rgb(148,163,184)';
            });
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            
            // 선택 완료
            completeLanguageSelection(questionId, current.lang, levelValue, current.btnEl);
            
            // 패널 숨기기
            if (panel) panel.classList.add('hidden');
        }
        window.selectLanguageLevel = selectLanguageLevel;
        
        // 기타 언어 드롭다운 선택
        function selectOtherLanguage(questionId, value) {
            const input = document.getElementById(\`lang-other-input-\${questionId}\`);
            if (value === 'custom') {
                input?.classList.remove('hidden');
                input?.focus();
            } else {
                input?.classList.add('hidden');
                if (input) input.value = '';
            }
            window.currentLangSelection[questionId].otherLang = value === 'custom' ? '' : value;
        }
        window.selectOtherLanguage = selectOtherLanguage;
        
        // 기타 언어 직접 입력
        function setCustomLanguage(questionId, value) {
            window.currentLangSelection[questionId].otherLang = value;
        }
        window.setCustomLanguage = setCustomLanguage;
        
        // 기타 언어 수준 선택
        function selectOtherLanguageLevel(questionId, levelValue, btnEl) {
            const current = window.currentLangSelection[questionId];
            if (!current || !current.otherLang) {
                alert('먼저 언어를 선택해주세요.');
                return;
            }
            
            // 수준 버튼 스타일 업데이트
            const panel = document.getElementById(\`lang-other-panel-\${questionId}\`);
            panel?.querySelectorAll('.other-level-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.style.backgroundColor = 'rgba(26,26,46,0.9)';
                opt.style.borderColor = 'rgba(42,42,62,0.5)';
                opt.style.color = 'rgb(148,163,184)';
            });
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            
            // 선택 완료 (기타 언어)
            const langKey = \`other_\${current.otherLang}\`;
            completeLanguageSelection(questionId, langKey, levelValue, current.btnEl);
            
            // 패널 숨기기 및 초기화
            if (panel) panel.classList.add('hidden');
            const select = document.getElementById(\`lang-other-select-\${questionId}\`);
            const input = document.getElementById(\`lang-other-input-\${questionId}\`);
            if (select) select.value = '';
            if (input) { input.value = ''; input.classList.add('hidden'); }
        }
        window.selectOtherLanguageLevel = selectOtherLanguageLevel;
        
        // 언어 선택 완료 처리
        function completeLanguageSelection(questionId, langValue, levelValue, btnEl) {
            // 저장 구조 초기화
            if (!window.selectedLanguages[questionId]) {
                window.selectedLanguages[questionId] = {};
            }
            
            // 언어+수준 저장
            window.selectedLanguages[questionId][langValue] = levelValue;
            
            // 칩 스타일 업데이트
            btnEl.classList.add('selected');
            btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
            btnEl.style.borderColor = '#10b981';
            btnEl.style.color = '#34d399';
            btnEl.querySelector('.chip-check')?.classList.remove('hidden');
            btnEl.querySelector('.chip-check')?.classList.add('flex');
            
            // 표시 업데이트
            updateLanguageDisplay(questionId);
            
            // 현재 선택 정보 초기화
            delete window.currentLangSelection[questionId];
        }
        
        // 선택된 언어 표시 업데이트
        function updateLanguageDisplay(questionId) {
            const displayContainer = document.getElementById(\`lang-selected-\${questionId}\`);
            if (!displayContainer) return;
            
            const langs = window.selectedLanguages[questionId] || {};
            const levelLabels = { basic: '일상회화', business: '업무가능', native: '원어민급' };
            const langLabels = {
                english: '영어', chinese: '중국어', japanese: '일본어',
                spanish: '스페인어', german: '독일어', french: '프랑스어',
                vietnamese: '베트남어', thai: '태국어', indonesian: '인도네시아어',
                russian: '러시아어', portuguese: '포르투갈어', arabic: '아랍어',
                hindi: '힌디어', italian: '이탈리아어', dutch: '네덜란드어'
            };
            
            displayContainer.innerHTML = Object.entries(langs).map(([lang, level]) => {
                const isOther = lang.startsWith('other_');
                const langName = isOther 
                    ? (langLabels[lang.replace('other_', '')] || lang.replace('other_', ''))
                    : (langLabels[lang] || lang);
                const levelName = levelLabels[level] || level;
                
                return \`
                    <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm"
                          style="background-color: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #34d399;">
                        \${langName} (\${levelName})
                        <button type="button" onclick="removeSelectedLanguage('\${questionId}', '\${lang}')" 
                                class="hover:text-red-400 transition-colors">&times;</button>
                    </span>
                \`;
            }).join('');
            
            // universalAnswers 업데이트
            const values = Object.entries(langs).map(([lang, level]) => \`\${lang}_\${level}\`);
            if (values.length > 0) {
                universalAnswers[questionId] = values;
            } else {
                delete universalAnswers[questionId];
            }
        }
        
        // 선택된 언어 제거
        function removeSelectedLanguage(questionId, langValue) {
            if (window.selectedLanguages[questionId]) {
                delete window.selectedLanguages[questionId][langValue];
            }
            
            // 칩 버튼 스타일 초기화
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const btn = container?.querySelector(\`[data-value="\${langValue}"]\`);
            if (btn) {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.style.color = 'rgb(148,163,184)';
                btn.querySelector('.chip-check')?.classList.add('hidden');
                btn.querySelector('.chip-check')?.classList.remove('flex');
            }
            
            // other 버튼의 경우 특별 처리
            if (langValue.startsWith('other_')) {
                const otherBtn = container?.querySelector('[data-value="other"]');
                if (otherBtn) {
                    // 다른 other 언어가 없으면 버튼 스타일 초기화
                    const hasOtherLangs = Object.keys(window.selectedLanguages[questionId] || {}).some(k => k.startsWith('other_'));
                    if (!hasOtherLangs) {
                        otherBtn.classList.remove('selected');
                        otherBtn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                        otherBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                        otherBtn.style.color = 'rgb(148,163,184)';
                        otherBtn.querySelector('.chip-check')?.classList.add('hidden');
                        otherBtn.querySelector('.chip-check')?.classList.remove('flex');
                    }
                }
            }
            
            updateLanguageDisplay(questionId);
        }
        window.removeSelectedLanguage = removeSelectedLanguage;
        
        // ============================================
        
        // 라디오 옵션 선택 (단일 선택)
        function selectRadioOption(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const isSelected = btnEl.classList.contains('selected');
            
            // 모든 옵션 선택 해제
            container.querySelectorAll('.radio-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = btn.classList.contains('radio-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                btn.style.borderColor = btn.classList.contains('radio-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
                btn.classList.remove('disabled-by-unknown');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
            
            if (!isSelected) {
                // 새 선택
                btnEl.classList.add('selected');
                
                if (isUnknown) {
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#64748b';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    
                    // 다른 옵션들 비활성화 표시
                    container.querySelectorAll('.radio-option:not(.radio-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                } else {
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                }
            }
        }
        
        // ============================================
        // Universal 답변 수집
        // ============================================
        function collectUniversalAnswers() {
            universalAnswers = {};
            UNIVERSAL_QUESTIONS.forEach(q => {
                if (q.ui_type === 'language_chips') {
                    // 언어 선택 UI: window.selectedLanguages에서 가져옴
                    const langs = window.selectedLanguages?.[q.id] || {};
                    const values = Object.entries(langs).map(([lang, level]) => \`\${lang}_\${level}\`);
                    if (values.length > 0) universalAnswers[q.id] = values;
                } else if (q.ui_type === 'chips' || q.ui_type === 'checkbox') {
                    const container = document.querySelector(\`[data-question-id="\${q.id}"]\`);
                    if (container) {
                        const selected = container.querySelectorAll('.chip-option.selected:not(.chip-unknown)');
                        const values = Array.from(selected).map(btn => btn.dataset.value);
                    if (values.length > 0) universalAnswers[q.id] = values;
                    }
                } else if (q.ui_type === 'radio') {
                    const container = document.querySelector(\`[data-question-id="\${q.id}"]\`);
                    if (container) {
                        const selected = container.querySelector('.radio-option.selected:not(.radio-unknown)');
                        if (selected) universalAnswers[q.id] = selected.dataset.value;
                    }
                } else if (q.ui_type === 'text') {
                    const textarea = document.querySelector(\`textarea[name="\${q.id}"]\`);
                    if (textarea && textarea.value.trim()) universalAnswers[q.id] = textarea.value.trim();
                }
            });
            return universalAnswers;
        }
        
        // ============================================
        // Step 2 → Step 3 or Step 4
        // ============================================
        async function submitUniversalAndContinue() {
            collectUniversalAnswers();
            showLoading('답변 분석 중...', '심화 질문을 구성하고 있어요');
            
            // API 호출하여 follow-up 질문 받기
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                console.log('Analysis response (for followups):', data);
                hideLoading();
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(3);
                } else {
                    // Follow-up 질문이 없으면 바로 결과로
                    currentRequestId = data.request_id;
                    displayResults(data);
                    goToStep(3); // 결과 (3단계 구조)
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        async function submitUniversalAndAnalyze() {
            collectUniversalAnswers();
            const btn = document.getElementById('analyze-btn-quick');
            if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>분석 중...';
            }
            showLoading('AI가 분석 중...', '맞춤 추천을 구성하고 있어요');
            
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                console.log('Analysis response:', data);
                
                if (!response.ok) throw new Error(data.error || 'API 오류');
                
                currentRequestId = data.request_id;
                displayResults(data);
                goToStep(3); // 결과 (3단계 구조)
            } catch (error) {
                console.error('Error:', error);
                alert('분석 중 오류가 발생했습니다: ' + error.message);
            } finally {
                hideLoading();
                if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>바로 결과 보기';
                }
            }
        }
        
        // ============================================
        // Step 2: Follow-up Questions 렌더링 (고급 UI) - 3단계 구조
        // ============================================
        function renderFollowupQuestions(questions) {
            const container = document.getElementById('followup-questions-form');
            container.innerHTML = questions.slice(0, 5).map((q, idx) => \`
                <div class="followup-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="followup_\${q.id}">
                    <div class="flex items-start gap-4 mb-4">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white;">\${idx + 1}</span>
                        <h4 class="font-semibold text-white text-lg leading-relaxed">\${q.question}</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 ml-12">
                        \${(q.options || []).map(opt => \`
                            <button type="button" onclick="selectFollowupOption('followup_\${q.id}', '\${opt.value}', '\${q.fact_key}', this)"
                                    class="followup-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                    style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                    data-value="\${opt.value}" data-fact-key="\${q.fact_key}">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                         style="border-color: rgba(100,100,120,0.5);">
                                        <div class="w-2.5 h-2.5 rounded-full hidden radio-dot" style="background: linear-gradient(135deg, #a855f7, #6366f1);"></div>
                                    </div>
                                    <span style="color: rgb(148,163,184)">\${opt.label}</span>
                                </div>
                            </button>
                        \`).join('')}
                    </div>
                </div>
            \`).join('');
        }
        
        function selectFollowupOption(questionId, value, factKey, btnEl) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            const isSelected = btnEl.classList.contains('selected');
            
            // 같은 질문의 다른 버튼들 선택 해제
            container.querySelectorAll('.followup-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                btnEl.classList.add('selected');
                btnEl.style.backgroundColor = 'rgba(168,85,247,0.2)';
                btnEl.style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-circle').style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            }
        }
        
        async function submitFollowupsAndAnalyze() {
            const btn = document.getElementById('analyze-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>분석 중...';
            showLoading('AI가 분석 중...', '맞춤 추천을 구성하고 있어요');
            
            // Followup 답변 수집 및 제출 (새 UI 방식)
            try {
                const selectedOptions = document.querySelectorAll('#followup-questions-form .followup-option.selected');
                for (const btn of selectedOptions) {
                    const factKey = btn.dataset.factKey;
                    const answer = btn.dataset.value;
                    const container = btn.closest('[data-question-id]');
                    const questionId = container.dataset.questionId.replace('followup_', '');
                    
                    await fetch('/api/ai-analyzer/followup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            question_id: questionId,
                            fact_key: factKey,
                            answer: answer,
                        })
                    });
                }
                
                // 재분석
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API 오류');
                
                currentRequestId = data.request_id;
                displayResults(data);
                goToStep(3); // 결과 (3단계 구조)
            } catch (error) {
                console.error('Error:', error);
                alert('분석 중 오류가 발생했습니다: ' + error.message);
            } finally {
                hideLoading();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>AI 추천 시작하기';
            }
        }
        
        // ============================================
        // Step 4: 결과 표시 (V3: 프리미엄 리포트 지원)
        // ============================================
        function displayResults(data) {
            // 결과가 없는 경우 처리
            if (!data || !data.result) {
                console.error('[displayResults] No result data:', data);
                showErrorToast('분석 결과를 불러올 수 없습니다: ' + (data?.error || '데이터가 없습니다'));
                return;
            }
            
            const result = data.result;

            // mini_module_result 복원 (DB에서 로드 시 window에 없을 수 있음)
            if (result.mini_module_result && !window.miniModuleResult) {
                window.miniModuleResult = result.mini_module_result;
                console.log('[displayResults] Restored miniModuleResult from result data');
            }

            // V3: 프리미엄 리포트가 있으면 새 UI로 표시
            if (result.premium_report || result.engine_version === 'v3') {
                displayPremiumReportV3(result);
                return;
            }
            
            // V2 기존 로직
            const top3 = result.fit_top3 || [];
            
            // User Insight 표시
            displayUserInsight(result.user_insight);
            
            // Confidence UI 표시
            displayConfidenceUI(result);
            
            // TOP3 표시 (썸네일 + 링크 포함, 점수는 토글)
            const top3Html = top3.map((job, idx) => \`
                <div class="bg-wiki-bg p-4 rounded-xl border border-wiki-border group">
                    <a href="/job/\${job.slug || job.job_id}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        \${job.image_url ? \`
                            <div class="mb-3 overflow-hidden rounded-lg">
                                <img src="\${job.image_url}" alt="\${job.job_name}" class="w-full h-32 object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">\${idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉'}</span>
                            <span class="text-lg font-bold group-hover:text-wiki-primary transition">\${job.job_name}</span>
                        </div>
                        <div class="text-xs text-wiki-primary opacity-0 group-hover:opacity-100 transition">자세히 보기 →</div>
                    </a>
                    <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>상세 점수 보기</span>
                        <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                    </button>
                    <div class="score-details hidden mt-2 pt-2 border-t border-wiki-border/30">
                        <div class="text-sm text-wiki-muted mb-2">Fit: \${job.fit_score}</div>
                        <div class="flex gap-2 text-xs">
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">Like: \${job.like_score}</span>
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded">Can: \${job.can_score}</span>
                        </div>
                    </div>
                </div>
            \`).join('');
            document.getElementById('top3-results').innerHTML = top3Html || '<p class="text-wiki-muted col-span-3 text-center">추천 결과가 없습니다.</p>';
            
            // 디버그 패널 (debug=true)
            if (DEBUG_MODE) {
                updateDebugPanel(result, data);
            }
            
            // 추가 Follow-up 질문 (있으면)
            if (result.followup_questions?.length > 0) {
                displayResultFollowup(result.followup_questions[0]);
            }
            
            previousTop3 = top3.map(j => j.job_name);
        }
        
        // ============================================
        // V3: 프리미엄 리포트 UI
        // ============================================
        
        // 영어 용어 → 한국어 변환 맵
        const STAGE_LABELS = {
            job_explore: '탐색 단계',
            job_student: '학생 단계',
            job_prepare: '취업 준비',
            job_early: '초기 커리어 (0~3년)',
            job_mid: '경력자 (3년+)',
            job_transition: '전환/복귀',
            job_second: '세컨드 커리어',
        };
        
        const VALUE_LABELS = {
            recognition: '인정받고 영향력 발휘',
            stability: '안정성',
            income: '높은 수입',
            growth: '성장',
            autonomy: '자율성',
            meaning: '의미/사회 기여',
            wlb: '워라밸',
            balance: '일과 삶의 균형',
            expertise: '전문성',
            creativity: '창의성',
        };

        // 워크스타일 변환 맵 (백엔드 TOKEN_TO_KOREAN과 동기화)
        const WORKSTYLE_LABELS = {
            solo: '혼자 집중',
            solo_deep: '혼자 깊이 집중',
            team: '팀 협업',
            team_harmony: '팀 조화',
            mixed: '상황에 따라',
            structured: '체계적 환경',
            flexible: '자유로운 환경',
        };

        // 관심 영역 변환 맵
        const INTEREST_LABELS = {
            problem_solving: '문제 해결',
            data_numbers: '데이터/숫자',
            tech: '기술/IT',
            creative: '창작/예술',
            people: '사람/소통',
            helping: '돌봄/봉사',
            business: '비즈니스/경영',
            nature: '자연/환경',
            physical: '신체 활동',
            research: '연구/탐구',
            teaching: '교육/가르침',
            analysis: '분석',
            design: '디자인',
            writing: '글쓰기',
            hands_on: '손으로 만들기',
        };

        // 강점 변환 맵 (백엔드 TOKEN_TO_KOREAN과 동기화)
        const STRENGTH_LABELS = {
            // 백엔드 기본 토큰
            analytical: '분석력',
            creative: '창의력',  // 백엔드는 creative (creativity 아님)
            communication: '소통력',
            structured_execution: '실행력',  // ★ 누락됐던 토큰!
            persistence: '끈기',  // 백엔드는 persistence (perseverance 아님)
            fast_learning: '학습력',
            // 추가 토큰
            leadership: '리더십',
            detail_oriented: '꼼꼼함',
            patience: '인내심',
            empathy: '공감 능력',
            organization: '체계적 정리',
            adaptability: '적응력',
            perseverance: '끈기',  // 호환용 유지
            creativity: '창의성',  // 호환용 유지
            strategic: '전략적 사고',
            teamwork: '팀워크',
            independence: '독립적 업무',
        };

        // 에너지 소진 요인 변환 맵 (백엔드 TOKEN_TO_KOREAN과 동기화)
        const DRAIN_LABELS = {
            // 백엔드 기본 토큰
            people_drain: '대인관계 스트레스',
            cognitive_drain: '인지 피로',
            time_pressure_drain: '시간 압박 스트레스',
            responsibility_drain: '책임 스트레스',
            repetition_drain: '반복 피로',
            unpredictability_drain: '불확실성 스트레스',
            routine_drain: '반복 업무 피로',
            bureaucracy_drain: '관료주의 스트레스',
            // 호환용
            pressure_drain: '마감 압박',
            conflict_drain: '갈등 상황',
            isolation_drain: '고립된 환경',
            physical_drain: '신체적 피로',
            uncertainty_drain: '불확실성',
        };

        // 희생 가능 요소 변환 맵 (백엔드 TOKEN_TO_KOREAN과 동기화)
        const SACRIFICE_LABELS = {
            // 백엔드 기본 토큰
            low_initial_income: '낮은 초봉 감수',
            willing_to_study: '재학습 감수',
            field_change_ok: '분야 전환 감수',
            ignore_social_pressure: '주변 시선 감수',
            no_sacrifice: '포기 불가',
            unstable_hours: '불규칙한 시간 감수',
            long_hours_ok: '긴 근무시간 감수',
            // 호환용
            long_hours: '긴 근무시간',
            relocation: '거주지 이동',
            unstable_early: '초기 불안정 감수',
        };

        // 제약조건 변환 맵 (미니모듈 및 백엔드 constraint 토큰)
        const CONSTRAINT_LABELS = {
            // 미니모듈 기본 제약 토큰
            time_constraint: '시간 제약',
            income_constraint: '수입 조건',
            location_constraint: '위치 제약',
            physical_constraint: '체력 제약',
            qualification_constraint: '자격 제약',
            uncertainty_constraint: '불확실성 회피',
            health_constraint: '건강 제약',
            // 백엔드 confirmed_constraint 토큰
            work_hours_strict: '불규칙한 근무시간',
            no_travel: '출장 불가',
            no_overtime: '야근 불가',
            remote_only: '재택만 가능',
            remote_preferred: '재택 선호',
            prefer_remote: '재택 선호',
            shift_work_no: '교대근무 불가',
            degree_impossible: '학위 취득 어려움',
            license_impossible: '자격 취득 어려움',
            travel_impossible: '출장 불가',
            prefer_low_overtime: '야근 최소화',
            // 기타 제약
            no_shift: '교대근무 불가',
            no_weekend: '주말 근무 불가',
            no_physical: '육체노동 불가',
            no_outdoor: '야외근무 불가',
            no_repetitive: '반복 업무 회피',
            no_social_stress: '대인 스트레스 회피',
            no_relocation: '이사/출장 불가',
        };

        // 영어 용어를 한국어로 변환하는 헬퍼 함수
        // 템플릿 리터럴에 안전하게 삽입하기 위한 이스케이프 함수
        function escapeTemplateString(str) {
            if (!str) return str;
            // $와 백틱을 HTML 엔티티로 치환하여 템플릿 리터럴 파싱 에러 방지
            const backtick = String.fromCharCode(96);
            return String(str).replace(/\\$/g, '&#36;').replace(new RegExp(backtick, 'g'), '&#96;');
        }

        function translateToKorean(text) {
            if (!text) return text;
            let result = String(text);

            // 모든 레이블 맵 합치기
            const ALL_LABELS = {
                ...STAGE_LABELS,
                ...VALUE_LABELS,
                ...WORKSTYLE_LABELS,
                ...INTEREST_LABELS,
                ...STRENGTH_LABELS,
                ...DRAIN_LABELS,
                ...SACRIFICE_LABELS,
                ...CONSTRAINT_LABELS,
            };

            // 정확히 일치하는 경우 먼저 처리
            if (ALL_LABELS[result]) {
                return ALL_LABELS[result];
            }

            // 부분 문자열 치환 (언더스코어 포함 키를 먼저 처리)
            const sortedEntries = Object.entries(ALL_LABELS)
                .sort((a, b) => b[0].length - a[0].length);

            for (const [eng, kor] of sortedEntries) {
                result = result.replace(new RegExp(eng.replace(/_/g, '[_\\\\s]?'), 'gi'), kor);
            }

            // 템플릿 리터럴 안전성을 위해 이스케이프
            return escapeTemplateString(result);
        }
        
        function displayPremiumReportV3(result) {
            const report = result.premium_report || {};
            
            // PremiumReport 타입 데이터 매핑 (백엔드 실제 필드에 맞춤)
            // 백엔드 실제 필드: executiveSummary, workStyleNarrative, innerConflictAnalysis 등
            const summary = {
                headline: report.executiveSummary || report.summary_one_page?.headline || '',
                top_takeaways: report.lifeVersionStatement?.expanded || report.summary_one_page?.top_takeaways || [],
                recommended_next_step: report.expertGuidance?.doNow?.[0] || report.summary_one_page?.recommended_next_step || '',
            };
            
            // 심리 분석 데이터 매핑 (미니모듈 결과 + 백엔드 분석 결과 활용)
            const mm = window.miniModuleResult || {};

            // workStyleNarrative 텍스트 정리 함수
            function cleanWorkStyleNarrative(text) {
                if (!text) return null;
                let cleaned = text;
                // 1. 괄호 안의 Top2/선호/강점 정보 제거 (흥미 Top2: ...), (가치 Top2: ...), (환경 선호: ...), (강점 Top2: ...) 등
                cleaned = cleaned.replace(/\\([^)]*(?:Top2|선호|강점)[^)]*\\)/g, '');
                // 2. 두 번째 이후의 "당신은" 제거 (첫 번째만 유지)
                const parts = cleaned.split('당신은');
                if (parts.length > 2) {
                    // 첫 번째 "당신은"만 유지하고 나머지는 연결
                    cleaned = parts[0] + '당신은' + parts.slice(1).join('');
                }
                // 3. 연속된 공백 정리
                cleaned = cleaned.replace(/\\s+/g, ' ').trim();
                return cleaned;
            }

            const personal = {
                personality_summary: cleanWorkStyleNarrative(report.workStyleNarrative) ||
                    (report.lifeVersionStatement?.oneLiner) ||
                    (mm.interest_top?.length ? generatePersonalitySummary(mm) : null),
                work_style_insights: [
                    report.workStyleMap?.socialStyle ? \`\${translateToKorean(report.workStyleMap.socialStyle)} 업무 스타일을 선호합니다\` : null,
                    report.workStyleMap?.decisionStyle ? \`의사결정 시 \${translateToKorean(report.workStyleMap.decisionStyle)} 접근을 취합니다\` : null,
                    report.growthCurveDescription || null,
                    ...(report.personal_analysis?.work_style_insights || []),
                ].filter(Boolean),
                value_priorities: mm.value_top?.map(v => translateToKorean(v)) || 
                    report.personal_analysis?.value_priorities || [],
                potential_challenges: [
                    ...(report.stressTriggers || []),
                    ...(report.conflictPatterns || []),
                    ...(report.personal_analysis?.potential_challenges || []),
                ].slice(0, 3),
                blind_spots_to_check: report.failurePattern ? [report.failurePattern] : 
                    (report.personal_analysis?.blind_spots_to_check || []),
            };
            
            const hypotheses = report.key_hypotheses || {};
            const topRecs = report.recommendations_top || {};
            const holdRecs = report.recommendations_hold || {};
            const planB = report.plan_b_paths || {};
            const nextQ = report.next_questions || {};

            // ============================================
            // V3 심리 분석 추가 데이터 매핑
            // ============================================

            // 내면 갈등 분석
            const innerConflict = {
                analysis: report.innerConflictAnalysis || '',
                patterns: report.conflictPatterns || [],
            };

            // 성장 곡선
            const growthCurve = {
                type: report.growthCurveType || '',
                description: report.growthCurveDescription || '',
            };

            // 스트레스 프로필
            const stressProfile = {
                profile: report.stressProfile || '',
                triggers: report.stressTriggers || [],
                failurePattern: report.failurePattern || '',
            };

            // 프로필 해석 (LLM 생성)
            const profileInterpretation = report.profileInterpretation || null;
            console.log('[DEBUG] profileInterpretation:', profileInterpretation);
            console.log('[DEBUG] report keys:', Object.keys(report));

            // 전환 타이밍 (30/60/90일 계획)
            const transitionTiming = report.transitionTiming || {
                day30: { goal: '', actions: [], milestone: '' },
                day60: { goal: '', actions: [], milestone: '' },
                day90: { goal: '', actions: [], milestone: '' },
            };

            // 인생 버전 선언문
            const lifeVersion = {
                oneLiner: report.lifeVersionStatement?.oneLiner || '',
                expanded: report.lifeVersionStatement?.expanded || [],
            };

            // 전문가 가이던스
            const expertGuidance = report.expertGuidance || {
                doNow: [],
                stopDoing: [],
                learnNext: [],
                avoidPaths: [],
            };

            // 작업 스타일 맵 (5축)
            const workStyleMap = report.workStyleMap || {
                analytical_vs_creative: 0,
                solo_vs_team: 0,
                structured_vs_flexible: 0,
                depth_vs_breadth: 0,
                guided_vs_autonomous: 0,
            };

            // 메타인지 분석 결과
            const metaCognition = report.metaCognition || null;
            console.log('[DEBUG] metaCognition:', metaCognition);

            // 한국어 받침 판별 (조사 선택용)
            function hasBatchim(word) {
                if (!word || word.length === 0) return false;
                const last = word.charCodeAt(word.length - 1);
                if (last >= 0xAC00 && last <= 0xD7A3) return (last - 0xAC00) % 28 !== 0;
                if (last >= 0x30 && last <= 0x39) return [0, 1, 3, 6, 7, 8].includes(last - 0x30);
                return false;
            }

            // 성격 요약 생성 헬퍼 (미니모듈 기반)
            function generatePersonalitySummary(mm) {
                const parts = [];
                if (mm.interest_top?.length) {
                    const items = mm.interest_top.map(t => translateToKorean(t));
                    const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? '과 ' : '와 ') + items[items.length - 1] : items[0];
                    parts.push(\`\${joined}에 관심을 가지고 있으며\`);
                }
                if (mm.value_top?.length) {
                    const items = mm.value_top.map(t => translateToKorean(t));
                    const lastItem = items[items.length - 1];
                    const joined = items.length > 1 ? items.slice(0, -1).join(', ') + (hasBatchim(items[items.length - 2]) ? '과 ' : '와 ') + lastItem : lastItem;
                    const particle = hasBatchim(lastItem) ? '을' : '를';
                    parts.push(\`\${joined}\${particle} 중요하게 여기는\`);
                }
                if (mm.strength_top?.length) {
                    const items = mm.strength_top.map(t => translateToKorean(t));
                    parts.push(\`\${items.join(', ')}에서 강점을 보이는\`);
                }
                if (parts.length === 0) return null;
                return parts.join(' ') + ' 분입니다.';
            }
            
            // 직업 추천 데이터 - result.fit_top3 우선 사용 (직업 이름, 썸네일 포함)
            const fitTop3 = result.fit_top3 || [];
            const jobRecs = report.jobRecommendations || {};
            
            // overallTop5: fit_top3 우선, 부족하면 jobRecommendations에서 보충
            const overallTop5 = fitTop3.length > 0 ? fitTop3.slice(0, 5) : (jobRecs.overallTop5 || topRecs.recommendations || []);
            
            // fitTop10: can_top10 또는 fit_top3 확장 (반드시 10개로 제한)
            const fitTop10 = (result.can_top10 || fitTop3 || []).slice(0, 10);
            
            // likeTop10: like_top10 또는 desireTop10 (반드시 10개로 제한)
            const likeTop10 = (result.like_top10 || jobRecs.desireTop10 || []).slice(0, 10);
            
            // 결과 컨테이너 초기화 (3단계 구조: step3 = 결과)
            const container = document.getElementById('step3');
            if (!container) return;

            // 커리어 비전 섹션 HTML 사전 계산 (중첩 템플릿 리터럴 문제 방지)
            let careerVisionHtml = '';
            if (lifeVersion.oneLiner) {
                let profileDesc = '';
                if (profileInterpretation) {
                    const pi = profileInterpretation;
                    const parts = [];
                    if (pi.interests?.length > 0) {
                        parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>에 관심이 있고');
                    }
                    if (pi.strengths?.length > 0) {
                        parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>이 강점이며');
                    }
                    if (pi.values?.length > 0) {
                        parts.push('<span class="text-purple-400">' + translateToKorean(pi.values[0].label) + '</span>을 중시하는 당신을 위한 맞춤 분석입니다.');
                    }
                    if (parts.length > 0) {
                        // 마지막 파트에 문장 종결이 없으면 추가
                        const joined = parts.join(', ');
                        const finalText = joined.endsWith('.') ? joined : joined + '의 프로필입니다.';
                        profileDesc = '<p class="text-[15px] text-wiki-muted mt-3 leading-relaxed">' + finalText + '</p>';
                    }
                }
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.3);"><p class="text-lg md:text-xl font-semibold leading-relaxed" style="color: rgb(251,191,36);">"' + translateToKorean(lifeVersion.oneLiner) + '"</p>' + profileDesc + '</div>';
            } else if (personal.personality_summary) {
                const highlightedText = personal.personality_summary.replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">&#39;$1&#39;</strong>');
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">💫 ' + highlightedText + '</p></div>';
            } else if (profileInterpretation) {
                const pi = profileInterpretation;
                const parts = [];
                if (pi.interests?.length > 0) {
                    parts.push('<span class="text-green-400">' + translateToKorean(pi.interests[0].label) + '</span>을 좋아하고');
                }
                if (pi.strengths?.length > 0) {
                    parts.push('<span class="text-blue-400">' + translateToKorean(pi.strengths[0].label) + '</span>에 강점을 가진');
                }
                if (pi.values?.length > 0) {
                    const valLabel = translateToKorean(pi.values[0].label);
                    parts.push('<span class="text-purple-400">' + valLabel + '</span>' + (hasBatchim(valLabel) ? '을' : '를') + ' 중요하게 여기는');
                }
                const summaryText = parts.length > 0 ? '당신은 ' + parts.join(', ') + ' 사람입니다.' : '당신의 커리어 프로필을 분석했습니다.';
                careerVisionHtml = '<div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);"><p class="text-lg leading-relaxed text-white">💫 ' + summaryText + '</p></div>';
            }

            // 탭 UI 생성
            container.innerHTML = \`
                <!-- V3 프리미엄 리포트 헤더 -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2)); border: 1px solid rgba(99,102,241,0.3);">
                        <span class="text-lg">✨</span>
                        <span class="text-sm font-medium" style="color: rgb(165,180,252);">프리미엄 리포트 V3</span>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold mb-2">당신만의 커리어 분석 리포트</h2>
                    <p class="text-wiki-muted mb-4">AI가 분석한 당신의 커리어 방향성</p>
                    <!-- 테스트용 버튼들 -->
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button onclick="copyAllReportContent()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition" style="background: rgba(67, 97, 238, 0.2); color: #64b5f6; border: 1px solid rgba(67, 97, 238, 0.3);">
                            <i class="fas fa-copy"></i> 결과 전체 복사
                        </button>
                        <button onclick="resetAnalyzer()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <i class="fas fa-redo"></i> 처음부터 다시
                        </button>
                    </div>
                </div>
                
                <!-- 탭 네비게이션 -->
                <div class="flex justify-center gap-1 mb-6 flex-wrap" id="report-tabs">
                    <button onclick="showReportTab('summary')" class="report-tab active px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="summary">요약</button>
                    <button onclick="showReportTab('psychology')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="psychology">메타인지</button>
                    <button onclick="showReportTab('recommendations')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="recommendations">추천 직업</button>
                    <button onclick="showReportTab('details')" class="report-tab px-6 py-3 rounded-xl text-base font-semibold transition" data-tab="details" title="분석 상세">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                
                <!-- 탭 컨텐츠: 요약 -->
                <div id="tab-summary" class="report-tab-content glass-card p-6 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">📋</span>
                            <span class="bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">요약</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">당신의 커리어 분석 핵심을 한눈에 확인하세요.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                    </div>

                    <!-- ✨ 커리어 비전 (요약 탭 첫 섹션) -->
                    <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                        <span>✨</span> 커리어 비전
                    </h4>
                    \${careerVisionHtml}

                    <!-- 📊 메타인지 요약 (요약 탭) -->
                    \${metaCognition ? \`
                        <div class="mt-8 mb-8">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>📊</span> 메타인지
                                <button onclick="showReportTab('psychology')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                                    <span>자세히 보기</span>
                                    <i class="fas fa-chevron-right text-[10px]"></i>
                                </button>
                            </h4>

                            \${(() => {
                                const metaSummarySections = [
                                    metaCognition.myArsenal?.strengths?.length > 0 ? 'strengths' : null,
                                    profileInterpretation?.values?.length > 0 ? 'values' : null,
                                    metaCognition.stressRecovery?.stressFactors?.length > 0 ? 'stress' : null,
                                ].filter(Boolean);
                                const metaSummaryCount = metaSummarySections.length;
                                const metaSummaryGridClass = metaSummaryCount <= 1 ? 'grid grid-cols-1 gap-4' : metaSummaryCount === 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 md:grid-cols-3 gap-4';
                                return '<div class="' + metaSummaryGridClass + '">';
                            })()}
                                <!-- 핵심 강점 -->
                                \${metaCognition.myArsenal?.strengths?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">💪</span>
                                            <h5 class="font-bold text-green-400 text-[15px]">핵심 강점</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${metaCognition.myArsenal.strengths.slice(0, 3).map(s => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">\${translateToKorean(s.trait)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}

                                <!-- 핵심 가치 -->
                                \${profileInterpretation?.values?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">⭐</span>
                                            <h5 class="font-bold text-purple-400 text-[15px]">핵심 가치</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${profileInterpretation.values.slice(0, 3).map(v => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(168,85,247,0.15); color: rgb(216,180,254);">\${translateToKorean(v.label)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}

                                <!-- 스트레스 주의점 -->
                                \${metaCognition.stressRecovery?.stressFactors?.length > 0 ? \`
                                    <div class="p-4 rounded-xl" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">⚠️</span>
                                            <h5 class="font-bold text-red-400 text-[15px]">주의점</h5>
                                            <span class="relative group cursor-help">
                                                <i class="fas fa-question-circle text-wiki-muted text-xs"></i>
                                                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 rounded-lg text-xs text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50" style="background: rgba(30,30,40,0.95); border: 1px solid rgba(255,255,255,0.1);">이 항목들은 에너지가 소모되거나 스트레스를 유발할 수 있는 요인입니다.<br/>커리어 선택 시 이 요인들을 고려하면 번아웃을 예방할 수 있습니다.</span>
                                            </span>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5">
                                            \${metaCognition.stressRecovery.stressFactors.slice(0, 2).map(s => \`
                                                <span class="px-2.5 py-1 rounded text-[15px] font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">\${translateToKorean(s.factor)}</span>
                                            \`).join('')}
                                        </div>
                                    </div>
                                \` : ''}
                            </div>
                        </div>
                    \` : ''}

                    <!-- 🆕 나의 커리어 프로필 (프로필 해석) -->
                    \${profileInterpretation ? \`
                        <div class="mt-8 mb-8">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>🧬</span> 나의 커리어 프로필
                            </h4>

                            \${(() => {
                                const profileSections = [
                                    profileInterpretation.interests?.length > 0 ? 'interests' : null,
                                    profileInterpretation.strengths?.length > 0 ? 'strengths' : null,
                                    profileInterpretation.values?.length > 0 ? 'values' : null,
                                    profileInterpretation.constraints?.length > 0 ? 'constraints' : null
                                ].filter(Boolean);
                                const profileCount = profileSections.length;
                                const profileGridClass = profileCount <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';
                                const profileIsOdd = profileCount > 1 && profileCount % 2 === 1;
                                const profileLastSection = profileSections[profileCount - 1];
                                const interestsSpan = profileIsOdd && profileLastSection === 'interests' ? 'md:col-span-2' : '';
                                const strengthsSpan = profileIsOdd && profileLastSection === 'strengths' ? 'md:col-span-2' : '';
                                const valuesSpan = profileIsOdd && profileLastSection === 'values' ? 'md:col-span-2' : '';
                                const constraintsSpan = profileIsOdd && profileLastSection === 'constraints' ? 'md:col-span-2' : '';
                                return '<div class="' + profileGridClass + '">' +

                                (profileInterpretation.interests?.length > 0 ? '<div class="p-4 rounded-xl ' + interestsSpan + '" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">💚</span><h5 class="font-bold text-green-400 text-[15px]">좋아하는 것</h5></div>' + (profileInterpretation.interests.length <= 2 ? '<div class="flex flex-wrap gap-2">' + profileInterpretation.interests.map(item => '<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">' + translateToKorean(item.label) + '</span>').join('') + '</div>' : '<p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.interests_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.interests.map(item => '<div class="pl-3 border-l-2 border-green-500/30"><div class="font-medium text-green-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div>') + '</div>' : '') +

                                (profileInterpretation.strengths?.length > 0 ? '<div class="p-4 rounded-xl ' + strengthsSpan + '" style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">💪</span><h5 class="font-bold text-blue-400 text-[15px]">잘하는 것</h5></div>' + (profileInterpretation.strengths.length <= 2 ? '<div class="flex flex-wrap gap-2">' + profileInterpretation.strengths.map(item => '<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(59,130,246,0.15); color: rgb(147,197,253);">' + translateToKorean(item.label) + '</span>').join('') + '</div>' : '<p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.strengths_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.strengths.map(item => '<div class="pl-3 border-l-2 border-blue-500/30"><div class="font-medium text-blue-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div>') + '</div>' : '') +

                                (profileInterpretation.values?.length > 0 ? '<div class="p-4 rounded-xl ' + valuesSpan + '" style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">⭐</span><h5 class="font-bold text-purple-400 text-[15px]">중요한 가치</h5></div>' + (profileInterpretation.values.length <= 2 ? '<div class="flex flex-wrap gap-2">' + profileInterpretation.values.map(item => '<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(168,85,247,0.15); color: rgb(216,180,254);">' + translateToKorean(item.label) + '</span>').join('') + '</div>' : '<p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.values_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.values.map(item => '<div class="pl-3 border-l-2 border-purple-500/30"><div class="font-medium text-purple-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div>') + '</div>' : '') +

                                (profileInterpretation.constraints?.length > 0 ? '<div class="p-4 rounded-xl ' + constraintsSpan + '" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);"><div class="flex items-center gap-2 mb-3"><span class="text-lg">🚫</span><h5 class="font-bold text-red-400 text-[15px]">피하고 싶은 것</h5></div><p class="text-[15px] text-wiki-muted mb-3">' + translateToKorean(profileInterpretation.constraints_summary || '') + '</p><div class="space-y-3">' + profileInterpretation.constraints.map(item => '<div class="pl-3 border-l-2 border-red-500/30"><div class="font-medium text-red-300 text-[15px]">' + translateToKorean(item.label) + '</div><div class="text-[15px] text-wiki-muted mt-1 leading-relaxed">' + translateToKorean(item.meaning) + '</div></div>').join('') + '</div></div>' : '') +

                                '</div>';
                            })()}
                        </div>
                    \` : ''}

                    <!-- 업무 스타일 힌트 (핵심 인사이트에서 이동) -->
                    \${workStyleMap && (workStyleMap.analytical_vs_creative !== undefined || workStyleMap.solo_vs_team !== undefined) ? \`
                        <div class="mt-6 flex flex-wrap gap-2 justify-center">
                            \${[
                                workStyleMap.analytical_vs_creative < 0 ? '🔍 분석적 접근' : workStyleMap.analytical_vs_creative > 0 ? '💡 창의적 접근' : null,
                                workStyleMap.solo_vs_team < 0 ? '🧘 집중 작업 선호' : workStyleMap.solo_vs_team > 0 ? '🤝 협업 선호' : null,
                                workStyleMap.structured_vs_flexible < 0 ? '📋 체계적 스타일' : workStyleMap.structured_vs_flexible > 0 ? '🌊 유연한 스타일' : null,
                                workStyleMap.guided_vs_autonomous > 0 ? '🚀 자율 지향' : null,
                            ].filter(Boolean).map(hint => \`
                                <span class="px-3 py-1.5 rounded-full text-[13px] font-medium" style="background: rgba(99,102,241,0.1); color: rgb(165,180,252); border: 1px solid rgba(99,102,241,0.2);">\${hint}</span>
                            \`).join('')}
                        </div>
                    \` : ''}

                    <!-- C: 프로필 → 추천 브릿지 문장 -->
                    \${profileInterpretation && overallTop5.length > 0 ? \`
                        <div class="mt-4 mb-2 p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05)); border: 1px solid rgba(251,191,36,0.2);">
                            <p class="text-base md:text-lg" style="color: rgb(253,224,71);">
                                <span class="font-medium">🎯 이런 당신에게 맞는 직업</span>
                            </p>
                            <p class="text-[15px] text-wiki-muted mt-2">
                                \${(() => {
                                    const parts = [];
                                    const pi = profileInterpretation;
                                    if (pi.interests?.length > 0) {
                                        parts.push('<span class="text-green-400">"' + translateToKorean(pi.interests[0].label) + '"</span>을 좋아하고');
                                    }
                                    if (pi.strengths?.length > 0) {
                                        parts.push('<span class="text-blue-400">"' + translateToKorean(pi.strengths[0].label) + '"</span>이 강점인 당신');
                                    }
                                    if (pi.constraints?.length > 0) {
                                        parts.push('<span class="text-red-400">"' + translateToKorean(pi.constraints[0].label) + '"</span> 없이 성장할 수 있는 직업을 찾았습니다.');
                                    } else if (parts.length > 0) {
                                        parts.push('에게 맞는 직업을 찾았습니다.');
                                    }
                                    return parts.length > 0 ? parts.join(' ') : '당신의 프로필을 바탕으로 직업을 추천합니다.';
                                })()}
                            </p>
                        </div>
                    \` : ''}

                    <!-- TOP 3 직업 카드 (요약 탭) -->
                    \${overallTop5.length > 0 ? \`
                        <div class="mt-6 pt-4 border-t border-wiki-border/30">
                            <h4 class="text-xl font-bold mb-4 text-wiki-text flex items-center gap-2">
                                <span>🏆</span> 추천 직업 Top 3
                                <button onclick="showReportTab('recommendations')" class="ml-auto px-3 py-1.5 rounded-lg text-[13px] font-medium text-wiki-primary bg-wiki-primary/10 hover:bg-wiki-primary/20 transition-all flex items-center gap-1.5">
                                    <span>더보기</span>
                                    <i class="fas fa-chevron-right text-[10px]"></i>
                                </button>
                            </h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                \${overallTop5.slice(0, 3).map((job, idx) => {
                                    const jobName = job.job_name || job.job_id || '직업';
                                    const jobSlug = job.slug || encodeURIComponent(jobName);
                                    const rationale = job.rationale || job.one_line_why || '';
                                    const imageUrl = job.image_url || '';
                                    const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                                    // fallback 1: rationale에서 첫 문장 추출 (자동 생성 아닌 경우)
                                    // fallback 2: rationale 전체 (자동 생성 포함)
                                    // fallback 3: 직업명 기반 기본 설명
                                    const displayDescription = description
                                        || (rationale && !rationale.includes('자동 생성') ? rationale.split('.')[0] + '.' : '')
                                        || (rationale ? rationale.replace('자동 생성된 결과입니다. LLM 분석이 진행되지 않았습니다.', '').trim() : '')
                                        || \`\${jobName} 직업에 대해 더 알아보세요.\`;
                                    const fitScore = job.scores?.fit || job.fit_score || '-';
                                    const likeScore = job.scores?.like || job.like_score || '-';

                                    // rationale 파싱: 좋아할 이유, 잘할 이유 추출
                                    const extractLikeReason = (r) => {
                                        if (!r || r.includes('자동 생성된 결과')) return null;
                                        const match = r.match(/\\[좋아할 이유\\]\\s*(.+?)(?=\\[|$)/s)
                                            || r.match(/\\[1\\]\\s*(.+?)(?=\\[2\\]|$)/s);
                                        return match ? match[1].trim() : null;
                                    };
                                    const extractCanReason = (r) => {
                                        if (!r || r.includes('자동 생성된 결과')) return null;
                                        const match = r.match(/\\[잘할 이유\\]\\s*(.+?)(?=\\[|$)/s)
                                            || r.match(/\\[2\\]\\s*(.+?)(?=\\[3\\]|\\[리스크\\]|$)/s);
                                        return match ? match[1].trim() : null;
                                    };

                                    const likeReason = job.like_reason || extractLikeReason(rationale);
                                    const canReason = job.can_reason || extractCanReason(rationale);
                                    const hasReasons = likeReason || canReason;

                                    return \`
                                        <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="block p-4 rounded-xl transition-all hover:scale-[1.02] group"
                                           style="background: linear-gradient(135deg, rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.15), rgba(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'},0.05)); border: 1px solid rgba(\${idx === 0 ? '245,158,11' : idx === 1 ? '100,116,139' : '180,83,9'},0.3);">
                                            <!-- 썸네일 (없으면 placeholder) -->
                                            <div class="mb-3 overflow-hidden rounded-lg" style="aspect-ratio: 16/10;">
                                                \${imageUrl ? \`
                                                    <img src="\${imageUrl}" alt="\${jobName}"
                                                         class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="hidden w-full h-full items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                        <i class="fas fa-briefcase text-3xl text-wiki-muted"></i>
                                                    </div>
                                                \` : \`
                                                    <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.1));">
                                                        <i class="fas fa-briefcase text-3xl text-wiki-muted"></i>
                                                    </div>
                                                \`}
                                            </div>
                                            <div class="flex items-center gap-3 mb-3">
                                                <span class="text-2xl">\${idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉'}</span>
                                                <span class="font-bold text-lg text-white flex-1 line-clamp-1">\${jobName}</span>
                                                <span class="text-base font-bold" style="color: rgb(\${idx === 0 ? '251,191,36' : idx === 1 ? '148,163,184' : '217,119,6'});">Fit \${fitScore}</span>
                                            </div>
                                            \${displayDescription ? \`<p class="text-base text-wiki-muted line-clamp-3 mb-3">\${displayDescription}</p>\` : ''}
                                            <!-- 잘할 이유 + 좋아할 이유 -->
                                            \${hasReasons ? \`
                                                <div class="space-y-1.5 mt-3 p-3 rounded-lg" style="background: rgba(0,0,0,0.2);">
                                                    \${likeReason ? \`<p class="text-[13px] leading-relaxed text-purple-300/90"><span class="text-purple-400 font-medium">💜 Like:</span> \${likeReason}</p>\` : ''}
                                                    \${canReason ? \`<p class="text-[13px] leading-relaxed text-blue-300/90"><span class="text-blue-400 font-medium">💪 Can:</span> \${canReason}</p>\` : ''}
                                                </div>
                                            \` : (rationale && !rationale.includes('자동 생성된 결과') ? \`
                                                <p class="text-[13px] text-emerald-400/80 mt-3">💡 \${rationale}</p>
                                            \` : '')}
                                        </a>
                                    \`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                </div>

                <!-- 탭 컨텐츠: 메타인지 -->
                <div id="tab-psychology" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">📊</span>
                            <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">메타인지</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">자기 자신에 대한 깊은 이해와 내면 탐구.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
                    </div>

                    <!-- ============================================ -->
                    <!-- 핵심 요약 (💫 당신은...) - 가장 먼저 표시 -->
                    <!-- ============================================ -->
                    \${personal.personality_summary || metaCognition?.innerExploration?.identityInsight ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                            <h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">💫 핵심 요약</h4>
                            <p class="text-base md:text-lg leading-relaxed text-white mb-4">
                                \${(() => {
                                    // LLM identityInsight 우선, 없으면 personality_summary fallback
                                    const rawText = metaCognition?.innerExploration?.identityInsight || personal.personality_summary || '';
                                    // 키워드 볼드 + 색상 처리
                                    let styled = rawText
                                        .replace(/'([^']+)'/g, '<strong class="text-wiki-secondary font-bold">$1</strong>');
                                    // 프로필 키워드에 색상 적용
                                    if (profileInterpretation) {
                                        const pi = profileInterpretation;
                                        (pi.interests || []).forEach(i => {
                                            const label = translateToKorean(i.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-green-400">' + label + '</strong>');
                                        });
                                        (pi.strengths || []).forEach(s => {
                                            const label = translateToKorean(s.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-blue-400">' + label + '</strong>');
                                        });
                                        (pi.values || []).forEach(v => {
                                            const label = translateToKorean(v.label);
                                            styled = styled.replace(new RegExp(label, 'g'), '<strong class="text-purple-400">' + label + '</strong>');
                                        });
                                    }
                                    return styled;
                                })()}
                            </p>
                            \${metaCognition?.innerExploration?.innerConflicts ? \`
                                <div class="p-4 rounded-xl mb-4" style="background-color: rgba(236,72,153,0.08); border-left: 3px solid rgba(236,72,153,0.5);">
                                    <div class="text-[15px] font-medium text-pink-300 mb-2">🎭 알아두면 좋은 내적 갈등</div>
                                    <p class="text-[15px] text-wiki-muted leading-relaxed">\${translateToKorean(metaCognition.innerExploration.innerConflicts)}</p>
                                </div>
                            \` : ''}
                            \${metaCognition?.innerExploration?.valueAnalysis ? \`
                                <details class="group">
                                    <summary class="cursor-pointer text-[15px] text-violet-400 font-medium hover:text-violet-300 flex items-center gap-2">
                                        <span>📖</span>
                                        <span class="group-open:hidden">▶ 추가 설명</span>
                                        <span class="hidden group-open:inline">▼ 추가 설명</span>
                                    </summary>
                                    <div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(139,92,246,0.05);">
                                        \${translateToKorean(metaCognition.innerExploration.valueAnalysis)}
                                    </div>
                                </details>
                            \` : ''}
                        </div>
                    \` : \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.2);">
                            <h4 class="text-xl font-bold mb-3" style="color: rgb(165,180,252);">💫 핵심 요약</h4>
                            <p class="text-base md:text-lg leading-relaxed text-wiki-muted">심층 분석을 위해 더 많은 정보가 필요합니다. 심층 질문에 자세히 답변해주시면 더 정확한 분석이 가능합니다.</p>
                        </div>
                    \`}

                    <!-- ============================================ -->
                    <!-- 메타인지 5개 섹션 (LLM/Rule 기반) - 핵심 요약 아래에 배치 -->
                    <!-- ============================================ -->

                    \${metaCognition ? \`
                        <!-- 강점 + 선호도 (2열 그리드) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- 1️⃣ 나의 무기고 (강점 + 약점) - 핵심만 표시 -->
                            <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(99,102,241,0.05)); border: 1px solid rgba(59,130,246,0.15);">
                                <h4 class="text-lg font-bold mb-4 text-blue-400 flex items-center gap-2">
                                    <span>💪</span> 나의 강점
                                </h4>

                            \${metaCognition.myArsenal?.strengths?.length > 0 ? \`
                                <!-- 클릭 가능한 강점 태그 -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    \${metaCognition.myArsenal.strengths.map((s, i) => {
                                        const icons = { '분석력': '🔍', '창작/예술': '🎨', '소통력': '💬', '체계적 실행력': '📋', '끈기': '💪', '빠른 학습': '⚡', '리더십': '👑', '공감 능력': '🤝', '꼼꼼함': '🔬', '적응력': '🌊' };
                                        const icon = icons[translateToKorean(s.trait)] || '✨';
                                        return \`<button onclick="document.getElementById('strength-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-4 py-2 rounded-full text-[15px] font-semibold cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.15); color: rgb(134,239,172);">
                                            \${icon} \${translateToKorean(s.trait)}
                                        </button>\`;
                                    }).join('')}
                                </div>
                                <!-- 태그 클릭 시 표시되는 상세 설명 -->
                                \${metaCognition.myArsenal.strengths.map((s, i) => \`
                                    <div id="strength-detail-\${i}" class="hidden mb-3 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed animate-fadeIn" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);">
                                        <span class="font-medium text-green-300">\${translateToKorean(s.trait)}:</span>
                                        <span class="ml-1">\${s.meaning}</span>
                                    </div>
                                \`).join('')}

                                <!-- 상담사 노트 -->
                                \${metaCognition.myArsenal.counselorNote ? \`
                                    <div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">💡 상담사 노트</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.myArsenal.counselorNote)}</p>
                                    </div>
                                \` : ''}
                            \` : '<p class="text-[15px] text-wiki-muted">강점 분석을 위해 더 많은 정보가 필요합니다.</p>'}

                            \${metaCognition.myArsenal?.weaknesses?.length > 0 ? \`
                                <div class="mt-5 pt-4 border-t border-wiki-border/20">
                                    <div class="text-[15px] font-medium text-orange-400 mb-3 flex items-center gap-2">
                                        <span>⚠️</span> 개선 가능 영역
                                    </div>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        \${metaCognition.myArsenal.weaknesses.map(w => \`
                                            <span class="px-3 py-1.5 rounded-full text-[15px]" style="background-color: rgba(251,146,60,0.1); color: rgb(253,186,116);">
                                                \${translateToKorean(w.trait)}
                                            </span>
                                        \`).join('')}
                                    </div>
                                    <!-- 개선 영역 상세 - 더보기 -->
                                    <details class="group">
                                        <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                            <span class="group-open:hidden">▶ 극복 방향 보기</span>
                                            <span class="hidden group-open:inline">▼ 접기</span>
                                        </summary>
                                        <div class="mt-3 space-y-2 pl-2 border-l-2 border-orange-500/20">
                                            \${metaCognition.myArsenal.weaknesses.map(w => \`
                                                <div class="text-[15px]">
                                                    <span class="font-medium text-orange-300">\${translateToKorean(w.trait)}:</span>
                                                    <span class="text-wiki-muted ml-1">\${w.meaning}</span>
                                                </div>
                                            \`).join('')}
                                        </div>
                                    </details>
                                </div>
                            \` : ''}
                            </div>

                            <!-- 2️⃣ 선호도 지도 - 핵심만 표시 -->
                            <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.15);">
                                <h4 class="text-lg font-bold mb-4 text-purple-400 flex items-center gap-2">
                                    <span>🎯</span> 선호도 요약
                                </h4>

                            <div class="space-y-4">
                                <!-- 좋아하는 것 -->
                                \${metaCognition.preferenceMap?.likes?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-green-400 mb-2">💚 좋아하는 것</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.likes.map((l, i) => {
                                                const icons = { '기술/IT': '💻', '문제해결': '🧩', '창작/예술': '🎨', '데이터/숫자': '📊', '사람 돕기': '🤲', '조직/관리': '📋', '영향력': '📢', '연구/탐구': '🔬', '리딩': '👑', '빌딩': '🏗️' };
                                                const icon = icons[translateToKorean(l.item)] || '💚';
                                                return \`<button onclick="document.getElementById('like-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(34,197,94,0.12); color: rgb(134,239,172);">\${icon} \${translateToKorean(l.item)}</button>\`;
                                            }).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.likes.map((l, i) => \`
                                            <div id="like-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(34,197,94,0.05); border-left: 2px solid rgba(34,197,94,0.3);">
                                                <span class="font-medium text-green-300">\${translateToKorean(l.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(l.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}

                                <!-- 피하고 싶은 것 -->
                                \${metaCognition.preferenceMap?.dislikes?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-red-400 mb-2">🚫 피하고 싶은 것</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.dislikes.map((d, i) => {
                                                const icons = { '불규칙한 근무시간': '⏰', '재택 선호': '🏠', '야근 없음': '🌙', '출장 없음': '✈️', '교대근무 없음': '🔄', '시간 제약': '⏳', '수입 제약': '💰', '체력 제약': '🏋️', '불확실성 제약': '❓' };
                                                const icon = icons[translateToKorean(d.item)] || '🚫';
                                                return \`<button onclick="document.getElementById('dislike-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">\${icon} \${translateToKorean(d.item)}</button>\`;
                                            }).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.dislikes.map((d, i) => \`
                                            <div id="dislike-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);">
                                                <span class="font-medium text-red-300">\${translateToKorean(d.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(d.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}

                                <!-- 잘 맞는 것 -->
                                \${metaCognition.preferenceMap?.fits?.length > 0 ? \`
                                    <div>
                                        <div class="text-[15px] font-medium text-blue-400 mb-2">💙 잘 맞는 것</div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            \${metaCognition.preferenceMap.fits.map((f, i) => \`
                                                <button onclick="document.getElementById('fit-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-2.5 py-1 rounded-lg text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(59,130,246,0.12); color: rgb(147,197,253);">💙 \${translateToKorean(f.item)}</button>
                                            \`).join('')}
                                        </div>
                                        \${metaCognition.preferenceMap.fits.map((f, i) => \`
                                            <div id="fit-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(59,130,246,0.05); border-left: 2px solid rgba(59,130,246,0.3);">
                                                <span class="font-medium text-blue-300">\${translateToKorean(f.item)}:</span>
                                                <span class="ml-1">\${translateToKorean(f.why)}</span>
                                            </div>
                                        \`).join('')}
                                    </div>
                                \` : ''}
                            </div>

                            <!-- 상담사 노트 -->
                            \${metaCognition.preferenceMap?.counselorNote ? \`
                                <div class="mt-4 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                    <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">💡 상담사 노트</div>
                                    <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.preferenceMap.counselorNote)}</p>
                                </div>
                            \` : ''}
                            </div>
                        </div>

                        <!-- 스트레스 + 성장 (2열 그리드, 하나만 있으면 전체 너비) -->
                        <div class="grid grid-cols-1 \${metaCognition.stressRecovery?.stressFactors?.length > 0 && metaCognition.growthPotential ? 'md:grid-cols-2' : ''} gap-6 mb-6">
                            <!-- 4️⃣ 스트레스 & 회복 - 핵심만 -->
                            \${metaCognition.stressRecovery?.stressFactors?.length > 0 ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(251,146,60,0.05)); border: 1px solid rgba(239,68,68,0.15);">
                                    <h4 class="text-lg font-bold mb-4 text-red-400 flex items-center gap-2">
                                        <span>⚡</span> 스트레스 요인
                                    </h4>

                                <!-- 클릭 가능한 스트레스 요인 태그 -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    \${metaCognition.stressRecovery.stressFactors.map((s, i) => {
                                        const icons = { '반복 업무 피로': '🔄', '관료주의 스트레스': '📑', '사람 상대 피로': '👥', '인지 과부하': '🧠', '시간 압박': '⏰', '책임감 부담': '⚖️', '예측 불가': '🌪️', '갈등 상황': '💢', '멀티태스킹': '🔀', '불확실성': '❓' };
                                        const icon = icons[translateToKorean(s.factor)] || '⚡';
                                        return \`<button onclick="document.getElementById('stress-detail-\${i}').classList.toggle('hidden'); this.classList.toggle('ring-2')" class="px-3 py-1.5 rounded-full text-[15px] font-medium cursor-pointer transition-all hover:scale-105" style="background-color: rgba(239,68,68,0.12); color: rgb(252,165,165);">
                                            \${icon} \${translateToKorean(s.factor)}
                                        </button>\`;
                                    }).join('')}
                                </div>
                                <!-- 태그 클릭 시 표시되는 상세 설명 -->
                                \${metaCognition.stressRecovery.stressFactors.map((s, i) => \`
                                    <div id="stress-detail-\${i}" class="hidden mb-2 p-3 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(239,68,68,0.05); border-left: 2px solid rgba(239,68,68,0.3);">
                                        <span class="font-medium text-red-300">\${translateToKorean(s.factor)}:</span>
                                        <span class="ml-1">\${translateToKorean(s.why)}</span>
                                    </div>
                                \`).join('')}

                                <!-- 상담사 노트 -->
                                \${metaCognition.stressRecovery.counselorNote ? \`
                                    <div class="mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-1" style="color: rgb(251,191,36);">💡 상담사 노트</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.stressRecovery.counselorNote)}</p>
                                    </div>
                                \` : ''}

                                <!-- 회복 방법 (있으면) -->
                                \${metaCognition.stressRecovery?.recoveryMethods?.length > 0 ? \`
                                    <div class="mt-4 pt-4 border-t border-wiki-border/20">
                                        <div class="text-[15px] font-medium text-emerald-400 mb-2 flex items-center gap-2">
                                            <span>🌿</span> 회복 방법
                                        </div>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            \${metaCognition.stressRecovery.recoveryMethods.map(r => \`
                                                <span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">
                                                    \${translateToKorean(r.factor)}
                                                </span>
                                            \`).join('')}
                                        </div>
                                        <!-- 회복 방법 상세 - 더보기 -->
                                        <details class="group">
                                            <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                                <span class="group-open:hidden">▶ 왜 회복되는지 이해하기</span>
                                                <span class="hidden group-open:inline">▼ 접기</span>
                                            </summary>
                                            <div class="mt-3 space-y-2 text-[15px]">
                                                \${metaCognition.stressRecovery.recoveryMethods.map(r => \`
                                                    <div class="p-3 rounded-lg" style="background-color: rgba(16,185,129,0.05);">
                                                        <span class="font-medium text-emerald-300">\${translateToKorean(r.factor)}:</span>
                                                        <span class="text-wiki-muted ml-1">\${translateToKorean(r.why)}</span>
                                                    </div>
                                                \`).join('')}
                                            </div>
                                        </details>
                                    </div>
                                \` : ''}
                                </div>
                            \` : ''}

                            <!-- 5️⃣ 성장 가능성 -->
                            \${metaCognition.growthPotential ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(52,211,153,0.05)); border: 1px solid rgba(16,185,129,0.15);">
                                    <h4 class="text-lg font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                        <span>🌱</span> 성장 가능성
                                    </h4>

                                <!-- 핵심: 활용할 강점 태그 (아이콘 개별 적용) -->
                                \${metaCognition.growthPotential.leveragePoints?.length > 0 ? \`
                                    <div class="flex flex-wrap gap-2 mb-4">
                                        \${metaCognition.growthPotential.leveragePoints.map(p => {
                                            const icons = { '분석력': '🔍', '창작/예술': '🎨', '소통력': '💬', '체계적 실행력': '📋', '끈기': '💪', '빠른 학습': '⚡', '리더십': '👑', '공감 능력': '🤝', '꼼꼼함': '🔬', '적응력': '🌊' };
                                            const icon = icons[translateToKorean(p)] || '✨';
                                            return \`<span class="px-3 py-1.5 rounded-full text-[15px] font-medium" style="background-color: rgba(16,185,129,0.12); color: rgb(110,231,183);">
                                                \${icon} \${translateToKorean(p)}
                                            </span>\`;
                                        }).join('')}
                                    </div>
                                \` : ''}

                                <!-- 상담사 노트 (핵심 메시지) -->
                                \${metaCognition.growthPotential.counselorNote ? \`
                                    <div class="p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05)); border-left: 3px solid rgba(251,191,36,0.5);">
                                        <div class="text-[15px] font-medium mb-2" style="color: rgb(251,191,36);">💡 상담사 노트</div>
                                        <p class="text-[15px] text-wiki-text leading-relaxed italic">\${translateToKorean(metaCognition.growthPotential.counselorNote)}</p>
                                    </div>
                                \` : ''}

                                <!-- 성장 방향 - 더보기 -->
                                \${metaCognition.growthPotential.direction ? \`
                                    <details class="group">
                                        <summary class="cursor-pointer text-[15px] text-wiki-muted hover:text-wiki-primary flex items-center gap-1">
                                            <span class="group-open:hidden">▶ 성장 방향 상세 보기</span>
                                            <span class="hidden group-open:inline">▼ 접기</span>
                                        </summary>
                                        <div class="mt-3 p-4 rounded-lg text-[15px] text-wiki-muted leading-relaxed" style="background-color: rgba(16,185,129,0.05);">
                                            🎯 \${translateToKorean(metaCognition.growthPotential.direction)}
                                        </div>
                                    </details>
                                \` : ''}
                                </div>
                            \` : ''}
                        </div>

                        <hr class="border-wiki-border/20 my-8" />
                    \` : ''}

                    <!-- ============================================ -->
                    <!-- ============================================ -->
                    <!-- 추가 분석 섹션들 (핵심 요약 아래 보충 정보) -->
                    <!-- ============================================ -->

                    <!-- 작업 스타일 인사이트 -->
                    \${personal.work_style_insights?.length > 0 ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>🎨</span> 작업 스타일
                            </h4>
                            <div class="grid gap-3">
                                \${personal.work_style_insights.map(ws => {
                                    // 마침표 일관성 보장
                                    let text = translateToKorean(ws).trim();
                                    if (!text.endsWith('.') && !text.endsWith('다.') && !text.endsWith('요.') && !text.endsWith('니다.')) {
                                        if (text.endsWith('다') || text.endsWith('요') || text.endsWith('니다')) {
                                            text += '.';
                                        } else {
                                            text += '.';
                                        }
                                    }
                                    // 키워드 볼드+색상 처리
                                    text = text
                                        .replace(/(성장|도전|학습|몰입|성취감|자율|창의성|분석|문제|해결|독립|협업|리더십|꼼꼼|유연|안정|전문성|체계)/g, '<strong class="text-indigo-400">$1</strong>');
                                    return \`<div class="p-4 rounded-xl bg-wiki-bg/50 flex items-start gap-4" style="border: 1px solid rgba(99,102,241,0.1);">
                                        <span class="text-wiki-primary text-lg mt-0.5">✓</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${text}</span>
                                    </div>\`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- 가치 우선순위 -->
                    \${personal.value_priorities?.length > 0 ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>⭐</span> 가치 우선순위
                            </h4>
                            <div class="grid gap-3">
                                \${personal.value_priorities.map((v, i) => {
                                    const colors = ['rgba(168,85,247,0.2)', 'rgba(99,102,241,0.2)', 'rgba(59,130,246,0.2)', 'rgba(6,182,212,0.2)', 'rgba(16,185,129,0.2)', 'rgba(245,158,11,0.2)', 'rgba(239,68,68,0.2)'];
                                    const textColors = ['rgb(216,180,254)', 'rgb(165,180,252)', 'rgb(147,197,253)', 'rgb(103,232,249)', 'rgb(110,231,183)', 'rgb(253,224,71)', 'rgb(252,165,165)'];
                                    // 키워드 볼드 처리
                                    let text = translateToKorean(v).trim();
                                    if (!text.endsWith('.')) text += '.';
                                    text = text.replace(/(성장|수입|보상|워라밸|안정|의미|보람|인정|영향력|자율|도전|리스크)/g, '<strong style="color: ' + textColors[i % textColors.length] + '">$1</strong>');
                                    return \`<div class="p-4 rounded-xl flex items-start gap-3" style="background-color: \${colors[i % colors.length]}; border: 1px solid \${colors[i % colors.length].replace('0.2', '0.3')};">
                                        <span class="text-lg font-bold mt-0.5" style="color: \${textColors[i % textColors.length]};">#\${i + 1}</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${text}</span>
                                    </div>\`;
                                }).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- 잠재적 도전 -->
                    \${personal.potential_challenges?.length > 0 ? \`
                        <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-orange-400 flex items-center gap-2">
                                <span>⚠️</span> 주의할 점
                            </h4>
                            <ul class="space-y-3">
                                \${personal.potential_challenges.map(c => \`
                                    <li class="flex items-center gap-3">
                                        <span class="text-orange-400">•</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${c}</span>
                                    </li>
                                \`).join('')}
                            </ul>
                        </div>
                    \` : ''}

                    <!-- 블라인드 스팟 -->
                    \${personal.blind_spots_to_check?.length > 0 ? \`
                        <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2">
                                <span>🔍</span> 점검할 블라인드 스팟
                            </h4>
                            <ul class="space-y-3">
                                \${personal.blind_spots_to_check.map(b => \`
                                    <li class="flex items-center gap-3">
                                        <span class="text-red-400">•</span>
                                        <span class="text-[15px] leading-relaxed text-wiki-text">\${b}</span>
                                    </li>
                                \`).join('')}
                            </ul>
                        </div>
                    \` : ''}
                    
                    <!-- 미니모듈 결과 기반 기본 분석 (데이터가 없을 때) -->
                    \${!personal.work_style_insights?.length && window.miniModuleResult ? \`
                        <div class="mb-8">
                            <h4 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <span>📊</span> 선택 기반 분석
                            </h4>
                            <p class="text-sm text-wiki-muted mb-4">미니모듈에서 선택한 내용을 기반으로 한 기초 분석입니다.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="p-4 rounded-xl" style="background-color: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.15);">
                                    <div class="text-sm font-semibold text-indigo-400 mb-2">흥미 영역</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.interest_top || []).map(t => translateToKorean(t)).join(', ') || '미선택'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.15);">
                                    <div class="text-sm font-semibold text-purple-400 mb-2">중요 가치</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.value_top || []).map(t => translateToKorean(t)).join(', ') || '미선택'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.15);">
                                    <div class="text-sm font-semibold text-emerald-400 mb-2">강점</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.strength_top || []).map(t => translateToKorean(t)).join(', ') || '미선택'}</div>
                                </div>
                                <div class="p-4 rounded-xl" style="background-color: rgba(251,146,60,0.08); border: 1px solid rgba(251,146,60,0.15);">
                                    <div class="text-sm font-semibold text-orange-400 mb-2">제약 조건</div>
                                    <div class="text-base text-wiki-text">\${(window.miniModuleResult.constraint_flags || []).map(t => translateToKorean(t)).join(', ') || '없음'}</div>
                                </div>
                            </div>
                        </div>
                    \` : ''}

                    <!-- ============================================ -->
                    <!-- V3 추가 심리 분석 섹션들 -->
                    <!-- ============================================ -->

                    <!-- 작업 스타일 5축 시각화 (개선된 버전) -->
                    \${workStyleMap && (workStyleMap.analytical_vs_creative !== 0 || workStyleMap.solo_vs_team !== 0) ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(6,182,212,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-cyan-400 flex items-center gap-2">
                                <span>📊</span> 작업 스타일 5축 분석
                            </h4>
                            <p class="text-sm text-wiki-muted mb-5">각 축의 중앙은 균형 상태이며, 좌우로 치우칠수록 해당 성향이 강합니다.</p>
                            <div class="space-y-5">
                                \${[
                                    { left: '분석형', right: '창의형', value: workStyleMap.analytical_vs_creative, color: 'cyan' },
                                    { left: '혼자 집중', right: '팀 협업', value: workStyleMap.solo_vs_team, color: 'blue' },
                                    { left: '체계적', right: '유연함', value: workStyleMap.structured_vs_flexible, color: 'violet' },
                                    { left: '전문가형', right: '제너럴리스트', value: workStyleMap.depth_vs_breadth, color: 'amber' },
                                    { left: '가이드 선호', right: '자율 선호', value: workStyleMap.guided_vs_autonomous, color: 'emerald' },
                                ].map(axis => \`
                                    <div class="flex items-center gap-4">
                                        <span class="text-sm w-24 text-right \${axis.value < 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted'}">\${axis.left}</span>
                                        <div class="flex-1 h-3 bg-wiki-border/20 rounded-full relative overflow-hidden">
                                            <div class="absolute top-0 left-1/2 w-px h-full bg-wiki-muted/40 z-10"></div>
                                            \${axis.value === 0
                                                ? '<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gray-400 rounded-full border-2 border-wiki-bg z-20"></div>'
                                                : \`<div class="absolute top-0 h-full bg-\${axis.color}-400/80 rounded-full transition-all"
                                                     style="\${axis.value >= 0
                                                        ? 'left: 50%; width: ' + Math.max(axis.value / 2, 3) + '%;'
                                                        : 'right: 50%; width: ' + Math.max(Math.abs(axis.value) / 2, 3) + '%;'}"></div>\`}
                                        </div>
                                        <span class="text-sm w-24 \${axis.value > 0 ? 'text-' + axis.color + '-400 font-semibold' : 'text-wiki-muted'}">\${axis.right}</span>
                                    </div>
                                \`).join('')}
                            </div>
                        </div>
                    \` : ''}

                    <!-- 내면 갈등 + 성장 곡선 (2열 그리드) -->
                    \${(innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts) || growthCurve.type ? \`
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- 내면 갈등 분석 -->
                            \${innerConflict.analysis && !metaCognition?.innerExploration?.innerConflicts ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(168,85,247,0.2);">
                                    <h4 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                                        <span>💭</span> 내면 갈등 분석
                                    </h4>
                                    \${innerConflict.patterns?.length > 0 ? \`
                                        <p class="text-lg font-bold mb-3" style="color: rgb(216,180,254);">\${innerConflict.patterns[0]}</p>
                                    \` : ''}
                                    <p class="text-[15px] leading-relaxed text-wiki-text mb-4">\${innerConflict.analysis}</p>
                                    \${innerConflict.patterns?.length > 1 ? \`
                                        <div class="mt-4 pt-4 border-t border-purple-400/20">
                                            <span class="text-sm text-purple-300 font-semibold">기타 갈등 패턴:</span>
                                            <ul class="mt-3 space-y-2">
                                                \${innerConflict.patterns.slice(1).map(p => \`
                                                    <li class="flex items-center gap-3">
                                                        <span class="text-purple-400">•</span>
                                                        <span class="text-[15px] leading-relaxed text-wiki-muted">\${p}</span>
                                                    </li>
                                                \`).join('')}
                                            </ul>
                                        </div>
                                    \` : ''}
                                </div>
                            \` : ''}

                            <!-- 성장 곡선 -->
                            \${growthCurve.type ? \`
                                <div class="p-5 md:p-6 rounded-2xl h-full" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(52,211,153,0.1)); border: 1px solid rgba(16,185,129,0.2);">
                                    <h4 class="text-xl font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                        <span>📈</span> 성장 곡선 유형
                                    </h4>
                                    <p class="text-lg font-bold mb-3" style="color: rgb(52,211,153);">\${translateToKorean(growthCurve.type)}</p>
                                    \${growthCurve.description ? \`
                                        <p class="text-[15px] leading-relaxed text-wiki-text">\${growthCurve.description}</p>
                                    \` : ''}
                                </div>
                            \` : ''}
                        </div>
                    \` : ''}

                    <!-- 전환 타이밍 (30/60/90일 계획) -->
                    \${transitionTiming.day30?.goal || transitionTiming.day60?.goal || transitionTiming.day90?.goal ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-blue-400 flex items-center gap-2">
                                <span>📅</span> 30/60/90일 전환 계획
                            </h4>
                            <p class="text-sm text-wiki-muted mb-5">단계별 목표와 실행 계획을 통해 체계적으로 전환을 준비하세요.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                \${transitionTiming.day30?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15);">
                                        <div class="text-sm font-bold text-blue-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold">30</span>
                                            첫 30일
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day30.goal}</div>
                                        \${transitionTiming.day30.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day30.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-blue-400">•</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day30.milestone ? \`<div class="text-sm text-blue-400 font-medium">✓ \${transitionTiming.day30.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                                \${transitionTiming.day60?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.15);">
                                        <div class="text-sm font-bold text-indigo-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold">60</span>
                                            60일차
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day60.goal}</div>
                                        \${transitionTiming.day60.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day60.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-indigo-400">•</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day60.milestone ? \`<div class="text-sm text-indigo-400 font-medium">✓ \${transitionTiming.day60.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                                \${transitionTiming.day90?.goal ? \`
                                    <div class="p-4 rounded-xl" style="background-color: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.15);">
                                        <div class="text-sm font-bold text-violet-300 mb-3 flex items-center gap-2">
                                            <span class="w-8 h-8 rounded-full bg-violet-500/20 flex items-center justify-center text-violet-400 font-bold">90</span>
                                            90일차
                                        </div>
                                        <div class="text-base font-semibold text-white mb-3">\${transitionTiming.day90.goal}</div>
                                        \${transitionTiming.day90.actions?.length > 0 ? \`
                                            <ul class="text-sm text-wiki-muted space-y-2 mb-3">
                                                \${transitionTiming.day90.actions.slice(0,2).map(a => \`<li class="flex items-center gap-2"><span class="text-violet-400">•</span> \${a}</li>\`).join('')}
                                            </ul>
                                        \` : ''}
                                        \${transitionTiming.day90.milestone ? \`<div class="text-sm text-violet-400 font-medium">✓ \${transitionTiming.day90.milestone}</div>\` : ''}
                                    </div>
                                \` : ''}
                            </div>
                        </div>
                    \` : ''}

                    <!-- 전문가 가이던스 -->
                    \${expertGuidance.doNow?.length > 0 || expertGuidance.stopDoing?.length > 0 || expertGuidance.learnNext?.length > 0 ? \`
                        <div class="mb-8 p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.2);">
                            <h4 class="text-xl font-bold mb-2 text-green-400 flex items-center gap-2">
                                <span>🧭</span> 전문가 가이던스
                            </h4>
                            <p class="text-[15px] text-wiki-muted mb-5">지금 당장 실천할 수 있는 구체적인 조언입니다.</p>
                            \${(() => {
                                // 활성 섹션 수 계산하여 그리드 동적 조정
                                const activeSections = [
                                    expertGuidance.doNow?.length > 0 ? 'doNow' : null,
                                    expertGuidance.stopDoing?.length > 0 ? 'stopDoing' : null,
                                    expertGuidance.learnNext?.length > 0 ? 'learnNext' : null,
                                    expertGuidance.avoidPaths?.length > 0 ? 'avoidPaths' : null
                                ].filter(Boolean);
                                const count = activeSections.length;
                                const lastSection = activeSections[count - 1];
                                const isOdd = count % 2 === 1;
                                const gridClass = count <= 1 ? 'grid grid-cols-1 gap-4' : 'grid grid-cols-1 md:grid-cols-2 gap-4';

                                // 홀수개일 때 마지막 섹션만 col-span-2
                                const doNowSpan = isOdd && lastSection === 'doNow' ? 'md:col-span-2' : '';
                                const stopSpan = isOdd && lastSection === 'stopDoing' ? 'md:col-span-2' : '';
                                const learnSpan = isOdd && lastSection === 'learnNext' ? 'md:col-span-2' : '';
                                const avoidSpan = isOdd && lastSection === 'avoidPaths' ? 'md:col-span-2' : '';

                                return '<div class="' + gridClass + '">'
                                + (expertGuidance.doNow?.length > 0 ? '<div class="p-5 rounded-xl ' + doNowSpan + '" style="background-color: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.15);"><div class="text-base font-bold text-green-400 mb-3 flex items-center gap-2"><span class="text-xl">✅</span> 지금 시작할 것</div><ul class="space-y-2">' + expertGuidance.doNow.slice(0,3).map(d => '<li class="flex items-center gap-3"><span class="text-green-400">•</span><span class="text-[15px] text-wiki-text">' + translateToKorean(d) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.stopDoing?.length > 0 ? '<div class="p-5 rounded-xl ' + stopSpan + '" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.15);"><div class="text-base font-bold text-red-400 mb-3 flex items-center gap-2"><span class="text-xl">🚫</span> 그만해야 할 것</div><ul class="space-y-2">' + expertGuidance.stopDoing.slice(0,3).map(s => '<li class="flex items-center gap-3"><span class="text-red-400">•</span><span class="text-[15px] text-wiki-text">' + translateToKorean(s) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.learnNext?.length > 0 ? '<div class="p-5 rounded-xl ' + learnSpan + '" style="background-color: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15);"><div class="text-base font-bold text-blue-400 mb-3 flex items-center gap-2"><span class="text-xl">📚</span> 학습할 것</div><ul class="space-y-2">' + expertGuidance.learnNext.slice(0,3).map(l => '<li class="flex items-center gap-3"><span class="text-blue-400">•</span><span class="text-[15px] text-wiki-text">' + translateToKorean(l) + '</span></li>').join('') + '</ul></div>' : '')
                                + (expertGuidance.avoidPaths?.length > 0 ? '<div class="p-5 rounded-xl ' + avoidSpan + '" style="background-color: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.15);"><div class="text-base font-bold text-orange-400 mb-3 flex items-center gap-2"><span class="text-xl">⚠️</span> 피해야 할 경로</div><ul class="space-y-2">' + expertGuidance.avoidPaths.slice(0,3).map(a => '<li class="flex items-center gap-3"><span class="text-orange-400">•</span><span class="text-[15px] text-wiki-text">' + translateToKorean(a) + '</span></li>').join('') + '</ul></div>' : '')
                                + '</div>';
                            })()}
                        </div>
                    \` : ''}

                    <!-- 스트레스 프로필 상세 -->
                    \${stressProfile.profile ? \`
                        <div class="p-5 md:p-6 rounded-2xl" style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,146,60,0.1)); border: 1px solid rgba(239,68,68,0.2);">
                            <h4 class="text-xl font-bold mb-4 text-red-400 flex items-center gap-2">
                                <span>😰</span> 스트레스 프로필
                            </h4>
                            <p class="text-[15px] leading-relaxed text-wiki-text mb-4">\${stressProfile.profile}</p>
                            \${stressProfile.triggers?.length > 0 ? \`
                                <div class="mt-4 pt-4 border-t border-red-400/20">
                                    <span class="text-sm text-red-300 font-semibold">주요 트리거:</span>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        \${stressProfile.triggers.map(t => \`
                                            <span class="px-3 py-1.5 rounded-lg text-sm font-medium" style="background-color: rgba(239,68,68,0.15); color: rgb(252,165,165);">\${t}</span>
                                        \`).join('')}
                                    </div>
                                </div>
                            \` : ''}
                        </div>
                    \` : ''}

                </div>
                
                <!-- 탭 컨텐츠: 추천 직업 -->
                <div id="tab-recommendations" class="report-tab-content hidden glass-card p-6 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">💼</span>
                            <span class="bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">추천 직업</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">당신에게 맞는 직업을 AI가 분석했습니다.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>
                    </div>

                    <!-- 📌 프로필 기반 추천 요약 (A: 추천 탭 상단) -->
                    \${profileInterpretation ? \`
                        <div class="mb-6 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.08)); border: 1px solid rgba(99,102,241,0.2);">
                            <h4 class="text-lg font-bold mb-3 flex items-center gap-2" style="color: rgb(165,180,252);">
                                <span>📌</span> 당신의 프로필 기반 추천
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                \${profileInterpretation.interests?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(34,197,94,0.1);">
                                        <span class="text-green-400">💚</span>
                                        <div>
                                            <div class="text-base font-semibold text-green-400">흥미</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.interests.slice(0,2).map(i => i.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.strengths?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(59,130,246,0.1);">
                                        <span class="text-blue-400">💪</span>
                                        <div>
                                            <div class="text-base font-semibold text-blue-400">강점</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.strengths.slice(0,2).map(s => s.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.values?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(168,85,247,0.1);">
                                        <span class="text-purple-400">⭐</span>
                                        <div>
                                            <div class="text-base font-semibold text-purple-400">가치</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.values.slice(0,2).map(v => v.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                                \${profileInterpretation.constraints?.length > 0 ? \`
                                    <div class="flex items-center gap-2 p-2 rounded-lg" style="background: rgba(239,68,68,0.1);">
                                        <span class="text-red-400">🚫</span>
                                        <div>
                                            <div class="text-base font-semibold text-red-400">제약</div>
                                            <div class="text-[15px] text-white">\${profileInterpretation.constraints.slice(0,2).map(c => c.label).join(', ')}</div>
                                        </div>
                                    </div>
                                \` : ''}
                            </div>
                            <p class="text-[15px] text-wiki-muted">
                                이 조건들을 종합하여 <span class="text-wiki-primary font-medium">\${overallTop5.length || fitTop10.length}개</span>의 직업을 추천합니다.
                            </p>
                        </div>
                    \` : ''}

                    <!-- 3세트 탭 -->
                    <div class="flex gap-3 mb-6">
                        <button onclick="showJobSet('overall')" class="job-set-tab active flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="overall">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">🏆</span>
                                <span>종합 추천</span>
                            </span>
                        </button>
                        <button onclick="showJobSet('fit')" class="job-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="fit">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">💪</span>
                                <span>잘 할 것 같은 직업</span>
                            </span>
                        </button>
                        <button onclick="showJobSet('desire')" class="job-set-tab flex-1 px-5 py-3.5 rounded-xl text-[15px] font-medium" data-set="desire">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">💖</span>
                                <span>좋아할만한 직업</span>
                            </span>
                        </button>
                    </div>
                    
                    <!-- 직업 카드들 -->
                    <div id="job-cards-container">
                        \${renderJobCardsV3((overallTop5.length > 0 ? overallTop5 : fitTop10).slice(0, 5), 'overall', profileInterpretation)}
                    </div>
                </div>
                
                <!-- 탭 컨텐츠: 분석 상세 (점수/신뢰도 정보) -->
                <div id="tab-details" class="report-tab-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
                    <div class="mb-8 pb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-center flex items-center justify-center gap-3">
                            <span class="text-3xl">📊</span>
                            <span class="bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">분석 상세 정보</span>
                        </h2>
                        <p class="text-center text-wiki-muted text-sm mt-2">AI 추천의 근거와 신뢰도를 확인하세요.</p>
                        <div class="mt-6 h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
                    </div>
                    <p class="text-base text-wiki-muted mb-6">이 섹션은 AI 추천의 근거, 사용된 알고리즘, 그리고 신뢰도를 상세히 보여줍니다.</p>

                    <!-- 분석 파이프라인 설명 -->
                    <div class="mb-8 p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.05)); border: 1px solid rgba(34,197,94,0.2);">
                        <h4 class="text-xl font-bold mb-4 text-emerald-400">🔬 분석 파이프라인</h4>
                        <div class="space-y-4 text-base">
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">1</span>
                                <div>
                                    <p class="font-medium text-white">벡터 검색 (Vectorize)</p>
                                    <p class="text-wiki-muted text-[15px]">당신의 답변을 임베딩으로 변환하여 7,000개 직업 DB에서 의미적으로 유사한 후보를 검색합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">2</span>
                                <div>
                                    <p class="font-medium text-white">TAG 필터링 (Hard Constraints)</p>
                                    <p class="text-wiki-muted text-[15px]">워라밸, 원격근무, 자격요건 등 절대 조건에 맞지 않는 직업을 제외합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">3</span>
                                <div>
                                    <p class="font-medium text-white">LLM Judge (GPT-4o-mini)</p>
                                    <p class="text-wiki-muted text-[15px]">남은 후보 60개에 대해 AI가 Like/Can/Fit 점수를 계산하고, 추천 이유를 생성합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-7 h-7 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm font-bold">4</span>
                                <div>
                                    <p class="font-medium text-white">LLM Reporter (심리분석)</p>
                                    <p class="text-wiki-muted text-[15px]">당신의 미니모듈 결과를 바탕으로 업무 스타일과 커리어 방향을 분석합니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 입력 데이터 요약 -->
                    <div class="mb-8">
                        <h4 class="text-xl font-bold mb-4">📝 분석에 사용된 입력 데이터</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-wiki-primary">\${report._factsCount || 0}</div>
                                <div class="text-base text-wiki-muted mt-1">수집된 팩트</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-emerald-400">\${report._answeredQuestions || 0}</div>
                                <div class="text-base text-wiki-muted mt-1">답변한 질문</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-purple-400">\${report._candidatesScored || 60}</div>
                                <div class="text-base text-wiki-muted mt-1">LLM 평가 직업</div>
                            </div>
                            <div class="p-4 rounded-xl bg-wiki-bg/50 text-center">
                                <div class="text-3xl font-bold text-amber-400">6</div>
                                <div class="text-base text-wiki-muted mt-1">LLM 호출 횟수</div>
                            </div>
                        </div>
                    </div>

                    <!-- 신뢰도 섹션 -->
                    <div class="mb-8 p-5 rounded-xl" style="background-color: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2);">
                        <h4 class="text-xl font-bold mb-4" style="color: rgb(165,180,252);">🎯 추천 신뢰도</h4>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="text-4xl font-bold" style="color: rgb(99,102,241);">\${Math.round((report._confidence || 0.75) * 100)}%</div>
                            <div class="flex-1">
                                <div class="h-4 bg-wiki-border/30 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-wiki-primary to-wiki-secondary transition-all" style="width: \${Math.round((report._confidence || 0.75) * 100)}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-base text-wiki-muted mb-4">
                            <p class="font-medium text-white mb-2">신뢰도란?</p>
                            <p>입력 데이터의 양과 질을 기반으로 계산됩니다. 답변이 구체적이고, 더 많은 질문에 응답할수록 신뢰도가 올라갑니다.</p>
                        </div>
                        <p class="text-base" style="color: rgba(165,180,252,0.9);">
                            \${(report._confidence || 0.75) >= 0.8
                                ? '✅ 충분한 정보를 바탕으로 신뢰도 높은 추천입니다.'
                                : (report._confidence || 0.75) >= 0.6
                                    ? '⚡ 기본적인 추천은 가능하지만, 더 많은 정보가 있으면 정확도가 올라갑니다.'
                                    : '⚠️ 제한된 정보로 추천했습니다. 추가 질문에 답변하시면 더 정확해집니다.'}
                        </p>
                    </div>

                    <!-- 점수 계산 방식 설명 -->
                    <div class="mb-8 p-5 rounded-xl bg-wiki-bg/30">
                        <h4 class="text-xl font-bold mb-4">💡 점수 계산 방식</h4>
                        <div class="space-y-3 text-base">
                            <div class="flex items-start gap-3">
                                <span class="text-emerald-400 font-bold text-lg shrink-0">Fit</span>
                                <div>
                                    <p class="text-white">종합 적합도</p>
                                    <p class="text-wiki-muted text-[15px]">Like × 0.55 + Can × 0.45 - Risk 로 계산됩니다. 좋아하면서 잘할 수 있는 직업이 높은 점수를 받습니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="text-purple-400 font-bold text-lg shrink-0">Like</span>
                                <div>
                                    <p class="text-white">좋아할 가능성</p>
                                    <p class="text-wiki-muted text-[15px]">관심 분야, 가치관, 우선순위가 직업의 특성과 얼마나 일치하는지 평가합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="text-blue-400 font-bold text-lg shrink-0">Can</span>
                                <div>
                                    <p class="text-white">잘할 가능성</p>
                                    <p class="text-wiki-muted text-[15px]">강점, 업무 스타일, 경험이 직업의 요구사항과 얼마나 맞는지 평가합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="text-red-400 font-bold text-lg shrink-0">Risk</span>
                                <div>
                                    <p class="text-white">위험 요소</p>
                                    <p class="text-wiki-muted text-[15px]">절대 피하고 싶은 조건, 에너지 소모원과 직업 환경이 충돌할 때 페널티가 적용됩니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 데이터 소스 -->
                    <div class="p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                        <h4 class="text-xl font-bold mb-4 text-purple-400">📚 데이터 소스</h4>
                        <div class="grid md:grid-cols-2 gap-4 text-base">
                            <div>
                                <p class="font-medium text-white mb-1">직업 정보</p>
                                <p class="text-wiki-muted text-[15px]">커리어넷 + 고용24 + 워크넷 데이터 통합 (약 7,000개 직업)</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">직업 속성 태깅</p>
                                <p class="text-wiki-muted text-[15px]">job_attributes 테이블: 워라밸, 성장성, 자격요건 등 15개 속성</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">임베딩 모델</p>
                                <p class="text-wiki-muted text-[15px]">OpenAI text-embedding-3-small (1536차원)</p>
                            </div>
                            <div>
                                <p class="font-medium text-white mb-1">판단 모델</p>
                                <p class="text-wiki-muted text-[15px]">GPT-4o-mini (Like/Can/Fit 점수 및 추천 이유 생성)</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 하단: 다시 시작 버튼 -->
                <div class="text-center mt-8">
                    <a href="/analyzer" class="inline-flex items-center gap-2 px-6 py-3 bg-wiki-card border border-wiki-border rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-redo"></i>
                        <span>다시 분석하기</span>
                    </a>
                </div>
            \`;
            
            // 스타일 추가
            addReportStyles();
            
            // 전역 데이터 저장 (탭 전환용 + Evidence 시스템)
            // Evidence 데이터 매핑 (job_id → evidence_links)
            const evidenceMap = {};
            (result.fit_top3 || []).forEach(job => {
                if (job.evidence_links?.length > 0) {
                    evidenceMap[job.job_id] = job.evidence_links;
                }
            });
            
            window.currentReportData = {
                report,
                overallTop5,
                fitTop10,
                likeTop10,
                evidenceMap,  // Evidence 데이터 추가
                profileInterpretation,  // 프로필 해석 데이터
            };
        }
        
        // 탭 전환
        function showReportTab(tabId) {
            document.querySelectorAll('.report-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.report-tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId)?.classList.remove('hidden');
            document.querySelector('.report-tab[data-tab="' + tabId + '"]')?.classList.add('active');
        }
        
        // 결과 전체 복사 기능 (데이터 기반 - DOM이 아닌 실제 데이터에서 추출)
        function copyAllReportContent() {
            const data = window.currentReportData;
            if (!data) { alert('리포트 데이터가 없습니다.'); return; }
            const report = data.report || {};
            const pi = data.profileInterpretation;
            const mm = window.miniModuleResult || {};

            let t = '=== AI 커리어 분석 리포트 ===\\n';
            t += '생성일: ' + new Date().toLocaleDateString('ko-KR') + '\\n\\n';

            // ── 1. 요약 ──
            t += '━━━ 📋 요약 ━━━\\n\\n';
            const headline = report.executiveSummary || report.summary_one_page?.headline || '';
            if (headline) t += headline + '\\n\\n';
            const takeaways = report.lifeVersionStatement?.expanded || report.summary_one_page?.top_takeaways || [];
            if (takeaways.length > 0) {
                t += '▸ 핵심 포인트\\n';
                takeaways.forEach(function(item) { t += '  • ' + item + '\\n'; });
                t += '\\n';
            }
            const nextStep = report.expertGuidance?.doNow?.[0] || report.summary_one_page?.recommended_next_step || '';
            if (nextStep) t += '▸ 다음 단계: ' + nextStep + '\\n\\n';

            // 나의 커리어 프로필
            if (pi) {
                t += '▸ 나의 커리어 프로필\\n';
                if (pi.interests?.length) t += '  흥미: ' + pi.interests.map(function(i){return i.label}).join(', ') + '\\n';
                if (pi.strengths?.length) t += '  강점: ' + pi.strengths.map(function(s){return s.label}).join(', ') + '\\n';
                if (pi.values?.length) t += '  가치: ' + pi.values.map(function(v){return v.label}).join(', ') + '\\n';
                if (pi.constraints?.length) t += '  제약: ' + pi.constraints.map(function(c){return c.label}).join(', ') + '\\n';
                t += '\\n';
            }

            // 요약 Top 3 직업
            const summaryJobs = (data.overallTop5 || data.fitTop10 || []).slice(0, 3);
            if (summaryJobs.length > 0) {
                t += '▸ 추천 직업 Top 3\\n';
                summaryJobs.forEach(function(job, i) {
                    const name = job.job_name || job.job_id || '';
                    const fit = job.scores?.fit || job.fit_score || '-';
                    const like = job.scores?.like || job.like_score || '-';
                    const can = job.scores?.can || job.can_score || '-';
                    t += '  ' + (i+1) + '. ' + name + ' (Fit:' + fit + ' Like:' + like + ' Can:' + can + ')\\n';
                    if (job.like_reason) t += '     Like: ' + job.like_reason + '\\n';
                    if (job.can_reason) t += '     Can: ' + job.can_reason + '\\n';
                });
                t += '\\n';
            }

            // ── 2. 메타인지 ──
            t += '━━━ 🧠 메타인지 ━━━\\n\\n';
            const personality = report.workStyleNarrative || report.lifeVersionStatement?.oneLiner || '';
            if (personality) t += '▸ 성격 요약\\n  ' + personality + '\\n\\n';

            const workInsights = [
                report.workStyleMap?.socialStyle ? translateToKorean(report.workStyleMap.socialStyle) + ' 업무 스타일' : null,
                report.workStyleMap?.decisionStyle ? translateToKorean(report.workStyleMap.decisionStyle) + ' 의사결정' : null,
                report.growthCurveDescription || null,
            ].filter(Boolean);
            if (workInsights.length > 0) {
                t += '▸ 업무 스타일\\n';
                workInsights.forEach(function(w) { t += '  • ' + w + '\\n'; });
                t += '\\n';
            }

            const valuePriorities = mm.value_top?.map(function(v){return translateToKorean(v)}) || report.personal_analysis?.value_priorities || [];
            if (valuePriorities.length > 0) t += '▸ 가치 우선순위: ' + valuePriorities.join(', ') + '\\n\\n';

            if (report.innerConflictAnalysis) t += '▸ 내면 갈등 분석\\n  ' + report.innerConflictAnalysis + '\\n\\n';
            if (report.conflictPatterns?.length) {
                t += '▸ 갈등 패턴\\n';
                report.conflictPatterns.forEach(function(p) { t += '  • ' + p + '\\n'; });
                t += '\\n';
            }

            if (report.stressProfile) t += '▸ 스트레스 프로필: ' + report.stressProfile + '\\n';
            if (report.stressTriggers?.length) {
                t += '▸ 스트레스 요인\\n';
                report.stressTriggers.forEach(function(s) { t += '  • ' + s + '\\n'; });
                t += '\\n';
            }
            if (report.failurePattern) t += '▸ 실패 패턴: ' + report.failurePattern + '\\n\\n';

            // 메타인지 (metaCognition)
            const mc = report.metaCognition;
            if (mc) {
                if (mc.strengths?.length) {
                    t += '▸ 메타인지 강점\\n';
                    mc.strengths.forEach(function(s) { t += '  • ' + (s.label || s) + (s.detail ? ': ' + s.detail : '') + '\\n'; });
                    t += '\\n';
                }
                if (mc.values?.length) {
                    t += '▸ 메타인지 가치\\n';
                    mc.values.forEach(function(v) { t += '  • ' + (v.label || v) + (v.detail ? ': ' + v.detail : '') + '\\n'; });
                    t += '\\n';
                }
                if (mc.stressPoints?.length) {
                    t += '▸ 스트레스 포인트\\n';
                    mc.stressPoints.forEach(function(s) { t += '  • ' + (s.label || s) + (s.detail ? ': ' + s.detail : '') + '\\n'; });
                    t += '\\n';
                }
            }

            // 5축 워크스타일 맵
            const wsm = report.workStyleMap;
            if (wsm && (wsm.analytical_vs_creative !== undefined)) {
                t += '▸ 5축 워크스타일\\n';
                t += '  분석↔창의: ' + (wsm.analytical_vs_creative || 0) + '\\n';
                t += '  독립↔협업: ' + (wsm.solo_vs_team || 0) + '\\n';
                t += '  체계↔유연: ' + (wsm.structured_vs_flexible || 0) + '\\n';
                t += '  깊이↔넓이: ' + (wsm.depth_vs_breadth || 0) + '\\n';
                t += '  가이드↔자율: ' + (wsm.guided_vs_autonomous || 0) + '\\n\\n';
            }

            // ── 3. 추천 직업 (3세트 전부) ──
            t += '━━━ 💼 추천 직업 ━━━\\n\\n';

            function formatJobList(jobs, label) {
                if (!jobs || jobs.length === 0) return '';
                let s = '▸ ' + label + '\\n';
                jobs.forEach(function(job, i) {
                    const name = job.job_name || job.job_id || '';
                    const fit = job.scores?.fit || job.fit_score || '-';
                    const like = job.scores?.like || job.like_score || '-';
                    const can = job.scores?.can || job.can_score || '-';
                    const desc = (job.job_description || job.description || job.summary || '').replace(/\\n/g, ' ').trim();
                    s += '  ' + (i+1) + '. ' + name + ' (Fit:' + fit + ' Like:' + like + ' Can:' + can + ')\\n';
                    if (desc) s += '     ' + desc.substring(0, 100) + (desc.length > 100 ? '...' : '') + '\\n';
                    if (job.like_reason) s += '     💜 Like: ' + job.like_reason + '\\n';
                    if (job.can_reason) s += '     💪 Can: ' + job.can_reason + '\\n';
                    if (job.dislike_warnings?.length) s += '     ⚠️ 주의: ' + job.dislike_warnings.join(', ') + '\\n';
                });
                return s + '\\n';
            }

            const overallJobs = (data.overallTop5 || data.fitTop10 || []).slice(0, 5);
            const fitJobs = (data.fitTop10 || []).slice(0, 10);
            const likeJobs = (data.likeTop10 || data.fitTop10 || []).slice(0, 10);

            t += formatJobList(overallJobs, '🏆 종합 추천 Top 5');
            t += formatJobList(fitJobs, '💪 잘 할 것 같은 직업 Top 10');
            t += formatJobList(likeJobs, '💖 좋아할만한 직업 Top 10');

            // ── 4. 전문가 가이던스 ──
            const eg = report.expertGuidance;
            if (eg && (eg.doNow?.length || eg.stopDoing?.length || eg.learnNext?.length || eg.avoidPaths?.length)) {
                t += '━━━ 🎯 전문가 가이던스 ━━━\\n\\n';
                if (eg.doNow?.length) { t += '▸ 지금 당장\\n'; eg.doNow.forEach(function(a){ t += '  • ' + a + '\\n'; }); t += '\\n'; }
                if (eg.stopDoing?.length) { t += '▸ 멈출 것\\n'; eg.stopDoing.forEach(function(a){ t += '  • ' + a + '\\n'; }); t += '\\n'; }
                if (eg.learnNext?.length) { t += '▸ 배울 것\\n'; eg.learnNext.forEach(function(a){ t += '  • ' + a + '\\n'; }); t += '\\n'; }
                if (eg.avoidPaths?.length) { t += '▸ 피할 것\\n'; eg.avoidPaths.forEach(function(a){ t += '  • ' + a + '\\n'; }); t += '\\n'; }
            }

            // 30/60/90일 전환 계획
            const tt = report.transitionTiming;
            if (tt && (tt.day30?.goal || tt.day60?.goal || tt.day90?.goal)) {
                t += '━━━ 📅 전환 계획 ━━━\\n\\n';
                ['day30','day60','day90'].forEach(function(key) {
                    const d = tt[key];
                    if (!d?.goal) return;
                    const label = key === 'day30' ? '30일' : key === 'day60' ? '60일' : '90일';
                    t += '▸ ' + label + ': ' + d.goal + '\\n';
                    if (d.actions?.length) d.actions.forEach(function(a){ t += '  • ' + a + '\\n'; });
                    if (d.milestone) t += '  ✓ 마일스톤: ' + d.milestone + '\\n';
                    t += '\\n';
                });
            }

            // 인생 버전 선언문
            if (report.lifeVersionStatement?.oneLiner) {
                t += '━━━ ✨ 인생 버전 선언문 ━━━\\n\\n';
                t += report.lifeVersionStatement.oneLiner + '\\n\\n';
            }

            // ── 5. 분석 상세 (DOM에서 추출 - 점수/기술 정보) ──
            const detailEl = document.getElementById('tab-details');
            if (detailEl) {
                t += '━━━ 📊 분석 상세 ━━━\\n\\n';
                const wasHidden = detailEl.classList.contains('hidden');
                detailEl.classList.remove('hidden');
                t += detailEl.innerText.trim() + '\\n';
                if (wasHidden) detailEl.classList.add('hidden');
            }

            navigator.clipboard.writeText(t).then(function() {
                alert('리포트 전체 내용이 클립보드에 복사되었습니다!');
            }).catch(function(err) {
                console.error('복사 실패:', err);
                const textarea = document.createElement('textarea');
                textarea.value = t;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('리포트 전체 내용이 클립보드에 복사되었습니다!');
            });
        }
        
        // 분석 초기화 기능 (테스트용)
        function resetAnalyzer() {
            if (!confirm('정말 처음부터 다시 시작하시겠습니까?\\n현재까지의 모든 답변이 초기화됩니다.')) {
                return;
            }
            
            // 로컬 스토리지의 draft 데이터 삭제
            localStorage.removeItem('analyzer_draft');
            localStorage.removeItem('analyzer_draft_timestamp');
            
            // 서버의 draft도 삭제 시도 (옵션)
            fetch('/api/ai-analyzer/draft', {
                method: 'DELETE',
                credentials: 'same-origin'
            }).catch(() => {});
            
            // 모든 상태 초기화
            window.currentStep = 1;
            window.currentRound = null;
            window.savedAnswers = {};
            window.collectedCareerState = {};
            window.universalAnswers = {};
            window.narrativeAnswers = {};
            window.roundAnswers = {};
            window.stepScrollPositions = {};
            
            // UI 초기화
            goToStep(1);
            
            // 페이지 새로고침
            window.location.reload();
        }
        
        // 직업 세트 전환
        function showJobSet(setId) {
            const data = window.currentReportData;
            if (!data) return;

            let jobList = [];

            if (setId === 'overall') jobList = (data.overallTop5 || data.fitTop10 || []).slice(0, 5);  // 종합 추천: 5개
            else if (setId === 'fit') jobList = (data.fitTop10 || []).slice(0, 10);  // 잘 할 것 같은 직업: 10개
            else if (setId === 'desire') jobList = (data.likeTop10 || data.fitTop10 || []).slice(0, 10);  // 좋아할만한 직업: 10개

            // setId와 profileInterpretation을 전달하여 탭별로 다른 이유 및 매칭 태그 표시
            document.getElementById('job-cards-container').innerHTML = renderJobCardsV3(jobList, setId, data.profileInterpretation);

            document.querySelectorAll('.job-set-tab').forEach(el => el.classList.remove('active'));
            document.querySelector('.job-set-tab[data-set="' + setId + '"]')?.classList.add('active');
        }
        
        // V3 직업 카드 렌더링 (PremiumReport 데이터 구조용) - 컴팩트 디자인
        // setId: 'overall' | 'fit' | 'desire'
        // profileInterp: ProfileInterpretation 데이터 (매칭 태그용)
        function renderJobCardsV3(jobs, setId = 'overall', profileInterp = null) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">추천 결과가 없습니다.</p>';
            }

            // rationale 파싱 헬퍼 함수
            const extractLikeReason = (r) => {
                if (!r || r.includes('자동 생성된 결과')) return null;
                const match = r.match(/\\[좋아할 이유\\]\\s*(.+?)(?=\\[|$)/s)
                    || r.match(/\\[1\\]\\s*(.+?)(?=\\[2\\]|$)/s);
                return match ? match[1].trim() : null;
            };
            const extractCanReason = (r) => {
                if (!r || r.includes('자동 생성된 결과')) return null;
                const match = r.match(/\\[잘할 이유\\]\\s*(.+?)(?=\\[|$)/s)
                    || r.match(/\\[2\\]\\s*(.+?)(?=\\[3\\]|\\[리스크\\]|$)/s);
                return match ? match[1].trim() : null;
            };

            return jobs.map((job, idx) => {
                const jobName = job.job_name || job.job_id || '직업';
                const jobSlug = job.slug || job.job_id || '';
                // 이미지 URL 인코딩 (한글 파일명 처리)
                let imageUrl = job.image_url || '';
                if (imageUrl && imageUrl.includes('/uploads/')) {
                    const parts = imageUrl.split('/');
                    const filename = parts.pop();
                    imageUrl = parts.join('/') + '/' + encodeURIComponent(filename);
                }
                const rationale = job.rationale || job.one_line_why || '';
                const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                // fallback 1: rationale에서 첫 문장 추출 (자동 생성 아닌 경우)
                // fallback 2: 직업명 기반 기본 설명
                const displayDescription = description
                    || (rationale && !rationale.includes('자동 생성') ? rationale.split('.')[0] + '.' : '')
                    || \`\${jobName} 직업에 대해 더 알아보세요.\`;
                const dislikeWarnings = job.dislike_warnings || [];
                const fitScore = job.scores?.fit || job.fit_score || '-';
                const likeScore = job.scores?.like || job.like_score || '-';
                const canScore = job.scores?.can || job.can_score || '-';

                // 탭별 주점수 및 이유 결정
                let mainScore, mainScoreLabel, mainScoreColor;
                let likeReasonText = job.like_reason || extractLikeReason(rationale) || '';
                let canReasonText = job.can_reason || extractCanReason(rationale) || '';

                // 자동 생성 결과 필터링
                const isAutoGenerated = rationale.includes('자동 생성된 결과') || rationale.includes('LLM 분석이 진행되지');
                if (likeReasonText.includes('자동 생성된 결과')) likeReasonText = '';
                if (canReasonText.includes('자동 생성된 결과')) canReasonText = '';

                // LLM 분석 없이 자동 생성된 경우, 점수 기반 기본 이유 생성
                if (!likeReasonText && !isAutoGenerated && rationale && !rationale.includes('[')) {
                    likeReasonText = rationale;  // 일반 rationale을 like 이유로 사용
                }
                if (!likeReasonText && likeScore !== '-') {
                    const score = parseInt(likeScore) || 0;
                    if (score >= 70) likeReasonText = '당신의 관심사와 가치관에 잘 맞는 직업입니다.';
                    else if (score >= 50) likeReasonText = '흥미로운 업무 환경을 제공할 수 있습니다.';
                }
                if (!canReasonText && canScore !== '-') {
                    const score = parseInt(canScore) || 0;
                    if (score >= 70) canReasonText = '당신의 강점을 잘 발휘할 수 있는 분야입니다.';
                    else if (score >= 50) canReasonText = '성장 가능성이 있는 분야입니다.';
                }

                if (setId === 'desire') {
                    mainScore = likeScore;
                    mainScoreLabel = 'Like';
                    mainScoreColor = 'text-purple-400';
                } else if (setId === 'fit') {
                    mainScore = canScore;
                    mainScoreLabel = 'Can';
                    mainScoreColor = 'text-blue-400';
                } else {
                    mainScore = fitScore;
                    mainScoreLabel = 'Fit';
                    mainScoreColor = 'text-emerald-400';
                }

                // 이유 HTML 생성 (카드 내부에 표시)
                let reasonOuterHtml = '';
                if (setId === 'overall') {
                    if (likeReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">💜 Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
                    if (canReasonText) reasonOuterHtml += '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">💪 Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
                } else if (setId === 'desire') {
                    if (likeReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-purple-400 font-medium shrink-0 text-[13px] w-12">💜 Like</span><p class="text-[14px] text-purple-300/90 leading-relaxed">' + likeReasonText + '</p></div>';
                } else {
                    if (canReasonText) reasonOuterHtml = '<div class="flex gap-3 items-start"><span class="text-blue-400 font-medium shrink-0 text-[13px] w-12">💪 Can</span><p class="text-[14px] text-blue-300/90 leading-relaxed">' + canReasonText + '</p></div>';
                }

                const rankBadge = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : \`\${idx + 1}\`;
                const rankColor = idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,116,139,0.4)';

                // B: 프로필 매칭 포인트 생성
                const matchingTags = [];
                const likeNum = parseInt(likeScore) || 0;
                const canNum = parseInt(canScore) || 0;
                const riskPenalty = job.riskPenalty || job.risk_penalty || 0;

                // profileInterpretation에서 토큰 가져오기
                const pi = profileInterp || {};
                const interestLabels = (pi.interests || []).slice(0, 2).map(i => i.label);
                const strengthLabels = (pi.strengths || []).slice(0, 2).map(s => s.label);
                const constraintLabels = (pi.constraints || []).slice(0, 1).map(c => c.label);

                // Like 점수 기반 흥미/가치 매칭
                if (likeNum >= 65 && interestLabels.length > 0) {
                    matchingTags.push({ icon: '💚', label: interestLabels[0] + ' 흥미', color: 'green' });
                }
                // Can 점수 기반 강점 매칭
                if (canNum >= 65 && strengthLabels.length > 0) {
                    matchingTags.push({ icon: '💪', label: strengthLabels[0] + ' 강점', color: 'blue' });
                }
                // 제약 충족 (Risk 페널티 없음)
                if (riskPenalty <= 5 && constraintLabels.length > 0) {
                    matchingTags.push({ icon: '✅', label: '제약 충족', color: 'emerald' });
                }

                const matchingTagsHtml = matchingTags.length > 0 ? \`
                    <div class="flex flex-wrap gap-1.5 mt-2">
                        \${matchingTags.map(tag => \`
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs"
                                  style="background: rgba(\${tag.color === 'green' ? '34,197,94' : tag.color === 'blue' ? '59,130,246' : '16,185,129'},0.15); color: rgb(\${tag.color === 'green' ? '134,239,172' : tag.color === 'blue' ? '147,197,253' : '110,231,183'});">
                                <span>\${tag.icon}</span>
                                <span>\${tag.label}</span>
                            </span>
                        \`).join('')}
                    </div>
                \` : '';

                // 점수 바 너비 계산 (0-100)
                const fitNum = parseInt(fitScore) || 0;
                const likeNum2 = parseInt(likeScore) || 0;
                const canNum2 = parseInt(canScore) || 0;

                return \`
                <div class="rounded-2xl overflow-hidden group transition-all mb-4" style="background: linear-gradient(135deg, rgba(30,30,50,0.9), rgba(25,25,45,0.95)); border: 1px solid rgba(99,102,241,\${idx < 3 ? '0.25' : '0.12'});">
                    <!-- 상단: 썸네일 + 직업 정보 -->
                    <div class="flex items-stretch">
                        <!-- 썸네일 (카드 높이 꽉 채움) -->
                        \${imageUrl && imageUrl.trim() ? \`
                            <div class="flex-shrink-0 w-28 sm:w-32 relative overflow-hidden">
                                <img src="\${imageUrl}" alt="\${jobName}"
                                     class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center\\' style=\\'background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));\\' ><i class=\\'fas fa-briefcase text-2xl text-wiki-muted\\'></i></div>';" />
                                <div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
                                    <span class="\${idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted'}">\${rankBadge}</span>
                                </div>
                            </div>
                        \` : \`
                            <div class="flex-shrink-0 w-28 sm:w-32 relative flex items-center justify-center" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));">
                                <i class="fas fa-briefcase text-2xl text-wiki-muted"></i>
                                <div class="absolute top-2 left-2 w-7 h-7 flex items-center justify-center rounded-full" style="background: rgba(0,0,0,0.6);">
                                    <span class="\${idx < 3 ? 'text-sm' : 'text-xs font-bold text-wiki-muted'}">\${rankBadge}</span>
                                </div>
                            </div>
                        \`}

                        <!-- 직업 정보 + 점수 -->
                        <div class="flex-1 min-w-0 p-4 flex flex-col justify-between">
                            <div>
                                <!-- 직업명 + 메인 점수 -->
                                <div class="flex items-start justify-between gap-3 mb-1.5">
                                    <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="group-hover:text-wiki-primary transition">
                                        <h4 class="font-bold text-lg text-white leading-tight">\${jobName}</h4>
                                    </a>
                                    <div class="flex-shrink-0 text-right">
                                        <span class="text-xl font-bold \${mainScoreColor}">\${mainScore}</span>
                                        <span class="text-xs text-wiki-muted ml-0.5">\${mainScoreLabel}</span>
                                    </div>
                                </div>

                                <!-- 직업 설명 -->
                                \${displayDescription ? \`<p class="text-[14px] text-wiki-muted line-clamp-2 leading-relaxed mb-2">\${displayDescription}</p>\` : ''}

                                <!-- 매칭 태그 -->
                                \${matchingTagsHtml}
                                \${dislikeWarnings.length > 0 ? \`
                                    <p class="text-[13px] text-orange-400/80 line-clamp-1 mt-1.5">⚠️ \${dislikeWarnings[0]?.label || ''}</p>
                                \` : ''}
                            </div>

                            <!-- 점수 바 (3점 비교) -->
                            <div class="flex items-center gap-4 mt-3 pt-2.5" style="border-top: 1px solid rgba(255,255,255,0.06);">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-emerald-400/80 font-medium">Fit</span>
                                        <span class="text-[11px] text-emerald-400 font-semibold">\${fitScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(fitNum, 100)}%; background: rgb(52,211,153);"></div>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-purple-400/80 font-medium">Like</span>
                                        <span class="text-[11px] text-purple-400 font-semibold">\${likeScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(likeNum2, 100)}%; background: rgb(168,85,247);"></div>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[11px] text-blue-400/80 font-medium">Can</span>
                                        <span class="text-[11px] text-blue-400 font-semibold">\${canScore}</span>
                                    </div>
                                    <div class="h-1 rounded-full" style="background: rgba(255,255,255,0.06);">
                                        <div class="h-full rounded-full transition-all" style="width: \${Math.min(canNum2, 100)}%; background: rgb(96,165,250);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 하단: 추천 이유 (Like/Can) -->
                    \${reasonOuterHtml ? \`
                    <div class="px-4 pb-4 pt-0">
                        <div class="p-3 rounded-xl space-y-2" style="background: rgba(99,102,241,0.06); border: 1px solid rgba(99,102,241,0.1);">
                            \${reasonOuterHtml}
                        </div>
                    </div>
                    \` : ''}

                    <!-- 하단 액션 바 -->
                    <div class="flex items-center justify-between px-4 pb-3 \${reasonOuterHtml ? '' : 'pt-0'}">
                        <button onclick="event.stopPropagation(); toggleJobScoresCompact(this)" class="text-[13px] text-wiki-muted hover:text-wiki-primary transition flex items-center gap-1.5" title="상세 점수">
                            <i class="fas fa-chart-bar"></i>
                            <span>상세 점수</span>
                        </button>
                        \${jobSlug ? \`<a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="text-[13px] text-wiki-primary hover:text-indigo-300 font-medium transition flex items-center gap-1">
                            <span>상세 보기</span>
                            <i class="fas fa-arrow-right text-[11px]"></i>
                        </a>\` : ''}
                    </div>

                    <!-- 점수 상세 (기본 숨김) -->
                    <div class="score-details-compact hidden px-4 pb-3">
                        <div class="p-3 rounded-lg" style="background-color: rgba(26,26,46,0.5);">
                            <div class="flex items-center gap-6 text-base">
                                <div class="flex items-center gap-1.5">
                                    <span class="text-emerald-400 font-semibold">\${fitScore}</span>
                                    <span class="text-wiki-muted">Fit</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="text-purple-400 font-semibold">\${likeScore}</span>
                                    <span class="text-wiki-muted">Like</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="text-blue-400 font-semibold">\${canScore}</span>
                                    <span class="text-wiki-muted">Can</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                \`;
            }).join('');
        }
        
        // 컴팩트 점수 토글
        function toggleJobScoresCompact(btn) {
            const card = btn.closest('.rounded-2xl');
            if (!card) return;
            const details = card.querySelector('.score-details-compact');
            if (details) {
                details.classList.toggle('hidden');
            }
        }
        window.toggleJobScoresCompact = toggleJobScoresCompact;
        
        // (기존 큰 카드용 함수 유지 - 호환성)
        function renderJobCardsV3Large(jobs) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">추천 결과가 없습니다.</p>';
            }
            
            return jobs.map((job, idx) => {
                const jobName = job.job_name || job.job_id || '직업';
                const jobSlug = job.slug || job.job_id || '';
                const imageUrl = job.image_url || '';
                const rationale = job.rationale || job.one_line_why || '';
                const description = (job.job_description || job.description || job.summary || '').replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ').trim();
                const growthPath = job.growth_path || job.first30DaysPlan || [];
                const risks = job.risks || [];
                const dislikeWarnings = job.dislike_warnings || [];
                const fitScore = job.scores?.fit || job.fit_score || '-';
                const likeScore = job.scores?.like || job.like_score || '-';
                const canScore = job.scores?.can || job.can_score || '-';
                
                return \`
                <div class="glass-card p-5 rounded-xl group" style="border-left: 4px solid \${idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,100,120,0.3)'};">
                    <a href="/job/\${jobSlug}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        \${imageUrl ? \`
                            <div class="mb-4 overflow-hidden rounded-lg" style="aspect-ratio: 16/9;">
                                <img src="\${imageUrl}" alt="\${jobName}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">\${idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '📌'}</span>
                                <div>
                                    <h4 class="font-bold text-lg group-hover:text-wiki-primary transition">\${jobName}</h4>
                                    <span class="text-xs text-wiki-primary">자세히 보기 →</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    \${dislikeWarnings.length > 0 ? \`
                        <div class="p-2 rounded-lg mb-3" style="background-color: rgba(251,146,60,0.15); border: 1px solid rgba(251,146,60,0.3);">
                            <div class="text-xs space-y-1">
                                \${dislikeWarnings.map(w => \`<div class="\${w.severity === 'high' ? 'text-orange-400 font-medium' : 'text-amber-400/80'}">\${w.label}</div>\`).join('')}
                            </div>
                        </div>
                    \` : ''}
                    \${rationale ? \`
                        <div class="mb-3 p-3 rounded-lg" style="background-color: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.15);">
                            <div class="text-xs font-medium text-emerald-400 mb-1">💡 추천 이유</div>
                            <p class="text-sm text-white/90">\${rationale}</p>
                        </div>
                    \` : ''}
                    \${description ? \`<p class="text-sm text-wiki-muted/80 mb-3 line-clamp-2">\${description}</p>\` : ''}
                    \${growthPath.length > 0 ? \`
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(99,102,241,0.1);">
                            <div class="text-xs font-medium text-indigo-400 mb-2">🚀 성장 경로</div>
                            <ol class="text-xs text-wiki-muted space-y-1 list-decimal list-inside">
                                \${growthPath.slice(0, 3).map(p => \`<li>\${p}</li>\`).join('')}
                            </ol>
                        </div>
                    \` : ''}
                    \${risks.length > 0 ? \`
                        <div class="p-2 rounded-lg mb-3" style="background-color: rgba(239,68,68,0.1);">
                            <div class="text-xs text-red-400">\${risks.slice(0, 2).map(r => '⚠️ ' + r).join(' · ')}</div>
                        </div>
                    \` : ''}
                    <div class="flex items-center gap-3 mt-2 flex-wrap">
                        <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition">
                            <i class="fas fa-info-circle"></i>
                            <span>상세 점수</span>
                            <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                        </button>
                        <button onclick="showJobEvidence('\${job.job_id || job.slug}', '\${jobName}')" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-emerald-400 transition evidence-trigger">
                            <i class="fas fa-search"></i>
                            <span>근거 보기</span>
                        </button>
                    </div>
                    <div class="score-details hidden mt-3 pt-3 border-t border-wiki-border/30">
                        <div class="grid grid-cols-3 gap-2">
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(16,185,129,0.1);">
                                <div class="text-sm font-medium text-emerald-400">\${fitScore}</div>
                                <div class="text-xs text-wiki-muted">Fit</div>
                            </div>
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(168,85,247,0.1);">
                                <div class="text-sm font-medium text-purple-400">\${likeScore}</div>
                                <div class="text-xs text-wiki-muted">Like</div>
                            </div>
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(59,130,246,0.1);">
                                <div class="text-sm font-medium text-blue-400">\${canScore}</div>
                                <div class="text-xs text-wiki-muted">Can</div>
                            </div>
                        </div>
                    </div>
                </div>
                \`;
            }).join('');
        }
        
        // 직업 카드 렌더링
        function renderJobCards(jobs, setId) {
            if (!jobs || jobs.length === 0) {
                return '<p class="text-wiki-muted text-center py-8">추천 결과가 없습니다.</p>';
            }
            
            return jobs.map((job, idx) => \`
                <div class="glass-card p-5 rounded-xl group" style="border-left: 4px solid \${idx < 3 ? 'rgba(99,102,241,0.8)' : 'rgba(100,100,120,0.3)'};">
                    <!-- 클릭 가능한 상단 영역 -->
                    <a href="/job/\${job.slug || job.job_id}" target="_blank" rel="noopener noreferrer" class="block hover:opacity-90 transition">
                        <!-- 썸네일 이미지 -->
                        \${job.image_url ? \`
                            <div class="mb-4 overflow-hidden rounded-lg">
                                <img src="\${job.image_url}" alt="\${job.job_name}" class="w-full h-40 object-cover group-hover:scale-105 transition-transform" />
                            </div>
                        \` : ''}
                        
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">\${idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '📌'}</span>
                                <div>
                                    <h4 class="font-bold text-lg group-hover:text-wiki-primary transition">\${job.job_name}</h4>
                                    <span class="text-xs text-wiki-primary">자세히 보기 →</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    
                    <!-- 추천 이유 -->
                    \${job.rationale ? \`
                        <p class="text-sm text-wiki-muted mb-3">\${job.rationale}</p>
                    \` : ''}
                    
                    <!-- 30일 플랜 -->
                    \${job.first30DaysPlan?.length > 0 ? \`
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(99,102,241,0.1);">
                            <div class="text-xs font-medium text-indigo-400 mb-2">🚀 30일 실행 플랜</div>
                            <ol class="text-xs text-wiki-muted space-y-1 list-decimal list-inside">
                                \${job.first30DaysPlan.map(p => \`<li>\${p}</li>\`).join('')}
                            </ol>
                        </div>
                    \` : ''}
                    
                    <!-- 상세 점수 토글 버튼 -->
                    <button onclick="toggleJobScores(this)" class="flex items-center gap-1.5 text-xs text-wiki-muted hover:text-wiki-primary transition mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>상세 점수 보기</span>
                        <i class="fas fa-chevron-down text-[10px] transition-transform score-toggle-icon"></i>
                    </button>
                    
                    <!-- 점수 상세 (기본 숨김) -->
                    <div class="score-details hidden mt-3 pt-3 border-t border-wiki-border/30">
                        <!-- 점수 바 -->
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(16,185,129,0.1);">
                                <div class="text-sm font-medium text-emerald-400">\${job.fitScore || job.fit_score || '-'}</div>
                                <div class="text-xs text-wiki-muted">Fit</div>
                            </div>
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(168,85,247,0.1);">
                                <div class="text-sm font-medium text-purple-400">\${job.desireScore || job.like_score || '-'}</div>
                                <div class="text-xs text-wiki-muted">Like</div>
                            </div>
                            <div class="text-center p-2 rounded-lg" style="background-color: rgba(59,130,246,0.1);">
                                <div class="text-sm font-medium text-blue-400">\${job.feasibilityScore || job.can_score || '-'}</div>
                                <div class="text-xs text-wiki-muted">Can</div>
                            </div>
                        </div>
                        
                        <!-- 리스크 플래그 -->
                        \${job.riskFlags?.length > 0 ? \`
                            <div class="flex flex-wrap gap-1 mb-3">
                                \${job.riskFlags.map(f => \`<span class="px-2 py-0.5 bg-red-500/20 text-red-300 rounded text-xs">⚠️ \${f}</span>\`).join('')}
                            </div>
                        \` : ''}
                        
                        <!-- 근거 인용 -->
                        \${job.evidenceQuotes?.length > 0 ? \`
                            <div class="p-3 rounded-lg" style="background-color: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2);">
                                <div class="text-xs font-medium text-amber-400 mb-2">📝 근거 인용</div>
                                <ul class="text-xs text-wiki-muted space-y-1">
                                    \${job.evidenceQuotes.slice(0, 3).map(eq => \`<li>"<em>\${eq.text}</em>"</li>\`).join('')}
                                </ul>
                            </div>
                        \` : ''}
                    </div>
                </div>
            \`).join('');
        }
        
        // 점수 상세 토글
        function toggleJobScores(btn) {
            const card = btn.closest('.glass-card');
            const details = card.querySelector('.score-details');
            const icon = btn.querySelector('.score-toggle-icon');
            const label = btn.querySelector('span');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                label.textContent = '숨기기';
            } else {
                details.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
                label.textContent = '상세 점수';
            }
        }
        window.toggleJobScores = toggleJobScores;
        
        // ============================================
        // Evidence 모달 시스템
        // ============================================
        function showJobEvidence(jobId, jobName) {
            const data = window.currentReportData;
            if (!data || !data.evidenceMap) {
                showErrorToast('근거 데이터를 불러올 수 없습니다.');
                return;
            }
            
            const evidenceLinks = data.evidenceMap[jobId] || [];
            
            // 모달 생성
            const modal = document.createElement('div');
            modal.id = 'evidence-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.cssText = 'background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
            modal.onclick = (e) => { if (e.target === modal) closeEvidenceModal(); };
            
            // 매칭 타입별 보더 색상
            const borderColors = {
                positive: 'rgba(16,185,129,0.6)',
                neutral: 'rgba(148,163,184,0.4)',
                negative: 'rgba(239,68,68,0.5)',
            };
            
            // 출처 라벨 매핑
            const sourceLabels = {
                'step1': '1단계: 기본정보',
                'step2': '2단계: 선호도',
                'step3': '3단계: 방향설정',
                'narrative': '서술형 질문',
                'round1': '심층질문 Round 1',
                'round2': '심층질문 Round 2',
                'round3': '심층질문 Round 3',
                'mini_module': '나를 알아가기',
            };
            
            modal.innerHTML = \`
                <div class="relative max-w-2xl w-full max-h-[85vh] overflow-y-auto rounded-2xl p-6" 
                     style="background: linear-gradient(135deg, rgba(26,26,46,0.98), rgba(15,15,35,0.98)); border: 1px solid rgba(99,102,241,0.3);">
                    <!-- 닫기 버튼 -->
                    <button onclick="closeEvidenceModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-white/10" style="color: rgb(148,163,184);">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <!-- 헤더 -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-quote-left text-emerald-400"></i>
                            <span>\${jobName} 추천 근거</span>
                        </h3>
                        <p class="text-sm text-wiki-muted mt-1">아래 내용을 바탕으로 이 직업이 추천되었습니다</p>
                    </div>
                    
                    <!-- Evidence 목록 (인용 스타일) -->
                    \${evidenceLinks.length > 0 ? \`
                        <div class="space-y-3">
                            \${evidenceLinks.map((ev, idx) => {
                                const borderColor = borderColors[ev.match_type] || borderColors.neutral;
                                const sourceKey = ev.user_fact?.source?.split('.')[0] || 'unknown';
                                const sourceLabel = sourceLabels[sourceKey] || ev.user_fact?.source || '사용자 입력';
                                
                                return \`
                                    <div class="pl-4 py-2" style="border-left: 3px solid \${borderColor};">
                                        <!-- 인용문 (사용자 답변) -->
                                        <p class="text-sm text-white/90 italic mb-1">
                                            "\${ev.user_fact?.label || ev.user_fact?.value || '(데이터 없음)'}"
                                        </p>
                                        
                                        <!-- 출처 -->
                                        <div class="flex items-center gap-2 text-xs text-wiki-muted">
                                            <i class="fas fa-bookmark"></i>
                                            <span>출처: \${sourceLabel}</span>
                                        </div>
                                        
                                        <!-- 매칭 설명 (있으면) -->
                                        \${ev.explanation ? \`
                                            <div class="mt-2 p-2 rounded-lg" style="background-color: rgba(99,102,241,0.08);">
                                                <p class="text-xs text-indigo-300/80">
                                                    <i class="fas fa-link mr-1"></i>
                                                    \${ev.explanation}
                                                </p>
                                            </div>
                                        \` : ''}
                                        
                                        <!-- 직업 특성 매칭 -->
                                        \${ev.job_attribute?.label ? \`
                                            <div class="mt-1 text-xs text-wiki-muted/70">
                                                → 직업 특성: \${ev.job_attribute.label}
                                            </div>
                                        \` : ''}
                                    </div>
                                \`;
                            }).join('')}
                        </div>
                    \` : \`
                        <div class="text-center py-12">
                            <i class="fas fa-quote-left text-4xl text-wiki-muted/30 mb-4"></i>
                            <p class="text-wiki-muted">아직 구체적인 근거 데이터가 없습니다.</p>
                            <p class="text-sm text-wiki-muted/60 mt-2">심층 질문에 더 자세히 답변하시면 근거가 추가됩니다.</p>
                        </div>
                    \`}
                    
                    <!-- 닫기 버튼 -->
                    <div class="mt-6 pt-4 border-t border-wiki-border/30 text-center">
                        <button onclick="closeEvidenceModal()" class="px-6 py-2 rounded-lg text-sm font-medium transition" 
                                style="background: rgba(99,102,241,0.2); color: rgb(165,180,252); border: 1px solid rgba(99,102,241,0.3);">
                            닫기
                        </button>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        window.showJobEvidence = showJobEvidence;
        
        function closeEvidenceModal() {
            const modal = document.getElementById('evidence-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        window.closeEvidenceModal = closeEvidenceModal;
        
        // Work Style 바 렌더링
        function renderWorkStyleBar(leftLabel, rightLabel, value) {
            const normalizedValue = ((value || 0) + 100) / 2; // -100~100 → 0~100
            return \`
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-16 text-right text-wiki-muted">\${leftLabel}</span>
                    <div class="flex-1 h-2 bg-wiki-border rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-wiki-primary to-wiki-secondary transition-all" style="width: \${normalizedValue}%"></div>
                    </div>
                    <span class="w-16 text-wiki-muted">\${rightLabel}</span>
                </div>
            \`;
        }
        
        // 전환 일정 렌더링
        function renderTransitionDay(day, data) {
            if (!data) return '';
            const colors = { 30: 'emerald', 60: 'blue', 90: 'purple' };
            const color = colors[day] || 'gray';
            
            return \`
                <div class="p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(var(--\${color}-rgb, 16,185,129), 0.1), transparent); border: 1px solid rgba(var(--\${color}-rgb, 16,185,129), 0.2);">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-\${color}-500/20 flex items-center justify-center text-\${color}-400 font-bold">\${day}</div>
                        <div>
                            <div class="font-bold">Day \${day}</div>
                            <div class="text-sm text-wiki-muted">\${data.goal}</div>
                        </div>
                    </div>
                    <ul class="text-sm space-y-1 mb-3">
                        \${(data.actions || []).map(a => \`<li>• \${a}</li>\`).join('')}
                    </ul>
                    <div class="text-xs text-wiki-muted">📍 마일스톤: \${data.milestone}</div>
                </div>
            \`;
        }
        
        // 리포트 스타일 추가
        function addReportStyles() {
            if (document.getElementById('report-v3-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'report-v3-styles';
            style.textContent = \`
                .report-tab {
                    background-color: rgba(26,26,46,0.5);
                    color: rgb(148,163,184);
                }
                .report-tab:hover {
                    background-color: rgba(42,42,62,0.5);
                }
                .report-tab.active {
                    background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(168,85,247,0.2));
                    color: white;
                    border: 1px solid rgba(99,102,241,0.5);
                }
                .job-set-tab {
                    background: linear-gradient(135deg, rgba(26,26,46,0.7), rgba(42,42,62,0.5));
                    color: rgb(148,163,184);
                    border: 1px solid rgba(148,163,184,0.15);
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .job-set-tab:hover {
                    background: linear-gradient(135deg, rgba(42,42,62,0.8), rgba(62,62,82,0.6));
                    color: rgb(200,210,220);
                    border-color: rgba(148,163,184,0.3);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
                .job-set-tab.active {
                    background: linear-gradient(135deg, rgba(99,102,241,0.4), rgba(168,85,247,0.25));
                    color: white;
                    border: 1px solid rgba(99,102,241,0.5);
                    box-shadow: 0 4px 16px rgba(99,102,241,0.25);
                }
            \`;
            document.head.appendChild(style);
        }
        
        function displayConfidenceUI(result) {
            const card = document.getElementById('confidence-card');
            if (!card) return;
            
            // confidence_score 계산 (서버에서 안 왔으면 클라이언트에서 추정)
            let confidenceScore = result.confidence_score;
            if (confidenceScore === undefined) {
                // 클라이언트에서 간단히 추정: 응답한 질문 수 기반
                const answeredCount = Object.keys(universalAnswers).length + 
                                     Object.keys(transitionSignalAnswers).length + 
                                     Object.keys(followupAnswers).length;
                confidenceScore = Math.min(0.4 + (answeredCount * 0.06), 0.95);
            }
            
            const percentage = Math.round(confidenceScore * 100);
            
            // 게이지바 업데이트
            document.getElementById('confidence-score-text').textContent = percentage + '%';
            document.getElementById('confidence-bar').style.width = percentage + '%';
            
            // 설명 텍스트
            let description = '';
            if (percentage >= 80) {
                description = '충분한 정보를 바탕으로 신뢰도 높은 추천이에요.';
            } else if (percentage >= 60) {
                description = '기본적인 추천은 가능하지만, 더 많은 정보가 있으면 정확도가 올라가요.';
            } else {
                description = '제한된 정보로 추천했어요. 추가 질문에 답변하시면 더 정확해져요.';
            }
            document.getElementById('confidence-description').textContent = description;
            
            // 결정 변수 표시
            const keyDecisions = result.key_decision_variables || generateKeyDecisions();
            const decisionsHtml = keyDecisions.map(kd => \`
                <div class="flex items-start gap-3 p-2 bg-wiki-bg/50 rounded-lg">
                    <span class="text-amber-400">•</span>
                    <div class="flex-1">
                        <span class="text-sm">\${kd.label || kd.fact_key || kd}</span>
                        \${kd.impact ? \`<span class="text-xs text-wiki-muted ml-2">(영향도: \${kd.impact})</span>\` : ''}
                    </div>
                </div>
            \`).join('');
            document.getElementById('key-decisions').innerHTML = decisionsHtml || '<p class="text-wiki-muted text-sm">결정 변수 정보가 없습니다.</p>';
            
            card.classList.remove('hidden');
        }
        
        function generateKeyDecisions() {
            // 클라이언트에서 응답 기반으로 결정 변수 생성
            const decisions = [];
            
            // 5축 상태에서
            if (careerState.role_identity) {
                const opt = ROLE_IDENTITY_OPTIONS.find(o => o.value === careerState.role_identity);
                decisions.push({ label: '현재 상태: ' + (opt?.label || careerState.role_identity), fact_key: 'state.role_identity' });
            }
            if (careerState.transition_status && careerState.transition_status !== 'none') {
                const opt = TRANSITION_STATUS_OPTIONS.find(o => o.value === careerState.transition_status);
                decisions.push({ label: '전환 상태: ' + (opt?.label || careerState.transition_status), fact_key: 'state.transition_status' });
            }
            
            // Universal 답변에서
            if (universalAnswers.univ_interest?.length > 0) {
                decisions.push({ label: '관심 분야: ' + universalAnswers.univ_interest.slice(0, 3).join(', '), fact_key: 'profile.interest' });
            }
            if (universalAnswers.univ_priority) {
                decisions.push({ label: '우선순위: ' + universalAnswers.univ_priority, fact_key: 'priority.top1' });
            }
            
            // 전이 신호에서
            if (transitionSignalAnswers.trans_desired_type?.length > 0) {
                decisions.push({ label: '원하는 변화: ' + transitionSignalAnswers.trans_desired_type.slice(0, 2).join(', '), fact_key: 'transition.desired_type' });
            }
            if (transitionSignalAnswers.trans_motivation) {
                decisions.push({ label: '변화 동기: ' + transitionSignalAnswers.trans_motivation, fact_key: 'transition.motivation_primary' });
            }
            
            return decisions.slice(0, 5);
        }
        
        function displayUserInsight(insight) {
            const card = document.getElementById('user-insight-card');
            if (!insight || !insight.summary) {
                card.classList.add('hidden');
                return;
            }
            
            card.classList.remove('hidden');
            document.getElementById('insight-summary').textContent = insight.summary;
            
            const traitsHtml = (insight.key_traits || []).map(t => \`
                <div class="flex items-start gap-3 p-3 bg-purple-500/10 rounded-lg">
                    <span class="text-xl">💡</span>
                    <div>
                        <div class="font-semibold text-purple-300">\${t.trait}</div>
                        <div class="text-sm text-wiki-muted">\${t.evidence}</div>
                        <div class="text-xs text-green-400 mt-1">→ \${t.score_impact}</div>
                    </div>
                </div>
            \`).join('');
            document.getElementById('insight-traits').innerHTML = traitsHtml;
            
            if (insight.applied_facts?.length > 0) {
                document.getElementById('insight-applied-facts').classList.remove('hidden');
                document.getElementById('insight-facts-list').textContent = 
                    insight.applied_facts.map(f => f.effect_summary).join(', ');
            }
        }
        
        function updateDebugPanel(result, data) {
            const debugInfo = result.debug_info;
            
            // 1. Candidate Source
            const sourceEl = document.getElementById('debug-candidate-source');
            if (sourceEl) {
                if (debugInfo) {
                    const sourceLabel = {
                        'tagged': '🏷️ tagged (DB)',
                        'sample_fallback': '⚠️ sample_fallback',
                        'vector': '🔍 vector',
                        'random': '🎲 random'
                    }[debugInfo.candidate_source] || debugInfo.candidate_source;
                    sourceEl.innerHTML = \`
                        <span class="text-yellow-400">\${sourceLabel}</span> | 
                        Stage: <span class="text-blue-400">\${selectedStage || '-'}</span> | 
                        Tagged: <span class="text-green-400">\${debugInfo.tagged_count}</span> / 
                        Total: <span class="text-white">\${debugInfo.total_in_db}</span>
                    \`;
                } else {
                    sourceEl.textContent = \`Stage: \${selectedStage || '-'}, Candidates: \${result.total_candidates || 0}\`;
                }
            }
            
            // 2. 점수 분해 (TOP3)
            const scoreEl = document.getElementById('debug-score-breakdown');
            if (scoreEl) {
                if (debugInfo?.score_breakdown) {
                    scoreEl.innerHTML = debugInfo.score_breakdown.map((s, i) => \`
                        <div class="mb-2 pb-2 \${i < 2 ? 'border-b border-slate-700' : ''}">
                            <div class="flex justify-between">
                                <span class="text-yellow-300">\${i+1}. \${s.job_name}</span>
                                <span class="text-green-400">Fit: \${s.final_fit}</span>
                            </div>
                            <div class="text-slate-400 text-xs">
                                Base: L\${s.base_like}/C\${s.base_can}/R\${s.base_risk} → 
                                Final: L\${s.final_like}/C\${s.final_can}/R\${s.final_risk}
                            </div>
                            \${s.like_boosts.length > 0 ? \`<div class="text-green-300 text-xs">Like ↑: \${s.like_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                            \${s.can_boosts.length > 0 ? \`<div class="text-blue-300 text-xs">Can ↑: \${s.can_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                            \${s.risk_boosts.length > 0 ? \`<div class="text-red-300 text-xs">Risk ↑: \${s.risk_boosts.map(b => b.rule).join(', ')}</div>\` : ''}
                        </div>
                    \`).join('');
                } else {
                    const top1 = result.fit_top3?.[0];
                    if (top1) {
                        scoreEl.innerHTML = \`Like: \${top1.like_score}, Can: \${top1.can_score}, Fit: \${top1.fit_score}\`;
                    }
                }
            }
            
            // 3. Follow-up 근거
            const followupEl = document.getElementById('debug-followup-rationale');
            if (followupEl) {
                if (debugInfo?.followup_rationale) {
                    const fr = debugInfo.followup_rationale;
                    followupEl.innerHTML = \`
                        <span class="text-purple-400">Split Attr:</span> \${fr.split_attribute} | 
                        <span class="text-yellow-400">Gain:</span> \${fr.split_gain.toFixed(2)} | 
                        <span class="text-slate-400">\${fr.reason}</span>
                    \`;
                } else if (result.followup_questions?.[0]) {
                    const fq = result.followup_questions[0];
                    followupEl.innerHTML = \`질문: "\${fq.question.slice(0, 40)}..." → \${fq.fact_key}\`;
                } else {
                    followupEl.textContent = '추가 질문 없음';
                }
            }
            
            // 4. Rank Change
            const rankEl = document.getElementById('debug-rank-change');
            if (rankEl) {
                if (debugInfo?.rank_changes) {
                    const rc = debugInfo.rank_changes;
                    rankEl.innerHTML = \`
                        <div class="text-slate-400">Before: \${rc.before.join(' → ')}</div>
                        <div class="text-green-400">After: \${rc.after.join(' → ')}</div>
                        <div class="text-yellow-400">Changes: \${rc.changes.join(', ') || '없음'}</div>
                    \`;
                } else if (previousTop3.length > 0) {
                    const currentTop3 = (result.fit_top3 || []).map(j => j.job_name);
                    rankEl.innerHTML = \`
                        <div class="text-slate-400">Before: \${previousTop3.join(' → ')}</div>
                        <div class="text-green-400">After: \${currentTop3.join(' → ')}</div>
                    \`;
                } else {
                    rankEl.textContent = '첫 분석 (비교 대상 없음)';
                }
            }
            
            // 5. Applied Facts & Rules
            const factsEl = document.getElementById('debug-applied-facts');
            if (factsEl) {
                if (debugInfo?.applied_facts) {
                    factsEl.innerHTML = debugInfo.applied_facts.map(f => \`
                        <div class="py-1 border-b border-slate-700/50">
                            <span class="text-blue-300">\${f.fact_key}</span>: 
                            <span class="text-white">\${f.value}</span>
                            <span class="text-slate-500">(\${f.effect})</span>
                        </div>
                    \`).join('');
                } else {
                    factsEl.innerHTML = \`Facts: \${result.input_summary?.facts_applied || 0}개, Rules: \${(result.input_summary?.applied_rules || []).join(', ') || '없음'}\`;
                }
            }
            
            // 6. 버전 정보
            const versionsEl = document.getElementById('debug-versions');
            if (versionsEl) {
                const v = debugInfo?.versions || result.versions || {};
                versionsEl.innerHTML = \`
                    <span class="text-slate-400">recipe:</span> \${v.recipe || '-'} | 
                    <span class="text-slate-400">tagger:</span> \${v.tagger || '-'} | 
                    <span class="text-slate-400">scoring:</span> \${v.scoring || '-'} | 
                    <span class="text-slate-400">embedding:</span> \${v.embedding || 'none'}
                \`;
            }
            
            // Phase4 상태
            const phase4El = document.getElementById('debug-phase4-status');
            if (phase4El) {
                const diversityApplied = debugInfo?.diversity_guard_triggered || result.diversity_guard_active;
                const biasCapApplied = debugInfo?.research_bias_cap_applied || false;
                phase4El.innerHTML = \`
                    <span class="\${diversityApplied ? 'text-green-400' : 'text-slate-500'}">
                        Diversity Guard: \${diversityApplied ? '✓ 적용됨' : '✗ 미적용'}
                    </span> | 
                    <span class="\${biasCapApplied ? 'text-yellow-400' : 'text-slate-500'}">
                        Research Bias Cap: \${biasCapApplied ? '✓ 적용됨' : '✗ 미적용'}
                    </span>
                    \${result.diversity_changes?.length > 0 ? \`<div class="text-xs text-yellow-300 mt-1">변경: \${result.diversity_changes.join(', ')}</div>\` : ''}
                \`;
            }
        }
        
        function displayResultFollowup(question) {
            const section = document.getElementById('result-followup-section');
            section.classList.remove('hidden');
            document.getElementById('result-followup-question').textContent = question.question;
            
            document.getElementById('result-followup-options').innerHTML = (question.options || []).map(opt => \`
                <button onclick="submitResultFollowup('\${question.id}', '\${question.fact_key}', '\${opt.value}')"
                        class="px-4 py-2 bg-wiki-primary hover:bg-blue-600 text-white rounded-lg transition">
                    \${opt.label}
                </button>
            \`).join('');
        }
        
        async function submitResultFollowup(qId, factKey, answer) {
            try {
                await fetch('/api/ai-analyzer/followup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        question_id: qId,
                        fact_key: factKey,
                        answer: answer,
                    })
                });
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel-content');
            if (panel) panel.classList.toggle('hidden');
        }
        
        function resetAnalysis() {
            universalAnswers = {};
            followupAnswers = {};
            currentSessionId = null;
            currentRequestId = null;
            previousTop3 = [];
            selectedStage = null;
            goToStep(0);
        }
        
        // 자동 저장 기능
        // 변경사항 추적 플래그
        window.analyzerUnsavedChanges = false;
        
        // 세션 자동 연장 (30분마다 활동 감지 시)
        let lastActivityTime = Date.now();
        let sessionExtendInterval = null;
        
        function trackActivity() {
            lastActivityTime = Date.now();
        }
        
        async function extendSessionIfNeeded() {
            // 5분 이내에 활동이 있었으면 세션 연장
            if (Date.now() - lastActivityTime < 5 * 60 * 1000) {
                try {
                    await fetch('/auth/refresh', { 
                        method: 'POST', 
                        credentials: 'same-origin' 
                    });
                    console.log('[Session] Extended');
                } catch (e) {
                    console.warn('[Session] Extend failed:', e);
                }
            }
        }
        
        // 활동 감지 이벤트 (클릭, 키입력, 스크롤)
        ['click', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, trackActivity, { passive: true });
        });
        
        // 30분마다 세션 연장 체크
        sessionExtendInterval = setInterval(extendSessionIfNeeded, 30 * 60 * 1000);
        
        function autoSaveDraft() {
            const draft = {
                currentStep: window.currentStep,
                currentRound: window.currentRound,
                collectedCareerState: window.collectedCareerState || {},
                universalAnswers: window.universalAnswers || {},
                narrativeAnswers: window.narrativeAnswers || {},
                roundAnswers: window.roundAnswers || {},
                selectedStage: selectedStage,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem('analyzer_draft', JSON.stringify(draft));
                localStorage.setItem('analyzer_draft_timestamp', Date.now().toString());
                console.log('[AutoSave] Draft saved at step', draft.currentStep);
                window.analyzerUnsavedChanges = true; // 로컬에만 저장된 상태
            } catch (e) {
                console.warn('[AutoSave] Failed to save draft:', e);
            }
        }
        
        // 서버에 자동 저장 (백그라운드, UI 업데이트 없음)
        async function saveDraftToServer() {
            try {
                // 로컬 스토리지 먼저 저장
                autoSaveDraft();
                
                // 세션 ID 확보
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // 최신 답변 수집
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function' 
                    ? collectUniversalAnswers() 
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};
                
                // 서술형 심층 질문 현재 값 수집
                const narrativeQ0 = document.getElementById('narrative_q0');
                const narrativeQ1 = document.getElementById('narrative_q1');
                const narrativeQ2 = document.getElementById('narrative_q2');
                const narrativeCareerBg = document.getElementById('narrative_career_bg');
                if (narrativeQ0 || narrativeQ1 || narrativeQ2) {
                    const currentQuestions = typeof getNarrativeQuestions === 'function' ? getNarrativeQuestions() : null;
                    window.narrativeFacts = {
                        storyAnswer: narrativeQ0?.value || '',
                        life_story: narrativeQ0?.value || '',
                        question1Answer: narrativeQ1?.value || '',
                        question2Answer: narrativeQ2?.value || '',
                        highAliveMoment: narrativeQ1?.value || '',
                        lostMoment: narrativeQ2?.value || '',
                        career_background: narrativeCareerBg?.value || window.resumeCareerBackground || '',  // 전공/직무 정보 추가
                    };
                    if (currentQuestions) {
                        window.savedNarrativeQuestions = currentQuestions;
                    }
                }
                
                // step4_answers 통합 데이터
                const step4Data = {
                    round_answers: window.roundAnswers || [],
                    narrative_facts: window.narrativeFacts || null,
                    narrative_questions: window.savedNarrativeQuestions || null,
                    round_questions: window.roundQuestions || null,
                    current_round: window.currentRound || 0
                };
                
                // career_background 현재 값 수집 (이력서 또는 수동 입력)
                const careerBgInput = document.getElementById('narrative_career_bg');
                const currentCareerBackground = careerBgInput?.value || window.resumeCareerBackground || '';
                
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,  // 프로필 서브스텝 (1: 5축, 2: 나를 알아가기)
                    current_round: window.currentRound || 0,  // 심층 질문 라운드
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 1,  // 복원용
                        currentRound: window.currentRound || 0,  // 심층 질문 라운드 복원용
                        resumeUploaded: window.resumeUploaded || false,  // 이력서 업로드 여부
                        resumeCareerBackground: window.resumeCareerBackground || ''  // 이력서에서 추출한 배경
                    },
                    mini_module_result: window.miniModuleResult || null,
                    mini_module_selections: miniModuleSelections || null,
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: step4Data,
                    career_background: currentCareerBackground  // 전공/직무 정보 (최상위에도 저장)
                };
                
                console.log('[AutoServerSave] Saving draft to server...');
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false;
                    console.log('[AutoServerSave] Draft saved to server');
                }
            } catch (error) {
                console.warn('[AutoServerSave] Failed:', error);
            }
        }
        
        // 수동 임시저장 함수 (버튼 클릭)
        async function saveDraftNow() {
            const saveBtn = event?.target?.closest('button');
            const originalHtml = saveBtn ? saveBtn.innerHTML : '';
            
            // 버튼 상태 변경
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...';
            }
            
            try {
                // 로컬 스토리지 저장
                autoSaveDraft();
                
                // 세션 ID 확보 (없으면 생성)
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // 최신 답변 수집
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function' 
                    ? collectUniversalAnswers() 
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};
                
                // 서술형 심층 질문 현재 값 수집 (textarea에서 직접)
                const narrativeQ0 = document.getElementById('narrative_q0');
                const narrativeQ1 = document.getElementById('narrative_q1');
                const narrativeQ2 = document.getElementById('narrative_q2');
                const narrativeCareerBg = document.getElementById('narrative_career_bg');
                if (narrativeQ0 || narrativeQ1 || narrativeQ2) {
                    const currentQuestions = typeof getNarrativeQuestions === 'function' ? getNarrativeQuestions() : null;
                    window.narrativeFacts = {
                        // 스토리 질문 (공통)
                        storyAnswer: narrativeQ0?.value || '',
                        life_story: narrativeQ0?.value || '',
                        // 동적 질문 1, 2
                        question1Answer: narrativeQ1?.value || '',
                        question2Answer: narrativeQ2?.value || '',
                        highAliveMoment: narrativeQ1?.value || '',
                        lostMoment: narrativeQ2?.value || '',
                        // 전공/직무 정보 추가
                        career_background: narrativeCareerBg?.value || window.resumeCareerBackground || '',
                    };
                    // 질문 자체도 저장 (복원 시 동일한 질문 사용)
                    if (currentQuestions) {
                        window.savedNarrativeQuestions = currentQuestions;
                    }
                }
                
                // 서버에도 저장 (API 호출)
                // step4_answers에 모든 심층 질문 관련 데이터 통합 (DB 스키마 변경 없이)
                const step4Data = {
                    round_answers: window.roundAnswers || [],
                    narrative_facts: window.narrativeFacts || null,
                    narrative_questions: window.savedNarrativeQuestions || null,
                    round_questions: window.roundQuestions || null,
                    current_round: window.currentRound || 0
                };
                
                // career_background 현재 값 수집 (이력서 또는 수동 입력)
                const careerBgInput = document.getElementById('narrative_career_bg');
                const currentCareerBackground = careerBgInput?.value || window.resumeCareerBackground || '';
                
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,  // 프로필 서브스텝
                    current_round: window.currentRound || 0,  // 심층 질문 라운드
                    career_state: careerState || {},  // 로컬 careerState 사용
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},  // 5축 좌표도 저장
                        profileSubStep: profileSubStep || 1,  // 복원용
                        currentRound: window.currentRound || 0,  // 심층 질문 라운드 복원용
                        resumeUploaded: window.resumeUploaded || false,  // 이력서 업로드 여부
                        resumeCareerBackground: window.resumeCareerBackground || ''  // 이력서에서 추출한 배경
                    },
                    mini_module_result: window.miniModuleResult || null,  // 미니모듈 결과
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: step4Data,  // 통합 데이터
                    career_background: currentCareerBackground  // 전공/직무 정보 (최상위에도 저장)
                };
                
                console.log('[ManualSave] Sending draft data:', draftData);
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                const responseData = await response.json().catch(() => ({}));
                console.log('[ManualSave] Server response:', response.status, responseData);
                
                if (response.ok) {
                    window.analyzerUnsavedChanges = false; // 서버에 저장됨
                    
                    // 성공 피드백 - 저장됨 상태 유지 (내용 변경 전까지)
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-check mr-2 text-emerald-400"></i>저장됨';
                        saveBtn.disabled = false;
                        saveBtn.dataset.saved = 'true';
                    }
                    console.log('[ManualSave] Draft saved to server');
                } else {
                    throw new Error('Server save failed: ' + (responseData.error || response.status));
                }
            } catch (error) {
                console.error('[ManualSave] Error:', error);
                // 로컬에는 저장되었으므로 경고만 표시
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-amber-400"></i>오프라인 저장됨';
                    saveBtn.disabled = false;
                    saveBtn.dataset.saved = 'true'; // 오프라인 저장도 저장됨 상태로
                }
            }
        }
        
        // 저장 버튼 리셋 (내용 변경 시 호출)
        function resetSaveButtons() {
            document.querySelectorAll('[id$="-save-btn"]').forEach(btn => {
                if (btn.dataset.saved === 'true') {
                    btn.innerHTML = '<i class="fas fa-save mr-2 text-emerald-400"></i>임시저장';
                    btn.dataset.saved = 'false';
                    window.analyzerUnsavedChanges = true;
                }
            });
        }
        
        // 자동 복원 기능 (모달 사용)
        let pendingDraft = null;
        let pendingServerDraft = null;
        
        async function autoRestoreDraft() {
            try {
                // 1. 서버에서 진행중인 draft 확인 (캐시 방지!)
                const serverResponse = await fetch('/api/ai-analyzer/draft/load?_t=' + Date.now(), {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-store',  // 브라우저 캐시 완전 무시
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const serverData = await serverResponse.json();
                
                if (serverResponse.ok && serverData.found && serverData.draft) {
                    const serverDraft = serverData.draft;
                    pendingServerDraft = serverDraft;
                    
                    // 서버에 저장된 데이터가 있으면 모달 표시
                    const stepNames = ['', '상태 선택', '기본 정보', '앞으로의 방향', '심층 질문', '결과'];
                    const savedDate = new Date(serverDraft.updated_at);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[serverDraft.current_step] + '</strong>까지 진행됨<br>' +
                        '<span class="text-xs">마지막 작업: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    console.log('[AutoRestore] Server draft found at step', serverDraft.current_step);
                    return 'modal';
                }
                
                // 서버에 draft가 없으면 로컬 스토리지도 정리 (서버가 source of truth)
                // 이전에 유저 메뉴에서 삭제했거나, 다른 기기에서 삭제한 경우
                if (serverResponse.ok && !serverData.found) {
                    console.log('[AutoRestore] Server has no draft, clearing local storage');
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    return false;
                }
                
                // 2. 로컬 스토리지에서 확인 (서버 오류 시 폴백)
                const draftStr = localStorage.getItem('analyzer_draft');
                const timestamp = localStorage.getItem('analyzer_draft_timestamp');
                
                if (!draftStr) return false;
                
                // 24시간 이내의 드래프트만 복원
                const savedTime = parseInt(timestamp, 10);
                if (Date.now() - savedTime > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    return false;
                }
                
                const draft = JSON.parse(draftStr);
                pendingDraft = draft;
                
                console.log('[AutoRestore] Local draft found at step', draft.currentStep);
                
                // 로컬에 저장된 데이터가 있으면 모달 표시 (step 1이어도)
                if (draft.currentStep >= 1) {
                    const stepNames = ['', '상태 선택', '기본 정보', '앞으로의 방향', '심층 질문', '결과'];
                    const savedDate = new Date(savedTime);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[draft.currentStep] + '</strong>까지 진행됨<br>' +
                        '<span class="text-xs">마지막 작업: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal'; // 모달 표시 중
                }
                
                return false;
            } catch (e) {
                console.warn('[AutoRestore] Failed to restore draft:', e);
                return false;
            }
        }
        
        // 이어서 하기
        function continueFromDraft() {
            // 서버 draft 우선
            if (pendingServerDraft) {
                const draft = pendingServerDraft;
                currentSessionId = draft.session_id;
                
                // 5축 좌표 복원
                const savedCareerState = draft.step1_answers?.careerState || draft.career_state;
                if (savedCareerState && Object.keys(savedCareerState).length > 0) {
                    Object.assign(careerState, savedCareerState);
                }
                
                // 답변들 복원
                if (draft.step2_answers) {
                    window.universalAnswers = draft.step2_answers;
                    universalAnswers = draft.step2_answers;
                }
                if (draft.step3_answers) {
                    window.narrativeAnswers = draft.step3_answers;
                    transitionSignalAnswers = draft.step3_answers;
                }
                if (draft.step4_answers) {
                    window.roundAnswers = draft.step4_answers;
                }
                if (draft.step1_answers?.stage) {
                    selectedStage = draft.step1_answers.stage;
                }
                
                document.getElementById('continue-modal').classList.add('hidden');
                
                // mini_module_result 복원
                if (draft.mini_module_result) {
                    window.miniModuleResult = draft.mini_module_result;
                }
                
                // narrative_facts 복원
                if (draft.narrative_facts) {
                    window.narrativeFacts = draft.narrative_facts;
                }
                
                // current_round 복원
                if (draft.current_round) {
                    window.currentRound = draft.current_round;
                }
                
                // UI 복원 후 해당 step으로 이동
                setTimeout(() => {
                    updateStep1Selection();
                    if (draft.current_step >= 2) {
                        renderUniversalQuestions();
                        setTimeout(() => updateStep2Selection(), 100);
                    }
                    if (draft.current_step >= 3) {
                        renderTransitionSignalForm();
                    }
                    // Step 4 (심층 질문) 복원 추가!
                    if (draft.current_step >= 4) {
                        // 심층 질문 UI 렌더링
                        const currentRound = draft.current_round || 1;
                        console.log('[continueFromDraft] Restoring step 4, round:', currentRound);
                        
                        // 라운드 질문 가져오기 시작
                        setTimeout(() => {
                            if (typeof startV3RoundQuestions === 'function') {
                                startV3RoundQuestions(currentRound);
                            }
                        }, 300);
                    }
                }, 200);
                
                goToStep(draft.current_step, true);
                pendingServerDraft = null;
                return;
            }
            
            // 로컬 draft
            if (!pendingDraft) return;
            
            // 상태 복원
            if (pendingDraft.collectedCareerState) {
                Object.assign(careerState, pendingDraft.collectedCareerState);
                window.collectedCareerState = pendingDraft.collectedCareerState;
            }
            if (pendingDraft.universalAnswers) {
                window.universalAnswers = pendingDraft.universalAnswers;
                universalAnswers = pendingDraft.universalAnswers;
            }
            if (pendingDraft.narrativeAnswers) {
                window.narrativeAnswers = pendingDraft.narrativeAnswers;
                transitionSignalAnswers = pendingDraft.narrativeAnswers;
            }
            if (pendingDraft.roundAnswers) {
                window.roundAnswers = pendingDraft.roundAnswers;
            }
            if (pendingDraft.selectedStage) {
                selectedStage = pendingDraft.selectedStage;
            }
            if (pendingDraft.currentRound) {
                window.currentRound = pendingDraft.currentRound;
            }
            
            document.getElementById('continue-modal').classList.add('hidden');
            
            // mini_module_result 복원 (로컬)
            if (pendingDraft.miniModuleResult) {
                window.miniModuleResult = pendingDraft.miniModuleResult;
            }
            
            // UI 복원
            setTimeout(() => {
                updateStep1Selection();
                if (pendingDraft.currentStep >= 2) {
                    renderUniversalQuestions();
                    setTimeout(() => updateStep2Selection(), 100);
                }
                if (pendingDraft.currentStep >= 3) {
                    renderTransitionSignalForm();
                }
                // Step 4 (심층 질문) 복원 추가!
                if (pendingDraft.currentStep >= 4) {
                    const currentRound = pendingDraft.currentRound || 1;
                    console.log('[continueFromDraft] Restoring step 4 (local), round:', currentRound);
                    
                    setTimeout(() => {
                        if (typeof startV3RoundQuestions === 'function') {
                            startV3RoundQuestions(currentRound);
                        }
                    }, 300);
                }
            }, 200);
            
            goToStep(pendingDraft.currentStep, true);
            pendingDraft = null;
        }
        
        // 새로 시작 경고 표시
        function showRestartWarning() {
            document.getElementById('restart-warning-modal').classList.remove('hidden');
        }
        
        // 새로 시작 경고 숨기기
        function hideRestartWarning() {
            document.getElementById('restart-warning-modal').classList.add('hidden');
        }
        
        // 새로 시작 확인
        async function confirmRestart() {
            console.log('[confirmRestart] Starting fresh...');
            
            // 1. 로컬 스토리지 삭제
            localStorage.removeItem('analyzer_draft');
            localStorage.removeItem('analyzer_draft_timestamp');
            
            // 2. 서버의 모든 job 타입 draft 삭제 (다른 세션 포함)
            try {
                const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('[confirmRestart] All drafts deleted:', result.deleted_count);
                } else {
                    console.warn('[confirmRestart] Delete-all failed:', response.status);
                }
            } catch (e) {
                console.warn('[confirmRestart] Delete failed:', e);
            }
            
            // 3. 모달 닫기
            document.getElementById('restart-warning-modal').classList.add('hidden');
            document.getElementById('continue-modal').classList.add('hidden');
            
            // 4. 모든 상태 초기화
            pendingDraft = null;
            pendingServerDraft = null;
            currentSessionId = '';  // 세션 ID 초기화 (새 세션 시작)
            window.collectedCareerState = {};
            window.universalAnswers = {};
            window.narrativeAnswers = {};
            window.roundAnswers = {};
            window.miniModuleResult = null;  // 미니모듈 결과도 초기화
            miniModuleSelections = { interest: [], value: [], strength: [], constraint: [] };
            selectedStage = '';
            window.currentRound = null;
            
            // 5. Step 1부터 시작
            goToStep(1);
        }
        
        // goToStep 래핑하여 자동 저장 추가
        const originalGoToStep = goToStep;
        goToStep = function(step, skipRender = false) {
            originalGoToStep(step, skipRender);
            // 자동 저장
            if (step < 3) {
                // 진행 중 단계: 자동 저장
                setTimeout(autoSaveDraft, 100);
            } else if (step === 3) {
                // 결과 도달 시 서버에 완료 상태 저장 후 localStorage 정리
                saveDraftAsCompleted().then(() => {
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                    window.analyzerUnsavedChanges = false;
                    console.log('[AutoSave] Draft marked as completed and cleared');
                }).catch(err => {
                    console.warn('[AutoSave] Failed to mark draft as completed:', err);
                    localStorage.removeItem('analyzer_draft');
                    localStorage.removeItem('analyzer_draft_timestamp');
                });
            }
        };
        
        // 결과 도달 시 서버에 완료 상태 저장
        async function saveDraftAsCompleted() {
            if (!currentSessionId) return;
            
            try {
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: '${c.req.path.includes('/major') ? 'major' : 'job'}',
                    current_step: 3,  // 완료 상태
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 2,  // 프로필 완료
                        completed: true
                    },
                    mini_module_result: window.miniModuleResult || null
                };
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    console.log('[SaveCompleted] Draft marked as completed on server');
                }
            } catch (error) {
                console.warn('[SaveCompleted] Failed:', error);
            }
        }
        
        // beforeunload 핸들러 (저장 확인)
        window.addEventListener('beforeunload', (e) => {
            if (window.analyzerUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '저장하지 않은 변경사항이 있습니다. 페이지를 떠나시겠습니까?';
                return e.returnValue;
            }
        });
        
        // 서버에서 draft 불러오기
        async function loadDraftFromServer(sessionId) {
            try {
                const url = sessionId 
                    ? '/api/ai-analyzer/draft/load?session_id=' + encodeURIComponent(sessionId)
                    : '/api/ai-analyzer/draft/load';
                    
                const response = await fetch(url, { credentials: 'same-origin' });
                if (!response.ok) {
                    console.log('[ServerRestore] Failed to load draft:', response.status);
                    return null;
                }
                
                const data = await response.json();
                if (!data.found || !data.draft) {
                    console.log('[ServerRestore] No draft found');
                    return null;
                }
                
                console.log('[ServerRestore] Draft loaded from server:', data.draft.session_id);
                return data.draft;
            } catch (error) {
                console.error('[ServerRestore] Error loading draft:', error);
                return null;
            }
        }
        
        // 서버 draft를 UI에 적용
        function applyServerDraft(draft) {
            if (!draft) return false;
            
            // 세션 ID 설정
            currentSessionId = draft.session_id;
            
            // Step 1: stage와 careerState 복원
            if (draft.step1_answers?.stage) {
                selectedStage = draft.step1_answers.stage;
            }
            
            // 프로필 서브스텝 복원 (1: 5축, 2: 나를 알아가기)
            if (draft.profile_sub_step || draft.step1_answers?.profileSubStep) {
                profileSubStep = draft.profile_sub_step || draft.step1_answers?.profileSubStep || 1;
                console.log('[ServerRestore] ProfileSubStep restored:', profileSubStep);
            }
            
            // 5축 좌표 복원 (step1_answers.careerState 또는 draft.career_state)
            const savedCareerState = draft.step1_answers?.careerState || draft.career_state;
            if (savedCareerState && Object.keys(savedCareerState).length > 0) {
                // 로컬 careerState 변수 업데이트
                Object.assign(careerState, savedCareerState);
                window.collectedCareerState = savedCareerState;
                console.log('[ServerRestore] CareerState restored:', careerState);
            }
            
            // 이력서 업로드 정보 복원
            if (draft.step1_answers?.resumeUploaded) {
                window.resumeUploaded = true;
                window.resumeCareerBackground = draft.step1_answers.resumeCareerBackground || '';
                console.log('[ServerRestore] Resume info restored:', window.resumeCareerBackground);
            }
            
            // career_background 복원 (최상위 필드 또는 narrative_facts에서)
            if (draft.career_background) {
                window.savedCareerBackground = draft.career_background;
            }
            
            // Step 2: universal answers
            if (draft.step2_answers && Object.keys(draft.step2_answers).length > 0) {
                window.universalAnswers = draft.step2_answers;
                universalAnswers = draft.step2_answers;
            }
            
            // Step 3: narrative/transition answers
            if (draft.step3_answers && Object.keys(draft.step3_answers).length > 0) {
                window.narrativeAnswers = draft.step3_answers;
                transitionSignalAnswers = draft.step3_answers;
            }
            
            // Step 4: 심층 질문 데이터 복원 (통합 구조)
            if (draft.step4_answers && typeof draft.step4_answers === 'object') {
                const step4Data = draft.step4_answers;
                
                // round_answers 복원
                if (step4Data.round_answers) {
                    window.roundAnswers = step4Data.round_answers;
                }
                
                // narrative_facts 복원 (심층 질문 기초 답변)
                if (step4Data.narrative_facts) {
                    window.narrativeFacts = step4Data.narrative_facts;
                    // career_background도 narrative_facts에 포함되어 있으면 복원
                    if (step4Data.narrative_facts.career_background && !window.resumeCareerBackground) {
                        window.savedCareerBackground = step4Data.narrative_facts.career_background;
                    }
                    console.log('[ServerRestore] narrative_facts restored:', window.narrativeFacts);
                }
                
                // narrative_questions 복원 (동적 질문 재사용)
                if (step4Data.narrative_questions) {
                    window.savedNarrativeQuestions = step4Data.narrative_questions;
                    console.log('[ServerRestore] narrative_questions restored:', window.savedNarrativeQuestions);
                }
                
                // round_questions 복원
                if (step4Data.round_questions) {
                    window.roundQuestions = step4Data.round_questions;
                }
                
                // current_round 복원
                if (step4Data.current_round && step4Data.current_round > 0) {
                    window.currentRound = step4Data.current_round;
                }
            }
            
            // 이전 버전 호환성 (별도 필드로 저장된 경우)
            if (draft.narrative_facts && !window.narrativeFacts) {
                window.narrativeFacts = draft.narrative_facts;
            }
            if (draft.narrative_questions && !window.savedNarrativeQuestions) {
                window.savedNarrativeQuestions = draft.narrative_questions;
            }
            if (draft.round_questions && !window.roundQuestions) {
                window.roundQuestions = draft.round_questions;
            }
            if (draft.current_round && draft.current_round > 0 && !window.currentRound) {
                window.currentRound = draft.current_round;
            }
            
            // ============================================
            // 미니모듈 결과 복원
            // ============================================
            if (draft.mini_module_result) {
                window.miniModuleResult = draft.mini_module_result;
                console.log('[ServerRestore] mini_module_result restored:', window.miniModuleResult);
            }
            
            // ============================================
            // AggregatedProfile + Memory 복원 (요약 배너용!)
            // ============================================
            if (draft.aggregated_profile) {
                window.aggregatedProfile = draft.aggregated_profile;
                console.log('[ServerRestore] aggregatedProfile restored, version:', draft.profile_version);
            }
            if (draft.memory) {
                // aggregatedProfile이 없으면 생성
                if (!window.aggregatedProfile) {
                    window.aggregatedProfile = { memory: draft.memory };
                } else {
                    window.aggregatedProfile.memory = draft.memory;
                }
                console.log('[ServerRestore] memory restored');
            }
            
            console.log('[ServerRestore] Draft applied, step:', draft.current_step, 'stage:', selectedStage, 'narrativeFacts:', window.narrativeFacts, 'currentRound:', window.currentRound);
            return draft.current_step || 1;
        }
        
        // Step 1 UI 업데이트 (5축 좌표 선택 상태 복원)
        function updateStep1Selection() {
            // 축 1: 역할 정체성 복원
            if (careerState.role_identity) {
                document.querySelectorAll('.role-card, [data-value]').forEach(card => {
                    if (card.closest('#role-options') && card.dataset.value === careerState.role_identity) {
                        card.classList.add('selected');
                        card.style.borderColor = '#4361ee';
                        card.style.backgroundColor = 'rgba(67,97,238,0.2)';
                        console.log('[ServerRestore] Role identity restored:', careerState.role_identity);
                    }
                });
            }
            
            // 축 2: 경력 기간 복원
            if (careerState.career_stage_years) {
                document.querySelectorAll('.career-stage-btn, [data-value]').forEach(card => {
                    if (card.closest('#career-stage-options') && card.dataset.value === careerState.career_stage_years) {
                        card.classList.add('selected');
                        card.style.borderColor = '#4361ee';
                        card.style.backgroundColor = 'rgba(67,97,238,0.2)';
                        console.log('[ServerRestore] Career stage restored:', careerState.career_stage_years);
                    }
                });
            }
            
            // 축 3: 전환 상태 복원 (다중 선택 - 배열)
            if (careerState.transition_status && Array.isArray(careerState.transition_status)) {
                document.querySelectorAll('.goal-chip, [data-value]').forEach(card => {
                    if (card.closest('#transition-status-options') && careerState.transition_status.includes(card.dataset.value)) {
                        card.classList.add('selected');
                        card.style.borderColor = '#10b981';
                        card.style.backgroundColor = 'rgba(16,185,129,0.2)';
                        console.log('[ServerRestore] Transition status restored:', card.dataset.value);
                    }
                });
            }
            
            // 축 4: 숙련도 복원
            if (careerState.skill_level !== null && careerState.skill_level !== undefined) {
                document.querySelectorAll('.skill-btn, [data-value]').forEach(card => {
                    if (card.closest('#skill-level-options') && parseInt(card.dataset.value) === careerState.skill_level) {
                        card.classList.add('selected');
                        card.style.borderColor = '#8b5cf6';
                        card.style.backgroundColor = 'rgba(139,92,246,0.2)';
                        console.log('[ServerRestore] Skill level restored:', careerState.skill_level);
                    }
                });
            }
            
            // 축 5: 제약 조건 복원 (UI 직접 업데이트 - toggleConstraint 호출하면 토글되어 해제됨)
            if (careerState.constraints && Object.keys(careerState.constraints).length > 0) {
                setTimeout(() => {
                    // 저장된 제약 조건을 임시 저장하고 careerState 초기화
                    const savedConstraints = JSON.parse(JSON.stringify(careerState.constraints));
                    careerState.constraints = {};
                    
                    Object.entries(savedConstraints).forEach(([type, constraint]) => {
                        if (constraint && constraint.has_constraint) {
                            const card = document.querySelector(\`.constraint-card[data-type="\${type}"]\`);
                            if (card) {
                                const headerBtn = card.querySelector('.constraint-header');
                                if (headerBtn) {
                                    // toggleConstraint를 호출하면 careerState.constraints에 다시 설정됨
                                    headerBtn.click();
                                    console.log('[ServerRestore] Constraint restored:', type);
                                    
                                    // 세부 태그 복원 (details 배열이 있는 경우)
                                    if (constraint.details && Array.isArray(constraint.details)) {
                                        setTimeout(() => {
                                            constraint.details.forEach(detailValue => {
                                                const detailTag = card.querySelector(\`.detail-tag[data-value="\${detailValue}"]\`);
                                                if (detailTag && !detailTag.classList.contains('selected')) {
                                                    detailTag.click();
                                                    console.log('[ServerRestore] Constraint detail restored:', type, detailValue);
                                                }
                                            });
                                        }, 100);
                                    }
                                }
                            }
                        }
                    });
                }, 150);
            }
            
            // 다음 버튼 활성화 체크
            checkStep1Completion();
            console.log('[ServerRestore] Step 1 selection updated, careerState:', careerState);
        }
        
        // Step 2 UI 업데이트 (Universal answers 복원)
        function updateStep2Selection() {
            if (!universalAnswers || Object.keys(universalAnswers).length === 0) return;
            
            Object.entries(universalAnswers).forEach(([questionId, answer]) => {
                const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
                if (!container) return;
                
                if (Array.isArray(answer)) {
                    // chips/checkbox: 다중 선택
                    answer.forEach(val => {
                        const chip = container.querySelector(\`.chip-option[data-value="\${val}"]\`);
                        if (chip && !chip.classList.contains('selected')) {
                            chip.classList.add('selected');
                            chip.style.borderColor = '#4361ee';
                            chip.style.backgroundColor = 'rgba(67,97,238,0.15)';
                        }
                    });
                } else {
                    // radio: 단일 선택
                    const radio = container.querySelector(\`.radio-option[data-value="\${answer}"]\`);
                    if (radio && !radio.classList.contains('selected')) {
                        radio.classList.add('selected');
                        radio.style.borderColor = '#4361ee';
                        radio.style.backgroundColor = 'rgba(67,97,238,0.15)';
                    }
                    
                    // text input
                    const textarea = container.querySelector(\`textarea[name="\${questionId}"]\`);
                    if (textarea) {
                        textarea.value = answer;
                    }
                }
                console.log('[ServerRestore] Step 2 answer restored:', questionId);
            });
        }
        
        // 페이지 로드 시 초기화 - /analyzer/job은 Step 1(상태 선택)부터 시작
        document.addEventListener('DOMContentLoaded', async () => {
            renderStageOptions();  // 스테이지 옵션 렌더링
            
            // URL에서 session_id 확인 (AI 추천 메뉴에서 진행중 클릭 시)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('session_id');
            
            if (urlSessionId) {
                // 서버에서 해당 session의 draft 불러오기
                console.log('[Init] Loading draft from server for session:', urlSessionId);
                const serverDraft = await loadDraftFromServer(urlSessionId);
                console.log('[Init] Server draft loaded:', serverDraft);
                console.log('[Init] Server draft current_step:', serverDraft?.current_step);
                console.log('[Init] Server draft narrative_facts:', serverDraft?.narrative_facts);
                console.log('[Init] Server draft narrative_questions:', serverDraft?.narrative_questions);
                if (serverDraft) {
                    const restoredStep = applyServerDraft(serverDraft);
                    console.log('[Init] restoredStep from applyServerDraft:', restoredStep);
                    
                    // DOM 업데이트 후 UI 적용 (setTimeout으로 다음 틱에서 실행)
                    setTimeout(() => {
                        updateStep1Selection();  // 5축 좌표 UI 복원
                        
                        // 프로필 서브스텝에 따라 적절한 화면 표시
                        if (restoredStep === 1) {
                            if (profileSubStep === 2) {
                                // 프로필 2/2 (나를 알아가기)로 이동
                                goToProfileStep2();
                            }
                        }
                        
                        // Step 2 (심층 질문) 복원 - 3단계 구조
                        if (restoredStep === 2) {
                            // 라운드 진행 중이면 라운드 UI 렌더링
                            if (window.currentRound > 0 && window.roundQuestions) {
                                const roundMeta = {
                                    1: { title: '내면의 에너지 탐색', subtitle: '무엇이 당신을 움직이게 하나요?', emoji: '🔥', color: 'from-orange-500 to-red-500' },
                                    2: { title: '경계선 확인', subtitle: '무엇을 피하고 싶으신가요?', emoji: '🛡️', color: 'from-purple-500 to-indigo-500' },
                                    3: { title: '실행 계획 설계', subtitle: '어떻게 시작할 수 있을까요?', emoji: '🚀', color: 'from-emerald-500 to-teal-500' },
                                };
                                renderV3RoundUI(window.currentRound, window.roundQuestions, roundMeta[window.currentRound]);
                                setTimeout(() => restoreRoundAnswers(), 100);
                            } else {
                                // 심층 질문 기초 단계 복원
                                console.log('[Restore] Rendering narrative step, narrativeFacts:', window.narrativeFacts);
                                renderNarrativeStep();
                                // 저장된 답변 복원
                                setTimeout(() => restoreNarrativeAnswers(), 150);
                            }
                        }
                    }, 200);  // 조금 더 여유 있게
                    
                    // 심층 질문 단계면 Step 3 컨테이너를 직접 표시 (currentStep은 4 유지)
                    if (restoredStep >= 4) {
                        // Step 3 컨테이너만 표시 (goToStep 사용하지 않음 - currentStep 덮어쓰기 방지)
                        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
                        document.getElementById('step3')?.classList.remove('hidden');
                        currentStep = 4;
                        window.currentStep = 4;
                        // 인디케이터 업데이트
                        document.querySelectorAll('.step-dot').forEach((el) => {
                            const circle = el.querySelector('span:first-child');
                            const stepNum = parseInt(el.dataset.step, 10);
                            if (stepNum <= 4) {
                                circle.classList.remove('bg-wiki-border', 'text-wiki-muted');
                                circle.classList.add('bg-wiki-primary', 'text-white');
                            }
                        });
                    } else {
                        goToStep(restoredStep, true);
                    }
                    return;
                }
            }
            
            // request_id가 있으면 결과 직접 로드 (테스트 시나리오 결과 조회용)
            const urlRequestId = urlParams.get('request_id');
            if (urlRequestId) {
                console.log('[Init] Loading result from request_id:', urlRequestId);
                try {
                    showLoading();
                    const response = await fetch('/api/ai-analyzer/result/' + urlRequestId);
                    const data = await response.json();
                    hideLoading();

                    if (response.ok && data) {
                        console.log('[Init] Result loaded:', data);
                        currentRequestId = parseInt(urlRequestId, 10);
                        displayResults(data);
                        goToStep(3);  // 결과 화면으로 이동
                        return;
                    } else {
                        console.error('[Init] Failed to load result:', data);
                        alert('결과를 불러오는데 실패했습니다: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    hideLoading();
                    console.error('[Init] Error loading result:', e);
                    alert('결과를 불러오는데 실패했습니다.');
                }
            }

            // 시나리오 자동 실행 (?scenario=stability_seeker 등)
            const scenarioId = urlParams.get('scenario');
            if (scenarioId) {
                console.log('[Init] Auto-running scenario:', scenarioId);
                try {
                    showLoading();

                    // 로딩 메시지 표시
                    const loadingEl = document.querySelector('.loading-overlay');
                    if (loadingEl) {
                        loadingEl.innerHTML = \`
                            <div class="text-center">
                                <div class="animate-spin w-12 h-12 border-4 border-wiki-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                                <p class="text-white text-lg font-medium">시나리오 테스트 실행 중...</p>
                                <p class="text-wiki-muted mt-2">\${scenarioId}</p>
                            </div>
                        \`;
                    }

                    // 테스트 시나리오 실행
                    const response = await fetch('/api/ai-analyzer/test/run-scenario', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scenario_id: scenarioId })
                    });
                    const testData = await response.json();

                    if (!testData.success) {
                        throw new Error(testData.error || '테스트 실패');
                    }

                    console.log('[Init] Scenario test completed:', testData);

                    // 결과 로드
                    if (testData.request_id) {
                        const resultResponse = await fetch('/api/ai-analyzer/result/' + testData.request_id);
                        const resultData = await resultResponse.json();

                        hideLoading();

                        if (resultResponse.ok && resultData) {
                            console.log('[Init] Scenario result loaded:', resultData);
                            currentRequestId = testData.request_id;

                            // 시나리오 테스트 배너 표시
                            setTimeout(() => {
                                const banner = document.createElement('div');
                                banner.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-purple-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3';
                                banner.innerHTML = \`
                                    <i class="fas fa-flask"></i>
                                    <div>
                                        <div class="font-medium">테스트 시나리오: \${testData.scenario?.name || scenarioId}</div>
                                        <div class="text-sm opacity-80">검증 점수: \${testData.verification?.score || 0}/100 (\${testData.verification?.passed ? '통과' : '실패'})</div>
                                    </div>
                                    <button onclick="goToStep(1); this.closest('.fixed').remove();" class="ml-2 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-sm font-medium transition">
                                        테스트 종료
                                    </button>
                                    <button onclick="this.parentElement.remove()" class="hover:bg-white/20 p-1 rounded">
                                        <i class="fas fa-times"></i>
                                    </button>
                                \`;
                                document.body.appendChild(banner);
                            }, 500);

                            displayResults(resultData);
                            goToStep(3);  // 결과 화면으로 이동
                            return;
                        }
                    }

                    hideLoading();
                    alert('시나리오 결과를 불러오는데 실패했습니다.');
                } catch (e) {
                    hideLoading();
                    console.error('[Init] Scenario test error:', e);
                    alert('시나리오 테스트 실패: ' + e.message);
                }
            }

            // URL에 session_id가 없으면 서버/로컬에서 복원 시도
            const restoredStep = await autoRestoreDraft();
            if (restoredStep === 'modal') {
                // 모달이 표시되므로 기본 Step으로 대기
                goToStep(1);
            } else if (restoredStep) {
                // 복원된 데이터로 UI 업데이트
                setTimeout(() => {
                    updateStep1Selection();  // 5축 좌표 UI 복원
                }, 200);
                goToStep(restoredStep, true);  // skipRender = true
            } else {
                goToStep(1);           // Step 1부터 시작
            }
            
            // Step 2 버튼 기본 핸들러 설정 (renderNarrativeStep/renderV3RoundUI에서 덮어씀)
            const step2PrevBtn = document.getElementById('step2-prev-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            if (step2PrevBtn) {
                step2PrevBtn.onclick = () => {
                    goToStep(1);
                    goToProfileStep2();
                };
            }
            if (analyzeBtn) {
                analyzeBtn.onclick = () => {
                    // 기본값: 아무 동작 없음 (renderNarrativeStep에서 설정됨)
                    console.log('[analyze-btn] Default handler - waiting for render');
                };
            }
            
            // 입력 변경 감지 - 저장 버튼 리셋 (저장 버튼 자체 제외)
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('[id$="-save-btn"]') || target.closest('#analyze-btn')) return;
                if (target.closest('.role-card, .career-stage-btn, .goal-chip, .skill-btn, .constraint-option, .trans-chip, .trans-radio, .radio-option, .trans-checkbox')) {
                    resetSaveButtons();
                }
            });
            document.addEventListener('input', (e) => {
                if (e.target.matches('input, textarea, select')) {
                    resetSaveButtons();
                }
            });
        });
    </script>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI 직업 추천 - Careerwiki'))
})

// AI Major Analyzer v2.0.0 - 5단계 플로우 (직업 추천과 동일 구조)
app.get('/analyzer/major', requireAuth, (c) => {
  const debugMode = c.req.query('debug') === 'true'
  
  // 전공용 스테이지
  const majorStagesJson = JSON.stringify([
    { id: 'major_middle', label: '중학생', description: '진로 탐색 중', emoji: '🎒' },
    { id: 'major_high', label: '고등학생', description: '대학 진학 준비', emoji: '📖' },
    { id: 'major_freshman', label: '대학 신입생', description: '전공 탐색 중', emoji: '🎓' },
    { id: 'major_student', label: '대학 재학생', description: '전과/복수전공 고려', emoji: '📚' },
    { id: 'major_graduate', label: '대학원 진학', description: '석/박사 준비', emoji: '🔬' },
  ])
  
  // Universal Questions (전공용)
  const majorQuestionsJson = JSON.stringify([
    { id: 'univ_interest', order: 1, text: '어떤 분야에 관심이 있나요?', ui_type: 'chips', options: [
      { value: 'tech', label: '기술/IT', emoji: '💻' }, { value: 'science', label: '자연과학', emoji: '🔬' },
      { value: 'humanities', label: '인문학', emoji: '📜' }, { value: 'social', label: '사회과학', emoji: '🏛️' },
      { value: 'art', label: '예술/디자인', emoji: '🎨' }, { value: 'business', label: '경영/경제', emoji: '💼' },
      { value: 'health', label: '의료/보건', emoji: '🏥' }, { value: 'education', label: '교육', emoji: '📚' },
      { value: 'engineering', label: '공학', emoji: '⚙️' }, { value: 'law', label: '법학', emoji: '⚖️' },
    ], allow_unknown: true, unknown_label: '잘 모르겠어요', fact_key: 'profile.interest.keywords', required: true, max_selections: 5 },
    { id: 'univ_good_subjects', order: 2, text: '자신 있거나 좋아하는 과목은?', ui_type: 'chips', options: [
      { value: 'korean', label: '국어', emoji: '📖' }, { value: 'math', label: '수학', emoji: '🔢' },
      { value: 'english', label: '영어', emoji: '🌐' }, { value: 'science', label: '과학', emoji: '🧪' },
      { value: 'social', label: '사회', emoji: '🗺️' }, { value: 'history', label: '역사', emoji: '📜' },
      { value: 'art', label: '미술', emoji: '🎨' }, { value: 'music', label: '음악', emoji: '🎵' },
    ], allow_unknown: true, unknown_label: '딱히 없어요', fact_key: 'profile.good_subjects', required: true, max_selections: 4 },
    { id: 'univ_weak_subjects', order: 3, text: '어렵거나 피하고 싶은 과목은?', ui_type: 'chips', options: [
      { value: 'korean', label: '국어', emoji: '📖' }, { value: 'math', label: '수학', emoji: '🔢' },
      { value: 'english', label: '영어', emoji: '🌐' }, { value: 'science', label: '과학', emoji: '🧪' },
      { value: 'social', label: '사회', emoji: '🗺️' }, { value: 'history', label: '역사', emoji: '📜' },
    ], fact_key: 'profile.weak_subjects', required: true, max_selections: 3 },
    { id: 'univ_workstyle', order: 4, text: '공부할 때 어떤 방식이 더 맞나요?', ui_type: 'radio', options: [
      { value: 'theory', label: '이론/개념 학습', emoji: '📚' }, { value: 'practice', label: '실습/실험', emoji: '🔧' },
      { value: 'discuss', label: '토론/발표', emoji: '💬' }, { value: 'mixed', label: '상황에 따라', emoji: '🔀' },
    ], allow_unknown: true, unknown_label: '모르겠어요', fact_key: 'profile.workstyle.study', required: true },
    { id: 'univ_priority', order: 5, text: '전공 선택에서 가장 중요한 건?', ui_type: 'radio', options: [
      { value: 'interest', label: '내 관심사와 맞는 것', emoji: '❤️' }, { value: 'job', label: '취업 잘 되는 것', emoji: '💼' },
      { value: 'salary', label: '연봉이 높은 것', emoji: '💰' }, { value: 'stable', label: '안정적인 것', emoji: '🏠' },
      { value: 'growth', label: '성장 가능성', emoji: '📈' }, { value: 'social', label: '사회에 기여', emoji: '🌍' },
    ], allow_unknown: true, unknown_label: '아직 모르겠어요', fact_key: 'priority.top1', required: true },
  ])
  
  // 5축 데이터 JSON (전공 추천용)
  const majorStudentOptionsJson = JSON.stringify(MAJOR_STUDENT_OPTIONS)
  const roleIdentityOptionsJson = JSON.stringify(ROLE_IDENTITY_OPTIONS)
  const careerStageOptionsJson = JSON.stringify(CAREER_STAGE_OPTIONS)
  const transitionStatusOptionsJson = JSON.stringify(TRANSITION_STATUS_OPTIONS)
  const skillLevelOptionsJson = JSON.stringify(SKILL_LEVEL_OPTIONS)
  const constraintOptionsJson = JSON.stringify(CONSTRAINT_OPTIONS)
  const transitionSignalQuestionsJson = JSON.stringify(TRANSITION_SIGNAL_QUESTIONS)
  const identityAnchorPatternsJson = JSON.stringify(IDENTITY_ANCHOR_PATTERNS)
  
  const content = `
    <div class="max-w-6xl mx-auto px-4 md:px-6 md:mt-8">
        <h1 class="text-3xl font-bold mb-6 text-center">
            <i class="fas fa-university mr-3 text-wiki-secondary"></i>AI 전공 추천
            ${debugMode ? '<span class="ml-2 text-sm bg-yellow-500 text-black px-2 py-1 rounded">DEBUG MODE</span>' : ''}
        </h1>
        
        <!-- Step Indicator (5단계) -->
        <div class="flex justify-center items-center gap-1 md:gap-2 mb-6 flex-wrap" id="step-indicator">
            <div class="step-dot flex flex-col items-center active" data-step="1">
                <span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center bg-wiki-primary text-white rounded-full font-bold text-xs md:text-sm">1</span>
                <span class="text-xs mt-1 hidden md:block">학생유형</span>
            </div>
            <div class="w-4 md:w-8 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="2">
                <span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-xs md:text-sm">2</span>
                <span class="text-xs mt-1 hidden md:block">관심사</span>
            </div>
            <div class="w-4 md:w-8 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="3">
                <span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-xs md:text-sm">3</span>
                <span class="text-xs mt-1 hidden md:block">목표</span>
            </div>
            <div class="w-4 md:w-8 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="4">
                <span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-xs md:text-sm">4</span>
                <span class="text-xs mt-1 hidden md:block">심층</span>
            </div>
            <div class="w-4 md:w-8 h-0.5 bg-wiki-border"></div>
            <div class="step-dot flex flex-col items-center" data-step="5">
                <span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center bg-wiki-card text-wiki-muted rounded-full font-bold text-xs md:text-sm">5</span>
                <span class="text-xs mt-1 hidden md:block">결과</span>
            </div>
        </div>
        
        <!-- 본인 계정 사용 안내 배너 (Step 1에서만 표시) -->
        <div id="account-warning-banner" class="mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-amber-400 text-lg"></i>
                <div>
                    <p class="text-amber-300 font-medium">반드시 본인 계정으로 진행해주세요</p>
                    <p class="text-sm text-amber-200/70">입력한 정보는 현재 로그인된 계정에 저장됩니다. 다른 사람의 계정으로 진행하면 데이터가 섞일 수 있어요.</p>
                </div>
            </div>
        </div>
        
        <!-- 로딩 오버레이 -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-wiki-bg/90 z-50 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-wiki-primary mx-auto mb-4"></div>
                <p class="text-xl font-semibold" id="loading-message">분석 중...</p>
                <p class="text-wiki-muted text-sm mt-2" id="loading-submessage">잠시만 기다려주세요</p>
            </div>
        </div>
        
        <!-- 이어하기/새로시작 모달 -->
        <div id="continue-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-wiki-border/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-500 to-wiki-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-history text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">진행 중인 분석이 있습니다</h3>
                    <p class="text-wiki-muted text-sm" id="continue-modal-info"></p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="continueFromDraft()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-wiki-primary text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-play mr-2"></i>이어서 하기
                    </button>
                    <button type="button" onclick="showRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-redo mr-2"></i>새로 시작하기
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 새로 시작 경고 모달 -->
        <div id="restart-warning-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div class="glass-card p-6 rounded-2xl max-w-md mx-4 border border-red-500/30">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">정말 새로 시작하시겠어요?</h3>
                    <p class="text-wiki-muted text-sm">진행 중인 데이터가 모두 삭제됩니다.<br>이 작업은 되돌릴 수 없습니다.</p>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="confirmRestart()" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-xl hover:opacity-90 transition">
                        <i class="fas fa-trash mr-2"></i>삭제하고 새로 시작
                    </button>
                    <button type="button" onclick="hideRestartWarning()"
                            class="w-full px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                        <i class="fas fa-arrow-left mr-2"></i>취소
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Step 1: 학생 유형 선택 (전공 추천 전용) -->
        <div id="step1" class="step-content glass-card p-6 md:p-8 rounded-2xl mb-6">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300">
                    현재 학업 상황을 알려주세요
                </h2>
                <p class="text-wiki-muted mt-2">학생 유형에 맞는 전공을 추천해드려요</p>
            </div>
            
            <!-- 이력서 업로드 섹션 (선택사항) -->
            <div class="mb-8 p-5 rounded-2xl" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px dashed rgba(99,102,241,0.3);">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-file-alt text-white"></i>
                    </div>
                <div>
                        <h3 class="font-bold text-white">이력서/자기소개서로 빠르게 시작하기</h3>
                        <p class="text-xs" style="color: rgb(148,163,184)">PDF 파일을 업로드하면 항목을 자동으로 채워드려요</p>
                    </div>
                    <span class="ml-auto px-3 py-1 text-xs rounded-full" style="background-color: rgba(99,102,241,0.2); color: rgb(165,180,252);">선택사항</span>
                </div>
                
                <div class="flex items-center gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="file" id="resume-upload" accept=".pdf" class="hidden" onchange="handleResumeUpload(this)">
                        <div class="flex items-center justify-center gap-3 px-4 py-3 rounded-xl border-2 border-dashed transition-all hover:border-indigo-400"
                             style="background-color: rgba(26,26,46,0.5); border-color: rgba(99,102,241,0.3);">
                            <i class="fas fa-cloud-upload-alt text-xl" style="color: rgb(165,180,252);"></i>
                            <span style="color: rgb(148,163,184);">PDF 파일 선택</span>
                        </div>
                    </label>
                    
                    <div id="resume-status" class="hidden flex items-center gap-2 px-4 py-3 rounded-xl" style="background-color: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);">
                        <i class="fas fa-check-circle text-emerald-400"></i>
                        <span class="text-emerald-400 text-sm" id="resume-status-text">분석 완료!</span>
                    </div>
                </div>
                
                <p class="text-xs mt-2" style="color: rgb(100,116,139);">
                    <i class="fas fa-info-circle mr-1"></i>
                    파일은 저장되지 않으며, 분석 참고용으로만 사용됩니다. 임시저장 시 분석 결과만 저장됩니다.
                </p>
                
                <div id="resume-loading" class="hidden mt-3 flex items-center justify-center gap-3 py-3">
                    <i class="fas fa-spinner fa-spin text-indigo-400"></i>
                    <span style="color: rgb(165,180,252);">문서 분석 중...</span>
                </div>
                
                <div id="resume-error" class="hidden mt-3 p-3 rounded-lg" style="background-color: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);">
                    <p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i><span id="resume-error-text"></span></p>
                </div>
            </div>
            
            <div class="space-y-8" id="major-state-form">
                <!-- 학생 유형 -->
                <div class="state-axis-section" data-axis="student_type">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">1</div>
                        <h3 class="text-lg font-bold">나는 현재?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="student-type-options">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 전공 선택 목적 -->
                <div class="state-axis-section" data-axis="major_purpose">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-violet-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">2</div>
                        <h3 class="text-lg font-bold">전공을 찾는 이유는?</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="career-stage-options"></div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 3: 전환 상태 (다중 선택) -->
                <div class="state-axis-section" data-axis="transition_status">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">3</div>
                        <h3 class="text-lg font-bold">지금 상황은?</h3>
                        <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">복수 선택</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">해당하는 상황을 모두 선택해주세요</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="transition-status-options"></div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 4: 숙련도 -->
                <div class="state-axis-section" data-axis="skill_level">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">4</div>
                        <h3 class="text-lg font-bold">관심 분야에서의 숙련도는?</h3>
                    </div>
                    <div class="ml-11 mb-4 p-3 bg-violet-500/10 rounded-lg border border-violet-500/20">
                        <p class="text-sm text-violet-300">
                            <i class="fas fa-lightbulb mr-2"></i>
                            현재 학력과 무관하게, <strong>앞으로 가고 싶은 분야</strong> 기준으로 선택해주세요
                        </p>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3" id="skill-level-options"></div>
                </div>
                
                <!-- 구분선 -->
                <div class="border-t border-wiki-border/30"></div>
                
                <!-- 축 5: 제약 조건 -->
                <div class="state-axis-section" data-axis="constraints">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg">5</div>
                        <h3 class="text-lg font-bold">현재 제약이 있나요?</h3>
                        <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full">선택사항</span>
                    </div>
                    <p class="text-sm text-wiki-muted mb-4 ml-11">해당하는 제약을 선택하면 맞춤 추천에 반영됩니다</p>
                    <div class="max-w-2xl mx-auto" id="constraint-options"></div>
                </div>
            </div>
            
            <!-- 하단 버튼 -->
            <div class="flex justify-center gap-4 pt-8 mt-6 border-t border-wiki-border/30">
                <a href="/analyzer" class="px-6 py-3 bg-wiki-card/50 border border-wiki-border text-gray-300 rounded-xl hover:bg-wiki-card hover:text-white transition inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>유형 다시 선택
                </a>
                <button type="button" id="step1-next-btn" onclick="goToStep2WithLoading()" disabled
                        class="px-10 py-4 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold rounded-xl shadow-lg shadow-wiki-primary/25 transition disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-wiki-primary/40 hover:scale-[1.02] active:scale-[0.98]">
                    <i class="fas fa-arrow-right mr-2"></i>다음
                            </button>
                    </div>
                </div>
                
        <!-- Step 2: 기본 질문 -->
        <div id="step2" class="step-content hidden glass-card p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-rocket text-wiki-primary mr-2"></i>기본 정보 (30~60초)
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm">느낌대로 선택하시면 됩니다!</p>
            
            <form id="universal-form">
                <div id="universal-questions" class="space-y-6"></div>
                <div class="flex justify-center gap-4 pt-6">
                    <button type="button" onclick="goToStep(1)" class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>상황 다시 선택
                    </button>
                    <button type="button" onclick="submitUniversalAndGoToTransition()"
                            class="px-10 py-4 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold rounded-xl hover-glow transition">
                        <i class="fas fa-arrow-right mr-2"></i>다음
                    </button>
                </div>
            </form>
                </div>
                
        <!-- Step 3: 전이 신호 -->
        <div id="step3" class="step-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-compass text-emerald-400 mr-2"></i>앞으로의 방향 (1~2분)
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm">원하는 변화와 목표를 알려주세요</p>
            
            <div id="transition-signal-form" class="space-y-6"></div>
            
            <div class="flex justify-center gap-4 pt-6">
                <button type="button" onclick="goToStep(2)" class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                    <i class="fas fa-arrow-left mr-2"></i>이전
                </button>
                <button type="button" onclick="submitTransitionAndContinue()" id="step3-next-btn"
                        class="px-10 py-4 bg-gradient-to-r from-emerald-500 to-wiki-secondary text-white font-bold rounded-xl hover-glow transition">
                    <i class="fas fa-arrow-right mr-2"></i>다음
                </button>
            </div>
                </div>
                
        <!-- Step 4: 심층 팔로업 -->
        <div id="step4" class="step-content hidden glass-card p-6 md:p-8 rounded-2xl mb-6">
            <h2 class="text-xl font-bold mb-2 text-center">
                <i class="fas fa-user-astronaut text-purple-400 mr-2"></i>심층 질문 (1~2분)
            </h2>
            <p class="text-center text-wiki-muted mb-6 text-sm" id="step4-subtitle">더 정확한 추천을 위한 맞춤 질문이에요</p>
            
            <div id="followup-questions-form" class="space-y-6"></div>
            
            <div class="flex justify-center gap-4 pt-6">
                <button type="button" onclick="goToStep(3)" class="px-6 py-3 bg-wiki-card border border-wiki-border text-white rounded-xl hover:bg-wiki-bg transition">
                    <i class="fas fa-arrow-left mr-2"></i>이전
                </button>
                <button type="button" onclick="submitFollowupsAndAnalyze()" id="analyze-btn"
                        class="px-12 py-4 bg-gradient-to-r from-purple-500 to-wiki-secondary text-white font-bold rounded-xl hover-glow transition transform hover:scale-105">
                    <i class="fas fa-magic mr-2"></i>AI 추천 받기
                </button>
            </div>
                </div>
                
        <!-- Step 5: 결과 -->
        <div id="step5" class="step-content hidden">
            <!-- Confidence UI: 근거 강도 + 결정변수 -->
            <div id="confidence-card" class="glass-card p-6 rounded-2xl mb-6 border border-emerald-500/30 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-emerald-400"></i>
                    <span>추천 근거 강도</span>
                </h2>
                
                <!-- 근거 강도 게이지 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-wiki-muted">신뢰도</span>
                        <span id="confidence-score-text" class="text-lg font-bold text-emerald-400">--%</span>
                    </div>
                    <div class="w-full bg-wiki-bg rounded-full h-3 overflow-hidden">
                        <div id="confidence-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="confidence-description" class="text-xs text-wiki-muted mt-2">-</p>
                </div>
                
                <!-- 결정 변수 -->
                <div>
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-key text-amber-400"></i>
                        <span>이 답변들이 결과에 영향을 주었어요</span>
                    </h3>
                    <div id="key-decisions" class="space-y-2"></div>
                </div>
                </div>
                
            <div class="glass-card p-6 rounded-2xl mb-6">
                <h2 class="text-xl font-bold mb-4 text-center">
                    <i class="fas fa-star text-yellow-400 mr-2"></i>추천 전공
                </h2>
                <div id="major-results" class="space-y-4"></div>
                </div>
                
            <div class="text-center">
                <button onclick="resetAnalysis()" class="px-6 py-3 bg-wiki-card text-white rounded-lg hover:bg-wiki-primary transition">
                    <i class="fas fa-redo mr-2"></i>새로 분석하기
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const DEBUG_MODE = ${debugMode};
        const UNIVERSAL_QUESTIONS = ${majorQuestionsJson};
        const MAJOR_STAGES = ${majorStagesJson};
        
        // 5축 데이터
        const ROLE_IDENTITY_OPTIONS = ${roleIdentityOptionsJson};
        const CAREER_STAGE_OPTIONS = ${careerStageOptionsJson};
        const TRANSITION_STATUS_OPTIONS = ${transitionStatusOptionsJson};
        const SKILL_LEVEL_OPTIONS = ${skillLevelOptionsJson};
        const CONSTRAINT_OPTIONS = ${constraintOptionsJson};
        const TRANSITION_SIGNAL_QUESTIONS = ${transitionSignalQuestionsJson};
        const IDENTITY_ANCHOR_PATTERNS = ${identityAnchorPatternsJson};
        
        // 상태 관리
        let currentStep = 1;
        let selectedAnalysisType = 'major';
        let selectedStage = null;
        let universalAnswers = {};
        let followupAnswers = {};
        let transitionSignalAnswers = {};
        let currentSessionId = null;
        let currentRequestId = null;
        
        let careerState = {
            role_identity: null,
            career_stage_years: null,
            transition_status: null,
            skill_level: null,
            constraints: {}
        };
        
        // 로딩
        function showLoading(message, submessage = '잠시만 기다려주세요') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-submessage').textContent = submessage;
            overlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // ============================================
        // 이력서 업로드 처리 (전공 추천)
        // ============================================
        async function handleResumeUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showResumeError('PDF 파일만 업로드 가능합니다.');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showResumeError('파일 크기는 5MB 이하만 가능합니다.');
                return;
            }
            
            document.getElementById('resume-loading').classList.remove('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.add('hidden');
            
            try {
                await loadPdfJs();
                const pdfText = await extractTextFromPdf(file);
                
                if (pdfText.length < 100) {
                    showResumeError('문서에서 충분한 텍스트를 추출하지 못했습니다.');
                    return;
                }
                
                const response = await fetch('/api/ai-analyzer/resume/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: pdfText,
                        session_id: currentSessionId,
                        save_to_draft: false,
                    }),
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || '파싱 실패');
                
                applyResumeParseResult(data.career_state, data.data);
                
                document.getElementById('resume-loading').classList.add('hidden');
                document.getElementById('resume-status').classList.remove('hidden');
                
                // 이력서 형식 확인 (추출된 데이터 기준)
                const extracted = data.data.extracted || {};
                const hasSkills = extracted.skills?.length > 0;
                const hasCerts = extracted.certifications?.length > 0;
                const hasEducation = !!extracted.education_level;
                const hasExperience = extracted.total_experience_years !== null;
                const hasRole = !!extracted.current_role_type;
                
                const extractedCount = [hasSkills, hasCerts, hasEducation, hasExperience, hasRole].filter(Boolean).length;
                
                if (extractedCount < 2) {
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-amber-400">⚠️ 충분한 정보를 추출하지 못했어요. 그래도 입력하신 내용은 참고됩니다.</span>';
                } else {
                    const infoSummary = [];
                    if (hasSkills) infoSummary.push('스킬 ' + extracted.skills.length + '개');
                    if (hasCerts) infoSummary.push('자격증 ' + extracted.certifications.length + '개');
                    if (hasEducation) infoSummary.push(extracted.education_level);
                    if (hasExperience) infoSummary.push('경력 ' + extracted.total_experience_years + '년');
                    if (hasRole) infoSummary.push(extracted.current_role_type);
                    
                    document.getElementById('resume-status-text').innerHTML = 
                        '<span class="text-emerald-400">✓ 분석 완료! (' + infoSummary.slice(0, 3).join(', ') + ')</span>';
                }
                
            } catch (error) {
                console.error('Resume upload error:', error);
                showResumeError(error.message || '문서 분석 중 오류가 발생했습니다.');
            }
        }
        
        function showResumeError(message) {
            document.getElementById('resume-loading').classList.add('hidden');
            document.getElementById('resume-status').classList.add('hidden');
            document.getElementById('resume-error').classList.remove('hidden');
            document.getElementById('resume-error-text').textContent = message;
        }
        
        async function loadPdfJs() {
            return new Promise((resolve, reject) => {
                if (window.pdfjsLib) { resolve(); return; }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = () => reject(new Error('PDF.js 로드 실패'));
                document.head.appendChild(script);
            });
        }
        
        async function extractTextFromPdf(file) {
            await loadPdfJs();
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            return fullText.trim();
        }
        
        function applyResumeParseResult(careerStateFromResume, parsedData) {
            // 전환 상태 선택
            if (careerStateFromResume.transition_status) {
                const transBtn = document.querySelector(\`#transition-status-options [data-value="\${careerStateFromResume.transition_status}"]\`);
                if (transBtn && !transBtn.classList.contains('selected')) transBtn.click();
            }
            
            // 숙련도 선택
            if (careerStateFromResume.skill_level !== undefined && careerStateFromResume.skill_level !== null) {
                const skillBtn = document.querySelector(\`#skill-level-options [data-value="\${careerStateFromResume.skill_level}"]\`);
                if (skillBtn) skillBtn.click();
            }
            
            console.log('Resume parsed successfully:', parsedData);
        }
        
        // ============================================
        // 전공 추천용 비활성화 규칙
        // ============================================
        const STUDENT_TYPE_DISABLED_RULES = {
            middle: {
                career_stage: ['univ', 'grad', 'work_exp'],
                transition_status: ['job_change', 'promotion', 'return_work'],
                skill_level: [3, 4],
                reasons: {
                    career_stage: '중학생은 선택할 수 없어요',
                    transition_status: '학생에게는 해당하지 않아요',
                    skill_level: '아직 해당 단계가 아니에요'
                }
            },
            high: {
                career_stage: ['grad', 'work_exp'],
                transition_status: ['job_change', 'promotion', 'return_work'],
                skill_level: [4],
                reasons: {
                    career_stage: '고등학생은 선택할 수 없어요',
                    transition_status: '학생에게는 해당하지 않아요',
                    skill_level: '아직 해당 단계가 아니에요'
                }
            },
            univ: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            },
            grad: {
                career_stage: [],
                transition_status: [],
                skill_level: [],
                reasons: {}
            }
        };
        
        let studentType = null;
        let majorPurpose = null;
        
        // ============================================
        // 5축 UI 렌더링 (전공 전용 - 프로페셔널 디자인)
        // ============================================
        function renderCareerStateForm() {
            renderStudentTypeOptions();
            renderMajorPurposeOptions();
            updateTransitionStatusOptionsMajor();
            updateSkillLevelOptionsMajor();
            renderConstraintOptionsMajor();
        }
        
        // 학생 유형 선택 (다크 테마)
        function renderStudentTypeOptions() {
            const container = document.getElementById('student-type-options');
            if (!container) return;
            
            const studentTypes = [
                { value: 'middle', label: '중학생', description: '진로 탐색 중', emoji: '🎒' },
                { value: 'high', label: '고등학생', description: '대학 진학 준비', emoji: '📖' },
                { value: 'univ', label: '대학생', description: '전공 탐색/전과', emoji: '🎓' },
                { value: 'grad', label: '대학원 준비', description: '석·박사 진학', emoji: '🔬' },
            ];
            
            container.innerHTML = studentTypes.map(opt => \`
                <button type="button" onclick="selectStudentType('\${opt.value}', this)"
                        class="student-type-card group relative overflow-hidden rounded-xl border border-wiki-border/50 bg-wiki-card/80 p-4 hover:bg-wiki-card hover:border-cyan-500/50 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/10"
                        data-value="\${opt.value}">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-cyan-500/10 to-transparent rounded-bl-full"></div>
                    <div class="relative z-10">
                        <div class="text-3xl mb-2 transform group-hover:scale-110 transition-transform">\${opt.emoji}</div>
                        <div class="font-semibold text-white">\${opt.label}</div>
                        <div class="text-xs text-wiki-muted mt-1">\${opt.description}</div>
                    </div>
                </button>
            \`).join('');
        }
        
        function selectStudentType(value, btnEl) {
            studentType = value;
            careerState.role_identity = 'student'; // 전공 추천은 항상 student
            
            // 선택 상태 업데이트
            document.querySelectorAll('#student-type-options .student-type-card').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'bg-cyan-500/20', 'shadow-lg', 'shadow-cyan-500/20');
                btn.classList.add('border-wiki-border/50');
            });
            btnEl.classList.remove('border-wiki-border/50');
            btnEl.classList.add('border-cyan-500', 'bg-cyan-500/20', 'shadow-lg', 'shadow-cyan-500/20');
            
            // 다른 축들 업데이트
            setTimeout(() => {
                updateTransitionStatusOptionsMajor();
                updateSkillLevelOptionsMajor();
            }, 150);
            
            checkStep1Completion();
        }
        
        // 전공 선택 목적 (다크 테마)
        function renderMajorPurposeOptions() {
            const container = document.getElementById('career-stage-options');
            if (!container) return;
            
            const purposes = [
                { value: 'explore', label: '진로 탐색', description: '다양한 전공 알아보기', emoji: '🔍' },
                { value: 'decide', label: '전공 결정', description: '입학/전과 준비', emoji: '✅' },
                { value: 'change', label: '전공 변경', description: '복수전공/전과 고려', emoji: '🔄' },
                { value: 'career', label: '진로 연계', description: '취업을 위한 전공', emoji: '💼' },
            ];
            
            container.innerHTML = purposes.map((opt, idx) => \`
                <button type="button" onclick="selectMajorPurpose('\${opt.value}', this)"
                        class="purpose-btn group relative overflow-hidden rounded-xl p-4 bg-wiki-card/80 border border-wiki-border/50 hover:border-purple-500/50 hover:bg-wiki-card transition-all duration-300"
                        data-value="\${opt.value}">
                    <div class="relative z-10">
                        <div class="text-2xl mb-2">\${opt.emoji}</div>
                        <div class="font-semibold text-sm text-white">\${opt.label}</div>
                        <div class="text-xs text-wiki-muted mt-0.5">\${opt.description}</div>
                    </div>
                </button>
            \`).join('');
        }
        
        function selectMajorPurpose(value, btnEl) {
            majorPurpose = value;
            careerState.career_stage_years = value === 'explore' ? 'none' : value === 'decide' ? '0_3' : value === 'change' ? '0_3' : '3_10';
            
            document.querySelectorAll('#career-stage-options .purpose-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-500/20', 'shadow-lg', 'shadow-purple-500/20');
                btn.classList.add('border-wiki-border/50');
            });
            btnEl.classList.remove('border-wiki-border/50');
            btnEl.classList.add('border-purple-500', 'bg-purple-500/20', 'shadow-lg', 'shadow-purple-500/20');
            
            checkStep1Completion();
        }
        
        // 전환 상태 (다중 선택 - 다크 테마)
        function updateTransitionStatusOptionsMajor() {
            const container = document.getElementById('transition-status-options');
            if (!container) return;
            
            const rules = studentType && STUDENT_TYPE_DISABLED_RULES[studentType] 
                ? STUDENT_TYPE_DISABLED_RULES[studentType] 
                : { transition_status: [], reasons: {} };
            const disabledValues = rules.transition_status || [];
            const reason = rules.reasons?.transition_status || '현재 상태에서 선택할 수 없어요';
            
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            careerState.transition_status = careerState.transition_status.filter(v => !disabledValues.includes(v));
            
            container.innerHTML = TRANSITION_STATUS_OPTIONS.map(opt => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.transition_status.includes(opt.value);
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="toggleTransitionStatusMajor('\${opt.value}', this)"\`}
                            class="goal-chip group relative rounded-xl p-4 transition-all duration-300 \${
                                isDisabled 
                                    ? 'bg-wiki-bg/50 cursor-not-allowed opacity-40' 
                                    : isSelected 
                                        ? 'bg-emerald-500/20 border border-emerald-500 shadow-lg shadow-emerald-500/20 transform scale-[1.02]' 
                                        : 'bg-wiki-card/80 border border-wiki-border/50 hover:border-emerald-500/50 hover:bg-wiki-card'
                            }"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-4 h-4 text-wiki-muted/50" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : isSelected ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        <div class="text-2xl mb-2 \${isDisabled ? 'grayscale opacity-50' : ''}">\${opt.emoji}</div>
                        <div class="font-semibold text-sm \${isDisabled ? 'text-wiki-muted/50' : isSelected ? 'text-emerald-400' : 'text-white'}">\${opt.label}</div>
                        <div class="text-xs mt-1 \${isDisabled ? 'text-wiki-muted/30' : isSelected ? 'text-emerald-300/80' : 'text-wiki-muted'}">\${opt.description}</div>
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-wiki-border/30">
                                🔒 \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function toggleTransitionStatusMajor(value, btnEl) {
            if (!Array.isArray(careerState.transition_status)) {
                careerState.transition_status = [];
            }
            
            const idx = careerState.transition_status.indexOf(value);
            if (idx === -1) {
                careerState.transition_status.push(value);
            } else {
                careerState.transition_status.splice(idx, 1);
            }
            
            updateTransitionStatusOptionsMajor();
            checkStep1Completion();
        }
        
        // 숙련도 (다크 테마 레벨 게이지)
        function updateSkillLevelOptionsMajor() {
            const container = document.getElementById('skill-level-options');
            if (!container) return;
            
            const rules = studentType && STUDENT_TYPE_DISABLED_RULES[studentType] 
                ? STUDENT_TYPE_DISABLED_RULES[studentType] 
                : { skill_level: [], reasons: {} };
            const disabledValues = rules.skill_level || [];
            const reason = rules.reasons?.skill_level || '현재 상태에서 선택할 수 없어요';
            
            if (disabledValues.includes(careerState.skill_level)) {
                careerState.skill_level = null;
            }
            
            container.innerHTML = SKILL_LEVEL_OPTIONS.map((opt, idx) => {
                const isDisabled = disabledValues.includes(opt.value);
                const isSelected = careerState.skill_level === opt.value;
                const levelBars = idx + 1;
                
                return \`
                    <button type="button" \${isDisabled ? '' : \`onclick="selectSkillLevelMajor(\${opt.value}, this)"\`}
                            class="skill-btn group relative rounded-xl p-3 transition-all duration-300 \${
                                isDisabled 
                                    ? 'bg-wiki-bg/50 cursor-not-allowed opacity-40' 
                                    : isSelected 
                                        ? 'bg-violet-500/20 border border-violet-500 shadow-lg shadow-violet-500/20' 
                                        : 'bg-wiki-card/80 border border-wiki-border/50 hover:border-violet-500/50 hover:bg-wiki-card'
                            }"
                            data-value="\${opt.value}" \${isDisabled ? 'disabled' : ''}>
                        \${isDisabled ? \`
                            <div class="absolute top-2 right-2">
                                <svg class="w-3.5 h-3.5 text-wiki-muted/50" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        \` : ''}
                        <div class="flex gap-1 mb-2 justify-center">
                            \${[1,2,3,4,5].map(i => \`
                                <div class="w-3 h-6 rounded-sm transition-all duration-300 \${
                                    i <= levelBars 
                                        ? isDisabled ? 'bg-wiki-muted/30' : isSelected ? 'bg-violet-500' : 'bg-wiki-muted/50'
                                        : 'bg-wiki-border/30'
                                }"></div>
                            \`).join('')}
                        </div>
                        <div class="font-semibold text-sm \${isDisabled ? 'text-wiki-muted/50' : isSelected ? 'text-violet-400' : 'text-white'}">\${opt.label}</div>
                        <div class="text-xs \${isDisabled ? 'text-wiki-muted/30' : 'text-wiki-muted'} mt-0.5">\${opt.description}</div>
                        \${isDisabled ? \`
                            <div class="disabled-tooltip absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1.5 bg-black/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 border border-wiki-border/30">
                                🔒 \${reason}
                            </div>
                        \` : ''}
                    </button>
                \`;
            }).join('');
        }
        
        function selectSkillLevelMajor(value, btnEl) {
            careerState.skill_level = value;
            updateSkillLevelOptionsMajor();
            checkStep1Completion();
        }
        
        // 제약 조건 (다크 테마 아코디언 카드)
        let noConstraintSelectedMajor = false;
        
        function renderConstraintOptionsMajor() {
            const container = document.getElementById('constraint-options');
            if (!container) return;
            
            container.innerHTML = \`
                <div class="mb-4">
                    <button type="button" onclick="toggleNoConstraintMajor(this)" id="no-constraint-btn"
                            class="w-full p-4 rounded-xl border border-dashed hover:border-emerald-500/50 transition-all duration-300 group"
                            style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.5);">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform" style="background-color: rgba(16,185,129,0.2);">✅</div>
                            <div class="text-left flex-1">
                                <div class="font-semibold text-white">제약 없음</div>
                                <div class="text-sm" style="color: rgb(148,163,184)">특별한 제약 조건 없이 모든 옵션 고려</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center no-constraint-check opacity-0 transition-opacity" style="border-color: rgba(42,42,62,0.5);">
                                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </button>
                </div>
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                    <span class="text-xs font-medium" style="color: rgb(148,163,184)">또는 제약 조건 선택</span>
                    <div class="flex-1 h-px" style="background-color: rgba(42,42,62,0.3)"></div>
                </div>
                <div id="constraint-list" class="grid gap-3">
                    \${CONSTRAINT_OPTIONS.map(opt => \`
                        <div class="constraint-card rounded-xl border overflow-hidden transition-all duration-300" 
                             style="border-color: rgba(42,42,62,0.5); background-color: rgba(26,26,46,0.9);"
                             data-type="\${opt.type}">
                            <button type="button" onclick="toggleConstraintMajor('\${opt.type}', this)"
                                    class="constraint-header w-full p-4 flex items-center gap-4 text-left transition-colors"
                                    onmouseover="this.style.backgroundColor='rgba(26,26,46,1)';"
                                    onmouseout="this.style.backgroundColor='transparent';">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl flex-shrink-0" style="background-color: rgba(245,158,11,0.2);">\${opt.emoji}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-white">\${opt.label}</div>
                                    <div class="text-sm truncate" style="color: rgb(148,163,184)">\${opt.description}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="constraint-badge hidden px-2 py-1 text-amber-400 text-xs font-medium rounded-full" style="background-color: rgba(245,158,11,0.2);">선택됨</div>
                                    <svg class="constraint-chevron w-5 h-5 transition-transform duration-300" style="color: rgb(148,163,184)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </button>
                            <div class="constraint-detail hidden border-t" style="border-color: rgba(42,42,62,0.3); background-color: rgba(15,15,35,0.5);">
                                <div class="p-4 space-y-4">
                <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">구체적인 상황 (선택)</label>
                                        <div class="flex flex-wrap gap-2">
                                            \${opt.details.map(d => \`
                                                <button type="button" onclick="selectConstraintDetailMajor('\${opt.type}', '\${d.value}', this)"
                                                        class="detail-tag px-3 py-1.5 text-sm rounded-full border"
                                                        data-value="\${d.value}">
                                                    \${d.label}
                                                </button>
                                            \`).join('')}
                </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium mb-2 block" style="color: rgb(148,163,184)">추가 설명 (선택)</label>
                                        <textarea class="w-full px-4 py-3 text-sm border rounded-lg transition-all resize-none"
                                                  style="border-color: rgba(42,42,62,0.5); background-color: rgba(15,15,35,1); color: #fff;"
                                                  rows="2" placeholder="\${opt.placeholder}"
                                                  onfocus="this.style.borderColor='rgba(245,158,11,0.5)';"
                                                  onblur="this.style.borderColor='rgba(42,42,62,0.5)';"
                                                  onchange="updateConstraintCustomDetailMajor('\${opt.type}', this.value)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }
        
        function toggleNoConstraintMajor(btnEl) {
            noConstraintSelectedMajor = !noConstraintSelectedMajor;
            const checkEl = btnEl.querySelector('.no-constraint-check');
            const constraintList = document.getElementById('constraint-list');
            
            if (noConstraintSelectedMajor) {
                btnEl.classList.add('border-solid', 'shadow-lg');
                btnEl.classList.remove('border-dashed');
                btnEl.style.borderColor = '#10b981';
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                checkEl.classList.remove('opacity-0');
                checkEl.classList.add('opacity-100');
                checkEl.style.backgroundColor = '#10b981';
                checkEl.style.borderColor = '#10b981';
                careerState.constraints = {};
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.add('opacity-30', 'pointer-events-none');
                    card.querySelector('.constraint-badge')?.classList.add('hidden');
                    card.querySelector('.constraint-detail')?.classList.add('hidden');
                    card.querySelector('.constraint-chevron')?.classList.remove('rotate-180');
                });
                constraintList.classList.add('opacity-50');
            } else {
                btnEl.classList.remove('border-solid', 'shadow-lg');
                btnEl.classList.add('border-dashed');
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                checkEl.classList.remove('opacity-100');
                checkEl.style.backgroundColor = 'transparent';
                checkEl.style.borderColor = 'rgba(42,42,62,0.5)';
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                constraintList.classList.remove('opacity-50');
            }
        }
        
        function toggleConstraintMajor(type, btnEl) {
            if (noConstraintSelectedMajor) {
                noConstraintSelectedMajor = false;
                const noBtn = document.getElementById('no-constraint-btn');
                const checkEl = noBtn.querySelector('.no-constraint-check');
                noBtn.classList.remove('border-solid', 'shadow-lg');
                noBtn.classList.add('border-dashed');
                noBtn.style.borderColor = 'rgba(42,42,62,0.5)';
                noBtn.style.backgroundColor = 'rgba(26,26,46,0.5)';
                checkEl.classList.add('opacity-0');
                document.querySelectorAll('.constraint-card').forEach(card => {
                    card.classList.remove('opacity-30', 'pointer-events-none');
                });
                document.getElementById('constraint-list').classList.remove('opacity-50');
            }
            
            const card = btnEl.closest('.constraint-card');
            const badge = card.querySelector('.constraint-badge');
            const detail = card.querySelector('.constraint-detail');
            const chevron = card.querySelector('.constraint-chevron');
            const isSelected = careerState.constraints[type]?.has_constraint;
            
            if (isSelected) {
                delete careerState.constraints[type];
                card.classList.remove('shadow-lg');
                card.style.borderColor = 'rgba(42,42,62,0.5)';
                badge.classList.add('hidden');
                detail.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                detail.querySelectorAll('.detail-tag').forEach(tag => {
                    tag.classList.remove('selected');
                    tag.style.backgroundColor = 'rgba(26,26,46,0.5)';
                    tag.style.borderColor = 'rgba(42,42,62,0.5)';
                    tag.style.color = 'rgb(148,163,184)';
                });
            } else {
                careerState.constraints[type] = { has_constraint: true };
                card.classList.add('shadow-lg');
                card.style.borderColor = '#f59e0b';
                badge.classList.remove('hidden');
                detail.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            }
        }
        
        function selectConstraintDetailMajor(type, value, btnEl) {
            if (!careerState.constraints[type]) return;

            const isCurrentlySelected = btnEl.classList.contains('selected');

            // details 배열 초기화
            if (!careerState.constraints[type].details) {
                careerState.constraints[type].details = [];
            }
            if (!Array.isArray(careerState.constraints[type].details)) {
                careerState.constraints[type].details = careerState.constraints[type].details
                    ? [careerState.constraints[type].details] : [];
            }

            // 토글: 선택/해제
            if (isCurrentlySelected) {
                btnEl.classList.remove('selected');
                careerState.constraints[type].details = careerState.constraints[type].details.filter(v => v !== value);
            } else {
                btnEl.classList.add('selected');
                if (!careerState.constraints[type].details.includes(value)) {
                    careerState.constraints[type].details.push(value);
                }
            }
            
            // 스타일 즉시 적용
            applyDetailTagStyle(btnEl, !isCurrentlySelected);
        }
        
        function updateConstraintCustomDetailMajor(type, value) {
            if (!careerState.constraints[type]) return;
            careerState.constraints[type].custom_detail = value;
        }
        
        function selectAxis(axis, value, btnEl) {
            careerState[axis] = value;
            const container = btnEl.parentElement;
            container.querySelectorAll('.axis-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            });
            btnEl.classList.add('ring-2', 'ring-wiki-primary', 'bg-wiki-primary/10', 'border-wiki-primary');
            checkStep1Completion();
        }
        
        function toggleConstraint(type, btnEl) {
            const isSelected = careerState.constraints[type]?.has_constraint;
            if (isSelected) {
                delete careerState.constraints[type];
                btnEl.classList.remove('ring-2', 'ring-amber-400', 'bg-amber-400/10', 'border-amber-400');
            } else {
                careerState.constraints[type] = { has_constraint: true };
                btnEl.classList.add('ring-2', 'ring-amber-400', 'bg-amber-400/10', 'border-amber-400');
            }
        }
        
        function checkStep1Completion() {
            const hasStudentType = studentType !== null;
            const hasMajorPurpose = majorPurpose !== null;
            const hasTransition = Array.isArray(careerState.transition_status) && careerState.transition_status.length > 0;
            const hasSkillLevel = careerState.skill_level !== null;
            const isComplete = hasStudentType && hasMajorPurpose && hasTransition && hasSkillLevel;
            const nextBtn = document.getElementById('step1-next-btn');
            nextBtn.disabled = !isComplete;
            if (isComplete) nextBtn.classList.add('hover-glow');
            else nextBtn.classList.remove('hover-glow');
        }
        
        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('step' + step);
            if (target) target.classList.remove('hidden');
            currentStep = step;
            
            // 본인 계정 경고 배너: Step 1에서만 표시
            const warningBanner = document.getElementById('account-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = step === 1 ? 'block' : 'none';
            }
            
            document.querySelectorAll('.step-dot').forEach(dot => {
                const dotStep = parseInt(dot.dataset.step);
                const circle = dot.querySelector('span');
                if (dotStep === step) {
                    dot.classList.add('active');
                    circle.classList.remove('bg-wiki-card', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-primary', 'text-white');
                } else if (dotStep < step) {
                    circle.classList.remove('bg-wiki-card', 'text-wiki-muted');
                    circle.classList.add('bg-wiki-secondary', 'text-white');
                } else {
                    dot.classList.remove('active');
                    circle.classList.remove('bg-wiki-primary', 'bg-wiki-secondary', 'text-white');
                    circle.classList.add('bg-wiki-card', 'text-wiki-muted');
                }
            });
        }
        
        function goToStep2WithLoading() {
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            showLoading('질문 구성 중...', '상황에 맞는 질문을 준비하고 있어요');
            setTimeout(() => {
                renderUniversalQuestions();
                goToStep(2);
                hideLoading();
            }, 600);
        }
        
        // 전이 신호 렌더링 (고급 UI)
        function renderTransitionSignalForm() {
            const container = document.getElementById('transition-signal-form');
            if (!container) {
                console.warn('[renderTransitionSignalForm] Container not found');
                return;
            }
            container.innerHTML = TRANSITION_SIGNAL_QUESTIONS.map(q => {
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-2 text-white">\${q.text}</h4>
                            <p class="text-xs mb-3" style="color: rgb(100,116,139)">최대 \${q.max_selections || 3}개까지 선택 (선택 순서 = 우선순위)</p>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map((opt, idx) => \`
                                    <button type="button" onclick="selectTransitionChip('\${q.question_id}', '\${opt.value}', this, \${q.max_selections || 3})"
                                            class="trans-chip group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-rank"></div>
                                    </button>
                                \`).join('')}
                            </div>
                            <div class="selected-order mt-3 text-sm hidden p-3 rounded-lg" style="background-color: rgba(16,185,129,0.1); color: #34d399;"></div>
                        </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectTransitionRadio('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-radio group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(148,163,184)"><span class="mr-1">\${opt.emoji}</span>\${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                } else if (q.ui_type === 'checkbox') {
                    return \`
                        <div class="trans-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="\${q.question_id}">
                            <h4 class="font-semibold mb-4 text-white">\${q.text}</h4>
                            <div class="flex flex-wrap gap-2">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleTransitionCheckbox('\${q.question_id}', '\${opt.value}', this)"
                                            class="trans-checkbox group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">\${opt.emoji}</span>
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                    </button>
                                \`).join('')}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
        }
        
        function selectTransitionChip(questionId, value, btnEl, maxSelections) {
            if (!transitionSignalAnswers[questionId]) transitionSignalAnswers[questionId] = [];
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-rank')?.classList.add('hidden');
                btnEl.querySelector('.chip-rank')?.classList.remove('flex');
            } else if (arr.length < maxSelections) {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
            }
            updateChipOrder(questionId);
        }
        
        function updateChipOrder(questionId) {
            const container = document.querySelector(\`[data-question-id="\${questionId}"]\`);
            if (!container) {
                console.warn('[updateChipOrder] Container not found for:', questionId);
                return;
            }
            const orderEl = container.querySelector('.selected-order');
            if (!orderEl) {
                console.warn('[updateChipOrder] Order element not found for:', questionId);
                return;
            }
            const arr = transitionSignalAnswers[questionId] || [];
            
            // 모든 순위 배지 초기화
            container.querySelectorAll('.trans-chip').forEach(btn => {
                const rank = btn.querySelector('.chip-rank');
                if (rank) {
                    rank.classList.add('hidden');
                    rank.classList.remove('flex');
                }
            });
            
            if (arr.length > 0) {
                const q = TRANSITION_SIGNAL_QUESTIONS.find(q => q.question_id === questionId);
                const labels = arr.map((v, i) => {
                    const opt = q?.options.find(o => o.value === v);
                    const btn = container.querySelector(\`[data-value="\${v}"]\`);
                    if (btn) {
                        const rank = btn.querySelector('.chip-rank');
                        if (rank) {
                            rank.textContent = i + 1;
                            rank.classList.remove('hidden');
                            rank.classList.add('flex');
                        }
                    }
                    return \`\${i + 1}순위: \${opt?.label || v}\`;
                });
                orderEl.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>' + labels.join(' → ');
                orderEl.classList.remove('hidden');
            } else {
                orderEl.classList.add('hidden');
            }
        }
        
        function selectTransitionRadio(questionId, value, btnEl) {
            const isSelected = transitionSignalAnswers[questionId] === value;
            const container = btnEl.parentElement;
            
            container.querySelectorAll('.trans-radio').forEach(btn => {
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                transitionSignalAnswers[questionId] = value;
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete transitionSignalAnswers[questionId];
            }
        }
        
        function toggleTransitionCheckbox(questionId, value, btnEl) {
            if (!transitionSignalAnswers[questionId]) transitionSignalAnswers[questionId] = [];
            const arr = transitionSignalAnswers[questionId];
            const idx = arr.indexOf(value);
            
            if (idx > -1) {
                arr.splice(idx, 1);
                btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                btnEl.style.color = 'rgb(148,163,184)';
                btnEl.querySelector('.chip-check')?.classList.add('hidden');
                btnEl.querySelector('.chip-check')?.classList.remove('flex');
            } else {
                arr.push(value);
                btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                btnEl.style.borderColor = '#10b981';
                btnEl.style.color = '#34d399';
                btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                btnEl.querySelector('.chip-check')?.classList.add('flex');
            }
        }
        
        async function submitUniversalAndGoToTransition() {
            collectUniversalAnswers();
            
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            showLoading('답변 저장 중...', '전이 신호 질문을 준비하고 있어요');
            setTimeout(() => {
                try {
                    renderTransitionSignalForm();
                    goToStep(3);
                } catch (error) {
                    console.error('[submitUniversalAndGoToTransition] Error:', error);
                } finally {
                    hideLoading();
                }
            }, 600);
        }
        
        async function submitTransitionAndContinue() {
            // 서버에 자동 저장 (백그라운드)
            saveDraftToServer();
            
            showLoading('분석 중...', '맞춤 심층 질문을 구성하고 있어요');
            
            try {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage || 'major_high',
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.result?.followup_questions?.length > 0) {
                    renderFollowupQuestions(data.result.followup_questions);
                    goToStep(4);
                } else {
                    currentRequestId = data.request_id;
                    displayResults(data);
                    saveDraftAsCompletedMajor();  // 결과 저장
                    goToStep(5);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        // Universal Questions 렌더링 (Major용 - 고급 UI)
        function renderUniversalQuestions() {
            const container = document.getElementById('universal-questions');
            container.innerHTML = UNIVERSAL_QUESTIONS.map(q => {
                const requiredMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : '';
                
                if (q.ui_type === 'chips') {
                    return \`
                        <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                            <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                            <div class="flex flex-wrap gap-2" data-question-id="\${q.id}" data-max-selections="\${q.max_selections || 99}">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="toggleChipOptionMajor('\${q.id}', '\${opt.value}', this, false)"
                                            class="chip-option group relative px-4 py-2.5 rounded-xl border transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5); color: rgb(148,163,184);"
                                            data-value="\${opt.value}">
                                        <span class="flex items-center gap-2">
                                            \${opt.emoji ? \`<span class="text-lg">\${opt.emoji}</span>\` : ''}
                                            <span>\${opt.label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" onclick="toggleChipOptionMajor('\${q.id}', '_unknown', this, true)"
                                            class="chip-option chip-unknown group relative px-4 py-2.5 rounded-xl border border-dashed transition-all duration-200"
                                            style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5); color: rgb(120,120,140);"
                                            data-value="_unknown">
                                        <span class="flex items-center gap-2">
                                            <span class="text-lg">❓</span>
                                            <span>\${q.unknown_label}</span>
                                        </span>
                                        <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-slate-500 text-white items-center justify-center text-xs font-bold hidden chip-check">✓</div>
                                    </button>
                                \` : ''}
                            </div>
                            \${q.max_selections ? \`<p class="text-xs mt-2" style="color: rgb(100,116,139)">최대 \${q.max_selections}개 선택 가능</p>\` : ''}
                    </div>
                    \`;
                } else if (q.ui_type === 'radio') {
                    return \`
                        <div class="question-block p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);">
                            <label class="block text-lg font-semibold mb-4 text-white">\${q.text}\${requiredMark}</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3" data-question-id="\${q.id}">
                                \${q.options.map(opt => \`
                                    <button type="button" onclick="selectRadioOptionMajor('\${q.id}', '\${opt.value}', this, false)"
                                            class="radio-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                            style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                            data-value="\${opt.value}">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 hidden radio-dot"></div>
                </div>
                                            <span style="color: rgb(148,163,184)">\${opt.emoji || ''} \${opt.label}</span>
                                        </div>
                                    </button>
                                \`).join('')}
                                \${q.allow_unknown ? \`
                                    <button type="button" onclick="selectRadioOptionMajor('\${q.id}', '_unknown', this, true)"
                                            class="radio-option radio-unknown group relative p-4 rounded-xl border border-dashed text-left transition-all duration-200"
                                            style="background-color: rgba(15,15,35,0.5); border-color: rgba(100,100,120,0.5);"
                                            data-value="_unknown">
                                        <div class="flex items-center gap-3">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                                 style="border-color: rgba(100,100,120,0.5);">
                                                <div class="w-2.5 h-2.5 rounded-full bg-slate-500 hidden radio-dot"></div>
                                            </div>
                                            <span style="color: rgb(120,120,140)">❓ \${q.unknown_label}</span>
                                        </div>
                                    </button>
                                \` : ''}
                            </div>
                        </div>
                    \`;
                }
                return '';
            }).join('');
        }
        
        // 칩 옵션 토글 (Major용)
        function toggleChipOptionMajor(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const maxSelections = parseInt(container.dataset.maxSelections) || 99;
            const isSelected = btnEl.classList.contains('selected');
            
            if (isUnknown) {
                container.querySelectorAll('.chip-option').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.style.backgroundColor = btn.classList.contains('chip-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                    btn.style.borderColor = btn.classList.contains('chip-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                    btn.style.color = btn.classList.contains('chip-unknown') ? 'rgb(120,120,140)' : 'rgb(148,163,184)';
                    btn.querySelector('.chip-check')?.classList.add('hidden');
                    btn.querySelector('.chip-check')?.classList.remove('flex');
                });
                
                if (!isSelected) {
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.style.color = '#94a3b8';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                    universalAnswers[questionId] = ['_unknown'];
                } else {
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                    delete universalAnswers[questionId];
                }
            } else {
                const unknownBtn = container.querySelector('.chip-unknown');
                if (unknownBtn && unknownBtn.classList.contains('selected')) {
                    unknownBtn.classList.remove('selected');
                    unknownBtn.style.backgroundColor = 'rgba(15,15,35,0.5)';
                    unknownBtn.style.borderColor = 'rgba(100,100,120,0.5)';
                    unknownBtn.style.borderStyle = 'dashed';
                    unknownBtn.style.color = 'rgb(120,120,140)';
                    unknownBtn.querySelector('.chip-check')?.classList.add('hidden');
                    unknownBtn.querySelector('.chip-check')?.classList.remove('flex');
                    container.querySelectorAll('.chip-option:not(.chip-unknown)').forEach(btn => {
                        btn.classList.remove('disabled-by-unknown');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    });
                }
                
                if (!universalAnswers[questionId]) universalAnswers[questionId] = [];
                
                if (isSelected) {
                    btnEl.classList.remove('selected');
                    btnEl.style.backgroundColor = 'rgba(26,26,46,0.9)';
                    btnEl.style.borderColor = 'rgba(42,42,62,0.5)';
                    btnEl.style.color = 'rgb(148,163,184)';
                    btnEl.querySelector('.chip-check')?.classList.add('hidden');
                    btnEl.querySelector('.chip-check')?.classList.remove('flex');
                    const idx = universalAnswers[questionId].indexOf(value);
                    if (idx > -1) universalAnswers[questionId].splice(idx, 1);
                } else {
                    if (universalAnswers[questionId].length >= maxSelections) {
                        const firstSelected = container.querySelector('.chip-option.selected:not(.chip-unknown)');
                        if (firstSelected) {
                            firstSelected.classList.remove('selected');
                            firstSelected.style.backgroundColor = 'rgba(26,26,46,0.9)';
                            firstSelected.style.borderColor = 'rgba(42,42,62,0.5)';
                            firstSelected.style.color = 'rgb(148,163,184)';
                            firstSelected.querySelector('.chip-check')?.classList.add('hidden');
                            firstSelected.querySelector('.chip-check')?.classList.remove('flex');
                            const removeVal = firstSelected.dataset.value;
                            const removeIdx = universalAnswers[questionId].indexOf(removeVal);
                            if (removeIdx > -1) universalAnswers[questionId].splice(removeIdx, 1);
                        }
                    }
                    
                    btnEl.classList.add('selected');
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.style.color = '#34d399';
                    btnEl.querySelector('.chip-check')?.classList.remove('hidden');
                    btnEl.querySelector('.chip-check')?.classList.add('flex');
                    universalAnswers[questionId].push(value);
                }
            }
        }
        
        // 라디오 옵션 선택 (Major용)
        function selectRadioOptionMajor(questionId, value, btnEl, isUnknown) {
            const container = btnEl.parentElement;
            const isSelected = btnEl.classList.contains('selected');
            
            container.querySelectorAll('.radio-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = btn.classList.contains('radio-unknown') ? 'rgba(15,15,35,0.5)' : 'rgba(26,26,46,0.9)';
                btn.style.borderColor = btn.classList.contains('radio-unknown') ? 'rgba(100,100,120,0.5)' : 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
                btn.classList.remove('disabled-by-unknown');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
            
            if (!isSelected) {
                btnEl.classList.add('selected');
                
                if (isUnknown) {
                    btnEl.style.backgroundColor = 'rgba(100,116,139,0.3)';
                    btnEl.style.borderColor = '#64748b';
                    btnEl.style.borderStyle = 'solid';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#64748b';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    
                    container.querySelectorAll('.radio-option:not(.radio-unknown)').forEach(btn => {
                        btn.classList.add('disabled-by-unknown');
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                    });
                    universalAnswers[questionId] = '_unknown';
                } else {
                    btnEl.style.backgroundColor = 'rgba(16,185,129,0.2)';
                    btnEl.style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-circle').style.borderColor = '#10b981';
                    btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
                    universalAnswers[questionId] = value;
                }
            } else {
                delete universalAnswers[questionId];
            }
        }
        
        function collectUniversalAnswers() {
            // 이미 universalAnswers에 수집됨
        }
        
        function renderFollowupQuestions(questions) {
            const container = document.getElementById('followup-questions-form');
            container.innerHTML = questions.map((q, i) => \`
                <div class="followup-question p-5 rounded-2xl mb-5" style="background-color: rgba(26,26,46,0.5); border: 1px solid rgba(42,42,62,0.3);" data-question-id="followup_\${q.id || i}">
                    <div class="flex items-start gap-4 mb-4">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white;">\${i + 1}</span>
                        <h4 class="font-semibold text-white text-lg leading-relaxed">\${q.question}</h4>
                    </div>
                    \${q.options ? \`
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 ml-12">
                            \${q.options.map(opt => \`
                                <button type="button" onclick="selectFollowup('\${q.id || i}', '\${opt.value || opt}', this)"
                                        class="followup-option group relative p-4 rounded-xl border text-left transition-all duration-200"
                                        style="background-color: rgba(26,26,46,0.9); border-color: rgba(42,42,62,0.5);"
                                        data-value="\${opt.value || opt}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 radio-circle"
                                             style="border-color: rgba(100,100,120,0.5);">
                                            <div class="w-2.5 h-2.5 rounded-full hidden radio-dot" style="background: linear-gradient(135deg, #a855f7, #6366f1);"></div>
                                        </div>
                                        <span style="color: rgb(148,163,184)">\${opt.label || opt}</span>
                                    </div>
                    </button>
                            \`).join('')}
                </div>
                    \` : \`
                        <div class="ml-12">
                            <textarea onchange="followupAnswers['\${q.id || i}'] = this.value" rows="3"
                                      class="w-full px-4 py-3 rounded-xl border transition-all resize-none"
                                      style="background-color: rgba(15,15,35,1); border-color: rgba(42,42,62,0.5); color: #fff;"
                                      onfocus="this.style.borderColor='rgba(168,85,247,0.5)';"
                                      onblur="this.style.borderColor='rgba(42,42,62,0.5)';"></textarea>
        </div>
                    \`}
    </div>
            \`).join('');
        }
        
        function selectFollowup(qid, value, btnEl) {
            const container = btnEl.closest('[data-question-id]');
            const isSelected = btnEl.classList.contains('selected');
            
            container.querySelectorAll('.followup-option').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.backgroundColor = 'rgba(26,26,46,0.9)';
                btn.style.borderColor = 'rgba(42,42,62,0.5)';
                btn.querySelector('.radio-circle').style.borderColor = 'rgba(100,100,120,0.5)';
                btn.querySelector('.radio-dot')?.classList.add('hidden');
            });
            
            if (!isSelected) {
                followupAnswers[qid] = value;
                btnEl.classList.add('selected');
                btnEl.style.backgroundColor = 'rgba(168,85,247,0.2)';
                btnEl.style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-circle').style.borderColor = '#a855f7';
                btnEl.querySelector('.radio-dot')?.classList.remove('hidden');
            } else {
                delete followupAnswers[qid];
            }
        }
        
        async function submitFollowupsAndAnalyze() {
            showLoading('AI가 분석 중...', '최적의 전공을 찾고 있어요');
            
            try {
                const response = await fetch('/api/ai-analyzer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        analysis_type: selectedAnalysisType,
                        stage: selectedStage || 'major_high',
                        career_state: careerState,
                        transition_signal: transitionSignalAnswers,
                        universal_answers: universalAnswers,
                        followup_answers: followupAnswers,
                        debug: DEBUG_MODE,
                    })
                });
                
                const data = await response.json();
                hideLoading();
                currentRequestId = data.request_id;
                displayResults(data);
                saveDraftAsCompletedMajor();  // 결과 저장
                goToStep(5);
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        function displayResults(data) {
            const container = document.getElementById('major-results');
            const result = data.result;
            
            // Confidence UI 표시
            displayConfidenceUI(result);
            
            if (!result || !result.recommendations || result.recommendations.length === 0) {
                container.innerHTML = '<p class="text-center text-wiki-muted">추천 결과가 없습니다. 다시 시도해주세요.</p>';
                return;
            }
            
            container.innerHTML = result.recommendations.map((rec, i) => \`
                <a href="/major/\${rec.slug || rec.major_id || rec.id || encodeURIComponent(rec.name)}" class="block p-4 bg-wiki-bg rounded-lg border border-wiki-border hover:border-wiki-primary transition group \${i === 0 ? 'border-wiki-primary ring-2 ring-wiki-primary/20' : ''}">
                    \${rec.image_url ? \`
                        <div class="mb-3 overflow-hidden rounded-lg">
                            <img src="\${rec.image_url}" alt="\${rec.name}" class="w-full h-32 object-cover group-hover:scale-105 transition-transform" />
                        </div>
                    \` : ''}
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-2xl font-bold text-wiki-primary">#\${i + 1}</span>
                        <h3 class="text-lg font-bold group-hover:text-wiki-primary transition">\${rec.name || rec.job_name || '추천 전공'}</h3>
                    </div>
                    <p class="text-wiki-muted text-sm mb-2">\${rec.reason || rec.match_reason || ''}</p>
                    \${rec.fit_score ? \`<div class="text-sm text-wiki-secondary">점수: \${Math.round(rec.fit_score * 100)}%</div>\` : ''}
                    <div class="text-xs text-wiki-primary mt-2 opacity-0 group-hover:opacity-100 transition">자세히 보기 →</div>
                </a>
            \`).join('');
        }
        
        function displayConfidenceUI(result) {
            const card = document.getElementById('confidence-card');
            if (!card) return;
            
            // confidence_score 계산
            let confidenceScore = result?.confidence_score;
            if (confidenceScore === undefined) {
                const answeredCount = Object.keys(universalAnswers).length + 
                                     Object.keys(transitionSignalAnswers).length + 
                                     Object.keys(followupAnswers).length;
                confidenceScore = Math.min(0.4 + (answeredCount * 0.06), 0.95);
            }
            
            const percentage = Math.round(confidenceScore * 100);
            
            document.getElementById('confidence-score-text').textContent = percentage + '%';
            document.getElementById('confidence-bar').style.width = percentage + '%';
            
            let description = '';
            if (percentage >= 80) {
                description = '충분한 정보를 바탕으로 신뢰도 높은 추천이에요.';
            } else if (percentage >= 60) {
                description = '기본적인 추천은 가능하지만, 더 많은 정보가 있으면 정확도가 올라가요.';
            } else {
                description = '제한된 정보로 추천했어요. 추가 질문에 답변하시면 더 정확해져요.';
            }
            document.getElementById('confidence-description').textContent = description;
            
            // 결정 변수
            const keyDecisions = result?.key_decision_variables || generateKeyDecisions();
            const decisionsHtml = keyDecisions.map(kd => \`
                <div class="flex items-start gap-3 p-2 bg-wiki-bg/50 rounded-lg">
                    <span class="text-amber-400">•</span>
                    <div class="flex-1">
                        <span class="text-sm">\${kd.label || kd.fact_key || kd}</span>
                    </div>
                </div>
            \`).join('');
            document.getElementById('key-decisions').innerHTML = decisionsHtml || '<p class="text-wiki-muted text-sm">결정 변수 정보가 없습니다.</p>';
            
            card.classList.remove('hidden');
        }
        
        function generateKeyDecisions() {
            const decisions = [];
            
            if (careerState.role_identity) {
                const opt = ROLE_IDENTITY_OPTIONS.find(o => o.value === careerState.role_identity);
                decisions.push({ label: '현재 상태: ' + (opt?.label || careerState.role_identity) });
            }
            if (careerState.transition_status && careerState.transition_status !== 'none') {
                const opt = TRANSITION_STATUS_OPTIONS.find(o => o.value === careerState.transition_status);
                decisions.push({ label: '전환 상태: ' + (opt?.label || careerState.transition_status) });
            }
            if (universalAnswers.univ_interest?.length > 0) {
                decisions.push({ label: '관심 분야: ' + universalAnswers.univ_interest.slice(0, 3).join(', ') });
            }
            if (universalAnswers.univ_priority) {
                decisions.push({ label: '우선순위: ' + universalAnswers.univ_priority });
            }
            if (transitionSignalAnswers.trans_motivation) {
                decisions.push({ label: '변화 동기: ' + transitionSignalAnswers.trans_motivation });
            }
            
            return decisions.slice(0, 5);
        }
        
        function resetAnalysis() {
            currentStep = 1;
            selectedStage = null;
            universalAnswers = {};
            followupAnswers = {};
            transitionSignalAnswers = {};
            careerState = { role_identity: null, career_stage_years: null, transition_status: null, skill_level: null, constraints: {} };
            
            document.querySelectorAll('.axis-btn, .constraint-btn, .chip-btn, .radio-btn, .trans-chip, .trans-radio, .trans-checkbox').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-wiki-primary', 'ring-emerald-400', 'ring-amber-400', 'bg-wiki-primary/10', 'bg-emerald-400/10', 'bg-amber-400/10', 'border-wiki-primary', 'border-emerald-400', 'border-amber-400');
            });
            
            document.getElementById('step1-next-btn').disabled = true;
            goToStep(1);
        }
        
        // 자동 복원 기능 (모달 사용) - 전공용
        let pendingDraft = null;
        let pendingServerDraft = null;
        
        async function autoRestoreDraft() {
            try {
                // 1. 서버에서 진행중인 draft 확인 (major 타입, 캐시 방지!)
                const serverResponse = await fetch('/api/ai-analyzer/draft/load?_t=' + Date.now(), {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-store',  // 브라우저 캐시 완전 무시
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const serverData = await serverResponse.json();
                
                if (serverResponse.ok && serverData.found && serverData.draft && serverData.draft.analysis_type === 'major') {
                    const serverDraft = serverData.draft;
                    pendingServerDraft = serverDraft;
                    
                    const stepNames = ['', '상태 선택', '기본 정보', '앞으로의 방향', '심층 질문', '결과'];
                    const savedDate = new Date(serverDraft.updated_at);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[serverDraft.current_step] + '</strong>까지 진행됨<br>' +
                        '<span class="text-xs">마지막 작업: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    console.log('[AutoRestore] Server draft found at step', serverDraft.current_step);
                    return 'modal';
                }
                
                // 서버에 major draft가 없으면 로컬 스토리지도 정리
                if (serverResponse.ok && !serverData.found) {
                    console.log('[AutoRestore] Server has no major draft, clearing local storage');
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                    return false;
                }
                
                // 2. 로컬 스토리지 확인 (서버 오류 시 폴백)
                const draftStr = localStorage.getItem('analyzer_draft_major');
                const timestamp = localStorage.getItem('analyzer_draft_major_timestamp');
                
                if (!draftStr) return false;
                
                const savedTime = parseInt(timestamp, 10);
                if (Date.now() - savedTime > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                    return false;
                }
                
                const draft = JSON.parse(draftStr);
                pendingDraft = draft;
                
                if (draft.currentStep >= 1) {
                    const stepNames = ['', '상태 선택', '기본 정보', '앞으로의 방향', '심층 질문', '결과'];
                    const savedDate = new Date(savedTime);
                    const dateStr = savedDate.toLocaleDateString('ko-KR') + ' ' + 
                                   savedDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('continue-modal-info').innerHTML = 
                        '<strong class="text-white">' + stepNames[draft.currentStep] + '</strong>까지 진행됨<br>' +
                        '<span class="text-xs">마지막 작업: ' + dateStr + '</span>';
                    
                    document.getElementById('continue-modal').classList.remove('hidden');
                    return 'modal';
                }
                
                return false;
            } catch (e) {
                console.warn('[AutoRestore] Failed:', e);
                return false;
            }
        }
        
        // 이어서 하기
        function continueFromDraft() {
            if (pendingServerDraft) {
                const draft = pendingServerDraft;
                currentSessionId = draft.session_id;
                
                if (draft.step1_answers?.careerState || draft.career_state) {
                    Object.assign(careerState, draft.step1_answers?.careerState || draft.career_state);
                }
                if (draft.step2_answers) {
                    universalAnswers = draft.step2_answers;
                }
                if (draft.step3_answers) {
                    transitionSignalAnswers = draft.step3_answers;
                }
                if (draft.step4_answers) {
                    window.roundAnswers = draft.step4_answers;
                }
                if (draft.step1_answers?.stage) {
                    selectedStage = draft.step1_answers.stage;
                }
                
                document.getElementById('continue-modal').classList.remove('hidden');
                document.getElementById('continue-modal').classList.add('hidden');
                
                setTimeout(() => {
                    updateStep1Selection();
                    if (draft.current_step >= 2) {
                        renderUniversalQuestions();
                    }
                    if (draft.current_step >= 3) {
                        renderTransitionSignalForm();
                    }
                }, 200);
                
                goToStep(draft.current_step, true);
                pendingServerDraft = null;
                return;
            }
            
            if (!pendingDraft) return;
            
            if (pendingDraft.collectedCareerState) {
                Object.assign(careerState, pendingDraft.collectedCareerState);
            }
            if (pendingDraft.universalAnswers) {
                universalAnswers = pendingDraft.universalAnswers;
            }
            if (pendingDraft.narrativeAnswers) {
                transitionSignalAnswers = pendingDraft.narrativeAnswers;
            }
            if (pendingDraft.roundAnswers) {
                window.roundAnswers = pendingDraft.roundAnswers;
            }
            if (pendingDraft.selectedStage) {
                selectedStage = pendingDraft.selectedStage;
            }
            
            document.getElementById('continue-modal').classList.add('hidden');
            
            setTimeout(() => {
                updateStep1Selection();
                if (pendingDraft.currentStep >= 2) {
                    renderUniversalQuestions();
                }
                if (pendingDraft.currentStep >= 3) {
                    renderTransitionSignalForm();
                }
            }, 200);
            
            goToStep(pendingDraft.currentStep, true);
            pendingDraft = null;
        }
        
        // 새로 시작 경고 표시
        function showRestartWarning() {
            document.getElementById('restart-warning-modal').classList.remove('hidden');
        }
        
        // 새로 시작 경고 숨기기
        function hideRestartWarning() {
            document.getElementById('restart-warning-modal').classList.add('hidden');
        }
        
        // 서버에 자동 저장 (백그라운드, UI 업데이트 없음)
        async function saveDraftToServer() {
            try {
                // 세션 ID 확보
                if (!currentSessionId) {
                    currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                
                // 최신 답변 수집
                const currentUniversalAnswers = typeof collectUniversalAnswers === 'function' 
                    ? collectUniversalAnswers() 
                    : (universalAnswers || {});
                const currentTransitionAnswers = transitionSignalAnswers || {};
                
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: 'major',
                    current_step: window.currentStep || currentStep || 1,
                    profile_sub_step: profileSubStep || 1,  // 프로필 서브스텝
                    current_round: window.currentRound || 0,  // 심층 질문 라운드
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 1,
                        currentRound: window.currentRound || 0
                    },
                    mini_module_result: window.miniModuleResult || null,
                    mini_module_selections: typeof miniModuleSelections !== 'undefined' ? miniModuleSelections : null,
                    step2_answers: currentUniversalAnswers,
                    step3_answers: currentTransitionAnswers,
                    step4_answers: {}
                };
                
                console.log('[AutoServerSave] Saving draft to server...');
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    console.log('[AutoServerSave] Draft saved to server');
                }
            } catch (error) {
                console.warn('[AutoServerSave] Failed:', error);
            }
        }
        
        // 결과 도달 시 서버에 완료 상태 저장 (major)
        async function saveDraftAsCompletedMajor() {
            if (!currentSessionId) return;
            
            try {
                const draftData = {
                    session_id: currentSessionId,
                    analysis_type: 'major',
                    current_step: 5,  // major는 step 5가 결과
                    career_state: careerState || {},
                    step1_answers: { 
                        stage: selectedStage,
                        careerState: careerState || {},
                        profileSubStep: profileSubStep || 2,
                        completed: true
                    },
                    mini_module_result: window.miniModuleResult || null
                };
                
                const response = await fetch('/api/ai-analyzer/draft/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    console.log('[SaveCompleted] Draft marked as completed on server (major)');
                    localStorage.removeItem('analyzer_draft_major');
                    localStorage.removeItem('analyzer_draft_major_timestamp');
                }
            } catch (error) {
                console.warn('[SaveCompleted] Failed:', error);
            }
        }
        
        // 새로 시작 확정
        async function confirmRestart() {
            console.log('[confirmRestart] Starting fresh (major)...');
            
            // 1. 로컬 스토리지 삭제
            localStorage.removeItem('analyzer_draft_major');
            localStorage.removeItem('analyzer_draft_major_timestamp');
            
            // 2. 서버의 모든 draft 삭제 (다른 세션 포함)
            try {
                const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('[confirmRestart] All drafts deleted:', result.deleted_count);
                } else {
                    console.warn('[confirmRestart] Delete-all failed:', response.status);
                }
            } catch (e) {
                console.warn('[confirmRestart] Delete failed:', e);
            }
            
            // 3. 모달 닫기
            document.getElementById('restart-warning-modal').classList.add('hidden');
            document.getElementById('continue-modal').classList.add('hidden');
            
            // 4. 모든 상태 초기화
            pendingDraft = null;
            pendingServerDraft = null;
            currentSessionId = '';  // 세션 ID 초기화
            careerState = { role_identity: null, career_stage_years: null, transition_status: null, skill_level: null, constraints: {} };
            universalAnswers = {};
            transitionSignalAnswers = {};
            window.roundAnswers = {};
            selectedStage = '';
            
            // 5. Step 1부터 시작
            goToStep(1);
        }
        
        // Step 1 UI 복원
        function updateStep1Selection() {
            // 5축 좌표 UI 복원 (간단 버전)
            console.log('[Restore] Restoring careerState:', careerState);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            renderCareerStateForm();
            
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('session_id');
            
            if (urlSessionId) {
                const serverDraft = await loadDraftFromServer(urlSessionId);
                if (serverDraft) {
                    currentSessionId = serverDraft.session_id;
                    if (serverDraft.step1_answers?.careerState || serverDraft.career_state) {
                        Object.assign(careerState, serverDraft.step1_answers?.careerState || serverDraft.career_state);
                    }
                    setTimeout(() => updateStep1Selection(), 200);
                    goToStep(serverDraft.current_step, true);
                    return;
                }
            }
            
            const restoredStep = await autoRestoreDraft();
            if (restoredStep === 'modal') {
                goToStep(1);
            } else {
                goToStep(1);
            }
            
            // 입력 변경 감지 - 저장 버튼 리셋 (저장 버튼 자체 제외)
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('[id$="-save-btn"]') || target.closest('#analyze-btn')) return;
                if (target.closest('.student-option, .role-card, .career-stage-btn, .goal-chip, .skill-btn, .constraint-option, .trans-chip, .trans-radio, .radio-option, .trans-checkbox')) {
                    resetSaveButtons();
                }
            });
            document.addEventListener('input', (e) => {
                if (e.target.matches('input, textarea, select')) {
                    resetSaveButtons();
                }
            });
        });
        
        async function loadDraftFromServer(sessionId) {
            try {
                const response = await fetch('/api/ai-analyzer/draft/load?session_id=' + sessionId, {
                    method: 'GET', credentials: 'same-origin'
                });
                const data = await response.json();
                return response.ok && data.found ? data.draft : null;
            } catch (e) {
                return null;
            }
        }
    </script>
  `
  
  return c.html(renderLayoutWithContext(c, content, 'AI 전공 추천 - Careerwiki'))
})

// Community Guidelines Help Page
app.get('/help/community-guidelines', (c) => {
  const policy = resolveCommentPolicy()
  const governanceItems = buildCommentGovernanceItems(policy)
  const overviewList = governanceItems
    .map((item) => `<li class="flex gap-2 text-sm text-wiki-muted leading-relaxed"><i class="fas fa-check-circle text-wiki-secondary mt-0.5" aria-hidden="true"></i><span>${escapeHtml(item)}</span></li>`)
    .join('')
  const bestDetails = [
    `좋아요 ${policy.bestLikeThreshold}개 이상이면 BEST로 승격됩니다.`,
    `BEST 영역은 최대 ${policy.bestLimit}건으로 유지되며 새로운 BEST가 등록되면 매일 갱신됩니다.`,
    'BEST 댓글은 목록 상단에 고정되어 누구나 빠르게 확인할 수 있습니다.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')
  const reportDetails = [
    `신고 ${policy.reportBlindThreshold}회 이상 시 댓글이 자동으로 블라인드 처리됩니다.`,
    policy.moderatorIpBlockEnabled
      ? '모더레이터는 신고가 누적된 IP를 차단하여 악성 활동을 선제적으로 막을 수 있습니다.'
      : null,
    `모더레이터 권한 계층: ${policy.moderatorRoles.join(' > ')}`
  ]
    .filter(Boolean)
    .map((item) => `<li>${escapeHtml(String(item))}</li>`)
    .join('')
  const voteDetails = [
    '공감/비공감은 로그인 없이 가능합니다. 신고는 로그인 후 이용해 주세요.',
    '여러 댓글에 공감/비공감을 표시하는 것은 제한이 없습니다.',
    '단, 한 댓글에는 공감 또는 비공감 중 하나만 선택할 수 있습니다.',
    '자신이 작성한 댓글에는 공감/비공감을 할 수 없습니다.',
    '비공감을 남발하거나 집단적으로 특정 댓글을 공격하면 제재될 수 있습니다.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')

  const commentRules = [
    '댓글은 최대 500자까지 작성할 수 있습니다.',
    '답글은 최대 3단계까지 달 수 있습니다.',
    '익명 댓글 작성 시 4자리 숫자 비밀번호를 설정해야 하며, 수정/삭제 시 필요합니다.',
    '익명 사용자는 하루 최대 5개의 댓글을 작성할 수 있습니다.',
    '로그인 사용자는 댓글 작성 횟수 제한이 없으며, 익명으로도 작성 가능합니다.',
    '욕설, 비방, 광고성 댓글은 자동 필터링되거나 제재 대상이 됩니다.'
  ]
    .map((item) => `<li>${escapeHtml(item)}</li>`)
    .join('')

  const canonicalUrl = buildCanonicalUrl(c.req.url, '/help/community-guidelines')
  const content = `
    <div class="max-w-[1400px] mx-auto px-4 pt-4 pb-10 sm:pt-12">
      <section class="space-y-10">
      <header class="space-y-3">
        <p class="text-xs uppercase tracking-widest text-wiki-secondary">CareerWiki Community</p>
        <h1 class="text-3xl font-bold text-white">커뮤니티 이용 정책</h1>
        <p class="text-sm text-wiki-muted">CareerWiki 댓글 커뮤니티의 기본 운영 원칙과 BEST/신고/공감 정책을 한눈에 확인하세요.</p>
      </header>
      <section class="grid gap-6 md:grid-cols-2">
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">기본 운영 원칙</h2>
          <ul class="space-y-3">${overviewList}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">댓글 작성 규칙</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${commentRules}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">BEST 댓글 정책</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${bestDetails}</ul>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4">
          <h2 class="text-lg font-semibold text-wiki-text">신고 &amp; 모더레이션</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${reportDetails}</ul>
          <p class="text-xs text-wiki-muted/80">블라인드 처리 이후 모더레이터 검토에서 복구 또는 제재 여부가 확정됩니다.</p>
        </article>
        <article class="glass-card p-6 rounded-xl space-y-4 md:col-span-2">
          <h2 class="text-lg font-semibold text-wiki-text">공감/비공감 정책</h2>
          <ul class="space-y-2 text-sm text-wiki-muted">${voteDetails}</ul>
        </article>
      </section>
      <section class="glass-card p-6 rounded-xl space-y-4">
        <h2 class="text-lg font-semibold text-wiki-text">상호작용 흐름 요약</h2>
        <ol class="space-y-2 text-sm text-wiki-muted list-decimal pl-5">
          <li>로그인 없이 댓글을 작성할 수 있습니다. 익명 작성 시 4자리 숫자 비밀번호가 필요하며, 하루 최대 5개까지 작성 가능합니다.</li>
          <li>로그인 사용자는 댓글 작성 횟수 제한 없이 자유롭게 작성할 수 있으며, 원하면 익명으로도 작성할 수 있습니다.</li>
          <li>답글은 최대 3단계까지 달 수 있으며, 댓글 한 건당 최대 500자까지 작성 가능합니다.</li>
          <li>좋아요 ${policy.bestLikeThreshold}개 이상을 받은 댓글은 BEST로 승격되어 목록 상단에 고정됩니다.</li>
          <li>신고 ${policy.reportBlindThreshold}회 이상 누적 시 자동으로 블라인드 처리되며, 모더레이터가 최종 검토합니다.</li>
        </ol>
        <p class="text-xs text-wiki-muted">정책은 서비스 개선을 위해 주기적으로 업데이트되며, 변경 사항은 이 페이지에 먼저 반영됩니다.</p>
      </section>
      <footer class="text-xs text-wiki-muted">
        <p>정책 관련 문의는 <a href="mailto:contact@careerwiki.org" class="text-wiki-primary hover:text-wiki-secondary">contact@careerwiki.org</a>로 연락해 주세요.</p>
      </footer>
      </section>
    </div>
  `

  return c.html(
    renderLayoutWithContext(c,
      content,
      '커뮤니티 이용 정책 - Careerwiki',
      'CareerWiki 댓글 커뮤니티 운영 원칙과 BEST/신고/공감 정책 안내',
      false,
      { canonical: canonicalUrl, ogUrl: canonicalUrl }
    )
  )
})

// Job Template Design Page
app.get('/job-template-design', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // 변호사 데이터 가져오기
    const jobRow = await db.prepare(`
      SELECT id, name FROM jobs WHERE name = '변호사' LIMIT 1
    `).first<{ id: string; name: string }>()

    if (!jobRow) {
      c.status(404)
      return c.text('변호사 데이터를 찾을 수 없습니다. ETL 시딩을 먼저 실행해주세요.')
    }

    // job_sources 가져오기
    // job_id로 먼저 시도
    let sources = await db.prepare(`
      SELECT * FROM job_sources WHERE job_id = ?
    `).bind(jobRow.id).all<JobSourceRow>()
    
    // job_id가 null인 경우 이름으로 직접 매칭 (더 정확하게)
    if (!sources.results || sources.results.length === 0) {
      console.log('job_id로 찾기 실패, 이름으로 매칭 시도:', jobRow.name)
      
      // JSON_EXTRACT로 직접 매칭 (SQLite 지원)
      // normalized_payload와 raw_payload 모두 확인
      try {
        sources = await db.prepare(`
          SELECT * FROM job_sources 
          WHERE JSON_EXTRACT(normalized_payload, '$.name') = ?
             OR JSON_EXTRACT(raw_payload, '$.dJobNm') = ?
             OR JSON_EXTRACT(raw_payload, '$.jobNm') = ?
             OR JSON_EXTRACT(raw_payload, '$.duty.job_nm') = ?
        `).bind(jobRow.name, jobRow.name, jobRow.name, jobRow.name).all<JobSourceRow>()
      } catch (e) {
        console.error('JSON_EXTRACT 실패, 수동 필터링:', e)
        // JSON_EXTRACT 안되면 전체 검색
        const allSources = await db.prepare(`
          SELECT * FROM job_sources WHERE normalized_payload LIKE ? OR raw_payload LIKE ?
        `).bind(`%"name":"${jobRow.name}"%`, `%"${jobRow.name}"%`).all<JobSourceRow>()
        
        const matchedSources = allSources.results?.filter(source => {
          try {
            const normalized = JSON.parse(source.normalized_payload || '{}')
            const raw = JSON.parse(source.raw_payload || '{}')
            return normalized.name === jobRow.name || 
                   raw.dJobNm === jobRow.name || 
                   raw.jobNm === jobRow.name ||
                   raw.duty?.job_nm === jobRow.name
          } catch {
            return false
          }
        }) || []
        
        sources = { results: matchedSources, success: true, meta: allSources.meta }
      }
    }
    
    console.log(`찾은 소스: ${sources.results?.length || 0}개`)

    if (!sources.results || sources.results.length === 0) {
      c.status(404)
      return c.text('변호사의 소스 데이터를 찾을 수 없습니다.')
    }

    const html = renderJobTemplateDesignPage(jobRow.name, sources.results)
    return c.html(html)
  } catch (error) {
    console.error('Template design page error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// Job Merge Designer Page (드래그 앤 드롭 병합 규칙 설계)
app.get('/job-template-design2', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // 실제 DB에 있는 직업들의 소스 데이터 가져오기 (다양한 예시 확보)
    // 각 소스 시스템에서 균등하게 샘플링
    // SQLite에서는 UNION ALL 안의 각 SELECT에 ORDER BY를 사용할 수 없으므로 서브쿼리로 감싸야 함
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM (
        -- 커리어넷 샘플 (20개)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'CAREERNET' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- 고용24 직업정보 샘플 (20개)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'WORK24_JOB' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- 고용24 직업사전 샘플 (20개)
        SELECT * FROM (
          SELECT * FROM job_sources 
          WHERE source_system = 'WORK24_DJOB' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
      ) js
      LEFT JOIN jobs j ON js.job_id = j.id
    `).all<JobSourceRow & { job_name: string }>()

    console.log(`Found ${allSources.results?.length || 0} source records`)

    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text('샘플 직업 데이터를 찾을 수 없습니다. ETL 시딩을 먼저 실행해주세요.')
    }

    // 소스별로 데이터 통합
    const careernetSamples: any[] = []
    const work24JobSamples: any[] = []
    const work24DJobSamples: any[] = []

    allSources.results.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: row.job_name })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: row.job_name })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: row.job_name })
        }
      } catch (e) {
        console.error(`Failed to parse ${row.source_system} for ${row.job_name}:`, e)
      }
    })

    const { renderJobMergeDesigner } = await import('./templates/jobMergeDesigner')
    const html = renderJobMergeDesigner(careernetSamples, work24JobSamples, work24DJobSamples)
    return c.html(html)
  } catch (error) {
    console.error('Job merge designer error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// 직업별 디자이너 페이지: /job-template-design2/:slug
app.get('/job-template-design2/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slug로 직업 찾기
    const job = await db.prepare(`
      SELECT id, name, slug FROM jobs WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string }>()
    
    if (!job) {
      c.status(404)
      return c.text(`직업 "${slug}"을 찾을 수 없습니다.`)
    }

    // 해당 직업의 모든 소스 데이터 가져오기
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM job_sources js
      LEFT JOIN jobs j ON js.job_id = j.id
      WHERE (
        js.job_id = ?
        OR JSON_EXTRACT(js.normalized_payload, '$.name') = ?
        OR (js.source_system = 'WORK24_DJOB' AND JSON_EXTRACT(js.raw_payload, '$.dJobNm') = ?)
        OR (js.source_system = 'WORK24_JOB' AND JSON_EXTRACT(js.raw_payload, '$.jobNm') = ?)
      )
    `).bind(job.id, job.name, job.name, job.name).all<JobSourceRow & { job_name: string }>()

    console.log(`Found ${allSources.results?.length || 0} source records for job: ${job.name}`)

    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`직업 "${job.name}"의 소스 데이터를 찾을 수 없습니다.`)
    }

    // 다른 직업들의 예시 데이터 가져오기 (현재 직업에 없는 필드용)
    // 각 소스별로 균등하게 샘플링하여 모든 필드에 예시 데이터가 있도록 함
    const otherSamples = await db.prepare(`
      SELECT source_system, raw_payload, job_name FROM (
        -- CAREERNET 샘플 15개
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.normalized_payload, '$.name')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'CAREERNET'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, raw_payload, job_name FROM (
        -- WORK24_JOB 샘플 15개
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.raw_payload, '$.jobNm')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'WORK24_JOB'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, raw_payload, job_name FROM (
        -- WORK24_DJOB 샘플 20개 (필드가 많아서 더 많이)
        SELECT js.source_system, js.raw_payload,
               COALESCE(j.name, JSON_EXTRACT(js.raw_payload, '$.dJobNm')) as job_name
        FROM job_sources js
        LEFT JOIN jobs j ON js.job_id = j.id
        WHERE js.source_system = 'WORK24_DJOB'
          AND js.job_id != ?
          AND js.raw_payload IS NOT NULL 
          AND js.raw_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 20
      )
    `).bind(job.id, job.id, job.id).all<{ source_system: string; raw_payload: string; job_name: string }>()

    // 소스별로 데이터 통합
    const careernetSamples: any[] = []
    const work24JobSamples: any[] = []
    const work24DJobSamples: any[] = []

    // 현재 직업 데이터 추가 (우선 표시)
    allSources.results.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: row.job_name, _isCurrentJob: true })
        }
      } catch (e) {
        console.error(`Failed to parse ${row.source_system} for ${row.job_name}:`, e)
      }
    })

    // 다른 직업 예시 데이터 추가 (예시용)
    otherSamples.results?.forEach(row => {
      try {
        const rawData = JSON.parse(row.raw_payload || '{}')
        if (!rawData || Object.keys(rawData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...rawData, _jobName: `[예시] ${row.job_name}`, _isCurrentJob: false })
        } else if (row.source_system === 'WORK24_JOB') {
          work24JobSamples.push({ ...rawData, _jobName: `[예시] ${row.job_name}`, _isCurrentJob: false })
        } else if (row.source_system === 'WORK24_DJOB') {
          work24DJobSamples.push({ ...rawData, _jobName: `[예시] ${row.job_name}`, _isCurrentJob: false })
        }
      } catch (e) {
        console.error(`Failed to parse sample ${row.source_system}:`, e)
      }
    })

    const { renderJobMergeDesigner } = await import('./templates/jobMergeDesigner')
    const html = renderJobMergeDesigner(
      careernetSamples,
      work24JobSamples,
      work24DJobSamples,
      job.name,
      job.slug
    )
    return c.html(html)
  } catch (error) {
    console.error('Job merge designer error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// Major Merge Designer Page (전공 데이터 필드 병합 규칙 설계)
app.get('/major-template-design', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    // 실제 DB에 있는 전공들의 소스 데이터 가져오기
    const allSources = await db.prepare(`
      SELECT ms.*, 
             COALESCE(
               m.name,
               JSON_EXTRACT(ms.normalized_payload, '$.name'),
               JSON_EXTRACT(ms.raw_payload, '$.major'),
               JSON_EXTRACT(ms.raw_payload, '$.majorName')
             ) as major_name
      FROM (
        -- 커리어넷 샘플 (20개)
        SELECT * FROM (
          SELECT * FROM major_sources 
          WHERE source_system = 'CAREERNET' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
        
        UNION ALL
        
        -- 고용24 학과정보 샘플 (20개)
        SELECT * FROM (
          SELECT * FROM major_sources 
          WHERE source_system = 'WORK24_MAJOR' 
          ORDER BY RANDOM() 
          LIMIT 20
        )
      ) ms
      LEFT JOIN majors m ON ms.major_id = m.id
    `).all<MajorSourceRow & { major_name: string }>()

    console.log(`Found ${allSources.results?.length || 0} major source records`)

    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text('샘플 전공 데이터를 찾을 수 없습니다. ETL 시딩을 먼저 실행해주세요.')
    }

    // 소스별로 데이터 통합
    const careernetSamples: any[] = []
    const work24MajorSamples: any[] = []

    // normalized_payload 사용 (병합 로직과 동일한 필드명 표시)
    allSources.results.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: row.major_name })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: row.major_name })
        }
      } catch (e) {
        console.error(`Failed to parse ${row.source_system} for ${row.major_name}:`, e)
      }
    })

    const { renderMajorMergeDesigner } = await import('./templates/majorMergeDesigner')
    const html = renderMajorMergeDesigner(careernetSamples, work24MajorSamples)
    return c.html(html)
  } catch (error) {
    console.error('Major merge designer error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// 전공별 디자이너 페이지: /major-template-design/:slug
app.get('/major-template-design/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slug로 전공 찾기
    const major = await db.prepare(`
      SELECT id, name, slug FROM majors WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string }>()
    
    if (!major) {
      c.status(404)
      return c.text(`전공 "${slug}"을 찾을 수 없습니다.`)
    }

    // 해당 전공의 모든 소스 데이터 가져오기
    const allSources = await db.prepare(`
      SELECT ms.*, 
             COALESCE(
               m.name,
               JSON_EXTRACT(ms.normalized_payload, '$.name'),
               JSON_EXTRACT(ms.raw_payload, '$.major'),
               JSON_EXTRACT(ms.raw_payload, '$.majorName')
             ) as major_name
      FROM major_sources ms
      LEFT JOIN majors m ON ms.major_id = m.id
      WHERE (
        ms.major_id = ?
        OR JSON_EXTRACT(ms.normalized_payload, '$.name') = ?
        OR JSON_EXTRACT(ms.raw_payload, '$.major') = ?
        OR JSON_EXTRACT(ms.raw_payload, '$.majorName') = ?
      )
    `).bind(major.id, major.name, major.name, major.name).all<MajorSourceRow & { major_name: string }>()

    console.log(`Found ${allSources.results?.length || 0} source records for major: ${major.name}`)

    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`전공 "${major.name}"의 소스 데이터를 찾을 수 없습니다.`)
    }

    // 다른 전공들의 예시 데이터 가져오기 (normalized_payload 사용)
    const otherSamples = await db.prepare(`
      SELECT source_system, normalized_payload, major_name FROM (
        SELECT ms.source_system, ms.normalized_payload,
               COALESCE(m.name, JSON_EXTRACT(ms.normalized_payload, '$.name')) as major_name
        FROM major_sources ms
        LEFT JOIN majors m ON ms.major_id = m.id
        WHERE ms.source_system = 'CAREERNET'
          AND ms.major_id != ?
          AND ms.normalized_payload IS NOT NULL 
          AND ms.normalized_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
      UNION ALL
      SELECT source_system, normalized_payload, major_name FROM (
        SELECT ms.source_system, ms.normalized_payload,
               COALESCE(m.name, JSON_EXTRACT(ms.normalized_payload, '$.name')) as major_name
        FROM major_sources ms
        LEFT JOIN majors m ON ms.major_id = m.id
        WHERE ms.source_system = 'WORK24_MAJOR'
          AND ms.major_id != ?
          AND ms.normalized_payload IS NOT NULL 
          AND ms.normalized_payload != '{}'
        ORDER BY RANDOM()
        LIMIT 15
      )
    `).bind(major.id, major.id).all<{ source_system: string; normalized_payload: string; major_name: string }>()

    // 소스별로 데이터 통합
    const careernetSamples: any[] = []
    const work24MajorSamples: any[] = []

    // 현재 전공 데이터 추가 (우선 표시) - normalized_payload 사용
    allSources.results.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: row.major_name, _isCurrentMajor: true })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: row.major_name, _isCurrentMajor: true })
        }
      } catch (e) {
        console.error(`Failed to parse ${row.source_system} for ${row.major_name}:`, e)
      }
    })

    // 다른 전공의 예시 데이터 추가 (필드 예시용) - normalized_payload 사용
    otherSamples.results?.forEach(row => {
      try {
        const normalizedData = JSON.parse(row.normalized_payload || '{}')
        if (!normalizedData || Object.keys(normalizedData).length === 0) return

        const displayName = `[예시] ${row.major_name}`
        if (row.source_system === 'CAREERNET') {
          careernetSamples.push({ ...normalizedData, _majorName: displayName, _isCurrentMajor: false })
        } else if (row.source_system === 'WORK24_MAJOR') {
          work24MajorSamples.push({ ...normalizedData, _majorName: displayName, _isCurrentMajor: false })
        }
      } catch (e) {
        // Skip invalid JSON
      }
    })

    const { renderMajorMergeDesigner } = await import('./templates/majorMergeDesigner')
    const html = renderMajorMergeDesigner(
      careernetSamples, 
      work24MajorSamples,
      major.name,
      major.slug
    )
    return c.html(html)
  } catch (error) {
    console.error('Major merge designer error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// ETL 병합 로직 점검 페이지: /job-template-design3/:slug
app.get('/job-template-design3/:slug', async (c) => {
  try {
    const db = c.env.DB as D1Database
    if (!db) {
      throw new Error('DB not available')
    }

    const slug = decodeURIComponent(c.req.param('slug'))
    
    // slug로 직업 찾기
    const job = await db.prepare(`
      SELECT id, name, slug, merged_profile_json FROM jobs WHERE slug = ? LIMIT 1
    `).bind(slug).first<{ id: string; name: string; slug: string; merged_profile_json: string | null }>()
    
    if (!job) {
      c.status(404)
      return c.text(`직업 "${slug}"을 찾을 수 없습니다.`)
    }

    // 해당 직업의 모든 소스 데이터 가져오기
    const allSources = await db.prepare(`
      SELECT js.*, 
             COALESCE(
               j.name,
               JSON_EXTRACT(js.normalized_payload, '$.name'),
               JSON_EXTRACT(js.raw_payload, '$.dJobNm'),
               JSON_EXTRACT(js.raw_payload, '$.jobNm')
             ) as job_name
      FROM job_sources js
      LEFT JOIN jobs j ON js.job_id = j.id
      WHERE (
        js.job_id = ?
        OR JSON_EXTRACT(js.normalized_payload, '$.name') = ?
        OR (js.source_system = 'WORK24_DJOB' AND JSON_EXTRACT(js.raw_payload, '$.dJobNm') = ?)
        OR (js.source_system = 'WORK24_JOB' AND JSON_EXTRACT(js.raw_payload, '$.jobNm') = ?)
      )
    `).bind(job.id, job.name, job.name, job.name).all<JobSourceRow & { job_name: string }>()

    console.log(`Found ${allSources.results?.length || 0} source records for job: ${job.name}`)

    if (!allSources.results || allSources.results.length === 0) {
      c.status(404)
      return c.text(`직업 "${job.name}"의 소스 데이터를 찾을 수 없습니다.`)
    }

    // Merged profile 파싱
    let mergedProfile: UnifiedJobDetail | null = null
    if (job.merged_profile_json) {
      try {
        mergedProfile = JSON.parse(job.merged_profile_json) as UnifiedJobDetail
      } catch (e) {
        console.error('Failed to parse merged_profile_json:', e)
      }
    }

    const html = renderJobETLInspectionPage(
      job.name,
      job.id,
      allSources.results,
      mergedProfile
    )
    return c.html(html)
  } catch (error) {
    console.error('ETL inspection page error:', error)
    c.status(500)
    return c.text('오류가 발생했습니다: ' + (error instanceof Error ? error.message : String(error)))
  }
})

// Job Wiki List Page
app.get('/job', async (c) => {
  const keywordRaw = c.req.query('q') || ''
  const keyword = keywordRaw.trim()
  const includeSources = parseSourcesQuery(c.req.query('sources'))
  const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
  const perPage = 20 // 성능 최적화: 50 → 20 (이미지 로딩 시간 단축)
  
  // 모바일 감지
  const userAgent = c.req.header('user-agent') || ''
  const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
  const sort = c.req.query('sort') || 'relevance' // 정렬 옵션

  const searchParams = new URLSearchParams()
  if (keyword) searchParams.set('q', keyword)
  if (includeSources?.length) searchParams.set('sources', includeSources.join(','))
  if (page > 1) searchParams.set('page', String(page))
  if (sort && sort !== 'relevance') searchParams.set('sort', sort)

  const canonicalPath = `/job${searchParams.toString() ? `?${searchParams.toString()}` : ''}`
  const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)

  const formatSummaryText = (value?: string | null): string => {
    const fallback = '고용24와 커리어넷 데이터를 통합하여 제공하는 직업 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
    if (!value) return fallback
    const normalized = value.replace(/\s+/g, ' ').trim()
    if (!normalized) return fallback
    return normalized.length > 220 ? `${normalized.slice(0, 217)}…` : normalized
  }

  // 로그인 상태 확인
  const user = getOptionalUser(c)
  const isLoggedIn = !!user

  try {
    // Direct D1 query - no KV cache
    const result = await searchUnifiedJobs(
      {
        keyword,
        page,
        perPage,
        includeSources,
        sort
      },
      c.env
    )

    const items = result.items
    const totalCount = typeof result.meta?.total === 'number' ? result.meta.total : items.length

    try {
      console.log('[job-list]', {
        keyword: keyword || '(all)',
        page,
        perPage,
        count: items.length,
        total: totalCount
      })
    } catch (_) {}

    // 공통 함수 renderJobCard 사용
    const jobCards = items.length
      ? items.map((entry) => renderJobCard(entry)).join('')
      : keyword
        ? `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
            <i class="fas fa-search text-4xl text-wiki-muted mb-4"></i>
            <p class="text-lg text-wiki-muted">"${escapeHtml(keyword)}"에 해당하는 직업이 없습니다.</p>
            <p class="text-sm text-wiki-muted mt-2">다른 검색어를 시도해보세요.</p>
          </div>`
        : `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
            <i class="fas fa-briefcase text-4xl text-wiki-muted mb-4"></i>
            <p class="text-lg text-wiki-muted">등록된 직업이 없습니다.</p>
          </div>`

    // 🆕 캐시 알림 제거 (사용자에게 보이지 않도록)
    const cacheNotice = '' // renderCacheNotice(cacheState, { staleSeconds: LIST_CACHE_STALE_SECONDS, maxAgeSeconds: LIST_CACHE_MAX_AGE_SECONDS })

    // 🆕 데이터 소스 요약 제거 (사용자에게 혼란을 줄 수 있음)
    const sourceSummaryHtml = '' // renderSourceStatusSummary(result.meta?.sources, { id: 'job-source-summary' })
    const filterSummary = keyword ? `"${escapeHtml(keyword)}" 키워드` : '전체 직업'
    const headingLabel = keyword ? `“${escapeHtml(keyword)}” 관련 직업` : '직업위키'

    const jsonLdItems = items.map((entry, index) => {
      const slug = composeDetailSlug('job', entry.profile.name, entry.profile.id)
      return {
        '@type': 'ListItem',
        position: (page - 1) * perPage + index + 1,
        url: buildCanonicalUrl(c.req.url, `/job/${encodeURIComponent(slug)}`),
        name: entry.profile.name
      }
    })
    const jsonLd = jsonLdItems.length
      ? `<script type="application/ld+json">${JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'ItemList',
          name: keyword ? `${keyword} 관련 직업 목록` : 'Careerwiki 직업 목록',
          numberOfItems: jsonLdItems.length,
          itemListOrder: 'https://schema.org/ItemListOrderAscending',
          itemListElement: jsonLdItems
        }).replace(/</g, '\\u003C')}</script>`
      : ''

    // 모바일 메트릭 스크롤 스타일 (스크롤바 숨기기)
    const mobileScrollStyle = `<style>.mobile-metric-scroll::-webkit-scrollbar{display:none;}</style>`
    const extraHead = [jsonLd, mobileScrollStyle].filter(Boolean).join('\n')

    const content = `
      <div class="max-w-[1400px] mx-auto px-4 md:px-6">
        <!-- 히어로 섹션 with 그라데이션 블렌딩 -->
        <div class="relative text-center pt-12 pb-12 mb-6 space-y-7">
          <!-- 배경 글로우 + 하단 페이드 -->
          <div class="absolute inset-0 -z-10 overflow-hidden">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-gradient-to-b from-wiki-primary/8 via-wiki-primary/5 to-transparent rounded-full blur-[120px]"></div>
          </div>
          <!-- 하단 그라데이션 페이드 -->
          <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-wiki-bg to-transparent -z-10"></div>
          
          <h1 class="text-[42px] md:text-[48px] lg:text-6xl font-extrabold leading-tight mb-2">
            <span class="bg-gradient-to-r from-wiki-primary via-blue-400 to-wiki-secondary bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(59,130,246,0.3)]">
            ${headingLabel}
            </span>
          </h1>
          
          <p class="text-lg md:text-xl text-wiki-text/90 max-w-2xl mx-auto font-medium leading-relaxed">
            당신의 다음 커리어를 여기서 확인하세요
          </p>
          
          <div class="flex items-center justify-center gap-3 text-sm">
            <span class="px-3 py-1.5 rounded-lg bg-wiki-bg/60 text-wiki-muted">${filterSummary}</span>
            <span class="px-3 py-1.5 rounded-lg bg-gradient-to-r from-wiki-primary/20 to-blue-500/20 border border-wiki-primary/30 text-white font-semibold">
              <span id="job-total-count">${totalCount}</span>개
            </span>
          </div>
        </div>

        <form id="job-filter-form" data-hydration-target="job" method="get" class="mb-6">
          <div class="flex flex-row gap-2 sm:gap-3">
            <!-- 검색창 - 글래스모피즘 + 인셋 아이콘 -->
            <div class="flex-1 relative group min-w-0">
              <div class="absolute inset-0 bg-gradient-to-r from-wiki-primary/20 via-wiki-secondary/20 to-wiki-primary/20 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
              <div class="relative flex items-center bg-wiki-bg/40 backdrop-blur-xl border border-white/20 rounded-2xl overflow-hidden transition-all duration-300 group-focus-within:border-wiki-primary/50 group-focus-within:shadow-lg group-focus-within:shadow-wiki-primary/10">
                <span class="pl-3 sm:pl-4 pr-1 sm:pr-2 text-wiki-muted/60 group-focus-within:text-wiki-primary transition-colors duration-300">
                  <i class="fas fa-search text-sm"></i>
                </span>
                <input
                  id="job-keyword"
                  type="text"
                  name="q"
                  value="${escapeHtml(keyword)}"
                  placeholder="직업 검색..."
                  class="flex-1 px-1 sm:px-2 py-2 sm:py-3.5 bg-transparent border-none focus:outline-none text-base text-white placeholder:text-wiki-muted/50 min-w-0"
                  style="font-size: 16px;"
                />
                <button type="submit" class="m-1 sm:m-1.5 px-3 sm:px-5 py-2 sm:py-2.5 min-h-[40px] sm:min-h-[44px] bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-wiki-primary/25 active:scale-95 transition-all duration-200">
                  <i class="fas fa-search sm:hidden"></i>
                  <span class="hidden sm:inline">검색</span>
                </button>
              </div>
            </div>
            <!-- 정렬 + 새 직업 추가 버튼 -->
            <div class="flex items-center gap-2 shrink-0" id="job-hydration-toolbar">
              <div class="relative" data-dropdown="job-sort">
                <button type="button" id="job-sort-trigger" class="flex items-center justify-center gap-2 px-3 sm:pl-4 sm:pr-3 py-2 sm:py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl text-sm text-white/70 hover:bg-white/[0.06] hover:border-white/[0.1] focus:outline-none focus:border-wiki-primary/40 transition-all duration-200 cursor-pointer min-w-[44px] sm:min-w-[130px] min-h-[44px]">
                  <i class="fas fa-sliders-h sm:hidden"></i>
                  <span id="job-sort-label" class="hidden sm:inline">${sort === 'salary-desc' ? '연봉 높은 순' : sort === 'name-asc' ? '가나다 순' : '기본 순'}</span>
                  <i class="fas fa-chevron-down text-[10px] text-white/40 ml-auto transition-transform duration-200 hidden sm:inline" id="job-sort-chevron"></i>
                </button>
                <div id="job-sort-menu" class="absolute right-0 top-full mt-2 w-44 py-1.5 bg-[#1c2333]/95 backdrop-blur-xl border border-white/[0.08] rounded-xl shadow-2xl shadow-black/40 opacity-0 invisible translate-y-1 transition-all duration-200 z-50">
                  <div class="px-2 py-1.5 text-[10px] font-medium text-white/30 uppercase tracking-wider">정렬 기준</div>
                  <button type="button" data-sort="relevance" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'relevance' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-primary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>기본 순</span>
                  </button>
                  <button type="button" data-sort="salary-desc" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'salary-desc' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-primary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>연봉 높은 순</span>
                  </button>
                  <button type="button" data-sort="name-asc" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'name-asc' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-primary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>가나다 순</span>
                  </button>
                </div>
                <select id="job-sort-select" class="sr-only">
                  <option value="relevance">기본 순</option>
                  <option value="salary-desc">연봉 높은 순</option>
                  <option value="name-asc">가나다 순</option>
                </select>
              </div>
              ${isLoggedIn ? `
              <!-- 새 직업 추가 버튼 (로그인 시에만 표시) -->
              <button
                type="button"
                id="create-job-btn"
                data-create-entity="job"
                class="flex items-center gap-1.5 px-4 py-3 bg-gradient-to-r from-wiki-primary to-blue-500 text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-wiki-primary/25 active:scale-95 transition-all duration-200 whitespace-nowrap"
              >
                <i class="fas fa-plus text-xs"></i>
                추가
              </button>
              ` : ''}
            </div>
          </div>
        </form>

        ${cacheNotice}

        <section id="job-results" class="space-y-4" aria-live="polite">
          ${jobCards}
        </section>

        ${(() => {
          const totalPages = Math.ceil(totalCount / perPage)
          if (totalPages <= 1) return ''
          
          const buildPageUrl = (pageNum: number) => {
            const params = new URLSearchParams()
            if (keyword) params.set('q', keyword)
            if (includeSources?.length) params.set('sources', includeSources.join(','))
            if (pageNum > 1) params.set('page', String(pageNum))
            return `/job${params.toString() ? `?${params.toString()}` : ''}`
          }
          
          // 화면 크기에 따라 버튼 수 조정 (모바일: 3개, 데스크톱: 7개)
          const maxPageButtons = isMobile ? 3 : 7
          let startPage = Math.max(1, page - Math.floor(maxPageButtons / 2))
          let endPage = Math.min(totalPages, startPage + maxPageButtons - 1)
          
          if (endPage - startPage < maxPageButtons - 1) {
            startPage = Math.max(1, endPage - maxPageButtons + 1)
          }
          
          const pageButtons = []
          
          // 이전 페이지 버튼
          if (page > 1) {
            pageButtons.push(`
              <a href="${buildPageUrl(page - 1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                <i class="fas fa-chevron-left"></i>
              </a>
            `)
          }
          
          // 첫 페이지
          if (startPage > 1) {
            pageButtons.push(`
              <a href="${buildPageUrl(1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                1
              </a>
            `)
            if (startPage > 2) {
              pageButtons.push(`<span class="px-1 text-wiki-muted">...</span>`)
            }
          }
          
          // 페이지 번호들
          for (let i = startPage; i <= endPage; i++) {
            const isActive = i === page
            pageButtons.push(`
              <a href="${buildPageUrl(i)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center rounded-lg transition ${
                   isActive
                     ? 'bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold'
                     : 'bg-wiki-bg border border-wiki-border hover:border-wiki-primary'
                 }">
                ${i}
              </a>
            `)
          }
          
          // 마지막 페이지
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              pageButtons.push(`<span class="px-1 text-wiki-muted">...</span>`)
            }
            pageButtons.push(`
              <a href="${buildPageUrl(totalPages)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                ${totalPages}
              </a>
            `)
          }
          
          // 다음 페이지 버튼
          if (page < totalPages) {
            pageButtons.push(`
              <a href="${buildPageUrl(page + 1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                <i class="fas fa-chevron-right"></i>
              </a>
            `)
          }
          
          return `
            <nav class="mt-8 flex justify-center items-center gap-2 flex-wrap" aria-label="페이지네이션">
              ${pageButtons.join('')}
            </nav>
            <p class="text-center text-xs text-wiki-muted mt-4">
              ${page}페이지 / 총 ${totalPages}페이지 (${totalCount}개 직업)
            </p>
          `
        })()}

        ${sourceSummaryHtml}
      </div>
    `

    const hydrationScript = `<script id="job-hydration-data" type="application/json">${serializeForScript({
      items,
      meta: {
        total: totalCount,
        page,
        perPage,
        keyword,
        sort,
        includeSources: includeSources ?? null,
        sources: result.meta?.sources ?? null
      }
    })}</script>`
    
    // 정렬 드롭다운 이벤트 핸들러 스크립트
    const sortScript = `<script>
(function() {
  const currentSort = '${sort}';
  const sortLabels = { 'relevance': '기본 순', 'salary-desc': '연봉 높은 순', 'name-asc': '가나다 순' };
  
  // 초기 라벨 설정
  const labelEl = document.getElementById('job-sort-label');
  if (labelEl) labelEl.textContent = sortLabels[currentSort] || '기본 순';
  
  // 커스텀 드롭다운 토글
  const trigger = document.getElementById('job-sort-trigger');
  const menu = document.getElementById('job-sort-menu');
  const chevron = document.getElementById('job-sort-chevron');
  
  if (trigger && menu) {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      const isOpen = !menu.classList.contains('invisible');
      if (isOpen) {
        menu.classList.add('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.remove('rotate-180');
      } else {
        menu.classList.remove('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.add('rotate-180');
      }
    });
    
    // 메뉴 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
      if (!trigger.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.remove('rotate-180');
      }
    });
  }
  
  // 정렬 옵션 클릭 이벤트
  document.querySelectorAll('.sort-option[data-sort]').forEach(function(btn) {
    const sortValue = btn.getAttribute('data-sort');
    if (sortValue === currentSort) btn.classList.add('active');
    
    btn.addEventListener('click', function() {
      const url = new URL(window.location.href);
      if (sortValue === 'relevance') {
        url.searchParams.delete('sort');
      } else {
        url.searchParams.set('sort', sortValue);
      }
      url.searchParams.delete('page'); // 정렬 변경 시 첫 페이지로
      window.location.href = url.toString();
    });
  });
  
  // select 요소 변경 이벤트 (모바일용)
  const selectEl = document.getElementById('job-sort-select');
  if (selectEl) {
    selectEl.value = currentSort;
    selectEl.addEventListener('change', function() {
      const url = new URL(window.location.href);
      if (this.value === 'relevance') {
        url.searchParams.delete('sort');
      } else {
        url.searchParams.set('sort', this.value);
      }
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  }
})();
</script>`
    
    const hydratedContent = `${content}${hydrationScript}${sortScript}`

    const pageTitle = keyword ? `${keyword} 직업 검색 결과 - Careerwiki` : '직업위키 - Careerwiki'
    const description = createMetaDescription(
      keyword ? `${keyword} 관련 직업 정보를 확인하세요.` : undefined,
      items[0]?.display?.summary,
      '직업 연봉과 전망, 필요 역량을 한눈에 확인하세요.'
    )

    return c.html(
      renderLayoutWithContext(c,
        hydratedContent,
        escapeHtml(pageTitle),
        escapeHtml(description),
        false,
        {
          canonical: canonicalUrl,
          ogUrl: canonicalUrl,
          extraHead
        }
      )
    )
  } catch (error) {
    // 에러 메시지 추출
    const errorMsg = error instanceof Error ? error.message : String(error)
    const errorStack = error instanceof Error ? error.stack : ''
    c.status(500)
    
    // 에러를 화면에 표시 (복사 가능)
    const errorHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>500 Error - /job</title>
        <style>
          body { background: #1a1a2e; color: #eee; font-family: monospace; padding: 40px; }
          .error-box { background: #16213e; border: 1px solid #e94560; border-radius: 8px; padding: 20px; max-width: 900px; }
          h1 { color: #e94560; margin-top: 0; }
          .error-msg { background: #0f0f23; padding: 15px; border-radius: 4px; word-break: break-all; cursor: pointer; }
          .error-msg:hover { background: #1a1a3e; }
          .stack { font-size: 12px; color: #888; white-space: pre-wrap; margin-top: 10px; }
          .copy-btn { background: #e94560; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 15px; }
          .copy-btn:hover { background: #ff6b6b; }
          .hint { color: #888; font-size: 12px; margin-top: 10px; }
        </style>
      </head>
      <body>
        <div class="error-box">
          <h1>🚨 /job 500 Error</h1>
          <p>에러 메시지 (클릭하여 복사):</p>
          <div class="error-msg" onclick="copyError()" id="errorMsg">${errorMsg.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <div class="stack">${(errorStack || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <button class="copy-btn" onclick="copyError()">📋 에러 복사</button>
          <p class="hint">클릭하면 클립보드에 복사됩니다. 이 메시지를 공유해주세요.</p>
        </div>
        <script>
          function copyError() {
            const text = ${JSON.stringify(errorMsg + '\\n\\n' + (errorStack || ''))};
            navigator.clipboard.writeText(text).then(() => {
              alert('에러가 클립보드에 복사되었습니다!');
            });
          }
        </script>
      </body>
      </html>
    `
    return c.html(errorHtml)
  }
})

// Major Wiki List Page
app.get('/major', async (c) => {
  const keywordRaw = c.req.query('q') || ''
  const keyword = keywordRaw.trim()
  const includeSources = parseSourcesQuery(c.req.query('sources'))
  const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
  const perPage = 20 // 성능 최적화: 50 → 20 (이미지 로딩 시간 단축)
  const sort = c.req.query('sort') || 'relevance' // 정렬 옵션
  
  // 모바일 감지
  const userAgent = c.req.header('user-agent') || ''
  const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)

  const searchParams = new URLSearchParams()
  if (keyword) searchParams.set('q', keyword)
  if (includeSources?.length) searchParams.set('sources', includeSources.join(','))
  if (page > 1) searchParams.set('page', String(page))
  if (sort && sort !== 'relevance') searchParams.set('sort', sort)
  const canonicalPath = `/major${searchParams.toString() ? `?${searchParams.toString()}` : ''}`
  const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)

  const formatSummaryText = (value?: string | null): string => {
    const fallback = '고용24와 커리어넷 데이터를 통합하여 제공하는 전공 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
    if (!value) return fallback
    const normalized = value.replace(/\s+/g, ' ').trim()
    if (!normalized) return fallback
    return normalized.length > 220 ? `${normalized.slice(0, 217)}…` : normalized
  }

  // 로그인 상태 확인
  const user = getOptionalUser(c)
  const isLoggedIn = !!user

  try {
    const forceRefresh = c.req.query('refresh') === '1'
    const { value: result, cacheState } = await withKvCache(
      c.env.KV,
      buildListCacheKey('major', { keyword, page, perPage, includeSources, sort }),
      async () =>
        searchUnifiedMajors(
          {
            keyword,
            page,
            perPage,
            includeSources,
            sort
          },
          c.env
        ),
      {
        staleSeconds: LIST_CACHE_STALE_SECONDS,
        maxAgeSeconds: LIST_CACHE_MAX_AGE_SECONDS,
        metadata: {
          type: 'major-list',
          keyword: keyword || null,
          page,
          perPage,
          includeSources: includeSources ?? []
        },
        forceRefresh
      }
    )

    const items = result.items
    const totalCount = typeof result.meta?.total === 'number' ? result.meta.total : items.length

    try {
      console.log('[major-list]', {
        keyword: keyword || '(all)',
        page,
        perPage,
        count: items.length,
        total: totalCount
      })
    } catch (_) {}

    const freshnessRecordPromise = recordListFreshness(c.env.KV, {
      type: 'major',
      params: {
        keyword,
        page,
        perPage,
        includeSources
      },
      trigger: 'runtime',
      cacheState,
      totalItems: items.length,
      reportedTotal: result.meta?.total,
      sources: result.meta?.sources
    })

    if (c.executionCtx && 'waitUntil' in c.executionCtx) {
      c.executionCtx.waitUntil(
        freshnessRecordPromise.catch((err) => console.error('[freshness][major]', err))
      )
    } else {
      freshnessRecordPromise.catch((err) => console.error('[freshness][major]', err))
    }

    // 공통 함수 renderMajorCard 사용
    const majorCards = items.length
      ? items.map((entry) => renderMajorCard(entry)).join('')
      : keyword
        ? `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
            <i class="fas fa-search text-4xl text-wiki-muted mb-4"></i>
            <p class="text-lg text-wiki-muted">"${escapeHtml(keyword)}"에 해당하는 전공이 없습니다.</p>
            <p class="text-sm text-wiki-muted mt-2">다른 검색어를 시도해보세요.</p>
          </div>`
        : `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
            <i class="fas fa-graduation-cap text-4xl text-wiki-muted mb-4"></i>
            <p class="text-lg text-wiki-muted">등록된 전공이 없습니다.</p>
          </div>`

    // 🆕 캐시 알림 제거 (사용자에게 보이지 않도록)
    const cacheNotice = '' // renderCacheNotice(cacheState, { staleSeconds: LIST_CACHE_STALE_SECONDS, maxAgeSeconds: LIST_CACHE_MAX_AGE_SECONDS })

    const sourceSummaryHtml = '' // 데이터 수집 상태 제거
    const filterSummary = keyword ? `"${escapeHtml(keyword)}" 키워드` : '전체 전공'
    const headingLabel = keyword ? `"${escapeHtml(keyword)}" 관련 전공` : '전공위키'

    const jsonLdItems = items.map((entry, index) => {
      const slug = composeDetailSlug('major', entry.profile.name, entry.profile.id)
      return {
        '@type': 'ListItem',
        position: (page - 1) * perPage + index + 1,
        url: buildCanonicalUrl(c.req.url, `/major/${encodeURIComponent(slug)}`),
        name: entry.profile.name
      }
    })
    const jsonLd = jsonLdItems.length
      ? `<script type="application/ld+json">${JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'ItemList',
          name: keyword ? `${keyword} 관련 전공 목록` : 'Careerwiki 전공 목록',
          numberOfItems: jsonLdItems.length,
          itemListOrder: 'https://schema.org/ItemListOrderAscending',
          itemListElement: jsonLdItems
        }).replace(/</g, '\\u003C')}</script>`
      : ''

    const extraHead = [jsonLd].filter(Boolean).join('\n')

    const content = `
      <div class="max-w-[1400px] mx-auto px-4 md:px-6">
        <!-- 히어로 섹션 with 그라데이션 블렌딩 -->
        <div class="relative text-center pt-12 pb-12 mb-6 space-y-7">
          <!-- 배경 글로우 + 하단 페이드 -->
          <div class="absolute inset-0 -z-10 overflow-hidden">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-gradient-to-b from-wiki-secondary/8 via-wiki-secondary/5 to-transparent rounded-full blur-[120px]"></div>
          </div>
          <!-- 하단 그라데이션 페이드 -->
          <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-wiki-bg to-transparent -z-10"></div>
          
          <h1 class="text-[42px] md:text-[48px] lg:text-6xl font-extrabold leading-tight mb-2">
            <span class="bg-gradient-to-r from-wiki-secondary via-purple-400 to-pink-400 bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(168,85,247,0.3)]">
            ${headingLabel}
            </span>
          </h1>
          
          <p class="text-lg md:text-xl text-wiki-text/90 max-w-2xl mx-auto font-medium leading-relaxed">
            전문성을 키우는 첫 걸음, 지금 시작하세요
          </p>
          
          <div class="flex items-center justify-center gap-3 text-sm">
            <span class="px-3 py-1.5 rounded-lg bg-wiki-bg/60 text-wiki-muted">${filterSummary}</span>
            <span class="px-3 py-1.5 rounded-lg bg-gradient-to-r from-wiki-secondary/20 to-purple-500/20 border border-wiki-secondary/30 text-white font-semibold">
              <span id="major-total-count">${totalCount}</span>개
            </span>
          </div>
        </div>

        <form id="major-filter-form" data-hydration-target="major" method="get" class="mb-6">
          <div class="flex flex-row gap-2 sm:gap-3">
            <!-- 검색창 - 글래스모피즘 + 인셋 아이콘 -->
            <div class="flex-1 relative group min-w-0">
              <div class="absolute inset-0 bg-gradient-to-r from-wiki-secondary/20 via-purple-500/20 to-wiki-secondary/20 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
              <div class="relative flex items-center bg-wiki-bg/40 backdrop-blur-xl border border-white/20 rounded-2xl overflow-hidden transition-all duration-300 group-focus-within:border-wiki-secondary/50 group-focus-within:shadow-lg group-focus-within:shadow-wiki-secondary/10">
                <span class="pl-3 sm:pl-4 pr-1 sm:pr-2 text-wiki-muted/60 group-focus-within:text-wiki-secondary transition-colors duration-300">
                  <i class="fas fa-search text-sm"></i>
                </span>
                <input
                  id="major-keyword"
                  type="text"
                  name="q"
                  value="${escapeHtml(keyword)}"
                  placeholder="전공 검색..."
                  class="flex-1 px-1 sm:px-2 py-2 sm:py-3.5 bg-transparent border-none focus:outline-none text-base text-white placeholder:text-wiki-muted/50 min-w-0"
                  style="font-size: 16px;"
                />
                <button type="submit" class="m-1 sm:m-1.5 px-3 sm:px-5 py-2 sm:py-2.5 min-h-[40px] sm:min-h-[44px] bg-gradient-to-r from-wiki-secondary to-purple-500 text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-wiki-secondary/25 active:scale-95 transition-all duration-200">
                  <i class="fas fa-search sm:hidden"></i>
                  <span class="hidden sm:inline">검색</span>
                </button>
              </div>
            </div>
            <!-- 정렬 + 새 전공 추가 버튼 -->
            <div class="flex items-center gap-2 shrink-0" id="major-hydration-toolbar">
              <div class="relative" data-dropdown="major-sort">
                <button type="button" id="major-sort-trigger" class="flex items-center justify-center gap-2 px-3 sm:pl-4 sm:pr-3 py-2 sm:py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl text-sm text-white/70 hover:bg-white/[0.06] hover:border-white/[0.1] focus:outline-none focus:border-wiki-secondary/40 transition-all duration-200 cursor-pointer min-w-[44px] sm:min-w-[130px] min-h-[44px]">
                  <i class="fas fa-sliders-h sm:hidden"></i>
                  <span id="major-sort-label" class="hidden sm:inline">${sort === 'employment-desc' ? '취업률 높은 순' : sort === 'salary-desc' ? '월급 높은 순' : sort === 'name-asc' ? '가나다 순' : '기본 순'}</span>
                  <i class="fas fa-chevron-down text-[10px] text-white/40 ml-auto transition-transform duration-200 hidden sm:inline" id="major-sort-chevron"></i>
                </button>
                <div id="major-sort-menu" class="absolute right-0 top-full mt-2 w-44 py-1.5 bg-[#1c2333]/95 backdrop-blur-xl border border-white/[0.08] rounded-xl shadow-2xl shadow-black/40 opacity-0 invisible translate-y-1 transition-all duration-200 z-50">
                  <div class="px-2 py-1.5 text-[10px] font-medium text-white/30 uppercase tracking-wider">정렬 기준</div>
                  <button type="button" data-sort="relevance" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'relevance' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-secondary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>기본 순</span>
                  </button>
                  <button type="button" data-sort="employment-desc" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'employment-desc' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-secondary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>취업률 높은 순</span>
                  </button>
                  <button type="button" data-sort="salary-desc" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'salary-desc' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-secondary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>월급 높은 순</span>
                  </button>
                  <button type="button" data-sort="name-asc" class="sort-option w-full px-3 py-2.5 text-left text-sm text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors duration-150 flex items-center gap-2.5 group ${sort === 'name-asc' ? 'active' : ''}">
                    <span class="w-1.5 h-1.5 rounded-full bg-wiki-secondary opacity-0 group-[.active]:opacity-100 transition-opacity"></span>
                    <span>가나다 순</span>
                  </button>
                </div>
                <select id="major-sort-select" class="sr-only">
                  <option value="relevance">기본 순</option>
                  <option value="employment-desc">취업률 높은 순</option>
                  <option value="salary-desc">월급 높은 순</option>
                  <option value="name-asc">가나다 순</option>
                </select>
              </div>
              ${isLoggedIn ? `
              <!-- 새 전공 추가 버튼 (로그인 시에만 표시) -->
              <button
                type="button"
                id="create-major-btn"
                data-create-entity="major"
                class="flex items-center gap-1.5 px-4 py-3 bg-gradient-to-r from-wiki-secondary to-purple-500 text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-wiki-secondary/25 active:scale-95 transition-all duration-200 whitespace-nowrap"
              >
                <i class="fas fa-plus text-xs"></i>
                추가
              </button>
              ` : ''}
            </div>
          </div>
        </form>

        ${cacheNotice}

        <section id="major-results" class="space-y-4" aria-live="polite">
          ${majorCards}
        </section>

        ${(() => {
          // 실제 병합된 아이템 수를 기준으로 페이지네이션 계산
          const actualTotalCount = typeof result.meta?.total === 'number' ? result.meta.total : items.length
          const totalPages = Math.ceil(actualTotalCount / perPage)
          if (totalPages <= 1) return ''
          
          const buildPageUrl = (pageNum: number) => {
            const params = new URLSearchParams()
            if (keyword) params.set('q', keyword)
            if (includeSources?.length) params.set('sources', includeSources.join(','))
            if (pageNum > 1) params.set('page', String(pageNum))
            return `/major${params.toString() ? `?${params.toString()}` : ''}`
          }
          
          // 화면 크기에 따라 버튼 수 조정 (모바일: 3개, 데스크톱: 7개)
          const maxPageButtons = isMobile ? 3 : 7
          let startPage = Math.max(1, page - Math.floor(maxPageButtons / 2))
          let endPage = Math.min(totalPages, startPage + maxPageButtons - 1)
          
          if (endPage - startPage < maxPageButtons - 1) {
            startPage = Math.max(1, endPage - maxPageButtons + 1)
          }
          
          const pageButtons = []
          
          // 이전 페이지 버튼
          if (page > 1) {
            pageButtons.push(`
              <a href="${buildPageUrl(page - 1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                <i class="fas fa-chevron-left"></i>
              </a>
            `)
          }
          
          // 첫 페이지
          if (startPage > 1) {
            pageButtons.push(`
              <a href="${buildPageUrl(1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                1
              </a>
            `)
            if (startPage > 2) {
              pageButtons.push(`<span class="px-1 text-wiki-muted">...</span>`)
            }
          }
          
          // 페이지 번호들 (최대 7개만 표시)
          for (let i = startPage; i <= endPage; i++) {
            const isActive = i === page
            pageButtons.push(`
              <a href="${buildPageUrl(i)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center rounded-lg transition ${
                   isActive
                     ? 'bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold'
                     : 'bg-wiki-bg border border-wiki-border hover:border-wiki-primary'
                 }">
                ${i}
              </a>
            `)
          }
          
          // 마지막 페이지
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              pageButtons.push(`<span class="px-1 text-wiki-muted">...</span>`)
            }
            pageButtons.push(`
              <a href="${buildPageUrl(totalPages)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                ${totalPages}
              </a>
            `)
          }
          
          // 다음 페이지 버튼
          if (page < totalPages) {
            pageButtons.push(`
              <a href="${buildPageUrl(page + 1)}" 
                 class="min-w-[44px] min-h-[44px] px-3 py-2.5 flex items-center justify-center bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">
                <i class="fas fa-chevron-right"></i>
              </a>
            `)
          }
          
          return `
            <nav class="mt-8 flex justify-center items-center gap-2 flex-wrap" aria-label="페이지네이션">
              ${pageButtons.join('')}
            </nav>
            <p class="text-center text-xs text-wiki-muted mt-4">
              ${page}페이지 / 총 ${totalPages}페이지 (${actualTotalCount}개 전공)
            </p>
          `
        })()}

        ${sourceSummaryHtml}
      </div>
    `

    const hydrationScript = `<script id="major-hydration-data" type="application/json">${serializeForScript({
      items,
      meta: {
        total: totalCount,
        page,
        perPage,
        keyword,
        sort,
        includeSources: includeSources ?? null,
        sources: result.meta?.sources ?? null,
        cacheState
      }
    })}</script>`
    
    // 전공위키 정렬 드롭다운 이벤트 핸들러 스크립트
    const sortScript = `<script>
(function() {
  const currentSort = '${sort}';
  const sortLabels = { 'relevance': '기본 순', 'employment-desc': '취업률 높은 순', 'salary-desc': '월급 높은 순', 'name-asc': '가나다 순' };
  
  // 초기 라벨 설정
  const labelEl = document.getElementById('major-sort-label');
  if (labelEl) labelEl.textContent = sortLabels[currentSort] || '기본 순';
  
  // 커스텀 드롭다운 토글
  const trigger = document.getElementById('major-sort-trigger');
  const menu = document.getElementById('major-sort-menu');
  const chevron = document.getElementById('major-sort-chevron');
  
  if (trigger && menu) {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      const isOpen = !menu.classList.contains('invisible');
      if (isOpen) {
        menu.classList.add('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.remove('rotate-180');
      } else {
        menu.classList.remove('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.add('rotate-180');
      }
    });
    
    // 메뉴 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
      if (!trigger.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('invisible', 'opacity-0', 'translate-y-1');
        chevron?.classList.remove('rotate-180');
      }
    });
  }
  
  // 정렬 옵션 클릭 이벤트
  document.querySelectorAll('#major-sort-menu .sort-option[data-sort]').forEach(function(btn) {
    const sortValue = btn.getAttribute('data-sort');
    if (sortValue === currentSort) btn.classList.add('active');
    
    btn.addEventListener('click', function() {
      const url = new URL(window.location.href);
      if (sortValue === 'relevance') {
        url.searchParams.delete('sort');
      } else {
        url.searchParams.set('sort', sortValue);
      }
      url.searchParams.delete('page'); // 정렬 변경 시 첫 페이지로
      window.location.href = url.toString();
    });
  });
  
  // select 요소 변경 이벤트 (모바일용)
  const selectEl = document.getElementById('major-sort-select');
  if (selectEl) {
    selectEl.value = currentSort;
    selectEl.addEventListener('change', function() {
      const url = new URL(window.location.href);
      if (this.value === 'relevance') {
        url.searchParams.delete('sort');
      } else {
        url.searchParams.set('sort', this.value);
      }
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  }
})();
</script>`
    
    const hydratedContent = `${content}${hydrationScript}${sortScript}`

    const pageTitle = keyword ? `${keyword} 전공 검색 결과 - Careerwiki` : '전공위키 - Careerwiki'
    const description = createMetaDescription(
      keyword ? `${keyword} 관련 전공 정보를 확인하세요.` : undefined,
      items[0]?.display?.summary,
      items[0]?.display?.employmentRate,
      '전공별 커리큘럼과 진로 정보를 통합 데이터로 확인하세요.'
    )

    return c.html(
      renderLayoutWithContext(c,
        hydratedContent,
        escapeHtml(pageTitle),
        escapeHtml(description),
        false,
        {
          canonical: canonicalUrl,
          ogUrl: canonicalUrl,
          extraHead
        }
      )
    )
    } catch (error) {
      // KV 연결 실패 등 네트워크 에러는 캐시 없이 직접 조회 시도
      if (error instanceof Error && (error.message.includes('fetch failed') || error.message.includes('ECONNRESET') || error.message.includes('ECONNREFUSED') || error.message.includes('terminated'))) {
        try {
          // 로컬 개발 환경에서는 KV가 없을 수 있으므로 조용히 처리
          const isLocalDev = !c.env.KV && !c.env.DB
          if (!isLocalDev) {
            console.warn('KV cache failed, attempting direct D1 query:', error.message)
          }
          const directResult = await searchUnifiedMajors(
          {
            keyword,
            page,
            perPage,
            includeSources
          },
          c.env
        )
        
        const items = directResult.items
        const totalCount = typeof directResult.meta?.total === 'number' ? directResult.meta.total : items.length
        
        // 공통 함수 renderMajorCard 사용
        const majorCards = items.length
          ? items.map((entry) => renderMajorCard(entry)).join('')
          : keyword
            ? `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
                <i class="fas fa-search text-4xl text-wiki-muted mb-4"></i>
                <p class="text-lg text-wiki-muted">"${escapeHtml(keyword)}"에 해당하는 전공이 없습니다.</p>
                <p class="text-sm text-wiki-muted mt-2">다른 검색어를 시도해보세요.</p>
              </div>`
            : `<div class="glass-card p-8 rounded-2xl text-center col-span-full">
                <i class="fas fa-graduation-cap text-4xl text-wiki-muted mb-4"></i>
                <p class="text-lg text-wiki-muted">등록된 전공이 없습니다.</p>
              </div>`
        
        const totalPages = Math.ceil(totalCount / perPage)
        
        // 모바일 감지
        const userAgent = c.req.header('user-agent') || ''
        const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
        
        const buildPageUrl = (pageNum: number) => {
          const params = new URLSearchParams()
          if (keyword) params.set('q', keyword)
          if (includeSources?.length) params.set('sources', includeSources.join(','))
          if (pageNum > 1) params.set('page', String(pageNum))
          return `/major${params.toString() ? `?${params.toString()}` : ''}`
          }
          
          // 화면 크기에 따라 버튼 수 조정 (모바일: 3개, 데스크톱: 7개)
          const maxPageButtons = isMobile ? 3 : 7
          let startPage = Math.max(1, page - Math.floor(maxPageButtons / 2))
        let endPage = Math.min(totalPages, startPage + maxPageButtons - 1)
        if (endPage - startPage < maxPageButtons - 1) {
          startPage = Math.max(1, endPage - maxPageButtons + 1)
        }
        
        const pageButtons = []
        if (page > 1) {
          pageButtons.push(`<a href="${buildPageUrl(page - 1)}" class="px-4 py-2 bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition"><i class="fas fa-chevron-left"></i></a>`)
        }
        if (startPage > 1) {
          pageButtons.push(`<a href="${buildPageUrl(1)}" class="px-4 py-2 bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">1</a>`)
          if (startPage > 2) pageButtons.push(`<span class="px-2 text-wiki-muted">...</span>`)
        }
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === page
          pageButtons.push(`<a href="${buildPageUrl(i)}" class="px-4 py-2 rounded-lg transition ${isActive ? 'bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-bold' : 'bg-wiki-bg border border-wiki-border hover:border-wiki-primary'}">${i}</a>`)
        }
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) pageButtons.push(`<span class="px-2 text-wiki-muted">...</span>`)
          pageButtons.push(`<a href="${buildPageUrl(totalPages)}" class="px-4 py-2 bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition">${totalPages}</a>`)
        }
        if (page < totalPages) {
          pageButtons.push(`<a href="${buildPageUrl(page + 1)}" class="px-4 py-2 bg-wiki-bg border border-wiki-border rounded-lg hover:border-wiki-primary transition"><i class="fas fa-chevron-right"></i></a>`)
        }
        
        const paginationHtml = totalPages > 1 ? `
          <nav class="mt-8 flex justify-center items-center gap-2 flex-wrap" aria-label="페이지네이션">
            ${pageButtons.join('')}
          </nav>
          <p class="text-center text-xs text-wiki-muted mt-4">
            ${page}페이지 / 총 ${totalPages}페이지 (${totalCount}개 전공)
          </p>
        ` : ''
        
        const content = `
          <div class="max-w-[1400px] mx-auto px-4 md:px-6 md:mt-8">
            <div class="relative text-center pt-12 pb-12 mb-16 space-y-7">
              <div class="absolute inset-0 -z-10 overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-wiki-secondary/5 rounded-full blur-[100px]"></div>
              </div>
              <h1 class="text-[42px] md:text-[48px] lg:text-6xl font-extrabold leading-tight mb-2">
                <span class="bg-gradient-to-r from-wiki-secondary via-purple-400 to-pink-400 bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(168,85,247,0.3)]">
                ${keyword ? `"${escapeHtml(keyword)}" 관련 전공` : '전공위키'}
                </span>
              </h1>
              <p class="text-lg md:text-xl text-wiki-text/90 max-w-2xl mx-auto font-medium leading-relaxed">
                전공별 커리큘럼과 진로 정보를 통합 데이터로 확인하세요.
              </p>
              <div class="flex items-center justify-center gap-4 text-sm text-wiki-muted">
                <span class="px-3 py-1.5 rounded-lg bg-gradient-to-r from-wiki-primary/20 to-blue-500/20 border border-wiki-primary/30 text-white font-semibold">
                  <span id="major-total-count">${totalCount}</span>개 전공
                </span>
              </div>
            </div>
            <form method="get" action="/major" class="glass-card rounded-xl p-6 mb-6" id="major-filter-form">
              <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                  <label for="major-keyword" class="block text-sm text-wiki-muted mb-2">검색어</label>
                  <input type="text" id="major-keyword" name="q" value="${escapeHtml(keyword)}" placeholder="전공명으로 검색..." class="w-full px-4 py-3 bg-wiki-bg border border-wiki-border rounded-lg focus:border-wiki-primary focus:outline-none" />
                </div>
                <div class="flex gap-2 justify-end">
                  <button type="submit" class="px-6 py-3 bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white font-semibold rounded-lg hover-glow transition">
                    <i class="fas fa-search mr-2"></i>검색
                  </button>
                  <a href="/major" class="px-6 py-3 bg-wiki-bg border border-wiki-border text-wiki-muted font-semibold rounded-lg hover:border-wiki-primary transition">초기화</a>
                </div>
              </div>
            </form>
            <div class="glass-card rounded-xl p-4 mb-6 flex flex-wrap items-center gap-4" id="major-hydration-toolbar">
              <div class="flex items-center gap-2">
                <label for="major-sort-select" class="text-sm text-wiki-muted">정렬</label>
                <select id="major-sort-select" class="px-4 py-2 bg-wiki-bg border border-wiki-border rounded-lg focus:border-wiki-primary focus:outline-none">
                  <option value="relevance">기본 순</option>
                  <option value="employment-desc">취업률 높은 순</option>
                  <option value="salary-desc">월급 높은 순</option>
                </select>
              </div>
              <div class="ml-auto text-xs text-wiki-muted" id="major-hydration-status" aria-live="polite"></div>
            </div>
            <section id="major-results" class="space-y-4" aria-live="polite">
              ${majorCards}
            </section>
            ${paginationHtml}
          </div>
        `
        
        const hydrationScript = `<script id="major-hydration-data" type="application/json">${serializeForScript({
          items,
          meta: {
            total: totalCount,
            page,
            perPage,
            keyword,
            includeSources: includeSources ?? null,
            sources: directResult.meta?.sources ?? null
          }
        })}</script>`
        
        return c.html(
          renderLayoutWithContext(c,
            `${content}${hydrationScript}`,
            keyword ? `${keyword} 전공 검색 결과 - Careerwiki` : '전공위키 - Careerwiki',
            keyword ? `${keyword} 관련 전공 정보를 확인하세요.` : '전공별 커리큘럼과 진로 정보를 통합 데이터로 확인하세요.'
          )
        )
      } catch (fallbackError) {
        // 로컬 개발 환경에서는 D1이 없을 수 있으므로 조용히 처리
        const isLocalDev = !c.env.KV && !c.env.DB
        if (!isLocalDev) {
          console.error('Direct D1 query also failed:', fallbackError)
        }
      }
    }
    
    // 로컬 개발 환경에서는 D1이 없을 수 있으므로 조용히 처리
    const isLocalDev = !c.env.KV && !c.env.DB
    if (!isLocalDev) {
      console.error('Major list route error:', error)
    }
    c.status(500)
    const fallbackHtml = renderDetailFallback({
      icon: 'fa-circle-exclamation',
      iconColor: 'text-red-500',
      title: '전공 목록을 불러오지 못했습니다',
      description: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',
      ctaHref: '/',
      ctaLabel: '홈으로 돌아가기'
    })
    return c.html(
      renderLayoutWithContext(c,
        fallbackHtml,
        '전공 목록 오류 - Careerwiki',
        '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
      )
    )
  }
})

// HowTo 업데이트 API (발행된 HowTo 수정)
app.put('/api/howto/:id/update', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const pageId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(pageId)) {
      return c.json({ success: false, error: '유효하지 않은 ID입니다' }, 400)
    }
    
    // 권한 확인 (작성자 또는 관리자만)
    const page = await c.env.DB.prepare(
      'SELECT author_id FROM pages WHERE id = ? AND page_type = ?'
    ).bind(pageId, 'guide').first<{ author_id: number | null }>()
    
    if (!page) {
      return c.json({ success: false, error: 'HowTo를 찾을 수 없습니다' }, 404)
    }
    
    const isAuthor = page.author_id && user.id === page.author_id
    const isAdmin = user.role === 'admin'
    
    if (!isAuthor && !isAdmin) {
      return c.json({ success: false, error: '편집 권한이 없습니다' }, 403)
    }
    
    const body = await c.req.json()
    const { title, summary, contentHtml, contentJson, tags, relatedJobs, relatedMajors, relatedHowtos, thumbnailUrl, footnotes } = body
    
    if (!title || !title.trim()) {
      return c.json({ success: false, error: '제목을 입력해주세요' }, 400)
    }
    
    // 첫 번째 이미지 추출 (썸네일이 명시적으로 설정되지 않은 경우)
    let finalThumbnailUrl = thumbnailUrl || ''
    let extractedFootnotes = footnotes || []
    if (contentJson) {
      try {
        const contentObj = JSON.parse(contentJson)
        if (!finalThumbnailUrl) {
          finalThumbnailUrl = extractFirstImage(contentObj)
        }
        // 각주 추출 (클라이언트에서 안 보내면 서버에서 추출)
        if (!footnotes || footnotes.length === 0) {
          extractedFootnotes = extractFootnotes(contentObj)
        }
      } catch {}
    }
    
    // meta_data 구성
    const metaData = JSON.stringify({
      contentJson,
      tags: tags || [],
      relatedJobs: relatedJobs || [],
      relatedMajors: relatedMajors || [],
      relatedHowtos: relatedHowtos || [],
      footnotes: extractedFootnotes,
      authorName: user.username || user.email?.split('@')[0] || '작성자',
      thumbnailUrl: finalThumbnailUrl
    })
    
    // 업데이트
    const now = new Date().toISOString()
    await c.env.DB.prepare(`
      UPDATE pages 
      SET title = ?, summary = ?, content = ?, meta_data = ?, updated_at = ?
      WHERE id = ?
    `).bind(title.trim(), summary || '', contentHtml || '', metaData, now, pageId).run()
    
    return c.json({ success: true, message: '저장되었습니다' })
  } catch (error) {
    console.error('[update howto] Error:', error)
    return c.json({ success: false, error: '저장 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo 삭제 API
app.delete('/api/howto/:id', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const pageId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(pageId)) {
      return c.json({ success: false, error: '유효하지 않은 ID입니다' }, 400)
    }
    
    // 권한 확인 + 이미지 삭제를 위한 content, meta_data 조회
    const page = await c.env.DB.prepare(
      'SELECT author_id, content, meta_data FROM pages WHERE id = ? AND page_type = ?'
    ).bind(pageId, 'guide').first<{ author_id: number | null; content: string | null; meta_data: string | null }>()
    
    if (!page) {
      return c.json({ success: false, error: 'HowTo를 찾을 수 없습니다' }, 404)
    }
    
    const isAuthor = page.author_id && user.id === page.author_id
    const isAdmin = user.role === 'admin'
    
    if (!isAuthor && !isAdmin) {
      return c.json({ success: false, error: '삭제 권한이 없습니다' }, 403)
    }
    
    // R2 이미지 삭제 (본문 이미지 + 썸네일)
    const imageKeysToDelete: string[] = []
    
    // 1) 본문에서 /uploads/ 경로 이미지 추출
    if (page.content) {
      const uploadMatches = page.content.match(/\/uploads\/[^\s"'<>]+/g) || []
      for (const match of uploadMatches) {
        const key = match.replace('/uploads/', '')
        if (key && !imageKeysToDelete.includes(key)) {
          imageKeysToDelete.push(key)
        }
      }
    }
    
    // 2) 썸네일 URL 추출
    if (page.meta_data) {
      try {
        const meta = JSON.parse(page.meta_data)
        if (meta.thumbnailUrl && meta.thumbnailUrl.startsWith('/uploads/')) {
          const key = meta.thumbnailUrl.replace('/uploads/', '')
          if (key && !imageKeysToDelete.includes(key)) {
            imageKeysToDelete.push(key)
          }
        }
      } catch (e) {
        // meta_data 파싱 실패 시 무시
      }
    }
    
    // R2에서 이미지 삭제 (실패해도 D1 삭제는 진행)
    if (imageKeysToDelete.length > 0 && c.env.UPLOADS) {
      for (const key of imageKeysToDelete) {
        try {
          await c.env.UPLOADS.delete(key)
          console.log(`[delete howto] R2 이미지 삭제: ${key}`)
        } catch (e) {
          console.error(`[delete howto] R2 이미지 삭제 실패: ${key}`, e)
        }
      }
    }
    
    // D1에서 페이지 삭제
    await c.env.DB.prepare('DELETE FROM pages WHERE id = ?').bind(pageId).run()
    
    return c.json({ success: true, message: '삭제되었습니다' })
  } catch (error) {
    console.error('[delete howto] Error:', error)
    return c.json({ success: false, error: '삭제 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo Sample Pages - 블로그 스타일
app.get('/howto', async (c) => {
  try {
  const user = getOptionalUser(c)
  const keywordRaw = c.req.query('q') || ''
  const keyword = keywordRaw.trim()
  const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
  const perPage = 12
  
  // 모바일 감지
  const userAgent = c.req.header('user-agent') || ''
  const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
  
  // 검색 조건
  const searchCondition = keyword 
    ? `AND (p.title LIKE ? OR p.summary LIKE ? OR p.meta_data LIKE ?)` 
    : ''
  const searchParams = keyword 
    ? [`%${keyword}%`, `%${keyword}%`, `%${keyword}%`] 
    : []
  
  // 전체 개수 조회 (source = 'user'로 실제 유저가 작성한 HowTo만, guide: prefix 제외)
  const countQuery = `
    SELECT COUNT(*) as total
    FROM pages p
    WHERE p.page_type = 'guide' AND p.status = 'published' 
      AND p.source = 'user' AND p.slug NOT LIKE 'guide:%'
    ${searchCondition}
  `
  const countResult = keyword 
    ? await c.env.DB.prepare(countQuery).bind(...searchParams).first<{ total: number }>()
    : await c.env.DB.prepare(countQuery).first<{ total: number }>()
  const totalCount = countResult?.total || 0
  const totalPages = Math.ceil(totalCount / perPage)
  
  // DB에서 발행된 HowTo 가져오기 (페이지네이션 적용, source = 'user'만)
  const offset = (page - 1) * perPage
  const dbQuery = `
    SELECT p.id, p.slug, p.title, p.summary, p.meta_data, p.author_id, p.created_at, p.updated_at,
           u.username AS author_username, u.picture_url AS author_picture_url, u.custom_picture_url AS author_custom_picture_url,
           (SELECT COUNT(*) FROM comments WHERE page_id = p.id) AS comment_count,
           (SELECT COUNT(*) FROM user_bookmarks WHERE item_type = 'howto' AND item_slug = p.slug) AS bookmark_count
    FROM pages p
    LEFT JOIN users u ON u.id = p.author_id
    WHERE p.page_type = 'guide' AND p.status = 'published' 
      AND p.source = 'user' AND p.slug NOT LIKE 'guide:%'
    ${searchCondition}
    ORDER BY p.created_at DESC
    LIMIT ? OFFSET ?
  `
  const dbHowtos = keyword
    ? await c.env.DB.prepare(dbQuery).bind(...searchParams, perPage, offset).all()
    : await c.env.DB.prepare(dbQuery).bind(perPage, offset).all()
  
  // DB 결과를 형식으로 변환
  const dbSummaries = (dbHowtos.results || []).map((row: any) => {
    let metaData: any = {}
    try {
      if (row.meta_data) metaData = JSON.parse(row.meta_data)
    } catch {}
    return {
      slug: row.slug,
      title: row.title,
      snippet: row.summary || '',
      tags: metaData.tags || [],
      keywords: [],
      thumbnailUrl: metaData.thumbnailUrl || '',
      authorName: metaData.authorName || row.author_username || '작성자',
      authorPictureUrl: row.author_custom_picture_url || row.author_picture_url || null,
      updatedAt: row.updated_at || row.created_at,
      commentCount: row.comment_count || 0,
      bookmarkCount: row.bookmark_count || 0
    }
  })
  
  // 샘플 데이터 제거 - DB 데이터만 사용
  const howtoSummaries: Array<{
    slug: string
    title: string
    snippet: string
    tags: string[]
    keywords: string[]
    thumbnailUrl?: string
    authorName?: string
    authorPictureUrl?: string | null
    updatedAt: string | number
    commentCount: number
    bookmarkCount: number
  }> = dbSummaries
  
  // 블로그 스타일 카드 생성
  const cards = howtoSummaries.length
    ? howtoSummaries
        .map((howto) => {
          const tagsHtml = howto.tags && howto.tags.length
            ? howto.tags.slice(0, 3).map((tag: string) => 
                `<span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded-md text-[9px] sm:text-[10px] font-semibold uppercase tracking-wider bg-wiki-primary/10 text-wiki-primary/80 border border-wiki-primary/20">${escapeHtml(tag)}</span>`
              ).join('')
            : ''
          
          // 데스크탑용 썸네일 (상단)
          const thumbnailDesktop = howto.thumbnailUrl 
            ? `<div class="hidden sm:block aspect-[16/9] overflow-hidden">
                <img src="${escapeHtml(howto.thumbnailUrl)}" 
                     alt="${escapeHtml(howto.title)}" 
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                     loading="lazy" />
              </div>`
            : `<div class="hidden sm:flex aspect-[16/9] bg-gradient-to-br from-wiki-primary/20 to-amber-500/10 items-center justify-center">
                <i class="fas fa-book-open text-5xl text-wiki-primary/40"></i>
              </div>`
          
          // 모바일용 썸네일 (오른쪽)
          const thumbnailMobile = howto.thumbnailUrl 
            ? `<div class="sm:hidden w-20 h-20 shrink-0 rounded-xl overflow-hidden">
                <img src="${escapeHtml(howto.thumbnailUrl)}" 
                     alt="${escapeHtml(howto.title)}" 
                     class="w-full h-full object-cover"
                     loading="lazy" />
              </div>`
            : `<div class="sm:hidden w-20 h-20 shrink-0 rounded-xl bg-gradient-to-br from-wiki-primary/20 to-amber-500/10 flex items-center justify-center">
                <i class="fas fa-book-open text-2xl text-wiki-primary/40"></i>
              </div>`
          
          const dateStr = howto.updatedAt 
            ? new Date(howto.updatedAt).toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric' })
            : ''
          
          // 댓글/저장 갯수 표시
          const statsHtml = `
            <div class="flex items-center gap-2.5 text-[13px] text-wiki-muted/60">
              <span class="inline-flex items-center gap-1">
                <i class="far fa-comment text-xs"></i>
                <span class="font-medium">${howto.commentCount}</span>
              </span>
              <span class="inline-flex items-center gap-1">
                <i class="far fa-bookmark text-xs"></i>
                <span class="font-medium">${howto.bookmarkCount}</span>
              </span>
            </div>
          `
          
          return `
            <article class="group bg-wiki-card/50 border border-wiki-border/40 rounded-2xl overflow-hidden hover:border-wiki-primary/40 hover:shadow-lg hover:shadow-wiki-primary/5 transition-all duration-300">
              <a href="/howto/${encodeURIComponent(howto.slug)}" class="block">
                <!-- 데스크탑: 썸네일 상단 -->
                ${thumbnailDesktop}
                
                <div class="p-4 sm:p-5">
                  <!-- 모바일: 가로 레이아웃 (텍스트 왼쪽 + 썸네일 오른쪽) -->
                  <div class="flex sm:block gap-3">
                    <div class="flex-1 min-w-0 space-y-1.5 sm:space-y-3">
                      <!-- 태그 -->
                      ${tagsHtml ? `<div class="flex flex-wrap gap-1.5 sm:gap-2">${tagsHtml}</div>` : ''}
                      
                      <!-- 제목 -->
                      <h2 class="text-lg sm:text-xl font-bold text-white group-hover:text-wiki-primary transition-colors line-clamp-2">
                        ${escapeHtml(howto.title)}
                      </h2>
                      
                      <!-- 설명 -->
                      <p class="text-[13px] sm:text-[15px] text-wiki-muted/90 line-clamp-2 leading-relaxed">${escapeHtml(howto.snippet)}</p>
                    </div>
                    
                    <!-- 모바일: 썸네일 오른쪽 -->
                    ${thumbnailMobile}
                  </div>
                  
                  <!-- 하단 정보 (글쓴이, 날짜, 댓글/저장 수) -->
                  <div class="flex items-center justify-between pt-3 mt-3 border-t border-wiki-border/30">
                    <div class="flex items-center gap-1.5 text-[13px] text-wiki-muted/70">
                      <span class="inline-flex items-center gap-1">
                        ${howto.authorPictureUrl 
                          ? `<img src="${escapeHtml(howto.authorPictureUrl)}" alt="${escapeHtml(howto.authorName || '운영자')}" class="w-4 h-4 sm:w-5 sm:h-5 rounded-full object-cover" />`
                          : `<i class="fas fa-user-circle text-wiki-primary/60 text-sm"></i>`}
                        <span class="font-medium">${escapeHtml(howto.authorName || '운영자')}</span>
                      </span>
                      ${dateStr ? `<span class="text-wiki-border/50">·</span><span class="font-normal">${dateStr}</span>` : ''}
                    </div>
                    ${statsHtml}
                  </div>
                </div>
              </a>
            </article>
          `
        })
        .join('')
    : ''
  
  // 비어있을 때 표시
  const emptyState = !howtoSummaries.length ? `
    <div class="col-span-full text-center py-16">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-wiki-primary/10 mb-6">
        <i class="fas fa-pen-nib text-3xl text-wiki-primary/60"></i>
      </div>
      <h3 class="text-xl font-semibold text-white mb-2">아직 작성된 가이드가 없어요</h3>
      <p class="text-wiki-muted mb-6">첫 번째 HowTo 가이드를 작성해보세요!</p>
      <a href="${user ? '/howto/write' : '/login?redirect=/howto/write'}" 
         class="inline-flex items-center gap-2 px-6 py-3 min-h-[48px] bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
        <i class="fas fa-plus"></i>
        가이드 작성하기
      </a>
    </div>
  ` : ''

  // 페이지네이션 생성
  const maxPageButtons = isMobile ? 3 : 7
  const halfMax = Math.floor(maxPageButtons / 2)
  let startPage = Math.max(1, page - halfMax)
  let endPage = Math.min(totalPages, startPage + maxPageButtons - 1)
  if (endPage - startPage + 1 < maxPageButtons) {
    startPage = Math.max(1, endPage - maxPageButtons + 1)
  }
  
  const buildPageUrl = (p: number) => {
    const params = new URLSearchParams()
    if (keyword) params.set('q', keyword)
    if (p > 1) params.set('page', String(p))
    return `/howto${params.toString() ? `?${params.toString()}` : ''}`
  }
  
  const paginationHtml = totalPages > 1 ? `
    <nav class="flex justify-center items-center gap-2 flex-wrap" aria-label="페이지네이션">
      ${page > 1 ? `
        <a href="${buildPageUrl(page - 1)}" class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg bg-wiki-card border border-wiki-border hover:border-wiki-primary/50 hover:bg-wiki-primary/10 transition" aria-label="이전 페이지">
          <i class="fas fa-chevron-left text-sm text-wiki-muted"></i>
        </a>
      ` : `
        <span class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg bg-wiki-card/50 border border-wiki-border/50 opacity-50 cursor-not-allowed">
          <i class="fas fa-chevron-left text-sm text-wiki-muted"></i>
        </span>
      `}
      ${Array.from({ length: endPage - startPage + 1 }, (_, i) => {
        const p = startPage + i
        const isActive = p === page
        return `
          <a href="${buildPageUrl(p)}" 
             class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg text-sm font-medium transition ${isActive 
               ? 'bg-wiki-primary text-white' 
               : 'bg-wiki-card border border-wiki-border text-wiki-muted hover:border-wiki-primary/50 hover:text-white'}"
             ${isActive ? 'aria-current="page"' : ''}>
            ${p}
          </a>
        `
      }).join('')}
      ${page < totalPages ? `
        <a href="${buildPageUrl(page + 1)}" class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg bg-wiki-card border border-wiki-border hover:border-wiki-primary/50 hover:bg-wiki-primary/10 transition" aria-label="다음 페이지">
          <i class="fas fa-chevron-right text-sm text-wiki-muted"></i>
        </a>
      ` : `
        <span class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg bg-wiki-card/50 border border-wiki-border/50 opacity-50 cursor-not-allowed">
          <i class="fas fa-chevron-right text-sm text-wiki-muted"></i>
        </span>
      `}
    </nav>
    <p class="text-center text-sm text-wiki-muted mt-4">${page}페이지 / 총 ${totalPages}페이지 (${totalCount}개 가이드)</p>
  ` : ''

  const content = `
    <div class="max-w-[1400px] mx-auto px-4 py-8">
      <!-- 헤더 섹션 -->
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 sm:gap-6 mb-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">${keyword ? `"${escapeHtml(keyword)}" 검색 결과` : 'HowTo 가이드'}</h1>
          <p class="text-wiki-muted">${keyword ? `${totalCount}개의 가이드를 찾았습니다` : '실전 경험에서 나온 진짜 노하우를 공유합니다'}</p>
        </div>
        <a href="${user ? '/howto/write' : '/login?redirect=/howto/write'}" 
           class="inline-flex items-center gap-1.5 sm:gap-2 px-3 sm:px-5 py-2 sm:py-3 min-h-[40px] sm:min-h-[44px] bg-wiki-primary/70 hover:bg-wiki-primary/80 text-white text-sm sm:text-base font-medium rounded-xl transition shrink-0 self-end md:self-center"
           ${!user ? 'data-require-login="true"' : ''}>
          <i class="fas fa-plus text-xs sm:text-sm"></i>
          <span>가이드 작성</span>
        </a>
      </header>
      
      <!-- 검색창 -->
      <form action="/howto" method="get" class="mb-6">
        <div class="flex flex-row gap-2 sm:gap-3">
          <div class="flex-1 relative group min-w-0">
            <div class="relative flex items-center bg-wiki-bg/40 backdrop-blur-xl border border-white/20 rounded-2xl overflow-hidden transition-all duration-300 group-focus-within:border-wiki-primary/50 group-focus-within:shadow-lg group-focus-within:shadow-wiki-primary/10">
              <span class="pl-3 sm:pl-4 pr-1 sm:pr-2 text-wiki-muted/60 group-focus-within:text-wiki-primary transition-colors duration-300">
                <i class="fas fa-search text-sm"></i>
              </span>
              <input
                type="text"
                name="q"
                value="${escapeHtml(keyword)}"
                placeholder="가이드 검색..."
                class="flex-1 px-1 sm:px-2 py-2 sm:py-3.5 bg-transparent border-none focus:outline-none text-base text-white placeholder:text-wiki-muted/50 min-w-0"
                style="font-size: 16px;"
              />
              <button type="submit" class="m-1 sm:m-1.5 px-3 sm:px-5 py-2 sm:py-2.5 min-h-[40px] sm:min-h-[44px] bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-wiki-primary/25 active:scale-95 transition-all duration-200">
                <i class="fas fa-search sm:hidden"></i>
                <span class="hidden sm:inline">검색</span>
              </button>
            </div>
          </div>
        </div>
      </form>
      
      <!-- 가이드 목록 (그리드) -->
      <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        ${cards}
        ${emptyState}
      </section>
      
      <!-- 페이지네이션 -->
      ${paginationHtml}
    </div>
  `

  const title = keyword ? `"${keyword}" - HowTo 가이드 검색 - Careerwiki` : 'HowTo 가이드 - Careerwiki'
  const description = keyword 
    ? `"${keyword}" 검색 결과 - ${totalCount}개의 HowTo 가이드를 찾았습니다.`
    : '실전 경험에서 나온 진짜 노하우를 공유하는 HowTo 가이드 모음입니다.'

  return c.html(
    renderLayoutWithContext(c,
      content,
      title,
      description
    )
  )
  } catch (error) {
    console.error('[howto list] Error:', error)
    return c.text('HowTo 페이지를 불러오는 중 오류가 발생했습니다.', 500)
  }
})

// 로그인 페이지 (Google OAuth로 리다이렉트)
app.get('/login', (c) => {
  const queryRedirect = c.req.query('redirect')
  const referer = c.req.header('Referer')
  let redirect = queryRedirect || '/'
  
  // Referer가 있고 내부 URL이면 사용
  if (!queryRedirect && referer) {
    try {
      const refererUrl = new URL(referer)
      const currentUrl = new URL(c.req.url)
      // 같은 도메인이면 Referer 사용
      if (refererUrl.origin === currentUrl.origin && refererUrl.pathname !== '/login') {
        redirect = refererUrl.pathname + refererUrl.search
      }
    } catch (e) {
      // URL 파싱 실패 시 기본값 사용
    }
  }
  
  const user = getOptionalUser(c)
  
  // 이미 로그인한 경우 리다이렉트
  if (user) {
    return c.redirect(redirect)
  }
  
  const content = `
    <div class="min-h-[60vh] flex items-center justify-center px-4 pt-16 md:pt-0">
      <div class="max-w-md w-full">
        <div class="bg-wiki-card/60 border border-wiki-border/40 rounded-2xl p-8 text-center backdrop-blur-sm">
          <!-- 로고/아이콘 -->
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-primary/10 mb-6">
            <i class="fas fa-user-circle text-3xl text-wiki-primary"></i>
          </div>
          
          <h1 class="text-2xl font-bold text-white mb-2">로그인이 필요합니다</h1>
          <p class="text-wiki-muted mb-8">계속하려면 로그인해주세요</p>
          
          <!-- Google 로그인 버튼 -->
          <a href="/auth/google?return_url=${encodeURIComponent(redirect)}" 
             class="flex items-center justify-center gap-3 w-full px-6 py-3.5 bg-white hover:bg-gray-50 text-gray-800 font-medium rounded-xl transition shadow-sm">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Google로 계속하기</span>
          </a>
          
          <p class="text-xs text-wiki-muted mt-6 leading-relaxed">
            로그인하면 <a href="/terms" class="text-wiki-primary hover:underline py-1 inline-block">이용약관</a> 및 
            <a href="/privacy" class="text-wiki-primary hover:underline py-1 inline-block">개인정보처리방침</a>에 동의하게 됩니다.
          </p>
        </div>
      </div>
    </div>
  `
  
  return c.html(
    renderLayoutWithContext(c,
      content,
      '로그인 - Careerwiki',
      'Careerwiki에 로그인하세요'
    )
  )
})

// 이용약관 페이지
app.get('/terms', (c) => {
  const content = `
    <div class="max-w-4xl mx-auto px-4 py-12">
      <header class="mb-10">
        <h1 class="text-3xl font-bold text-white mb-3">이용약관</h1>
        <p class="text-wiki-muted">최종 수정일: 2024년 11월 30일</p>
      </header>
      
      <div class="prose prose-invert max-w-none space-y-8 text-wiki-text">
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제1조 (목적)</h2>
          <p class="leading-relaxed">
            이 약관은 CareerWiki(이하 "회사")가 제공하는 커리어 정보 서비스(이하 "서비스")의 이용조건 및 절차, 
            회사와 이용자의 권리·의무 및 책임사항을 규정함을 목적으로 합니다.
          </p>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제2조 (정의)</h2>
          <ul class="list-disc list-inside space-y-2">
            <li><strong>"서비스"</strong>란 회사가 제공하는 직업·전공 정보, HowTo 가이드, 커뮤니티 기능 등 일체의 서비스를 의미합니다.</li>
            <li><strong>"이용자"</strong>란 이 약관에 따라 회사가 제공하는 서비스를 이용하는 회원 및 비회원을 말합니다.</li>
            <li><strong>"회원"</strong>이란 회사에 개인정보를 제공하여 회원등록을 한 자로서, 서비스를 계속적으로 이용할 수 있는 자를 말합니다.</li>
            <li><strong>"콘텐츠"</strong>란 회원이 서비스 내에 게시한 글, 댓글, 이미지 등 모든 정보를 말합니다.</li>
          </ul>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제3조 (약관의 효력 및 변경)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>이 약관은 서비스 화면에 게시하거나 기타의 방법으로 이용자에게 공지함으로써 효력이 발생합니다.</li>
            <li>회사는 필요하다고 인정되는 경우 이 약관을 변경할 수 있으며, 변경된 약관은 제1항과 같은 방법으로 공지합니다.</li>
            <li>이용자는 변경된 약관에 동의하지 않을 경우 서비스 이용을 중단하고 탈퇴할 수 있습니다.</li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제4조 (회원가입)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>회원가입은 이용자가 약관에 동의한 후 소셜 로그인(Google)을 통해 가입 신청을 하고, 회사가 이를 승낙함으로써 체결됩니다.</li>
            <li>회사는 다음 각 호에 해당하는 신청에 대해서는 승낙하지 않거나 사후에 이용계약을 해지할 수 있습니다.
              <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>타인의 정보를 도용한 경우</li>
                <li>허위 정보를 기재한 경우</li>
                <li>서비스 운영을 방해하거나 방해할 우려가 있는 경우</li>
              </ul>
            </li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제5조 (서비스 이용)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>서비스는 회사의 업무상 또는 기술상 특별한 지장이 없는 한 연중무휴, 1일 24시간 제공함을 원칙으로 합니다.</li>
            <li>회사는 서비스 개선, 시스템 점검 등의 사유로 서비스를 일시 중단할 수 있습니다.</li>
            <li>회사는 무료로 제공하는 서비스의 일부 또는 전부를 변경, 중단, 종료할 수 있습니다.</li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제6조 (회원의 의무)</h2>
          <p class="mb-3">회원은 다음 각 호의 행위를 하여서는 안 됩니다.</p>
          <ul class="list-disc list-inside space-y-2">
            <li>타인의 정보 도용</li>
            <li>회사가 게시한 정보의 무단 변경</li>
            <li>회사가 허용하지 않은 정보의 송신 또는 게시</li>
            <li>회사 및 제3자의 저작권 등 지적재산권 침해</li>
            <li>회사 및 제3자의 명예를 손상시키거나 업무를 방해하는 행위</li>
            <li>음란·폭력적인 콘텐츠 게시</li>
            <li>서비스의 안정적인 운영을 방해하는 행위</li>
          </ul>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제7조 (콘텐츠의 관리)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>회원이 게시한 콘텐츠의 저작권은 해당 회원에게 귀속됩니다.</li>
            <li>회사는 회원이 게시한 콘텐츠가 다음 각 호에 해당하는 경우 사전 통지 없이 삭제하거나 블라인드 처리할 수 있습니다.
              <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>타인의 명예를 훼손하거나 권리를 침해하는 내용</li>
                <li>불법 정보 또는 음란물</li>
                <li>영리 목적의 광고성 게시물</li>
                <li>기타 관련 법령 또는 이 약관에 위반되는 내용</li>
              </ul>
            </li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제8조 (면책조항)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>회사는 천재지변, 전쟁, 기간통신사업자의 서비스 중단 등 불가항력으로 인한 서비스 중단에 대해 책임을 지지 않습니다.</li>
            <li>회사는 이용자가 서비스를 이용하여 기대하는 결과를 얻지 못한 것에 대해 책임을 지지 않습니다.</li>
            <li>회사는 이용자가 게시한 정보의 신뢰성, 정확성에 대해 책임을 지지 않습니다.</li>
            <li>회사가 제공하는 직업·전공 정보는 참고용이며, 실제 의사결정에 대한 책임은 이용자에게 있습니다.</li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제9조 (분쟁 해결)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>회사와 이용자 간에 발생한 분쟁에 관한 소송은 대한민국 서울중앙지방법원을 관할 법원으로 합니다.</li>
            <li>회사와 이용자 간의 분쟁에는 대한민국 법을 적용합니다.</li>
          </ol>
        </section>
        
        <section class="pt-6 border-t border-wiki-border/40">
          <p class="text-sm text-wiki-muted">
            <strong>부칙</strong><br>
            이 약관은 2024년 11월 30일부터 시행합니다.
          </p>
        </section>
      </div>
    </div>
  `
  
  return c.html(
    renderLayoutWithContext(c, content, '이용약관 - Careerwiki', 'Careerwiki 서비스 이용약관')
  )
})

// 개인정보처리방침 페이지
app.get('/privacy', (c) => {
  const content = `
    <div class="max-w-4xl mx-auto px-4 py-12">
      <header class="mb-10">
        <h1 class="text-3xl font-bold text-white mb-3">개인정보처리방침</h1>
        <p class="text-wiki-muted">최종 수정일: 2024년 11월 30일</p>
      </header>
      
      <div class="prose prose-invert max-w-none space-y-8 text-wiki-text">
        <section>
          <p class="leading-relaxed">
            CareerWiki(이하 "회사")는 개인정보보호법, 정보통신망 이용촉진 및 정보보호 등에 관한 법률 등 
            관련 법령에 따라 이용자의 개인정보를 보호하고, 이와 관련한 고충을 신속하고 원활하게 처리할 수 있도록 
            다음과 같이 개인정보처리방침을 수립·공개합니다.
          </p>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제1조 (수집하는 개인정보 항목)</h2>
          <p class="mb-3">회사는 서비스 제공을 위해 다음의 개인정보를 수집합니다.</p>
          
          <div class="bg-wiki-card/30 border border-wiki-border/40 rounded-xl p-5 space-y-4">
            <div>
              <h4 class="font-semibold text-white mb-2">1. 회원가입 시 (Google 소셜 로그인)</h4>
              <ul class="list-disc list-inside text-sm space-y-1">
                <li><strong>필수항목:</strong> 이메일 주소, 이름(닉네임), 프로필 이미지</li>
                <li><strong>자동수집:</strong> 서비스 이용 기록, 접속 로그, 쿠키, 접속 IP 정보</li>
              </ul>
            </div>
            <div>
              <h4 class="font-semibold text-white mb-2">2. 서비스 이용 과정</h4>
              <ul class="list-disc list-inside text-sm space-y-1">
                <li>게시글, 댓글 작성 시: 작성 내용, 작성 시간</li>
                <li>익명 게시 시: IP 주소 해시값 (복호화 불가)</li>
              </ul>
            </div>
          </div>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제2조 (개인정보의 수집 및 이용목적)</h2>
          <ul class="list-disc list-inside space-y-2">
            <li><strong>회원 관리:</strong> 회원제 서비스 이용에 따른 본인확인, 개인식별, 불량회원 관리</li>
            <li><strong>서비스 제공:</strong> 콘텐츠 제공, 맞춤형 서비스 제공</li>
            <li><strong>서비스 개선:</strong> 서비스 이용 통계 분석, 신규 서비스 개발</li>
            <li><strong>고객 응대:</strong> 문의사항 처리, 공지사항 전달</li>
          </ul>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제3조 (개인정보의 보유 및 이용기간)</h2>
          <p class="mb-3">회사는 원칙적으로 개인정보 수집 및 이용목적이 달성된 후에는 해당 정보를 지체 없이 파기합니다.</p>
          
          <div class="bg-wiki-card/30 border border-wiki-border/40 rounded-xl p-5 space-y-3">
            <div class="flex items-start gap-3">
              <span class="px-2 py-1 bg-wiki-primary/20 text-wiki-primary text-xs font-medium rounded">회원 탈퇴 시</span>
              <span class="text-sm">즉시 파기 (단, 관계 법령에 따라 보존이 필요한 경우 해당 기간까지 보관)</span>
            </div>
            <div class="flex items-start gap-3">
              <span class="px-2 py-1 bg-wiki-primary/20 text-wiki-primary text-xs font-medium rounded">접속 기록</span>
              <span class="text-sm">3개월 (통신비밀보호법)</span>
            </div>
            <div class="flex items-start gap-3">
              <span class="px-2 py-1 bg-wiki-primary/20 text-wiki-primary text-xs font-medium rounded">계약/청약철회 기록</span>
              <span class="text-sm">5년 (전자상거래법)</span>
            </div>
          </div>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제4조 (개인정보의 제3자 제공)</h2>
          <p class="leading-relaxed">
            회사는 원칙적으로 이용자의 개인정보를 외부에 제공하지 않습니다. 
            다만, 다음의 경우에는 예외로 합니다.
          </p>
          <ul class="list-disc list-inside space-y-2 mt-3">
            <li>이용자가 사전에 동의한 경우</li>
            <li>법령의 규정에 의거하거나, 수사 목적으로 법령에 정해진 절차와 방법에 따라 수사기관의 요구가 있는 경우</li>
          </ul>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제5조 (개인정보 처리의 위탁)</h2>
          <p class="mb-3">회사는 서비스 제공을 위해 다음과 같이 개인정보 처리업무를 위탁하고 있습니다.</p>
          
          <div class="overflow-x-auto">
            <table class="w-full text-sm border border-wiki-border/40 rounded-xl overflow-hidden">
              <thead class="bg-wiki-card/50">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold text-white">수탁업체</th>
                  <th class="px-4 py-3 text-left font-semibold text-white">위탁 업무</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-t border-wiki-border/40">
                  <td class="px-4 py-3">Google LLC</td>
                  <td class="px-4 py-3">소셜 로그인 인증</td>
                </tr>
                <tr class="border-t border-wiki-border/40">
                  <td class="px-4 py-3">Cloudflare Inc.</td>
                  <td class="px-4 py-3">서비스 호스팅, CDN 제공</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제6조 (이용자의 권리와 행사방법)</h2>
          <p class="mb-3">이용자는 언제든지 다음의 권리를 행사할 수 있습니다.</p>
          <ul class="list-disc list-inside space-y-2">
            <li><strong>열람권:</strong> 자신의 개인정보에 대한 열람을 요청할 수 있습니다.</li>
            <li><strong>정정권:</strong> 자신의 개인정보에 오류가 있을 경우 정정을 요청할 수 있습니다.</li>
            <li><strong>삭제권:</strong> 자신의 개인정보 삭제를 요청할 수 있습니다.</li>
            <li><strong>처리정지권:</strong> 자신의 개인정보 처리 정지를 요청할 수 있습니다.</li>
          </ul>
          <p class="mt-3 text-sm text-wiki-muted">
            위 권리 행사는 서비스 내 설정 메뉴 또는 이메일(contact@careerwiki.org)을 통해 가능합니다.
          </p>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제7조 (쿠키의 사용)</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li><strong>쿠키 사용 목적:</strong> 로그인 상태 유지, 이용자 맞춤형 서비스 제공</li>
            <li><strong>쿠키 관리:</strong> 이용자는 웹 브라우저 설정을 통해 쿠키 저장을 거부하거나 삭제할 수 있습니다. 다만, 쿠키 저장을 거부할 경우 일부 서비스 이용에 제한이 있을 수 있습니다.</li>
          </ol>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제8조 (개인정보의 안전성 확보조치)</h2>
          <p class="mb-3">회사는 개인정보의 안전성 확보를 위해 다음과 같은 조치를 취하고 있습니다.</p>
          <ul class="list-disc list-inside space-y-2">
            <li>개인정보 암호화 저장 및 전송 시 SSL/TLS 암호화</li>
            <li>해킹 등에 대비한 기술적 대책</li>
            <li>개인정보 접근 권한 최소화</li>
            <li>정기적인 보안 점검</li>
          </ul>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제9조 (개인정보 보호책임자)</h2>
          <div class="bg-wiki-card/30 border border-wiki-border/40 rounded-xl p-5">
            <p class="mb-2"><strong>개인정보 보호책임자</strong></p>
            <ul class="text-sm space-y-1">
              <li>담당: CareerWiki 개인정보보호팀</li>
              <li>이메일: contact@careerwiki.org</li>
            </ul>
            <p class="mt-4 text-sm text-wiki-muted">
              개인정보 처리에 관한 불만 처리 및 피해 구제를 위해 아래 기관에 문의하실 수 있습니다.
            </p>
            <ul class="text-sm mt-2 space-y-1">
              <li>개인정보침해신고센터: (국번없이) 118</li>
              <li>개인정보분쟁조정위원회: 1833-6972</li>
            </ul>
          </div>
        </section>
        
        <section>
          <h2 class="text-xl font-semibold text-white mb-4">제10조 (방침의 변경)</h2>
          <p class="leading-relaxed">
            이 개인정보처리방침은 법령·정책 또는 보안기술의 변경에 따라 내용이 추가·삭제 및 수정될 수 있으며, 
            변경 시에는 서비스 내 공지사항을 통해 고지합니다.
          </p>
        </section>
        
        <section class="pt-6 border-t border-wiki-border/40">
          <p class="text-sm text-wiki-muted">
            <strong>부칙</strong><br>
            이 개인정보처리방침은 2024년 11월 30일부터 시행합니다.
          </p>
        </section>
      </div>
    </div>
  `
  
  return c.html(
    renderLayoutWithContext(c, content, '개인정보처리방침 - Careerwiki', 'Careerwiki 개인정보처리방침')
  )
})

// 내 작성 가이드 목록 페이지 - /user/drafts로 리다이렉트
app.get('/howto/my-drafts', requireAuth, (c) => {
  const filter = c.req.query('filter')
  return c.redirect(filter ? `/user/drafts?filter=${filter}` : '/user/drafts')
})

// 내 작성 가이드 목록 페이지 (새 URL)
app.get('/user/drafts', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/auth/google?return_url=/user/drafts')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // 내 가이드 조회 (draft_published + published)
  const allGuidesResult = await c.env.DB.prepare(`
    SELECT id, slug, title, summary, status, created_at, updated_at
    FROM pages 
    WHERE page_type = 'guide' AND author_id = ? AND status IN ('published', 'draft_published')
    ORDER BY created_at DESC
  `).bind(user.id).all()
  const allGuides = allGuidesResult.results || []
  const draftPublished = allGuides.filter((p: any) => p.status === 'draft_published')
  const published = allGuides.filter((p: any) => p.status === 'published')
  
  // 필터 적용
  const showDraftPublished = filter === 'all' || filter === 'draft_published'
  const showPublished = filter === 'all' || filter === 'published'
  
  const innerContent = `
      <div class="flex items-center justify-between gap-4 mb-6">
        <p class="text-wiki-muted">임시 발행 및 발행한 가이드를 관리합니다</p>
        <a href="/howto/write" class="px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition flex items-center gap-2 shrink-0 text-sm">
          <i class="fas fa-plus"></i>
          새 가이드 작성
        </a>
      </div>
      
      <!-- 필터 탭 -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4">
        <a href="/user/drafts?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          전체 <span class="ml-1 opacity-70">(${allGuides.length})</span>
        </a>
        <a href="/user/drafts?filter=draft_published" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'draft_published' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          임시 발행 <span class="ml-1 opacity-70">(${draftPublished.length})</span>
        </a>
        <a href="/user/drafts?filter=published" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'published' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          발행됨 <span class="ml-1 opacity-70">(${published.length})</span>
        </a>
      </div>
      
        <div class="space-y-4">
        <!-- 임시 발행된 가이드 -->
        ${showDraftPublished && draftPublished.length > 0 ? draftPublished.map((p: any) => `
          <div class="p-4 bg-wiki-card/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
            <div class="flex items-start justify-between gap-4">
              <a href="/howto/${p.slug}" class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-white group-hover:text-wiki-primary transition truncate">
                  ${escapeHtml(p.title || '제목 없음')}
                </h3>
                ${p.summary ? `<p class="text-sm text-wiki-muted mt-1 line-clamp-2">${escapeHtml(p.summary)}</p>` : ''}
                <div class="flex items-center gap-3 mt-2 text-xs text-wiki-muted">
                  <span>
                    <i class="far fa-clock mr-1"></i>
                    ${p.created_at ? formatDateSafe(p.created_at) : '날짜 없음'}
                  </span>
                  <span class="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-400 border border-purple-500/30">
                    <i class="fas fa-eye-slash mr-1"></i>임시 발행
                  </span>
                </div>
              </a>
              <div class="flex items-center gap-2">
                <a href="/howto/${p.slug}/edit" class="p-2 text-wiki-muted hover:text-amber-400 transition" title="편집">
                  <i class="fas fa-edit text-sm"></i>
                </a>
                <button type="button" onclick="deletePublished(${p.id}, '${escapeHtml(p.title || '제목 없음').replace(/'/g, "\\'")}', this)" class="p-2 text-wiki-muted hover:text-red-400 transition" title="삭제">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('') : ''}
        
        <!-- 발행된 가이드 -->
        ${showPublished && published.length > 0 ? published.map((p: any) => `
          <div class="p-4 bg-wiki-card/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
            <div class="flex items-start justify-between gap-4">
              <a href="/howto/${p.slug}" class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-white group-hover:text-wiki-primary transition truncate">
                  ${escapeHtml(p.title || '제목 없음')}
                </h3>
                ${p.summary ? `<p class="text-sm text-wiki-muted mt-1 line-clamp-2">${escapeHtml(p.summary)}</p>` : ''}
                <div class="flex items-center gap-3 mt-2 text-xs text-wiki-muted">
                  <span>
                    <i class="far fa-clock mr-1"></i>
                    ${p.created_at ? formatDateSafe(p.created_at) : '날짜 없음'}
                  </span>
                  ${p.status === 'draft_published' ? `
                    <span class="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-400 border border-purple-500/30">
                      <i class="fas fa-eye-slash mr-1"></i>임시 발행
                    </span>
                  ` : `
                    <span class="px-2 py-0.5 rounded-full bg-green-500/10 text-green-400 border border-green-500/30">
                      <i class="fas fa-check-circle mr-1"></i>발행됨
                    </span>
                  `}
                </div>
              </a>
              <div class="flex items-center gap-2">
                <a href="/howto/${p.slug}/edit" class="p-2 text-wiki-muted hover:text-amber-400 transition" title="편집">
                  <i class="fas fa-edit text-sm"></i>
                </a>
                <button type="button" onclick="deletePublished(${p.id}, '${escapeHtml(p.title?.replace(/'/g, "\\'") || '')}', this)" 
                        class="p-2 text-wiki-muted hover:text-red-400 transition" title="삭제">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('') : ''}
        
        <!-- 빈 상태 -->
        ${allGuides.length === 0 || (filter === 'draft_published' && draftPublished.length === 0) || (filter === 'published' && published.length === 0) ? `
          <div class="text-center py-16">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-card/50 mb-4">
              <i class="fas fa-file-alt text-2xl text-wiki-muted"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">
              ${filter === 'draft_published' ? '임시 발행된 가이드가 없습니다' : filter === 'published' ? '발행된 가이드가 없습니다' : '아직 작성한 가이드가 없습니다'}
            </h3>
            <p class="text-wiki-muted">위의 "새 가이드 작성" 버튼을 눌러 시작하세요!</p>
          </div>
        ` : ''}
        </div>
        
        <script>
          async function deleteDraft(draftId, title, btn) {
            if (!confirm('정말 "' + title + '" 초안을 삭제하시겠습니까?\\n삭제된 초안은 복구할 수 없습니다.')) {
              return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
            
            try {
              const res = await fetch('/api/howto/drafts/' + draftId, {
                method: 'DELETE'
              });
              const data = await res.json();
              
              if (data.success) {
                const card = btn.closest('[data-draft-id]');
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';
                card.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                  card.remove();
                if (!document.querySelector('[data-draft-id]') && !document.querySelector('.space-y-4 > div:not([data-draft-id])')) {
                    location.reload();
                  }
                }, 300);
              } else {
                alert(data.error || '삭제에 실패했습니다.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
              }
            } catch (err) {
              alert('네트워크 오류가 발생했습니다.');
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
            }
          }
        
        async function deletePublished(pageId, title, btn) {
          if (!confirm('정말 "' + title + '" 가이드를 삭제하시겠습니까?\\n삭제된 가이드는 복구할 수 없습니다.')) {
            return;
          }
          
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
          
          try {
            const res = await fetch('/api/howto/' + pageId, {
              method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.success) {
              const card = btn.closest('.bg-wiki-card\\\\/50');
              if (card) {
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';
                card.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                  card.remove();
                  location.reload();
                }, 300);
              } else {
                location.reload();
              }
            } else {
              alert(data.error || '삭제에 실패했습니다.');
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
            }
          } catch (err) {
            alert('네트워크 오류가 발생했습니다.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
          }
        }
        </script>
  `
  
  const pageContent = renderUserLayoutContent({
    title: '작성 가이드',
    currentPath: '/user/drafts',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, '작성 가이드 - 마이페이지 - Careerwiki', '내 초안과 가이드를 관리합니다')
  )
})

// HowTo 작성 페이지 (로그인 필수) - Tiptap 에디터
// 페이지 접속 시에는 초안 생성하지 않음. 저장 버튼 클릭 시에만 초안 생성
app.get('/howto/write', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/howto/write')
  }
  
  // 초안 없이 빈 에디터 페이지 렌더링
    const content = `
    <!-- Tiptap CDN -->
    <link rel="stylesheet" href="/static/howto-editor.css">
    
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
      <!-- 헤더 -->
      <header class="mb-6">
        <!-- 상단: 뒤로가기 + 제목 -->
        <div class="flex items-center gap-3 mb-3">
          <a href="/howto" class="flex items-center justify-center w-10 h-10 min-w-[44px] min-h-[44px] text-wiki-muted hover:text-white hover:bg-wiki-border/30 rounded-xl transition shrink-0">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div class="min-w-0 flex-1">
            <h1 class="text-xl sm:text-2xl font-bold text-white leading-tight">가이드 작성</h1>
            <p class="text-xs sm:text-sm text-wiki-muted mt-0.5" id="save-status">
              <span class="text-gray-400">●</span> 새 문서
            </p>
          </div>
        </div>
        
        <!-- 하단: 액션 버튼 (모바일에서도 텍스트 표시) -->
        <div class="flex items-center gap-2 sm:gap-3">
          <button type="button" id="btn-save" class="flex-1 sm:flex-none px-4 py-2.5 min-h-[44px] border border-wiki-border/60 text-wiki-muted hover:text-white hover:bg-wiki-border/20 rounded-xl transition text-sm font-medium flex items-center justify-center gap-2">
            <i class="fas fa-save"></i>
            <span>임시저장</span>
          </button>
          <button type="button" id="btn-publish" class="flex-1 sm:flex-none px-4 sm:px-5 py-2.5 min-h-[44px] bg-gradient-to-r from-wiki-primary to-blue-500 hover:from-wiki-primary/90 hover:to-blue-500/90 text-white rounded-xl transition text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-wiki-primary/20">
            <i class="fas fa-paper-plane"></i>
            <span>발행하기</span>
          </button>
        </div>
      </header>
      
      <!-- 메타 필드 -->
      <div class="grid gap-4 mb-6">
        <!-- 제목 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">제목 *</label>
          <div class="relative">
            <input type="text" id="field-title" maxlength="100"
                   class="w-full px-4 py-3 pr-10 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white text-lg font-semibold placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                   placeholder="가이드 제목을 입력하세요"
                   value="" />
            <span id="title-check" class="absolute right-3 top-1/2 -translate-y-1/2 text-lg hidden">
              <i class="fas fa-spinner fa-spin text-wiki-muted" id="title-loading"></i>
              <i class="fas fa-check-circle text-green-500 hidden" id="title-ok"></i>
              <i class="fas fa-times-circle text-red-500 hidden" id="title-error"></i>
            </span>
          </div>
          <p id="title-error-msg" class="mt-1 text-xs text-red-400 hidden"></p>
        </div>
        
        <!-- 요약 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">요약</label>
          <textarea id="field-summary" maxlength="300" rows="2"
                    class="w-full px-4 py-3 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition resize-none"
                    placeholder="이 가이드가 어떤 내용을 다루는지 간략히 설명해주세요"></textarea>
        </div>
        
        <!-- 썸네일 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">썸네일 <span class="text-wiki-muted font-normal">(선택)</span></label>
          <div id="thumbnail-upload-area" class="border-2 border-dashed border-wiki-border/40 rounded-xl p-4 text-center hover:border-wiki-primary/50 transition cursor-pointer">
            <div id="thumbnail-placeholder" class="space-y-2">
              <i class="fas fa-image text-3xl text-wiki-muted"></i>
              <p class="text-sm text-wiki-muted">클릭하여 이미지 업로드 또는 드래그 앤 드롭</p>
              <p class="text-xs text-wiki-muted/60">없으면 본문의 첫 번째 이미지가 자동으로 사용됩니다</p>
            </div>
            <div id="thumbnail-preview" class="hidden">
              <img id="thumbnail-img" src="" alt="썸네일 미리보기" class="max-h-48 mx-auto rounded-lg" />
              <button type="button" id="thumbnail-remove" class="mt-2 text-sm text-red-400 hover:text-red-300">
                <i class="fas fa-times mr-1"></i>썸네일 제거
              </button>
            </div>
          </div>
          <input type="file" id="thumbnail-input" accept="image/*" class="hidden" />
          <input type="hidden" id="field-thumbnail" value="" />
        </div>
        
        <!-- 태그 & 관련 콘텐츠 -->
        <div class="grid md:grid-cols-2 gap-4">
          <!-- 태그 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">태그</label>
            <div class="relative">
              <input type="text" id="field-tags"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="태그 입력 후 Enter 또는 쉼표(,)"
                     data-tags='[]' />
              <div id="tags-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
          
          <!-- 관련 직업 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 직업</label>
            <div class="relative">
              <input type="text" id="field-jobs" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="직업 검색..."
                     data-items='[]' />
              <div id="jobs-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="jobs-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <!-- 관련 전공 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 전공</label>
            <div class="relative">
              <input type="text" id="field-majors" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="전공 검색..."
                     data-items='[]' />
              <div id="majors-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="majors-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
          
          <!-- 관련 HowTo -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 HowTo</label>
            <div class="relative">
              <input type="text" id="field-howtos" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="HowTo 검색..."
                     data-items='[]' />
              <div id="howtos-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="howtos-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 본문 영역 -->
      <div>
        <label class="block text-sm font-medium text-wiki-text mb-2">본문 *</label>
        
        <!-- 에디터 툴바 -->
        <div id="toolbar" class="howto-editor-toolbar bg-wiki-card/50 border border-wiki-border/40 rounded-t-xl px-3 py-2">
          <div class="toolbar-group">
            <button type="button" data-action="bold" title="굵게 (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button type="button" data-action="italic" title="기울임 (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button type="button" data-action="underline" title="밑줄 (Ctrl+U)"><i class="fas fa-underline"></i></button>
            <button type="button" data-action="strike" title="취소선"><i class="fas fa-strikethrough"></i></button>
          </div>
          <div class="toolbar-group">
            <!-- 폰트 -->
            <div class="toolbar-dropdown font-dropdown">
              <button type="button" title="폰트" class="toolbar-btn flex items-center gap-1.5"><span class="current-font-name">기본</span><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="font-menu hidden">
                <button type="button" data-font="inherit" class="is-active">기본</button>
                <button type="button" data-font="sans-serif">Sans-serif (샌즈)</button>
                <button type="button" data-font="serif">Serif (세리프)</button>
                <button type="button" data-font="monospace">Monospace (코드)</button>
                <button type="button" data-font="'Nanum Gothic', sans-serif">나눔고딕</button>
                <button type="button" data-font="'Nanum Myeongjo', serif">나눔명조</button>
              </div>
            </div>
            <!-- 폰트 크기 -->
            <div class="toolbar-dropdown size-dropdown">
              <button type="button" title="글자 크기" class="toolbar-btn size-input-btn">
                <input type="number" class="size-input" value="15" min="6" max="72" title="글자 크기 (px)">
                <i class="fas fa-chevron-down text-[10px] opacity-60"></i>
              </button>
              <div class="size-menu hidden">
                <button type="button" data-size="8px">8</button>
                <button type="button" data-size="12px">12</button>
                <button type="button" data-size="14px">14</button>
                <button type="button" data-size="15px" class="is-default">15</button>
                <button type="button" data-size="16px">16</button>
                <button type="button" data-size="18px">18</button>
                <button type="button" data-size="20px">20</button>
                <button type="button" data-size="24px">24</button>
                <button type="button" data-size="28px">28</button>
                <button type="button" data-size="32px">32</button>
                <button type="button" data-size="36px">36</button>
              </div>
            </div>
            <!-- 폰트 색상 -->
            <div class="toolbar-dropdown color-dropdown">
              <button type="button" title="글자 색상" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-palette"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="color-menu hidden">
                <div class="color-grid">
                  <button type="button" data-color="#ffffff" style="background:#ffffff" title="흰색"></button>
                  <button type="button" data-color="#f59e0b" style="background:#f59e0b" title="주황"></button>
                  <button type="button" data-color="#ef4444" style="background:#ef4444" title="빨강"></button>
                  <button type="button" data-color="#22c55e" style="background:#22c55e" title="초록"></button>
                  <button type="button" data-color="#3b82f6" style="background:#3b82f6" title="파랑"></button>
                  <button type="button" data-color="#8b5cf6" style="background:#8b5cf6" title="보라"></button>
                  <button type="button" data-color="#ec4899" style="background:#ec4899" title="분홍"></button>
                  <button type="button" data-color="#6b7280" style="background:#6b7280" title="회색"></button>
                </div>
                <button type="button" data-color="" class="color-reset">기본 색상</button>
              </div>
            </div>
          </div>
          <div class="toolbar-group">
            <!-- 정렬 -->
            <div class="toolbar-dropdown align-dropdown">
              <button type="button" title="정렬" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-align-left"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="align-menu hidden">
                <button type="button" data-action="alignLeft"><i class="fas fa-align-left"></i> 왼쪽</button>
                <button type="button" data-action="alignCenter"><i class="fas fa-align-center"></i> 중앙</button>
                <button type="button" data-action="alignRight"><i class="fas fa-align-right"></i> 오른쪽</button>
              </div>
            </div>
            <!-- 커스텀 블록 -->
            <div class="toolbar-dropdown custom-block-dropdown">
              <button type="button" title="커스텀 블록" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-cube"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="toolbar-dropdown-content custom-block-menu hidden">
                <button type="button" data-action="blockquote"><i class="fas fa-quote-left text-sky-400"></i> 인용구</button>
                <button type="button" data-action="horizontalRule"><i class="fas fa-minus text-purple-400"></i> 구분선</button>
                <button type="button" data-action="checkpointBox"><i class="fas fa-check-circle text-green-500"></i> 체크포인트</button>
                <button type="button" data-action="conclusionBox"><i class="fas fa-lightbulb text-wiki-primary"></i> 결론 박스</button>
                <button type="button" data-action="qnaBlock"><i class="fas fa-question-circle text-amber-500"></i> Q&A</button>
              </div>
            </div>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="h1" title="제목 1">H1</button>
            <button type="button" data-action="h2" title="제목 2">H2</button>
            <button type="button" data-action="h3" title="제목 3">H3</button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="bulletList" title="글머리 기호"><i class="fas fa-list-ul"></i></button>
            <button type="button" data-action="orderedList" title="번호 매기기"><i class="fas fa-list-ol"></i></button>
            <button type="button" data-action="taskList" title="체크리스트"><i class="fas fa-tasks"></i></button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="link" title="외부 링크"><i class="fas fa-link"></i></button>
            <button type="button" data-action="internalLink" title="내부 링크 (직업/전공/HowTo)"><i class="fas fa-sitemap"></i></button>
            <button type="button" data-action="footnote" title="각주 (출처)"><i class="fas fa-asterisk"></i></button>
            <button type="button" data-action="image" title="이미지"><i class="fas fa-image"></i></button>
            <button type="button" data-action="table" title="표"><i class="fas fa-table"></i></button>
            <button type="button" data-action="codeBlock" title="코드 블록"><i class="fas fa-code"></i></button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="undo" title="실행 취소 (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            <button type="button" data-action="redo" title="다시 실행 (Ctrl+Y)"><i class="fas fa-redo"></i></button>
          </div>
        </div>
        
        <!-- 표 편집 툴바 (압축형) -->
        <div id="table-toolbar" class="table-toolbar">
          <div class="toolbar-dropdown row-dropdown">
            <button type="button" title="행 추가" class="toolbar-btn"><i class="fas fa-plus"></i> 행</button>
            <div class="row-menu hidden">
              <button type="button" data-action="addRowBefore"><i class="fas fa-arrow-up"></i> 위에 추가</button>
              <button type="button" data-action="addRowAfter"><i class="fas fa-arrow-down"></i> 아래에 추가</button>
            </div>
          </div>
          <div class="toolbar-dropdown col-dropdown">
            <button type="button" title="열 추가" class="toolbar-btn"><i class="fas fa-plus"></i> 열</button>
            <div class="col-menu hidden">
              <button type="button" data-action="addColBefore"><i class="fas fa-arrow-left"></i> 왼쪽에 추가</button>
              <button type="button" data-action="addColAfter"><i class="fas fa-arrow-right"></i> 오른쪽에 추가</button>
            </div>
          </div>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="deleteRow" title="행 삭제"><i class="fas fa-trash-alt"></i></button>
          <button type="button" data-action="deleteCol" title="열 삭제"><i class="fas fa-columns"></i></button>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="mergeCells" title="셀 병합"><i class="fas fa-compress-alt"></i></button>
          <button type="button" data-action="splitCell" title="셀 분할"><i class="fas fa-expand-alt"></i></button>
          <!-- 셀 배경색 -->
          <span class="toolbar-divider"></span>
          <div class="toolbar-dropdown cell-color-dropdown">
            <button type="button" title="셀 배경색" class="toolbar-btn"><i class="fas fa-fill-drip"></i></button>
            <div class="cell-color-menu hidden">
              <div class="color-grid">
                <button type="button" data-cell-bg="" style="background:transparent;border:1px dashed #666" title="없음"></button>
                <button type="button" data-cell-bg="rgba(79,143,255,0.15)" style="background:rgba(79,143,255,0.4)" title="파랑"></button>
                <button type="button" data-cell-bg="rgba(34,197,94,0.15)" style="background:rgba(34,197,94,0.4)" title="초록"></button>
                <button type="button" data-cell-bg="rgba(245,158,11,0.15)" style="background:rgba(245,158,11,0.4)" title="주황"></button>
                <button type="button" data-cell-bg="rgba(239,68,68,0.15)" style="background:rgba(239,68,68,0.4)" title="빨강"></button>
                <button type="button" data-cell-bg="rgba(139,92,246,0.15)" style="background:rgba(139,92,246,0.4)" title="보라"></button>
              </div>
            </div>
          </div>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="deleteTable" title="표 삭제" class="text-red-400"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- 에디터 본문 -->
        <div id="editor" class="howto-editor-content bg-wiki-card/50 border border-wiki-border/40 border-t-0 rounded-b-xl"></div>
      </div>
      
      <!-- 출처 섹션 -->
      <div id="footnotes-section" class="editor-footnotes-section">
        <h4><i class="fas fa-book-open"></i> 출처</h4>
        <div id="footnotes-list" class="editor-footnotes-list">
          <div class="editor-footnotes-empty">
            <i class="fas fa-quote-right"></i>
            <p>각주를 추가하면 여기에 출처가 표시됩니다.</p>
          </div>
        </div>
      </div>
      
      <div id="editor-message" class="hidden mt-4"></div>
    </div>
    
    <!-- Tiptap 에디터 번들 -->
    <script src="/static/editor.bundle.iife.js"></script>
    
    <script>
      // 에디터 데이터 (초안 없음)
      let DRAFT_ID = null;
      let currentVersion = 1;
      let hasUnsavedChanges = false;
      let tiptapEditor = null;
      
      // 페이지 나가기 경고
      const beforeUnloadHandler = (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '저장하지 않은 변경사항이 있습니다. 정말 나가시겠습니까?';
          return e.returnValue;
        }
      };
      window.addEventListener('beforeunload', beforeUnloadHandler);
      
      // 에디터 초기화
      document.addEventListener('DOMContentLoaded', async () => {
        if (window.HowToEditor) {
          tiptapEditor = new window.HowToEditor({
            container: '#editor',
            draftId: null, // 초안 없음
            version: 1,
            initialContent: '<p></p>',
            onSave: (data) => {
              if (data.success) {
                currentVersion = data.version;
                hasUnsavedChanges = false;
                updateSaveStatus('saved');
              }
            },
            onError: (err) => {
              showMessage('error', err.message);
              updateSaveStatus('error');
            },
            onUpdate: () => {
              hasUnsavedChanges = true;
              updateSaveStatus('unsaved');
            }
          });
          window.HowToEditorInstance = tiptapEditor;
        }
        
        initAutocomplete();
        initTags();
        initThumbnail();
        setupToolbarDropdowns();
        initTitleCheck();
        
        // 저장 버튼
        document.getElementById('btn-save')?.addEventListener('click', saveDraft);
        
        // 발행 버튼
        document.getElementById('btn-publish')?.addEventListener('click', publishGuide);
        
        // 각주 목록 업데이트 이벤트 수신
        window.addEventListener('footnotes-updated', function(e) {
          var footnotes = e.detail.footnotes || [];
          var container = document.getElementById('footnotes-list');
          if (!container) return;
          
          function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
          }
          
          if (footnotes.length === 0) {
            container.innerHTML = '<div class="editor-footnotes-empty"><i class="fas fa-quote-right"></i><p>각주를 추가하면 여기에 출처가 표시됩니다.</p></div>';
          } else {
            container.innerHTML = footnotes.map(function(f) {
              var urlHtml = f.url ? '<a href="' + esc(f.url) + '" target="_blank" class="editor-footnote-url">' + esc(f.url) + '</a>' : '';
              return '<div class="editor-footnote-item" data-id="' + f.id + '">' +
                '<span class="editor-footnote-id">' + f.id + '</span>' +
                '<div class="editor-footnote-content">' +
                  '<div class="editor-footnote-text">' + esc(f.text) + '</div>' +
                  urlHtml +
                '</div>' +
              '</div>';
            }).join('');
          }
        });
      });
      
      // 툴바 드롭다운 설정
      function setupToolbarDropdowns() {
        const menuSelector = '.align-menu, .font-menu, .custom-block-menu, .color-menu, .size-menu, .row-menu, .col-menu, .cell-color-menu, .border-style-menu';
        
        document.querySelectorAll('.toolbar-dropdown').forEach(dropdown => {
          const btn = dropdown.querySelector('.toolbar-btn');
          const menu = dropdown.querySelector(menuSelector);
          if (!btn || !menu) return;
          
          let isOpen = false;
          let hoverTimeout = null;
          
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            isOpen = !isOpen;
            dropdown.classList.toggle('is-open', isOpen);
            if (isOpen) {
              menu.classList.remove('hidden');
              document.querySelectorAll('.toolbar-dropdown').forEach(other => {
                if (other !== dropdown) {
                  other.classList.remove('is-open');
                  const otherMenu = other.querySelector(menuSelector);
                  if (otherMenu) otherMenu.classList.add('hidden');
                }
              });
            } else {
              menu.classList.add('hidden');
            }
          });
          
          dropdown.addEventListener('mouseenter', () => {
            clearTimeout(hoverTimeout);
            menu.classList.remove('hidden');
          });
          
          dropdown.addEventListener('mouseleave', () => {
            if (!isOpen) {
              hoverTimeout = setTimeout(() => {
                menu.classList.add('hidden');
              }, 300);
            }
          });
          
          menu.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
              isOpen = false;
              dropdown.classList.remove('is-open');
              setTimeout(() => menu.classList.add('hidden'), 100);
            }
          });
        });
        
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.toolbar-dropdown')) {
            document.querySelectorAll('.toolbar-dropdown').forEach(dropdown => {
              dropdown.classList.remove('is-open');
              const menu = dropdown.querySelector(menuSelector);
              if (menu) menu.classList.add('hidden');
            });
          }
        });
        
        // 폰트/크기 관련 이벤트는 에디터에서 처리
      }
      
      function updateSaveStatus(status) {
        const el = document.getElementById('save-status');
        if (!el) return;
        switch(status) {
          case 'saving':
            el.innerHTML = '<span class="text-blue-400">●</span> 저장 중...';
            break;
          case 'saved':
            el.innerHTML = '<span class="text-green-400">●</span> 저장됨';
            break;
          case 'unsaved':
            el.innerHTML = '<span class="text-amber-400">●</span> 저장되지 않음';
            break;
          case 'error':
            el.innerHTML = '<span class="text-red-400">●</span> 저장 실패';
            break;
        }
      }
      
      function showMessage(type, msg) {
        const el = document.getElementById('editor-message');
        if (!el) return;
        el.className = 'mt-4 p-4 rounded-lg text-sm ' + 
          (type === 'error' ? 'bg-red-500/10 border border-red-500/30 text-red-400' : 
           type === 'success' ? 'bg-green-500/10 border border-green-500/30 text-green-400' : 
           'bg-blue-500/10 border border-blue-500/30 text-blue-400');
        el.textContent = msg;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
      }
      
      // 필드별 에러 표시
      function showFieldError(fieldId, msg) {
        clearFieldError(fieldId);
        const field = document.getElementById(fieldId);
        if (!field) return;
        field.dataset.error = 'true';
        field.style.borderColor = 'rgba(239, 68, 68, 0.6)';
        const errorEl = document.createElement('p');
        errorEl.className = 'field-error text-red-400 text-xs mt-1';
        errorEl.textContent = msg;
        field.parentElement.appendChild(errorEl);
      }
      
      function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        delete field.dataset.error;
        field.style.borderColor = '';
        const existingError = field.parentElement.querySelector('.field-error');
        if (existingError) existingError.remove();
      }
      
      function clearAllFieldErrors() {
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('[data-error="true"]').forEach(el => {
          delete el.dataset.error;
          el.style.borderColor = '';
        });
      }
      
      // 유효성 검사 (초성만 입력 등 체크)
      function validateTitle(title) {
        if (!title) return '제목을 입력해주세요.';
        if (title.length < 2) return '제목은 2자 이상이어야 합니다.';
        // 초성만 있는지 체크 (ㄱ-ㅎ만으로 이루어진 경우)
        if (/^[ㄱ-ㅎ]+$/.test(title)) return '제목에 초성만 입력할 수 없습니다.';
        return null;
      }
      
      function validateContent(html) {
        if (!html || html === '<p></p>' || html === '<p><br></p>') return '본문을 입력해주세요.';
        // 초성만 있는지 체크
        const textOnly = html.replace(/<[^>]*>/g, '').trim();
        if (/^[ㄱ-ㅎ\s]+$/.test(textOnly)) return '본문에 초성만 입력할 수 없습니다.';
        return null;
      }
      
      // 제목 중복 체크 상태
      let titleCheckTimer = null;
      let isTitleAvailable = true;
      
      function initTitleCheck() {
        const titleInput = document.getElementById('field-title');
        const titleCheck = document.getElementById('title-check');
        const titleLoading = document.getElementById('title-loading');
        const titleOk = document.getElementById('title-ok');
        const titleError = document.getElementById('title-error');
        const titleErrorMsg = document.getElementById('title-error-msg');
        
        if (!titleInput) return;
        
        titleInput.addEventListener('input', () => {
          hasUnsavedChanges = true;
          updateSaveStatus('unsaved');
          
          clearTimeout(titleCheckTimer);
          const title = titleInput.value.trim();
          
          // 빈 값이면 숨김
          if (!title) {
            titleCheck.classList.add('hidden');
            titleErrorMsg.classList.add('hidden');
            isTitleAvailable = true;
            return;
          }
          
          // 2자 미만이면 바로 에러
          if (title.length < 2) {
            titleCheck.classList.remove('hidden');
            titleLoading.classList.add('hidden');
            titleOk.classList.add('hidden');
            titleError.classList.remove('hidden');
            titleErrorMsg.textContent = '제목은 최소 2자 이상이어야 합니다';
            titleErrorMsg.classList.remove('hidden');
            isTitleAvailable = false;
            return;
          }
          
          // 로딩 표시
          titleCheck.classList.remove('hidden');
          titleLoading.classList.remove('hidden');
          titleOk.classList.add('hidden');
          titleError.classList.add('hidden');
          titleErrorMsg.classList.add('hidden');
          
          // 500ms 후 API 호출
          titleCheckTimer = setTimeout(async () => {
            try {
              const res = await fetch('/api/howto/check-title?title=' + encodeURIComponent(title));
              const data = await res.json();
              
              titleLoading.classList.add('hidden');
              
              if (data.success && data.available) {
                titleOk.classList.remove('hidden');
                titleError.classList.add('hidden');
                titleErrorMsg.classList.add('hidden');
                isTitleAvailable = true;
              } else {
                titleOk.classList.add('hidden');
                titleError.classList.remove('hidden');
                titleErrorMsg.textContent = data.reason || '사용할 수 없는 제목입니다';
                titleErrorMsg.classList.remove('hidden');
                isTitleAvailable = false;
              }
            } catch (err) {
              titleLoading.classList.add('hidden');
              titleOk.classList.add('hidden');
              titleError.classList.remove('hidden');
              titleErrorMsg.textContent = '제목 확인 중 오류가 발생했습니다';
              titleErrorMsg.classList.remove('hidden');
              isTitleAvailable = false;
            }
          }, 500);
        });
      }
      
      // 초안 저장 (없으면 새로 생성)
      async function saveDraft() {
        clearAllFieldErrors();
        const title = document.getElementById('field-title').value.trim();
        const summary = document.getElementById('field-summary').value.trim();
        
        const titleError = validateTitle(title);
        if (titleError) {
          showFieldError('field-title', titleError);
          showMessage('error', titleError);
          return false;
        }
        
        // 제목 중복 체크 결과 확인
        if (!isTitleAvailable) {
          showMessage('error', '이미 같은 제목의 가이드가 존재합니다. 다른 제목을 입력해주세요.');
          document.getElementById('field-title').focus();
          return false;
        }
        
        const contentHtml = tiptapEditor?.editor?.getHTML();
        const contentError = validateContent(contentHtml);
        if (contentError) {
          showMessage('error', contentError);
          return false;
        }
        
        updateSaveStatus('saving');
        
        const content = tiptapEditor?.editor?.getJSON();
        const tags = getSelectedTags();
        const relatedJobs = getSelectedItems('jobs');
        const relatedMajors = getSelectedItems('majors');
        const relatedHowtos = getSelectedItems('howtos');
        const thumbnail = getThumbnailUrl();
        
        try {
          // 저장 시 임시 발행 상태로 저장 (draft_published)
          const res = await fetch('/api/howto/save-publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              draftId: DRAFT_ID,
              title,
              summary,
              contentJson: JSON.stringify(content),
              contentHtml,
              tags,
              relatedJobs,
              relatedMajors,
              relatedHowtos,
              thumbnailUrl: thumbnail
            })
          });
          const data = await res.json();
          if (data.success) {
            hasUnsavedChanges = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.onbeforeunload = null;
            showMessage('success', '저장되었습니다! 잠시 후 이동합니다...');
            setTimeout(() => { window.location.href = '/howto/' + data.slug; }, 100);
            return true;
          } else {
            throw new Error(data.error || '저장 실패');
          }
        } catch (err) {
          showMessage('error', err.message || '저장 중 오류가 발생했습니다.');
          updateSaveStatus('error');
          return false;
        }
      }
      
      // 바로 발행하기
      async function publishGuide() {
        clearAllFieldErrors();
        const title = document.getElementById('field-title').value.trim();
        const summary = document.getElementById('field-summary').value.trim();
        
        const titleError = validateTitle(title);
        if (titleError) {
          showFieldError('field-title', titleError);
          showMessage('error', titleError);
          return;
        }
        
        // 제목 중복 체크 결과 확인
        if (!isTitleAvailable) {
          showMessage('error', '이미 같은 제목의 가이드가 존재합니다. 다른 제목을 입력해주세요.');
          document.getElementById('field-title').focus();
          return;
        }
        
        const contentHtml = tiptapEditor?.editor?.getHTML();
        const contentError = validateContent(contentHtml);
        if (contentError) {
          showMessage('error', contentError);
          return;
        }
        
        if (!confirm('이 가이드를 바로 발행하시겠습니까?\\n발행하면 목록에 공개됩니다.')) return;
        
        updateSaveStatus('saving');
        
        const content = tiptapEditor?.editor?.getJSON();
        const tags = getSelectedTags();
        const relatedJobs = getSelectedItems('jobs');
        const relatedMajors = getSelectedItems('majors');
        const relatedHowtos = getSelectedItems('howtos');
        const thumbnail = getThumbnailUrl();
        
        try {
          const publishBtn = document.getElementById('btn-publish');
          if (publishBtn) {
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>발행 중...';
          }
          
          // 바로 발행 API 호출
          const res = await fetch('/api/howto/publish-direct', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              summary,
              contentJson: JSON.stringify(content),
              contentHtml,
              tags,
              relatedJobs,
              relatedMajors,
              relatedHowtos,
              thumbnailUrl: thumbnail
            })
          });
          const data = await res.json();
          if (data.success) {
            hasUnsavedChanges = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.onbeforeunload = null;
            showMessage('success', '발행되었습니다! 잠시 후 이동합니다...');
            setTimeout(() => { window.location.href = '/howto/' + data.slug; }, 100);
          } else {
            throw new Error(data.error || '발행 실패');
          }
        } catch (err) {
          showMessage('error', err.message || '발행 중 오류가 발생했습니다.');
          const publishBtn = document.getElementById('btn-publish');
          if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.innerHTML = '<i class="fas fa-globe mr-2"></i>발행';
          }
        }
      }
      
      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }
      
      // 자동완성 초기화 (pointerdown + 이벤트 위임 + focusout 방식 + IME 지원)
      function initAutocomplete() {
        ['jobs', 'majors', 'howtos'].forEach(domain => {
          const input = document.getElementById('field-' + domain);
          const dropdown = document.getElementById(domain + '-dropdown');
          const container = document.getElementById(domain + '-container');
          if (!input || !dropdown || !container) return;
          const wrap = input.parentElement;
          
          let items = [];
          try {
            items = JSON.parse(input.dataset.items || '[]');
          } catch (e) {}
          
          items.forEach(item => addItemChip(container, item, domain));
          
          let debounceTimer = null;
          let composingTimer = null;
          let abortController = null;
          let lastSearchValue = '';
          
          // 검색 실행 함수
          const doSearch = async (q) => {
            if (q.length < 2) {
              dropdown.classList.add('hidden');
              dropdown.innerHTML = '';
              return;
            }
            
            // 이미 같은 값으로 검색했으면 스킵
            if (q === lastSearchValue) return;
            lastSearchValue = q;
            
            try {
              if (abortController) abortController.abort();
              abortController = new AbortController();
              
              const res = await fetch('/api/search?domain=' + domain + '&q=' + encodeURIComponent(q) + '&limit=10', {
                signal: abortController.signal
              });
              const data = await res.json();
              
              if (data.success && data.results && data.results.length > 0) {
                dropdown.innerHTML = data.results.map(r => 
                  '<div class="autocomplete-item" data-id="' + (r.id || r.slug) + '" data-name="' + escapeHtml(r.name || r.title) + '" data-slug="' + escapeHtml(r.slug || r.name) + '">' +
                  '<span class="text-white">' + escapeHtml(r.name || r.title) + '</span>' +
                  (r.snippet ? '<br><span class="text-xs text-wiki-muted">' + escapeHtml(r.snippet) + '</span>' : '') +
                  '</div>'
                ).join('');
                dropdown.classList.remove('hidden');
              } else {
                dropdown.classList.add('hidden');
                dropdown.innerHTML = '';
              }
            } catch (err) {
              if (err?.name !== 'AbortError') {
                console.error('[autocomplete] Error:', err);
              }
            }
          };
          
          // 모든 입력에 대해 1초 후 자동 검색 (한글 조합 중에도)
          input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            clearTimeout(composingTimer);
            const q = input.value.trim();
            
            // 1초 후 자동 검색 (한글 조합 중에도 동작)
            composingTimer = setTimeout(() => doSearch(q), 1000);
            
            // 영어 등 비조합 입력은 300ms 후 빠르게 검색
            debounceTimer = setTimeout(() => {
              const currentQ = input.value.trim();
              if (currentQ.length >= 2) {
                doSearch(currentQ);
              }
            }, 300);
          });
          
          dropdown.addEventListener('pointerdown', (e) => {
            const el = e.target.closest('.autocomplete-item');
            if (!el) return;
            e.preventDefault();
            e.stopPropagation();
            
            const item = { id: el.dataset.id, name: el.dataset.name, slug: el.dataset.slug };
            
            // 중복 체크
            const existing = container.querySelector('[data-id="' + item.id + '"]');
            if (!existing) {
              addItemChip(container, item, domain);
            }
            
            input.value = '';
            dropdown.innerHTML = '';
            dropdown.classList.add('hidden');
            input.focus();
          });
          
          const handleFocusOut = (evt) => {
            const next = evt.relatedTarget;
            const isInside = wrap ? wrap.contains(next) : (input === next || dropdown.contains(next));
            if (!isInside) {
              dropdown.classList.add('hidden');
            }
          };
          (wrap || input).addEventListener('focusout', handleFocusOut);
        });
      }
      
      function addItemChip(container, item, domain) {
        // 중복 체크
        const existingChip = container.querySelector('[data-id="' + item.id + '"]');
        if (existingChip) return;
        
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-wiki-primary/10 border border-wiki-primary/30 rounded-lg text-xs text-wiki-primary';
        chip.dataset.id = item.id;
        chip.dataset.name = item.name || item.title || '';
        chip.dataset.slug = item.slug || '';
        chip.innerHTML = escapeHtml(item.name || item.title) + '<button type="button" class="hover:text-red-400 ml-1">&times;</button>';
        
        chip.querySelector('button').addEventListener('click', () => {
          chip.remove();
        });
        
        container.appendChild(chip);
      }
      
      function getSelectedItems(domain) {
        const container = document.getElementById(domain + '-container');
        if (!container) return [];
        return Array.from(container.querySelectorAll('span[data-id]')).map(chip => ({
          id: chip.dataset.id,
          name: chip.dataset.name,
          slug: chip.dataset.slug
        }));
      }
      
      function getThumbnailUrl() {
        return thumbnailUrl;
      }
      
      // 태그 관련
      let selectedTags = [];
      
      function initTags() {
        const input = document.getElementById('field-tags');
        if (!input) return;
        
        try {
          selectedTags = JSON.parse(input.dataset.tags || '[]');
          selectedTags.forEach(tag => addTagChip(tag));
        } catch(e) {}
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const tag = input.value.replace(/,/g, '').trim();
            if (tag && !selectedTags.includes(tag)) {
              selectedTags.push(tag);
              addTagChip(tag);
              hasUnsavedChanges = true;
              updateSaveStatus('unsaved');
            }
            input.value = '';
          }
        });
      }
      
      function addTagChip(tag) {
        const container = document.getElementById('tags-container');
        if (!container) return;
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 px-3 py-1 bg-wiki-primary/10 text-wiki-primary rounded-full text-sm';
        chip.innerHTML = escapeHtml(tag) + '<button type="button" class="hover:text-red-400 ml-1" onclick="removeTag(this, \\'' + escapeHtml(tag.replace(/'/g, "\\\\'")) + '\\')"><i class="fas fa-times text-xs"></i></button>';
        container.appendChild(chip);
      }
      
      function removeTag(btn, tag) {
        selectedTags = selectedTags.filter(t => t !== tag);
        btn.parentElement.remove();
        hasUnsavedChanges = true;
        updateSaveStatus('unsaved');
      }
      
      function getSelectedTags() {
        return selectedTags;
      }
      
      // 썸네일 업로드
      let thumbnailUrl = '';
      let thumbnailInitialized = false;
      
      function initThumbnail() {
        if (thumbnailInitialized) return;
        thumbnailInitialized = true;
        
        const uploadArea = document.getElementById('thumbnail-upload-area');
        const fileInput = document.getElementById('thumbnail-input');
        const placeholder = document.getElementById('thumbnail-placeholder');
        const preview = document.getElementById('thumbnail-preview');
        const thumbnailImg = document.getElementById('thumbnail-img');
        const removeBtn = document.getElementById('thumbnail-remove');
        const hiddenField = document.getElementById('field-thumbnail');
        
        if (!uploadArea || !fileInput) return;
        
        // 클릭 시 파일 선택 (이벤트 버블링 방지)
        uploadArea.addEventListener('click', (e) => {
          // fileInput 클릭이나 removeBtn 클릭은 무시
          if (e.target === fileInput || e.target.closest('#thumbnail-remove')) return;
          e.stopPropagation();
          fileInput.click();
        }, { capture: true });
        
        // 드래그 앤 드롭
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('border-wiki-primary');
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('border-wiki-primary');
        });
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('border-wiki-primary');
          const file = e.dataTransfer?.files?.[0];
          if (file && file.type.startsWith('image/')) {
            handleThumbnailUpload(file);
          }
        });
        
        // 파일 선택
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files?.[0];
          if (file) {
            handleThumbnailUpload(file);
          }
          // 같은 파일 재선택 가능하도록 value 리셋
          e.target.value = '';
        });
        
        // 기존 이미지 로드
        if (hiddenField && hiddenField.value) {
          thumbnailUrl = hiddenField.value;
          if (preview) preview.classList.remove('hidden');
          if (placeholder) placeholder.classList.add('hidden');
          if (thumbnailImg) thumbnailImg.src = thumbnailUrl;
          if (removeBtn) removeBtn.classList.remove('hidden');
        }
        
        // 삭제 버튼
        if (removeBtn) {
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            thumbnailUrl = '';
            if (hiddenField) hiddenField.value = '';
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (removeBtn) removeBtn.classList.add('hidden');
            hasUnsavedChanges = true;
            updateSaveStatus('unsaved');
          });
        }
      }
      
      function handleThumbnailUpload(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/upload', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.url) {
            thumbnailUrl = data.url;
            const hiddenField = document.getElementById('field-thumbnail');
            if (hiddenField) hiddenField.value = data.url;
            const preview = document.getElementById('thumbnail-preview');
            const placeholder = document.getElementById('thumbnail-placeholder');
            const thumbnailImg = document.getElementById('thumbnail-img');
            const removeBtn = document.getElementById('thumbnail-remove');
            if (preview) preview.classList.remove('hidden');
            if (placeholder) placeholder.classList.add('hidden');
            if (thumbnailImg) thumbnailImg.src = data.url;
            if (removeBtn) removeBtn.classList.remove('hidden');
            hasUnsavedChanges = true;
            updateSaveStatus('unsaved');
          } else {
            alert('썸네일 업로드 실패: ' + (data.error || '알 수 없는 오류'));
          }
        })
        .catch(err => {
          console.error('썸네일 업로드 오류:', err);
          alert('썸네일 업로드 중 오류가 발생했습니다.');
        });
      }
      
      function getThumbnailUrl() {
        return thumbnailUrl;
      }
      
      // 초기화
      document.addEventListener('DOMContentLoaded', function() {
        initTags();
        initThumbnail();
      });
    </script>
  `
  
  return c.html(
    renderLayoutWithContext(c, content, 'HowTo 가이드 작성 - Careerwiki', '새 가이드를 작성합니다')
  )
})

// HowTo 초안 편집 페이지
app.get('/howto/draft/:id', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=' + encodeURIComponent(c.req.path))
  }
  
  const draftId = parseInt(c.req.param('id'))
  if (!Number.isFinite(draftId)) {
    return c.redirect('/howto')
  }
  
  // 초안 조회
  const { getDraft } = await import('./services/draftService')
  const draftResult = await getDraft(c.env.DB, draftId, user.id)
  
  if (!draftResult.success) {
    const content = `
      <div class="max-w-2xl mx-auto px-4 py-16 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-amber-500/10 mb-6">
          <i class="fas fa-file-alt text-3xl text-amber-400"></i>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2">초안을 찾을 수 없습니다</h1>
        <p class="text-wiki-muted mb-6">삭제되었거나 접근 권한이 없습니다.</p>
        <a href="/howto/write" class="px-6 py-3 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
          새 글 작성
        </a>
      </div>
    `
    return c.html(renderLayoutWithContext(c, content, '초안 없음 - Careerwiki', ''))
  }
  
  const draft = draftResult.draft!
  
  // 발행 이력 확인 (published_page_id가 있는지)
  const publishedPageInfo = await c.env.DB.prepare(`
    SELECT published_page_id, 
           (SELECT slug FROM pages WHERE id = published_page_id) as published_slug,
           (SELECT status FROM pages WHERE id = published_page_id) as page_status
    FROM howto_drafts WHERE id = ?
  `).bind(draftId).first<{ published_page_id: number | null; published_slug: string | null; page_status: string | null }>()
  
  const hasPublishedVersion = !!publishedPageInfo?.published_page_id
  const pageStatus = publishedPageInfo?.page_status || ''
  const isPublished = pageStatus === 'published'
  const isDraftPublished = pageStatus === 'draft_published'
  const publishedSlug = publishedPageInfo?.published_slug || ''
  
  const content = `
    <!-- Tiptap CDN -->
    <link rel="stylesheet" href="/static/howto-editor.css">
    
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
      <!-- 헤더 -->
      <header class="mb-6">
        <!-- 상단: 뒤로가기 + 제목 + 삭제 -->
        <div class="flex items-center gap-3 mb-3">
          <a href="/howto" class="flex items-center justify-center w-10 h-10 min-w-[44px] min-h-[44px] text-wiki-muted hover:text-white hover:bg-wiki-border/30 rounded-xl transition shrink-0">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div class="min-w-0 flex-1">
            <h1 class="text-xl sm:text-2xl font-bold text-white leading-tight">${hasPublishedVersion ? '가이드 편집' : '가이드 작성'}</h1>
            <p class="text-xs sm:text-sm text-wiki-muted mt-0.5" id="save-status">
              <span class="text-amber-400">●</span> 저장되지 않음
            </p>
          </div>
          <button type="button" id="btn-delete" class="shrink-0 w-10 h-10 sm:w-auto sm:h-auto sm:px-3 sm:py-2 flex items-center justify-center text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition" title="삭제">
            <i class="fas fa-trash-alt sm:mr-1.5"></i>
            <span class="hidden sm:inline text-sm">삭제</span>
          </button>
        </div>
        
        <!-- 하단: 액션 버튼 -->
        <div class="flex items-center gap-2 sm:gap-3">
          <button type="button" id="btn-save" class="flex-1 sm:flex-none px-4 py-2.5 min-h-[44px] border border-wiki-border/60 text-wiki-muted hover:text-white hover:bg-wiki-border/20 rounded-xl transition text-sm font-medium flex items-center justify-center gap-2">
            <i class="fas fa-save"></i>
            <span>임시저장</span>
          </button>
          ${isPublished ? `
            <button type="button" id="btn-update" class="flex-1 sm:flex-none px-4 sm:px-5 py-2.5 min-h-[44px] bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-500/90 hover:to-teal-500/90 text-white rounded-xl transition text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20">
              <i class="fas fa-sync-alt"></i>
              <span>업데이트</span>
            </button>
          ` : `
            <button type="button" id="btn-publish" class="flex-1 sm:flex-none px-4 sm:px-5 py-2.5 min-h-[44px] bg-gradient-to-r from-wiki-primary to-blue-500 hover:from-wiki-primary/90 hover:to-blue-500/90 text-white rounded-xl transition text-sm font-medium flex items-center justify-center gap-2 shadow-lg shadow-wiki-primary/20">
              <i class="fas fa-paper-plane"></i>
              <span>발행하기</span>
            </button>
          `}
        </div>
      </header>
      
      <!-- 메타 필드 -->
      <div class="grid gap-4 mb-6">
        <!-- 제목 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">제목 *</label>
          <div class="relative">
            <input type="text" id="field-title" maxlength="100"
                   class="w-full px-4 py-3 pr-10 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white text-lg font-semibold placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                   placeholder="가이드 제목을 입력하세요"
                   value="${escapeHtml(draft.title || '')}" />
            <span id="title-check" class="absolute right-3 top-1/2 -translate-y-1/2 text-lg hidden">
              <i class="fas fa-spinner fa-spin text-wiki-muted" id="title-loading"></i>
              <i class="fas fa-check-circle text-green-500 hidden" id="title-ok"></i>
              <i class="fas fa-times-circle text-red-500 hidden" id="title-error"></i>
            </span>
          </div>
          <p id="title-error-msg" class="mt-1 text-xs text-red-400 hidden"></p>
        </div>
        
        <!-- 요약 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">요약</label>
          <textarea id="field-summary" maxlength="300" rows="2"
                    class="w-full px-4 py-3 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition resize-none"
                    placeholder="이 가이드가 어떤 내용을 다루는지 간략히 설명해주세요">${escapeHtml(draft.summary || '')}</textarea>
        </div>
        
        <!-- 썸네일 -->
        <div>
          <label class="block text-sm font-medium text-wiki-text mb-2">썸네일 <span class="text-wiki-muted font-normal">(선택)</span></label>
          <div id="thumbnail-upload-area" class="border-2 border-dashed border-wiki-border/40 rounded-xl p-4 text-center hover:border-wiki-primary/50 transition cursor-pointer">
            <div id="thumbnail-placeholder" class="${(draft as any).thumbnailUrl ? 'hidden' : ''} space-y-2">
              <i class="fas fa-image text-3xl text-wiki-muted"></i>
              <p class="text-sm text-wiki-muted">클릭하여 이미지 업로드 또는 드래그 앤 드롭</p>
              <p class="text-xs text-wiki-muted/60">없으면 본문의 첫 번째 이미지가 자동으로 사용됩니다</p>
            </div>
            <div id="thumbnail-preview" class="${(draft as any).thumbnailUrl ? '' : 'hidden'}">
              <img id="thumbnail-img" src="${escapeHtml((draft as any).thumbnailUrl || '')}" alt="썸네일 미리보기" class="max-h-48 mx-auto rounded-lg" />
              <button type="button" id="thumbnail-remove" class="mt-2 text-sm text-red-400 hover:text-red-300">
                <i class="fas fa-times mr-1"></i>썸네일 제거
              </button>
            </div>
          </div>
          <input type="file" id="thumbnail-input" accept="image/*" class="hidden" />
          <input type="hidden" id="field-thumbnail" value="${escapeHtml((draft as any).thumbnailUrl || '')}" />
        </div>
        
        <!-- 태그 & 관련 콘텐츠 -->
        <div class="grid md:grid-cols-2 gap-4">
          <!-- 태그 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">태그</label>
            <div class="relative">
              <input type="text" id="field-tags"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="태그 입력 후 Enter 또는 쉼표(,)"
                     data-tags='${escapeHtml(JSON.stringify(draft.tags || []))}' />
              <div id="tags-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
          
          <!-- 관련 직업 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 직업</label>
            <div class="relative">
              <input type="text" id="field-jobs" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="직업 검색..."
                     data-items='${escapeHtml(JSON.stringify(draft.relatedJobs || []))}' />
              <div id="jobs-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="jobs-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <!-- 관련 전공 -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 전공</label>
            <div class="relative">
              <input type="text" id="field-majors" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="전공 검색..."
                     data-items='${escapeHtml(JSON.stringify(draft.relatedMajors || []))}' />
              <div id="majors-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="majors-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
          
          <!-- 관련 HowTo -->
          <div>
            <label class="block text-sm font-medium text-wiki-text mb-2">관련 HowTo</label>
            <div class="relative">
              <input type="text" id="field-howtos" autocomplete="off"
                     class="w-full px-4 py-2.5 bg-wiki-card/50 border border-wiki-border/40 rounded-xl text-white placeholder-wiki-muted focus:border-wiki-primary outline-none transition"
                     placeholder="HowTo 검색..."
                     data-items='${escapeHtml(JSON.stringify(draft.relatedHowtos || []))}' />
              <div id="howtos-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-wiki-bg border border-wiki-border/60 rounded-lg shadow-xl z-50 hidden max-h-48 overflow-y-auto" tabindex="-1"></div>
              <div id="howtos-container" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 본문 영역 -->
      <div>
        <label class="block text-sm font-medium text-wiki-text mb-2">본문 *</label>
        
        <!-- 에디터 툴바 -->
        <div id="toolbar" class="howto-editor-toolbar bg-wiki-card/50 border border-wiki-border/40 rounded-t-xl px-3 py-2">
          <div class="toolbar-group">
            <button type="button" data-action="bold" title="굵게 (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button type="button" data-action="italic" title="기울임 (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button type="button" data-action="underline" title="밑줄 (Ctrl+U)"><i class="fas fa-underline"></i></button>
            <button type="button" data-action="strike" title="취소선"><i class="fas fa-strikethrough"></i></button>
          </div>
          <div class="toolbar-group">
            <!-- 폰트 -->
            <div class="toolbar-dropdown font-dropdown">
              <button type="button" title="폰트" class="toolbar-btn flex items-center gap-1.5"><span class="current-font-name">기본</span><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="font-menu hidden">
                <button type="button" data-font="inherit" class="is-active">기본</button>
                <button type="button" data-font="sans-serif">Sans-serif (샌즈)</button>
                <button type="button" data-font="serif">Serif (세리프)</button>
                <button type="button" data-font="monospace">Monospace (코드)</button>
                <button type="button" data-font="'Nanum Gothic', sans-serif">나눔고딕</button>
                <button type="button" data-font="'Nanum Myeongjo', serif">나눔명조</button>
              </div>
            </div>
            <!-- 폰트 크기 -->
            <div class="toolbar-dropdown size-dropdown">
              <button type="button" title="글자 크기" class="toolbar-btn size-input-btn">
                <input type="number" class="size-input" value="15" min="6" max="72" title="글자 크기 (px)">
                <i class="fas fa-chevron-down text-[10px] opacity-60"></i>
              </button>
              <div class="size-menu hidden">
                <button type="button" data-size="8px">8</button>
                <button type="button" data-size="12px">12</button>
                <button type="button" data-size="14px">14</button>
                <button type="button" data-size="15px" class="is-default">15</button>
                <button type="button" data-size="16px">16</button>
                <button type="button" data-size="18px">18</button>
                <button type="button" data-size="20px">20</button>
                <button type="button" data-size="24px">24</button>
                <button type="button" data-size="28px">28</button>
                <button type="button" data-size="32px">32</button>
                <button type="button" data-size="36px">36</button>
              </div>
            </div>
            <!-- 폰트 색상 -->
            <div class="toolbar-dropdown color-dropdown">
              <button type="button" title="글자 색상" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-palette"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="color-menu hidden">
                <div class="color-grid">
                  <button type="button" data-color="#ffffff" style="background:#ffffff" title="흰색"></button>
                  <button type="button" data-color="#f59e0b" style="background:#f59e0b" title="주황"></button>
                  <button type="button" data-color="#ef4444" style="background:#ef4444" title="빨강"></button>
                  <button type="button" data-color="#22c55e" style="background:#22c55e" title="초록"></button>
                  <button type="button" data-color="#3b82f6" style="background:#3b82f6" title="파랑"></button>
                  <button type="button" data-color="#8b5cf6" style="background:#8b5cf6" title="보라"></button>
                  <button type="button" data-color="#ec4899" style="background:#ec4899" title="분홍"></button>
                  <button type="button" data-color="#6b7280" style="background:#6b7280" title="회색"></button>
                </div>
                <button type="button" data-color="" class="color-reset">기본 색상</button>
              </div>
            </div>
          </div>
          <div class="toolbar-group">
            <!-- 정렬 -->
            <div class="toolbar-dropdown align-dropdown">
              <button type="button" title="정렬" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-align-left"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="align-menu hidden">
                <button type="button" data-action="alignLeft"><i class="fas fa-align-left"></i> 왼쪽</button>
                <button type="button" data-action="alignCenter"><i class="fas fa-align-center"></i> 중앙</button>
                <button type="button" data-action="alignRight"><i class="fas fa-align-right"></i> 오른쪽</button>
              </div>
            </div>
            <!-- 커스텀 블록 -->
            <div class="toolbar-dropdown custom-block-dropdown">
              <button type="button" title="커스텀 블록" class="toolbar-btn flex items-center gap-1.5"><i class="fas fa-cube"></i><i class="fas fa-chevron-down text-[10px] opacity-60"></i></button>
              <div class="toolbar-dropdown-content custom-block-menu hidden">
                <button type="button" data-action="blockquote"><i class="fas fa-quote-left text-sky-400"></i> 인용구</button>
                <button type="button" data-action="horizontalRule"><i class="fas fa-minus text-purple-400"></i> 구분선</button>
                <button type="button" data-action="checkpointBox"><i class="fas fa-check-circle text-green-500"></i> 체크포인트</button>
                <button type="button" data-action="conclusionBox"><i class="fas fa-lightbulb text-wiki-primary"></i> 결론 박스</button>
                <button type="button" data-action="qnaBlock"><i class="fas fa-question-circle text-amber-500"></i> Q&A</button>
              </div>
            </div>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="h1" title="제목 1">H1</button>
            <button type="button" data-action="h2" title="제목 2">H2</button>
            <button type="button" data-action="h3" title="제목 3">H3</button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="bulletList" title="글머리 기호"><i class="fas fa-list-ul"></i></button>
            <button type="button" data-action="orderedList" title="번호 매기기"><i class="fas fa-list-ol"></i></button>
            <button type="button" data-action="taskList" title="체크리스트"><i class="fas fa-tasks"></i></button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="link" title="외부 링크"><i class="fas fa-link"></i></button>
            <button type="button" data-action="internalLink" title="내부 링크 (직업/전공/HowTo)"><i class="fas fa-sitemap"></i></button>
            <button type="button" data-action="footnote" title="각주 (출처)"><i class="fas fa-asterisk"></i></button>
            <button type="button" data-action="image" title="이미지"><i class="fas fa-image"></i></button>
            <button type="button" data-action="table" title="표"><i class="fas fa-table"></i></button>
            <button type="button" data-action="codeBlock" title="코드 블록"><i class="fas fa-code"></i></button>
          </div>
          <div class="toolbar-group">
            <button type="button" data-action="undo" title="실행 취소 (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            <button type="button" data-action="redo" title="다시 실행 (Ctrl+Y)"><i class="fas fa-redo"></i></button>
          </div>
        </div>
        
        <!-- 표 편집 툴바 (압축형) -->
        <div id="table-toolbar" class="table-toolbar">
          <div class="toolbar-dropdown row-dropdown">
            <button type="button" title="행 추가" class="toolbar-btn"><i class="fas fa-plus"></i> 행</button>
            <div class="row-menu hidden">
              <button type="button" data-action="addRowBefore"><i class="fas fa-arrow-up"></i> 위에 추가</button>
              <button type="button" data-action="addRowAfter"><i class="fas fa-arrow-down"></i> 아래에 추가</button>
            </div>
          </div>
          <div class="toolbar-dropdown col-dropdown">
            <button type="button" title="열 추가" class="toolbar-btn"><i class="fas fa-plus"></i> 열</button>
            <div class="col-menu hidden">
              <button type="button" data-action="addColBefore"><i class="fas fa-arrow-left"></i> 왼쪽에 추가</button>
              <button type="button" data-action="addColAfter"><i class="fas fa-arrow-right"></i> 오른쪽에 추가</button>
            </div>
          </div>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="deleteRow" title="행 삭제"><i class="fas fa-trash-alt"></i></button>
          <button type="button" data-action="deleteCol" title="열 삭제"><i class="fas fa-columns"></i></button>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="mergeCells" title="셀 병합"><i class="fas fa-compress-alt"></i></button>
          <button type="button" data-action="splitCell" title="셀 분할"><i class="fas fa-expand-alt"></i></button>
          <!-- 셀 배경색 -->
          <span class="toolbar-divider"></span>
          <div class="toolbar-dropdown cell-color-dropdown">
            <button type="button" title="셀 배경색" class="toolbar-btn"><i class="fas fa-fill-drip"></i></button>
            <div class="cell-color-menu hidden">
              <div class="color-grid">
                <button type="button" data-cell-bg="" style="background:transparent;border:1px dashed #666" title="없음"></button>
                <button type="button" data-cell-bg="rgba(79,143,255,0.15)" style="background:rgba(79,143,255,0.4)" title="파랑"></button>
                <button type="button" data-cell-bg="rgba(34,197,94,0.15)" style="background:rgba(34,197,94,0.4)" title="초록"></button>
                <button type="button" data-cell-bg="rgba(245,158,11,0.15)" style="background:rgba(245,158,11,0.4)" title="주황"></button>
                <button type="button" data-cell-bg="rgba(239,68,68,0.15)" style="background:rgba(239,68,68,0.4)" title="빨강"></button>
                <button type="button" data-cell-bg="rgba(139,92,246,0.15)" style="background:rgba(139,92,246,0.4)" title="보라"></button>
              </div>
            </div>
          </div>
          <span class="toolbar-divider"></span>
          <button type="button" data-action="deleteTable" title="표 삭제" class="text-red-400"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- 에디터 본문 (Tiptap 마운트) -->
        <div id="editor" class="howto-editor-content bg-wiki-card/50 border border-wiki-border/40 border-t-0 rounded-b-xl"></div>
      </div>
      
      <!-- 출처 섹션 -->
      <div id="footnotes-section" class="editor-footnotes-section">
        <h4><i class="fas fa-book-open"></i> 출처</h4>
        <div id="footnotes-list" class="editor-footnotes-list">
          <div class="editor-footnotes-empty">
            <i class="fas fa-quote-right"></i>
            <p>각주를 추가하면 여기에 출처가 표시됩니다.</p>
          </div>
        </div>
      </div>
      
      <!-- 메시지 -->
      <div id="editor-message" class="hidden mt-4"></div>
    </div>
    
    <!-- 충돌 다이얼로그 -->
    <div id="conflict-dialog" class="hidden">
      <div class="backdrop"></div>
      <div class="content">
        <h3 class="text-lg font-semibold text-white mb-4">버전 충돌 발생</h3>
        <p class="text-wiki-muted mb-4">
          다른 곳에서 이 초안이 수정되었습니다.<br>
          서버 버전: <span data-server-version>-</span> / 내 버전: <span data-local-version>-</span>
        </p>
        <div class="flex gap-3">
          <button type="button" id="conflict-reload" class="flex-1 px-4 py-2 bg-wiki-primary text-white rounded-lg">
            서버 버전 불러오기
          </button>
          <button type="button" id="conflict-overwrite" class="flex-1 px-4 py-2 border border-wiki-border text-wiki-muted rounded-lg">
            내 버전으로 덮어쓰기
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tiptap 에디터 번들 -->
    <script src="/static/editor.bundle.iife.js"></script>
    
    <script>
      // 에디터 데이터
      const DRAFT_ID = ${draftId};
      const DRAFT_VERSION = ${draft.version};
      const PAGE_STATUS = '${pageStatus}';
      const IS_PUBLISHED = ${isPublished};
      const HAS_PUBLISHED_VERSION = ${hasPublishedVersion};
      const PUBLISHED_PAGE_ID = ${publishedPageInfo?.published_page_id || 'null'};
      // contentJson이 있으면 JSON으로, 없으면 HTML로 초기화
      const CONTENT_JSON_RAW = ${JSON.stringify(draft.contentJson || null)};
      const CONTENT_JSON = (CONTENT_JSON_RAW && CONTENT_JSON_RAW.length > 10 && CONTENT_JSON_RAW !== '{}') ? JSON.parse(CONTENT_JSON_RAW) : null;
      const CONTENT_HTML = ${JSON.stringify(draft.contentHtml || '<p></p>')};
      const INITIAL_CONTENT = CONTENT_JSON || CONTENT_HTML;
      console.log('[draft] CONTENT_JSON:', CONTENT_JSON ? 'exists' : 'null', 'CONTENT_HTML length:', CONTENT_HTML.length);
      let currentVersion = DRAFT_VERSION;
      let hasUnsavedChanges = false;
      let tiptapEditor = null;  // Tiptap 에디터 인스턴스
      
      // 페이지 나가기 경고
      const beforeUnloadHandler = (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '저장하지 않은 변경사항이 있습니다. 정말 나가시겠습니까?';
          return e.returnValue;
        }
      };
      window.addEventListener('beforeunload', beforeUnloadHandler);
      
      // 에디터 초기화
      document.addEventListener('DOMContentLoaded', async () => {
        // Tiptap 에디터 초기화
        if (window.HowToEditor) {
          tiptapEditor = new window.HowToEditor({
            container: '#editor',
            draftId: DRAFT_ID,
            version: DRAFT_VERSION,
            initialContent: INITIAL_CONTENT,
            onSave: (data) => {
              if (data.success) {
                currentVersion = data.version;
                hasUnsavedChanges = false;
                updateSaveStatus('saved');
              }
            },
            onError: (err) => {
              showMessage('error', err.message);
              updateSaveStatus('error');
            },
            onUpdate: () => {
              hasUnsavedChanges = true;
              updateSaveStatus('unsaved');
            }
          });
          window.HowToEditorInstance = tiptapEditor;
        } else {
          console.error('Tiptap 에디터 번들이 로드되지 않았습니다');
        }
        
        // 자동완성 초기화
        initAutocomplete();
        
        // 태그 초기화
        initTags();
        
        // 썸네일 초기화
        initThumbnail();
        
        // 제목 중복 체크 초기화
        initTitleCheck();
        
        // 툴바 드롭다운 설정
        function setupToolbarDropdowns() {
          const menuSelector = '.align-menu, .font-menu, .custom-block-menu, .color-menu, .size-menu, .row-menu, .col-menu, .cell-color-menu, .border-style-menu';
          
          document.querySelectorAll('.toolbar-dropdown').forEach(dropdown => {
            const btn = dropdown.querySelector('.toolbar-btn');
            const menu = dropdown.querySelector(menuSelector);
            if (!btn || !menu) return;
            
            let isOpen = false;
            let hoverTimeout = null;
            
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              isOpen = !isOpen;
              dropdown.classList.toggle('is-open', isOpen);
              if (isOpen) {
                menu.classList.remove('hidden');
                document.querySelectorAll('.toolbar-dropdown').forEach(other => {
                  if (other !== dropdown) {
                    other.classList.remove('is-open');
                    const otherMenu = other.querySelector(menuSelector);
                    if (otherMenu) otherMenu.classList.add('hidden');
                  }
                });
              } else {
                menu.classList.add('hidden');
              }
            });
            
            dropdown.addEventListener('mouseenter', () => {
              clearTimeout(hoverTimeout);
              menu.classList.remove('hidden');
            });
            
            dropdown.addEventListener('mouseleave', () => {
              if (!isOpen) {
                hoverTimeout = setTimeout(() => {
                  menu.classList.add('hidden');
                }, 300);
              }
            });
            
            menu.addEventListener('click', (e) => {
              if (e.target.closest('button')) {
                isOpen = false;
                dropdown.classList.remove('is-open');
                setTimeout(() => menu.classList.add('hidden'), 100);
              }
            });
          });
          
          document.addEventListener('click', (e) => {
            if (!e.target.closest('.toolbar-dropdown')) {
              document.querySelectorAll('.toolbar-dropdown').forEach(dropdown => {
                dropdown.classList.remove('is-open');
                const menu = dropdown.querySelector(menuSelector);
                if (menu) menu.classList.add('hidden');
              });
            }
          });
        }
        
        // 툴바 드롭다운 초기화
        setupToolbarDropdowns();
        
        // 저장 버튼
        document.getElementById('btn-save').addEventListener('click', async () => {
          await saveDraft();
        });
        
        // 발행 버튼 (임시 발행 → 정식 발행)
        document.getElementById('btn-publish')?.addEventListener('click', async () => {
          await publishFromDraft();
        });
        
        // 업데이트 버튼 (발행된 페이지 업데이트)
        document.getElementById('btn-update')?.addEventListener('click', async () => {
          await updatePublished();
        });
        
        // 삭제 버튼
        document.getElementById('btn-delete')?.addEventListener('click', async () => {
          const title = document.getElementById('field-title')?.value || '제목 없음';
          const confirmMsg = HAS_PUBLISHED_VERSION && PUBLISHED_PAGE_ID
            ? '정말 "' + title + '" 가이드를 삭제하시겠습니까?\\n삭제된 가이드는 복구할 수 없습니다.'
            : '정말 "' + title + '" 초안을 삭제하시겠습니까?\\n삭제된 초안은 복구할 수 없습니다.';
          
          if (!confirm(confirmMsg)) {
            return;
          }
          
          const btn = document.getElementById('btn-delete');
          const originalHtml = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>삭제 중...';
          
          try {
            // 발행된 페이지가 있으면 페이지 삭제 API, 없으면 초안 삭제 API 호출
            const deleteUrl = HAS_PUBLISHED_VERSION && PUBLISHED_PAGE_ID
              ? '/api/howto/' + PUBLISHED_PAGE_ID
              : '/api/howto/drafts/' + DRAFT_ID;
            
            const response = await fetch(deleteUrl, {
              method: 'DELETE',
              credentials: 'include'
            });
            
            const result = await response.json();
            
            if (result.success) {
              alert('삭제되었습니다.');
              window.location.href = '/howto/my-drafts';
            } else {
              alert('삭제 실패: ' + (result.error || '알 수 없는 오류'));
              btn.disabled = false;
              btn.innerHTML = originalHtml;
            }
          } catch (err) {
            alert('삭제 중 오류가 발생했습니다.');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
        });
        
        // 커스텀 블록 드롭다운 (호버/클릭 제어)
        document.querySelectorAll('.custom-block-dropdown').forEach(dropdown => {
          const btn = dropdown.querySelector('.toolbar-btn');
          const menu = dropdown.querySelector('.custom-block-menu');
          if (!btn || !menu) return;
          
          let isOpen = false;
          let hoverTimeout = null;
          
          // 호버 시 표시
          dropdown.addEventListener('mouseenter', () => {
            if (!isOpen) {
              clearTimeout(hoverTimeout);
              menu.classList.remove('hidden');
            }
          });
          
          // 호버 아웃 시 숨김 (열려있지 않을 때만)
          dropdown.addEventListener('mouseleave', () => {
            if (!isOpen) {
              hoverTimeout = setTimeout(() => {
                menu.classList.add('hidden');
              }, 200);
            }
          });
          
          // 클릭 시 토글
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            isOpen = !isOpen;
            if (isOpen) {
              menu.classList.remove('hidden');
            } else {
              menu.classList.add('hidden');
            }
          });
          
          // 메뉴 아이템 클릭 시 닫기
          menu.querySelectorAll('button').forEach(item => {
            item.addEventListener('click', () => {
              isOpen = false;
              menu.classList.add('hidden');
            });
          });
        });
        
        // 외부 클릭 시 모든 드롭다운 닫기
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.custom-block-dropdown')) {
            document.querySelectorAll('.custom-block-dropdown').forEach(dropdown => {
              const menu = dropdown.querySelector('.custom-block-menu');
              if (menu) menu.classList.add('hidden');
            });
          }
          if (!e.target.closest('.align-dropdown')) {
            document.querySelectorAll('.align-menu').forEach(m => m.classList.add('hidden'));
          }
          if (!e.target.closest('.font-dropdown')) {
            document.querySelectorAll('.font-menu').forEach(m => m.classList.add('hidden'));
          }
        });
        
        // 정렬 드롭다운 제어
        document.querySelectorAll('.align-dropdown').forEach(dropdown => {
          const btn = dropdown.querySelector('.toolbar-btn');
          const menu = dropdown.querySelector('.align-menu');
          if (!btn || !menu) return;
          
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('hidden');
            menu.classList.toggle('visible');
          });
          
          menu.querySelectorAll('button').forEach(item => {
            item.addEventListener('click', () => {
              menu.classList.add('hidden');
              menu.classList.remove('visible');
            });
          });
        });
        
        // 폰트/크기 관련 이벤트는 에디터에서 처리
        // 드롭다운 열기/닫기만 처리
        document.querySelectorAll('.font-dropdown').forEach(dropdown => {
          const btn = dropdown.querySelector('.toolbar-btn');
          const menu = dropdown.querySelector('.font-menu');
          if (!btn || !menu) return;
          
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('hidden');
            menu.classList.toggle('visible');
          });
          
          menu.querySelectorAll('button').forEach(item => {
            item.addEventListener('click', () => {
              menu.classList.add('hidden');
              menu.classList.remove('visible');
            });
          });
        });
        
        // 표 툴바 제어 (표 안에 커서 있을 때만 표시)
        const tableToolbar = document.getElementById('table-toolbar');
        if (tableToolbar && tiptapEditor) {
          // 에디터 선택 변경 시 표 상태 확인
          const checkTableState = () => {
            if (tiptapEditor.isInTable && tiptapEditor.isInTable()) {
              tableToolbar.classList.add('visible');
            } else {
              tableToolbar.classList.remove('visible');
            }
          };
          
          // 주기적 확인 (더 나은 방법은 에디터 이벤트 사용)
          document.getElementById('editor').addEventListener('click', checkTableState);
          document.getElementById('editor').addEventListener('keyup', checkTableState);
          
          // 표 툴바 버튼 이벤트
          tableToolbar.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', () => {
              const action = btn.dataset.action;
              if (tiptapEditor && typeof tiptapEditor.executeToolbarAction === 'function') {
                tiptapEditor.executeToolbarAction(action);
              }
            });
          });
        }
        
        // 각주 목록 업데이트 이벤트 수신
        window.addEventListener('footnotes-updated', (e) => {
          const footnotes = e.detail.footnotes || [];
          const container = document.getElementById('footnotes-list');
          if (!container) return;
          
          if (footnotes.length === 0) {
            container.innerHTML = '<div class="editor-footnotes-empty"><i class="fas fa-quote-right"></i><p>각주를 추가하면 여기에 출처가 표시됩니다.</p></div>';
          } else {
            container.innerHTML = footnotes.map(function(f) {
              var urlHtml = f.url ? '<a href="' + escapeHtml(f.url) + '" target="_blank" class="editor-footnote-url">' + escapeHtml(f.url) + '</a>' : '';
              return '<div class="editor-footnote-item" data-id="' + f.id + '">' +
                '<span class="editor-footnote-id">' + f.id + '</span>' +
                '<div class="editor-footnote-content">' +
                  '<div class="editor-footnote-text">' + escapeHtml(f.text) + '</div>' +
                  urlHtml +
                '</div>' +
                '<div class="editor-footnote-actions">' +
                  '<button type="button" class="btn-edit" data-id="' + f.id + '" title="편집"><i class="fas fa-edit"></i></button>' +
                  '<button type="button" class="btn-delete" data-id="' + f.id + '" title="삭제"><i class="fas fa-trash"></i></button>' +
                '</div>' +
              '</div>';
            }).join('');
            
            // 편집/삭제 버튼 이벤트
            container.querySelectorAll('.btn-edit').forEach(btn => {
              btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                const f = footnotes.find(x => x.id === id);
                if (f && tiptapEditor && typeof tiptapEditor.showFootnoteModal === 'function') {
                  tiptapEditor.showFootnoteModal(id, f.text, f.url);
                }
              });
            });
            
            container.querySelectorAll('.btn-delete').forEach(btn => {
              btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                if (confirm('이 각주를 삭제하시겠습니까?') && tiptapEditor && typeof tiptapEditor.deleteFootnote === 'function') {
                  tiptapEditor.deleteFootnote(id);
                }
              });
            });
          }
        });
        
        // 요약 변경 추적
        document.getElementById('field-summary').addEventListener('input', () => {
          hasUnsavedChanges = true;
          updateSaveStatus('unsaved');
        });
      });
      
      // 제목 중복 체크 상태
      let titleCheckTimer = null;
      let isTitleAvailable = true;
      const EXCLUDE_PAGE_ID = HAS_PUBLISHED_VERSION ? PUBLISHED_PAGE_ID : null;
      
      function initTitleCheck() {
        const titleInput = document.getElementById('field-title');
        const titleCheck = document.getElementById('title-check');
        const titleLoading = document.getElementById('title-loading');
        const titleOk = document.getElementById('title-ok');
        const titleError = document.getElementById('title-error');
        const titleErrorMsg = document.getElementById('title-error-msg');
        
        if (!titleInput) return;
        
        titleInput.addEventListener('input', () => {
          hasUnsavedChanges = true;
          updateSaveStatus('unsaved');
          
          clearTimeout(titleCheckTimer);
          const title = titleInput.value.trim();
          
          // 빈 값이면 숨김
          if (!title) {
            titleCheck.classList.add('hidden');
            titleErrorMsg.classList.add('hidden');
            isTitleAvailable = true;
            return;
          }
          
          // 2자 미만이면 바로 에러
          if (title.length < 2) {
            titleCheck.classList.remove('hidden');
            titleLoading.classList.add('hidden');
            titleOk.classList.add('hidden');
            titleError.classList.remove('hidden');
            titleErrorMsg.textContent = '제목은 최소 2자 이상이어야 합니다';
            titleErrorMsg.classList.remove('hidden');
            isTitleAvailable = false;
            return;
          }
          
          // 로딩 표시
          titleCheck.classList.remove('hidden');
          titleLoading.classList.remove('hidden');
          titleOk.classList.add('hidden');
          titleError.classList.add('hidden');
          titleErrorMsg.classList.add('hidden');
          
          // 500ms 후 API 호출
          titleCheckTimer = setTimeout(async () => {
            try {
              let url = '/api/howto/check-title?title=' + encodeURIComponent(title);
              if (EXCLUDE_PAGE_ID) {
                url += '&excludeId=' + EXCLUDE_PAGE_ID;
              }
              const res = await fetch(url);
              const data = await res.json();
              
              titleLoading.classList.add('hidden');
              
              if (data.success && data.available) {
                titleOk.classList.remove('hidden');
                titleError.classList.add('hidden');
                titleErrorMsg.classList.add('hidden');
                isTitleAvailable = true;
              } else {
                titleOk.classList.add('hidden');
                titleError.classList.remove('hidden');
                titleErrorMsg.textContent = data.reason || '사용할 수 없는 제목입니다';
                titleErrorMsg.classList.remove('hidden');
                isTitleAvailable = false;
              }
            } catch (err) {
              titleLoading.classList.add('hidden');
              titleOk.classList.add('hidden');
              titleError.classList.remove('hidden');
              titleErrorMsg.textContent = '제목 확인 중 오류가 발생했습니다';
              titleErrorMsg.classList.remove('hidden');
              isTitleAvailable = false;
            }
          }, 500);
        });
      }
      
      // 저장 (임시 발행 상태로 저장)
      async function saveDraft() {
        clearAllFieldErrors();
        
        const title = document.getElementById('field-title').value.trim();
        const summary = document.getElementById('field-summary').value.trim();
        const contentHtml = tiptapEditor ? tiptapEditor.getHTML() : '';
        const contentJson = tiptapEditor ? JSON.stringify(tiptapEditor.getContent()) : '{}';
        
        // 유효성 검사
        const titleError = validateTitle(title);
        if (titleError) {
          showFieldError('field-title', titleError);
          showMessage('error', titleError);
          updateSaveStatus('error');
          return;
        }
        
        // 제목 중복 체크 결과 확인
        if (!isTitleAvailable) {
          showMessage('error', '이미 같은 제목의 가이드가 존재합니다. 다른 제목을 입력해주세요.');
          document.getElementById('field-title').focus();
          updateSaveStatus('error');
          return;
        }
        
        const contentError = validateContent(contentHtml);
        if (contentError) {
          showMessage('error', contentError);
          updateSaveStatus('error');
          return;
        }
        
        // 발행된 문서를 저장하면 임시 발행 상태로 전환됨을 경고
        if (IS_PUBLISHED) {
          const confirmed = confirm('⚠️ 주의: 이미 발행된 문서입니다.\\n\\n저장하면 임시 발행 상태로 전환되어 비공개 처리됩니다.\\n(목록에서 사라지고 작성자만 볼 수 있게 됩니다)\\n\\n공개 상태를 유지하려면 "업데이트" 버튼을 사용하세요.\\n\\n계속하시겠습니까?');
          if (!confirmed) {
            return;
          }
        }
        
        updateSaveStatus('saving');
        
        // 태그 수집
        const tags = [];
        document.querySelectorAll('#tags-container span').forEach(chip => {
          const text = chip.textContent.replace('×', '').trim();
          if (text) tags.push(text);
        });
        
        // 관련 콘텐츠 수집
        const relatedJobs = getRelatedItems('jobs');
        const relatedMajors = getRelatedItems('majors');
        const relatedHowtos = getRelatedItems('howtos');
        const thumbnail = getThumbnailUrl();
        
        try {
          // 임시 발행 API 호출 (발행된 문서도 draft_published로 전환)
          const res = await fetch('/api/howto/save-publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              draftId: DRAFT_ID,
              title,
              summary,
              tags,
              relatedJobs,
              relatedMajors,
              relatedHowtos,
              contentHtml,
              contentJson,
              thumbnailUrl: thumbnail,
              forceDraftPublished: true  // 항상 draft_published로 저장
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            hasUnsavedChanges = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.onbeforeunload = null;
            showMessage('success', '임시 저장되었습니다! 잠시 후 이동합니다...');
            setTimeout(() => { window.location.href = '/howto/' + data.slug; }, 100);
          } else {
            updateSaveStatus('error');
            showMessage('error', data.error || '저장 실패');
          }
        } catch (err) {
          updateSaveStatus('error');
          showMessage('error', '네트워크 오류');
        }
      }
      
      // 발행 (draft_published → published)
      async function publishFromDraft() {
        clearAllFieldErrors();
        
        const title = document.getElementById('field-title').value.trim();
        const summary = document.getElementById('field-summary').value.trim();
        const contentHtml = tiptapEditor ? tiptapEditor.getHTML() : '';
        const contentJson = tiptapEditor ? JSON.stringify(tiptapEditor.getContent()) : '{}';
        
        // 유효성 검사
        const titleError = validateTitle(title);
        if (titleError) {
          showFieldError('field-title', titleError);
          showMessage('error', titleError);
          return;
        }
        
        // 제목 중복 체크 결과 확인
        if (!isTitleAvailable) {
          showMessage('error', '이미 같은 제목의 가이드가 존재합니다. 다른 제목을 입력해주세요.');
          document.getElementById('field-title').focus();
          return;
        }
        
        const contentError = validateContent(contentHtml);
        if (contentError) {
          showMessage('error', contentError);
          return;
        }
        
        if (!confirm('이 가이드를 정식 발행하시겠습니까?\\n발행 후 HowTo 목록에 공개됩니다.')) {
          return;
        }
        
        updateSaveStatus('saving');
        
        // 태그 수집
        const tags = [];
        document.querySelectorAll('#tags-container span').forEach(chip => {
          const text = chip.textContent.replace('×', '').trim();
          if (text) tags.push(text);
        });
        
        // 관련 콘텐츠 수집
        const relatedJobs = getRelatedItems('jobs');
        const relatedMajors = getRelatedItems('majors');
        const relatedHowtos = getRelatedItems('howtos');
        const thumbnail = getThumbnailUrl();
        
        try {
          const res = await fetch('/api/howto/publish-direct', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              draftId: DRAFT_ID,
              title,
              summary,
              tags,
              relatedJobs,
              relatedMajors,
              relatedHowtos,
              contentHtml,
              contentJson,
              thumbnailUrl: thumbnail
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            hasUnsavedChanges = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.onbeforeunload = null;
            showMessage('success', '발행되었습니다! 잠시 후 이동합니다...');
            setTimeout(() => { window.location.href = '/howto/' + data.slug; }, 100);
          } else {
            updateSaveStatus('error');
            showMessage('error', data.error || '발행 실패');
          }
        } catch (err) {
          updateSaveStatus('error');
          showMessage('error', '네트워크 오류');
        }
      }
      
      // 업데이트 (published 페이지 업데이트)
      async function updatePublished() {
        clearAllFieldErrors();
        
        const title = document.getElementById('field-title').value.trim();
        const summary = document.getElementById('field-summary').value.trim();
        const contentHtml = tiptapEditor ? tiptapEditor.getHTML() : '';
        const contentJson = tiptapEditor ? JSON.stringify(tiptapEditor.getContent()) : '{}';
        
        // 유효성 검사
        const titleError = validateTitle(title);
        if (titleError) {
          showFieldError('field-title', titleError);
          showMessage('error', titleError);
          return;
        }
        
        // 제목 중복 체크 결과 확인
        if (!isTitleAvailable) {
          showMessage('error', '이미 같은 제목의 가이드가 존재합니다. 다른 제목을 입력해주세요.');
          document.getElementById('field-title').focus();
          return;
        }
        
        const contentError = validateContent(contentHtml);
        if (contentError) {
          showMessage('error', contentError);
          return;
        }
        
        updateSaveStatus('saving');
        
        // 태그 수집
        const tags = [];
        document.querySelectorAll('#tags-container span').forEach(chip => {
          const text = chip.textContent.replace('×', '').trim();
          if (text) tags.push(text);
        });
        
        // 관련 콘텐츠 수집
        const relatedJobs = getRelatedItems('jobs');
        const relatedMajors = getRelatedItems('majors');
        const relatedHowtos = getRelatedItems('howtos');
        const thumbnail = getThumbnailUrl();
        
        try {
          const res = await fetch('/api/howto/save-publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              draftId: DRAFT_ID,
              title,
              summary,
              tags,
              relatedJobs,
              relatedMajors,
              relatedHowtos,
              contentHtml,
              contentJson,
              thumbnailUrl: thumbnail
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            hasUnsavedChanges = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.onbeforeunload = null;
            showMessage('success', '업데이트되었습니다! 잠시 후 이동합니다...');
            setTimeout(() => { window.location.href = '/howto/' + data.slug; }, 100);
          } else {
            updateSaveStatus('error');
            showMessage('error', data.error || '업데이트 실패');
          }
        } catch (err) {
          updateSaveStatus('error');
          showMessage('error', '네트워크 오류');
        }
      }
      
      // 썸네일 업로드
      let thumbnailUrl = document.getElementById('field-thumbnail')?.value || '';
      let thumbnailInitialized = false;
      
      function initThumbnail() {
        if (thumbnailInitialized) return;
        thumbnailInitialized = true;
        
        const uploadArea = document.getElementById('thumbnail-upload-area');
        const fileInput = document.getElementById('thumbnail-input');
        const placeholder = document.getElementById('thumbnail-placeholder');
        const preview = document.getElementById('thumbnail-preview');
        const thumbnailImg = document.getElementById('thumbnail-img');
        const removeBtn = document.getElementById('thumbnail-remove');
        const hiddenField = document.getElementById('field-thumbnail');
        
        if (!uploadArea || !fileInput) return;
        
        // 클릭 시 파일 선택 (이벤트 버블링 방지)
        uploadArea.addEventListener('click', (e) => {
          // fileInput 클릭이나 removeBtn 클릭은 무시
          if (e.target === fileInput || e.target.closest('#thumbnail-remove')) return;
          e.stopPropagation();
          fileInput.click();
        }, { capture: true });
        
        // 드래그 앤 드롭
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('border-wiki-primary');
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('border-wiki-primary');
        });
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('border-wiki-primary');
          const file = e.dataTransfer?.files?.[0];
          if (file && file.type.startsWith('image/')) {
            handleThumbnailUpload(file);
          }
        });
        
        // 파일 선택
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files?.[0];
          if (file) {
            handleThumbnailUpload(file);
          }
          // 같은 파일 재선택 가능하도록 value 리셋
          e.target.value = '';
        });
        
        // 썸네일 제거
        removeBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          thumbnailUrl = '';
          hiddenField.value = '';
          placeholder.classList.remove('hidden');
          preview.classList.add('hidden');
          thumbnailImg.src = '';
          hasUnsavedChanges = true;
        });
      }
      
      async function handleThumbnailUpload(file) {
        const placeholder = document.getElementById('thumbnail-placeholder');
        const preview = document.getElementById('thumbnail-preview');
        const thumbnailImg = document.getElementById('thumbnail-img');
        const hiddenField = document.getElementById('field-thumbnail');
        
        // 파일 크기 체크 (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showMessage('error', '이미지 크기는 5MB 이하여야 합니다.');
          return;
        }
        
        try {
          // 로딩 표시
          placeholder.classList.remove('hidden');
          placeholder.innerHTML = '<i class="fas fa-spinner fa-spin text-3xl text-wiki-primary"></i><p class="text-sm text-wiki-muted">업로드 중...</p>';
          
          // FormData로 업로드
          const formData = new FormData();
          formData.append('file', file);
          
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });
          
          const data = await res.json();
          
          if (data.success && data.url) {
            thumbnailUrl = data.url;
            hiddenField.value = data.url;
            thumbnailImg.src = data.url;
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');
            hasUnsavedChanges = true;
          } else {
            throw new Error(data.error || '업로드 실패');
          }
        } catch (err) {
          // 원래 상태로 복구
          placeholder.innerHTML = '<i class="fas fa-image text-3xl text-wiki-muted"></i><p class="text-sm text-wiki-muted">클릭하여 이미지 업로드 또는 드래그 앤 드롭</p><p class="text-xs text-wiki-muted/60">없으면 본문의 첫 번째 이미지가 자동으로 사용됩니다</p>';
          showMessage('error', err.message || '썸네일 업로드에 실패했습니다.');
        }
      }
      
      function getThumbnailUrl() {
        return thumbnailUrl || document.getElementById('field-thumbnail')?.value || '';
      }
      
      // 관련 아이템 수집
      function getRelatedItems(domain) {
        const items = [];
        document.querySelectorAll('#' + domain + '-container span[data-id]').forEach(chip => {
          items.push({
            id: chip.dataset.id,
            name: chip.dataset.name,
            slug: chip.dataset.slug
          });
        });
        return items;
      }
      
      // 충돌 다이얼로그 표시
      function showConflictDialog(serverVersion, localVersion) {
        const dialog = document.getElementById('conflict-dialog');
        dialog.querySelector('[data-server-version]').textContent = serverVersion;
        dialog.querySelector('[data-local-version]').textContent = localVersion;
        dialog.classList.remove('hidden');
        
        document.getElementById('conflict-reload').onclick = () => {
          location.reload();
        };
        
        document.getElementById('conflict-overwrite').onclick = async () => {
          currentVersion = serverVersion;
          dialog.classList.add('hidden');
          await saveDraft();
        };
      }
      
      // 저장 상태 업데이트
      function updateSaveStatus(status) {
        const el = document.getElementById('save-status');
        switch (status) {
          case 'saving':
            el.innerHTML = '<span class="text-amber-400">●</span> 저장 중...';
            break;
          case 'saved':
            el.innerHTML = '<span class="text-green-400">●</span> 저장됨 · ' + new Date().toLocaleTimeString('ko-KR');
            break;
          case 'error':
            el.innerHTML = '<span class="text-red-400">●</span> 저장 실패';
            break;
          default:
            el.innerHTML = '<span class="text-amber-400">●</span> 저장되지 않음';
        }
      }
      
      // 메시지 표시
      function showMessage(type, text) {
        const el = document.getElementById('editor-message');
        el.className = type === 'success'
          ? 'p-4 bg-green-500/10 border border-green-500/30 rounded-xl text-green-400'
          : 'p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400';
        el.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check' : 'exclamation') + '-circle mr-2"></i>' + text;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
      }
      
      // 필드별 에러 표시
      function showFieldError(fieldId, msg) {
        clearFieldError(fieldId);
        const field = document.getElementById(fieldId);
        if (!field) return;
        field.dataset.error = 'true';
        field.style.borderColor = 'rgba(239, 68, 68, 0.6)';
        const errorEl = document.createElement('p');
        errorEl.className = 'field-error text-red-400 text-xs mt-1';
        errorEl.textContent = msg;
        field.parentElement.appendChild(errorEl);
      }
      
      function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        delete field.dataset.error;
        field.style.borderColor = '';
        const existingError = field.parentElement.querySelector('.field-error');
        if (existingError) existingError.remove();
      }
      
      function clearAllFieldErrors() {
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('[data-error="true"]').forEach(el => {
          delete el.dataset.error;
          el.style.borderColor = '';
        });
      }
      
      // 유효성 검사 (초성만 입력 등 체크)
      function validateTitle(title) {
        if (!title) return '제목을 입력해주세요.';
        if (title.length < 2) return '제목은 2자 이상이어야 합니다.';
        if (/^[ㄱ-ㅎ]+$/.test(title)) return '제목에 초성만 입력할 수 없습니다.';
        return null;
      }
      
      function validateContent(html) {
        if (!html || html === '<p></p>' || html === '<p><br></p>') return '본문을 입력해주세요.';
        var textOnly = html.replace(/<[^>]*>/g, '').trim();
        if (/^[ㄱ-ㅎ \\t\\n]+$/.test(textOnly)) return '본문에 초성만 입력할 수 없습니다.';
        return null;
      }
      
      // 자동완성 초기화 (pointerdown + 이벤트 위임 + focusout 방식 + IME 지원)
      function initAutocomplete() {
        ['jobs', 'majors', 'howtos'].forEach(domain => {
          const input = document.getElementById('field-' + domain);
          const dropdown = document.getElementById(domain + '-dropdown');
          const container = document.getElementById(domain + '-container');
          if (!input || !dropdown || !container) return;
          const wrap = input.parentElement;
          
          let items = [];
          try {
            items = JSON.parse(input.dataset.items || '[]');
          } catch (e) {}
          
          // 기존 아이템 렌더링
          items.forEach(item => addItemChip(container, item, domain));
          
          let debounceTimer = null;
          let composingTimer = null;
          let abortController = null;
          let lastSearchValue = '';
          
          // 검색 실행 함수
          const doSearch = async (q) => {
            if (q.length < 2) {
              dropdown.classList.add('hidden');
              dropdown.innerHTML = '';
              return;
            }
            
            // 이미 같은 값으로 검색했으면 스킵
            if (q === lastSearchValue) return;
            lastSearchValue = q;
            
            try {
              if (abortController) abortController.abort();
              abortController = new AbortController();
              
              const res = await fetch('/api/search?domain=' + domain + '&q=' + encodeURIComponent(q) + '&limit=10', {
                signal: abortController.signal
              });
              const data = await res.json();
              
              if (data.success && data.results && data.results.length > 0) {
                dropdown.innerHTML = data.results.map(r => 
                  '<div class="autocomplete-item" data-id="' + (r.id || r.slug) + '" data-name="' + escapeHtml(r.name || r.title) + '" data-slug="' + escapeHtml(r.slug || r.name) + '">' +
                  '<span class="text-white">' + escapeHtml(r.name || r.title) + '</span>' +
                  (r.snippet ? '<br><span class="text-xs text-wiki-muted">' + escapeHtml(r.snippet) + '</span>' : '') +
                  '</div>'
                ).join('');
                dropdown.classList.remove('hidden');
              } else {
                dropdown.classList.add('hidden');
                dropdown.innerHTML = '';
              }
            } catch (err) {
              if (err?.name !== 'AbortError') {
                console.error('[autocomplete] Error:', err);
              }
            }
          };
          
          // 모든 입력에 대해 1초 후 자동 검색 (한글 조합 중에도)
          input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            clearTimeout(composingTimer);
            const q = input.value.trim();
            
            // 1초 후 자동 검색 (한글 조합 중에도 동작)
            composingTimer = setTimeout(() => doSearch(q), 1000);
            
            // 영어 등 비조합 입력은 300ms 후 빠르게 검색
            debounceTimer = setTimeout(() => {
              const currentQ = input.value.trim();
              if (currentQ.length >= 2) {
                doSearch(currentQ);
              }
            }, 300);
          });
          
          // 항목 선택: pointerdown에서 처리 (blur보다 먼저 발생)
          dropdown.addEventListener('pointerdown', (e) => {
            const el = e.target.closest('.autocomplete-item');
            if (!el) return;
            e.preventDefault();
            e.stopPropagation();
            
            const item = { id: el.dataset.id, name: el.dataset.name, slug: el.dataset.slug };
            
            // 중복 체크
            const existing = container.querySelector('[data-id="' + item.id + '"]');
            if (!existing) {
              addItemChip(container, item, domain);
            }
            
            input.value = '';
            dropdown.innerHTML = '';
            dropdown.classList.add('hidden');
            input.focus();
          });
          
          // focusout으로 외부 클릭 감지
          const handleFocusOut = (evt) => {
            const next = evt.relatedTarget;
            const isInside = wrap ? wrap.contains(next) : (input === next || dropdown.contains(next));
            if (!isInside) {
              dropdown.classList.add('hidden');
            }
          };
          (wrap || input).addEventListener('focusout', handleFocusOut);
        });
      }
      
      // 아이템 칩 추가
      function addItemChip(container, item, domain) {
        // 중복 체크
        const existingChip = container.querySelector('[data-id="' + item.id + '"]');
        if (existingChip) return;
        
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-wiki-primary/10 border border-wiki-primary/30 rounded-lg text-xs text-wiki-primary';
        chip.dataset.id = item.id;
        chip.dataset.name = item.name || item.title || '';
        chip.dataset.slug = item.slug || '';
        chip.innerHTML = escapeHtml(item.name || item.title) + '<button type="button" class="hover:text-red-400 ml-1">&times;</button>';
        
        chip.querySelector('button').addEventListener('click', () => {
          chip.remove();
        });
        
        container.appendChild(chip);
      }
      
      // 태그 초기화
      function initTags() {
        const input = document.getElementById('field-tags');
        const container = document.getElementById('tags-container');
        
        let tags = [];
        try {
          tags = JSON.parse(input.dataset.tags || '[]');
        } catch (e) {}
        
        tags.forEach(tag => addTagChip(container, tag));
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const tag = input.value.trim().replace(/,/g, '');
            if (tag) {
              addTagChip(container, tag);
              input.value = '';
            }
          }
        });
      }
      
      // 태그 칩 추가
      function addTagChip(container, tag) {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-wiki-card/50 border border-wiki-border/40 rounded-lg text-xs text-wiki-text';
        chip.innerHTML = escapeHtml(tag) + '<button type="button" class="hover:text-red-400 ml-1">&times;</button>';
        
        chip.querySelector('button').addEventListener('click', () => {
          chip.remove();
        });
        
        container.appendChild(chip);
      }
      
      // HTML 이스케이프
      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, c => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[c]);
      }
    </script>
  `
  
  return c.html(
    renderLayoutWithContext(c,
      content,
      'HowTo 작성 - Careerwiki',
      '새 HowTo 가이드를 작성합니다',
      false,
      { extraHead: '<link rel="stylesheet" href="/static/howto-editor.css">' }
    )
  )
})

// HowTo 편집 페이지 (작성자 또는 관리자만) - draft로 복사 후 리다이렉트
app.get('/howto/:slug/edit', requireAuth, async (c) => {
  const rawSlug = c.req.param('slug')
  const user = c.get('user')
  
  // guide: prefix가 있으면 정상 slug로 리다이렉트
  const slug = cleanGuidePrefix(rawSlug)
  if (slug !== rawSlug) {
    return c.redirect(`/howto/${encodeURIComponent(slug)}/edit`, 301)
  }
  
  if (!user) {
    return c.redirect(`/login?redirect=/howto/${encodeURIComponent(slug)}/edit`)
  }
  
  // DB에서 HowTo 조회 (page_type = 'guide', published 또는 draft_published)
  const page = await c.env.DB.prepare(`
    SELECT id, slug, title, summary, content, meta_data, author_id, status 
    FROM pages 
    WHERE slug = ? AND page_type = 'guide' AND status IN ('published', 'draft_published')
  `).bind(slug).first<{ id: number; slug: string; title: string; summary: string; content: string; meta_data: string; author_id: number | null; status: string }>()
  
  // 샘플 데이터 확인 (DB에 없는 경우)
  const sample = getSampleHowtoGuide(slug)
  
  if (!page && !sample) {
    return c.redirect('/howto')
  }
  
  // 권한 확인 (작성자 또는 관리자만)
  if (page) {
    const isAuthor = page.author_id && user.id === page.author_id
    const isAdmin = user.role === 'admin'
    
    if (!isAuthor && !isAdmin) {
      const content = `
        <div class="max-w-2xl mx-auto px-4 py-16 text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/10 mb-6">
            <i class="fas fa-lock text-3xl text-red-400"></i>
          </div>
          <h1 class="text-2xl font-bold text-white mb-2">편집 권한이 없습니다</h1>
          <p class="text-wiki-muted mb-6">본인이 작성한 글만 편집할 수 있습니다.</p>
          <a href="/howto/${escapeHtml(slug)}" class="px-6 py-3 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
            돌아가기
          </a>
        </div>
      `
      return c.html(
        renderLayoutWithContext(c, content, '편집 권한 없음 - Careerwiki', '편집 권한이 없습니다')
      )
    }
    
    // 발행된 페이지를 draft로 복사
    let metaData: any = {}
    try {
      if (page.meta_data) {
        metaData = JSON.parse(page.meta_data)
      }
    } catch {}
    
    // 이 페이지에 연결된 기존 draft가 있는지 확인
    const existingDraft = await c.env.DB.prepare(`
      SELECT id FROM howto_drafts 
      WHERE user_id = ? AND published_page_id = ?
      ORDER BY updated_at DESC
      LIMIT 1
    `).bind(user.id, page.id).first<{ id: number }>()
    
    if (existingDraft) {
      // 기존 draft가 있으면 그것으로 이동
      return c.redirect(`/howto/draft/${existingDraft.id}`)
    }
    
    // 새 draft 생성 (발행된 페이지 데이터 복사)
    const { createDraft, updateDraft } = await import('./services/draftService')
    
    // contentJson 및 contentHtml 처리
    // metaData.contentJson이 있으면 문자열로 전달, 없으면 빈 상태로 두어 contentHtml이 사용되도록 함
    let contentJson = ''
    if (metaData.contentJson && metaData.contentJson !== '{}') {
      contentJson = typeof metaData.contentJson === 'string' 
        ? metaData.contentJson 
        : JSON.stringify(metaData.contentJson)
    }
    const contentHtml = page.content || ''
    
    // 디버그 로그
    console.log('[edit] page.id:', page.id, 'slug:', slug)
    console.log('[edit] metaData keys:', Object.keys(metaData))
    console.log('[edit] contentJson length:', contentJson.length, 'contentHtml length:', contentHtml.length)
    console.log('[edit] tags:', metaData.tags?.length || 0, 'relatedJobs:', metaData.relatedJobs?.length || 0)
    
    const result = await createDraft(c.env.DB, {
      userId: user.id,
      title: page.title,
      summary: page.summary || '',
      contentJson: contentJson,
      contentHtml: contentHtml,
      thumbnailUrl: metaData.thumbnailUrl || ''
    })
    
    if (!result.success || !result.draftId) {
      // draft 생성 실패 시 에러 페이지
      const content = `
        <div class="max-w-2xl mx-auto px-4 py-16 text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/10 mb-6">
            <i class="fas fa-exclamation-triangle text-3xl text-red-400"></i>
          </div>
          <h1 class="text-2xl font-bold text-white mb-2">편집 모드로 전환할 수 없습니다</h1>
          <p class="text-wiki-muted mb-6">초안 생성에 실패했습니다. 잠시 후 다시 시도해주세요.</p>
          <a href="/howto/${escapeHtml(slug)}" class="px-6 py-3 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
            돌아가기
          </a>
        </div>
      `
      return c.html(renderLayoutWithContext(c, content, '편집 실패 - Careerwiki', ''))
    }
    
    // draft에 원본 페이지 ID 기록
    await c.env.DB.prepare(`
      UPDATE howto_drafts SET published_page_id = ? WHERE id = ?
    `).bind(page.id, result.draftId).run()
    
    // 관련 항목들 저장 (직접 DB에 삽입)
    const draftId = result.draftId
    
    // 태그 저장
    const tags = metaData.tags || []
    for (const tagName of tags) {
      if (!tagName || !tagName.trim()) continue
      const trimmed = tagName.trim()
      
      // 태그 조회 또는 생성
      let tag = await c.env.DB.prepare(`SELECT id FROM tags WHERE name = ?`).bind(trimmed).first<{ id: number }>()
      if (!tag) {
        const tagSlug = trimmed.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9가-힣-]/g, '')
        const tagResult = await c.env.DB.prepare(`INSERT INTO tags (name, slug) VALUES (?, ?)`).bind(trimmed, tagSlug).run()
        tag = { id: Number(tagResult.meta.last_row_id) }
      }
      await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_tags (draft_id, tag_id) VALUES (?, ?)`).bind(draftId, tag.id).run()
    }
    
    // 관련 직업 저장
    const relatedJobs = metaData.relatedJobs || []
    for (let i = 0; i < relatedJobs.length; i++) {
      const job = relatedJobs[i]
      const jobId = job.id || job.slug || job.name
      if (jobId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_jobs (draft_id, job_id, display_order) VALUES (?, ?, ?)`).bind(draftId, jobId, i).run()
      }
    }
    
    // 관련 전공 저장
    const relatedMajors = metaData.relatedMajors || []
    for (let i = 0; i < relatedMajors.length; i++) {
      const major = relatedMajors[i]
      const majorId = major.id || major.slug || major.name
      if (majorId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_majors (draft_id, major_id, display_order) VALUES (?, ?, ?)`).bind(draftId, majorId, i).run()
      }
    }
    
    // 관련 HowTo 저장
    const relatedHowtos = metaData.relatedHowtos || []
    for (let i = 0; i < relatedHowtos.length; i++) {
      const howto = relatedHowtos[i]
      const howtoId = howto.id || howto.slug || howto.name
      if (howtoId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_howtos (draft_id, howto_id, display_order) VALUES (?, ?, ?)`).bind(draftId, howtoId, i).run()
      }
    }
    
    return c.redirect(`/howto/draft/${draftId}`)
  }
  
  // 샘플 데이터 편집 (불가)
  const content = `
    <div class="max-w-2xl mx-auto px-4 py-16 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-amber-500/10 mb-6">
        <i class="fas fa-info-circle text-3xl text-amber-400"></i>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">샘플 콘텐츠입니다</h1>
      <p class="text-wiki-muted mb-6">샘플 콘텐츠는 편집할 수 없습니다.</p>
      <a href="/howto/${escapeHtml(slug)}" class="px-6 py-3 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
        돌아가기
      </a>
    </div>
  `
  return c.html(renderLayoutWithContext(c, content, '편집 불가 - Careerwiki', ''))
})

// HowTo 삭제 API (작성자 또는 관리자만)



app.get('/howto/:slug', async (c) => {
  const rawSlug = c.req.param('slug')
  
  // guide: prefix가 있으면 정상 slug로 리다이렉트 (301 Permanent Redirect)
  const cleanedSlug = cleanGuidePrefix(rawSlug)
  if (cleanedSlug !== rawSlug) {
    return c.redirect(`/howto/${encodeURIComponent(cleanedSlug)}`, 301)
  }
  
  const slug = cleanedSlug
  
  // 먼저 DB에서 HowTo 검색 (page_type = 'guide', published 또는 draft_published)
  // 작성자 프로필 이미지도 함께 조회
  const dbResult = await c.env.DB.prepare(`
    SELECT p.id, p.slug, p.title, p.summary, p.content, p.meta_data, p.author_id, p.status, p.view_count, p.created_at, p.updated_at,
           u.picture_url AS author_picture_url, u.custom_picture_url AS author_custom_picture_url
    FROM pages p
    LEFT JOIN users u ON u.id = p.author_id
    WHERE p.page_type = 'guide' AND p.slug = ? AND p.status IN ('published', 'draft_published')
    LIMIT 1
  `).bind(slug).first()
  
  if (dbResult) {
    const status = dbResult.status as string
    const pageId = dbResult.id as number
    const user = getOptionalUser(c)
    const isAuthor = user && String(user.id) === String(dbResult.author_id)
    const isAdmin = user && (user.role === 'super-admin' || user.role === 'operator')
    
    // draft_published 상태는 작성자 또는 관리자만 접근 가능
    if (status === 'draft_published' && !isAuthor && !isAdmin) {
      // 404 처리 - 간단한 인라인 404 메시지
      const notFoundContent = `
        <div class="flex flex-col items-center justify-center min-h-[50vh] text-center px-4">
          <div class="w-20 h-20 mb-6 rounded-full bg-wiki-card flex items-center justify-center">
            <i class="fas fa-file-alt text-3xl text-wiki-muted"></i>
          </div>
          <h1 class="text-2xl font-bold text-white mb-2">찾을 수 없는 가이드입니다</h1>
          <p class="text-wiki-muted mb-6">요청하신 페이지를 찾을 수 없습니다.</p>
          <a href="/howto" class="px-6 py-3 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-xl transition">
            HowTo 목록으로
          </a>
        </div>
      `
      return c.html(renderLayoutWithContext(c, notFoundContent, '페이지를 찾을 수 없습니다 - Careerwiki', ''), 404)
    }
    
    // 조회수 증가 (비동기, 에러 무시)
    c.env.DB.prepare(`UPDATE pages SET view_count = view_count + 1 WHERE id = ?`).bind(pageId).run().catch(() => {})
    
    // 북마크 수 조회 (user_bookmarks 테이블 사용)
    const bookmarkResult = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM user_bookmarks WHERE item_type = 'howto' AND item_slug = ?
    `).bind(slug).first<{ count: number }>()
    const bookmarkCount = bookmarkResult?.count || 0
    
    // DB에서 찾은 경우 - 변환 함수를 사용하여 HowtoGuideDetail로 변환
    const { dbRowToHowtoGuideDetail } = await import('./utils/howtoConverter')
    
    const guideDetail = dbRowToHowtoGuideDetail({
      id: dbResult.id as number,
      slug: dbResult.slug as string,
      title: dbResult.title as string,
      summary: dbResult.summary as string | null,
      content: dbResult.content as string | null,
      meta_data: dbResult.meta_data as string | null,
      author_id: dbResult.author_id as number | null,
      author_picture_url: dbResult.author_picture_url as string | null,
      author_custom_picture_url: dbResult.author_custom_picture_url as string | null,
      status: dbResult.status as string,
      created_at: dbResult.created_at as string,
      updated_at: dbResult.updated_at as string,
      view_count: (dbResult.view_count as number || 0) + 1, // 현재 조회 포함
      bookmark_count: bookmarkCount
    })
    
    // renderHowtoGuideDetail 템플릿 사용
    const { renderHowtoGuideDetail } = await import('./templates/howtoDetail')
    
    // CSS 링크 추가
    const cssLink = '<link rel="stylesheet" href="/static/howto-editor.css">'
    
    const content = cssLink + renderHowtoGuideDetail(guideDetail, {
      currentUserId: user?.id ? parseInt(user.id) : null,
      currentUserRole: user?.role || null,
      authorId: dbResult.author_id as number | null,
      pageId: dbResult.id as number,
      isBlinded: false,
      blindReason: null,
      isDraftPublished: status === 'draft_published'
    })
    
    return c.html(
      renderLayoutWithContext(c, content, `${dbResult.title} - Careerwiki`, dbResult.summary as string || '')
    )
  }
  
  // DB에 없으면 샘플 데이터에서 검색 (기존 템플릿 사용)
  const sample = getSampleHowtoGuide(slug)
  if (sample) {
    return renderSampleHowtoDetailPage(c, sample)
  }

  // 둘 다 없으면 404
    const fallbackHtml = renderDetailFallback({
      icon: 'fa-route',
      title: 'HowTo 정보를 찾을 수 없습니다',
      description: '요청하신 HowTo 가이드가 아직 등록되지 않았습니다.',
      ctaHref: '/howto',
      ctaLabel: 'HowTo 목록으로 돌아가기'
    })
    c.status(404)
    return c.html(
      renderLayoutWithContext(c,
        fallbackHtml,
        'HowTo 정보 없음 - Careerwiki',
        '요청한 HowTo 가이드를 찾을 수 없습니다.'
      )
    )
})


// Search Page - 실제 D1 데이터 검색
app.get('/search', async (c) => {
  const query = c.req.query('q') || ''
  const keyword = query.trim()
  
  const renderKeywordBadges = (keywords: string[]): string => {
    if (!keywords || !keywords.length) {
      return ''
    }
    return `<div class="flex flex-wrap gap-2 mt-3">${keywords.slice(0, 3)
      .map((keyword) => `<span class="px-3 py-1.5 rounded-full bg-wiki-bg border border-wiki-border text-xs text-wiki-muted">${escapeHtml(keyword)}</span>`)
      .join('')}</div>`
  }

  const queryValueAttr = escapeHtml(keyword)
  const escapedQuery = escapeHtml(keyword)

  // 실제 D1 데이터 검색
  let jobCardsHtml = ''
  let majorCardsHtml = ''
  let howtoResults: Array<{ href: string; title: string; summary?: string; thumbnailUrl?: string; tags?: string[] }> = []

  // 요약 텍스트 포맷팅 함수
  const formatSummaryText = (value?: string | null, type: 'job' | 'major' = 'job'): string => {
    const fallback = type === 'job' 
      ? '고용24와 커리어넷 데이터를 통합하여 제공하는 직업 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
      : '고용24와 커리어넷 데이터를 통합하여 제공하는 전공 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
    if (!value) return fallback
    const normalized = value.replace(/\s+/g, ' ').trim()
    if (!normalized) return fallback
    return normalized.length > 220 ? `${normalized.slice(0, 217)}…` : normalized
  }

  if (keyword && c.env?.DB) {
    try {
      // 직업 검색
      console.log('[/search] 직업 검색 시작:', keyword)
      const jobSearchResult = await searchUnifiedJobs(
        { keyword, page: 1, perPage: 5 },
        c.env
      )
      console.log('[/search] 직업 검색 결과:', jobSearchResult.items.length, '개')
      
      jobCardsHtml = jobSearchResult.items
        .slice(0, 5)
        .map((entry) => renderJobCard(entry))
        .join('')

      // 전공 검색
      const majorSearchResult = await searchUnifiedMajors(
        { keyword, page: 1, perPage: 5 },
        c.env
      )
      
      majorCardsHtml = majorSearchResult.items
        .slice(0, 5)
        .map((entry) => renderMajorCard(entry))
        .join('')
    } catch (error) {
      console.error('검색 오류:', error)
    }
  }

  // HowTo 검색 - D1 pages 테이블에서만 검색
  // 🔍 HowTo 키워드 토큰화 함수
  const tokenizeHowtoKeyword = (kw: string): string[] => {
    const tokens: string[] = []
    const normalizedKw = kw.toLowerCase().replace(/\s+/g, '')
    
    // 1. 취업/커리어 관련 키워드 추출
    const careerKeywords = ['취업', '면접', '자소서', '자기소개서', '이력서', '포트폴리오', '자격증', '스펙', '준비', '방법', '팁', '가이드', '합격', '불합격', '서류', '채용', '지원', '경력', '신입', '인턴', '공채', '수시', '연봉', '협상', '퇴사', '이직', '전직', '직무', '직업', '진로', '커리어']
    for (const ck of careerKeywords) {
      if (normalizedKw.includes(ck) && normalizedKw !== ck) {
        tokens.push(ck)
      }
    }
    
    // 2. 직무/분야 키워드 추출
    const fieldKeywords = ['개발자', '디자이너', '기획자', '마케터', '영업', '인사', '회계', '재무', '법무', '공무원', '대기업', '중소기업', '스타트업', 'it', '금융', '의료', '교육', '건설', '제조', '서비스']
    for (const fk of fieldKeywords) {
      if (normalizedKw.includes(fk) && normalizedKw !== fk) {
        tokens.push(fk)
      }
    }
    
    // 중복 제거, 원본 키워드 제외
    return [...new Set(tokens)].filter(t => t !== normalizedKw && t.length >= 2)
  }
  
  if (keyword && c.env?.DB) {
    try {
      const db = c.env.DB as any
      const howtoTokens = tokenizeHowtoKeyword(keyword)
      
      // 토큰 검색 조건 생성
      let tokenConditions = ''
      const tokenBindings: string[] = []
      if (howtoTokens.length > 0) {
        const tokenClauses = howtoTokens.map(() => `title LIKE ?`).join(' OR ')
        tokenConditions = ` OR (${tokenClauses})`
        for (const token of howtoTokens) {
          tokenBindings.push(`%${token}%`)
        }
      }
      
      // 우선순위 기반 정렬 쿼리 (guide: prefix가 붙은 corrupted slug 제외)
      const howtoQuery = `
        SELECT id, slug, title, summary,
          COALESCE(json_extract(meta_data, '$.thumbnailUrl'), '') as thumbnail_url,
          COALESCE(json_extract(meta_data, '$.tags'), '[]') as tags_json,
          CASE 
            WHEN LOWER(title) = LOWER(?) THEN 0
            WHEN LOWER(title) LIKE LOWER(?) THEN 1
            WHEN LOWER(title) LIKE LOWER(?) THEN 2
            ELSE 3
          END as priority
        FROM pages
        WHERE page_type = 'guide'
          AND status = 'published'
          AND slug NOT LIKE 'guide:%'
          AND (title LIKE ? OR summary LIKE ?${tokenConditions})
        ORDER BY priority, updated_at DESC
        LIMIT 5
      `
      
      const howtoResult = await db.prepare(howtoQuery).bind(
        keyword,                    // 완전 일치
        `${keyword}%`,              // 시작 일치
        `%${keyword}%`,             // 부분 일치
        `%${keyword}%`,             // WHERE title
        `%${keyword}%`,             // WHERE summary
        ...tokenBindings            // 토큰 검색
      ).all()
      
      howtoResults = (howtoResult.results || []).map((row: any) => {
        let tags: string[] = []
        try {
          tags = JSON.parse(row.tags_json || '[]')
        } catch { tags = [] }
        
        // slug에서 guide: prefix 제거
        const cleanSlug = cleanGuidePrefix(row.slug || '')
        
        return {
          href: `/howto/${encodeURIComponent(cleanSlug)}`,
          title: row.title,
          summary: row.summary || '',
          thumbnailUrl: row.thumbnail_url || '',
          tags: Array.isArray(tags) ? tags : []
        }
      })
    } catch (error) {
      console.error('HowTo 검색 오류:', error)
      howtoResults = []
    }
  } else if (c.env?.DB) {
    // 검색어 없을 때 최신 HowTo 표시
    try {
      const db = c.env.DB as any
      const defaultQuery = `
        SELECT id, slug, title, summary,
          COALESCE(json_extract(meta_data, '$.thumbnailUrl'), '') as thumbnail_url,
          COALESCE(json_extract(meta_data, '$.tags'), '[]') as tags_json
        FROM pages
        WHERE page_type = 'guide' AND status = 'published' AND slug NOT LIKE 'guide:%'
        ORDER BY updated_at DESC
        LIMIT 3
      `
      const defaultResult = await db.prepare(defaultQuery).all()
      
      howtoResults = (defaultResult.results || []).map((row: any) => {
        let tags: string[] = []
        try {
          tags = JSON.parse(row.tags_json || '[]')
        } catch { tags = [] }
        
        return {
          href: `/howto/${encodeURIComponent(row.slug)}`,
          title: row.title,
          summary: row.summary || '',
          thumbnailUrl: row.thumbnail_url || '',
          tags: Array.isArray(tags) ? tags : []
        }
      })
    } catch (error) {
      console.error('HowTo 기본 조회 오류:', error)
      howtoResults = []
    }
  }

  const content = `
    <div class="max-w-[1400px] mx-auto px-[2px] md:px-6 pt-4 md:pt-8 md:mt-8">
        <div class="mb-8">
            <form action="/search" method="get" class="relative">
                <input 
                    type="text" 
                    name="q" 
                    value="${queryValueAttr}"
                    placeholder="검색어를 입력하세요" 
                    class="w-full px-6 py-4 bg-wiki-bg border border-wiki-border rounded-full text-base md:text-lg focus:outline-none focus:border-wiki-primary transition"
                    style="font-size: 16px;"
                >
                <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 px-5 py-3 min-h-[44px] bg-gradient-to-r from-wiki-primary to-wiki-secondary text-white rounded-full hover:scale-105 transition text-sm md:text-base font-medium">
                    <i class="fas fa-search mr-1.5"></i>검색
                </button>
            </form>
        </div>

        ${jobCardsHtml ? `
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="w-2 h-6 bg-wiki-primary mr-3"></span>
                직업위키
            </h2>
            <div class="space-y-4">
                ${jobCardsHtml}
                ${jobCardsHtml.split('</article>').length - 1 >= 5 ? `
                <a href="/job?q=${encodeURIComponent(keyword)}" class="block glass-card py-4 px-6 rounded-xl hover-glow transition text-center min-h-[48px] flex items-center justify-center">
                    <span class="text-sm font-medium text-wiki-text">직업 결과 더보기</span>
                </a>
                ` : ''}
            </div>
        </div>
        ` : ''}

        ${majorCardsHtml ? `
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="w-2 h-6 bg-wiki-secondary mr-3"></span>
                전공위키
            </h2>
            <div class="space-y-4">
                ${majorCardsHtml}
                ${majorCardsHtml.split('</article>').length - 1 >= 5 ? `
                <a href="/major?q=${encodeURIComponent(keyword)}" class="block glass-card py-4 px-6 rounded-xl hover-glow transition text-center min-h-[48px] flex items-center justify-center">
                    <span class="text-sm font-medium text-wiki-text">전공 결과 더보기</span>
                </a>
                ` : ''}
            </div>
        </div>
        ` : ''}

        ${howtoResults.length > 0 ? `
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="w-2 h-6 bg-amber-500 mr-3"></span>
                HowTo 가이드
            </h2>
            <div class="space-y-4">
                ${howtoResults.map(howto => `
                    <article class="group relative">
                      <a href="${howto.href}" class="block">
                        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-wiki-card/40 via-wiki-card/60 to-wiki-card/40 backdrop-blur-xl border border-wiki-border/40 p-4 sm:p-5 transition-all duration-500 ease-out hover:border-amber-500/40 hover:shadow-xl hover:shadow-amber-500/5 hover:-translate-y-1">
                          <div class="flex gap-4">
                            <!-- 왼쪽: 텍스트 콘텐츠 -->
                            <div class="flex-1 min-w-0 space-y-2">
                              <div class="flex items-center gap-2">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-semibold uppercase tracking-wider bg-amber-500/10 text-amber-400/80 border border-amber-500/20">
                                  <i class="fas fa-book-open text-[8px]"></i>
                                  HowTo
                                </span>
                              </div>
                              <h3 class="text-lg sm:text-xl font-bold text-white group-hover:text-amber-400 transition-colors line-clamp-2">${escapeHtml(howto.title)}</h3>
                              <p class="text-[13px] sm:text-[14px] leading-relaxed text-wiki-muted/90 line-clamp-2">${escapeHtml(howto.summary || '가이드 요약이 없습니다.')}</p>
                              ${howto.tags && howto.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1.5 pt-1">
                                  ${howto.tags.slice(0, 4).map((tag: string) => `
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-300/80 text-xs font-medium">
                                      <i class="fas fa-tag text-[8px]"></i>
                                      ${escapeHtml(tag)}
                                    </span>
                                  `).join('')}
                                </div>
                              ` : ''}
                            </div>
                            <!-- 오른쪽: 썸네일 -->
                            ${howto.thumbnailUrl ? `
                              <div class="flex items-center justify-center flex-shrink-0">
                                <div class="w-[74px] h-[74px] sm:w-28 sm:h-28 rounded-xl overflow-hidden border border-wiki-border/30 bg-wiki-bg/50">
                                  <img 
                                    src="${escapeHtml(howto.thumbnailUrl)}" 
                                    alt="${escapeHtml(howto.title)}"
                                    class="w-full h-full object-cover"
                                    loading="lazy"
                                    onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center bg-wiki-card/50\\'><i class=\\'fas fa-book-open text-xl sm:text-2xl text-amber-400/40\\'></i></div>'"
                                  >
                                </div>
                              </div>
                            ` : `
                              <div class="flex items-center justify-center flex-shrink-0">
                                <div class="w-[74px] h-[74px] sm:w-28 sm:h-28 rounded-xl overflow-hidden border border-wiki-border/30 bg-wiki-card/50 flex items-center justify-center">
                                  <i class="fas fa-book-open text-xl sm:text-3xl text-amber-400/30"></i>
                                </div>
                              </div>
                            `}
                          </div>
                        </div>
                      </a>
                    </article>
                `).join('')}
                ${howtoResults.length >= 3 ? `
                <a href="/howto${keyword ? `?q=${encodeURIComponent(keyword)}` : ''}" class="block glass-card py-4 px-6 rounded-xl hover-glow transition text-center min-h-[48px] flex items-center justify-center">
                    <span class="text-sm font-medium text-wiki-text">HowTo 가이드 더보기</span>
                </a>
                ` : ''}
            </div>
        </div>
        ` : ''}

        ${keyword && !jobCardsHtml && !majorCardsHtml && howtoResults.length === 0 ? `
        <div class="glass-card p-8 rounded-xl text-center">
            <i class="fas fa-search text-4xl text-wiki-muted mb-4"></i>
            <p class="text-lg text-wiki-muted">"${escapedQuery}"에 대한 검색 결과가 없습니다.</p>
            <p class="text-sm text-wiki-muted mt-2">다른 검색어를 시도해보세요.</p>
        </div>
        ` : ''}
    </div>
  `

  const title = keyword ? `${keyword} - Careerwiki 검색` : '검색 - Careerwiki'
  const description = keyword
    ? createMetaDescription(`"${keyword}"와 관련된 Careerwiki 직업, 전공 정보를 확인하세요.`)
    : 'Careerwiki에서 직업, 전공, HowTo 정보를 검색해보세요.'

  return c.html(renderLayoutWithContext(c, content, escapeHtml(title), escapeHtml(description)))
})

// Unified Job Detail Page (ISR)
app.get('/job/:slug', async (c) => {
  const mark = c.get('mark') as ((k: string) => void) | undefined
  mark?.('route-start')
  const rawSlug = c.req.param('slug')
  const normalizedSlug = decodeURIComponent(rawSlug).normalize('NFC')
  const slug = normalizedSlug
  let resolvedId = resolveDetailIdFromSlug('job', slug)
  
  // 🆕 If resolvedId doesn't contain ':', try to find by name in D1
  if (!resolvedId.includes(':') && c.env.DB) {
    try {
      const db = c.env.DB
      // Decode URL-encoded slug back to Korean
      const decodedSlug = normalizedSlug
      
      // 관리자 여부 확인 (숨겨진 직업 접근 허용)
      const user = c.get('user')
      const role = user?.role as string | undefined
      const isAdmin = user && (role === 'super-admin' || role === 'operator' || role === 'admin')
      const activeCondition = isAdmin ? '' : 'AND is_active = 1'
      
      // 1. 먼저 slug 필드로 직접 조회 (가장 정확)
      let result = await db.prepare(
        `SELECT id, name, is_active FROM jobs WHERE slug = ? ${activeCondition} LIMIT 1`
      ).bind(decodedSlug).first() as { id: string; name: string; is_active: number } | null
      
      // 2. slug로 못 찾으면 정규화된 slug로 검색 (하이픈 제거)
      if (!result) {
        const normalizedSlug = decodedSlug.toLowerCase().replace(/-/g, '')
        
        result = await db.prepare(
          `SELECT id, name, is_active FROM jobs WHERE LOWER(REPLACE(slug, "-", "")) = ? ${activeCondition} LIMIT 1`
        ).bind(normalizedSlug).first() as { id: string; name: string; is_active: number } | null
      }
      
      // 3. 여전히 못 찾으면 이름으로 검색
      if (!result) {
        const normalized = decodedSlug.toLowerCase().replace(/-/g, '')
        
        result = await db.prepare(
          `SELECT id, name, is_active FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? ${activeCondition} LIMIT 1`
        ).bind(normalized).first() as { id: string; name: string; is_active: number } | null
      }
      
      if (result?.id) {
        resolvedId = result.id as string
      } else {
        // Only show "NO MATCH FOUND" if actually no match
        
        // Try to find similar names for debugging
        const firstWord = decodedSlug.split('-')[0]
        if (firstWord && firstWord.length > 1) {
          const similarJobs = await db.prepare(
            'SELECT id, name FROM jobs WHERE name LIKE ? LIMIT 5'
          ).bind(`${firstWord}%`).all() as { results: Array<{ id: string; name: string }> }
          
          if (similarJobs.results?.length > 0) {
            similarJobs.results.forEach((job, idx) => {
              console.log(`  ${idx + 1}. "${job.name}" (${job.id})`)
            })
          }
        }
      }
    } catch (error) {
      console.error('D1 이름 검색 오류:', error)
    }
  }
  
  // Check for debug mode first (bypass ISR cache for debugging)
  // 병합 설계 시스템: 이름이 완전히 같은 직업만 동일 엔티티로 간주
  const debugMode = c.req.query('debug') === 'true'
  if (debugMode) {
    try {
      // 1. 데이터베이스에서 job_sources 가져오기 (이름으로 검색)
      const db = c.env.DB as D1Database
      if (!db) {
        throw new Error('DB not available')
      }

      // resolvedId를 직업명으로 사용 (slug에서 변환된 이름)
      const jobName = resolvedId

      // 통합 job 엔티티에서 job_id 찾기
      const jobRow = await db.prepare(`
        SELECT id, name FROM jobs WHERE id = ? OR name = ? LIMIT 1
      `).bind(jobName, jobName).first<{ id: string; name: string }>()

      if (!jobRow) {
        // 직업을 못 찾으면 검색 페이지로 리다이렉트
        const searchQuery = decodeURIComponent(slug).replace(/-/g, ' ')
        return c.redirect(`/search?q=${encodeURIComponent(searchQuery)}`)
      }

      // 2. 해당 job_id의 모든 소스 가져오기
      let sources = await db.prepare(`
        SELECT * FROM job_sources WHERE job_id = ?
      `).bind(jobRow.id).all<JobSourceRow>()
      
      // job_id가 null인 경우 이름으로 직접 매칭
      if (!sources.results || sources.results.length === 0) {
        console.log('job_id로 찾기 실패, 이름으로 매칭 시도:', jobRow.name)
        
        // normalized와 raw 둘 다 검색
        const normalizedSources = await db.prepare(`
          SELECT * FROM job_sources 
          WHERE JSON_EXTRACT(normalized_payload, '$.name') = ?
        `).bind(jobRow.name).all<JobSourceRow>()
        
        const rawSources = await db.prepare(`
          SELECT * FROM job_sources 
          WHERE JSON_EXTRACT(raw_payload, '$.dJobNm') = ?
          OR raw_payload LIKE ?
        `).bind(jobRow.name, `%"dJobNm":"${jobRow.name}"%`).all<JobSourceRow>()
        
        // 두 결과 합치기 (중복 제거)
        const allResults = [...(normalizedSources.results || []), ...(rawSources.results || [])]
        const uniqueResults = Array.from(new Map(allResults.map(item => [item.source_key, item])).values())
        
        sources = { results: uniqueResults, success: true, meta: normalizedSources.meta }
        console.log(`매칭된 소스: ${uniqueResults.length}개`)
      }

      if (!sources.results || sources.results.length === 0) {
        const fallbackHtml = renderDetailFallback({
          icon: 'fa-database',
          title: '소스 데이터가 없습니다',
          description: '이 직업에 대한 원본 데이터를 찾을 수 없습니다.',
          ctaHref: '/jobs',
          ctaLabel: '직업 목록으로'
        })
        c.status(404)
        return c.html(renderLayoutWithContext(c, fallbackHtml, '소스 데이터 없음 - Careerwiki'))
      }

      // 3. 템플릿 디자인 페이지 렌더링
      const debugContent = renderJobTemplateDesignPage(jobRow.name, sources.results)
      
      return c.html(debugContent)
    } catch (error) {
      console.error('Debug mode error:', error)
      c.status(500)
      return c.html(renderLayoutWithContext(c, renderDetailFallback({
        icon: 'fa-circle-exclamation',
        iconColor: 'text-red-500',
        title: '디버그 데이터 로드 실패',
        description: '일시적인 오류가 발생했습니다.',
        ctaHref: '/job',
        ctaLabel: '직업위키로 돌아가기'
      }), '오류 - Careerwiki'))
    }
  }
  
  // 🆕 ISR (Incremental Static Regeneration) with wiki_pages cache
  return getOrGeneratePage(
    slug,
    'job',
    {
      // Step 1: Fetch data
      fetchData: async (slug, env) => {
        mark?.('fetch-start')
        let careernetId = c.req.query('careernetId') || undefined
        let goyongJobId = c.req.query('goyongJobId') || undefined
        const includeSources = parseSourcesQuery(c.req.query('sources')) || ['CAREERNET', 'GOYONG24']
        
        // 🆕 Redirect to clean URL if query parameters are present
        if (careernetId || goyongJobId) {
          const cleanUrl = `/job/${encodeURIComponent(slug)}`
          // Note: Redirect is handled by returning early, but we'll let ISR handle it
        }
        
        const findSampleJobDetail = () => {
          const candidates = resolvedId !== slug ? [slug, resolvedId] : [slug]
          for (const candidate of candidates) {
            const sample = getSampleJobDetail(candidate)
            if (sample) return sample
          }
          return null
        }
        
        // ⚠️ ISR에서는 sample data의 sourceIds를 사용하지 않음
        // → D1 병합 로직이 자동으로 실행되도록 함
        // (쿼리 파라미터는 이미 위에서 undefined로 설정됨)
        
        const result = await getUnifiedJobDetailWithRawData(
          {
            id: resolvedId,
            careernetId: undefined,  // ⚠️ 명시적으로 undefined (D1 병합 활성화)
            goyong24JobId: undefined,  // ⚠️ 명시적으로 undefined (D1 병합 활성화)
            includeSources
          },
          env
        )
        mark?.('db-fetch')
        
        if (!result.profile) {
          // Try sample data fallback
          const sample = findSampleJobDetail()
          if (sample) {
            throw new Error('SAMPLE_FALLBACK') // Signal to use sample rendering
          }
          
          throw new Error('PROFILE_NOT_FOUND')
        }
        
        // 관련 직업 중 DB에 존재하는 직업 매핑 조회
        let existingJobSlugs = new Map<string, string>()
        const sidebarJobs = result.profile.sidebarJobs
        if (sidebarJobs?.length && env?.DB) {
          try {
            // 관련 직업 이름 추출
            const jobNames = sidebarJobs
              .map((job: any) => job?.name?.trim() || job?.jobNm?.trim() || (typeof job === 'string' ? job.trim() : ''))
              .filter((name: string) => name)
              .slice(0, 20) // 최대 20개만 조회
            
            if (jobNames.length > 0) {
              const placeholders = jobNames.map(() => '?').join(',')
              const query = `SELECT name, slug FROM jobs WHERE name IN (${placeholders})`
              const { results } = await env.DB.prepare(query).bind(...jobNames).all() as { results: Array<{ name: string; slug: string }> | null }
              if (results) {
                for (const row of results) {
                  existingJobSlugs.set(row.name.toLowerCase(), row.slug)
                }
              }
            }
          } catch (e) {
            console.error('[Job ISR fetchData] Failed to query existing jobs:', e)
          }
        }
        
        return {
          ...result,
          existingJobSlugs
        }
      },
      
      // Step 2: Render HTML
      renderHTML: (result) => {
        mark?.('render-start')
        const profile = result.profile!  // Non-null assertion (we already checked in fetchData)
        const canonicalSlug = composeDetailSlug('job', profile.name, profile.id ?? resolvedId)
        const canonicalPath = `/job/${encodeURIComponent(canonicalSlug)}`
        const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)
        const title = `${profile.name} 직업 정보 - Careerwiki`
        const description = createMetaDescription(
          profile.summary,
          profile.duties,
          profile.prospect,
          profile.salary
        )
        const extraHead = [
          '<meta property="og:type" content="article">',
          '<meta property="article:modified_time" content="' + new Date().toISOString() + '">',
          createJobJsonLd(profile, canonicalUrl)
        ].filter(Boolean).join('\n')
        
        const content = renderUnifiedJobDetail({
          profile,
          partials: result.partials,
          sources: result.sources,
          rawApiData: result.rawApiData,
          existingJobSlugs: result.existingJobSlugs
        })
        mark?.('render-done')
        
        return renderLayoutWithContext(c,
          content,
          escapeHtml(title),
          escapeHtml(description),
          false,
          {
            canonical: canonicalUrl,
            ogUrl: canonicalUrl,
            extraHead
          }
        )
      },
      
      // Step 3: Extract metadata
      extractMetadata: (result) => {
        const profile = result.profile!  // Non-null assertion (we already checked in fetchData)
        return {
          title: `${profile.name} 직업 정보 - Careerwiki`,
          description: createMetaDescription(
            profile.summary,
            profile.duties,
            profile.prospect,
            profile.salary
          ),
          og_image_url: undefined // Add later if needed
        }
      }
    },
    c
  ).catch((error) => {
    // Error handling
    console.error('Job detail route error:', error)
    
    // Try sample fallback
    if (error.message === 'SAMPLE_FALLBACK') {
      const findSampleJobDetail = () => {
        const candidates = resolvedId !== slug ? [slug, resolvedId] : [slug]
        for (const candidate of candidates) {
          const sample = getSampleJobDetail(candidate)
          if (sample) return sample
        }
        return null
      }
      
      const sample = findSampleJobDetail()
      if (sample) {
        console.warn('Job detail fallback: serving synthetic sample for', slug)
        return renderSampleJobDetailPage(c, sample)
      }
    }
    
    // 404 for missing profiles -> 검색 페이지로 리다이렉트
    if (error.message === 'PROFILE_NOT_FOUND') {
      const searchQuery = decodeURIComponent(slug).replace(/-/g, ' ')
      return c.redirect(`/search?q=${encodeURIComponent(searchQuery)}`)
    }
    
    // 500 for other errors
    const fallbackHtml = renderDetailFallback({
      icon: 'fa-exclamation-circle',
      iconColor: 'text-red-500',
      title: '직업 정보를 불러오지 못했습니다',
      description: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',
      ctaHref: '/job',
      ctaLabel: '직업위키로 돌아가기'
    })
    c.status(500)
    return c.html(
      renderLayoutWithContext(c,
        fallbackHtml,
        '직업 정보 로드 오류 - Careerwiki',
        '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
      )
    )
  })
})

// Unified Major Detail Page (SSR)
app.get('/major/:slug', async (c) => {
  const mark = c.get('mark') as ((k: string) => void) | undefined
  mark?.('route-start')
  const rawSlug = c.req.param('slug')
  const normalizedSlug = decodeURIComponent(rawSlug).normalize('NFC')
  const slug = normalizedSlug
  let resolvedId = resolveDetailIdFromSlug('major', slug)
  
  // 🆕 If resolvedId doesn't contain ':', try to find by name in D1 (직업 페이지와 동일)
  if (!resolvedId.includes(':') && c.env.DB) {
    try {
      const db = c.env.DB
      // Decode URL-encoded slug back to Korean
      const decodedSlug = decodeURIComponent(slug)
      
      // 관리자 여부 확인 (숨겨진 전공 접근 허용)
      const user = c.get('user')
      const role = user?.role as string | undefined
      const isAdmin = user && (role === 'super-admin' || role === 'operator' || role === 'admin')
      const activeCondition = isAdmin ? '' : 'AND is_active = 1'
      
      // slug도 DB 쿼리와 동일한 정규화 적용 (하이픈, 괄호, 특수문자 제거)
      const normalized = decodedSlug.toLowerCase()
        .replace(/-/g, '')
        .replace(/,/g, '')
        .replace(/·/g, '')
        .replace(/ㆍ/g, '')
        .replace(/\//g, '')
        .replace(/\s/g, '')
        .replace(/\(/g, '')
        .replace(/\)/g, '')
      
      const result = await db.prepare(
        `SELECT id, name, is_active FROM majors WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? ${activeCondition} LIMIT 1`
      ).bind(normalized).first() as { id: string; name: string; is_active: number } | null
      
      if (result?.id) {
        resolvedId = result.id as string
      } else {
      }
    } catch (error) {
      console.error('[Major Slug Resolution] D1 이름 검색 오류:', error)
    }
  }
  
  // Check for debug mode first (bypass ISR cache for debugging)
  // 병합 설계 시스템: 이름이 완전히 같은 전공만 동일 엔티티로 간주
  const debugMode = c.req.query('debug') === 'true'
  if (debugMode) {
    try {
      // 1. 데이터베이스에서 major_sources 가져오기 (이름으로 검색)
      const db = c.env.DB as D1Database
      if (!db) {
        throw new Error('DB not available')
      }

      // resolvedId를 전공명으로 사용 (slug에서 변환된 이름)
      const majorName = resolvedId

      // 통합 major 엔티티에서 major_id 찾기
      const majorRow = await db.prepare(`
        SELECT id, name FROM majors WHERE id = ? OR name = ? LIMIT 1
      `).bind(majorName, majorName).first<{ id: string; name: string }>()

      if (!majorRow) {
        // 전공을 못 찾으면 검색 페이지로 리다이렉트
        const searchQuery = decodeURIComponent(slug).replace(/-/g, ' ')
        return c.redirect(`/search?q=${encodeURIComponent(searchQuery)}`)
      }

      // 2. 해당 major_id의 모든 소스 가져오기
      const sources = await db.prepare(`
        SELECT * FROM major_sources WHERE major_id = ?
      `).bind(majorRow.id).all<MajorSourceRow>()

      if (!sources.results || sources.results.length === 0) {
        const fallbackHtml = renderDetailFallback({
          icon: 'fa-database',
          title: '소스 데이터가 없습니다',
          description: '이 전공에 대한 원본 데이터를 찾을 수 없습니다.',
          ctaHref: '/majors',
          ctaLabel: '전공 목록으로'
        })
        c.status(404)
        return c.html(renderLayoutWithContext(c, fallbackHtml, '소스 데이터 없음 - Careerwiki'))
      }

      // 3. 필드 비교 (전공은 아직 미구현)
      c.status(501)
      const fallbackHtml = renderDetailFallback({
        icon: 'fa-tools',
        title: '전공 필드 비교 준비 중',
        description: '전공 필드 비교 기능은 아직 구현 중입니다. 직업 필드 비교를 먼저 확인해주세요.',
        ctaHref: '/majors',
        ctaLabel: '전공 목록으로'
      })
      return c.html(renderLayoutWithContext(c, fallbackHtml, '준비 중 - Careerwiki'))
    } catch (error) {
      console.error('Debug mode error:', error)
      c.status(500)
      return c.html(renderLayoutWithContext(c, renderDetailFallback({
        icon: 'fa-circle-exclamation',
        iconColor: 'text-red-500',
        title: '디버그 데이터 로드 실패',
        description: error instanceof Error ? error.message : '일시적인 오류가 발생했습니다.',
        ctaHref: '/major',
        ctaLabel: '전공 목록으로'
      }), '오류 - Careerwiki'))
    }
  }
  
  // 🆕 ISR (Incremental Static Regeneration) with wiki_pages cache
  return getOrGeneratePage(
    slug,
    'major',
    {
      // Step 1: Fetch data
      fetchData: async (slug, env) => {
        mark?.('fetch-start')
        const careernetId = c.req.query('careernetId') || undefined
        const majorGbParam = c.req.query('goyongMajorGb')
        const departmentId = c.req.query('goyongDepartmentId') || undefined
        const majorId = c.req.query('goyongMajorId') || undefined
        const includeSources = parseSourcesQuery(c.req.query('sources'))

        const goyongMajorGb = majorGbParam === '1' ? '1' as const : majorGbParam === '2' ? '2' as const : undefined
        const goyongParams = goyongMajorGb && departmentId && majorId
          ? { majorGb: goyongMajorGb, departmentId, majorId } as { majorGb: '1' | '2'; departmentId: string; majorId: string }
          : undefined

        
        const result = await getUnifiedMajorDetail(
          {
            id: resolvedId,
            careernetId,
            goyong24Params: goyongParams,
            includeSources
          },
          env
        )
        mark?.('db-fetch')
        
        
        if (!result.profile) {
          console.error(`[Major ISR fetchData] Profile not found for resolvedId: "${resolvedId}"`)
          
          // Try sample data fallback
          const findSampleMajorDetail = () => {
            const candidates = resolvedId !== slug ? [slug, resolvedId] : [slug]
            for (const candidate of candidates) {
              const sample = getSampleMajorDetail(candidate)
              if (sample) return sample
            }
            return null
          }
          
          const sample = findSampleMajorDetail()
          if (sample) {
            throw new Error('SAMPLE_FALLBACK') // Signal to use sample rendering
          }
          
          throw new Error('PROFILE_NOT_FOUND')
        }

        // 실제 DB ID 찾기 (resolvedId 사용, 이미 DB ID로 해결됨)
        let actualDbId = resolvedId
        
        // profile.id가 composite ID인 경우 실제 DB ID로 업데이트
        if (result.profile.id && result.profile.id.includes(':')) {
        }
        
        // 실제 DB ID로 프로필 업데이트
        
        // 관련 직업 중 DB에 존재하는 직업 매핑 조회
        let existingJobSlugs = new Map<string, string>()
        if (result.profile.relatedJobs?.length && env?.DB) {
          try {
            const jobNames = result.profile.relatedJobs.slice(0, 20) // 최대 20개만 조회
            const placeholders = jobNames.map(() => '?').join(',')
            const query = `SELECT name, slug FROM jobs WHERE name IN (${placeholders})`
            const { results } = await env.DB.prepare(query).bind(...jobNames).all() as { results: Array<{ name: string; slug: string }> | null }
            if (results) {
              for (const row of results) {
                existingJobSlugs.set(row.name, row.slug)
              }
            }
          } catch (e) {
            console.error('[Major ISR fetchData] Failed to query existing jobs:', e)
          }
        }
        
        // 같은 계열 전공 조회 (관련 전공)
        let relatedMajorsByCategory: Array<{ id: string; name: string; slug: string }> = []
        const categoryDisplay = (result.profile as any).categoryDisplay
        if (categoryDisplay && env?.DB) {
          try {
            // 같은 계열의 다른 전공 조회 (자기 자신 제외, 최대 15개)
            const query = `
              SELECT id, name, slug 
              FROM majors 
              WHERE json_extract(merged_profile_json, '$.categoryDisplay') = ? 
                AND id != ? 
                AND is_active = 1
              ORDER BY name
              LIMIT 15
            `
            const { results } = await env.DB.prepare(query)
              .bind(categoryDisplay, actualDbId)
              .all() as { results: Array<{ id: string; name: string; slug: string }> | null }
            if (results) {
              relatedMajorsByCategory = results.map(row => ({
                id: row.id,
                name: row.name,
                slug: row.slug
              }))
            }
          } catch (e) {
            console.error('[Major ISR fetchData] Failed to query related majors by category:', e)
          }
        }
        
        return {
          ...result,
          profile: {
            ...result.profile,
            id: actualDbId
          },
          existingJobSlugs,
          relatedMajorsByCategory
        }
      },

      // Step 2: Render HTML
      renderHTML: (result) => {
        mark?.('render-start')
        const profile = result.profile!  // Non-null assertion (we already checked in fetchData)
        const canonicalSlug = composeDetailSlug('major', profile.name, profile.id ?? resolvedId)
        const canonicalPath = `/major/${encodeURIComponent(canonicalSlug)}`
        const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)
        const title = `${profile.name} 전공 정보 - Careerwiki`
        const description = createMetaDescription(
          profile.summary,
          profile.employmentRate,
          profile.salaryAfterGraduation,
          profile.jobProspect
        )
        const extraHead = [
          '<meta property="og:type" content="article">',
          '<meta property="article:modified_time" content="' + new Date().toISOString() + '">',
          createMajorJsonLd(profile, canonicalUrl)
        ].filter(Boolean).join('\n')

        const content = renderUnifiedMajorDetail({
          profile,
          partials: result.partials,
          sources: result.sources,
          existingJobSlugs: result.existingJobSlugs,
          relatedMajorsByCategory: result.relatedMajorsByCategory
        })
        mark?.('render-done')

        return renderLayoutWithContext(c,
          content,
          escapeHtml(title),
          escapeHtml(description),
          false,
          {
            canonical: canonicalUrl,
            ogUrl: canonicalUrl,
            extraHead
          }
        )
      },

      // Step 3: Extract metadata
      extractMetadata: (result) => {
        const profile = result.profile!  // Non-null assertion (we already checked in fetchData)
        return {
          title: `${profile.name} 전공 정보 - Careerwiki`,
          description: createMetaDescription(
            profile.summary,
            profile.employmentRate,
            profile.salaryAfterGraduation,
            profile.jobProspect
          ),
          og_image_url: undefined // Add later if needed
        }
      }
    },
    c
  ).catch((error) => {
    // Error handling
    console.error('Major detail route error:', error)
    
    // Try sample fallback
    if (error.message === 'SAMPLE_FALLBACK') {
      const findSampleMajorDetail = () => {
        const candidates = resolvedId !== slug ? [slug, resolvedId] : [slug]
        for (const candidate of candidates) {
          const sample = getSampleMajorDetail(candidate)
          if (sample) return sample
        }
        return null
      }
      
      const sample = findSampleMajorDetail()
      if (sample) {
        console.warn('Major detail fallback: serving synthetic sample for', slug)
        return renderSampleMajorDetailPage(c, sample)
      }
    }
    
    // 404 for missing profiles -> 검색 페이지로 리다이렉트
    if (error.message === 'PROFILE_NOT_FOUND') {
      const searchQuery = decodeURIComponent(slug).replace(/-/g, ' ')
      return c.redirect(`/search?q=${encodeURIComponent(searchQuery)}`)
    }
    
    // 500 for other errors
    const fallbackHtml = renderDetailFallback({
      icon: 'fa-exclamation-circle',
      iconColor: 'text-red-500',
      title: '전공 정보를 불러오지 못했습니다',
      description: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',
      ctaHref: '/major',
      ctaLabel: '전공위키로 돌아가기'
    })
    c.status(500)
    return c.html(
      renderLayoutWithContext(c,
        fallbackHtml,
        '전공 정보 로드 오류 - Careerwiki',
        '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
      )
    )
  })
})

const parseSourcesQuery = (value?: string | null): DataSource[] | undefined => {
  if (!value) return undefined
  const tokens = value
    .split(',')
    .map((token) => token.trim().toUpperCase())
    .filter((token) => token.length > 0) as (DataSource | string)[]
  const validSources: DataSource[] = []
  tokens.forEach((token) => {
    if (token === 'CAREERNET' || token === 'GOYONG24') {
      if (!validSources.includes(token)) {
        validSources.push(token)
      }
    }
  })
  return validSources.length ? validSources : undefined
}

const parseNumberParam = (
  value: string | undefined,
  fallback: number,
  options?: { min?: number; max?: number }
): number => {
  if (!value) return fallback
  const parsed = Number(value)
  if (!Number.isFinite(parsed)) {
    return fallback
  }

  let result = Math.floor(parsed)
  if (options?.min !== undefined && result < options.min) {
    result = options.min
  }
  if (options?.max !== undefined && result > options.max) {
    result = options.max
  }
  if (options?.min === undefined && result <= 0) {
    return fallback
  }
  return result
}

const toIntegerOrNull = (
  value: unknown,
  options?: { min?: number; max?: number }
): number | null => {
  if (typeof value !== 'number' || !Number.isFinite(value)) {
    return null
  }

  let result = Math.floor(value)
  if (options?.min !== undefined && result < options.min) {
    result = options.min
  }
  if (options?.max !== undefined && result > options.max) {
    result = options.max
  }
  return result
}

// 취업률 포맷 함수: "70% 이상" 같은 텍스트에서 숫자 추출 후 소수점 1자리까지 반올림
const formatEmploymentRate = (rate: string | undefined): string | undefined => {
  if (!rate) return undefined
  // HTML 태그 제거 및 공백 정리
  const cleaned = rate.replace(/<[^>]*>/g, '').trim()
  // 숫자 추출 (정수 또는 소수)
  const match = cleaned.match(/([\d.]+)/)
  if (!match) return cleaned
  const num = parseFloat(match[1])
  if (isNaN(num)) return cleaned
  // 소수점 1자리까지 반올림, 정수면 정수로 표시
  const rounded = Math.round(num * 10) / 10
  return Number.isInteger(rounded) ? `${rounded}%` : `${rounded.toFixed(1)}%`
}

const escapeHtml = (value: string): string =>
  value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')

// 안전한 날짜 포맷팅 함수 (Unix timestamp 초 단위 또는 DATETIME 문자열 모두 처리)
const formatDateSafe = (dateValue: string | number | null | undefined): string => {
  if (!dateValue) return ''
  try {
    // 숫자인 경우 Unix timestamp (초 단위)로 간주하고 밀리초로 변환
    if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d+$/.test(dateValue))) {
      const timestamp = typeof dateValue === 'number' ? dateValue : parseInt(dateValue, 10)
      return new Date(timestamp * 1000).toLocaleDateString('ko-KR')
    }
    // 문자열인 경우 DATETIME 형식으로 간주
    return new Date(dateValue).toLocaleDateString('ko-KR')
  } catch {
    return ''
  }
}

const serializeForScript = (value: unknown): string =>
  JSON.stringify(value)
    .replace(/</g, '\\u003C')
    .replace(/>/g, '\\u003E')
    .replace(/&/g, '\\u0026')

const createMetaDescription = (...candidates: Array<string | undefined | null>): string => {
  for (const candidate of candidates) {
    if (!candidate) continue
    const normalized = candidate.replace(/\s+/g, ' ').trim()
    if (!normalized) continue
    if (normalized.length <= 160) {
      return normalized
    }
    return `${normalized.slice(0, 157)}…`
  }
  return 'Careerwiki는 고용24와 커리어넷 데이터를 통합해 제공하는 진로 정보 플랫폼입니다.'
}

// ============================================================================
// 카드 렌더링 공통 함수 (SSR + API 공유)
// ============================================================================

// 만족도 등급 계산 (직업/전공 공통)
const getSatisfactionGrade = (satisfaction: string | undefined) => {
  if (!satisfaction) return null
  const score = parseFloat(satisfaction) || 0
  
  if (score >= 80) {
    return { level: '매우 좋음', bg: 'bg-green-500/10', border: 'border-green-500/20', iconColor: 'text-green-400', textColor: 'text-green-300', textMuted: 'text-green-300/80' }
  } else if (score >= 60) {
    return { level: '좋음', bg: 'bg-sky-500/10', border: 'border-sky-500/20', iconColor: 'text-sky-400', textColor: 'text-sky-300', textMuted: 'text-sky-300/80' }
  } else if (score >= 40) {
    return { level: '보통', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', iconColor: 'text-yellow-400', textColor: 'text-yellow-300', textMuted: 'text-yellow-300/80' }
  } else if (score >= 20) {
    return { level: '별로', bg: 'bg-orange-500/10', border: 'border-orange-500/20', iconColor: 'text-orange-400', textColor: 'text-orange-300', textMuted: 'text-orange-300/80' }
  } else {
    return { level: '매우 별로', bg: 'bg-red-500/10', border: 'border-red-500/20', iconColor: 'text-red-400', textColor: 'text-red-300', textMuted: 'text-red-300/80' }
  }
}

// 직업 요약 텍스트 포맷
const formatJobSummaryText = (value?: string | null): string => {
  const fallback = '고용24와 커리어넷 데이터를 통합하여 제공하는 직업 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
  if (!value) return fallback
  const normalized = value.replace(/\s+/g, ' ').trim()
  if (!normalized) return fallback
  return normalized.length > 220 ? `${normalized.slice(0, 217)}…` : normalized
}

// 전공 요약 텍스트 포맷
const formatMajorSummaryText = (value?: string | null): string => {
  const fallback = '고용24와 커리어넷 데이터를 통합하여 제공하는 학과 정보입니다. 상세 페이지에서 자세한 내용을 확인하세요.'
  if (!value) return fallback
  const normalized = value.replace(/\s+/g, ' ').trim()
  if (!normalized) return fallback
  return normalized.length > 220 ? `${normalized.slice(0, 217)}…` : normalized
}

// 숙련기간 포맷팅: 단위가 같을 때 앞 단위 제거 (예: "1년~2년" → "1~2년")
const formatSkillYear = (value?: string | null): string => {
  if (!value) return ''
  let trimmed = String(value).trim()
  if (!trimmed) return ''
  
  // "초과", "이하" 제거
  trimmed = trimmed
    .replace(/\s*초과\s*/g, ' ')
    .replace(/\s*이하\s*/g, '')
    .replace(/\s+/g, ' ')
    .trim()
  
  // "~" 또는 "-"로 구분된 범위 형식인지 확인 (공백 무시)
  const rangeMatch = trimmed.match(/^(.+?)\s*([~-])\s*(.+)$/)
  if (!rangeMatch) return trimmed // 범위 형식이 아니면 그대로 반환
  
  const [, start, separator, end] = rangeMatch
  
  // 단위 추출 (년, 개월 등) - 앞뒤 공백 제거
  const startTrimmed = start.trim()
  const unitMatch = startTrimmed.match(/(\d+)\s*(년|개월|월)$/)
  if (!unitMatch) return trimmed // 단위가 없으면 그대로 반환
  
  const [, startNum, unit] = unitMatch
  
  // 끝 부분에서 같은 단위가 있는지 확인 - 앞뒤 공백 제거
  const endTrimmed = end.trim()
  const endMatch = endTrimmed.match(/^(\d+)\s*(년|개월|월)$/)
  if (!endMatch) return trimmed // 끝 부분에 단위가 없으면 그대로 반환
  
  const [, endNum, endUnit] = endMatch
  
  // 단위가 같으면 앞 단위 제거
  if (unit === endUnit) {
    return `${startNum}${separator}${endNum}${unit}`
  }
  
  // 단위가 다르면 그대로 반환
  return trimmed
}

// 직업 카드 HTML 렌더링
const renderJobCard = (entry: { profile: any; display?: any }): string => {
  const job = entry.profile
  const display = entry.display ?? {}
  const jobSlug = composeDetailSlug('job', job.name, job.id)
  const jobUrl = `/job/${encodeURIComponent(jobSlug)}`
  const summary = escapeHtml(formatJobSummaryText(display.summary))
  // categoryName이 객체일 수 있으므로 문자열 추출
  const rawCategoryName = display.categoryName || job.category?.name
  const normalizeCategory = (value: any): string => {
    let cat =
      typeof value === 'string'
        ? value
        : (value?.value || value?.large || value?.name || value?.medium || value?.small || '')
    if (cat.includes('›')) cat = cat.split('›')[0].trim()
    else if (cat.includes('>')) cat = cat.split('>')[0].trim()
    return cat
  }
  const categoryName = normalizeCategory(rawCategoryName)
  
  const satisfactionGrade = getSatisfactionGrade(display.satisfaction)
  
  // 메트릭 박스 생성 (우선순위: 평균 연봉 > 만족도 > 워라벨 > 작업 강도 > 숙련기간)
  type MetricBox = { html: string; mobileHtml: string; priority: number }
  const metricBoxes: MetricBox[] = []
  
  // 1. 평균 연봉 (최우선)
  if (display.salary) {
    const salaryText = display.salary.replace(/평균\s*/g, '')
    metricBoxes.push({
      priority: 1,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-emerald-500/10 backdrop-blur-sm border border-emerald-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-won-sign text-emerald-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-emerald-300/70">평균 연봉</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-emerald-300 text-center leading-tight px-1">${escapeHtml(salaryText)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-won-sign text-[10px]"></i>
          <span>평균 연봉: ${escapeHtml(salaryText)}</span>
        </span>
      `
    })
  }
  
  // 2. 만족도
  if (display.satisfaction && satisfactionGrade) {
    metricBoxes.push({
      priority: 2,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg ${satisfactionGrade.bg} backdrop-blur-sm border ${satisfactionGrade.border} w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-smile ${satisfactionGrade.iconColor} text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium ${satisfactionGrade.textMuted}">만족도</span>
          <span class="text-[11px] sm:text-[13px] font-bold ${satisfactionGrade.textColor}">${escapeHtml(satisfactionGrade.level)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full ${satisfactionGrade.bg} border ${satisfactionGrade.border} ${satisfactionGrade.textColor} text-xs font-medium whitespace-nowrap">
          <i class="fas fa-smile text-[10px]"></i>
          <span>만족도: ${escapeHtml(satisfactionGrade.level)}</span>
        </span>
      `
    })
  }
  
  // 3. 워라벨
  if (display.wlb) {
    metricBoxes.push({
      priority: 3,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-purple-500/10 backdrop-blur-sm border border-purple-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-balance-scale text-purple-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-purple-300/70">워라벨</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-purple-300 text-center leading-tight">${escapeHtml(display.wlb)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-purple-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-balance-scale text-[10px]"></i>
          <span>워라벨: ${escapeHtml(display.wlb)}</span>
        </span>
      `
    })
  }
  
  // 4. 작업 강도 (직업사전)
  if (display.workStrong) {
    metricBoxes.push({
      priority: 4,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-amber-500/10 backdrop-blur-sm border border-amber-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-dumbbell text-amber-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-amber-300/70">작업 강도</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-amber-300 text-center leading-tight">${escapeHtml(display.workStrong)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-dumbbell text-[10px]"></i>
          <span>작업 강도: ${escapeHtml(display.workStrong)}</span>
        </span>
      `
    })
  }
  
  // 5. 숙련기간 (직업사전)
  if (display.skillYear) {
    const formattedSkillYear = formatSkillYear(display.skillYear)
    metricBoxes.push({
      priority: 5,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-cyan-500/10 backdrop-blur-sm border border-cyan-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-clock text-cyan-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-cyan-300/70">숙련기간</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-cyan-300 text-center leading-tight">${escapeHtml(formattedSkillYear)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-cyan-500/10 border border-cyan-500/20 text-cyan-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-clock text-[10px]"></i>
          <span>숙련기간: ${escapeHtml(formattedSkillYear)}</span>
        </span>
      `
    })
  }
  
  // 우선순위 정렬
  const sortedBoxes = metricBoxes.sort((a, b) => a.priority - b.priority)
  
  // 데스크톱용 메트릭 박스 HTML (최대 3개, 3번째 박스는 모바일에서 숨김)
  const desktopBoxes = sortedBoxes.slice(0, 3)
  const metricsHtml = desktopBoxes.map((box, index) => {
    if (index === 2) {
      return `<div class="hidden sm:flex">${box.html}</div>`
    }
    return box.html
  }).join('')
  
  // 모바일용 메트릭 태그 HTML (모든 메트릭 표시)
  const mobileMetricsHtml = sortedBoxes.map(box => box.mobileHtml).join('')

  // 썸네일 이미지 URL (메트릭 박스와 같거나 큰 크기, 수직 중앙 정렬)
  const imageUrl = display.imageUrl
  const thumbnailHtml = imageUrl 
    ? `<div class="flex-shrink-0 self-center w-[76px] h-[76px] sm:w-[92px] sm:h-[92px] rounded-xl overflow-hidden bg-wiki-card/60 border border-wiki-border/30">
         <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(job.name)}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center w-full h-full text-wiki-muted\\' aria-hidden=\\'true\\'><i class=\\'fas fa-briefcase text-3xl\\'></i></div>'" />
       </div>`
    : `<div class="flex-shrink-0 self-center w-[76px] h-[76px] sm:w-[92px] sm:h-[92px] rounded-xl bg-gradient-to-br from-wiki-primary/10 to-wiki-secondary/10 border border-wiki-border/30 flex items-center justify-center">
         <i class="fas fa-briefcase text-3xl text-wiki-muted" aria-hidden="true"></i>
       </div>`

  return `
    <article class="group relative">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-wiki-card/40 via-wiki-card/60 to-wiki-card/40 backdrop-blur-xl border border-wiki-border/40 p-4 sm:p-6 transition-all duration-500 ease-out hover:border-wiki-primary/40 hover:shadow-xl hover:shadow-wiki-primary/5 hover:-translate-y-1">
          <!-- 배경 그라데이션 글로우 -->
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none">
            <div class="absolute -top-24 -right-24 w-48 h-48 bg-wiki-primary/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-wiki-secondary/10 rounded-full blur-3xl"></div>
          </div>
          
        <!-- 클릭 가능한 링크 영역 -->
        <a href="${jobUrl}" class="block">
          <div class="relative flex gap-3 sm:gap-4 items-center">
            <!-- 썸네일 (데스크톱: 왼쪽, 중간 정렬) -->
            <div class="hidden sm:block flex-shrink-0 self-center">
            ${thumbnailHtml}
            </div>
            
            <!-- 직업 정보 -->
            <div class="flex-1 space-y-3 sm:space-y-4 min-w-0 sm:max-w-[60%] pr-[84px] sm:pr-0">
              <!-- 헤더: 카테고리 + 직업명 -->
              <div class="space-y-1.5 sm:space-y-2">
                ${categoryName ? `
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 sm:gap-1.5 px-1.5 sm:px-2 py-0.5 sm:py-0.5 rounded-md sm:rounded-md rounded-full sm:rounded-md text-[9px] sm:text-[10px] text-xs sm:text-[10px] font-semibold sm:font-semibold font-medium sm:font-semibold uppercase tracking-wider bg-wiki-secondary/10 text-wiki-secondary/80 border border-wiki-secondary/20">
                      <i class="fas fa-folder text-[7px] sm:text-[8px] text-[10px] sm:text-[8px]"></i>
                      ${escapeHtml(categoryName)}
                    </span>
                  </div>
                ` : ''}
                
                <h2 class="text-lg sm:text-xl font-bold text-white group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-wiki-primary group-hover:to-wiki-secondary group-hover:bg-clip-text transition-all duration-300">
                  ${escapeHtml(job.name)}
                </h2>
              </div>
              
              <!-- 설명 -->
              <p class="text-[13px] sm:text-[15px] leading-relaxed text-wiki-muted/90 line-clamp-2">
                ${summary}
              </p>
            </div>
            
            <!-- 썸네일 (모바일: 오른쪽, 태그 영역 제외한 중간 정렬) -->
            <div class="sm:hidden absolute right-0 top-1/2 -translate-y-1/2 flex-shrink-0" style="transform: translateY(-50%);">
              ${thumbnailHtml}
            </div>
            
            <!-- 데스크톱: 오른쪽 메트릭 박스들 (최대 3개) -->
            ${metricsHtml ? `
              <div class="hidden sm:flex gap-2 sm:gap-2.5 items-center justify-end flex-shrink-0 ml-auto">
                ${metricsHtml}
              </div>
            ` : ''}
        </div>
      </a>
        
        <!-- 모바일: 메트릭 태그들 가로 스크롤 (a 태그 바깥) -->
        ${mobileMetricsHtml ? `
          <div class="sm:hidden mt-3 overflow-x-auto" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
            <div class="flex gap-2 w-max">
              ${mobileMetricsHtml}
            </div>
          </div>
        ` : ''}
      </div>
    </article>
  `
}

// 전공 카드 HTML 렌더링
const renderMajorCard = (entry: { profile: any; display?: any }): string => {
  const major = entry.profile
  const display = entry.display ?? {}
  const majorSlug = composeDetailSlug('major', major.name, major.id)
  const majorUrl = `/major/${encodeURIComponent(majorSlug)}`
  const summary = escapeHtml(formatMajorSummaryText(display.summary))
  // 계열 이름: 객체일 수 있으므로 문자열 추출, 콤마가 2개 이하인 경우에만 표시
  const rawCategoryName = typeof display.categoryName === 'string' 
    ? display.categoryName 
    : (display.categoryName?.value || display.categoryName?.large || display.categoryName?.name || '')
  const categoryName = rawCategoryName && rawCategoryName.split(',').length <= 2
    ? rawCategoryName
    : undefined
  
  const satisfactionGrade = getSatisfactionGrade(display.firstJobSatisfaction)
  
  // 메트릭 박스 생성 (우선순위: 취업률 > 첫직장월급 > 만족도 > 계열)
  type MetricBox = { html: string; mobileHtml: string; priority: number }
  const metricBoxes: MetricBox[] = []
  
  // 1. 취업률 (최우선)
  if (display.employmentRate) {
    const rateText = formatEmploymentRate(display.employmentRate) || ''
    metricBoxes.push({
      priority: 1,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-blue-500/10 backdrop-blur-sm border border-blue-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-chart-line text-blue-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-blue-300/70">취업률</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-blue-300 text-center leading-tight px-1">${escapeHtml(rateText)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-chart-line text-[10px]"></i>
          <span>취업률: ${escapeHtml(rateText)}</span>
        </span>
      `
    })
  }
  
  // 2. 평균 월급
  if (display.firstJobSalary) {
    const salaryText = display.firstJobSalary.includes('만원') ? display.firstJobSalary : `${display.firstJobSalary}만원`
    metricBoxes.push({
      priority: 2,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-emerald-500/10 backdrop-blur-sm border border-emerald-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-won-sign text-emerald-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-emerald-300/70">평균 월급</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-emerald-300 text-center leading-tight px-1">${escapeHtml(salaryText)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-won-sign text-[10px]"></i>
          <span>평균 월급: ${escapeHtml(salaryText)}</span>
        </span>
      `
    })
  }
  
  // 3. 만족도
  if (display.firstJobSatisfaction && satisfactionGrade) {
    metricBoxes.push({
      priority: 3,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg ${satisfactionGrade.bg} backdrop-blur-sm border ${satisfactionGrade.border} w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-smile ${satisfactionGrade.iconColor} text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium ${satisfactionGrade.textMuted}">만족도</span>
          <span class="text-[11px] sm:text-[13px] font-bold ${satisfactionGrade.textColor}">${escapeHtml(satisfactionGrade.level)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full ${satisfactionGrade.bg} border ${satisfactionGrade.border} ${satisfactionGrade.textColor} text-xs font-medium whitespace-nowrap">
          <i class="fas fa-smile text-[10px]"></i>
          <span>만족도: ${escapeHtml(satisfactionGrade.level)}</span>
        </span>
      `
    })
  }
  
  // 4. 계열
  if (categoryName) {
    metricBoxes.push({
      priority: 4,
      html: `
        <div class="flex flex-col items-center justify-center gap-1 p-2.5 rounded-lg bg-purple-500/10 backdrop-blur-sm border border-purple-500/20 w-[84px] h-[76px] sm:w-[100px] sm:h-[92px] flex-shrink-0">
          <i class="fas fa-graduation-cap text-purple-400 text-base sm:text-lg"></i>
          <span class="text-[9px] sm:text-[10px] font-medium text-purple-300/70">계열</span>
          <span class="text-[11px] sm:text-[13px] font-bold text-purple-300 text-center leading-tight px-1">${escapeHtml(categoryName.length > 10 ? categoryName.substring(0, 10) + '...' : categoryName)}</span>
        </div>
      `,
      mobileHtml: `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-purple-300 text-xs font-medium whitespace-nowrap">
          <i class="fas fa-graduation-cap text-[10px]"></i>
          <span>계열: ${escapeHtml(categoryName)}</span>
        </span>
      `
    })
  }
  
  // 우선순위 정렬
  const sortedBoxes = metricBoxes.sort((a, b) => a.priority - b.priority)
  
  // 데스크톱용 메트릭 박스 HTML (최대 3개, 3번째 박스는 모바일에서 숨김)
  const desktopBoxes = sortedBoxes.slice(0, 3)
  const metricsHtml = desktopBoxes.map((box, index) => {
    if (index === 2) {
      return `<div class="hidden sm:flex">${box.html}</div>`
    }
    return box.html
  }).join('')
  
  // 모바일용 메트릭 태그 HTML (모든 메트릭 표시)
  const mobileMetricsHtml = sortedBoxes.map(box => box.mobileHtml).join('')

  // 썸네일 이미지 URL (메트릭 박스와 같거나 큰 크기, 수직 중앙 정렬)
  const imageUrl = display.imageUrl
  const thumbnailHtml = imageUrl 
    ? `<div class="flex-shrink-0 self-center w-[76px] h-[76px] sm:w-[92px] sm:h-[92px] rounded-xl overflow-hidden bg-wiki-card/60 border border-wiki-border/30">
         <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(major.name)}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center w-full h-full text-wiki-muted\\' aria-hidden=\\'true\\'><i class=\\'fas fa-graduation-cap text-3xl\\'></i></div>'" />
       </div>`
    : `<div class="flex-shrink-0 self-center w-[76px] h-[76px] sm:w-[92px] sm:h-[92px] rounded-xl bg-gradient-to-br from-wiki-secondary/10 to-wiki-primary/10 border border-wiki-border/30 flex items-center justify-center">
         <i class="fas fa-graduation-cap text-3xl text-wiki-muted" aria-hidden="true"></i>
       </div>`

  return `
    <article class="group relative">
      <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-wiki-card/40 via-wiki-card/60 to-wiki-card/40 backdrop-blur-xl border border-wiki-border/40 p-4 sm:p-6 transition-all duration-500 ease-out hover:border-wiki-primary/40 hover:shadow-xl hover:shadow-wiki-primary/5 hover:-translate-y-1">
        <!-- 배경 그라데이션 글로우 -->
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none">
          <div class="absolute -top-24 -right-24 w-48 h-48 bg-wiki-primary/10 rounded-full blur-3xl"></div>
          <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-wiki-secondary/10 rounded-full blur-3xl"></div>
        </div>
        
        <!-- 클릭 가능한 링크 영역 -->
        <a href="${majorUrl}" class="block">
          <div class="relative flex gap-3 sm:gap-4 items-center">
            <!-- 썸네일 (데스크톱: 왼쪽, 중간 정렬) -->
            <div class="hidden sm:block flex-shrink-0 self-center">
              ${thumbnailHtml}
            </div>
            
            <!-- 전공 정보 -->
            <div class="flex-1 space-y-3 sm:space-y-4 min-w-0 sm:max-w-[60%] pr-[84px] sm:pr-0">
              <!-- 헤더: 전공명 -->
              <div class="space-y-1.5 sm:space-y-2">
                <h2 class="text-lg sm:text-xl font-bold text-white group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-wiki-primary group-hover:to-wiki-secondary group-hover:bg-clip-text transition-all duration-300">
                  ${escapeHtml(major.name)}
                </h2>
              </div>
              
              <!-- 설명 -->
              <p class="text-[13px] sm:text-[15px] leading-relaxed text-wiki-muted/90 line-clamp-2">
                ${summary}
              </p>
            </div>
            
            <!-- 썸네일 (모바일: 오른쪽, 수직 중앙 정렬) -->
            <div class="sm:hidden absolute right-0 top-1/2 -translate-y-1/2 flex-shrink-0" style="transform: translateY(-50%);">
              ${thumbnailHtml}
            </div>
            
            <!-- 데스크톱: 오른쪽 메트릭 박스들 (최대 3개) -->
            ${metricsHtml ? `
              <div class="hidden sm:flex gap-2 sm:gap-2.5 items-center justify-end flex-shrink-0 ml-auto">
                ${metricsHtml}
              </div>
            ` : ''}
          </div>
        </a>
        
        <!-- 모바일: 메트릭 태그 가로 스크롤 (카드 패딩 내부) -->
        ${mobileMetricsHtml ? `
          <div class="sm:hidden mt-3 overflow-x-auto" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
            <div class="flex gap-2 w-max">
              ${mobileMetricsHtml}
            </div>
          </div>
        ` : ''}
      </div>
    </article>
  `
}

const renderDetailFallback = (options: {
  icon: string
  title: string
  description: string
  ctaHref: string
  ctaLabel: string
  iconColor?: string
  note?: string
}): string => {
  const { icon, title, description, ctaHref, ctaLabel, iconColor = 'text-wiki-muted', note } = options
  return `
    <div class="max-w-3xl mx-auto text-center py-20">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-wiki-border/30 mb-6">
        <i class="fas ${icon} ${iconColor} text-3xl"></i>
      </div>
      <h1 class="text-3xl font-bold mb-4 text-white">${escapeHtml(title)}</h1>
      <p class="text-wiki-muted mb-6">${escapeHtml(description)}</p>
      ${note ? `<p class="text-xs text-wiki-muted mb-6">${escapeHtml(note)}</p>` : ''}
      <a href="${escapeHtml(ctaHref)}" class="inline-flex items-center gap-2 px-6 py-3 bg-wiki-primary text-white rounded-lg hover:bg-blue-600 transition">
        <i class="fas fa-arrow-left"></i><span>${escapeHtml(ctaLabel)}</span>
      </a>
    </div>
  `
}

type SampleHighlight = {
  slug: string
  title: string
  snippet: string
  keywords: string[]
}

const renderSampleHighlightBadges = (keywords: string[] | undefined): string => {
  if (!keywords || keywords.length === 0) return ''
  const chips = keywords
    .slice(0, 6)
    .map((keyword) => `<span class="px-3 py-1 rounded-full bg-wiki-bg border border-wiki-border text-xs text-wiki-muted">${escapeHtml(keyword)}</span>`)
    .join('')
  return `<div class="flex flex-wrap gap-2">${chips}</div>`
}

const renderSampleHighlightCards = (
  samples: SampleHighlight[],
  basePath: 'job' | 'major',
  notice: { title: string; description: string; badge: string }
): string => {
  if (!samples.length) {
    return `
      <div class="glass-card p-12 rounded-2xl text-center">
        <i class="fas fa-lightbulb text-4xl text-wiki-secondary mb-4"></i>
        <h2 class="text-2xl font-semibold text-white mb-2">${escapeHtml(notice.title)}</h2>
        <p class="text-sm text-wiki-muted">${escapeHtml(notice.description)}</p>
      </div>
    `
  }

  const cards = samples
    .map((sample) => {
      const href = `/${basePath}/${encodeURIComponent(sample.slug)}`
      const badges = renderSampleHighlightBadges(sample.keywords)
      return `
        <article class="glass-card h-full p-6 rounded-2xl border border-wiki-border/60 bg-wiki-bg/70">
          <div class="flex flex-col h-full gap-4">
            <div>
              <h3 class="text-xl font-semibold text-white">
                <a href="${href}" class="hover:text-wiki-secondary transition">${escapeHtml(sample.title)}</a>
              </h3>
              <p class="text-xs text-wiki-muted uppercase tracking-wide mt-1">${escapeHtml(notice.badge)}</p>
            </div>
            <p class="text-sm text-wiki-muted leading-relaxed flex-1">${escapeHtml(sample.snippet)}</p>
            ${badges}
            <div class="pt-2">
              <a href="${href}" class="inline-flex items-center gap-2 text-sm text-wiki-primary hover:text-wiki-secondary transition">
                자세히 보기<i class="fas fa-arrow-right"></i>
              </a>
            </div>
          </div>
        </article>
      `
    })
    .join('')

  return `
    <section class="space-y-6">
      <div class="glass-card p-8 rounded-2xl border border-wiki-border/60 bg-wiki-bg/60 text-center">
        <h2 class="text-2xl font-semibold text-white mb-2">${escapeHtml(notice.title)}</h2>
        <p class="text-sm text-wiki-muted">${escapeHtml(notice.description)}</p>
      </div>
      <div class="grid gap-4 md:grid-cols-3">${cards}</div>
    </section>
  `
}

const renderSampleJobHighlights = (limit = 3): string =>
  renderSampleHighlightCards(listSampleJobSummaries().slice(0, limit), 'job', {
    title: 'Phase 1 샘플 직업 살펴보기',
    description: 'CareerWiki 통합 데이터가 준비되는 동안 합성 직업 샘플을 참고해 주세요.',
    badge: 'Phase 1 Synthetic Sample'
  })

const renderSampleMajorHighlights = (limit = 3): string =>
  renderSampleHighlightCards(listSampleMajorSummaries().slice(0, limit), 'major', {
    title: 'Phase 1 샘플 전공 미리보기',
    description: 'CareerWiki가 제공할 전공 데이터를 Phase 1 합성 샘플로 먼저 확인해 보세요.',
    badge: 'Phase 1 Synthetic Sample'
  })

const describeSkipReason = (reason?: string): string => {
  switch (reason) {
    case 'missing-id':
      return '식별자 정보가 부족해 호출되지 않았습니다.'
    case 'missing-params':
      return '필수 파라미터가 부족해 호출되지 않았습니다.'
    case 'keyword-required':
      return '키워드가 없어 호출되지 않았습니다.'
    case 'excluded':
      return '요청한 데이터 소스에서 제외되었습니다.'
    default:
      return reason ? `호출되지 않음 (${reason})` : '호출되지 않았습니다.'
  }
}

const renderSourceStatusSummary = (
  sources?: SourceStatusRecord,
  options?: { id?: string }
): string => {
  const idAttr = options?.id ? ` id="${escapeHtml(options.id)}"` : ''
  if (!sources) {
    return options?.id ? `<div${idAttr}></div>` : ''
  }
  const entries = Object.entries(sources) as Array<[DataSource, SourceStatusRecord[DataSource]]>
  const rows = entries
    .map(([source, status]) => {
      const label = SOURCE_LABEL_MAP[source] ?? source
      let message: string
      if (status?.error) {
        message = `오류: ${status.error}`
      } else if (typeof status?.count === 'number' && status.count > 0) {
        message = `데이터 ${status.count}건 수신`
      } else if (status?.attempted) {
        message = '호출되었으나 제공 가능한 데이터가 없습니다.'
      } else {
        message = describeSkipReason(status?.skippedReason)
      }
      return `
        <li class="flex items-start justify-between gap-4">
          <span class="text-sm font-semibold text-wiki-text">${escapeHtml(label)}</span>
          <span class="text-xs text-wiki-muted text-right">${escapeHtml(message)}</span>
        </li>
      `
    })
    .join('')
  if (!rows) {
    return options?.id ? `<div${idAttr}></div>` : ''
  }
  return `
    <div${idAttr} class="glass-card p-6 rounded-xl mt-8">
      <h2 class="text-lg font-semibold text-wiki-text mb-3">데이터 수집 상태</h2>
      <ul class="space-y-2">${rows}</ul>
    </div>
  `
}

const renderCacheNotice = (
  state?: CacheState,
  options?: { staleSeconds: number; maxAgeSeconds: number }
): string => {
  if (!state || state.status === 'bypass') return ''

  const statusLabels: Record<CacheState['status'], string> = {
    miss: 'Cloudflare KV에 새로 저장된 데이터',
    hit: 'Cloudflare KV 캐시 적중',
    revalidated: '캐시 재검증 완료',
    stale: '임시 캐시 데이터 제공',
    bypass: '캐시 미사용'
  }

  const accentClasses: Record<CacheState['status'], string> = {
    miss: 'text-wiki-secondary',
    hit: 'text-wiki-secondary',
    revalidated: 'text-green-400',
    stale: 'text-yellow-300',
    bypass: 'text-wiki-muted'
  }

  const statusLabel = statusLabels[state.status] ?? '캐시 상태'
  const accent = accentClasses[state.status] ?? 'text-wiki-muted'

  const detailText = [
    `캐시 생성: ${formatTimestamp(state.cachedAt)}`,
    `재검증 예정: ${formatTimestamp(state.staleAt)}`,
    `만료 예정: ${formatTimestamp(state.expiresAt)}`
  ].join(' · ')

  const durationText = options
    ? `재검증 주기 ${secondsToHuman(options.staleSeconds)}, 최대 보존 ${secondsToHuman(options.maxAgeSeconds)}`
    : undefined

  return `
    <div class="glass-card p-4 rounded-xl mb-6 border border-wiki-border/70 bg-wiki-bg/70">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="text-sm font-semibold ${accent}"><i class="fas fa-cloud mr-2"></i>${escapeHtml(statusLabel)}</p>
          <p class="text-xs text-wiki-muted mt-1">${escapeHtml(detailText)}</p>
        </div>
        ${durationText ? `<p class="text-xs text-wiki-muted">${escapeHtml(durationText)}</p>` : ''}
      </div>
    </div>
  `
}

const createKeywordsMetaTag = (keywords?: string[]): string => {
  if (!keywords || keywords.length === 0) {
    return ''
  }
  return `<meta name="keywords" content="${escapeHtml(keywords.join(', '))}">`
}

const createArticleModifiedMeta = (updatedAt?: string): string => {
  if (!updatedAt) {
    return ''
  }
  return `<meta property="article:modified_time" content="${escapeHtml(updatedAt)}">`
}

function renderSampleJobDetailPage(
  c: Context<{ Bindings: Bindings; Variables: Variables }>,
  sample: NonNullable<ReturnType<typeof getSampleJobDetail>>
) {
  return renderSampleJobDetailPageWithRawData(c, sample, undefined)
}

function renderSampleJobDetailPageWithRawData(
  c: Context<{ Bindings: Bindings; Variables: Variables }>,
  sample: NonNullable<ReturnType<typeof getSampleJobDetail>>,
  rawApiData?: { careernet?: any; goyong24?: any }
) {
  const canonicalSlug = sample.meta?.canonicalSlug ?? composeDetailSlug('job', sample.profile.name, sample.profile.id)
  const canonicalPath = `/job/${encodeURIComponent(canonicalSlug)}`
  const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)
  const title = sample.meta?.title ?? `${sample.profile.name} 직업 정보 - Careerwiki`
  const description = createMetaDescription(
    sample.meta?.description,
    sample.profile.summary,
    sample.profile.prospect,
    sample.snippet
  )
  const extraHead = [
    '<meta property="og:type" content="article">',
    createJobJsonLd(sample.profile, canonicalUrl),
    createKeywordsMetaTag(sample.meta?.keywords),
    createArticleModifiedMeta(sample.meta?.updatedAt)
  ].filter(Boolean).join('\n')

  const content = renderUnifiedJobDetail({
    profile: sample.profile,
    partials: sample.partials ?? {},
    sources: sample.sources,
    rawApiData // Pass rawApiData even for sample pages
  })

  return c.html(
    renderLayoutWithContext(c,
      content,
      escapeHtml(title),
      escapeHtml(description),
      false,
      {
        canonical: canonicalUrl,
        ogUrl: canonicalUrl,
        extraHead
      }
    )
  )
}

function renderSampleMajorDetailPage(
  c: Context<{ Bindings: Bindings; Variables: Variables }>,
  sample: NonNullable<ReturnType<typeof getSampleMajorDetail>>
) {
  const canonicalSlug = sample.meta?.canonicalSlug ?? composeDetailSlug('major', sample.profile.name, sample.profile.id)
  const canonicalPath = `/major/${encodeURIComponent(canonicalSlug)}`
  const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)
  const title = sample.meta?.title ?? `${sample.profile.name} 전공 정보 - Careerwiki`
  const description = createMetaDescription(
    sample.meta?.description,
    sample.profile.summary,
    sample.profile.jobProspect,
    sample.snippet
  )
  const extraHead = [
    '<meta property="og:type" content="article">',
    createMajorJsonLd(sample.profile, canonicalUrl),
    createKeywordsMetaTag(sample.meta?.keywords),
    createArticleModifiedMeta(sample.meta?.updatedAt)
  ].filter(Boolean).join('\n')

  const content = renderUnifiedMajorDetail({
    profile: sample.profile,
    partials: sample.partials ?? {},
    sources: sample.sources
  })

  return c.html(
    renderLayoutWithContext(c,
      content,
      escapeHtml(title),
      escapeHtml(description),
      false,
      {
        canonical: canonicalUrl,
        ogUrl: canonicalUrl,
        extraHead
      }
    )
  )
}

function renderSampleHowtoDetailPage(
  c: Context<{ Bindings: Bindings; Variables: Variables }>,
  sample: NonNullable<ReturnType<typeof getSampleHowtoGuide>>
) {
  const authUser = c.get('user')  // User 타입 (id: number)
  const canonicalSlug = sample.meta?.canonicalSlug ?? sample.slug
  const canonicalPath = `/howto/${encodeURIComponent(canonicalSlug)}`
  const canonicalUrl = buildCanonicalUrl(c.req.url, canonicalPath)
  const title = sample.meta?.title ?? `${sample.guide.title} - Careerwiki HowTo`
  const description = createMetaDescription(
    sample.meta?.description,
    sample.guide.summary,
    sample.snippet
  )
  const extraHead = [
    '<meta property="og:type" content="article">',
    createKeywordsMetaTag(sample.meta?.keywords),
    createArticleModifiedMeta(sample.meta?.updatedAt),
    createHowtoJsonLd(sample.guide, canonicalUrl)
  ].filter(Boolean).join('\n')

  // 샘플 데이터는 DB 페이지가 없으므로 편집 불가, 신고만 가능
  const content = renderHowtoGuideDetail(sample.guide, {
    currentUserId: authUser?.id ?? null,
    currentUserRole: authUser?.role ?? null,
    authorId: null,  // 샘플 데이터는 작성자 없음
    pageId: null,    // 샘플 데이터는 DB ID 없음
    isBlinded: false,
    blindReason: null
  })

  return c.html(
    renderLayoutWithContext(c,
      content,
      escapeHtml(title),
      escapeHtml(description),
      false,
      {
        canonical: canonicalUrl,
        ogUrl: canonicalUrl,
        extraHead
      }
    )
  )
}

function createHowtoJsonLd(
  guide: NonNullable<ReturnType<typeof getSampleHowtoGuide>>['guide'],
  canonicalUrl: string
): string {
  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'HowTo',
    name: guide.title,
    description: guide.summary,
    url: canonicalUrl,
    totalTime: guide.estimatedDuration,
    difficulty: guide.difficulty,
    audience: guide.audience,
    supply: guide.prerequisites?.map((item) => ({
      '@type': 'HowToSupply',
      name: item
    })),
    tool: guide.resources?.map((resource) => ({
      '@type': 'HowToTool',
      name: resource.label,
      url: resource.url
    })),
    step: guide.steps?.map((step) => ({
      '@type': 'HowToStep',
      name: step.title,
      url: `${canonicalUrl}#${encodeURIComponent(step.id)}`,
      text: step.description,
      itemListElement: step.keyActions?.map((action) => ({
        '@type': 'HowToDirection',
        text: action
      }))
    }))
  }

  const script = JSON.stringify(jsonLd).replace(/</g, '\\u003C')
  return `<script type="application/ld+json">${script}</script>`
}

// Phase 3 Day 3: 기존 헤더 기반 인증을 JWT 기반으로 변경
// 기존 코드 호환을 위한 타입 유지
type RequestUser = {
  id: string
  role: UserRole
  name?: string | null
  username?: string | null
  picture_url?: string | null
  custom_picture_url?: string | null
}

/**
 * Phase 3 Day 3: 새로운 역할 시스템을 기존 댓글 시스템 역할로 매핑
 * 
 * 기존: 'super-admin' | 'operator' | 'user'
 * 신규: 'anonymous' | 'user' | 'expert' | 'admin'
 */
const mapRoleForComments = (newRole: string | null | undefined): UserRole => {
  if (!newRole || newRole === 'anonymous') {
    return 'user'  // 익명 유저도 댓글 작성 가능
  }
  
  switch (newRole) {
    case 'admin':
      return 'super-admin'
    case 'expert':
      return 'operator'
    case 'user':
    default:
      return 'user'
  }
}

/**
 * Phase 3 Day 3: authMiddleware에서 설정한 사용자 정보를 기존 형식으로 변환
 * 
 * Context에서 user를 가져와서 RequestUser 형식으로 반환
 * 로그인하지 않은 경우 null 반환 (익명 사용자)
 */
const getOptionalUser = (c: Context<{ Bindings: Bindings; Variables: Variables }>): RequestUser | null => {
  // authMiddleware에서 설정한 user 가져오기
  const user = c.get('user')
  
  if (!user) {
    return null  // 비로그인 사용자
  }
  
  return {
    id: user.id.toString(),
    role: mapRoleForComments(user.role),
    name: user.name,
    username: user.username,  // 편집 기록용 사용자 아이디
    picture_url: user.picture_url,
    custom_picture_url: user.custom_picture_url
  }
}

const maskIpForDisplay = (ip: string | null | undefined): string | null => {
  if (!ip) return null
  if (ip.includes(':')) {
    const segments = ip.split(':').filter(Boolean)
    const first = segments.slice(0, 2).join(':')
    return `${first}:`
  }
  const parts = ip.split('.')
  if (parts.length !== 4) {
    const a = parts[0] || '0'
    const b = parts[1] || '0'
    return `${a}.${b}.`
  }
  return `${parts[0]}.${parts[1]}.`
}

const toHex = (buffer: ArrayBuffer): string => {
  const bytes = new Uint8Array(buffer)
  return Array.from(bytes)
    .map((byte) => byte.toString(16).padStart(2, '0'))
    .join('')
}

const hashIpAddress = async (ip: string | null | undefined): Promise<string | null> => {
  if (!ip) return null
  const encoder = new TextEncoder()
  const digest = await crypto.subtle.digest('SHA-256', encoder.encode(ip))
  return toHex(digest)
}

const formatPerfAlertLine = (alert: PerfAlert): string => {
  const severityIcon = alert.severity === 'critical' ? '🚨' : '⚠️'
  const isScoreMetric = alert.metric.toLowerCase().includes('cls')
  const rounding = (value: number) => (isScoreMetric ? value.toFixed(2) : `${Math.round(value)}ms`)
  const contextParts: string[] = []
  if (alert.context?.page) {
    contextParts.push(`page=${alert.context.page}`)
  }
  if (alert.context?.action) {
    contextParts.push(`action=${alert.context.action}`)
  }
  if (alert.context?.category) {
    contextParts.push(`cat=${alert.context.category}`)
  }
  const contextSuffix = contextParts.length ? ` (${contextParts.join(' · ')})` : ''
  return `${severityIcon} ${alert.metric}: ${rounding(alert.value)} > ${rounding(alert.threshold)}${contextSuffix}`
}

const sendPerfAlertsToSlack = async (
  webhook: string,
  options: {
    alerts: PerfAlert[]
    url?: string
    reason?: string
    id: string
  }
): Promise<void> => {
  try {
    const header = options.reason ? `Perf alert (${options.reason})` : 'Perf alert detected'
    const urlLine = options.url ? `URL: ${options.url}` : null
    const lines = options.alerts.slice(0, 6).map((alert) => formatPerfAlertLine(alert))
    const bodyLines = [header, `Log ID: ${options.id}`, ...(urlLine ? [urlLine] : []), ...lines]
    const payload = { text: bodyLines.join('\n') }
    await fetch(webhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
  } catch (error) {
    console.error('[perf-alert] slack notification failed', error)
  }
}

// API 엔드포인트들

// 현재 로그인 사용자 정보 조회 (클라이언트에서 동적으로 확인용)
app.get('/api/me', async (c) => {
  const user = c.get('user')
  
  if (!user) {
    return c.json({ user: null })
  }
  
  return c.json({
    user: {
      id: user.id,
      name: user.name,
      username: user.username,
      role: user.role,
      pictureUrl: user.custom_picture_url || user.picture_url || null
    }
  })
})

app.post('/api/perf-metrics', async (c) => {
  let payload: PerfMetricsPayload
  try {
    payload = await c.req.json<PerfMetricsPayload>()
  } catch (error) {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  try {
    // 로컬 개발 환경에서는 KV가 없을 수 있음
    if (!c.env.KV) {
      console.warn('[perf-metrics] KV not available, skipping storage')
      return c.json({
        success: true,
        data: { id: 'local-dev-skip' },
        alerts: []
      })
    }

    const rawIp = c.req.header('cf-connecting-ip') ?? null
    const ipHash = await hashIpAddress(rawIp)
    const result = await storePerfMetrics(c.env.KV, payload, { ip: ipHash ?? undefined })

    if (result.alerts && result.alerts.length && c.env.PERF_ALERT_WEBHOOK) {
      c.executionCtx.waitUntil(
        sendPerfAlertsToSlack(c.env.PERF_ALERT_WEBHOOK, {
          alerts: result.alerts,
          url: payload.url,
          reason: payload.reason,
          id: result.id
        })
      )
    }

    return c.json({
      success: true,
      data: {
        id: result.id
      },
      alerts: result.alerts ?? []
    })
  } catch (error) {
    console.error('[perf-metrics] failed to store', error)
    return c.json({ success: false, error: 'failed to store metrics' }, 500)
  }
})

// Phase 3 Day 4: 클라이언트 IP 주소 반환 API
app.get('/api/client-ip', (c) => {
  const ipAddress = getClientIp(c)
  return c.json({ ip: ipAddress || '127.0.0.1' })
})

// Feedback APIs
app.post('/api/feedback', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    const body = await c.req.json()
    const validation = validateFeedbackInput(body)
    if (!validation.ok) {
      return c.json({ success: false, error: validation.errors.join(' ') }, 400)
    }

    const isPrivate = Boolean(body?.is_private)

    const post = await createFeedback(c.env.DB, {
      userId: user!.id,
      title: validation.title,
      body: validation.body,
      type: validation.type,
      status: validation.status,
      isPrivate,
      linkUrl: validation.linkUrl,
    })
    return c.json({ success: true, data: post })
  } catch (error) {
    console.error('[feedback] create error', error)
    return c.json({ success: false, error: 'failed_to_create' }, 500)
  }
})

app.get('/api/feedback', async (c) => {
  try {
    const user = c.get('user')
    const isAdmin = isAdminRole(user?.role)
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const pageSize = parseNumberParam(c.req.query('pageSize'), 20, { min: 1, max: 50 })
    const typeParam = c.req.query('type') || undefined
    const statusParam = c.req.query('status') || undefined

    const type =
      typeParam && ['bug', 'suggestion', 'question', 'other'].includes(typeParam)
        ? (typeParam as any)
        : undefined
    const status =
      statusParam && ['open', 'closed'].includes(statusParam)
        ? (statusParam as any)
        : undefined

    const result = await listFeedback(c.env.DB, {
      page,
      pageSize,
      type,
      status,
      includePrivate: isAdmin,
    })
    return c.json({ success: true, data: result.items, total: result.total, page, pageSize })
  } catch (error) {
    console.error('[feedback] list error', error)
    return c.json({ success: false, error: 'failed_to_list' }, 500)
  }
})

app.get('/api/feedback/:id', async (c) => {
  try {
    const user = c.get('user')
    const isAdmin = isAdminRole(user?.role)
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)

    const item = await getFeedbackById(c.env.DB, id, { includePrivate: isAdmin })
    if (!item) return c.json({ success: false, error: 'not_found' }, 404)

    if (item.is_private && !isAdmin) {
      return c.json({ success: false, error: 'not_found' }, 404)
    }

    return c.json({ success: true, data: item })
  } catch (error) {
    console.error('[feedback] detail error', error)
    return c.json({ success: false, error: 'failed_to_get' }, 500)
  }
})

app.post('/api/feedback/:id/reply', requireAdmin, async (c) => {
  try {
    const admin = c.get('user')!
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const body = await c.req.json()
    const replyBody = (body?.body || '').trim()
    if (replyBody.length < 3 || replyBody.length > 4000) {
      return c.json({ success: false, error: '답변은 3~4000자여야 합니다.' }, 400)
    }
    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)

    const updated = await upsertReply(c.env.DB, {
      postId: id,
      adminId: admin.id,
      body: replyBody,
    })
    return c.json({ success: true, data: updated })
  } catch (error) {
    console.error('[feedback] reply upsert error', error)
    return c.json({ success: false, error: 'failed_to_save_reply' }, 500)
  }
})

app.put('/api/feedback/:id/reply', requireAdmin, async (c) => {
  try {
    const admin = c.get('user')!
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const body = await c.req.json()
    const replyBody = (body?.body || '').trim()
    if (replyBody.length < 3 || replyBody.length > 4000) {
      return c.json({ success: false, error: '답변은 3~4000자여야 합니다.' }, 400)
    }
    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)

    const updated = await upsertReply(c.env.DB, {
      postId: id,
      adminId: admin.id,
      body: replyBody,
    })
    return c.json({ success: true, data: updated })
  } catch (error) {
    console.error('[feedback] reply update error', error)
    return c.json({ success: false, error: 'failed_to_save_reply' }, 500)
  }
})

app.delete('/api/feedback/:id/reply', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)
    await deleteReply(c.env.DB, id)
    return c.json({ success: true })
  } catch (error) {
    console.error('[feedback] reply delete error', error)
    return c.json({ success: false, error: 'failed_to_delete_reply' }, 500)
  }
})

// 관리자용 피드백 삭제
app.delete('/api/admin/feedback/:id', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)
    await deleteFeedback(c.env.DB, id)
    return c.json({ success: true })
  } catch (error) {
    console.error('[feedback] delete error', error)
    return c.json({ success: false, error: 'failed_to_delete' }, 500)
  }
})

// 피드백 댓글 추가 (스레드)
app.post('/api/feedback/:id/comments', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const postId = Number(c.req.param('id'))
    if (!Number.isFinite(postId)) return c.json({ success: false, error: 'invalid_id' }, 400)

    const feedback = await getFeedbackById(c.env.DB, postId, { includePrivate: true })
    if (!feedback) return c.json({ success: false, error: 'not_found' }, 404)

    // 종료된 피드백에는 댓글 불가
    if (feedback.status === 'closed') {
      return c.json({ success: false, error: 'feedback_closed' }, 400)
    }

    // 비공개 피드백은 작성자 또는 관리자만 댓글 가능
    const isAdmin = isAdminRole(user.role)
    if (feedback.is_private && !isAdmin && user.id !== feedback.user_id) {
      return c.json({ success: false, error: 'not_authorized' }, 403)
    }

    const { body } = await c.req.json()
    if (!body || typeof body !== 'string' || body.trim().length < 3 || body.trim().length > 2000) {
      return c.json({ success: false, error: 'invalid_body' }, 400)
    }

    const comment = await addComment(c.env.DB, {
      postId,
      userId: user.id,
      isAdmin: Boolean(isAdmin),
      body: body.trim(),
    })

    return c.json({ success: true, data: comment })
  } catch (error) {
    console.error('[feedback] add comment error', error)
    return c.json({ success: false, error: 'failed_to_add_comment' }, 500)
  }
})

// 피드백 댓글 삭제
app.delete('/api/feedback/comments/:id', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const commentId = Number(c.req.param('id'))
    if (!Number.isFinite(commentId)) return c.json({ success: false, error: 'invalid_id' }, 400)

    const comment = await getCommentById(c.env.DB, commentId)
    if (!comment) return c.json({ success: false, error: 'not_found' }, 404)

    // 본인 댓글 또는 관리자만 삭제 가능
    const isAdmin = isAdminRole(user.role)
    if (!isAdmin && comment.user_id !== user.id) {
      return c.json({ success: false, error: 'not_authorized' }, 403)
    }

    await deleteFeedbackComment(c.env.DB, commentId)
    return c.json({ success: true })
  } catch (error) {
    console.error('[feedback] delete comment error', error)
    return c.json({ success: false, error: 'failed_to_delete_comment' }, 500)
  }
})

app.patch('/api/feedback/:id/visibility', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const body = await c.req.json()
    const isPrivate = Boolean(body?.is_private)
    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)
    const updated = await setVisibility(c.env.DB, id, isPrivate)
    return c.json({ success: true, data: updated })
  } catch (error) {
    console.error('[feedback] visibility error', error)
    return c.json({ success: false, error: 'failed_to_update_visibility' }, 500)
  }
})

app.get('/api/comments', async (c) => {
  const entityTypeRaw = c.req.query('entityType')
  const slugRaw = c.req.query('slug')

  if (!isPageType(entityTypeRaw)) {
    return c.json({ success: false, error: 'entityType must be job, major, or guide' }, 400)
  }

  if (!slugRaw || !slugRaw.trim()) {
    return c.json({ success: false, error: 'slug is required' }, 400)
  }

  const slug = slugRaw.trim()
  const limit = parseNumberParam(c.req.query('limit'), 50, { min: 1, max: 50 })
  const titleParam = c.req.query('title')
  const summaryParam = c.req.query('summary')
  const title = typeof titleParam === 'string' && titleParam.trim().length ? titleParam.trim() : slug
  const summary = typeof summaryParam === 'string' && summaryParam.trim().length ? summaryParam.trim().slice(0, 400) : null
  const viewer = getOptionalUser(c)
  const rawIp = getClientIp(c)
  const ipHash = await hashIpAddress(rawIp)

  try {
    const result = await getCommentsBySlug(c.env.DB, {
      slug: buildCommentPageSlug(entityTypeRaw, slug),
      pageType: entityTypeRaw,
      title,
      summary,
      limit,
      viewerId: viewer?.id ?? null,
      viewerRole: viewer?.role ?? 'user',
      includeModerated: viewer ? viewer.role !== 'user' : false,
      ipHash
    })

    return c.json({
      success: true,
      data: result.comments,
      meta: {
        total: result.totalCount,
        page: {
          id: result.page.id,
          slug: result.page.slug,
          title: result.page.title,
          pageType: result.page.page_type,
          summary: result.page.summary
        },
        viewer: viewer ? { id: viewer.id, name: viewer.name, username: viewer.username, role: viewer.role, pictureUrl: viewer.custom_picture_url || viewer.picture_url || null } : null,
        viewerIp: maskIpForDisplay(rawIp),
        policy: result.policy,
        bestThreshold: result.policy.bestLikeThreshold,
        bestLimit: result.policy.bestLimit,
        reportBlindThreshold: result.policy.reportBlindThreshold,
        nextAnonymousNumber: result.nextAnonymousNumber ?? null
      }
    })
  } catch (error) {
    console.error('[comments:list] failed', error)
    return c.json({ success: false, error: 'failed to load comments' }, 500)
  }
})

app.post('/api/comments', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  const entityType = body?.entityType
  const slugRaw = typeof body?.slug === 'string' ? body.slug : ''
  const contentRaw = typeof body?.content === 'string' ? body.content : ''
  const title = typeof body?.title === 'string' && body.title.trim().length ? body.title.trim() : slugRaw.trim()
  const summary = typeof body?.summary === 'string' && body.summary.trim().length ? body.summary.trim().slice(0, 400) : null
  const parentId = toParentId(body?.parentId)

  if (!isPageType(entityType)) {
    return c.json({ success: false, error: 'entityType must be job, major, or guide' }, 400)
  }

  if (!slugRaw || !slugRaw.trim()) {
    return c.json({ success: false, error: 'slug is required' }, 400)
  }

  if (!contentRaw || !contentRaw.trim()) {
    return c.json({ success: false, error: 'content is required' }, 400)
  }

  // Phase 3 Day 3: 익명 사용자도 댓글 작성 가능
  const user = getOptionalUser(c)
  
  const slug = slugRaw.trim()
  const ipAddress = getClientIp(c)
  const ipHash = await hashIpAddress(ipAddress)

  if (await isIpBlocked(c.env.DB, ipHash)) {
    return c.json({ success: false, error: 'commenting temporarily restricted' }, 403)
  }

  const anonymousRequested = Boolean(body?.anonymous)
  const nicknameRaw = typeof body?.nickname === 'string' ? body.nickname : null
  
  // 익명 사용자는 닉네임 입력하지 않음 (익명 번호는 서버에서 자동 배정)
  // 로그인 사용자가 익명으로 작성하는 경우에만 nicknameRaw 사용
  const nickname = anonymousRequested && user
    ? nicknameRaw  // 로그인 사용자가 익명으로 작성하는 경우
    : (user
        ? (nicknameRaw
            ?? user?.username
            ?? (user?.id ? String(user.id) : null))
        : null)  // 로그인 사용자는 닉네임 입력값 → username → id 순서 사용, 익명 사용자는 null
  const displayIp = (anonymousRequested || !user) ? maskIpForDisplay(ipAddress) : null

  try {
    const comment = await createComment(c.env.DB, {
      slug: buildCommentPageSlug(entityType, slug),
      pageType: entityType,
      title: title || slug,
      summary,
      content: contentRaw,
      nickname: nickname,  // 익명 사용자는 null (익명 번호는 서버에서 자동 배정)
      parentId,
      authorId: user?.id ?? null,  // 익명 사용자는 null
      isAnonymous: anonymousRequested || !user,  // 로그인 안 했으면 익명으로 처리
      ipHash,
      displayIp,
      password: body?.password || null  // 익명 사용자는 비밀번호 필요
    })

    return c.json({ success: true, data: { ...comment, authorRole: user?.role ?? null } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'COMMENT_ERROR'
    if (message === 'EMPTY_CONTENT') {
      return c.json({ success: false, error: 'content is required' }, 400)
    }
    if (message === 'INVALID_PARENT') {
      return c.json({ success: false, error: 'invalid parentId' }, 400)
    }
    if (message === 'COMMENT_NOT_FOUND') {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    if (message === 'AUTHOR_REQUIRED') {
      return c.json({ success: false, error: 'authentication required' }, 401)
    }
    console.error('[comments:create] failed', error)
    return c.json({ success: false, error: 'failed to create comment' }, 500)
  }
})

app.post('/api/comments/:id/like', async (c) => {
  const commentId = Number(c.req.param('id'))
  if (!Number.isFinite(commentId) || commentId <= 0) {
    return c.json({ success: false, error: 'invalid comment id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const user = getOptionalUser(c)
  const rawIp = getClientIp(c)
  const ipHash = await hashIpAddress(rawIp)
  const voterId = user?.id ?? (ipHash ? `ip:${ipHash}` : null)
  if (!voterId) {
    return c.json({ success: false, error: 'authentication required' }, 401)
  }

  const directionRaw = typeof body?.direction === 'string' ? body.direction.toLowerCase() : 'up'
  const direction = directionRaw === 'down' || directionRaw === 'dislike'
    ? 'down'
    : directionRaw === 'clear' || directionRaw === 'remove'
      ? 'clear'
      : 'up'

  try {
    const comment = await setCommentVote(c.env.DB, {
      commentId,
      userId: voterId,
      direction
    })
    if (!comment) {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    return c.json({ success: true, data: { ...comment, authorRole: user?.role ?? null } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to update like state'
    if (message === 'USER_REQUIRED') {
      return c.json({ success: false, error: 'authentication required' }, 401)
    }
    if (message === 'COMMENT_NOT_FOUND') {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    if (message === 'SELF_VOTE_NOT_ALLOWED') {
      return c.json({ success: false, error: 'authors cannot vote on their own comments' }, 403)
    }
    if (message === 'VOTE_LIMIT_REACHED') {
      return c.json({ success: false, error: 'vote limit reached' }, 429)
    }
    console.error('[comments:like] failed', error)
    return c.json({ success: false, error: 'failed to update like state' }, 500)
  }
})

app.patch('/api/comments/:id', async (c) => {
  const commentId = Number(c.req.param('id'))
  if (!Number.isFinite(commentId) || commentId <= 0) {
    return c.json({ success: false, error: 'invalid comment id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  const contentRaw = typeof body?.content === 'string' ? body.content : ''
  if (!contentRaw || !contentRaw.trim()) {
    return c.json({ success: false, error: 'content is required' }, 400)
  }

  const user = getOptionalUser(c)
  const passwordRaw = typeof body?.password === 'string' ? body.password : null

  try {
    const comment = await updateComment(c.env.DB, {
      commentId,
      content: contentRaw,
      userId: user?.id ?? null,
      password: passwordRaw ?? null,
      userRole: user?.role as 'user' | 'expert' | 'admin' | null ?? null
    })
    return c.json({ success: true, data: comment })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'COMMENT_ERROR'
    if (message === 'COMMENT_NOT_FOUND') {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    if (message === 'UNAUTHORIZED') {
      return c.json({ success: false, error: 'unauthorized' }, 403)
    }
    if (message === 'PASSWORD_REQUIRED') {
      return c.json({ success: false, error: 'password is required for anonymous comments' }, 400)
    }
    if (message === 'INVALID_PASSWORD') {
      return c.json({ success: false, error: 'invalid password' }, 403)
    }
    if (message === 'EMPTY_CONTENT') {
      return c.json({ success: false, error: 'content is required' }, 400)
    }
    console.error('[comments:update] failed', error)
    return c.json({ success: false, error: 'failed to update comment' }, 500)
  }
})

app.delete('/api/comments/:id', async (c) => {
  const commentId = Number(c.req.param('id'))
  if (!Number.isFinite(commentId) || commentId <= 0) {
    return c.json({ success: false, error: 'invalid comment id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json().catch(() => ({}))
  } catch {
    body = {}
  }

  const user = getOptionalUser(c)
  const passwordRaw = typeof body?.password === 'string' ? body.password : null

  try {
    const success = await deleteComment(c.env.DB, {
      commentId,
      userId: user?.id ?? null,
      password: passwordRaw ?? null,
      userRole: user?.role as 'user' | 'expert' | 'admin' | 'super-admin' | 'operator' | null ?? null
    })
    if (!success) {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    return c.json({ success: true })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'COMMENT_ERROR'
    if (message === 'COMMENT_NOT_FOUND') {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    if (message === 'UNAUTHORIZED') {
      return c.json({ success: false, error: 'unauthorized' }, 403)
    }
    if (message === 'PASSWORD_REQUIRED') {
      return c.json({ success: false, error: 'password is required for anonymous comments' }, 400)
    }
    if (message === 'INVALID_PASSWORD') {
      return c.json({ success: false, error: 'invalid password' }, 403)
    }
    console.error('[comments:delete] failed', error)
    return c.json({ success: false, error: 'failed to delete comment' }, 500)
  }
})

app.post('/api/comments/:id/flag', async (c) => {
  const commentId = Number(c.req.param('id'))
  if (!Number.isFinite(commentId) || commentId <= 0) {
    return c.json({ success: false, error: 'invalid comment id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const user = getOptionalUser(c)
  if (!user) {
    return c.json({ success: false, error: 'authentication required' }, 401)
  }

  const ipAddress = c.req.header('cf-connecting-ip') ?? null
  const ipHash = await hashIpAddress(ipAddress)

  try {
    const comment = await reportComment(c.env.DB, {
      commentId,
      reporterId: user.id,
      reporterIpHash: ipHash,
      reason: typeof body?.reason === 'string' ? body.reason.slice(0, 200) : null
    })
    if (!comment) {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    return c.json({
      success: true,
      data: {
        ...comment,
        blinded: comment.status !== 'visible'
      }
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to flag comment'
    if (message === 'REPORTER_REQUIRED') {
      return c.json({ success: false, error: 'authentication required' }, 401)
    }
    if (message === 'COMMENT_NOT_FOUND') {
      return c.json({ success: false, error: 'comment not found' }, 404)
    }
    if (message === 'REPORT_ALREADY_FILED') {
      return c.json({ success: false, error: 'duplicate report not allowed' }, 409)
    }
    console.error('[comments:flag] failed', error)
    return c.json({ success: false, error: 'failed to flag comment' }, 500)
  }
})

app.get('/api/comments/ip-blocks', async (c) => {
  const user = getOptionalUser(c)
  if (!user || user.role === 'user') {
    return c.json({ success: false, error: 'moderator access required' }, 403)
  }

  const includeReleased = c.req.query('includeReleased') === '1'

  try {
    const records = await listIpBlocks(c.env.DB, { includeReleased })
    return c.json({ success: true, data: records })
  } catch (error) {
    console.error('[comments:ip-blocks:list] failed', error)
    return c.json({ success: false, error: 'failed to list ip blocks' }, 500)
  }
})

app.post('/api/comments/ip-blocks', async (c) => {
  const user = getOptionalUser(c)
  if (!user || user.role === 'user') {
    return c.json({ success: false, error: 'moderator access required' }, 403)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const ipHashRaw = typeof body?.ipHash === 'string' ? body.ipHash.trim() : ''
  const ipRaw = typeof body?.ip === 'string' ? body.ip.trim() : ''
  const ipHash = ipHashRaw || (await hashIpAddress(ipRaw))

  if (!ipHash) {
    return c.json({ success: false, error: 'ip or ipHash is required' }, 400)
  }

  try {
    const record = await blockIpAddress(c.env.DB, {
      ipHash,
      reason: typeof body?.reason === 'string' ? body.reason : null,
      blockedBy: user.id
    })
    return c.json({ success: true, data: record })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to block ip'
    if (message === 'IP_ALREADY_BLOCKED') {
      return c.json({ success: false, error: 'ip already blocked' }, 409)
    }
    if (message === 'IP_HASH_REQUIRED') {
      return c.json({ success: false, error: 'ipHash required' }, 400)
    }
    if (message === 'BLOCK_ACTOR_REQUIRED') {
      return c.json({ success: false, error: 'moderator identifier required' }, 400)
    }
    console.error('[comments:ip-blocks:block] failed', error)
    return c.json({ success: false, error: 'failed to block ip' }, 500)
  }
})

app.post('/api/comments/ip-blocks/:hash/release', async (c) => {
  const user = getOptionalUser(c)
  if (!user || user.role === 'user') {
    return c.json({ success: false, error: 'moderator access required' }, 403)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const hashParam = c.req.param('hash')
  const ipHash = typeof hashParam === 'string' ? hashParam.trim() : ''

  if (!ipHash) {
    return c.json({ success: false, error: 'ip hash required' }, 400)
  }

  try {
    const record = await releaseIpAddress(c.env.DB, {
      ipHash,
      releasedBy: user.id,
      reason: typeof body?.reason === 'string' ? body.reason : null
    })

    if (!record) {
      return c.json({ success: false, error: 'ip block not found' }, 404)
    }

    return c.json({ success: true, data: record })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to release ip block'
    if (message === 'IP_HASH_REQUIRED') {
      return c.json({ success: false, error: 'ip hash required' }, 400)
    }
    if (message === 'RELEASE_ACTOR_REQUIRED') {
      return c.json({ success: false, error: 'moderator identifier required' }, 400)
    }
    console.error('[comments:ip-blocks:release] failed', error)
    return c.json({ success: false, error: 'failed to release ip block' }, 500)
  }
})

app.post('/api/perf-metrics', async (c) => {
  let body: PerfMetricsPayload
  try {
    body = await c.req.json<PerfMetricsPayload>()
  } catch (error) {
    return c.json({ success: false, error: 'invalid json body' }, 400)
  }

  try {
    // 로컬 개발 환경에서는 KV가 없을 수 있음
    if (!c.env.KV) {
      console.warn('[perf-metrics] KV not available, skipping storage')
      return c.json({ success: true, id: 'local-dev-skip' })
    }

    const ip = c.req.header('cf-connecting-ip') ?? undefined
    const { id } = await storePerfMetrics(c.env.KV, body, { ip })
    return c.json({ success: true, id })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'perf metrics store failed'
    const status = message === 'Invalid payload' || message === 'No metrics provided' ? 400 : 500
    return c.json({ success: false, error: message }, status)
  }
})

app.post('/api/analyzer/sessions', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!body || typeof body !== 'object') {
    return c.json({ success: false, error: 'invalid body' }, 400)
  }

  try {
    const session = await createOrUpdateSession(c.env.DB, {
      sessionId: typeof body.sessionId === 'string' ? body.sessionId : undefined,
      userIdentifier: typeof body.userIdentifier === 'string' ? body.userIdentifier : undefined,
      traitsSnapshot: body.traits ?? body.traitsSnapshot
    })

    const includeRequests = Boolean(body.includeRequests)
    const response: Record<string, unknown> = { session }

    if (includeRequests) {
      const limitInput = typeof body.requestLimit === 'number' ? Math.floor(body.requestLimit) : 10
      const limit = Number.isFinite(limitInput) ? Math.min(Math.max(limitInput, 1), 100) : 10
      const requests = await listRequestsBySession(c.env.DB, session.id, limit)
      response.requests = requests
    }

    return c.json({ success: true, data: response })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'session upsert failed'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/sessions/:id', async (c) => {
  const sessionId = c.req.param('id')
  const includeRequests = c.req.query('includeRequests') === '1'
  const limit = parseNumberParam(c.req.query('limit'), 20, { min: 1, max: 50 })

  const session = await getAiSession(c.env.DB, sessionId)
  if (!session) {
    return c.json({ success: false, error: 'session not found' }, 404)
  }

  const result: Record<string, unknown> = { session }
  if (includeRequests) {
    const requests = await listRequestsBySession(c.env.DB, sessionId, limit)
    result.requests = requests
  }

  return c.json({ success: true, data: result })
})

app.post('/api/analyzer/requests', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  const sessionId = typeof body.sessionId === 'string' ? body.sessionId : ''
  const analysisType = body.analysisType
  const promptPayload = body.promptPayload

  if (!sessionId) {
    return c.json({ success: false, error: 'sessionId is required' }, 400)
  }

  if (!isAnalysisType(analysisType)) {
    return c.json({ success: false, error: 'analysisType must be "job" or "major"' }, 400)
  }

  if (promptPayload === undefined) {
    return c.json({ success: false, error: 'promptPayload is required' }, 400)
  }

  const session = await getAiSession(c.env.DB, sessionId)
  if (!session) {
    return c.json({ success: false, error: 'session not found' }, 404)
  }

  const pricingTier = isPricingTier(body.pricingTier) ? body.pricingTier : 'free'
  const initialStatus = isRequestStatus(body.status) ? body.status : 'pending'

  try {
    const request = await createAnalysisRequest(c.env.DB, {
      sessionId,
      analysisType,
      pricingTier,
      promptPayload,
      status: initialStatus
    })

    return c.json({ success: true, data: { request } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to create analysis request'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/requests/:id', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  const record = await getAnalysisRequestWithResult(c.env.DB, requestId)
  if (!record) {
    return c.json({ success: false, error: 'request not found' }, 404)
  }

  return c.json({ success: true, data: record })
})

app.post('/api/analyzer/requests/:id/result', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (typeof body.provider !== 'string' || !body.provider) {
    return c.json({ success: false, error: 'provider is required' }, 400)
  }

  if (body.responsePayload === undefined) {
    return c.json({ success: false, error: 'responsePayload is required' }, 400)
  }

  const requestStatus = body.requestStatus
  if (requestStatus !== undefined && !isRequestStatus(requestStatus)) {
    return c.json({ success: false, error: 'invalid requestStatus' }, 400)
  }

  try {
    const { request, result } = await createAnalysisResult(c.env.DB, {
      requestId,
      provider: body.provider,
      model: typeof body.model === 'string' ? body.model : null,
      completionTokens: typeof body.completionTokens === 'number' ? body.completionTokens : null,
      promptTokens: typeof body.promptTokens === 'number' ? body.promptTokens : null,
      totalTokens: typeof body.totalTokens === 'number' ? body.totalTokens : null,
      latencyMs: typeof body.latencyMs === 'number' ? body.latencyMs : null,
      responseSummary: typeof body.responseSummary === 'string' ? body.responseSummary : null,
      responsePayload: body.responsePayload,
      requestStatus
    })

    return c.json({ success: true, data: { request, result } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to store analysis result'
    return c.json({ success: false, error: message }, 500)
  }
})

app.post('/api/analyzer/requests/:id/status', async (c) => {
  const requestId = Number(c.req.param('id'))
  if (Number.isNaN(requestId)) {
    return c.json({ success: false, error: 'invalid request id' }, 400)
  }

  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!isRequestStatus(body.status)) {
    return c.json({ success: false, error: 'invalid status' }, 400)
  }

  const processedAt = typeof body.processedAt === 'string'
    ? body.processedAt
    : (body.status === 'completed' || body.status === 'failed' ? new Date().toISOString() : null)

  try {
    const request = await updateRequestStatus(c.env.DB, requestId, body.status, processedAt)
    return c.json({ success: true, data: { request } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to update status'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/analyzer/sessions/:id/requests', async (c) => {
  const sessionId = c.req.param('id')
  const limit = parseNumberParam(c.req.query('limit'), 20, { min: 1, max: 50 })
  const requests = await listRequestsBySession(c.env.DB, sessionId, limit)
  return c.json({ success: true, data: { requests } })
})

app.post('/api/serp-interactions', async (c) => {
  let body: any
  try {
    body = await c.req.json()
  } catch {
    body = {}
  }

  if (!isAnalysisType(body.pageType)) {
    return c.json({ success: false, error: 'pageType must be "job" or "major"' }, 400)
  }

  if (typeof body.action !== 'string' || !body.action.trim()) {
    return c.json({ success: false, error: 'action is required' }, 400)
  }

  try {
    const record = await recordSerpInteraction(c.env.DB, {
      pageType: body.pageType,
      action: body.action,
      keywordLength: toIntegerOrNull(body.keywordLength, { min: 0 }),
      category: typeof body.category === 'string' ? body.category : null,
      perPage: toIntegerOrNull(body.perPage, { min: 1, max: 50 }),
      results: toIntegerOrNull(body.results, { min: 0, max: 500 }),
      cacheStatus: typeof body.cacheStatus === 'string' ? body.cacheStatus : null,
      durationMs: toIntegerOrNull(body.durationMs, { min: 0 }),
      sampled: typeof body.sampled === 'boolean' ? body.sampled : null,
      source: typeof body.source === 'string' ? body.source : null
    })

    return c.json({ success: true, data: { record } })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to record interaction'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/serp-interactions/recent', async (c) => {
  const limit = parseNumberParam(c.req.query('limit'), 50, { min: 1, max: 200 })
  const records = await listRecentSerpInteractions(c.env.DB, limit)
  return c.json({ success: true, data: { records } })
})

app.get('/api/serp-interactions/summary', async (c) => {
  const startDate = c.req.query('startDate') || undefined
  const endDate = c.req.query('endDate') || undefined
  const pageType = c.req.query('pageType') as ('job' | 'major') | undefined
  const action = c.req.query('action') || undefined
  const limit = parseNumberParam(c.req.query('limit'), 50, { min: 1, max: 200 })

  const summaries = await getDailySerpSummary(c.env.DB, {
    startDate,
    endDate,
    pageType,
    action,
    limit
  })

  return c.json({ success: true, data: { summaries } })
})

app.get('/api/freshness/status', async (c) => {
  try {
    const status = await getFreshnessStatus(c.env.KV)
    return c.json({
      success: true,
      data: status
    })
  } catch (error) {
    return c.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'freshness status fetch failed'
      },
      500
    )
  }
})

app.post('/api/freshness/run', async (c) => {
  try {
    let body: { targetId?: string; force?: boolean; reason?: string } = {}
    try {
      body = await c.req.json<{ targetId?: string; force?: boolean; reason?: string }>()
    } catch {
      body = {}
    }

    const targetId = body.targetId || c.req.query('targetId')
    if (!targetId) {
      return c.json({ success: false, error: 'targetId required' }, 400)
    }

    const target = resolveFreshnessTargetById(targetId)
    if (!target) {
      return c.json({ success: false, error: 'unknown targetId' }, 404)
    }

    const result = await attemptScheduledRefresh(c.env.KV, c.env, target, {
      force: body.force ?? c.req.query('force') === '1',
      reason: body.reason || 'manual-trigger'
    })

    return c.json({
      success: result.outcome === 'success',
      result
    })
  } catch (error) {
    return c.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'freshness run failed'
      },
      500
    )
  }
})

// 학과정보 검색 API
app.get('/api/majors', async (c) => {
  try {
    const mark = c.get('mark') as ((k: string) => void) | undefined
    mark?.('parse-query')
    const keyword = c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 8, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const dataVersion = 'v1'
    const seed = `${TEMPLATE_VERSIONS.MAJOR}:${dataVersion}:${toNFC(keyword)}:${page}:${perPage}`
    const etag = weakETag(seed)
    const inm = c.req.header('If-None-Match')
    const hasMatch = matchETag(inm, etag)
    if (hasMatch) {
      c.header('ETag', etag)
      c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
      c.header('X-Cache-Status', 'HIT')
      return c.body(null, 304)
    }

    mark?.('build-sql')
    const result = await searchUnifiedMajors({
      keyword,
      page,
      perPage,
      includeSources
    }, c.env)
    mark?.('db-read')

    mark?.('post-filter')
    mark?.('serialize')
    // logging removed per request
    c.header('ETag', etag)
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '학과 정보 검색 실패'
    }, 500)
  }
})

// 학과 검색 API (별도 엔드포인트) - :id 라우트보다 먼저 정의해야 함
app.get('/api/majors/search', async (c) => {
  try {
    const q = c.req.query('q') || c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const sort = c.req.query('sort') || 'relevance'
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await searchUnifiedMajors({
      keyword: q,
      page,
      perPage,
      sort,
      includeSources
    }, c.env)

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword: q,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '학과 정보 검색 실패'
    }, 500)
  }
})

// 학과 상세 정보 API
app.get('/api/majors/:id', async (c) => {
  try {
    const id = c.req.param('id')
    let userContributedJson: any = {}
    const careernetId = c.req.query('careernetId') || undefined
    const goyongMajorGb = c.req.query('goyongMajorGb') as ('1' | '2') | undefined
    const goyongDepartmentId = c.req.query('goyongDepartmentId') || undefined
    const goyongMajorId = c.req.query('goyongMajorId') || undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const goyongParams = goyongMajorGb && goyongDepartmentId && goyongMajorId
      ? {
          majorGb: goyongMajorGb as '1' | '2',
          departmentId: goyongDepartmentId,
          majorId: goyongMajorId
        }
      : undefined

    const result = await getUnifiedMajorDetail(
      {
        id,
        careernetId,
        goyong24Params: goyongParams,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: '학과 정보를 찾을 수 없습니다.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '학과 정보 조회 실패'
    }, 500)
  }
})

// 직업정보 검색 API
app.get('/api/jobs', async (c) => {
  try {
    const mark = c.get('mark') as ((k: string) => void) | undefined
    mark?.('parse-query')
    const keyword = c.req.query('keyword') || ''
    const category = c.req.query('category') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 8, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const dataVersion = 'v1'
    const seed = `${TEMPLATE_VERSIONS.JOB}:${dataVersion}:${toNFC(keyword)}:${page}:${perPage}:${category}`
    const etag = weakETag(seed)
    const inm = c.req.header('If-None-Match')
    const hasMatch = matchETag(inm, etag)
    if (hasMatch) {
      c.header('ETag', etag)
      c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
      c.header('X-Cache-Status', 'HIT')
      return c.body(null, 304)
    }

    mark?.('build-sql')
    const result = await searchUnifiedJobs({
      keyword,
      category,
      page,
      perPage,
      includeSources
    }, c.env)
    mark?.('db-read')

    mark?.('post-filter')
    mark?.('serialize')
    // logging removed per request
    c.header('ETag', etag)
    c.header('Cache-Control', 'public, max-age=60, stale-while-revalidate=30')
    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        category,
        page,
        perPage
      },
      categories: JOB_CATEGORIES
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '직업 정보 검색 실패'
    }, 500)
  }
})

// 직업 검색 API (별도 엔드포인트) - :id 라우트보다 먼저 정의해야 함
app.get('/api/jobs/search', async (c) => {
  try {
    const q = c.req.query('q') || c.req.query('keyword') || ''
    const category = c.req.query('category') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const sort = c.req.query('sort') || 'relevance'
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await searchUnifiedJobs({
      keyword: q,
      category,
      page,
      perPage,
      sort,
      includeSources
    }, c.env)

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword: q,
        category,
        page,
        perPage
      },
      categories: JOB_CATEGORIES
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '직업 정보 검색 실패'
    }, 500)
  }
})

// 직업 상세 정보 API
app.get('/api/jobs/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const careernetId = c.req.query('careernetId') || undefined
    const goyongJobId = c.req.query('goyongJobId') || undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await getUnifiedJobDetail(
      {
        id,
        careernetId,
        goyong24JobId: goyongJobId || undefined,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: '직업 정보를 찾을 수 없습니다.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '직업 정보 조회 실패'
    }, 500)
  }
})

// 편집 모드용 데이터 조회 API (실제 렌더링에 사용되는 데이터 반환)
app.get('/api/job/:id/edit-data', async (c) => {
  try {
    // 캐시 방지 (편집 직후 최신 데이터 보장)
    c.header('Cache-Control', 'no-store')
    c.header('Pragma', 'no-cache')
    c.header('Expires', '0')

    const id = c.req.param('id')
    let userContributedJson: any = {}
    
    const result = await getUnifiedJobDetailWithRawData(
      {
        id,
        careernetId: undefined,
        goyong24JobId: undefined,
        includeSources: ['CAREERNET', 'GOYONG24']
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: '직업 정보를 찾을 수 없습니다.'
      }, 404)
    }

    const profile = result.profile
    const careernetSummary = result.partials?.CAREERNET?.summary
    const goyong24Summary = result.partials?.GOYONG24?.summary
    const heroDescription =
      (profile as any).heroSummary ||
      (profile.summary || careernetSummary || goyong24Summary)?.split('\n')[0]?.trim() ||
      ''
    let rawApiData = result.rawApiData || { careernet: null, goyong24: null }
    
    // 헬퍼 함수: 배열에서 이름/텍스트 추출 (핵심 역량, 적성, 흥미, 관련학과, 교육과정, 진로탐색 등)
    const extractListItems = (list: any[] | null | undefined): string[] => {
      if (!list || !Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          // ETL에서 사용하는 모든 필드명 지원
          return (
            item?.name || 
            item?.majorNm ||           // 고용24 관련학과
            item?.depart_name ||       // 커리어넷 관련학과
            item?.curriculum ||        // 정규교육과정
            item?.research ||          // 진로탐색활동
            item?.recruit ||           // 채용정보
            item?.training ||          // 필요 교육/훈련
            item?.certificate ||       // 자격증
            item?.ability_name ||      // 커리어넷 핵심역량
            item?.aptitude || 
            item?.interest || 
            item?.ability || 
            item?.text || 
            item?.value || 
            ''
          ).trim()
        })
        .filter(Boolean)
    }
    
    // 헬퍼 함수: detailReady 배열에서 텍스트 추출 (채용정보, 교육훈련 등)
    // 템플릿의 extractReadyItem과 동일한 로직
    const extractReadyListItems = (list: any[] | null | undefined, key: string): string[] => {
      if (!list || !Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          if (item && typeof item === 'object') {
            return (item[key] || item.name || item.value || item.title || '').trim()
          }
          return ''
        })
        .filter(Boolean)
    }
    
    // 🆕 api_data_json을 직접 읽어서 rawApiData 보완
    // getUnifiedJobDetailWithRawData가 careernet이 null이면 rawCareernetData를 설정하지 않을 수 있음
    // 하지만 실제 api_data_json에는 { careernet: null, goyong24: {...} } 형식으로 저장되어 있을 수 있음
    if (c.env.DB) {
      try {
        // 실제 DB ID로 조회
        let dbResult = await c.env.DB.prepare(
          'SELECT id, api_data_json FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
        ).bind(id).first<{ id: string; api_data_json: string | null }>()
        
        if (!dbResult && id.includes(':')) {
          const parts = id.split(':')
          if (parts.length > 1) {
            const extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
            dbResult = await c.env.DB.prepare(
              'SELECT id, api_data_json FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
            ).bind(extractedId).first<{ id: string; api_data_json: string | null }>()
          }
        }
        
        if (!dbResult) {
          const normalizedSlug = id.toLowerCase()
          dbResult = await c.env.DB.prepare(
            'SELECT id, api_data_json FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first<{ id: string; api_data_json: string | null }>()
        }
        
        if (dbResult?.api_data_json) {
          try {
            const apiDataFromDb = JSON.parse(dbResult.api_data_json)
            // api_data_json의 구조를 그대로 사용 (careernet이 null이어도 포함)
            rawApiData = {
              careernet: apiDataFromDb.careernet ?? null,
              goyong24: apiDataFromDb.goyong24 ?? null
            }
            console.log('[edit-data] Loaded rawApiData from api_data_json:', {
              careernet: rawApiData.careernet ? 'exists' : 'null',
              goyong24: rawApiData.goyong24 ? 'exists' : 'null'
            })
          } catch (parseError) {
            console.error('[edit-data] Failed to parse api_data_json:', parseError)
          }
        }
      } catch (dbError) {
        console.error('[edit-data] Failed to read api_data_json from DB:', dbError)
      }
    }

    // 실제 렌더링에 사용되는 병합 데이터 생성
    const { mergeJobData } = await import('./services/jobDataMerger')
    const mergedData = mergeJobData(rawApiData)

    // 🆕 템플릿과 정확히 동일한 로직으로 필드 추출 (renderUnifiedJobDetail과 일치)
    // 템플릿에서는 profile이 이미 user_contributed_json과 admin_data_json이 병합된 결과를 사용
    
    // 히어로 설명: 템플릿과 동일한 우선순위 (heroIntro > summary > goyong24)
    // 템플릿: const heroDescription = profile.heroIntro?.split('\n')[0]?.trim() || profile.summary || ...
    // 편집 모드에서도 실제 표시되는 데이터와 동일하게 표시
    const summaryForEdit = 
      profile.heroIntro ||  // heroIntro가 있으면 이것을 우선 사용
      profile.summary || 
      rawApiData?.goyong24?.duty?.jobSum || ''

    // "하는 일" 섹션: 템플릿과 동일한 로직
    // 템플릿: const workSummary = mergedData.work.summary || profile.summary
    const workSummary = mergedData.work.summary || profile.summary || ''
    
    // 주요 업무: 템플릿과 동일한 로직
    // 템플릿: workSimple이 있으면 그것을 사용, 없으면 profile.duties
    const workSimple = mergedData.work.simple
    let duties = ''
    if (workSimple && Array.isArray(workSimple) && workSimple.length > 0) {
      // workSimple이 있으면 템플릿과 동일하게 처리
      duties = workSimple
        .map((item: any) => {
          const text = typeof item === 'string' ? item : item.work || item.list_content || ''
          return text?.trim() || ''
        })
        .filter(Boolean)
        .join('\n')
    } else if (profile.duties?.trim()) {
      // workSimple이 없으면 profile.duties 사용 (템플릿과 동일)
      duties = profile.duties
    }

    // 태그: 템플릿과 동일한 로직 (rawApiData.careernet.encyclopedia.tagList)
    // 템플릿에서는 tagList를 rawApiData.careernet.encyclopedia.tagList에서 가져옴
    const tagList = rawApiData?.careernet?.encyclopedia?.tagList || []
    const tagText = Array.isArray(tagList) 
      ? tagList.map((tag: any) => {
          // 템플릿과 동일한 로직: string이면 그대로, object면 tag 또는 list_content 추출
          const tagText = typeof tag === 'string' ? tag : (tag?.tag || tag?.list_content || '')
          return tagText?.trim() || ''
        }).filter(Boolean).join('\n')
      : ''

    // 실제 데이터베이스 ID 조회 (profile.id는 API ID일 수 있음)
    let actualDbId = id
    if (c.env.DB) {
      try {
        // slug로 조회 시도
        const normalizedSlug = id.toLowerCase()
        const dbResult = await c.env.DB.prepare(
          'SELECT id FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first<{ id: string }>()
        
        if (dbResult?.id) {
          actualDbId = dbResult.id
        } else {
          // ID로 직접 조회 시도
          const directResult = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE id = ? AND is_active = 1 LIMIT 1'
          ).bind(id).first<{ id: string }>()
          
          if (directResult?.id) {
            actualDbId = directResult.id
          }
        }
      } catch (dbError) {
        console.error('[edit-data] Failed to resolve DB ID:', dbError)
        // DB 조회 실패 시 원본 id 사용
      }
    }

    // heroTags 처리: profile.heroTags 또는 tagList 사용
    let heroTags: string[] = []
    if (Array.isArray(profile.heroTags)) {
      heroTags = profile.heroTags
    } else if (Array.isArray(tagList) && tagList.length > 0) {
      heroTags = tagList.map((tag: any) => {
        const t = typeof tag === 'string' ? tag : (tag?.tag || tag?.list_content || '')
        return t?.trim() || ''
      }).filter(Boolean)
    }
    
    // heroCategory 처리: breadcrumb 형식인지 확인
    let heroCategory = ''
    let isCategoryBreadcrumb = false
    
    if (typeof profile.heroCategory === 'string') {
      heroCategory = profile.heroCategory
    } else if (profile.heroCategory && typeof profile.heroCategory === 'object') {
      const cat = profile.heroCategory as any
      // breadcrumb 형식: large, medium, small 등 계층 구조가 있는 경우
      if (cat.large || cat.medium || cat.small) {
        isCategoryBreadcrumb = true
        // breadcrumb 전체를 표시 (편집 불가)
        const parts = [cat.large, cat.medium, cat.small].filter(Boolean)
        heroCategory = parts.join(' › ')
      } else if (cat.value) {
        heroCategory = cat.value
      }
    }
    
    // 편집 가능한 필드만 추출 (편집 모드 UI 필드 구조에 맞춤)
    const editData: Record<string, any> = {
      name: profile.name || '',
      summary: summaryForEdit, // 전체 summary (heroIntro > summary > goyong24)
      heroTags: heroTags, // 태그 배열
      heroCategory: heroCategory, // 직업 분류
      isCategoryBreadcrumb: isCategoryBreadcrumb, // breadcrumb 형식 여부 (true면 편집 불가)
      
      // 개요 - 주요 업무
      // main은 문자열 → 배열로 변환 (리스트 편집용)
      // 템플릿의 renderDutyBulletList와 동일한 로직 적용
      overviewWork: {
        main: (() => {
          const raw = profile.overviewWork?.main || duties || ''
          console.log('[Edit Data API] overviewWork.main raw type:', typeof raw, 'isArray:', Array.isArray(raw))
          if (Array.isArray(raw)) {
            console.log('[Edit Data API] overviewWork.main array:', JSON.stringify(raw))
            return raw
          }
          if (typeof raw === 'string' && raw.trim()) {
            const normalized = raw.replace(/\r/g, '\n')
            // 1차: 줄바꿈, 불릿 포인트로 분리
            let sentences = normalized
              .split(/\n+|•|▶|►|■|●|◆/)
              .map((s: string) => s.trim().replace(/^[\d\-\.\)\(]+\s*/, ''))
              .filter(Boolean)
            // 2차: 1줄이면 마침표/느낌표/물음표로 분리
            if (sentences.length <= 1) {
              const sentenceSplit = normalized
                .replace(/([.!?])\s+(?=[^\s])/g, '$1|')
                .split('|')
                .map((s: string) => s.trim().replace(/^[\d\-\.\)\(]+\s*/, ''))
                .filter(Boolean)
              if (sentenceSplit.length > sentences.length) {
                sentences = sentenceSplit
              }
            }
            console.log('[Edit Data API] overviewWork.main split result:', JSON.stringify(sentences))
            return sentences
          }
          return []
        })(),
        workStrong: profile.overviewWork?.workStrong || profile.workStrong || '',
        workPlace: profile.overviewWork?.workPlace || profile.workPlace || '',
        physicalAct: profile.overviewWork?.physicalAct || profile.physicalAct || ''
      },
      
      // 개요 - 커리어 전망
      overviewProspect: {
        main: profile.overviewProspect?.main || mergedData.prospect.primary || profile.prospect || ''
      },
      
      // 개요 - 핵심 능력·자격
      overviewAbilities: {
        abilityList: extractListItems(profile.overviewAbilities?.abilityList) 
          || extractListItems(profile.abilityList),
        technKnow: profile.overviewAbilities?.technKnow || profile.technKnow || '',
        eduLevel: profile.overviewAbilities?.eduLevel || profile.eduLevel || '',
        skillYear: profile.overviewAbilities?.skillYear || profile.skillYear || ''
      },
      
      // 개요 - 적성 및 흥미
      overviewAptitude: {
        aptitudeList: extractListItems(profile.overviewAptitude?.aptitudeList)
          || extractListItems(profile.aptitudeList),
        interestList: extractListItems(profile.overviewAptitude?.interestList)
          || extractListItems(profile.interestList)
      },
      
      // 개요 - 여담 (리스트 형식)
      trivia: typeof profile.trivia === 'string' 
        ? profile.trivia.split(/\n|•/).map((s: string) => s.trim()).filter(Boolean)
        : (Array.isArray(profile.trivia) ? profile.trivia : []),
      
      // 상세정보 - 직업 준비하기
      detailReady: {
        curriculum: extractListItems(profile.detailReady?.curriculum),
        recruit: extractListItems(profile.detailReady?.recruit),
        training: extractListItems(profile.detailReady?.training),
        researchList: extractListItems(profile.detailReady?.researchList)
      },
      
      // 사이드바 - 연관 정보
      sidebarJobs: extractListItems(profile.sidebarJobs),
      sidebarMajors: extractListItems(profile.sidebarMajors),
      sidebarCerts: extractListItems(profile.sidebarCerts),
      
      // 사용자가 추가한 출처 (수정/삭제 가능)
      _sources: (profile as any)._sources || {}
    }

    // 디버깅: 데이터가 비어있는지 확인
    const dataKeys = Object.keys(editData)
    const nonEmptyKeys = dataKeys.filter(key => {
      const value = editData[key as keyof typeof editData]
      return value !== null && value !== undefined && value !== ''
    })
    
    
    return c.json({
      success: true,
      data: editData,
      entityId: actualDbId, // 실제 데이터베이스 ID 사용
      entityType: 'job'
    })
  } catch (error) {
    console.error('[edit-data] Error:', error)
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '편집 데이터 조회 실패'
    }, 500)
  }
})

// 전공 편집 모드용 데이터 조회 API
app.get('/api/major/:id/edit-data', async (c) => {
  try {
    // 캐시 방지 (편집 직후 최신 데이터 보장)
    c.header('Cache-Control', 'no-store')
    c.header('Pragma', 'no-cache')
    c.header('Expires', '0')

    const id = c.req.param('id')
    let userContributedJson: any = {} // 전체 스코프에서 사용할 변수 선언
    
    
    // 사용자 생성 전공 (U_ prefix)은 그대로 사용
    let resolvedId = id
    if (!id.startsWith('U_')) {
      // 전공 상세페이지와 동일한 ID 해결 로직 사용
      resolvedId = resolveDetailIdFromSlug('major', id)
    }
    
    
    // 실제 DB ID 찾기 (전공 상세페이지와 동일한 로직)
    let actualDbId = resolvedId
    if (c.env.DB) {
      try {
        // composite ID인 경우 (major:C_xxx 또는 major:G_xxx)
        if (resolvedId.includes(':')) {
          const parts = resolvedId.split(':')
          if (parts.length > 1) {
            const sourceId = parts[parts.length - 1].replace(/^C_/, '').replace(/^G_/, '')
            // careernet_id나 goyong24_id로 실제 DB ID 찾기
            const dbResult = await c.env.DB.prepare(
              'SELECT id FROM majors WHERE careernet_id = ? OR goyong24_id = ? LIMIT 1'
            ).bind(sourceId, sourceId).first() as { id: string } | null
            if (dbResult?.id) {
              actualDbId = dbResult.id
            } else {
            }
          }
        } else {
          // resolvedId가 composite ID가 아닌 경우 DB에서 찾기
          // ID로 직접 조회 시도
          let dbResult = await c.env.DB.prepare(
            'SELECT id FROM majors WHERE id = ? AND is_active = 1 LIMIT 1'
          ).bind(resolvedId).first() as { id: string } | null
          
          
          if (!dbResult) {
            // slug로 조회 시도 (정규화된 이름으로)
            const decodedSlug = decodeURIComponent(id)
            const normalizedSlug = decodedSlug.toLowerCase()
            
            // 방법 1: 정규화된 이름으로 조회
            dbResult = await c.env.DB.prepare(
              'SELECT id FROM majors WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
            ).bind(normalizedSlug).first() as { id: string } | null
            
            
            if (!dbResult) {
              // 방법 2: 이름으로 직접 조회 (대소문자 무시)
              dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
              ).bind(normalizedSlug).first() as { id: string } | null
              
            }
            
            if (!dbResult) {
              // 방법 3: 원본 slug로 조회
              dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
              ).bind(decodedSlug).first() as { id: string } | null
              
            }
          }
          
          if (dbResult?.id) {
            actualDbId = dbResult.id
          } else {
            actualDbId = resolvedId
          }
        }
      } catch (dbError) {
        console.error('[major edit-data] Failed to resolve DB ID:', dbError)
        // DB 조회 실패 시 resolvedId 사용
        actualDbId = resolvedId
      }
    }
    
    // 사용자 기여 데이터 우선 로드 (역사/편집 데이터 일치 보장)
    if (c.env.DB) {
      try {
        const ucRow = await c.env.DB.prepare(
          'SELECT user_contributed_json FROM majors WHERE id = ? LIMIT 1'
        ).bind(actualDbId).first<{ user_contributed_json: string | null }>()
        if (ucRow?.user_contributed_json) {
          userContributedJson = JSON.parse(ucRow.user_contributed_json)
        }
      } catch (ucError) {
        console.error('[major edit-data] Failed to load user_contributed_json:', ucError)
      }
    }
    
    // 전공 상세페이지와 동일한 방식으로 데이터 조회
    // actualDbId가 실제 DB ID인 경우 그대로 사용, 아니면 resolvedId 사용
    const searchId = actualDbId !== resolvedId ? actualDbId : resolvedId
    const result = await getUnifiedMajorDetail(
      {
        id: searchId, // 실제 DB ID 또는 resolvedId
        careernetId: undefined,
        goyong24Params: undefined
      },
      c.env
    )

    if (!result.profile) {
      console.error(`[major edit-data] Profile not found for searchId: ${searchId}`)
      // 원본 slug로도 시도 (composite ID가 아닌 경우에만)
      if (searchId !== id && !id.includes(':')) {
        const retryResult = await getUnifiedMajorDetail(
          {
            id: id,
            careernetId: undefined,
            goyong24Params: undefined
          },
          c.env
        )
        if (retryResult.profile) {
          // retryResult 사용
          const profile = retryResult.profile
          
          // 헬퍼 함수: 배열에서 이름/텍스트 추출
          const extractListItems = (list: any[] | undefined): string[] => {
            if (!Array.isArray(list)) return []
            return list
              .map((item: any) => {
                if (typeof item === 'string') return item.trim()
                return (item?.name || item?.value || '').trim()
              })
              .filter(Boolean)
          }
          
          const heroTags = Array.isArray((profile as any).heroTags) ? (profile as any).heroTags : []
          const categoryName = typeof (profile as any).categoryName === 'string' ? (profile as any).categoryName : ((profile as any).categoryName?.value || '')
          
          const editData = {
            name: profile.name || '',
            summary: profile.summary || '',
            heroTags: heroTags,
            categoryName: categoryName,
            property: profile.property || '',
            aptitude: profile.aptitude || '',
            relatedMajors: extractListItems(profile.relatedMajors),
            mainSubjects: extractListItems(profile.mainSubjects),
            relatedJobs: extractListItems(profile.relatedJobs),
            whatStudy: profile.whatStudy || '',
            mainSubject: profile.mainSubject || '',
            relateSubject: profile.relateSubject || '',
            enterField: typeof profile.enterField === 'string' ? profile.enterField : (profile.enterField ? JSON.stringify(profile.enterField, null, 2) : ''),
            jobProspect: profile.jobProspect || '',
            careerAct: profile.careerAct || ''
          }
          
          // 프로필 이름으로 실제 DB ID 찾기
          if (c.env.DB && profile.name) {
            try {
              const dbResult = await c.env.DB.prepare(
                'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
              ).bind(profile.name).first() as { id: string } | null
              if (dbResult?.id) {
                actualDbId = dbResult.id
              }
            } catch (e) {
              console.error('[major edit-data] Failed to resolve DB ID from retry:', e)
            }
          }
          
          return c.json({
            success: true,
            data: editData,
            entityId: actualDbId || id,
            entityType: 'major'
          })
        }
      }
      return c.json({
        success: false,
        error: '전공 정보를 찾을 수 없습니다.'
      }, 404)
    }
    
    // 프로필을 찾은 경우, 실제 DB ID를 다시 확인
    if (actualDbId === resolvedId && !actualDbId.includes(':') && c.env.DB) {
      try {
        // 프로필 이름으로 실제 DB ID 찾기
        const profileName = result.profile.name
        if (profileName) {
          const dbResult = await c.env.DB.prepare(
            'SELECT id FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(profileName).first() as { id: string } | null
          if (dbResult?.id) {
            actualDbId = dbResult.id
          }
        }
      } catch (e) {
        console.error('[major edit-data] Failed to resolve DB ID from profile name:', e)
      }
    }

    const profile = result.profile
    
    // 헬퍼 함수: 배열에서 이름/텍스트 추출
    const extractListItems = (list: any[] | undefined): string[] => {
      if (!Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          return (item?.name || item?.value || '').trim()
        })
        .filter(Boolean)
    }
    
    // heroTags 처리: profile.heroTags 또는 tagList
    let heroTags: string[] = []
    if (Array.isArray((profile as any).heroTags)) {
      heroTags = (profile as any).heroTags
    }
    
    // categoryName 처리
    let categoryName = ''
    if (typeof (profile as any).categoryName === 'string') {
      categoryName = (profile as any).categoryName
    } else if ((profile as any).categoryName?.value) {
      categoryName = (profile as any).categoryName.value
    }
    
    // 편집 가능한 필드만 추출 (편집 모드 UI 필드 구조에 맞춤)
    const extractListItemsWithSubjects = (list: any[] | undefined): string[] => {
      if (!Array.isArray(list)) return []
      return list
        .map((item: any) => {
          if (typeof item === 'string') return item.trim()
          return (
            item?.name ||
            item?.value ||
            item?.subject_name ||
            item?.SUBJECT_NM ||
            ''
          ).trim()
        })
        .filter(Boolean)
    }
    const toStringList = (val: any): string[] => {
      if (Array.isArray(val)) {
        return val.map(v => (typeof v === 'string' ? v : (v?.text || v?.value || v?.name || ''))).filter(Boolean)
      }
      if (typeof val === 'string') {
        return val.split(/\n+/).map(s => s.trim()).filter(Boolean)
      }
      return []
    }
    
    const toPairList = (list: any): Array<{ title: string; description: string }> => {
      if (!list) return []
      if (typeof list === 'string') {
        return list.split(/\n+/).map(line => line.trim()).filter(Boolean).map(line => ({ title: line, description: '' }))
      }
      if (Array.isArray(list)) {
        return list.map(item => {
          const anyItem = item as any
          const title =
            anyItem.title ||
            anyItem.name ||
            anyItem.gradeuate ||
            anyItem.field_name ||
            anyItem.act_name ||
            anyItem.ACT_NM ||
            anyItem.SBJECT_NM ||    // 커리어넷 실제 키 (U 없음)
            anyItem.SUBJECT_NM ||
            anyItem.subject_name ||
            ''
          const description =
            anyItem.description ||
            anyItem.desc ||
            anyItem.text ||
            anyItem.field_description ||
            anyItem.field_desc ||
            anyItem.act_description ||
            anyItem.ACT_SUMRY ||
            anyItem.SBJECT_SUMRY || // 커리어넷 실제 키 (U 없음)
            anyItem.subject_description ||
            anyItem.SUBJECT_SUMRY ||
            ''
          if (!title && !description) return null
          return { title, description }
        }).filter(Boolean) as Array<{ title: string; description: string }>
      }
      return []
    }
    
    // hero description: 템플릿과 동일 (heroSummary 우선, 없으면 summary/CAREERNET/GOYONG24 첫 문장)
    const heroDescription =
      (profile as any).heroSummary ||
      (profile.summary || result.partials?.CAREERNET?.summary || result.partials?.GOYONG24?.summary)
        ?.split('\n')[0]
        ?.trim() ||
      ''
    
    // overview summary: DB user_contributed_json 우선, 그 다음 merged → summary까지 폴백 (템플릿과 동일)
    const isUserCreatedMajor = (profile.id || '').startsWith('U_')
    const overviewSummary = (userContributedJson?.overview?.summary)
      || (profile as any).overview?.summary
      || profile.summary
      || (isUserCreatedMajor ? profile.summary : '')
      || ''
    // 사이드바 데이터
    const mapAutocompleteItems = (arr: any[] | undefined, type: 'job' | 'major' | 'howto') => {
      if (!Array.isArray(arr)) return []
      return arr.map(item => {
        if (typeof item === 'string') return { name: item, slug: item }
        return { name: item?.name || item?.title || '', slug: item?.slug || item?.id || item?.name || item?.title || '' }
      }).filter(i => i.name)
    }
    
    // 교육과정: 기초/심화 기본값 + mainSubjects 파싱 (템플릿과 동일한 순서)
    let basicSubjectsParsed = extractListItemsWithSubjects((profile as any).basicSubjects)
    let advancedSubjectsParsed = extractListItemsWithSubjects((profile as any).advancedSubjects)
    let relateSubjectParsed = extractListItemsWithSubjects(profile.relateSubject)
    // mainSubjects가 pairList 형태면 제목만 태그로 노출 (상세는 mainSubject pairList로 별도 저장)
    const mainSubjectsRaw = profile.mainSubjects
    if (Array.isArray(mainSubjectsRaw) && mainSubjectsRaw.length > 0) {
      const hasPairListShape = mainSubjectsRaw.some((i: any) => typeof i === 'object' && (i.title || i.subject_name || i.SUBJECT_NM))
      if (hasPairListShape) {
        const titles = mainSubjectsRaw
          .map((i: any) => i.title || i.subject_name || i.SUBJECT_NM || '')
          .filter(Boolean)
          .map((t: string) => t.trim())
          .filter(Boolean)
        if (basicSubjectsParsed.length === 0 && titles.length > 0) {
          basicSubjectsParsed = [...titles]
        }
      } else if (basicSubjectsParsed.length === 0 && advancedSubjectsParsed.length === 0) {
        // 문자열/배열 기반 파싱 (‡ 구분자)
        const firstSubject = mainSubjectsRaw[0]
        if (typeof firstSubject === 'string' && firstSubject.includes('‡')) {
          const sections = firstSubject.split('‡').filter((s: string) => s.trim())
          sections.forEach(section => {
            if (section.includes('기초과목')) {
              const subjects = section.replace(/^.*?기초과목\s*[:：]\s*/i, '')
                .split(/[,、]\s*/)
                .map((s: string) => s.trim())
                .filter((s: string) => s && s !== '등')
              basicSubjectsParsed.push(...subjects)
            } else if (section.includes('심화과목')) {
              const subjects = section.replace(/^.*?심화과목\s*[:：]\s*/i, '')
                .split(/[,、]\s*/)
                .map((s: string) => s.trim())
                .filter((s: string) => s && s !== '등')
              advancedSubjectsParsed.push(...subjects)
            }
          })
        }
      }
    }

    const editData = {
      name: profile.name || '',
      heroSummary: heroDescription || profile.summary || '',  // 히어로 섹션 전용 (개요와 분리)
      heroTags: heroTags,
      categoryName: categoryName,
      
      // 개요
      'overview.summary': overviewSummary,
      property: profile.property || '',
      aptitude: profile.aptitude || '',
      enterField: toPairList(profile.enterField),
      // 여담은 trivia 필드만 사용 (진로전망 jobProspect와 분리)
      trivia: toStringList((profile as any).trivia),
      
      // 상세정보 - 교육과정
      whatStudy: profile.whatStudy || '',
      basicSubjects: basicSubjectsParsed,
      advancedSubjects: advancedSubjectsParsed,
      // 대학 주요 교과목 상세: mainSubject 우선, 없으면 main_subject, 없으면 mainSubjects
      mainSubject: toPairList(
        (profile as any).mainSubject ||
        (profile as any).main_subject ||
        (profile as any).mainSubjects
      ),
      // 고교 추천 교과목: pairList로 제공 (제목/설명), [출처]로 시작하는 항목은 제외
      relateSubject: toPairList(profile.relateSubject || (profile as any).relate_subject).filter(
        (item) => item.title && !item.title.trim().startsWith('[출처')
      ),
      
      // 상세정보 - 진로 탐색 활동
      careerAct: toPairList(profile.careerAct),
      
      // 사이드바
      sidebarJobs: mapAutocompleteItems((profile as any).sidebarJobs || profile.relatedJobs, 'job'),
      sidebarMajors: mapAutocompleteItems((profile as any).sidebarMajors || profile.relatedMajors, 'major'),
      sidebarHowtos: mapAutocompleteItems((profile as any).sidebarHowtos, 'howto'),
      
      // 사용자 출처 (편집창에서 다중 입력 지원)
      _sources: (profile as any)._sources || {}
    }

    return c.json({
      success: true,
      data: editData,
      entityId: actualDbId, // 실제 데이터베이스 ID 사용
      entityType: 'major'
    })
  } catch (error) {
    console.error('[major edit-data] Error:', error)
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '편집 데이터 조회 실패'
    }, 500)
  }
})

// 미리보기 API 제거됨 (편집 모드에서 미리보기 기능 없음)

// 직업 카테고리 목록 API
app.get('/api/categories', async (c) => {
  return c.json({
    success: true,
    jobCategories: JOB_CATEGORIES,
    aptitudeTypes: APTITUDE_TYPES
  })
})

// ============================================================================
// 카드 HTML 렌더링 API (클라이언트 정렬 시 사용)
// ============================================================================

// 직업 카드 HTML 반환 API
app.post('/api/job/cards', async (c) => {
  try {
    const body = await c.req.json<{ items: Array<{ profile: any; display?: any }> }>()
    const items = body.items || []
    
    if (!Array.isArray(items) || items.length === 0) {
      return c.json({ html: '', count: 0 })
    }
    
    const html = items.map((item) => renderJobCard(item)).join('')
    
    return c.json({
      html,
      count: items.length
    })
  } catch (error) {
    console.error('Job cards API error:', error)
    return c.json({
      error: error instanceof Error ? error.message : '카드 렌더링 실패',
      html: '',
      count: 0
    }, 500)
  }
})

// 전공 카드 HTML 반환 API
app.post('/api/major/cards', async (c) => {
  try {
    const body = await c.req.json<{ items: Array<{ profile: any; display?: any }> }>()
    const items = body.items || []
    
    if (!Array.isArray(items) || items.length === 0) {
      return c.json({ html: '', count: 0 })
    }
    
    const html = items.map((item) => renderMajorCard(item)).join('')
    
    return c.json({
      html,
      count: items.length
    })
  } catch (error) {
    console.error('Major cards API error:', error)
    return c.json({
      error: error instanceof Error ? error.message : '카드 렌더링 실패',
      html: '',
      count: 0
    }, 500)
  }
})

// ============================================================================
// 전공(학과) 관련 API
// ============================================================================

// 전공 검색 API
app.get('/api/majors', async (c) => {
  try {
    const keyword = c.req.query('keyword') || ''
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const perPage = parseNumberParam(c.req.query('perPage'), 20, { min: 1, max: 50 })
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await searchUnifiedMajors({
      keyword,
      page,
      perPage,
      includeSources
    }, c.env)

    return c.json({
      success: true,
      data: result.items,
      meta: {
        ...result.meta,
        keyword,
        page,
        perPage
      }
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '전공 정보 검색 실패'
    }, 500)
  }
})

// 전공 상세 정보 API
app.get('/api/majors/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const careernetId = c.req.query('careernetId') || undefined
    const goyong24Params = c.req.query('goyong24Params') 
      ? JSON.parse(c.req.query('goyong24Params') || '{}')
      : undefined
    const includeSources = parseSourcesQuery(c.req.query('sources'))

    const result = await getUnifiedMajorDetail(
      {
        id,
        careernetId,
        goyong24Params,
        includeSources
      },
      c.env
    )

    if (!result.profile) {
      return c.json({
        success: false,
        error: '전공 정보를 찾을 수 없습니다.',
        sources: result.sources
      }, 404)
    }

    return c.json({
      success: true,
      data: result.profile,
      partials: result.partials,
      sources: result.sources
    })
  } catch (error) {
    return c.json({
      success: false,
      error: error instanceof Error ? error.message : '전공 정보 조회 실패'
    }, 500)
  }
})

// ============================================================================
// 전공 상세 페이지
// ============================================================================

// Simple Major Detail Page (D1-based, SEO optimized)
app.get('/majors/:id', async (c) => {
  const id = c.req.param('id')
  const { DB } = c.env
  const debugMode = c.req.query('debug') === 'true'
  
  try {
    // D1에서 직접 전공 상세 데이터 조회
    const row = await DB.prepare('SELECT id, name, api_data_json FROM majors WHERE id = ?')
      .bind(id).first<{ id: string; name: string; api_data_json: string }>()
    
    if (!row || !row.api_data_json) {
      const fallbackHtml = renderDetailFallback({
        icon: 'fa-magnifying-glass',
        title: '전공 정보를 찾을 수 없습니다',
        description: '요청하신 전공 데이터가 존재하지 않거나 삭제되었습니다.',
        ctaHref: '/major',
        ctaLabel: '전공위키로 돌아가기'
      })
      return c.html(renderLayoutWithContext(c,
        fallbackHtml,
        '전공 정보 없음 - Careerwiki',
        '요청하신 전공 정보를 찾을 수 없습니다.'
      ), 404)
    }
    
    // Parse API data from D1
    const apiData = JSON.parse(row.api_data_json)
    
    // UnifiedMajorDetail 형식으로 변환
    const profile: UnifiedMajorDetail = {
      id: row.id,
      sourceIds: apiData.merged?.sourceIds || {},
      name: apiData.merged?.name || row.name,
      categoryId: apiData.merged?.categoryId,
      categoryName: apiData.merged?.categoryName,
      summary: apiData.merged?.summary,
      aptitude: apiData.merged?.aptitude,
      relatedMajors: apiData.merged?.relatedMajors,
      mainSubjects: apiData.merged?.mainSubjects,
      licenses: apiData.merged?.licenses,
      universities: apiData.merged?.universities,
      recruitmentStatus: apiData.merged?.recruitmentStatus,
      relatedJobs: apiData.merged?.relatedJobs,
      whatStudy: apiData.merged?.whatStudy,
      howPrepare: apiData.merged?.howPrepare,
      jobProspect: apiData.merged?.jobProspect,
      salaryAfterGraduation: apiData.merged?.salaryAfterGraduation,
      employmentRate: apiData.merged?.employmentRate,
      sources: apiData.merged?.sources || []
    }
    
    const majorName = profile.name || '전공 정보'
    const summary = profile.summary?.substring(0, 120) || '전공 정보를 제공합니다.'
    
    // Note: 디버그 모드는 ISR 캐시를 우회하는 별도 라우트에서 처리됩니다.
    // 이 함수는 ISR 캐시 생성용이므로 디버그 모드를 지원하지 않습니다.
    
    // SEO 최적화된 메타 정보
    const pageTitle = `${majorName} 전공 정보 - 대학 학과, 진로, 취업 | CareerWiki`
    const metaDescription = `${summary}. ${profile.mainSubjects?.length || 0}개 주요 과목, ${profile.relatedJobs?.length || 0}개 관련 직업, ${profile.universities?.length || 0}개 대학 정보 제공.`
    const canonicalUrl = `https://careerwiki.org/majors/${id}`
    
    // renderUnifiedMajorDetail 템플릿 사용
    const content = renderUnifiedMajorDetail({
      profile,
      partials: apiData.partials || {},
      sources: apiData.sources || {}
    })
    
    // Schema.org JSON-LD 생성
    const extraHead = [
      '<meta property="og:type" content="article">',
      createMajorJsonLd(profile, canonicalUrl)
    ].filter(Boolean).join('\n')
    
    return c.html(renderLayoutWithContext(c,
      content,
      escapeHtml(pageTitle),
      escapeHtml(metaDescription),
      false,
      {
        canonical: canonicalUrl,
        ogUrl: canonicalUrl,
        extraHead
      }
    ))
    
  } catch (error) {
    console.error('Major detail route error:', error)
    const fallbackHtml = renderDetailFallback({
      icon: 'fa-exclamation-circle',
      iconColor: 'text-red-500',
      title: '전공 정보를 불러오지 못했습니다',
      description: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',
      ctaHref: '/major',
      ctaLabel: '전공위키로 돌아가기'
    })
    c.status(500)
    return c.html(renderLayoutWithContext(c,
      fallbackHtml,
      '전공 정보 로드 오류 - Careerwiki',
      '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
    ))
  }
})

// ============================================================================
// 사용자 설정 페이지 (마이페이지)
// ============================================================================

// 마이페이지 메인 - AI 추천 페이지로 리다이렉트
app.get('/user', requireAuth, async (c) => {
  return c.redirect('/user/ai-results')
})

// ============================================================================
// 사용자 프로필 - AI 추천 페이지로 리다이렉트
// ============================================================================
app.get('/user/profile', requireAuth, (c) => {
  return c.redirect('/user/ai-results?tab=profile')
})

// ============================================================================
// 프로필 컨텐츠 HTML 생성 함수
// ============================================================================
function generateProfileContentHtml(): string {
  return `
    <!-- 프로필 요약 헤더 -->
    <div id="profile-summary" class="mb-6">
      <div class="animate-pulse">
        <div class="h-4 bg-wiki-border/30 rounded w-1/3 mb-2"></div>
        <div class="h-3 bg-wiki-border/20 rounded w-1/2"></div>
      </div>
    </div>
    
    <!-- 변경사항 알림 배너 -->
    <div id="changes-banner" class="hidden mb-6 p-4 rounded-xl border border-amber-500/30 bg-amber-500/10">
      <div class="flex items-start gap-3">
        <i class="fas fa-exclamation-circle text-amber-400 mt-0.5"></i>
        <div class="flex-1">
          <h4 class="font-medium text-amber-300 mb-1">프로필 변경 감지</h4>
          <p id="changes-message" class="text-sm text-wiki-muted mb-3"></p>
          <button onclick="quickReanalyze()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-black font-medium rounded-lg transition text-sm">
            <i class="fas fa-redo mr-2"></i>변경사항 적용하여 재분석
          </button>
        </div>
      </div>
    </div>
    
    <!-- 탭 네비게이션 -->
    <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto" style="scrollbar-width: none;">
      <button onclick="switchTab('career')" data-tab="career" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap bg-wiki-primary text-white">
        <i class="fas fa-briefcase mr-2"></i>기본 정보
      </button>
      <button onclick="switchTab('universal')" data-tab="universal" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-heart mr-2"></i>관심사/성향
      </button>
      <button onclick="switchTab('transition')" data-tab="transition" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-exchange-alt mr-2"></i>전환 의향
      </button>
      <button onclick="switchTab('narrative')" data-tab="narrative" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-pen-fancy mr-2"></i>심층 답변
      </button>
      <button onclick="switchTab('resume')" data-tab="resume" class="profile-tab px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-wiki-muted hover:bg-wiki-card/50">
        <i class="fas fa-file-alt mr-2"></i>이력서 정보
      </button>
    </div>
    
    <!-- 탭 컨텐츠 영역 -->
    <div id="tab-content">
      <!-- 로딩 상태 -->
      <div id="loading-state" class="py-8 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-wiki-primary"></div>
        <p class="mt-4 text-wiki-muted">프로필 데이터를 불러오는 중...</p>
      </div>
      
      <!-- 빈 상태 -->
      <div id="empty-state" class="hidden py-12 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: rgba(67, 97, 238, 0.1);">
          <i class="fas fa-user-plus text-2xl text-wiki-primary"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-3">프로필 데이터가 없습니다</h3>
        <p class="mb-6 text-wiki-muted">AI 분석을 통해 프로필을 생성해주세요.</p>
        <a href="/analyzer/job" class="inline-flex items-center gap-2 px-5 py-2.5 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition">
          <i class="fas fa-magic"></i> AI 분석 시작하기
        </a>
      </div>
      
      <!-- Career State 탭 -->
      <div id="tab-career" class="tab-panel hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">역할 정체성</h4>
              <button onclick="editField('career_state', 'role_identity')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-role_identity" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">경력 단계</h4>
              <button onclick="editField('career_state', 'career_stage_years')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-career_stage_years" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">전환 상태</h4>
              <button onclick="editField('career_state', 'transition_status')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-transition_status" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">스킬 레벨</h4>
              <button onclick="editField('career_state', 'skill_level')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-skill_level" class="flex items-center gap-2">
              <div class="flex gap-1">
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
                <span class="skill-dot w-3 h-3 rounded-full bg-wiki-border/50"></span>
              </div>
              <span class="text-wiki-muted text-sm">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Universal Answers 탭 -->
      <div id="tab-universal" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">관심 분야</h4>
              <button onclick="editField('universal_answers', 'interest')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-interest" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">강점</h4>
              <button onclick="editField('universal_answers', 'strength')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-strength" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">기피 요소</h4>
              <button onclick="editField('universal_answers', 'dislike')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-dislike" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">우선순위</h4>
              <button onclick="editField('universal_answers', 'priority')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-priority" class="text-white font-medium">-</p>
          </div>
          
          <!-- 나를 알아가기 섹션 (Q8-Q15) -->
          <div class="mt-6 pt-4 border-t border-wiki-border/30">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fas fa-brain text-purple-400"></i> 나를 알아가기
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">업무 스타일</h4>
                <p id="field-workstyle_social" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">언어 능력</h4>
                <div id="field-language" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">🔥 감수 가능</h4>
                <div id="field-mm_sacrifice" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">⚡ 에너지 소모원</h4>
                <div id="field-mm_energy_drain" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">🏆 성취 피드백</h4>
                <div id="field-mm_achievement" class="flex flex-wrap gap-2">
                  <span class="text-wiki-muted">-</span>
                </div>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">🏃 실행 스타일</h4>
                <p id="field-mm_execution" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">🌍 영향 범위</h4>
                <p id="field-mm_impact_scope" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">💥 실패 반응</h4>
                <p id="field-mm_failure" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">🛡️ 버팀 앵커</h4>
                <p id="field-mm_anchor" class="text-white font-medium">-</p>
              </div>
              <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
                <h4 class="text-sm font-medium text-wiki-muted mb-2">👁️ 외부 기대 반응</h4>
                <p id="field-mm_external" class="text-white font-medium">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Transition Signal 탭 -->
      <div id="tab-transition" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">희망 전환 유형</h4>
              <button onclick="editField('transition_signal', 'desired_types')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-desired_types" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">전환 동기</h4>
              <button onclick="editField('transition_signal', 'motivation')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-motivation" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">목표 기간</h4>
              <button onclick="editField('transition_signal', 'timeline')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <p id="field-timeline" class="text-white font-medium">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">장애 요소</h4>
              <button onclick="editField('transition_signal', 'blockers')" class="text-wiki-muted hover:text-wiki-primary transition">
                <i class="fas fa-edit text-xs"></i>
              </button>
            </div>
            <div id="field-blockers" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Narrative/Round Answers 탭 -->
      <div id="tab-narrative" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">가장 생생했던 순간</h4>
            </div>
            <p id="field-highAliveMoment" class="text-white leading-relaxed">-</p>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">가장 지쳤던 순간</h4>
            </div>
            <p id="field-lostMoment" class="text-white leading-relaxed">-</p>
          </div>
          <div id="round-answers-container" class="space-y-4">
            <!-- 라운드 답변들이 여기에 동적으로 추가됨 -->
          </div>
        </div>
      </div>
      
      <!-- Resume Data 탭 -->
      <div id="tab-resume" class="tab-panel hidden">
        <div class="space-y-4">
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">보유 스킬</h4>
            </div>
            <div id="field-skills" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">자격증</h4>
            </div>
            <div id="field-certifications" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-wiki-muted">경험 업종</h4>
            </div>
            <div id="field-industries" class="flex flex-wrap gap-2">
              <span class="text-wiki-muted">-</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
              <h4 class="text-sm font-medium text-wiki-muted mb-3">학력 수준</h4>
              <p id="field-education_level" class="text-white font-medium">-</p>
            </div>
            <div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">
              <h4 class="text-sm font-medium text-wiki-muted mb-3">역할 유형</h4>
              <p id="field-role_type" class="text-white font-medium">-</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 편집 모달 -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70" onclick="closeEditModal()"></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-wiki-bg border border-wiki-border rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="modal-title" class="text-lg font-semibold text-white">필드 수정</h3>
          <button onclick="closeEditModal()" class="text-wiki-muted hover:text-white transition">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="modal-content" class="mb-6">
          <!-- 동적으로 폼 필드 삽입 -->
        </div>
        <div class="flex justify-end gap-3">
          <button onclick="closeEditModal()" class="px-4 py-2 text-wiki-muted hover:text-white transition">취소</button>
          <button onclick="saveField()" class="px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white font-medium rounded-lg transition">저장</button>
        </div>
      </div>
    </div>
    
    <!-- 메타데이터 영역 -->
    <div class="mt-6 pt-6 border-t border-wiki-border/30">
      <div class="flex flex-wrap items-center justify-between gap-4 text-sm text-wiki-muted">
        <div class="flex items-center gap-4">
          <span id="meta-updated"><i class="far fa-clock mr-1"></i>마지막 업데이트: -</span>
          <span id="meta-analysis"><i class="fas fa-chart-line mr-1"></i>마지막 분석: -</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="meta-completeness" class="flex items-center gap-2">
            완성도: <div class="w-24 h-2 bg-wiki-border/30 rounded-full overflow-hidden"><div class="h-full bg-wiki-primary rounded-full" style="width: 0%"></div></div> 0%
          </span>
        </div>
      </div>
    </div>
    
    <script>
      // 전역 상태
      let profileData = null;
      let currentCategory = null;
      let currentField = null;
      
      // 필드 라벨 맵
      const fieldLabels = {
        role_identity: '역할 정체성',
        career_stage_years: '경력 단계',
        transition_status: '전환 상태',
        skill_level: '스킬 레벨',
        interest: '관심 분야',
        strength: '강점',
        dislike: '기피 요소',
        priority: '우선순위',
        desired_types: '희망 전환 유형',
        motivation: '전환 동기',
        timeline: '목표 기간',
        blockers: '장애 요소'
      };
      
      // 값 라벨 맵
      const valueLabels = {
        // role_identity
        worker: '직장인',
        student: '학생',
        jobseeker: '구직자',
        career_changer: '이직 준비생',
        freelancer: '프리랜서',
        // career_stage_years
        '0_3': '0~3년 (초기)',
        '3_7': '3~7년 (성장기)',
        '7_15': '7~15년 (전문가)',
        '15_plus': '15년 이상 (시니어)',
        // transition_status
        exploring: '탐색 중',
        decided: '결정됨',
        preparing: '준비 중',
        transitioning: '전환 중',
        stable: '안정적',
        changer: '전환 고려 중',
        returner: '복귀 준비 중',
        // priority
        stability: '안정성',
        growth: '성장',
        balance: '워라밸',
        income: '소득',
        purpose: '의미/목적',
        // timeline
        '3m': '3개월 이내',
        '6m': '6개월 이내',
        '1y': '1년 이내',
        '2y_plus': '2년 이상',
        undecided: '미정',
        // motivation
        dissatisfaction: '현재 직무 불만족',
        better_opportunity: '더 좋은 기회',
        passion: '새로운 분야 열정',
        life_change: '생활 변화',
        skill_growth: '역량 향상',
        // ========== 나를 알아가기 (Q8-Q15) ==========
        // 업무 스타일 (Q7)
        alone_work: '혼자 집중',
        team_work: '함께 협업',
        mixed_work: '상황에 따라',
        // 포기 가능 (Q8 - sacrifice)
        low_initial_income: '낮은 초봉 감수',
        willing_to_study: '재학습 감수',
        field_change_ok: '분야 전환 감수',
        ignore_social_pressure: '주변 시선 감수',
        no_sacrifice: '포기 불가',
        // 에너지 소모 (Q9 - energy_drain)
        people_drain: '대인관계 스트레스',
        cognitive_drain: '인지 피로',
        time_pressure_drain: '시간 압박',
        responsibility_drain: '책임 스트레스',
        repetition_drain: '반복 피로',
        unpredictability_drain: '불확실성',
        // 성취 피드백 (Q10)
        metric_feedback: '수치 성과',
        helping_feedback: '직접 도움',
        problem_solved_feedback: '문제 해결',
        tangible_output_feedback: '결과물 산출',
        growth_feedback: '성장 실감',
        // 실행 스타일 (Q11)
        action_first: '일단 해보기',
        plan_first: '계획 우선',
        flexible_execution: '상황 따라',
        // 영향 범위 (Q12)
        individual_scope: '개인',
        team_scope: '팀/조직',
        company_scope: '회사/산업',
        society_scope: '사회 전반',
        unknown_scope: '잘 모르겠다',
        // 실패 반응 (Q13)
        iterate_on_failure: '구조 개선',
        pivot_on_failure: '빠르게 전환',
        pause_on_failure: '잠시 정리',
        emotionally_affected: '크게 흔들림',
        // 버팀 앵커 (Q14)
        reward_anchor: '보상',
        growth_anchor: '성장',
        people_anchor: '사람',
        meaning_anchor: '의미/방향성',
        stability_anchor: '안정성',
        // 외부 기대 반응 (Q15)
        external_structure_ok: '기준이 있으면 편함',
        neutral_to_expectation: '상관없음',
        expectation_pressure: '부담됨',
        // 관심 분야
        problem_solving: '문제해결',
        creating: '창작/디자인',
        helping_teaching: '도움/가르침',
        data_numbers: '데이터/숫자',
        organizing: '조직/관리',
        influencing: '영향력/설득',
        // 강점
        analytical: '분석력',
        creative: '창의력',
        communication: '소통력',
        structured_execution: '실행력',
        persistence: '끈기',
        fast_learning: '학습력'
      };
      
      // 페이지 로드 시 데이터 가져오기
      document.addEventListener('DOMContentLoaded', loadProfile);
      
      async function loadProfile() {
        try {
          const res = await fetch('/api/ai-analyzer/profile');
          const data = await res.json();
          
          if (!data.success) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            return;
          }
          
          profileData = data.profile;
          
          // 메타데이터 업데이트
          updateMetadata(data.metadata);
          
          // 데이터 렌더링
          renderProfile(data.profile);
          
          // 변경사항 체크
          checkForChanges();
          
          // 로딩 숨기고 첫 번째 탭 표시
          document.getElementById('loading-state').classList.add('hidden');
          document.getElementById('tab-career').classList.remove('hidden');
          
        } catch (error) {
          console.error('Profile load error:', error);
          document.getElementById('loading-state').innerHTML = '<p class="text-red-400">프로필을 불러오는 중 오류가 발생했습니다.</p>';
        }
      }
      
      function updateMetadata(metadata) {
        if (metadata.last_updated_at) {
          const updatedDate = new Date(metadata.last_updated_at);
          document.getElementById('meta-updated').innerHTML = '<i class="far fa-clock mr-1"></i>마지막 업데이트: ' + updatedDate.toLocaleDateString('ko-KR');
        }
        if (metadata.last_analysis_at) {
          const analysisDate = new Date(metadata.last_analysis_at);
          document.getElementById('meta-analysis').innerHTML = '<i class="fas fa-chart-line mr-1"></i>마지막 분석: ' + analysisDate.toLocaleDateString('ko-KR');
        }
        const completeness = Math.round((metadata.data_completeness || 0) * 100);
        document.getElementById('meta-completeness').innerHTML = '완성도: <div class="w-24 h-2 bg-wiki-border/30 rounded-full overflow-hidden"><div class="h-full bg-wiki-primary rounded-full" style="width: ' + completeness + '%"></div></div> ' + completeness + '%';
        
        // 요약 헤더 업데이트
        const summaryEl = document.getElementById('profile-summary');
        summaryEl.innerHTML = '<p class="text-wiki-muted">총 ' + (metadata.total_facts_count || 0) + '개의 프로필 데이터가 저장되어 있습니다.</p>';
      }
      
      function renderProfile(profile) {
        if (!profile) return;
        
        // Career State
        if (profile.career_state) {
          const cs = profile.career_state;
          setText('field-role_identity', valueLabels[cs.role_identity] || cs.role_identity || '-');
          setText('field-career_stage_years', valueLabels[cs.career_stage_years] || cs.career_stage_years || '-');
          setText('field-transition_status', valueLabels[cs.transition_status] || cs.transition_status || '-');
          renderSkillLevel(cs.skill_level);
        }
        
        // Universal Answers
        if (profile.universal_answers) {
          const ua = profile.universal_answers;
          renderTags('field-interest', ua.interest, 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30');
          renderTags('field-strength', ua.strength, 'bg-blue-500/20 text-blue-300 border-blue-500/30');
          renderTags('field-dislike', ua.dislike, 'bg-red-500/20 text-red-300 border-red-500/30');
          setText('field-priority', valueLabels[ua.priority] || ua.priority || '-');
          
          // 나를 알아가기 (Q8-Q15)
          setText('field-workstyle_social', valueLabels[ua.workstyle_social] || ua.workstyle_social || '-');
          renderLanguageTags('field-language', ua.language);
          renderTagsWithLabel('field-mm_sacrifice', ua.mm_sacrifice, 'bg-orange-500/20 text-orange-300 border-orange-500/30');
          renderTagsWithLabel('field-mm_energy_drain', ua.mm_energy_drain, 'bg-red-500/20 text-red-300 border-red-500/30');
          renderTagsWithLabel('field-mm_achievement', ua.mm_achievement, 'bg-green-500/20 text-green-300 border-green-500/30');
          setText('field-mm_execution', valueLabels[ua.mm_execution] || ua.mm_execution || '-');
          setText('field-mm_impact_scope', valueLabels[ua.mm_impact_scope] || ua.mm_impact_scope || '-');
          setText('field-mm_failure', valueLabels[ua.mm_failure] || ua.mm_failure || '-');
          setText('field-mm_anchor', valueLabels[ua.mm_anchor] || ua.mm_anchor || '-');
          setText('field-mm_external', valueLabels[ua.mm_external] || ua.mm_external || '-');
        }
        
        // Transition Signal
        if (profile.transition_signal) {
          const ts = profile.transition_signal;
          renderTags('field-desired_types', ts.desired_types, 'bg-purple-500/20 text-purple-300 border-purple-500/30');
          setText('field-motivation', valueLabels[ts.motivation] || ts.motivation || '-');
          setText('field-timeline', valueLabels[ts.timeline] || ts.timeline || '-');
          renderTags('field-blockers', ts.blockers, 'bg-orange-500/20 text-orange-300 border-orange-500/30');
        }
        
        // Narrative Facts
        if (profile.narrative_facts) {
          setText('field-highAliveMoment', profile.narrative_facts.highAliveMoment || '-');
          setText('field-lostMoment', profile.narrative_facts.lostMoment || '-');
        }
        
        // Round Answers
        if (profile.round_answers && profile.round_answers.length > 0) {
          const container = document.getElementById('round-answers-container');
          container.innerHTML = profile.round_answers.map((ra, i) => 
            '<div class="profile-card p-4 rounded-xl bg-wiki-card/30 border border-wiki-border/30">' +
              '<h4 class="text-sm font-medium text-wiki-muted mb-3">라운드 ' + ra.round + ' 답변 #' + (i + 1) + '</h4>' +
              '<p class="text-white leading-relaxed">' + escapeHtml(ra.answer || '-') + '</p>' +
            '</div>'
          ).join('');
        }
        
        // Resume Data
        if (profile.resume_data) {
          const rd = profile.resume_data;
          renderTags('field-skills', rd.skills, 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30');
          renderTags('field-certifications', rd.certifications, 'bg-amber-500/20 text-amber-300 border-amber-500/30');
          renderTags('field-industries', rd.industries, 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30');
          setText('field-education_level', rd.education_level || '-');
          setText('field-role_type', rd.role_type || '-');
        }
      }
      
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }
      
      function renderTags(id, items, colorClass) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || items.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        el.innerHTML = items.map(item => 
          '<span class="px-3 py-1 text-sm rounded-full border ' + colorClass + '">' + escapeHtml(item) + '</span>'
        ).join('');
      }
      
      // 토큰을 한국어 라벨로 변환하여 태그 렌더링
      function renderTagsWithLabel(id, items, colorClass) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || items.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        el.innerHTML = items.map(item => {
          const label = valueLabels[item] || item;
          return '<span class="px-3 py-1 text-sm rounded-full border ' + colorClass + '">' + escapeHtml(label) + '</span>';
        }).join('');
      }
      
      // 언어 태그 렌더링 (수준 포함)
      function renderLanguageTags(id, langData) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!langData) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        
        // 배열인 경우 (단순 언어 목록)
        if (Array.isArray(langData)) {
          if (langData.length === 0 || (langData.length === 1 && langData[0] === 'none')) {
            el.innerHTML = '<span class="text-wiki-muted">없음</span>';
            return;
          }
          el.innerHTML = langData.filter(l => l !== 'none').map(lang => 
            '<span class="px-3 py-1 text-sm rounded-full border bg-indigo-500/20 text-indigo-300 border-indigo-500/30">' + escapeHtml(lang) + '</span>'
          ).join('');
          return;
        }
        
        // 객체인 경우 (언어: {level, label} 형태)
        const entries = Object.entries(langData);
        if (entries.length === 0) {
          el.innerHTML = '<span class="text-wiki-muted">-</span>';
          return;
        }
        
        const langLabels = {
          korean: '한국어', english: '영어', japanese: '일본어', chinese: '중국어',
          spanish: '스페인어', german: '독일어', french: '프랑스어', russian: '러시아어',
          italian: '이탈리아어', portuguese: '포르투갈어', arabic: '아랍어', hindi: '힌디어',
          vietnamese: '베트남어', thai: '태국어', indonesian: '인도네시아어', turkish: '터키어'
        };
        const levelLabels = {
          beginner: '초급', intermediate: '중급', advanced: '고급', native: '원어민'
        };
        
        el.innerHTML = entries.map(([lang, info]) => {
          const langName = langLabels[lang] || lang;
          const levelName = levelLabels[info?.level] || info?.level || '';
          return '<span class="px-3 py-1 text-sm rounded-full border bg-indigo-500/20 text-indigo-300 border-indigo-500/30">' + 
            escapeHtml(langName) + (levelName ? ' (' + levelName + ')' : '') + '</span>';
        }).join('');
      }
      
      function renderSkillLevel(level) {
        const el = document.getElementById('field-skill_level');
        if (!el) return;
        const lvl = level || 0;
        const labels = ['미설정', '입문', '초급', '중급', '고급', '전문가'];
        el.innerHTML = '<div class="flex gap-1">' +
          [1,2,3,4,5].map(i => 
            '<span class="skill-dot w-3 h-3 rounded-full ' + (i <= lvl ? 'bg-wiki-primary' : 'bg-wiki-border/50') + '"></span>'
          ).join('') +
          '</div><span class="text-wiki-muted text-sm ml-2">' + labels[lvl] + '</span>';
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // 탭 전환
      function switchTab(tabName) {
        // 모든 탭 버튼 비활성화
        document.querySelectorAll('.profile-tab').forEach(btn => {
          btn.classList.remove('bg-wiki-primary', 'text-white');
          btn.classList.add('text-wiki-muted', 'hover:bg-wiki-card/50');
        });
        
        // 선택된 탭 버튼 활성화
        const activeBtn = document.querySelector('[data-tab="' + tabName + '"]');
        if (activeBtn) {
          activeBtn.classList.add('bg-wiki-primary', 'text-white');
          activeBtn.classList.remove('text-wiki-muted', 'hover:bg-wiki-card/50');
        }
        
        // 모든 탭 패널 숨기기
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        
        // 선택된 탭 패널 표시
        const activePanel = document.getElementById('tab-' + tabName);
        if (activePanel) {
          activePanel.classList.remove('hidden');
        }
      }
      
      // 변경사항 체크
      async function checkForChanges() {
        try {
          const res = await fetch('/api/ai-analyzer/profile/diff');
          const data = await res.json();
          
          if (data.success && data.has_changes) {
            const banner = document.getElementById('changes-banner');
            const message = document.getElementById('changes-message');
            banner.classList.remove('hidden');
            message.textContent = data.recommendation || '프로필이 변경되었습니다.';
          }
        } catch (error) {
          console.error('Diff check error:', error);
        }
      }
      
      // 필드 편집
      function editField(category, field) {
        currentCategory = category;
        currentField = field;
        
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        
        title.textContent = fieldLabels[field] || field;
        
        let currentValue = '';
        if (profileData && profileData[category]) {
          currentValue = profileData[category][field];
        }
        
        // 필드 타입에 따른 입력 폼 생성
        if (Array.isArray(currentValue)) {
          content.innerHTML = '<textarea id="edit-value" rows="4" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" placeholder="쉼표로 구분하여 입력">' + (currentValue.join(', ')) + '</textarea>';
        } else if (typeof currentValue === 'number') {
          content.innerHTML = '<input type="number" id="edit-value" value="' + (currentValue || '') + '" min="0" max="5" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" />';
        } else {
          content.innerHTML = '<input type="text" id="edit-value" value="' + (currentValue || '') + '" class="w-full px-4 py-3 bg-wiki-card border border-wiki-border rounded-lg text-white focus:outline-none focus:border-wiki-primary" />';
        }
        
        document.getElementById('edit-modal').classList.remove('hidden');
      }
      
      function closeEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
        currentCategory = null;
        currentField = null;
      }
      
      async function saveField() {
        if (!currentCategory || !currentField) return;
        
        const inputEl = document.getElementById('edit-value');
        let newValue = inputEl.value;
        
        // 배열 타입 처리
        if (inputEl.tagName === 'TEXTAREA') {
          newValue = newValue.split(',').map(s => s.trim()).filter(Boolean);
        } else if (inputEl.type === 'number') {
          newValue = parseInt(newValue, 10);
        }
        
        try {
          const res = await fetch('/api/ai-analyzer/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              updates: {
                [currentCategory]: {
                  [currentField]: newValue
                }
              }
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            closeEditModal();
            // 페이지 새로고침하여 데이터 반영
            loadProfile();
          } else {
            alert('저장 실패: ' + (data.message || '알 수 없는 오류'));
          }
        } catch (error) {
          console.error('Save error:', error);
          alert('저장 중 오류가 발생했습니다.');
        }
      }
      
      // 빠른 재분석
      async function quickReanalyze() {
        try {
          const btn = event.target;
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>처리 중...';
          }
          
          const res = await fetch('/api/ai-analyzer/profile/quick-reanalyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              use_existing_data: true,
              skip_unchanged_steps: true
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            // analyzer_url이 있으면 분석 페이지로, 없으면 결과 페이지로 이동
            if (data.analyzer_url) {
              window.location.href = data.analyzer_url;
            } else {
              window.location.href = '/user/ai-results';
            }
          } else {
            alert('재분석 요청 실패: ' + (data.message || '알 수 없는 오류'));
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-redo mr-2"></i>변경사항 적용하여 재분석';
            }
          }
        } catch (error) {
          console.error('Reanalyze error:', error);
          alert('재분석 요청 중 오류가 발생했습니다.');
        }
      }
    </script>
    
    <style>
      .profile-tab::-webkit-scrollbar { display: none; }
      .tab-panel { animation: fadeIn 0.2s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  `
}

// AI 추천 페이지 (결과 + 프로필 탭)
app.get('/user/ai-results', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/auth/google?return_url=/user/ai-results')
  }
  
  const activeTab = (c.req.query('tab') || 'results') as 'results' | 'profile'
  const filter = (c.req.query('filter') || 'all') as 'all' | 'job' | 'major'
  const page = parseInt(c.req.query('page') || '1', 10)
  const limit = 10
  const offset = (page - 1) * limit
  
  try {
    // 진행중인 모든 draft 조회 (완료된 것은 request_id도 함께 조회)
    // LEFT JOIN으로 ai_analysis_requests와 연결하여 request_id 가져오기
    const draftResults = await c.env.DB.prepare(`
      SELECT 
        d.id, d.session_id, d.analysis_type, d.current_step, 
        d.step1_answers_json, d.step4_answers_json, d.updated_at,
        r.id as request_id
      FROM analyzer_drafts d
      LEFT JOIN ai_analysis_requests r ON d.session_id = r.session_id AND r.status = 'completed'
      WHERE d.user_id = ? 
      ORDER BY d.updated_at DESC
    `).bind(user.id).all<{
      id: number
      session_id: string
      analysis_type: string
      current_step: number
      step1_answers_json: string | null
      step4_answers_json: string | null
      updated_at: string
      request_id: number | null
    }>()
    
    // 총 개수 조회
    const countResult = await c.env.DB.prepare(`
      SELECT COUNT(*) as total
      FROM ai_analysis_results r
      JOIN ai_analysis_requests req ON r.request_id = req.id
      WHERE req.user_id = ?
      ${filter !== 'all' ? 'AND req.analysis_type = ?' : ''}
    `).bind(...(filter !== 'all' ? [user.id, filter] : [user.id])).first<{ total: number }>()
    
    const total = countResult?.total || 0
    const totalPages = Math.ceil(total / limit)
    
    // 결과 조회
    const results = await c.env.DB.prepare(`
      SELECT 
        r.id,
        r.request_id,
        r.result_json,
        r.confidence_score,
        r.created_at,
        r.engine_version,
        CASE WHEN r.premium_report_json IS NOT NULL THEN 1 ELSE 0 END as has_premium_report,
        req.session_id,
        req.analysis_type
      FROM ai_analysis_results r
      JOIN ai_analysis_requests req ON r.request_id = req.id
      WHERE req.user_id = ?
      ${filter !== 'all' ? 'AND req.analysis_type = ?' : ''}
      ORDER BY r.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(...(filter !== 'all' ? [user.id, filter, limit, offset] : [user.id, limit, offset])).all<{
      id: number
      request_id: number
      result_json: string
      confidence_score: number | null
      created_at: string
      engine_version: string | null
      has_premium_report: number
      session_id: string
      analysis_type: string
    }>()
    
    // 결과 파싱
    const parsedResults: AiResultItem[] = (results.results || []).map(r => {
      let topRecs: Array<{ name: string; score?: number }> = []
      try {
        const parsed = JSON.parse(r.result_json)
        const fitTop3 = parsed.fit_top3 || []
        topRecs = fitTop3.slice(0, 3).map((j: any) => ({
          name: j.job_name || j.name || '알 수 없음',
          score: j.fit_score
        }))
      } catch { }
      
      return {
        id: r.id,
        request_id: r.request_id,
        session_id: r.session_id,
        analysis_type: r.analysis_type as 'job' | 'major',
        top_recommendations: topRecs,
        confidence_score: r.confidence_score,
        created_at: r.created_at,
        engine_version: r.engine_version || 'v2',
        has_premium_report: r.has_premium_report === 1
      }
    })
    
    const resultsContent = renderUserAiResultsContent({
      results: parsedResults,
      filter,
      totalCount: total,
      page,
      totalPages,
      drafts: (draftResults?.results || []).map(d => {
        // step1_answers_json에서 profileSubStep, currentRound 추출
        let profileSubStep = 1
        let currentRound = 0
        try {
          if (d.step1_answers_json) {
            const step1 = JSON.parse(d.step1_answers_json)
            profileSubStep = step1.profileSubStep || 1
            currentRound = step1.currentRound || 0
          }
          // step4_answers_json에서도 currentRound 확인 (fallback)
          if (!currentRound && d.step4_answers_json) {
            const step4 = JSON.parse(d.step4_answers_json)
            currentRound = step4.current_round || 0
          }
        } catch { /* ignore parse errors */ }
        
        return {
          id: d.id,
          session_id: d.session_id,
          analysis_type: d.analysis_type as 'job' | 'major',
          current_step: d.current_step,
          profile_sub_step: profileSubStep,
          current_round: currentRound,
          updated_at: d.updated_at,
          request_id: d.request_id  // 완료된 분석의 request_id (결과 페이지 링크용)
        }
      })
    })
    
    // 프로필 컨텐츠 HTML
    const profileContent = generateProfileContentHtml()
    
    // 탭 구조 컨텐츠
    const tabbedContent = `
      <!-- 메인 탭 네비게이션 -->
      <div class="flex items-center gap-4 mb-6 border-b border-wiki-border/40 pb-4">
        <a href="/user/ai-results?tab=results" 
           class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${activeTab === 'results' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:text-white hover:bg-wiki-card/50'}">
          <i class="fas fa-robot"></i>
          <span>AI 추천</span>
        </a>
        <a href="/user/ai-results?tab=profile" 
           class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${activeTab === 'profile' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:text-white hover:bg-wiki-card/50'}">
          <i class="fas fa-user-circle"></i>
          <span>내 프로필</span>
        </a>
      </div>
      
      <!-- 탭 컨텐츠 -->
      ${activeTab === 'results' ? `
        <p class="text-wiki-muted mb-6">AI 추천을 받으면 여기서 분석 결과를 확인할 수 있습니다.</p>
        ${resultsContent}
        
        <!-- 삭제 확인 모달 -->
        <div id="delete-draft-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
          <div class="bg-wiki-card border border-wiki-border rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
            <div class="text-center mb-6">
              <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center">
                <i class="fas fa-trash text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold text-white mb-2">진행중인 추천 삭제</h3>
              <p class="text-wiki-muted text-sm">정말 삭제하시겠습니까?<br>작성한 내용이 모두 사라집니다.</p>
            </div>
            <div class="flex gap-3">
              <button onclick="hideDeleteModal()" class="flex-1 px-4 py-2.5 bg-wiki-bg border border-wiki-border text-white rounded-xl hover:bg-wiki-card transition text-sm font-medium">
                취소
              </button>
              <button onclick="confirmDeleteDraft()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition text-sm font-medium">
                삭제
              </button>
            </div>
          </div>
        </div>
        
        <script>
          let pendingDeleteSessionId = null;
          
          function deleteDraft(sessionId) {
            pendingDeleteSessionId = sessionId;
            document.getElementById('delete-draft-modal').classList.remove('hidden');
          }
          
          function hideDeleteModal() {
            document.getElementById('delete-draft-modal').classList.add('hidden');
            pendingDeleteSessionId = null;
          }
          
          async function confirmDeleteDraft() {
            if (!pendingDeleteSessionId) return;
            
            try {
              const response = await fetch('/api/ai-analyzer/draft/delete?session_id=' + encodeURIComponent(pendingDeleteSessionId), {
                method: 'DELETE',
                credentials: 'same-origin'
              });
              
              if (response.ok) {
                // 로컬 스토리지도 삭제 (job/major 둘 다)
                localStorage.removeItem('analyzer_draft');
                localStorage.removeItem('analyzer_draft_timestamp');
                localStorage.removeItem('analyzer_draft_major');
                localStorage.removeItem('analyzer_draft_major_timestamp');
                
                // 페이지 새로고침하여 목록 갱신
                window.location.reload();
              } else {
                alert('삭제에 실패했습니다. 다시 시도해주세요.');
              }
            } catch (error) {
              console.error('Delete error:', error);
              alert('삭제 중 오류가 발생했습니다.');
            }
            
            hideDeleteModal();
          }
          
          async function deleteAllDrafts() {
            if (!confirm('진행중인 모든 분석을 삭제하시겠습니까?\\n이 작업은 되돌릴 수 없습니다.')) {
              return;
            }
            
            try {
              const response = await fetch('/api/ai-analyzer/draft/delete-all', {
                method: 'DELETE',
                credentials: 'same-origin'
              });
              
              if (response.ok) {
                const data = await response.json();
                
                // 로컬 스토리지도 모두 삭제
                localStorage.removeItem('analyzer_draft');
                localStorage.removeItem('analyzer_draft_timestamp');
                localStorage.removeItem('analyzer_draft_major');
                localStorage.removeItem('analyzer_draft_major_timestamp');
                
                alert(data.deleted_count + '개의 진행중 분석이 삭제되었습니다.');
                window.location.reload();
              } else {
                alert('삭제에 실패했습니다. 다시 시도해주세요.');
              }
            } catch (error) {
              console.error('Delete all error:', error);
              alert('삭제 중 오류가 발생했습니다.');
            }
          }
        </script>
      ` : profileContent}
    `
    
    const pageContent = renderUserLayoutContent({
      title: 'AI 추천',
      currentPath: '/user/ai-results',
      children: tabbedContent,
      username: user.username || user.email || 'user_' + user.id,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    
    return c.html(renderLayoutWithContext(c, pageContent, 'AI 추천 - 마이페이지 - Careerwiki'))
    
  } catch (error) {
    console.error('[User AI Results] Error:', error)
    const errorContent = renderUserLayoutContent({
      title: 'AI 추천',
      currentPath: '/user/ai-results',
      children: `<div class="text-center py-16"><p class="text-wiki-muted">결과를 불러오는 중 오류가 발생했습니다.</p></div>`,
      username: user.username || user.email,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    return c.html(renderLayoutWithContext(c, errorContent, 'AI 추천 - 마이페이지 - Careerwiki'))
  }
})

// AI 추천 결과 상세 페이지
app.get('/user/ai-results/:requestId', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/auth/google?return_url=' + encodeURIComponent(c.req.path))
  }
  
  const requestId = parseInt(c.req.param('requestId'), 10)
  
  try {
    // 결과 조회 (본인 것만 - req.user_id 또는 draft 소유권으로 확인)
    const result = await c.env.DB.prepare(`
      SELECT
        r.id,
        r.request_id,
        r.result_json,
        r.premium_report_json,
        r.confidence_score,
        r.created_at,
        r.engine_version,
        req.session_id,
        req.analysis_type
      FROM ai_analysis_results r
      JOIN ai_analysis_requests req ON r.request_id = req.id
      LEFT JOIN analyzer_drafts d ON req.session_id = d.session_id
      WHERE req.id = ? AND (req.user_id = ? OR d.user_id = ?)
    `).bind(requestId, user.id, user.id).first<{
      id: number
      request_id: number
      result_json: string
      premium_report_json: string | null
      confidence_score: number | null
      created_at: string
      engine_version: string | null
      session_id: string
      analysis_type: string
    }>()
    
    if (!result) {
      const notFoundContent = renderUserLayoutContent({
        title: '결과를 찾을 수 없음',
        currentPath: '/user/ai-results',
        children: `<div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: rgba(239, 68, 68, 0.1);">
            <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
          </div>
          <h3 class="text-xl font-semibold text-white mb-3">결과를 찾을 수 없습니다</h3>
          <p class="mb-6 text-wiki-muted">요청하신 분석 결과가 존재하지 않거나 접근 권한이 없습니다.</p>
          <a href="/user/ai-results" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm bg-wiki-primary/20 text-wiki-secondary">
            <i class="fas fa-arrow-left"></i> 목록으로 돌아가기
          </a>
        </div>`,
        username: user.username || user.email,
        pictureUrl: user.custom_picture_url || user.picture_url || null,
        role: user.role
      })
      return c.html(renderLayoutWithContext(c, notFoundContent, '결과 없음 - 마이페이지 - Careerwiki'))
    }
    
    // 결과 파싱
    let parsedResult: any = {}
    try {
      parsedResult = JSON.parse(result.result_json)
    } catch { }
    
    let premiumReport: any = null
    if (result.premium_report_json) {
      try {
        premiumReport = JSON.parse(result.premium_report_json)
      } catch { }
    }
    
    const isJob = result.analysis_type === 'job'
    const typeLabel = isJob ? '직업 추천' : '전공 추천'
    
    // 상세 결과 표시 콘텐츠
    const content = `
      <div class="max-w-4xl mx-auto">
        <!-- 상단 네비게이션 -->
        <div class="mb-6 flex items-center justify-between">
          <a href="/user/ai-results" class="inline-flex items-center gap-2 text-sm transition hover:opacity-80" style="color: #9aa3c5;">
            <i class="fas fa-arrow-left"></i> 목록으로
          </a>
          <button onclick="copyAllResults()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition hover:opacity-80" style="background: rgba(67, 97, 238, 0.2); color: #64b5f6;">
            <i class="fas fa-copy"></i> 결과 전체 복사
          </button>
        </div>
        
        <!-- 결과 헤더 -->
        <div class="p-6 rounded-xl mb-6" style="background: rgba(26, 26, 46, 0.6); border: 1px solid rgba(148, 163, 184, 0.15);">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center ${isJob ? 'bg-blue-500/20' : 'bg-emerald-500/20'}">
              <i class="fas ${isJob ? 'fa-briefcase text-blue-400' : 'fa-university text-emerald-400'} text-xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">${typeLabel} 결과</h2>
              <p class="text-sm" style="color: #9aa3c5;">${new Date(result.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
            </div>
          </div>
          ${result.confidence_score ? `
            <div class="flex items-center gap-2">
              <span class="text-sm" style="color: #9aa3c5;">신뢰도:</span>
              <div class="flex-1 h-2 rounded-full max-w-xs" style="background: rgba(67, 97, 238, 0.2);">
                <div class="h-full rounded-full" style="width: ${Math.round(result.confidence_score * 100)}%; background: linear-gradient(90deg, #4361ee, #64b5f6);"></div>
              </div>
              <span class="text-sm font-medium" style="color: #64b5f6;">${Math.round(result.confidence_score * 100)}%</span>
            </div>
          ` : ''}
        </div>
        
        <!-- TOP 추천 -->
        <div id="results-content" class="space-y-6">
          ${(parsedResult.fit_top3 || []).length > 0 ? `
            <div class="p-6 rounded-xl" style="background: rgba(26, 26, 46, 0.6); border: 1px solid rgba(148, 163, 184, 0.15);">
              <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-trophy text-amber-400 mr-2"></i>TOP 추천
              </h3>
              <div class="space-y-3">
                ${(parsedResult.fit_top3 || []).map((job: any, i: number) => `
                  <div class="flex items-start gap-4 p-4 rounded-lg" style="background: rgba(67, 97, 238, 0.05);">
                    <span class="text-2xl font-bold ${i === 0 ? 'text-amber-400' : i === 1 ? 'text-slate-300' : 'text-amber-600'}">${i + 1}</span>
                    <div class="flex-1">
                      <p class="font-medium text-white">${job.job_name || job.name || '알 수 없음'}</p>
                      ${job.job_description ? `<p class="text-sm mt-1" style="color: #b4c5e4; line-height: 1.4;">${job.job_description.length > 120 ? job.job_description.substring(0, 120) + '...' : job.job_description}</p>` : ''}
                      ${job.fit_score ? `<p class="text-sm mt-1" style="color: #64b5f6;">적합도: ${job.fit_score}점</p>` : ''}
                    </div>
                    ${job.slug ? `<a href="/${isJob ? 'job' : 'major'}/${job.slug}" class="text-sm hover:underline whitespace-nowrap" style="color: #4361ee;">상세 보기</a>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          ${premiumReport ? `
            <!-- 프리미엄 리포트 요약 -->
            <div class="p-6 rounded-xl" style="background: rgba(26, 26, 46, 0.6); border: 1px solid rgba(148, 163, 184, 0.15);">
              <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-file-alt text-emerald-400 mr-2"></i>분석 요약
              </h3>
              ${premiumReport.summary_one_page?.headline ? `
                <p class="text-white mb-4">${premiumReport.summary_one_page.headline}</p>
              ` : ''}
              ${premiumReport.summary_one_page?.top_takeaways?.length > 0 ? `
                <ul class="space-y-2">
                  ${premiumReport.summary_one_page.top_takeaways.map((t: string) => `
                    <li class="flex items-start gap-2" style="color: #9aa3c5;">
                      <i class="fas fa-check text-emerald-400 mt-1"></i>
                      <span>${t}</span>
                    </li>
                  `).join('')}
                </ul>
              ` : ''}
            </div>
          ` : ''}
          
          ${parsedResult.llm_explanation ? `
            <div class="p-6 rounded-xl" style="background: rgba(26, 26, 46, 0.6); border: 1px solid rgba(148, 163, 184, 0.15);">
              <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-lightbulb text-amber-400 mr-2"></i>추천 이유
              </h3>
              <div class="prose prose-invert max-w-none" style="color: #9aa3c5;">
                <p>${parsedResult.llm_explanation.like_reason || ''}</p>
                <p>${parsedResult.llm_explanation.can_reason || ''}</p>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
      
      <script>
        function copyAllResults() {
          const content = document.getElementById('results-content');
          if (!content) return;
          
          // 텍스트 추출 (이미지 제외)
          const text = content.innerText;
          const header = '=== AI 추천 결과 ===\\n' + '${typeLabel}\\n' + '생성일: ${new Date(result.created_at).toLocaleDateString('ko-KR')}\\n\\n';
          
          navigator.clipboard.writeText(header + text).then(() => {
            alert('결과가 클립보드에 복사되었습니다!');
          }).catch(err => {
            console.error('복사 실패:', err);
            alert('복사에 실패했습니다. 직접 선택하여 복사해주세요.');
          });
        }
      </script>
    `
    
    const detailPageContent = renderUserLayoutContent({
      title: `${typeLabel} 결과`,
      currentPath: '/user/ai-results',
      children: content,
      username: user.username || user.email,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    
    return c.html(renderLayoutWithContext(c, detailPageContent, `${typeLabel} 결과 - 마이페이지 - Careerwiki`))
    
  } catch (error) {
    console.error('[User AI Result Detail] Error:', error)
    const errorPageContent = renderUserLayoutContent({
      title: '오류',
      currentPath: '/user/ai-results',
      children: `<div class="text-center py-16"><p class="text-wiki-muted">결과를 불러오는 중 오류가 발생했습니다.</p></div>`,
      username: user.username || user.email,
      pictureUrl: user.custom_picture_url || user.picture_url || null,
      role: user.role
    })
    return c.html(renderLayoutWithContext(c, errorPageContent, '오류 - 마이페이지 - Careerwiki'))
  }
})

// 내 작성 댓글 페이지
app.get('/user/comments', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/comments')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // 내 댓글 조회 (pages 테이블과 조인)
  // author_id는 숫자로 저장되므로 CAST로 비교
  const comments = await c.env.DB.prepare(`
    SELECT c.id, c.content, c.created_at, p.page_type, p.slug, p.title as page_title
    FROM comments c
    JOIN pages p ON c.page_id = p.id
    WHERE CAST(c.author_id AS INTEGER) = ? AND c.status != 'deleted'
    ORDER BY c.created_at DESC
    LIMIT 100
  `).bind(user.id).all<{
    id: number; content: string; created_at: string; page_type: string; 
    slug: string; page_title: string | null
  }>()
  
  const allComments = comments.results || []
  
  // 페이지 타입별 분류 (guide는 howto로 취급)
  const jobComments = allComments.filter(c => c.page_type === 'job')
  const majorComments = allComments.filter(c => c.page_type === 'major')
  const guideComments = allComments.filter(c => c.page_type === 'guide' || c.page_type === 'howto')
  
  // 필터 적용
  let filteredComments = allComments
  if (filter === 'job') filteredComments = jobComments
  else if (filter === 'major') filteredComments = majorComments
  else if (filter === 'howto') filteredComments = guideComments
  
  // 페이지 타입에 따른 아이콘과 색상
  const getTypeInfo = (pageType: string) => {
    switch (pageType) {
      case 'job': return { icon: 'fa-briefcase', color: 'text-blue-400', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/30', label: '직업' }
      case 'major': return { icon: 'fa-university', color: 'text-emerald-400', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/30', label: '전공' }
      case 'guide':
      case 'howto': return { icon: 'fa-lightbulb', color: 'text-amber-400', bgColor: 'bg-amber-500/10', borderColor: 'border-amber-500/30', label: 'HowTo' }
      default: return { icon: 'fa-file', color: 'text-wiki-muted', bgColor: 'bg-wiki-card/50', borderColor: 'border-wiki-border/40', label: '기타' }
    }
  }
  
  // slug에서 type prefix 제거하고 실제 URL path 생성
  const getCommentUrl = (pageType: string, slug: string) => {
    // slug가 "guide:some-slug" 또는 "job:some-slug" 형태로 저장됨
    const cleanSlug = slug.replace(/^(guide|job|major):/, '')
    // guide는 howto로 라우팅
    const urlPath = pageType === 'guide' ? 'howto' : pageType
    return `/${urlPath}/${cleanSlug}`
  }
  
  const innerContent = `
      <p class="text-wiki-muted mb-6">내가 작성한 댓글들을 확인합니다</p>
      
      <!-- 필터 탭 -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto">
        <a href="/user/comments?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          전체 <span class="ml-1 opacity-70">(${allComments.length})</span>
        </a>
        <a href="/user/comments?filter=job" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'job' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-briefcase mr-1.5"></i>직업 <span class="ml-1 opacity-70">(${jobComments.length})</span>
        </a>
        <a href="/user/comments?filter=major" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'major' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-university mr-1.5"></i>전공 <span class="ml-1 opacity-70">(${majorComments.length})</span>
        </a>
        <a href="/user/comments?filter=howto" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'howto' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-lightbulb mr-1.5"></i>HowTo <span class="ml-1 opacity-70">(${guideComments.length})</span>
        </a>
      </div>
      
      ${filteredComments.length > 0 ? `
        <div class="space-y-4">
          ${filteredComments.map(comment => {
            const typeInfo = getTypeInfo(comment.page_type)
            const commentUrl = getCommentUrl(comment.page_type, comment.slug)
            return `
            <a href="${escapeHtml(commentUrl)}#comment-${comment.id}" 
               class="block p-4 bg-wiki-bg/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
              <div class="flex items-start justify-between gap-4 mb-2">
                <div class="flex items-center gap-2 min-w-0">
                  <span class="px-2 py-0.5 rounded-full text-xs ${typeInfo.bgColor} ${typeInfo.color} ${typeInfo.borderColor} border shrink-0">
                    <i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.label}
                  </span>
                  <span class="text-sm text-wiki-primary group-hover:underline truncate">
                    ${escapeHtml(comment.page_title || comment.slug.replace(/^(guide|job|major):/, ''))}
                  </span>
                </div>
                <span class="text-xs text-wiki-muted shrink-0">${formatDateSafe(comment.created_at)}</span>
              </div>
              <p class="text-wiki-text text-sm line-clamp-2">${escapeHtml(comment.content)}</p>
            </a>
          `}).join('')}
        </div>
      ` : `
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-bg/50 mb-4">
            <i class="fas fa-comments text-2xl text-wiki-muted"></i>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">
            ${filter === 'all' ? '작성한 댓글이 없습니다' : `작성한 ${filter === 'job' ? '직업' : filter === 'major' ? '전공' : 'HowTo'} 댓글이 없습니다`}
          </h3>
          <p class="text-wiki-muted">
            ${filter === 'all' 
              ? '직업, 전공, HowTo 페이지에서 댓글을 작성해보세요!' 
              : `${filter === 'job' ? '직업위키' : filter === 'major' ? '전공위키' : 'HowTo 가이드'}에서 댓글을 작성해보세요!`}
          </p>
          <div class="mt-4">
            <a href="/${filter === 'all' ? 'job' : (filter === 'howto' ? 'howto' : filter)}" class="inline-flex items-center gap-2 px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white rounded-lg text-sm transition">
              <i class="fas fa-arrow-right"></i>
              ${filter === 'job' ? '직업위키' : filter === 'major' ? '전공위키' : filter === 'howto' ? 'HowTo 가이드' : '직업위키'} 둘러보기
            </a>
          </div>
        </div>
      `}
  `
  
  const pageContent = renderUserLayoutContent({
    title: '작성 댓글',
    currentPath: '/user/comments',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, '작성 댓글 - 마이페이지 - Careerwiki', '내가 작성한 댓글')
  )
})

// 저장함 페이지
app.get('/user/bookmarks', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect('/login?redirect=/user/bookmarks')
  }
  
  const filter = c.req.query('filter') || 'all'
  
  // 저장된 항목 조회 (테이블이 없을 수 있음)
  let bookmarkList: Array<{ id: number; item_type: string; item_slug: string; item_title: string; created_at: string }> = []
  try {
    const bookmarks = await c.env.DB.prepare(`
      SELECT b.id, b.item_type, b.item_slug, b.item_title, b.created_at
      FROM user_bookmarks b
      WHERE b.user_id = ?
      ORDER BY b.created_at DESC
      LIMIT 100
    `).bind(user.id).all<{
      id: number; item_type: string; item_slug: string; item_title: string; created_at: string
    }>()
    bookmarkList = bookmarks.results || []
  } catch (e) {
    // 테이블이 없으면 빈 배열
    console.log('[bookmarks] Table not found, showing empty')
  }
  
  // 타입별로 분류
  const jobs = bookmarkList.filter(b => b.item_type === 'job')
  const majors = bookmarkList.filter(b => b.item_type === 'major')
  const howtos = bookmarkList.filter(b => b.item_type === 'howto')
  
  // 필터 적용
  let filteredBookmarks = bookmarkList
  if (filter === 'job') filteredBookmarks = jobs
  else if (filter === 'major') filteredBookmarks = majors
  else if (filter === 'howto') filteredBookmarks = howtos
  
  // 타입에 따른 아이콘과 색상
  const getTypeInfo = (itemType: string) => {
    switch (itemType) {
      case 'job': return { icon: 'fa-briefcase', color: 'text-blue-400', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/30', label: '직업', path: 'job' }
      case 'major': return { icon: 'fa-university', color: 'text-emerald-400', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/30', label: '전공', path: 'major' }
      case 'howto': return { icon: 'fa-lightbulb', color: 'text-amber-400', bgColor: 'bg-amber-500/10', borderColor: 'border-amber-500/30', label: 'HowTo', path: 'howto' }
      default: return { icon: 'fa-file', color: 'text-wiki-muted', bgColor: 'bg-wiki-card/50', borderColor: 'border-wiki-border/40', label: '기타', path: '' }
    }
  }
  
  const innerContent = `
      <p class="text-wiki-muted mb-6">저장한 직업, 전공, HowTo를 확인합니다</p>
      
      <!-- 필터 탭 -->
      <div class="flex items-center gap-2 mb-6 border-b border-wiki-border/40 pb-4 overflow-x-auto">
        <a href="/user/bookmarks?filter=all" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'all' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          전체 <span class="ml-1 opacity-70">(${bookmarkList.length})</span>
        </a>
        <a href="/user/bookmarks?filter=job" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'job' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-briefcase mr-1.5"></i>직업 <span class="ml-1 opacity-70">(${jobs.length})</span>
        </a>
        <a href="/user/bookmarks?filter=major" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'major' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-university mr-1.5"></i>전공 <span class="ml-1 opacity-70">(${majors.length})</span>
        </a>
        <a href="/user/bookmarks?filter=howto" 
           class="px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${filter === 'howto' ? 'bg-wiki-primary text-white' : 'text-wiki-muted hover:bg-wiki-card/50'}">
          <i class="fas fa-lightbulb mr-1.5"></i>HowTo <span class="ml-1 opacity-70">(${howtos.length})</span>
        </a>
      </div>
      
      ${filteredBookmarks.length > 0 ? `
        <div class="space-y-4">
          ${filteredBookmarks.map(bookmark => {
            const typeInfo = getTypeInfo(bookmark.item_type)
            return `
            <a href="/${typeInfo.path}/${escapeHtml(bookmark.item_slug)}" 
               class="block p-4 bg-wiki-bg/50 border border-wiki-border/40 rounded-xl hover:border-wiki-primary/50 transition group">
              <div class="flex items-center sm:items-start justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0">
                  <span class="px-2 py-0.5 rounded-full text-xs ${typeInfo.bgColor} ${typeInfo.color} ${typeInfo.borderColor} border shrink-0">
                    <i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.label}
                  </span>
                  <span class="text-wiki-text group-hover:text-wiki-primary transition truncate">
                    ${escapeHtml(bookmark.item_title)}
                  </span>
                </div>
                <div class="flex items-center gap-3 shrink-0">
                  <span class="text-xs text-wiki-muted">${new Date(Number(bookmark.created_at) * 1000).toLocaleDateString('ko-KR')}</span>
                  <i class="fas fa-chevron-right text-wiki-muted text-xs group-hover:text-wiki-primary transition"></i>
                </div>
              </div>
            </a>
          `}).join('')}
        </div>
      ` : `
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-wiki-bg/50 mb-4">
            <i class="fas fa-bookmark text-2xl text-wiki-muted"></i>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">
            ${filter === 'all' ? '저장한 항목이 없습니다' : `저장한 ${filter === 'job' ? '직업' : filter === 'major' ? '전공' : 'HowTo'}이 없습니다`}
          </h3>
          <p class="text-wiki-muted">
            ${filter === 'all' 
              ? '직업, 전공, HowTo 페이지에서 북마크 버튼을 눌러 저장해보세요!' 
              : `${filter === 'job' ? '직업위키' : filter === 'major' ? '전공위키' : 'HowTo 가이드'}에서 북마크 버튼을 눌러 저장해보세요!`}
          </p>
          <div class="mt-4">
            <a href="/${filter === 'all' ? 'job' : filter}" class="inline-flex items-center gap-2 px-4 py-2 bg-wiki-primary hover:bg-wiki-primary/90 text-white rounded-lg text-sm transition">
              <i class="fas fa-arrow-right"></i>
              ${filter === 'job' ? '직업위키' : filter === 'major' ? '전공위키' : filter === 'howto' ? 'HowTo 가이드' : '직업위키'} 둘러보기
            </a>
          </div>
        </div>
      `}
  `
  
  const pageContent = renderUserLayoutContent({
    title: '저장함',
    currentPath: '/user/bookmarks',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(
    renderLayoutWithContext(c, pageContent, '저장함 - 마이페이지 - Careerwiki', '저장한 직업, 전공, HowTo')
  )
})

// ============================================================================
// 북마크 API (저장 토글)
// ============================================================================

// 북마크 상태 확인 API
app.get('/api/bookmark/:type/:slug', async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ saved: false, error: 'not_logged_in' })
  }
  
  const { type, slug } = c.req.param()
  if (!['job', 'major', 'howto'].includes(type)) {
    return c.json({ saved: false, error: 'invalid_type' }, 400)
  }
  
  try {
    const existing = await c.env.DB.prepare(`
      SELECT id FROM user_bookmarks WHERE user_id = ? AND item_type = ? AND item_slug = ?
    `).bind(user.id, type, slug).first()
    
    return c.json({ saved: !!existing })
  } catch (e) {
    return c.json({ saved: false, error: 'db_error' }, 500)
  }
})

// 북마크 토글 API (저장/해제)
app.post('/api/bookmark', async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'not_logged_in', message: '로그인이 필요합니다' }, 401)
  }
  
  let body: { type: string; slug: string; title?: string }
  try {
    body = await c.req.json()
  } catch {
    return c.json({ success: false, error: 'invalid_body' }, 400)
  }
  
  const { type, slug, title } = body
  if (!type || !slug) {
    return c.json({ success: false, error: 'missing_params' }, 400)
  }
  if (!['job', 'major', 'howto'].includes(type)) {
    return c.json({ success: false, error: 'invalid_type' }, 400)
  }
  
  try {
    // 기존 북마크 확인
    const existing = await c.env.DB.prepare(`
      SELECT id FROM user_bookmarks WHERE user_id = ? AND item_type = ? AND item_slug = ?
    `).bind(user.id, type, slug).first<{ id: number }>()
    
    if (existing) {
      // 이미 저장됨 -> 삭제 (토글)
      await c.env.DB.prepare(`
        DELETE FROM user_bookmarks WHERE id = ?
      `).bind(existing.id).run()
      
      return c.json({ success: true, saved: false, message: '저장 해제되었습니다' })
    } else {
      // 저장되지 않음 -> 추가
      await c.env.DB.prepare(`
        INSERT INTO user_bookmarks (user_id, item_type, item_slug, item_title)
        VALUES (?, ?, ?, ?)
      `).bind(user.id, type, slug, title || null).run()
      
      return c.json({ success: true, saved: true, message: '저장되었습니다' })
    }
  } catch (e) {
    console.error('[bookmark] Error:', e)
    return c.json({ success: false, error: 'db_error' }, 500)
  }
})

// ===== 프로필 이미지 업로드 API =====
// POST /api/user/profile-image - 프로필 이미지 업로드
app.post('/api/user/profile-image', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'unauthorized' }, 401)
  }
  
  try {
    const formData = await c.req.formData()
    const file = formData.get('image') as File | null
    
    if (!file) {
      return c.json({ success: false, error: '이미지 파일이 필요합니다' }, 400)
    }
    
    // 파일 검증
    const { validateContentType, validateFileSize, validateMagicNumber, uploadToR2 } = await import('./services/uploadService')
    
    const typeResult = validateContentType(file.type)
    if (!typeResult.valid) {
      return c.json({ success: false, error: typeResult.error }, 400)
    }
    
    // 프로필 이미지는 2MB로 제한
    const MAX_PROFILE_SIZE = 2 * 1024 * 1024
    if (file.size > MAX_PROFILE_SIZE) {
      return c.json({ success: false, error: '프로필 이미지는 2MB를 초과할 수 없습니다' }, 400)
    }
    
    const sizeResult = validateFileSize(file.size)
    if (!sizeResult.valid) {
      return c.json({ success: false, error: sizeResult.error }, 400)
    }
    
    // 매직 넘버 검증
    const buffer = await file.arrayBuffer()
    if (!validateMagicNumber(buffer, file.type)) {
      return c.json({ success: false, error: '유효하지 않은 이미지 파일입니다' }, 400)
    }
    
    // 파일 키 생성 (profile/userId/timestamp.ext)
    const now = new Date()
    const timestamp = now.getTime()
    const ext = typeResult.ext || 'jpg'
    const fileKey = `profile/${user.id}/${timestamp}.${ext}`
    
    // R2에 업로드
    const uploadResult = await uploadToR2(
      c.env.UPLOADS,
      fileKey,
      buffer,
      file.type,
      { userId: String(user.id), type: 'profile' }
    )
    
    if (!uploadResult.success) {
      return c.json({ success: false, error: uploadResult.error || '업로드 실패' }, 500)
    }
    
    // 공개 URL 생성
    const publicUrl = `/uploads/${fileKey}`
    
    // DB 업데이트
    await c.env.DB.prepare(`
      UPDATE users SET custom_picture_url = ?, updated_at = ? WHERE id = ?
    `).bind(publicUrl, Math.floor(Date.now() / 1000), user.id).run()
    
    return c.json({ 
      success: true, 
      url: publicUrl,
      message: '프로필 이미지가 업데이트되었습니다' 
    })
  } catch (e) {
    console.error('[profile-image upload] Error:', e)
    return c.json({ success: false, error: '업로드 중 오류가 발생했습니다' }, 500)
  }
})

// DELETE /api/user/profile-image - 프로필 이미지 초기화 (기본 아이콘으로)
app.delete('/api/user/profile-image', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'unauthorized' }, 401)
  }
  
  try {
    // 기존 custom_picture_url이 있으면 R2에서 삭제 시도 (선택적)
    if (user.custom_picture_url && user.custom_picture_url.startsWith('/uploads/')) {
      const fileKey = user.custom_picture_url.replace('/uploads/', '')
      const { deleteFromR2 } = await import('./services/uploadService')
      await deleteFromR2(c.env.UPLOADS, fileKey).catch(() => {})
    }
    
    // DB에서 custom_picture_url 제거
    await c.env.DB.prepare(`
      UPDATE users SET custom_picture_url = NULL, updated_at = ? WHERE id = ?
    `).bind(Math.floor(Date.now() / 1000), user.id).run()
    
    return c.json({ 
      success: true, 
      message: '프로필 이미지가 기본으로 초기화되었습니다' 
    })
  } catch (e) {
    console.error('[profile-image delete] Error:', e)
    return c.json({ success: false, error: '초기화 중 오류가 발생했습니다' }, 500)
  }
})

// Phase 3 Day 4: 개인 설정 페이지
app.get('/user/settings', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.redirect(`/auth/google?return_url=${encodeURIComponent(c.req.path + c.req.query())}`)
  }
  
  const userData = {
    id: user.id,
    name: user.name,
    email: user.email,
    username: user.username,
    picture_url: user.picture_url,
    custom_picture_url: user.custom_picture_url,
    role: user.role,
    created_at: user.created_at
  }
  
  // 프로필 이미지 우선순위: custom > OAuth > 기본 아이콘
  const profileImageUrl = userData.custom_picture_url || userData.picture_url || null
  
  const innerContent = `
      <div class="space-y-6">
        <!-- 프로필 정보 섹션 -->
        <div class="bg-wiki-bg/50 p-6 rounded-xl border border-wiki-border">
          <h2 class="text-xl font-semibold mb-4 text-wiki-text">
            <i class="fas fa-user mr-2 text-wiki-primary"></i>프로필 정보
          </h2>
          
          <div class="space-y-4">
            <!-- 프로필 사진 -->
            <div class="flex items-start gap-4">
              <div class="relative group">
                <div 
                  id="profile-image-container"
                  class="w-20 h-20 rounded-full overflow-hidden border-2 border-wiki-border cursor-pointer hover:border-wiki-primary transition-colors"
                  title="클릭하여 프로필 이미지 변경"
                >
                  ${profileImageUrl ? `
                    <img 
                      id="profile-image"
                      src="${profileImageUrl}" 
                      alt="${userData.name || 'User'}"
                      class="w-full h-full object-cover"
                    />
                  ` : `
                    <div id="profile-image" class="w-full h-full bg-wiki-card flex items-center justify-center">
                      <i class="fas fa-user-circle text-4xl text-wiki-muted"></i>
                    </div>
                  `}
                  <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-full">
                    <i class="fas fa-camera text-white text-xl"></i>
                  </div>
                </div>
                <input 
                  type="file" 
                  id="profile-image-input" 
                  accept="image/jpeg,image/png,image/gif,image/webp"
                  class="hidden"
                />
              </div>
              <div class="flex-1 space-y-2">
                <p class="text-sm text-wiki-text font-medium">프로필 사진</p>
                <p class="text-xs text-wiki-muted">이미지를 클릭하여 변경하세요. (최대 2MB, JPG/PNG/GIF/WEBP)</p>
                <div class="flex flex-wrap gap-2 mt-2">
                  <button 
                    id="profile-image-upload-btn"
                    type="button"
                    class="px-4 py-2.5 min-h-[44px] text-sm bg-wiki-primary text-white rounded-lg hover:bg-blue-600 transition-colors"
                  >
                    <i class="fas fa-upload mr-1.5"></i>이미지 변경
                  </button>
                  ${userData.custom_picture_url ? `
                    <button 
                      id="profile-image-reset-btn"
                      type="button"
                      class="px-4 py-2.5 min-h-[44px] text-sm bg-wiki-card border border-wiki-border text-wiki-text rounded-lg hover:bg-wiki-bg transition-colors"
                    >
                      <i class="fas fa-undo mr-1.5"></i>기본으로 초기화
                    </button>
                  ` : ''}
                </div>
                <div id="profile-image-status" class="text-xs mt-2 hidden"></div>
              </div>
            </div>
            
            <!-- 이메일 -->
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">이메일</label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.email}
              </div>
              <p class="text-xs text-wiki-muted mt-1">Google 계정 이메일입니다.</p>
            </div>
          </div>
        </div>
        
        <!-- 계정 설정 섹션 -->
        <div class="bg-wiki-bg/50 p-6 rounded-xl border border-wiki-border">
          <h2 class="text-xl font-semibold mb-4 text-wiki-text">
            <i class="fas fa-id-card mr-2 text-wiki-primary"></i>계정 설정
          </h2>
          
          <div class="space-y-4">
            <!-- 사용자 아이디 변경 -->
            <div>
              <label for="username" class="block text-sm font-medium text-wiki-text mb-2">
                사용자 아이디 (닉네임)
              </label>
              <form id="username-form" class="flex flex-col sm:flex-row gap-2">
                <input
                  type="text"
                  id="username"
                  name="username"
                  value="${userData.username || ''}"
                  placeholder="user_abc123"
                  pattern="[a-z0-9_]{3,20}"
                  class="flex-1 px-4 py-3 min-h-[48px] bg-wiki-card border border-wiki-border rounded-lg text-wiki-text focus:outline-none focus:border-wiki-primary focus:ring-1 focus:ring-wiki-primary"
                  style="font-size: 16px;"
                  required
                />
                <button
                  type="submit"
                  class="px-6 py-3 min-h-[48px] bg-wiki-primary text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                >
                  변경
                </button>
              </form>
              <p class="text-xs text-wiki-muted mt-2">
                3-20자, 영문 소문자, 숫자, 언더스코어(_)만 사용 가능합니다.
              </p>
              <div id="username-message" class="mt-2 text-sm hidden"></div>
            </div>
            
            <!-- 가입일 -->
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">가입일</label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.created_at ? new Date(Number(userData.created_at) * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }) : '알 수 없음'}
              </div>
            </div>
            
            <!-- 역할 -->
            <div>
              <label class="block text-sm font-medium text-wiki-text mb-2">역할</label>
              <div class="px-4 py-2 bg-wiki-card border border-wiki-border rounded-lg text-wiki-text">
                ${userData.role === 'admin' ? '관리자' : userData.role === 'expert' ? '전문가' : '일반 사용자'}
              </div>
            </div>
          </div>
        </div>
        
        <!-- 보안 섹션 -->
        <div class="bg-wiki-bg/50 p-6 rounded-xl border border-wiki-border">
          <h2 class="text-xl font-semibold mb-4 text-wiki-text">
            <i class="fas fa-shield-halved mr-2 text-wiki-primary"></i>보안
          </h2>
          
          <div class="space-y-4">
            <div>
              <p class="text-sm text-wiki-muted mb-2">
                Google OAuth를 통해 로그인하므로 별도의 비밀번호가 없습니다.
              </p>
              <p class="text-sm text-wiki-muted">
                계정 보안은 Google 계정 설정에서 관리하세요.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      (function() {
        const form = document.getElementById('username-form');
        const input = document.getElementById('username');
        const message = document.getElementById('username-message');
        
        if (!form || !input || !message) return;
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const newUsername = input.value.trim().toLowerCase();
          
          // 클라이언트 측 유효성 검사
          if (!/^[a-z0-9_]{3,20}$/.test(newUsername)) {
            message.className = 'mt-2 text-sm text-red-400';
            message.textContent = '사용자 아이디는 3-20자의 영문 소문자, 숫자, 언더스코어만 사용할 수 있습니다.';
            message.classList.remove('hidden');
            return;
          }
          
          // 버튼 비활성화
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '변경 중...';
          }
          
          try {
            const response = await fetch('/api/user/username', {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username: newUsername })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
              message.className = 'mt-2 text-sm text-green-400';
              message.textContent = '사용자 아이디가 변경되었습니다.';
              message.classList.remove('hidden');
              
              // 페이지 새로고침
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              message.className = 'mt-2 text-sm text-red-400';
              message.textContent = data.error || '사용자 아이디 변경에 실패했습니다.';
              message.classList.remove('hidden');
            }
          } catch (error) {
            message.className = 'mt-2 text-sm text-red-400';
            message.textContent = '네트워크 오류가 발생했습니다.';
            message.classList.remove('hidden');
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = '변경';
            }
          }
        });
      })();
      
      // 프로필 이미지 업로드 스크립트
      (function() {
        const container = document.getElementById('profile-image-container');
        const imageInput = document.getElementById('profile-image-input');
        const uploadBtn = document.getElementById('profile-image-upload-btn');
        const resetBtn = document.getElementById('profile-image-reset-btn');
        const status = document.getElementById('profile-image-status');
        
        if (!container || !imageInput) return;
        
        // 이미지 컨테이너 클릭 시 파일 선택
        container.addEventListener('click', () => imageInput.click());
        if (uploadBtn) {
          uploadBtn.addEventListener('click', () => imageInput.click());
        }
        
        // 파일 선택 시 업로드
        imageInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          // 파일 크기 검증 (2MB)
          if (file.size > 2 * 1024 * 1024) {
            showStatus('프로필 이미지는 2MB를 초과할 수 없습니다', 'error');
            return;
          }
          
          // 파일 형식 검증
          const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            showStatus('지원하지 않는 파일 형식입니다 (JPG/PNG/GIF/WEBP만 가능)', 'error');
            return;
          }
          
          showStatus('업로드 중...', 'loading');
          
          try {
            const formData = new FormData();
            formData.append('image', file);
            
            const response = await fetch('/api/user/profile-image', {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
              showStatus('프로필 이미지가 업데이트되었습니다', 'success');
              // 페이지 새로고침하여 새 이미지 표시
              setTimeout(() => window.location.reload(), 1000);
            } else {
              showStatus(data.error || '업로드에 실패했습니다', 'error');
            }
          } catch (error) {
            showStatus('네트워크 오류가 발생했습니다', 'error');
          }
          
          // 입력 초기화
          imageInput.value = '';
        });
        
        // 초기화 버튼
        if (resetBtn) {
          resetBtn.addEventListener('click', async () => {
            if (!confirm('프로필 이미지를 기본으로 초기화하시겠습니까?')) return;
            
            showStatus('초기화 중...', 'loading');
            
            try {
              const response = await fetch('/api/user/profile-image', {
                method: 'DELETE'
              });
              
              const data = await response.json();
              
              if (response.ok && data.success) {
                showStatus('기본 이미지로 초기화되었습니다', 'success');
                setTimeout(() => window.location.reload(), 1000);
              } else {
                showStatus(data.error || '초기화에 실패했습니다', 'error');
              }
            } catch (error) {
              showStatus('네트워크 오류가 발생했습니다', 'error');
            }
          });
        }
        
        function showStatus(message, type) {
          if (!status) return;
          status.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-wiki-muted');
          if (type === 'success') {
            status.className = 'text-xs mt-2 text-green-400';
          } else if (type === 'error') {
            status.className = 'text-xs mt-2 text-red-400';
          } else {
            status.className = 'text-xs mt-2 text-wiki-muted';
          }
          status.textContent = message;
        }
      })();
    </script>
  `
  
  const pageContent = renderUserLayoutContent({
    title: '개인 설정',
    currentPath: '/user/settings',
    children: innerContent,
    username: user.username || user.email || `user_${user.id}`,
    pictureUrl: user.custom_picture_url || user.picture_url || null,
    role: user.role
  })
  
  return c.html(renderLayoutWithContext(c,
    pageContent,
    '개인 설정 - 마이페이지 - Careerwiki',
    '계정 설정 및 프로필 관리',
    false,
    { user: userData }
  ))
})

// ============================================================================
// 사용자 API
// ============================================================================

// Phase 3 Day 4: 사용자 아이디 변경 API
app.patch('/api/user/username', requireAuth, async (c) => {
  const user = c.get('user')
  if (!user) {
    return c.json({ success: false, error: 'Unauthorized' }, 401)
  }
  
  try {
    const body = await c.req.json() as { username?: string }
    
    if (!body.username) {
      return c.json({ success: false, error: 'Username is required' }, 400)
    }
    
    const { updateUsername } = await import('./utils/auth-helpers')
    await updateUsername(c.env.DB, user.id, body.username)
    
    return c.json({ success: true, message: 'Username updated successfully' })
  } catch (error) {
    console.error('❌ [User API] Failed to update username:', error)
    const errorMessage = error instanceof Error ? error.message : 'Failed to update username'
    return c.json({ success: false, error: errorMessage }, 400)
  }
})

// ============================================================================
// Admin 관련 API
// ============================================================================

// Admin API: Seed all jobs to D1
app.post('/api/admin/seed-jobs', requireAdmin, async (c) => {
  // Phase 3 Day 3: JWT 기반 인증으로 변경
  // requireAdmin 미들웨어가 이미 권한 체크를 수행함
  // 기존 토큰 기반 인증은 하위 호환성을 위해 유지 (선택 사항)
  
  // background 파라미터로 백그라운드 실행 여부 결정
  const background = c.req.query('background') === 'true'
  
  try {
    // 새 ETL 스크립트 사용 (seedAllJobs는 삭제됨)
    return c.json({ 
      error: 'This endpoint is deprecated. Please use the new ETL scripts in src/scripts/etl/' 
    }, 501)
    
    /*
    if (background) {
      // 백그라운드로 실행
      const seedPromise = Promise.resolve({}).catch((err: unknown) => {
        console.error('❌ Seed failed:', err)
        return {
          total: 0,
          processed: 0,
          inserted: 0,
          updated: 0,
          skipped: 0,
          errors: 1,
          errorDetails: [{ id: 'system', name: 'System', error: err.message }],
          startTime: Date.now()
        }
      })
      
      if (c.executionCtx && 'waitUntil' in c.executionCtx) {
        c.executionCtx.waitUntil(seedPromise)
      }
      
      return c.json({ 
        message: 'Seed started in background',
        estimatedTime: '약 3-5분 (500+ 직업 × 0.5초)',
        note: 'PM2 logs를 확인하세요: pm2 logs careerwiki --nostream'
      })
    } else {
      // 동기 실행 - 완료될 때까지 기다림
      console.log('🌱 Starting seed job synchronously...')
      return c.json({ error: 'Deprecated' }, 501)
    }
    */
  } catch (error: unknown) {
    console.error('❌ Seed start failed:', error)
    const errorMessage = error instanceof Error ? error.message : String(error)
    return c.json({ 
      error: 'Failed to start seed',
      details: errorMessage 
    }, 500)
  }
})

// ============================================
// Phase 4: 편집 시스템 API 엔드포인트
// ============================================

// 직업 편집 (단일 필드 또는 다중 필드 지원)
app.post('/api/job/:id/edit', requireJobMajorEdit, async (c) => {
  try {
    const jobId = c.req.param('id')
    const user = getOptionalUser(c)
    let body: any
    
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    // IP 해시 생성
    const ipAddress = c.req.header('cf-connecting-ip') ?? null
    const ipHash = await hashIpAddress(ipAddress)
    
    // 다중 필드 편집 (새로운 방식)
    if (body.fields && typeof body.fields === 'object') {
      const fields = body.fields as Record<string, any>
      const sources = body.sources as Record<string, { url?: string; text?: string; delete?: boolean }> | undefined
      const changeSummary = typeof body.changeSummary === 'string' ? body.changeSummary : undefined
      
      // 디버그: 리스트 필드 순서 확인
      if (fields['overviewWork.main']) {
      }
      
      if (Object.keys(fields).length === 0) {
        return c.json({ success: false, error: 'No fields to update' }, 400)
      }
      
      // 길이 검증 (최대 길이만 체크, 최소 길이는 체크하지 않음 - 빈 필드도 허용)
      for (const [key, value] of Object.entries(fields)) {
        if (typeof value === 'string' && value.length > 7000) {
          return c.json({ success: false, error: `${key}: 최대 7000자까지 입력 가능합니다` }, 400)
        }
      }
      
      // 출처는 URL이 아니어도 됨 (텍스트 출처 허용)
      // URL 검증 제거됨
      
      // 현재 데이터 조회
      const job = await c.env.DB.prepare('SELECT * FROM jobs WHERE id = ? AND is_active = 1')
        .bind(jobId)
        .first()
      
      if (!job) {
        return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
      }
      
      // 기존 user_contributed_json 파싱
      let userData: Record<string, any> = {}
      try {
        userData = job.user_contributed_json ? JSON.parse(job.user_contributed_json as string) : {}
      } catch { userData = {} }
      
      // 중첩 필드 처리 (예: 'overviewWork.main' -> { overviewWork: { main: value } })
      const flattenToNested = (flatFields: Record<string, any>): Record<string, any> => {
        const result: Record<string, any> = {}
        for (const [key, value] of Object.entries(flatFields)) {
          const parts = key.split('.')
          let current = result
          for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) current[parts[i]] = {}
            current = current[parts[i]]
          }
          current[parts[parts.length - 1]] = value
        }
        return result
      }
      
      // 기존 데이터와 병합
      const nestedFields = flattenToNested(fields)
      const deepMerge = (target: any, source: any): any => {
        for (const key of Object.keys(source)) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            target[key] = deepMerge(target[key] || {}, source[key])
          } else {
            target[key] = source[key]
          }
        }
        return target
      }
      
      const updatedUserData = deepMerge({ ...userData }, nestedFields)
      
      // 변경 전 값 저장 (비교 기능용)
      const previousValues: Record<string, any> = {}
      for (const key of Object.keys(fields)) {
        // 중첩된 키 처리 (예: overviewWork.main)
        const parts = key.split('.')
        let value: any = userData
        for (const part of parts) {
          value = value?.[part]
        }
        previousValues[key] = value ?? null
      }
      
      // 출처 데이터 저장 (URL 또는 텍스트) - 여러 개 지원
      if (sources && Object.keys(sources).length > 0) {
        updatedUserData._sources = updatedUserData._sources || {}
        // 기존 _sources에서 최대 id 추출 (배열/객체 모두 대응)
        const existingIds: number[] = []
        Object.values(updatedUserData._sources).forEach((val: any) => {
          if (Array.isArray(val)) {
            val.forEach(v => v?.id && existingIds.push(v.id))
          } else if (val?.id) {
            existingIds.push(val.id)
          }
        })
        let nextId = Math.max(0, ...existingIds) + 1

        for (const [key, source] of Object.entries(sources)) {
          if ((source as any)?.delete) {
            delete updatedUserData._sources[key]
            continue
          }

          // 배열 형태로 수신 (여러 개)
          const sourceArray = Array.isArray(source)
            ? source
            : [source]
          const normalized = sourceArray
            .map((s: any) => (s?.text || s?.url || '').trim())
            .filter(Boolean)
            .map(text => ({ id: nextId++, text }))

          if (normalized.length > 0) {
            updatedUserData._sources[key] = normalized
          }
        }
      }
      
      // _sources가 비어있으면 삭제
      if (updatedUserData._sources && Object.keys(updatedUserData._sources).length === 0) {
        delete updatedUserData._sources
      }
      
      const now = Date.now()
      
      // merged_profile_json 업데이트 (user_contributed_json과 병합)
      let currentMerged: any = {}
      try {
        currentMerged = job.merged_profile_json ? JSON.parse(job.merged_profile_json as string) : {}
      } catch { /* ignore */ }
      
      // _sources는 통째로 덮어쓰기 (삭제 반영을 위해)
      if (currentMerged._sources) {
        delete currentMerged._sources
      }
      
      // 깊은 병합 함수
      const deepMergeForUpdate = (target: any, source: any): any => {
        if (!source) return target
        if (!target) return source
        const result = { ...target }
        for (const key of Object.keys(source)) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            result[key] = deepMergeForUpdate(result[key] || {}, source[key])
          } else if (source[key] !== undefined) {
            result[key] = source[key]
          }
        }
        return result
      }
      
      const updatedMerged = deepMergeForUpdate(currentMerged, updatedUserData)
      
      // DB 업데이트 (merged_profile_json도 함께 업데이트)
      await c.env.DB.prepare(`
        UPDATE jobs SET user_contributed_json = ?, merged_profile_json = ?, user_last_updated_at = ?
        WHERE id = ?
      `).bind(JSON.stringify(updatedUserData), JSON.stringify(updatedMerged), now, jobId).run()
      
      // Revision 생성
      const { createRevision, getCurrentRevision } = await import('./services/revisionService')
      
      // 기존 리비전이 없으면 원본 상태를 r1으로 먼저 저장
      const existingRevision = await getCurrentRevision(c.env.DB, 'job', jobId)
      if (!existingRevision) {
        // 원본 상태를 r1으로 저장 (편집 전 상태)
        await createRevision(c.env.DB, {
          entityType: 'job',
          entityId: jobId,
          dataSnapshot: previousValues,  // 편집 전 원본 값
          previousValues: {},
          editorId: null,
          editorType: 'system',
          editorName: '원본',
          ipHash: null,
          changeType: 'initial',
          changeSummary: '원본 버전',
          changedFields: Object.keys(previousValues),
          storeFullSnapshot: true
        })
      }
      
      const revision = await createRevision(c.env.DB, {
        entityType: 'job',
        entityId: jobId,
        dataSnapshot: fields,  // 변경된 필드 값만
        previousValues,  // 변경 전 값
        editorId: user?.id?.toString() ?? null,
        editorType: (['user', 'expert', 'admin'].includes(user?.role || '') ? user?.role : 'anonymous') as 'user' | 'expert' | 'admin' | 'anonymous',
        editorName: user?.username ?? (ipHash ? `익명` : '익명 사용자'),
        ipHash: ipHash ?? null,
        changeType: 'edit',
        changeSummary: `${Object.keys(fields).length}개 필드 수정`,
        changedFields: Object.keys(fields),
        storeFullSnapshot: false
      })
      
      // 캐시 무효화
      await invalidatePageCache(c.env.DB, { jobId, pageType: 'job' })
      
      return c.json({
        success: true,
        revisionId: revision.id,
        message: 'Edit saved successfully'
      })
    }
    
    // 단일 필드 편집 (기존 방식 호환)
    const field = typeof body.field === 'string' ? body.field : ''
    const content = typeof body.content === 'string' ? body.content : ''
    const source = typeof body.source === 'string' ? body.source : ''
    const changeSummary = typeof body.changeSummary === 'string' ? body.changeSummary : undefined
    const anonymous = Boolean(body.anonymous)
    const password = typeof body.password === 'string' ? body.password : undefined
    
    // 필수 필드 검증 (field, content는 필수, source는 선택)
    if (!field || !content) {
      return c.json({ success: false, error: 'field and content are required' }, 400)
    }
    
    // 출처는 URL이 아니어도 됨 (텍스트 출처 허용)
    
    // 편집 서비스 호출
    const result = await editJob(c.env.DB, jobId, {
      field,
      content,
      source,
      changeSummary,
      anonymous,
      password,
      ipHash: ipHash ?? undefined,
      userId: user?.id?.toString(),
      editorType: user?.role as 'user' | 'expert' | 'admin' | undefined
    })
    
    // 캐시 무효화
    await invalidatePageCache(c.env.DB, {
      jobId: jobId,
      pageType: 'job'
    })
    
    return c.json({
      success: true,
      revisionId: result.revisionId,
      message: 'Edit saved successfully'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'edit failed'
    const status = message.includes('NOT_FOUND') ? 404 
      : message.includes('REQUIRED') || message.includes('INVALID') ? 400
      : message.includes('LIMIT') ? 403
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// 직업 숨기기/삭제 (운영자/관리자 전용)
// ?permanent=true 면 완전 삭제 (DB에서 제거), 없으면 숨기기 (soft delete)
app.delete('/api/job/:id', requireAuth, async (c) => {
  try {
    const jobId = c.req.param('id')
    const permanent = c.req.query('permanent') === 'true'
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    // 직업 존재 확인 (숨겨진 것도 포함)
    const job = await c.env.DB.prepare('SELECT id, name, is_active FROM jobs WHERE id = ?')
      .bind(jobId)
      .first<{ id: string; name: string; is_active: number }>()
    
    if (!job) {
      return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
    }
    
    // 캐시 무효화 (먼저 실행)
    await invalidatePageCache(c.env.DB, { jobId, pageType: 'job' })
    
    if (permanent) {
      // 완전 삭제: DB에서 제거 (revisions도 함께 삭제)
      
      // R2 이미지 삭제 (image_url 조회)
      const jobWithImage = await c.env.DB.prepare('SELECT image_url FROM jobs WHERE id = ?')
        .bind(jobId)
        .first<{ image_url: string | null }>()
      
      if (jobWithImage?.image_url && jobWithImage.image_url.startsWith('/uploads/') && c.env.UPLOADS) {
        const fileKey = jobWithImage.image_url.replace('/uploads/', '')
        try {
          await c.env.UPLOADS.delete(fileKey)
          console.log(`[Job Delete] R2 이미지 삭제: ${fileKey}`)
        } catch (e) {
          console.error(`[Job Delete] R2 이미지 삭제 실패: ${fileKey}`, e)
        }
      }
      
      try {
        await c.env.DB.prepare('DELETE FROM revisions WHERE entity_type = ? AND entity_id = ?')
          .bind('job', jobId)
          .run()
      } catch (e) {
        // revisions 테이블이 없어도 무시
        console.log('[Job Delete] Revisions table may not exist, skipping:', e)
      }
      
      await c.env.DB.prepare('DELETE FROM jobs WHERE id = ?')
        .bind(jobId)
        .run()
      
      console.log(`[Job Permanent Delete] Job "${job.name}" (${jobId}) permanently deleted by ${user.username || user.email}`)
      
      return c.json({
        success: true,
        message: `직업 "${job.name}"이(가) 완전히 삭제되었습니다. (복구 불가)`
      })
    } else {
      // 숨기기: soft delete (is_active = 0)
      await c.env.DB.prepare('UPDATE jobs SET is_active = 0, user_last_updated_at = ? WHERE id = ?')
        .bind(Date.now(), jobId)
        .run()
      
      console.log(`[Job Hide] Job "${job.name}" (${jobId}) hidden by ${user.username || user.email}`)
      
      return c.json({
        success: true,
        message: `직업 "${job.name}"이(가) 숨겨졌습니다. (관리자만 볼 수 있음)`
      })
    }
  } catch (error) {
    console.error('[Job Delete] Error:', error)
    return c.json({ success: false, error: 'DELETE_FAILED' }, 500)
  }
})

// 직업 복구 (운영자/관리자 전용) - 숨긴 직업 다시 활성화
app.post('/api/job/:id/restore', requireAuth, async (c) => {
  try {
    const jobId = c.req.param('id')
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    // 숨겨진 직업 확인
    const job = await c.env.DB.prepare('SELECT id, name, is_active FROM jobs WHERE id = ?')
      .bind(jobId)
      .first<{ id: string; name: string; is_active: number }>()
    
    if (!job) {
      return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
    }
    
    if (job.is_active === 1) {
      return c.json({ success: false, error: 'ALREADY_ACTIVE' }, 400)
    }
    
    // 복구 (is_active = 1)
    await c.env.DB.prepare('UPDATE jobs SET is_active = 1, user_last_updated_at = ? WHERE id = ?')
      .bind(Date.now(), jobId)
      .run()
    
    console.log(`[Job Restore] Job "${job.name}" (${jobId}) restored by ${user.username || user.email}`)
    
    return c.json({
      success: true,
      message: `직업 "${job.name}"이(가) 복구되었습니다.`
    })
  } catch (error) {
    console.error('[Job Restore] Error:', error)
    return c.json({ success: false, error: 'RESTORE_FAILED' }, 500)
  }
})

// 숨겨진 직업 목록 조회 (운영자/관리자 전용)
app.get('/api/job/hidden', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    const jobs = await c.env.DB.prepare(`
      SELECT id, name, slug, user_last_updated_at 
      FROM jobs 
      WHERE is_active = 0 
      ORDER BY user_last_updated_at DESC
    `).all<{ id: string; name: string; slug: string | null; user_last_updated_at: number }>()
    
    return c.json({
      success: true,
      jobs: jobs.results || []
    })
  } catch (error) {
    console.error('[Job Hidden List] Error:', error)
    return c.json({ success: false, error: 'FETCH_FAILED' }, 500)
  }
})

// 직업 생성 (일반 사용자)
app.post('/api/job/create', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const name = typeof body.name === 'string' ? body.name.trim() : ''
    const summary = typeof body.summary === 'string' ? body.summary.trim() : ''
    const heroTags = Array.isArray(body.heroTags) ? body.heroTags : []
    const heroCategory = typeof body.heroCategory === 'string' ? body.heroCategory.trim() : ''
    
    // 필수 필드 검증
    if (!name || name.length < 2) {
      return c.json({ success: false, error: '직업명은 최소 2자 이상이어야 합니다' }, 400)
    }
    if (!summary || summary.length < 2) {
      return c.json({ success: false, error: '설명은 최소 2자 이상이어야 합니다' }, 400)
    }
    
    // ID 생성 (이름 기반 slug)
    const slug = name.replace(/[\s\-\/\.·ㆍ,()]+/g, '-').toLowerCase()
    const id = `U_${slug}_${Date.now().toString(36)}`  // U_ prefix for user-created
    
    // 중복 확인
    const existing = await c.env.DB.prepare(
      'SELECT id FROM jobs WHERE name = ? AND is_active = 1'
    ).bind(name).first()
    
    if (existing) {
      return c.json({ success: false, error: '이미 존재하는 직업입니다' }, 400)
    }
    
    // user_contributed_json 데이터 구성
    const userData: Record<string, any> = {
      summary,
      overview: {
        summary
      }
    }
    if (heroTags.length > 0) {
      userData.heroTags = [...new Set(heroTags.filter((t: any) => typeof t === 'string' && t.trim()))]
    }
    if (heroCategory) {
      userData.heroCategory = heroCategory
    }
    
    // merged_profile_json 생성 (페이지 렌더링에 필요)
    const mergedProfile = {
      id,
      name,
      summary,
      heroTags: userData.heroTags || [],
      heroCategory: userData.heroCategory || '',
      source: 'USER' as const
    }
    
    // URL용 slug 생성
    const urlSlug = name.replace(/[\s]+/g, '-').toLowerCase()
    
    const now = Date.now()
    
    // jobs 테이블에 INSERT (merged_profile_json, slug 포함)
    console.log('[API] Inserting job:', { id, name, urlSlug, now })
    try {
      await c.env.DB.prepare(`
        INSERT INTO jobs (id, name, slug, user_contributed_json, merged_profile_json, user_last_updated_at, created_at, is_active, primary_source)
        VALUES (?, ?, ?, ?, ?, ?, ?, 1, 'USER')
      `).bind(
        id,
        name,
        urlSlug,
        JSON.stringify(userData),
        JSON.stringify(mergedProfile),
        now,
        now
      ).run()
      console.log('[API] Job inserted successfully')
    } catch (insertError) {
      console.error('[API] Job INSERT failed:', insertError)
      throw insertError
    }
    
    // 초기 revision 생성
    console.log('[API] Creating revision...')
    try {
      const { createRevision } = await import('./services/revisionService')
      await createRevision(c.env.DB, {
        entityType: 'job',
        entityId: id,
        dataSnapshot: { id, name, ...userData },
        editorId: user.id.toString(),
        editorType: user.role as 'user' | 'expert' | 'admin',
        editorName: user.username || `User ${user.id}`,
        changeType: 'initial',
        changeSummary: '직업 생성',
        changedFields: Object.keys(userData),
        storeFullSnapshot: true
      })
      console.log('[API] Revision created successfully')
    } catch (revisionError) {
      console.error('[API] Revision creation failed:', revisionError)
      throw revisionError
    }
    
    // 자동 이미지 생성 (동기 방식 - API 키가 있는 경우에만)
    let imageUrl: string | undefined
    let imagePrompt: string | undefined
    
    const geminiKey = (c.env as any).GEMINI_API_KEY
    const evolinkKey = (c.env as any).EVOLINK_API_KEY
    const uploadsR2 = (c.env as any).UPLOADS as R2Bucket | undefined
    
    if (geminiKey && evolinkKey && uploadsR2) {
      try {
        console.log(`[API] Starting auto image generation for job: ${name}`)
        const { generateJobImage } = await import('./services/autoImageService')
        const baseUrl = new URL(c.req.url).origin
        
        const imageResult = await generateJobImage(
          { GEMINI_API_KEY: geminiKey, EVOLINK_API_KEY: evolinkKey, UPLOADS: uploadsR2 },
          name,
          urlSlug,
          baseUrl
        )
        
        if (imageResult.success) {
          imageUrl = imageResult.imageUrl
          imagePrompt = imageResult.imagePrompt
          
          // DB 업데이트
          await c.env.DB.prepare(`
            UPDATE jobs SET image_url = ?, image_prompt = ? WHERE id = ?
          `).bind(imageUrl, imagePrompt, id).run()
          
          console.log(`[API] Auto image generated for job ${name}: ${imageUrl}`)
        } else {
          // 이미지 생성 실패해도 프롬프트는 저장
          if (imageResult.imagePrompt) {
            await c.env.DB.prepare(`
              UPDATE jobs SET image_prompt = ? WHERE id = ?
            `).bind(imageResult.imagePrompt, id).run()
            imagePrompt = imageResult.imagePrompt
          }
          console.warn(`[API] Auto image failed for job ${name}: ${imageResult.error}`)
        }
      } catch (imageError) {
        console.error('[API] Auto image generation error:', imageError)
        // 이미지 생성 실패해도 직업 생성은 성공으로 처리
      }
    } else {
      console.log('[API] Skipping auto image: API keys not configured')
    }
    
    return c.json({
      success: true,
      id,
      slug: urlSlug,
      imageUrl,
      imagePrompt,
      message: '직업이 생성되었습니다'
    }, 201)
    
  } catch (error) {
    console.error('[API] Create job error:', error)
    const message = error instanceof Error ? error.message : 'create failed'
    return c.json({ success: false, error: message }, 500)
  }
})

// 전공 숨기기/삭제 (운영자/관리자 전용)
// ?permanent=true 면 완전 삭제 (DB에서 제거), 없으면 숨기기 (soft delete)
app.delete('/api/major/:id', requireAuth, async (c) => {
  try {
    const majorId = c.req.param('id')
    const permanent = c.req.query('permanent') === 'true'
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    // 전공 존재 확인 (숨겨진 것도 포함)
    const major = await c.env.DB.prepare('SELECT id, name, is_active FROM majors WHERE id = ?')
      .bind(majorId)
      .first<{ id: string; name: string; is_active: number }>()
    
    if (!major) {
      return c.json({ success: false, error: 'MAJOR_NOT_FOUND' }, 404)
    }
    
    // 캐시 무효화 (먼저 실행)
    await invalidatePageCache(c.env.DB, { majorId, pageType: 'major' })
    
    if (permanent) {
      // 완전 삭제: DB에서 제거 (revisions도 함께 삭제)
      
      // R2 이미지 삭제 (image_url 조회)
      const majorWithImage = await c.env.DB.prepare('SELECT image_url FROM majors WHERE id = ?')
        .bind(majorId)
        .first<{ image_url: string | null }>()
      
      if (majorWithImage?.image_url && majorWithImage.image_url.startsWith('/uploads/') && c.env.UPLOADS) {
        const fileKey = majorWithImage.image_url.replace('/uploads/', '')
        try {
          await c.env.UPLOADS.delete(fileKey)
          console.log(`[Major Delete] R2 이미지 삭제: ${fileKey}`)
        } catch (e) {
          console.error(`[Major Delete] R2 이미지 삭제 실패: ${fileKey}`, e)
        }
      }
      
      try {
        await c.env.DB.prepare('DELETE FROM revisions WHERE entity_type = ? AND entity_id = ?')
          .bind('major', majorId)
          .run()
      } catch (e) {
        // revisions 테이블이 없어도 무시
        console.log('[Major Delete] Revisions table may not exist, skipping:', e)
      }
      
      await c.env.DB.prepare('DELETE FROM majors WHERE id = ?')
        .bind(majorId)
        .run()
      
      console.log(`[Major Permanent Delete] Major "${major.name}" (${majorId}) permanently deleted by ${user.username || user.email}`)
      
      return c.json({
        success: true,
        message: `전공 "${major.name}"이(가) 완전히 삭제되었습니다. (복구 불가)`
      })
    } else {
      // 숨기기: soft delete (is_active = 0)
      await c.env.DB.prepare('UPDATE majors SET is_active = 0, user_last_updated_at = ? WHERE id = ?')
        .bind(Date.now(), majorId)
        .run()
      
      console.log(`[Major Hide] Major "${major.name}" (${majorId}) hidden by ${user.username || user.email}`)
      
      return c.json({
        success: true,
        message: `전공 "${major.name}"이(가) 숨겨졌습니다. (관리자만 볼 수 있음)`
      })
    }
  } catch (error) {
    console.error('[Major Delete] Error:', error)
    return c.json({ success: false, error: 'DELETE_FAILED' }, 500)
  }
})

// 전공 복구 (운영자/관리자 전용) - 숨긴 전공 다시 활성화
app.post('/api/major/:id/restore', requireAuth, async (c) => {
  try {
    const majorId = c.req.param('id')
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    // 숨겨진 전공 확인
    const major = await c.env.DB.prepare('SELECT id, name, is_active FROM majors WHERE id = ?')
      .bind(majorId)
      .first<{ id: string; name: string; is_active: number }>()
    
    if (!major) {
      return c.json({ success: false, error: 'MAJOR_NOT_FOUND' }, 404)
    }
    
    if (major.is_active === 1) {
      return c.json({ success: false, error: 'ALREADY_ACTIVE' }, 400)
    }
    
    // 복구 (is_active = 1)
    await c.env.DB.prepare('UPDATE majors SET is_active = 1, user_last_updated_at = ? WHERE id = ?')
      .bind(Date.now(), majorId)
      .run()
    
    console.log(`[Major Restore] Major "${major.name}" (${majorId}) restored by ${user.username || user.email}`)
    
    return c.json({
      success: true,
      message: `전공 "${major.name}"이(가) 복구되었습니다.`
    })
  } catch (error) {
    console.error('[Major Restore] Error:', error)
    return c.json({ success: false, error: 'RESTORE_FAILED' }, 500)
  }
})

// 숨겨진 전공 목록 조회 (운영자/관리자 전용)
app.get('/api/major/hidden', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    // 운영자/관리자 권한 체크
    const role = user.role as string
    const isAdmin = role === 'super-admin' || role === 'operator' || role === 'admin'
    if (!isAdmin) {
      return c.json({ success: false, error: 'ADMIN_ONLY' }, 403)
    }
    
    const majors = await c.env.DB.prepare(`
      SELECT id, name, slug, user_last_updated_at 
      FROM majors 
      WHERE is_active = 0 
      ORDER BY user_last_updated_at DESC
    `).all<{ id: string; name: string; slug: string | null; user_last_updated_at: number }>()
    
    return c.json({
      success: true,
      majors: majors.results || []
    })
  } catch (error) {
    console.error('[Major Hidden List] Error:', error)
    return c.json({ success: false, error: 'FETCH_FAILED' }, 500)
  }
})

// 전공 생성 (일반 사용자)
app.post('/api/major/create', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const name = typeof body.name === 'string' ? body.name.trim() : ''
    const summary = typeof body.summary === 'string' ? body.summary.trim() : ''
    const heroTags = Array.isArray(body.heroTags) ? body.heroTags : []
    const categoryName = typeof body.categoryName === 'string' ? body.categoryName.trim() : ''
    
    // 필수 필드 검증
    if (!name || name.length < 2) {
      return c.json({ success: false, error: '전공명은 최소 2자 이상이어야 합니다' }, 400)
    }
    if (!summary || summary.length < 2) {
      return c.json({ success: false, error: '설명은 최소 2자 이상이어야 합니다' }, 400)
    }
    
    // ID 생성 (이름 기반 slug)
    const slug = name.replace(/[\s\-\/\.·ㆍ,()]+/g, '-').toLowerCase()
    const id = `U_${slug}_${Date.now().toString(36)}`  // U_ prefix for user-created
    
    // 중복 확인
    const existing = await c.env.DB.prepare(
      'SELECT id FROM majors WHERE name = ? AND is_active = 1'
    ).bind(name).first()
    
    if (existing) {
      return c.json({ success: false, error: '이미 존재하는 전공입니다' }, 400)
    }
    
    // user_contributed_json 데이터 구성
    const userData: Record<string, any> = {
      summary
    }
    if (heroTags.length > 0) {
      userData.heroTags = [...new Set(heroTags.filter((t: any) => typeof t === 'string' && t.trim()))]
    }
    if (categoryName) {
      userData.categoryName = categoryName
    }
    
    // merged_profile_json 생성 (페이지 렌더링에 필요)
    const mergedProfile = {
      id,
      name,
      summary,
      overview: { summary },
      heroTags: userData.heroTags || [],
      categoryName: userData.categoryName || '',
      source: 'USER' as const
    }
    
    // URL용 slug 생성
    const urlSlug = name.replace(/[\s]+/g, '-').toLowerCase()
    
    const now = Date.now()
    
    // majors 테이블에 INSERT (merged_profile_json, slug 포함)
    await c.env.DB.prepare(`
      INSERT INTO majors (id, name, slug, user_contributed_json, merged_profile_json, user_last_updated_at, created_at, is_active, primary_source)
      VALUES (?, ?, ?, ?, ?, ?, ?, 1, 'USER')
    `).bind(
      id,
      name,
      urlSlug,
      JSON.stringify(userData),
      JSON.stringify(mergedProfile),
      now,
      now
    ).run()
    
    // 초기 revision 생성
    const { createRevision } = await import('./services/revisionService')
    await createRevision(c.env.DB, {
      entityType: 'major',
      entityId: id,
      dataSnapshot: { id, name, ...userData },
      editorId: user.id.toString(),
      editorType: user.role as 'user' | 'expert' | 'admin',
      editorName: user.username || `User ${user.id}`,
      changeType: 'initial',
      changeSummary: '전공 생성',
      changedFields: Object.keys(userData),
      storeFullSnapshot: true
    })
    
    // 자동 이미지 생성 (동기 방식 - API 키가 있는 경우에만)
    let imageUrl: string | undefined
    let imagePrompt: string | undefined
    
    const geminiKey = (c.env as any).GEMINI_API_KEY
    const evolinkKey = (c.env as any).EVOLINK_API_KEY
    const uploadsR2 = (c.env as any).UPLOADS as R2Bucket | undefined
    
    if (geminiKey && evolinkKey && uploadsR2) {
      try {
        console.log(`[API] Starting auto image generation for major: ${name}`)
        const { generateMajorImage } = await import('./services/autoImageService')
        const baseUrl = new URL(c.req.url).origin
        
        const imageResult = await generateMajorImage(
          { GEMINI_API_KEY: geminiKey, EVOLINK_API_KEY: evolinkKey, UPLOADS: uploadsR2 },
          name,
          urlSlug,
          baseUrl
        )
        
        if (imageResult.success) {
          imageUrl = imageResult.imageUrl
          imagePrompt = imageResult.imagePrompt
          
          // DB 업데이트
          await c.env.DB.prepare(`
            UPDATE majors SET image_url = ?, image_prompt = ? WHERE id = ?
          `).bind(imageUrl, imagePrompt, id).run()
          
          console.log(`[API] Auto image generated for major ${name}: ${imageUrl}`)
        } else {
          // 이미지 생성 실패해도 프롬프트는 저장
          if (imageResult.imagePrompt) {
            await c.env.DB.prepare(`
              UPDATE majors SET image_prompt = ? WHERE id = ?
            `).bind(imageResult.imagePrompt, id).run()
            imagePrompt = imageResult.imagePrompt
          }
          console.warn(`[API] Auto image failed for major ${name}: ${imageResult.error}`)
        }
      } catch (imageError) {
        console.error('[API] Auto image generation error:', imageError)
        // 이미지 생성 실패해도 전공 생성은 성공으로 처리
      }
    } else {
      console.log('[API] Skipping auto image: API keys not configured')
    }
    
    return c.json({
      success: true,
      id,
      slug: urlSlug,
      imageUrl,
      imagePrompt,
      message: '전공이 생성되었습니다'
    }, 201)
    
  } catch (error) {
    console.error('[API] Create major error:', error)
    const message = error instanceof Error ? error.message : 'create failed'
    return c.json({ success: false, error: message }, 500)
  }
})

// 직업 생성 (관리자 전용)
app.post('/api/admin/job', requireAdmin, async (c) => {
  try {
    const user = c.get('user')
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const id = typeof body.id === 'string' ? body.id.trim() : ''
    const name = typeof body.name === 'string' ? body.name.trim() : ''
    const summary = typeof body.summary === 'string' ? body.summary : undefined
    const duties = typeof body.duties === 'string' ? body.duties : undefined
    const salary = typeof body.salary === 'string' ? body.salary : undefined
    const prospect = typeof body.prospect === 'string' ? body.prospect : undefined
    const way = typeof body.way === 'string' ? body.way : undefined
    
    if (!id) {
      return c.json({ success: false, error: 'id is required' }, 400)
    }
    if (!name) {
      return c.json({ success: false, error: 'name is required' }, 400)
    }
    
    const result = await createJob(c.env.DB, {
      id,
      name,
      summary,
      duties,
      salary,
      prospect,
      way,
      userId: user.id.toString()
    })
    
    return c.json({
      success: true,
      id: result.id,
      revisionId: result.revisionId,
      message: 'Job created successfully'
    }, 201)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'create failed'
    console.error('[admin job create] Error:', error)
    
    const status = message.includes('REQUIRED') ? 400
      : message.includes('ALREADY_EXISTS') ? 409
      : message.includes('LOGIN') ? 401
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// 전공 생성 (관리자 전용)
app.post('/api/admin/major', requireAdmin, async (c) => {
  try {
    const user = c.get('user')
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const id = typeof body.id === 'string' ? body.id.trim() : ''
    const name = typeof body.name === 'string' ? body.name.trim() : ''
    const summary = typeof body.summary === 'string' ? body.summary : undefined
    const property = typeof body.property === 'string' ? body.property : undefined
    const aptitude = typeof body.aptitude === 'string' ? body.aptitude : undefined
    const whatStudy = typeof body.whatStudy === 'string' ? body.whatStudy : undefined
    const howPrepare = typeof body.howPrepare === 'string' ? body.howPrepare : undefined
    const enterField = typeof body.enterField === 'string' ? body.enterField : undefined
    
    if (!id) {
      return c.json({ success: false, error: 'id is required' }, 400)
    }
    if (!name) {
      return c.json({ success: false, error: 'name is required' }, 400)
    }
    
    const result = await createMajor(c.env.DB, {
      id,
      name,
      summary,
      property,
      aptitude,
      whatStudy,
      howPrepare,
      enterField,
      userId: user.id.toString()
    })
    
    return c.json({
      success: true,
      id: result.id,
      revisionId: result.revisionId,
      message: 'Major created successfully'
    }, 201)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'create failed'
    console.error('[admin major create] Error:', error)
    
    const status = message.includes('REQUIRED') ? 400
      : message.includes('ALREADY_EXISTS') ? 409
      : message.includes('LOGIN') ? 401
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// 전공 편집 (단일 필드 또는 다중 필드 지원)
app.post('/api/major/:id/edit', requireJobMajorEdit, async (c) => {
  try {
    const majorIdParam = c.req.param('id')
    const user = getOptionalUser(c)
    let body: any
    
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    // IP 해시 생성
    const ipAddress = c.req.header('cf-connecting-ip') ?? null
    const ipHash = await hashIpAddress(ipAddress)
    
    // 실제 DB ID로 변환 (공통 로직)
    let majorId = majorIdParam
    let majorRecord = await c.env.DB.prepare('SELECT * FROM majors WHERE id = ? AND is_active = 1')
      .bind(majorId)
      .first()
    
    // ID로 찾지 못한 경우 slug로 시도
    if (!majorRecord) {
      let extractedId = majorId
      if (majorId.includes(':')) {
        const parts = majorId.split(':')
        if (parts.length > 1) {
          extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
          majorRecord = await c.env.DB.prepare('SELECT * FROM majors WHERE id = ? AND is_active = 1')
            .bind(extractedId)
            .first()
          if (majorRecord) majorId = extractedId
        }
      }
      
      if (!majorRecord) {
        const decodedSlug = decodeURIComponent(majorId)
        const normalizedSlug = decodedSlug.toLowerCase()
        
        majorRecord = await c.env.DB.prepare(
          'SELECT * FROM majors WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first()
        
        if (!majorRecord) {
          majorRecord = await c.env.DB.prepare(
            'SELECT * FROM majors WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first()
        }
        
        if (!majorRecord) {
          majorRecord = await c.env.DB.prepare(
            'SELECT * FROM majors WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(decodedSlug).first()
        }
        
        if (majorRecord) majorId = majorRecord.id as string
      }
    }
    
    if (!majorRecord) {
      console.error(`[major edit] Major not found. Searched with: ${majorIdParam}`)
      return c.json({ success: false, error: 'MAJOR_NOT_FOUND' }, 404)
    }
    
    // 다중 필드 편집 (새로운 방식)
    if (body.fields && typeof body.fields === 'object') {
      const fields = body.fields as Record<string, any>
      const sources = body.sources as Record<string, { url?: string; text?: string; delete?: boolean }> | undefined
      const changeSummary = typeof body.changeSummary === 'string' ? body.changeSummary : undefined
      
      if (Object.keys(fields).length === 0) {
        return c.json({ success: false, error: 'No fields to update' }, 400)
      }
      
      // 길이 검증 (최대 길이만 체크, 최소 길이는 체크하지 않음 - 빈 필드도 허용)
      for (const [key, value] of Object.entries(fields)) {
        if (typeof value === 'string' && value.length > 7000) {
          return c.json({ success: false, error: `${key}: 최대 7000자까지 입력 가능합니다` }, 400)
        }
      }
      
      // 출처는 URL이 아니어도 됨 (텍스트 출처 허용)
      // URL 검증 제거됨
      
      // 기존 user_contributed_json 파싱
      let userData: Record<string, any> = {}
      try {
        userData = majorRecord.user_contributed_json ? JSON.parse(majorRecord.user_contributed_json as string) : {}
      } catch { userData = {} }
      
      // 중첩 필드 처리
      const flattenToNested = (flatFields: Record<string, any>): Record<string, any> => {
        const result: Record<string, any> = {}
        for (const [key, value] of Object.entries(flatFields)) {
          const parts = key.split('.')
          let current = result
          for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) current[parts[i]] = {}
            current = current[parts[i]]
          }
          current[parts[parts.length - 1]] = value
        }
        return result
      }
      // 기존 데이터와 병합
      const nestedFields = flattenToNested(fields)
      const deepMerge = (target: any, source: any): any => {
        for (const key of Object.keys(source)) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            target[key] = deepMerge(target[key] || {}, source[key])
          } else {
            target[key] = source[key]
          }
        }
        return target
      }
      const updatedUserData = deepMerge({ ...userData }, nestedFields)
      // trivia가 저장될 때 기존 jobProspect 제거 (여담/진로전망 분리)
      if (nestedFields.trivia && updatedUserData.jobProspect) {
        delete updatedUserData.jobProspect
      }

      // 변경 전 값 저장 (비교 기능용)
      const previousValues: Record<string, any> = {}
      for (const key of Object.keys(fields)) {
        const parts = key.split('.')
        let value: any = userData
        for (const part of parts) {
          value = value?.[part]
        }
        previousValues[key] = value ?? null
      }
      
      // 출처 데이터 저장 (URL 또는 텍스트) - 여러 개 지원
      if (sources && Object.keys(sources).length > 0) {
        updatedUserData._sources = updatedUserData._sources || {}
        // 기존 _sources에서 최대 id 추출 (배열/객체 모두 대응)
        const existingIds: number[] = []
        Object.values(updatedUserData._sources).forEach((val: any) => {
          if (Array.isArray(val)) {
            val.forEach(v => v?.id && existingIds.push(v.id))
          } else if (val?.id) {
            existingIds.push(val.id)
          }
        })
        let nextId = Math.max(0, ...existingIds) + 1

        for (const [key, source] of Object.entries(sources)) {
          if ((source as any)?.delete) {
            delete updatedUserData._sources[key]
            continue
          }

          // 배열 형태로 수신 (여러 개)
          const sourceArray = Array.isArray(source)
            ? source
            : [source]
          const normalized = sourceArray
            .map((s: any) => (s?.text || s?.url || '').trim())
            .filter(Boolean)
            .map(text => ({ id: nextId++, text }))

          if (normalized.length > 0) {
            updatedUserData._sources[key] = normalized
          }
        }
      }
      
      // _sources가 비어있으면 삭제
      if (updatedUserData._sources && Object.keys(updatedUserData._sources).length === 0) {
        delete updatedUserData._sources
      }
      
      const now = Date.now()
      
      // merged_profile_json 업데이트 (user_contributed_json과 병합)
      let currentMerged: any = {}
      try {
        currentMerged = majorRecord.merged_profile_json ? JSON.parse(majorRecord.merged_profile_json as string) : {}
      } catch { /* ignore */ }
      
      // _sources는 통째로 덮어쓰기 (삭제 반영을 위해)
      if (currentMerged._sources) {
        delete currentMerged._sources
      }
      
      // 깊은 병합 함수
      const deepMergeForUpdate = (target: any, source: any): any => {
        if (!source) return target
        if (!target) return source
        const result = { ...target }
        for (const key of Object.keys(source)) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            result[key] = deepMergeForUpdate(result[key] || {}, source[key])
          } else if (source[key] !== undefined) {
            result[key] = source[key]
          }
        }
        return result
      }
      
      const updatedMerged = deepMergeForUpdate(currentMerged, updatedUserData)
      
      // trivia가 있으면 merged에서도 jobProspect 제거 (여담/진로전망 분리)
      if (updatedUserData.trivia && updatedMerged.jobProspect) {
        delete updatedMerged.jobProspect
      }
      
      // DB 업데이트 (merged_profile_json도 함께 업데이트)
      await c.env.DB.prepare(`
        UPDATE majors SET user_contributed_json = ?, merged_profile_json = ?, user_last_updated_at = ?
        WHERE id = ?
      `).bind(JSON.stringify(updatedUserData), JSON.stringify(updatedMerged), now, majorId).run()
      
      // Revision 생성
      const { createRevision, getCurrentRevision } = await import('./services/revisionService')
      
      // 기존 리비전이 없으면 원본 상태를 r1으로 먼저 저장 (전체 스냅샷)
      const existingRevision = await getCurrentRevision(c.env.DB, 'major', majorId)
      if (!existingRevision) {
        const originalSnapshot = currentMerged || {}
        // 원본 상태를 r1으로 저장 (편집 전 상태, 전체 스냅샷)
        await createRevision(c.env.DB, {
          entityType: 'major',
          entityId: majorId,
          dataSnapshot: originalSnapshot,  // 편집 전 전체 값
          previousValues: {},
          editorId: null,
          editorType: 'system',
          editorName: '원본',
          ipHash: null,
          changeType: 'initial',
          changeSummary: '원본 버전',
          changedFields: Object.keys(originalSnapshot),
          storeFullSnapshot: true
        })
      }
      
      const revision = await createRevision(c.env.DB, {
        entityType: 'major',
        entityId: majorId,
        dataSnapshot: updatedMerged,  // 변경 후 전체 값
        previousValues,  // 변경 전 값 (변경된 필드만)
        editorId: user?.id?.toString() ?? null,
        editorType: (['user', 'expert', 'admin'].includes(user?.role || '') ? user?.role : 'anonymous') as 'user' | 'expert' | 'admin' | 'anonymous',
        editorName: user?.username ?? (ipHash ? `익명` : '익명 사용자'),
        ipHash: ipHash ?? null,
        changeType: 'edit',
        changeSummary: `${Object.keys(fields).length}개 필드 수정`,
        changedFields: Object.keys(fields),
        storeFullSnapshot: true
      })
      
      // 캐시 무효화
      await invalidatePageCache(c.env.DB, { majorId, pageType: 'major' })
      
      return c.json({
        success: true,
        revisionId: revision.id,
        message: 'Edit saved successfully'
      })
    }
    
    // 단일 필드 편집 (기존 방식 호환)
    const field = typeof body.field === 'string' ? body.field : ''
    const content = typeof body.content === 'string' ? body.content : ''
    const source = typeof body.source === 'string' ? body.source : ''
    const changeSummary = typeof body.changeSummary === 'string' ? body.changeSummary : undefined
    const anonymous = Boolean(body.anonymous)
    const password = typeof body.password === 'string' ? body.password : undefined
    
    // 필수 필드 검증
    if (!field || !content) {
      return c.json({ success: false, error: 'field and content are required' }, 400)
    }
    
    // 출처는 URL이 아니어도 됨 (텍스트 출처 허용)
    
    const result = await editMajor(c.env.DB, majorId, {
      field,
      content,
      source,
      changeSummary,
      anonymous,
      password,
      ipHash: ipHash ?? undefined,
      userId: user?.id?.toString(),
      editorType: user?.role as 'user' | 'expert' | 'admin' | undefined
    })
    
    await invalidatePageCache(c.env.DB, {
      majorId: majorId,
      pageType: 'major'
    })
    
    return c.json({
      success: true,
      revisionId: result.revisionId,
      message: 'Edit saved successfully'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'edit failed'
    console.error(`[major edit] Error:`, error)
    const status = message.includes('NOT_FOUND') ? 404 
      : message.includes('REQUIRED') || message.includes('INVALID') ? 400
      : message.includes('LIMIT') ? 403
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// HowTo 생성 (로그인 필수)
app.post('/api/howto', requireAuth, async (c) => {
  try {
    const user = c.get('user')
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const title = typeof body.title === 'string' ? body.title.trim() : ''
    const slug = typeof body.slug === 'string' ? body.slug.trim() : ''
    const summary = typeof body.summary === 'string' ? body.summary.trim() : ''
    const content = typeof body.content === 'string' ? body.content : ''
    
    // 필수 필드 검증
    if (!title) {
      return c.json({ success: false, error: 'title is required' }, 400)
    }
    if (!slug) {
      return c.json({ success: false, error: 'slug is required' }, 400)
    }
    if (!summary) {
      return c.json({ success: false, error: 'summary is required' }, 400)
    }
    if (!content) {
      return c.json({ success: false, error: 'content is required' }, 400)
    }
    
    const result = await createHowTo(c.env.DB, {
      title,
      slug,
      summary,
      content,
      userId: user.id.toString(),
      editorType: user.role as 'user' | 'expert' | 'admin'
    })
    
    return c.json({
      success: true,
      slug: result.slug,
      revisionId: result.revisionId,
      message: 'HowTo created successfully'
    }, 201)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'create failed'
    console.error('[howto create] Error:', error)
    
    const status = message.includes('REQUIRED') ? 400
      : message.includes('INVALID') ? 400
      : message.includes('ALREADY_EXISTS') ? 409
      : message.includes('LOGIN') ? 401
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// HowTo 편집 (로그인 필수, 본인 글만 - admin 제외)
app.post('/api/howto/:slug/edit', requireHowToEdit, async (c) => {
  try {
    const slug = c.req.param('slug')
    const user = c.get('user')  // requireHowToEdit에서 이미 로그인 확인됨
    
    if (!user) {
      return c.json({ success: false, error: 'LOGIN_REQUIRED' }, 401)
    }
    
    let body: any
    try {
      body = await c.req.json()
    } catch {
      return c.json({ success: false, error: 'invalid json body' }, 400)
    }
    
    const content = typeof body.content === 'string' ? body.content : ''
    const source = typeof body.source === 'string' ? body.source : undefined
    const changeSummary = typeof body.changeSummary === 'string' ? body.changeSummary : undefined
    
    if (!content) {
      return c.json({ success: false, error: 'content is required' }, 400)
    }
    
    const result = await editHowTo(c.env.DB, slug, {
      content,
      source,
      changeSummary,
      userId: user.id.toString(),
      editorType: user.role as 'user' | 'expert' | 'admin'
    })
    
    await invalidatePageCache(c.env.DB, {
      slug,
      pageType: 'guide'
    })
    
    return c.json({
      success: true,
      revisionId: result.revisionId,
      message: 'Edit saved successfully'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'edit failed'
    console.error('[howto edit] Error:', error)
    
    const status = message.includes('NOT_FOUND') ? 404 
      : message.includes('NOT_AUTHOR') ? 403
      : message.includes('LOGIN_REQUIRED') ? 401
      : message.includes('REQUIRED') || message.includes('INVALID') ? 400
      : message.includes('LIMIT') ? 403
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// =====================================================
// 슬러그 API
// =====================================================

// 슬러그 생성 및 중복 체크
app.get('/api/slug/check', authMiddleware, async (c) => {
  try {
    const title = c.req.query('title')
    const excludeId = c.req.query('excludeId')
    
    if (!title) {
      return c.json({ success: false, error: 'title 파라미터가 필요합니다' }, 400)
    }
    
    const { checkAndGenerateUniqueSlug, generateSlug } = await import('./services/slugService')
    
    // 슬러그 생성
    const baseSlug = generateSlug(title)
    
    // 중복 체크
    const result = await checkAndGenerateUniqueSlug(
      c.env.DB, 
      title, 
      excludeId ? parseInt(excludeId) : undefined
    )
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 400)
    }
    
    return c.json({
      success: true,
      baseSlug,
      slug: result.slug,
      isUnique: result.isUnique,
      hasSuffix: result.slug !== baseSlug
    })
  } catch (error) {
    console.error('[slug check] Error:', error)
    return c.json({ success: false, error: '슬러그 생성 중 오류가 발생했습니다' }, 500)
  }
})

// 슬러그 유효성 검증
app.get('/api/slug/validate', authMiddleware, async (c) => {
  try {
    const slug = c.req.query('slug')
    
    if (!slug) {
      return c.json({ success: false, error: 'slug 파라미터가 필요합니다' }, 400)
    }
    
    const { validateSlug } = await import('./services/slugService')
    const result = validateSlug(slug)
    
    return c.json({ success: true, valid: result.valid, error: result.error })
  } catch (error) {
    console.error('[slug validate] Error:', error)
    return c.json({ success: false, error: '검증 중 오류가 발생했습니다' }, 500)
  }
})

// =====================================================
// 통합 검색 API (자동완성)
// =====================================================

// 통합 검색 (domain: jobs, majors, howtos, tags)
app.get('/api/search', authMiddleware, async (c) => {
  try {
    const domain = c.req.query('domain') as 'jobs' | 'majors' | 'howtos' | 'tags'
    const query = c.req.query('q') || ''
    const limit = parseInt(c.req.query('limit') || '10')
    const typeahead = c.req.query('typeahead') !== 'false'
    
    if (!domain || !['jobs', 'majors', 'howtos', 'tags'].includes(domain)) {
      return c.json({ success: false, error: 'domain 파라미터가 필요합니다 (jobs, majors, howtos, tags)' }, 400)
    }
    
    const { search } = await import('./services/searchService')
    const result = await search(c.env.DB, { domain, query, limit, typeahead })
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 500)
    }
    
    return c.json({ success: true, results: result.results })
  } catch (error) {
    console.error('[search] Error:', error)
    return c.json({ success: false, error: '검색 중 오류가 발생했습니다' }, 500)
  }
})

// 존재 검증 (선택 강제형)
app.get('/api/search/validate', authMiddleware, async (c) => {
  try {
    const domain = c.req.query('domain') as 'jobs' | 'majors' | 'howtos' | 'tags'
    const id = c.req.query('id')
    
    if (!domain || !id) {
      return c.json({ success: false, error: 'domain과 id 파라미터가 필요합니다' }, 400)
    }
    
    const { validateExists } = await import('./services/searchService')
    const result = await validateExists(c.env.DB, domain, id)
    
    return c.json({ success: true, exists: result.exists, data: result.data })
  } catch (error) {
    console.error('[validate] Error:', error)
    return c.json({ success: false, error: '검증 중 오류가 발생했습니다' }, 500)
  }
})

// 인기 태그
app.get('/api/tags/popular', async (c) => {
  try {
    const limit = parseInt(c.req.query('limit') || '20')
    
    const { getPopularTags } = await import('./services/searchService')
    const result = await getPopularTags(c.env.DB, limit)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 500)
    }
    
    return c.json({ success: true, tags: result.tags })
  } catch (error) {
    console.error('[popular tags] Error:', error)
    return c.json({ success: false, error: '태그 조회 중 오류가 발생했습니다' }, 500)
  }
})

// =====================================================
// 초안 API (HowTo Editor)
// =====================================================

// 새 초안 생성
app.post('/api/howto/drafts', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const body = await c.req.json()
    
    const { createDraft, updateDraft } = await import('./services/draftService')
    const result = await createDraft(c.env.DB, {
      userId: user.id,
      baseHowtoId: body.baseHowtoId,
      title: body.title,
      slug: body.slug,
      summary: body.summary,
      thumbnailUrl: body.thumbnailUrl,
      contentJson: body.contentJson,
      contentHtml: body.contentHtml
    })
    
    if (!result.success || !result.draftId) {
      return c.json({ success: false, error: result.error }, 400)
    }
    
    // 관련 항목들 저장 (태그, 관련 직업/전공/HowTo)
    const draftId = result.draftId
    const tags = body.tags || []
    const relatedJobs = body.relatedJobs || []
    const relatedMajors = body.relatedMajors || []
    const relatedHowtos = body.relatedHowtos || []
    
    // 태그 저장
    for (const tagName of tags) {
      if (!tagName || !String(tagName).trim()) continue
      const trimmed = String(tagName).trim()
      
      let tag = await c.env.DB.prepare(`SELECT id FROM tags WHERE name = ?`).bind(trimmed).first<{ id: number }>()
      if (!tag) {
        const tagSlug = trimmed.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9가-힣-]/g, '')
        const tagResult = await c.env.DB.prepare(`INSERT INTO tags (name, slug) VALUES (?, ?)`).bind(trimmed, tagSlug).run()
        tag = { id: Number(tagResult.meta.last_row_id) }
      }
      await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_tags (draft_id, tag_id) VALUES (?, ?)`).bind(draftId, tag.id).run()
    }
    
    // 관련 직업 저장
    for (let i = 0; i < relatedJobs.length; i++) {
      const job = relatedJobs[i]
      const jobId = job.id || job.slug || job.name
      if (jobId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_jobs (draft_id, job_id, display_order) VALUES (?, ?, ?)`).bind(draftId, String(jobId), i).run()
      }
    }
    
    // 관련 전공 저장
    for (let i = 0; i < relatedMajors.length; i++) {
      const major = relatedMajors[i]
      const majorId = major.id || major.slug || major.name
      if (majorId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_majors (draft_id, major_id, display_order) VALUES (?, ?, ?)`).bind(draftId, String(majorId), i).run()
      }
    }
    
    // 관련 HowTo 저장
    for (let i = 0; i < relatedHowtos.length; i++) {
      const howto = relatedHowtos[i]
      const howtoId = howto.id || howto.slug || howto.name
      if (howtoId) {
        await c.env.DB.prepare(`INSERT OR IGNORE INTO draft_related_howtos (draft_id, howto_id, display_order) VALUES (?, ?, ?)`).bind(draftId, String(howtoId), i).run()
      }
    }
    
    return c.json({ success: true, draftId: draftId }, 201)
  } catch (error) {
    console.error('[create draft] Error:', error)
    return c.json({ success: false, error: '초안 생성 중 오류가 발생했습니다' }, 500)
  }
})

// 제목 중복 체크
app.get('/api/howto/check-title', async (c) => {
  try {
    const title = c.req.query('title')?.trim()
    const excludeId = c.req.query('excludeId')
    
    if (!title) {
      return c.json({ success: false, error: '제목이 필요합니다' }, 400)
    }
    
    if (title.length < 2) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: '제목은 최소 2자 이상이어야 합니다' 
      })
    }
    
    // 정확히 같은 제목이 있는지 확인 (대소문자 무시)
    let query = `
      SELECT id, title FROM pages 
      WHERE page_type = 'guide' 
        AND status IN ('published', 'draft_published')
        AND LOWER(title) = LOWER(?)
    `
    const bindings: any[] = [title]
    
    if (excludeId) {
      query += ` AND id != ?`
      bindings.push(parseInt(excludeId))
    }
    
    query += ` LIMIT 1`
    
    const existing = await c.env.DB.prepare(query).bind(...bindings).first<{ id: number; title: string }>()
    
    if (existing) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: `이미 같은 제목의 가이드가 존재합니다` 
      })
    }
    
    return c.json({ success: true, available: true })
  } catch (error) {
    console.error('[check-title] Error:', error)
    return c.json({ success: false, error: '제목 확인 중 오류가 발생했습니다' }, 500)
  }
})

// 직업 분류 목록 조회
app.get('/api/job/categories', async (c) => {
  try {
    const q = c.req.query('q')?.trim().toLowerCase() || ''
    const limit = parseInt(c.req.query('limit') || '20')
    
    // 직업 분류 목록 (실제 데이터에서 추출)
    // heroCategory, category, jobType 등에서 추출
    let query = `
      SELECT DISTINCT 
        COALESCE(
          JSON_EXTRACT(user_contributed_json, '$.heroCategory'),
          JSON_EXTRACT(admin_data_json, '$.heroCategory'),
          JSON_EXTRACT(api_data_json, '$.category'),
          JSON_EXTRACT(api_data_json, '$.jobType')
        ) as category
      FROM jobs
      WHERE is_active = 1
        AND category IS NOT NULL
        AND category != ''
    `
    
    if (q) {
      query += ` AND LOWER(category) LIKE '%' || ? || '%'`
    }
    
    query += ` ORDER BY category LIMIT ?`
    
    const bindings = q ? [q, limit] : [limit]
    const result = await c.env.DB.prepare(query).bind(...bindings).all<{ category: string }>()
    
    const categories = result.results
      ?.map(r => r.category)
      .filter(c => c && c.trim()) || []
    
    // 기본 분류 목록 추가 (검색어와 매칭되는 것만)
    const defaultCategories = [
      '경영/사무', '영업/마케팅', '연구개발', 'IT/소프트웨어', '디자인', 
      '미디어/콘텐츠', '교육', '의료/보건', '법률/법무', '금융/보험',
      '건설/토목', '제조/생산', '물류/유통', '서비스', '예술/문화',
      '스포츠/레저', '농림어업', '공무원', '군인/경찰', '기타'
    ]
    
    const filtered = q 
      ? defaultCategories.filter(c => c.toLowerCase().includes(q))
      : defaultCategories
    
    // 기존 데이터와 기본 목록 병합 (중복 제거)
    const allCategories = [...new Set([...categories, ...filtered])].slice(0, limit)
    
    return c.json({ success: true, categories: allCategories })
  } catch (error) {
    console.error('[job-categories] Error:', error)
    return c.json({ success: true, categories: [] })
  }
})

// 전공 계열 목록 조회
app.get('/api/major/categories', async (c) => {
  try {
    const q = c.req.query('q')?.trim().toLowerCase() || ''
    const limit = parseInt(c.req.query('limit') || '20')
    
    // 전공 계열 목록 (실제 데이터에서 추출)
    let query = `
      SELECT DISTINCT 
        COALESCE(
          JSON_EXTRACT(user_contributed_json, '$.categoryName'),
          JSON_EXTRACT(admin_data_json, '$.categoryName'),
          JSON_EXTRACT(api_data_json, '$.facilMajorCategory')
        ) as category
      FROM majors
      WHERE is_active = 1
        AND category IS NOT NULL
        AND category != ''
    `
    
    if (q) {
      query += ` AND LOWER(category) LIKE '%' || ? || '%'`
    }
    
    query += ` ORDER BY category LIMIT ?`
    
    const bindings = q ? [q, limit] : [limit]
    const result = await c.env.DB.prepare(query).bind(...bindings).all<{ category: string }>()
    
    const categories = result.results
      ?.map(r => r.category)
      .filter(c => c && c.trim()) || []
    
    // 기본 계열 목록 추가 (검색어와 매칭되는 것만)
    const defaultCategories = [
      '인문계열', '사회계열', '교육계열', '공학계열', '자연계열',
      '의약계열', '예체능계열', '농림수산계열'
    ]
    
    const filtered = q 
      ? defaultCategories.filter(c => c.toLowerCase().includes(q))
      : defaultCategories
    
    // 기존 데이터와 기본 목록 병합 (중복 제거)
    const allCategories = [...new Set([...categories, ...filtered])].slice(0, limit)
    
    return c.json({ success: true, categories: allCategories })
  } catch (error) {
    console.error('[major-categories] Error:', error)
    return c.json({ success: true, categories: [] })
  }
})

// 직업 이름 중복 체크
app.get('/api/job/check-name', async (c) => {
  try {
    const name = c.req.query('name')?.trim()
    
    if (!name) {
      return c.json({ success: false, error: '직업명이 필요합니다' }, 400)
    }
    
    if (name.length < 2) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: '직업명은 최소 2자 이상이어야 합니다' 
      })
    }
    
    // 정확히 같은 이름이 있는지 확인 (대소문자 무시)
    const existing = await c.env.DB.prepare(`
      SELECT id, name FROM jobs 
      WHERE LOWER(name) = LOWER(?) AND is_active = 1
      LIMIT 1
    `).bind(name).first<{ id: string; name: string }>()
    
    if (existing) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: `이미 같은 이름의 직업이 존재합니다: "${existing.name}"`,
        existingId: existing.id,
        existingName: existing.name
      })
    }
    
    return c.json({ success: true, available: true })
  } catch (error) {
    console.error('[check-job-name] Error:', error)
    return c.json({ success: false, error: '직업명 확인 중 오류가 발생했습니다' }, 500)
  }
})

// 전공 이름 중복 체크
app.get('/api/major/check-name', async (c) => {
  try {
    const name = c.req.query('name')?.trim()
    
    if (!name) {
      return c.json({ success: false, error: '전공명이 필요합니다' }, 400)
    }
    
    if (name.length < 2) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: '전공명은 최소 2자 이상이어야 합니다' 
      })
    }
    
    // 정확히 같은 이름이 있는지 확인 (대소문자 무시)
    const existing = await c.env.DB.prepare(`
      SELECT id, name FROM majors 
      WHERE LOWER(name) = LOWER(?) AND is_active = 1
      LIMIT 1
    `).bind(name).first<{ id: string; name: string }>()
    
    if (existing) {
      return c.json({ 
        success: true, 
        available: false, 
        reason: `이미 같은 이름의 전공이 존재합니다: "${existing.name}"`,
        existingId: existing.id,
        existingName: existing.name
      })
    }
    
    return c.json({ success: true, available: true })
  } catch (error) {
    console.error('[check-major-name] Error:', error)
    return c.json({ success: false, error: '전공명 확인 중 오류가 발생했습니다' }, 500)
  }
})

// 내 초안 목록
app.get('/api/howto/drafts', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')
    const stage = c.req.query('stage')
    
    const { listMyDrafts } = await import('./services/draftService')
    const result = await listMyDrafts(c.env.DB, user.id, { limit, offset, stage })
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 500)
    }
    
    return c.json({ success: true, drafts: result.drafts, total: result.total })
  } catch (error) {
    console.error('[list drafts] Error:', error)
    return c.json({ success: false, error: '초안 목록 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 초안 조회
app.get('/api/howto/drafts/:id', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    const { getDraft } = await import('./services/draftService')
    const result = await getDraft(c.env.DB, draftId, user.id)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 404)
    }
    
    return c.json({ success: true, draft: result.draft })
  } catch (error) {
    console.error('[get draft] Error:', error)
    return c.json({ success: false, error: '초안 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 초안 업데이트 (낙관적 락)
app.put('/api/howto/drafts/:id', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    const ifMatch = c.req.header('If-Match')
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    // 버전 헤더 필수
    if (!ifMatch) {
      return c.json({ success: false, error: 'If-Match 헤더가 필요합니다 (버전 관리)' }, 428)
    }
    
    const expectedVersion = parseInt(ifMatch)
    if (!Number.isFinite(expectedVersion)) {
      return c.json({ success: false, error: '유효하지 않은 버전입니다' }, 400)
    }
    
    const body = await c.req.json()
    
    const { updateDraft } = await import('./services/draftService')
    const result = await updateDraft(c.env.DB, draftId, user.id, expectedVersion, {
      title: body.title,
      slug: body.slug,
      summary: body.summary,
      thumbnailUrl: body.thumbnailUrl,
      contentJson: body.contentJson,
      contentHtml: body.contentHtml,
      tags: body.tags,
      relatedJobs: body.relatedJobs,
      relatedMajors: body.relatedMajors,
      relatedHowtos: body.relatedHowtos
    })
    
    if (!result.success) {
      // 버전 충돌
      if (result.error === 'VERSION_CONFLICT') {
        return c.json({ 
          success: false, 
          error: '버전 충돌이 발생했습니다. 다른 곳에서 수정되었습니다.',
          serverVersion: result.serverVersion 
        }, 409)
      }
      return c.json({ success: false, error: result.error }, 400)
    }
    
    return c.json({ success: true, version: result.newVersion })
  } catch (error) {
    console.error('[update draft] Error:', error)
    return c.json({ success: false, error: '초안 업데이트 중 오류가 발생했습니다' }, 500)
  }
})

// 초안 삭제
app.delete('/api/howto/drafts/:id', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    // 삭제 전 초안 데이터 조회 (이미지 삭제용)
    const draft = await c.env.DB.prepare(`
      SELECT thumbnail_url, content_html FROM howto_drafts WHERE id = ? AND user_id = ?
    `).bind(draftId, user.id).first<{ thumbnail_url: string | null; content_html: string | null }>()
    
    if (!draft) {
      return c.json({ success: false, error: '초안을 찾을 수 없거나 삭제 권한이 없습니다' }, 404)
    }
    
    // R2 이미지 삭제 (본문 이미지 + 썸네일)
    const imageKeysToDelete: string[] = []
    
    // 1) 본문에서 /uploads/ 경로 이미지 추출
    if (draft.content_html) {
      const uploadMatches = draft.content_html.match(/\/uploads\/[^\s"'<>]+/g) || []
      for (const match of uploadMatches) {
        const key = match.replace('/uploads/', '')
        if (key && !imageKeysToDelete.includes(key)) {
          imageKeysToDelete.push(key)
        }
      }
    }
    
    // 2) 썸네일 URL 추출
    if (draft.thumbnail_url && draft.thumbnail_url.startsWith('/uploads/')) {
      const key = draft.thumbnail_url.replace('/uploads/', '')
      if (key && !imageKeysToDelete.includes(key)) {
        imageKeysToDelete.push(key)
      }
    }
    
    // R2에서 이미지 삭제 (실패해도 D1 삭제는 진행)
    if (imageKeysToDelete.length > 0 && c.env.UPLOADS) {
      for (const key of imageKeysToDelete) {
        try {
          await c.env.UPLOADS.delete(key)
          console.log(`[delete draft] R2 이미지 삭제: ${key}`)
        } catch (e) {
          console.error(`[delete draft] R2 이미지 삭제 실패: ${key}`, e)
        }
      }
    }
    
    // D1에서 초안 삭제
    const { deleteDraft } = await import('./services/draftService')
    const result = await deleteDraft(c.env.DB, draftId, user.id)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 404)
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('[delete draft] Error:', error)
    return c.json({ success: false, error: '초안 삭제 중 오류가 발생했습니다' }, 500)
  }
})

// 검수 요청 (레거시 - 사용 안함)
app.post('/api/howto/drafts/:id/submit', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    const { submitForReview } = await import('./services/draftService')
    const result = await submitForReview(c.env.DB, draftId, user.id)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 400)
    }
    
    return c.json({ success: true, message: '검수 요청이 완료되었습니다' })
  } catch (error) {
    console.error('[submit draft] Error:', error)
    return c.json({ success: false, error: '검수 요청 중 오류가 발생했습니다' }, 500)
  }
})

// 바로 발행 API (새 글 작성에서 바로 published 상태로)
app.post('/api/howto/publish-direct', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const body = await c.req.json()
    
    // 사용자 ID 필수 체크 (고아 데이터 방지)
    if (!user || !user.id) {
      console.error('[publish-direct] Error: user.id is missing', user)
      return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
    }
    
    const { draftId, title, summary, contentJson, contentHtml, tags, relatedJobs, relatedMajors, relatedHowtos, thumbnailUrl } = body
    
    // 필수 필드 체크
    if (!title || !title.trim()) {
      return c.json({ success: false, error: '제목을 입력해주세요' }, 400)
    }
    if (!contentJson || contentJson === '{}') {
      return c.json({ success: false, error: '본문을 입력해주세요' }, 400)
    }
    
    const now = new Date().toISOString()
    
    // draft가 있으면 기존 페이지 확인
    let existingPageId: number | null = null
    let existingSlug: string | null = null
    
    console.log('[publish-direct] Input:', { draftId, title, userId: user.id })
    
    if (draftId) {
      const draftInfo = await c.env.DB.prepare(`
        SELECT published_page_id, slug FROM howto_drafts WHERE id = ? AND user_id = ?
      `).bind(draftId, user.id).first<{ published_page_id: number | null; slug: string | null }>()
      
      console.log('[publish-direct] Draft info:', draftInfo)
      
      if (draftInfo?.published_page_id) {
        existingPageId = draftInfo.published_page_id
        existingSlug = draftInfo.slug
      }
    }
    
    console.log('[publish-direct] existingPageId:', existingPageId, 'existingSlug:', existingSlug)
    
    // HTML 생성 (Tiptap JSON → HTML)
    let finalContentHtml = contentHtml || ''
    let footnotes: Array<{ id: number; text: string; url?: string }> = []
    let firstImageUrl = ''
    try {
      const contentObj = JSON.parse(contentJson)
      finalContentHtml = convertTiptapToHtml(contentObj)
      footnotes = extractFootnotes(contentObj)
      firstImageUrl = extractFirstImage(contentObj)
    } catch {}
    
    const finalThumbnail = thumbnailUrl || firstImageUrl || ''
    
    // meta_data 구성
    const metaData = JSON.stringify({
      contentJson,
      tags: tags || [],
      relatedJobs: relatedJobs || [],
      relatedMajors: relatedMajors || [],
      relatedHowtos: relatedHowtos || [],
      footnotes,
      authorName: user.username || user.email?.split('@')[0] || '작성자',
      thumbnailUrl: finalThumbnail
    })
    
    let pageId: number | null = null
    let slug: string
    
    // 슬러그는 항상 제목에서 새로 생성 (corrupted slug 방지)
    const { generateSlug } = await import('./services/slugService')
    let baseSlug = cleanGuidePrefix(generateSlug(title))
    slug = baseSlug
    
    if (existingPageId) {
      // 기존 페이지 업데이트 (status를 published로 변경)
      // 기존 페이지의 슬러그를 유지 (existingSlug 사용)
      slug = cleanGuidePrefix(existingSlug || '') || slug
      
      await c.env.DB.prepare(`
        UPDATE pages SET
          slug = ?, title = ?, summary = ?, content = ?, meta_data = ?,
          status = 'published', updated_at = ?
        WHERE id = ? AND page_type = 'guide'
      `).bind(slug, title, summary || '', finalContentHtml, metaData, now, existingPageId).run()
      pageId = existingPageId
      
      // draft의 slug도 정리
      if (draftId) {
        await c.env.DB.prepare(`
          UPDATE howto_drafts SET slug = ? WHERE id = ?
        `).bind(slug, draftId).run()
      }
    } else {
      // 새 페이지 생성
      let suffix = 2
      
      // 중복 체크
      while (suffix <= 100) {
        const existing = await c.env.DB.prepare(
          `SELECT id FROM pages WHERE page_type = 'guide' AND slug = ? LIMIT 1`
        ).bind(slug).first()
        if (!existing) break
        slug = baseSlug + '-' + suffix
        suffix++
      }
      
      const result = await c.env.DB.prepare(`
        INSERT INTO pages (
          page_type, slug, title, summary, content, meta_data,
          status, author_id, source, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, 'published', ?, 'user', ?, ?)
      `).bind('guide', slug, title, summary || '', finalContentHtml, metaData, user.id, now, now).run()
      
      if (!result.success) {
        return c.json({ success: false, error: '발행 중 오류가 발생했습니다' }, 500)
      }
      
      pageId = result.meta.last_row_id ? Number(result.meta.last_row_id) : null
      
      // draft에 published_page_id 연결
      if (draftId && pageId) {
        await c.env.DB.prepare(`
          UPDATE howto_drafts SET published_page_id = ?, slug = ? WHERE id = ?
        `).bind(pageId, slug, draftId).run()
      }
    }
    
    // 관련 콘텐츠 저장 (page_relations 테이블)
    if (pageId) {
      // 관련 직업 추가
      for (const job of (relatedJobs || [])) {
        if (!job.slug) continue
        const jobPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'job'`).bind(job.slug).first<{ id: number }>()
        if (jobPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_job')`)
            .bind(pageId, jobPage.id).run()
        }
      }
      
      // 관련 전공 추가
      for (const major of (relatedMajors || [])) {
        if (!major.slug) continue
        const majorPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'major'`).bind(major.slug).first<{ id: number }>()
        if (majorPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_major')`)
            .bind(pageId, majorPage.id).run()
        }
      }
      
      // 관련 HowTo 추가
      for (const howto of (relatedHowtos || [])) {
        if (!howto.slug) continue
        const howtoPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'guide'`).bind(howto.slug).first<{ id: number }>()
        if (howtoPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_howto')`)
            .bind(pageId, howtoPage.id).run()
        }
      }
    }
    
    return c.json({ success: true, slug, pageId, status: 'published' })
  } catch (error) {
    console.error('[publish-direct] Error:', error)
    return c.json({ success: false, error: '발행 중 오류가 발생했습니다' }, 500)
  }
})

// 임시 발행 → 정식 발행 API
app.post('/api/howto/:pageId/publish-final', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const pageId = parseInt(c.req.param('pageId'))
    
    if (!Number.isFinite(pageId)) {
      return c.json({ success: false, error: '유효하지 않은 페이지 ID입니다' }, 400)
    }
    
    // 페이지 정보 확인
    const page = await c.env.DB.prepare(`
      SELECT id, author_id, status FROM pages WHERE id = ? AND page_type = 'guide'
    `).bind(pageId).first<{ id: number; author_id: number; status: string }>()
    
    if (!page) {
      return c.json({ success: false, error: '페이지를 찾을 수 없습니다' }, 404)
    }
    
    // 권한 확인 (작성자 또는 관리자)
    const isAuthor = String(user.id) === String(page.author_id)
    const isAdmin = (user.role as string) === 'super-admin' || (user.role as string) === 'operator'
    
    if (!isAuthor && !isAdmin) {
      return c.json({ success: false, error: '권한이 없습니다' }, 403)
    }
    
    // draft_published 상태 확인
    if (page.status !== 'draft_published') {
      return c.json({ success: false, error: '임시 발행 상태가 아닙니다' }, 400)
    }
    
    // 정식 발행으로 상태 변경
    const now = new Date().toISOString()
    await c.env.DB.prepare(`
      UPDATE pages SET status = 'published', updated_at = ? WHERE id = ?
    `).bind(now, pageId).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('[publish-final] Error:', error)
    return c.json({ success: false, error: '발행 중 오류가 발생했습니다' }, 500)
  }
})

// 저장 시 임시 발행 (draft_published) 또는 업데이트 API
app.post('/api/howto/save-publish', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const body = await c.req.json()
    
    // 사용자 ID 필수 체크 (고아 데이터 방지)
    if (!user || !user.id) {
      console.error('[save-publish] Error: user.id is missing', user)
      return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
    }
    
    const { title, summary, contentJson, contentHtml, tags, relatedJobs, relatedMajors, relatedHowtos, thumbnailUrl, forceDraftPublished } = body
    let draftId = body.draftId
    
    // 필수 필드 체크
    if (!title || !title.trim()) {
      return c.json({ success: false, error: '제목을 입력해주세요' }, 400)
    }
    if (!contentJson || contentJson === '{}') {
      return c.json({ success: false, error: '본문을 입력해주세요' }, 400)
    }
    
    const now = new Date().toISOString()
    
    // draftId가 없으면 새 draft 생성
    if (!draftId) {
      const { createDraft } = await import('./services/draftService')
      const draftResult = await createDraft(c.env.DB, {
        userId: user.id,
        title,
        summary,
        thumbnailUrl,
        contentJson,
        contentHtml
      })
      if (!draftResult.success || !draftResult.draftId) {
        return c.json({ success: false, error: draftResult.error || '초안 생성 실패' }, 400)
      }
      draftId = draftResult.draftId
    } else {
      // 기존 draft 업데이트
      await c.env.DB.prepare(`
        UPDATE howto_drafts SET
          title = ?, summary = ?, content_json = ?, content_html = ?, thumbnail_url = ?,
          updated_at = ?, version = version + 1
        WHERE id = ? AND user_id = ?
      `).bind(title, summary || '', contentJson, contentHtml || '', thumbnailUrl || '', now, draftId, user.id).run()
    }
    
    // 기존 발행 페이지 확인
    console.log('[save-publish] Checking draft:', { draftId, userId: user.id })
    
    const draftInfo = await c.env.DB.prepare(`
      SELECT published_page_id, (SELECT status FROM pages WHERE id = published_page_id) as page_status
      FROM howto_drafts WHERE id = ? AND user_id = ?
    `).bind(draftId, user.id).first<{ published_page_id: number | null; page_status: string | null }>()
    
    console.log('[save-publish] Raw draftInfo:', draftInfo)
    
    const publishedPageId = draftInfo?.published_page_id
    const currentStatus = draftInfo?.page_status || ''
    
    console.log('[save-publish] Draft info:', { draftId, publishedPageId, currentStatus, title, userId: user.id })
    
    // 슬러그 생성 (항상 제목에서 새로 생성, guide: prefix 방지)
    const { generateSlug } = await import('./services/slugService')
    let baseSlug = cleanGuidePrefix(generateSlug(title))
    let slug = baseSlug
    let suffix = 2
    
    console.log('[save-publish] Generated slug:', { baseSlug, slug, publishedPageId })
    
    // 중복 체크
    while (suffix <= 100) {
      const existing = await c.env.DB.prepare(
        `SELECT id FROM pages WHERE page_type = 'guide' AND slug = ? ${publishedPageId ? 'AND id != ?' : ''} LIMIT 1`
      ).bind(...(publishedPageId ? [slug, publishedPageId] : [slug])).first()
      if (!existing) break
      slug = baseSlug + '-' + suffix
      suffix++
    }
    
    // HTML 생성 (Tiptap JSON → HTML)
    let finalContentHtml = contentHtml || ''
    let footnotes: Array<{ id: number; text: string; url?: string }> = []
    let firstImageUrl = ''
    try {
      const contentObj = JSON.parse(contentJson)
      finalContentHtml = convertTiptapToHtml(contentObj)
      footnotes = extractFootnotes(contentObj)
      firstImageUrl = extractFirstImage(contentObj)
    } catch {}
    
    const finalThumbnail = thumbnailUrl || firstImageUrl || ''
    
    // meta_data 구성
    const metaData = JSON.stringify({
      contentJson,
      tags: tags || [],
      relatedJobs: relatedJobs || [],
      relatedMajors: relatedMajors || [],
      relatedHowtos: relatedHowtos || [],
      footnotes,
      authorName: user.username || user.email?.split('@')[0] || '작성자',
      thumbnailUrl: finalThumbnail
    })
    
    // 새 상태 결정: forceDraftPublished면 항상 draft_published, 아니면 기존 상태 유지
    const newStatus = forceDraftPublished ? 'draft_published' : (currentStatus === 'published' ? 'published' : 'draft_published')
    
    let finalPageId = publishedPageId
    
    if (publishedPageId) {
      // 기존 페이지 업데이트 - slug도 정리된 값으로 업데이트
      await c.env.DB.prepare(`
        UPDATE pages SET
          slug = ?, title = ?, summary = ?, content = ?, meta_data = ?,
          status = ?, updated_at = ?
        WHERE id = ? AND page_type = 'guide'
      `).bind(slug, title, summary || '', finalContentHtml, metaData, newStatus, now, publishedPageId).run()
      
      // draft의 slug도 정리된 값으로 업데이트
      await c.env.DB.prepare(`
        UPDATE howto_drafts SET slug = ? WHERE id = ?
      `).bind(slug, draftId).run()
    } else {
      // 새 페이지 생성 (draft_published 상태)
      const result = await c.env.DB.prepare(`
        INSERT INTO pages (
          page_type, slug, title, summary, content, meta_data,
          status, author_id, source, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'user', ?, ?)
      `).bind('guide', slug, title, summary || '', finalContentHtml, metaData, 'draft_published', user.id, now, now).run()
      
      if (result.success && result.meta.last_row_id) {
        finalPageId = Number(result.meta.last_row_id)
        
        // draft에 published_page_id 연결
        await c.env.DB.prepare(`
          UPDATE howto_drafts SET published_page_id = ?, slug = ? WHERE id = ?
        `).bind(finalPageId, slug, draftId).run()
      }
    }
    
    // 관련 콘텐츠 저장 (page_relations 테이블)
    if (finalPageId) {
      // 기존 관계 삭제
      await c.env.DB.prepare(`DELETE FROM page_relations WHERE page_id = ?`).bind(finalPageId).run()
      
      // 관련 직업 추가
      for (const job of (relatedJobs || [])) {
        if (!job.slug) continue
        const jobPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'job'`).bind(job.slug).first<{ id: number }>()
        if (jobPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_job')`)
            .bind(finalPageId, jobPage.id).run()
        }
      }
      
      // 관련 전공 추가
      for (const major of (relatedMajors || [])) {
        if (!major.slug) continue
        const majorPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'major'`).bind(major.slug).first<{ id: number }>()
        if (majorPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_major')`)
            .bind(finalPageId, majorPage.id).run()
        }
      }
      
      // 관련 HowTo 추가
      for (const howto of (relatedHowtos || [])) {
        if (!howto.slug) continue
        const howtoPage = await c.env.DB.prepare(`SELECT id FROM pages WHERE slug = ? AND page_type = 'guide'`).bind(howto.slug).first<{ id: number }>()
        if (howtoPage) {
          await c.env.DB.prepare(`INSERT INTO page_relations (page_id, related_page_id, relation_type) VALUES (?, ?, 'related_howto')`)
            .bind(finalPageId, howtoPage.id).run()
        }
      }
    }
    
    return c.json({ success: true, slug, pageId: finalPageId, status: newStatus })
  } catch (error) {
    console.error('[save-publish] Error:', error)
    return c.json({ success: false, error: '저장 중 오류가 발생했습니다' }, 500)
  }
})

// 바로 발행 API
app.post('/api/howto/drafts/:id/publish', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    // 클라이언트에서 직접 전송한 데이터 받기 (선택적)
    let clientData: any = {}
    try {
      const body = await c.req.text()
      if (body) {
        clientData = JSON.parse(body)
      }
    } catch {}
    
    const { getDraft } = await import('./services/draftService')
    const draft = await getDraft(c.env.DB, draftId, user.id)
    
    if (!draft.success || !draft.draft) {
      return c.json({ success: false, error: draft.error || '초안을 찾을 수 없습니다' }, 404)
    }
    
    const d = draft.draft
    
    // 필수 필드 체크
    if (!d.title || !d.title.trim()) {
      return c.json({ success: false, error: '제목을 입력해주세요' }, 400)
    }
    if (!d.contentJson || d.contentJson === '{}') {
      return c.json({ success: false, error: '본문을 입력해주세요' }, 400)
    }
    
    // published_page_id 확인 (기존 발행 페이지가 있는지)
    const publishedPageId = d.publishedPageId
    
    // 슬러그 생성/확인 (중복 시 자동으로 -2, -3 추가, guide: prefix 방지)
    const { generateSlug } = await import('./services/slugService')
    let baseSlug = cleanGuidePrefix(d.slug || generateSlug(d.title))
    let slug = baseSlug
    let suffix = 2
    
    // pages 테이블에서 중복 체크 (page_type = 'guide', 자기 자신 제외)
    while (suffix <= 100) {
      const existing = await c.env.DB.prepare(
        `SELECT id FROM pages WHERE page_type = 'guide' AND slug = ? ${publishedPageId ? 'AND id != ?' : ''} LIMIT 1`
      ).bind(...(publishedPageId ? [slug, publishedPageId] : [slug])).first()
      if (!existing) break
      slug = baseSlug + '-' + suffix
      suffix++
    }
    
    // HTML 생성 (Tiptap JSON → HTML)
    let contentHtml = ''
    let footnotes: Array<{ id: number; text: string; url?: string }> = []
    let firstImageUrl = ''
    try {
      const contentObj = JSON.parse(d.contentJson)
      contentHtml = convertTiptapToHtml(contentObj)
      // 각주 추출
      footnotes = extractFootnotes(contentObj)
      // 첫 번째 이미지 추출 (썸네일용)
      firstImageUrl = extractFirstImage(contentObj)
    } catch {
      contentHtml = '<p>내용을 불러올 수 없습니다.</p>'
    }
    
    // 썸네일 URL: 명시적으로 지정된 것 > 첫 번째 이미지 > 빈 문자열
    const thumbnailUrl = d.thumbnailUrl || firstImageUrl || ''
    
    // 관련 콘텐츠: 클라이언트에서 전송한 데이터 우선, 없으면 draft에서 가져오기
    const relatedJobs = (clientData.relatedJobs && clientData.relatedJobs.length > 0) 
      ? clientData.relatedJobs 
      : (d.relatedJobs || [])
    const relatedMajors = (clientData.relatedMajors && clientData.relatedMajors.length > 0) 
      ? clientData.relatedMajors 
      : (d.relatedMajors || [])
    const relatedHowtos = (clientData.relatedHowtos && clientData.relatedHowtos.length > 0) 
      ? clientData.relatedHowtos 
      : (d.relatedHowtos || [])
    const tags = (clientData.tags && clientData.tags.length > 0)
      ? clientData.tags
      : (d.tags || [])
    
    // meta_data 구성 (관련 콘텐츠, 태그, 각주 포함)
    const metaData = JSON.stringify({
      contentJson: d.contentJson,
      tags,
      relatedJobs,
      relatedMajors,
      relatedHowtos,
      footnotes,
      authorName: user.username || user.email?.split('@')[0] || '작성자',
      thumbnailUrl
    })
    
    // pages 테이블에 삽입 또는 업데이트
    const now = new Date().toISOString()
    let result
    let finalPageId = publishedPageId
    
    if (publishedPageId) {
      // 기존 페이지 업데이트
      result = await c.env.DB.prepare(`
        UPDATE pages SET
          slug = ?, title = ?, summary = ?, content = ?, meta_data = ?,
          status = 'published', updated_at = ?
        WHERE id = ? AND page_type = 'guide'
      `).bind(
        slug,
        d.title,
        d.summary || '',
        contentHtml,
        metaData,
        now,
        publishedPageId
      ).run()
    } else {
      // 새 페이지 삽입
      result = await c.env.DB.prepare(`
        INSERT INTO pages (
          page_type, slug, title, summary, content, meta_data,
          status, author_id, source, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, 'published', ?, 'user', ?, ?)
      `).bind(
        'guide',
        slug,
        d.title,
        d.summary || '',
        contentHtml,
        metaData,
        user.id,
        now,
        now
      ).run()
      
      if (result.success && result.meta.last_row_id) {
        finalPageId = Number(result.meta.last_row_id)
      }
    }
    
    if (!result.success) {
      return c.json({ success: false, error: '발행 중 오류가 발생했습니다' }, 500)
    }
    
    // 초안 삭제
    await c.env.DB.prepare('DELETE FROM howto_drafts WHERE id = ?').bind(draftId).run()
    
    return c.json({ 
      success: true, 
      message: '발행이 완료되었습니다',
      slug: slug,
      url: '/howto/' + slug
    })
  } catch (error) {
    console.error('[publish draft] Error:', error)
    return c.json({ success: false, error: '발행 중 오류가 발생했습니다' }, 500)
  }
})

// Tiptap JSON에서 첫 번째 이미지 URL 추출 (썸네일용)
function extractFirstImage(doc: any): string {
  let firstImage = ''
  
  const traverse = (node: any) => {
    if (firstImage) return // 이미 찾았으면 중단
    if (!node) return
    
    if (node.type === 'image' && node.attrs?.src) {
      firstImage = node.attrs.src
      return
    }
    
    if (node.content && Array.isArray(node.content)) {
      for (const child of node.content) {
        traverse(child)
        if (firstImage) break
      }
    }
  }
  
  traverse(doc)
  return firstImage
}

// Tiptap JSON에서 각주 추출
function extractFootnotes(doc: any): Array<{ id: number; text: string; url?: string }> {
  const footnotes: Array<{ id: number; text: string; url?: string }> = []
  
  const traverse = (node: any) => {
    if (!node) return
    
    if (node.type === 'footnote') {
      footnotes.push({
        id: node.attrs?.id || 0,
        text: node.attrs?.text || '',
        url: node.attrs?.url || undefined
      })
    }
    
    if (node.content && Array.isArray(node.content)) {
      node.content.forEach(traverse)
    }
  }
  
  traverse(doc)
  
  // ID로 정렬 후 반환
  return footnotes.sort((a, b) => a.id - b.id)
}

// Tiptap JSON → HTML 변환 헬퍼
function convertTiptapToHtml(doc: any): string {
  if (!doc || !doc.content) return ''
  
  const processNode = (node: any): string => {
    if (!node) return ''
    
    switch (node.type) {
      case 'paragraph':
        const pContent = node.content?.map(processNode).join('') || ''
        const pAlign = node.attrs?.textAlign
        const pStyle = pAlign && pAlign !== 'left' ? ' style="text-align:' + pAlign + '"' : ''
        return pContent ? '<p' + pStyle + '>' + pContent + '</p>' : '<p><br></p>'
      
      case 'text':
        let text = escapeHtml(node.text || '')
        if (node.marks) {
          for (const mark of node.marks) {
            switch (mark.type) {
              case 'bold': text = '<strong>' + text + '</strong>'; break
              case 'italic': text = '<em>' + text + '</em>'; break
              case 'underline': text = '<u>' + text + '</u>'; break
              case 'strike': text = '<s>' + text + '</s>'; break
              case 'code': text = '<code>' + text + '</code>'; break
              case 'link': {
                let href = mark.attrs?.href || '#'
                // 프로토콜 없이 www.로 시작하면 https:// 추가
                if (href.startsWith('www.')) {
                  href = 'https://' + href
                }
                // 프로토콜 없이 도메인처럼 보이면 (. 포함, /나 #으로 시작 안함) https:// 추가
                else if (!href.startsWith('http') && !href.startsWith('/') && !href.startsWith('#') && !href.startsWith('mailto:') && href.includes('.')) {
                  href = 'https://' + href
                }
                // 외부 링크는 새 탭에서 열기
                const isExternal = href.startsWith('http://') || href.startsWith('https://') || href.startsWith('mailto:')
                const targetAttr = isExternal ? ' target="_blank" rel="noopener noreferrer"' : ''
                text = '<a href="' + escapeHtml(href) + '"' + targetAttr + '>' + text + '</a>'
                break
              }
              case 'textStyle': {
                const styles: string[] = []
                if (mark.attrs?.color) styles.push('color:' + mark.attrs.color)
                if (mark.attrs?.fontSize) styles.push('font-size:' + mark.attrs.fontSize)
                if (mark.attrs?.fontFamily) styles.push('font-family:' + mark.attrs.fontFamily)
                if (styles.length) text = '<span style="' + styles.join(';') + '">' + text + '</span>'
                break
              }
              case 'highlight':
                text = '<mark style="background:' + (mark.attrs?.color || '#ffeb3b') + '">' + text + '</mark>'
                break
            }
          }
        }
        return text
      
      case 'heading':
        const level = node.attrs?.level || 1
        const hContent = node.content?.map(processNode).join('') || ''
        const hAlign = node.attrs?.textAlign
        const hStyle = hAlign && hAlign !== 'left' ? ' style="text-align:' + hAlign + '"' : ''
        return '<h' + level + hStyle + '>' + hContent + '</h' + level + '>'
      
      case 'bulletList':
        return '<ul>' + (node.content?.map(processNode).join('') || '') + '</ul>'
      
      case 'orderedList':
        return '<ol>' + (node.content?.map(processNode).join('') || '') + '</ol>'
      
      case 'listItem':
        return '<li>' + (node.content?.map(processNode).join('') || '') + '</li>'
      
      case 'taskList':
        return '<ul class="task-list" data-type="taskList">' + (node.content?.map(processNode).join('') || '') + '</ul>'
      
      case 'taskItem':
        const checked = node.attrs?.checked ? ' checked' : ''
        const dataChecked = node.attrs?.checked ? ' data-checked="true"' : ''
        return '<li class="task-item"' + dataChecked + '><label><input type="checkbox"' + checked + '></label><div>' + (node.content?.map(processNode).join('') || '') + '</div></li>'
      
      case 'blockquote':
        const bqAlign = node.attrs?.align || 'left'
        const bqSize = node.attrs?.size || 'medium'
        const bqClass = `blockquote-align-${bqAlign} blockquote-size-${bqSize}`
        return '<blockquote class="' + bqClass + '" data-align="' + bqAlign + '" data-size="' + bqSize + '">' + (node.content?.map(processNode).join('') || '') + '</blockquote>'
      
      case 'codeBlock':
        return '<pre><code>' + escapeHtml(node.content?.[0]?.text || '') + '</code></pre>'
      
      case 'horizontalRule':
        return '<hr>'
      
      case 'image':
        const imgSrc = node.attrs?.src || ''
        const imgAlt = node.attrs?.alt || ''
        const imgWidth = node.attrs?.width
        const imgHeight = node.attrs?.height
        const imgAlign = node.attrs?.align || 'center'
        
        let imgStyle = ''
        if (imgWidth) imgStyle += 'width:' + imgWidth + 'px;'
        if (imgHeight) imgStyle += 'height:' + imgHeight + 'px;'
        
        const imgAttrs = ' src="' + escapeHtml(imgSrc) + '" alt="' + escapeHtml(imgAlt) + '"' +
          (imgStyle ? ' style="' + imgStyle + '"' : '') +
          ' loading="lazy" class="rounded-lg"'
        
        return '<figure class="image-wrapper image-align-' + imgAlign + '" data-align="' + imgAlign + '"><img' + imgAttrs + '></figure>'
      
      case 'table':
        return '<table>' + (node.content?.map(processNode).join('') || '') + '</table>'
      
      case 'tableRow':
        return '<tr>' + (node.content?.map(processNode).join('') || '') + '</tr>'
      
      case 'tableCell':
        const cellBg = node.attrs?.backgroundColor
        const cellStyle = cellBg ? ' style="background-color:' + cellBg + '"' : ''
        return '<td' + cellStyle + '>' + (node.content?.map(processNode).join('') || '') + '</td>'
      
      case 'tableHeader':
        return '<th>' + (node.content?.map(processNode).join('') || '') + '</th>'
      
      // 커스텀 노드들
      case 'checkpointBox':
        return '<div class="checkpoint-box">' + (node.content?.map(processNode).join('') || '') + '</div>'
      
      case 'conclusionBox':
        return '<div class="conclusion-box">' + (node.content?.map(processNode).join('') || '') + '</div>'
      
      case 'qnaBlock':
        return '<div class="qna-block">' + (node.content?.map(processNode).join('') || '') + '</div>'
      
      case 'qnaQuestion':
        return '<div class="qna-question"><span class="qna-label-q">Q</span><div class="qna-text">' + (node.content?.map(processNode).join('') || '') + '</div></div>'
      
      case 'qnaAnswer':
        return '<div class="qna-answer"><span class="qna-label-a">A</span><div class="qna-text">' + (node.content?.map(processNode).join('') || '') + '</div></div>'
      
      case 'careerList':
        return '<div class="career-list">' + (node.content?.map(processNode).join('') || '') + '</div>'
      
      case 'careerListItem':
        return '<div class="career-list-item">' + (node.content?.map(processNode).join('') || '') + '</div>'
      
      case 'footnote':
        const fnId = node.attrs?.id || 1
        // 항상 출처 섹션으로 이동하도록 내부 앵커 사용
        return '<sup class="footnote-ref"><a href="#fn-' + fnId + '" id="fnref-' + fnId + '" data-footnote-id="' + fnId + '">' + fnId + '</a></sup>'
      
      case 'hardBreak':
        return '<br>'
      
      default:
        if (node.content) {
          return node.content.map(processNode).join('')
        }
        return ''
    }
  }
  
  return doc.content.map(processNode).join('')
}

// 검수 대기 목록 (관리자)
app.get('/api/admin/howto/pending', requireAdmin, async (c) => {
  try {
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')
    
    const { listPendingReviews } = await import('./services/publishService')
    const result = await listPendingReviews(c.env.DB, { limit, offset })
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 500)
    }
    
    return c.json({ success: true, drafts: result.drafts, total: result.total })
  } catch (error) {
    console.error('[pending reviews] Error:', error)
    return c.json({ success: false, error: '조회 중 오류가 발생했습니다' }, 500)
  }
})

// 초안 승인 (관리자)
app.post('/api/admin/howto/drafts/:id/approve', requireAdmin, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    const { approveDraft } = await import('./services/publishService')
    const result = await approveDraft(c.env.DB, draftId, user.id)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 400)
    }
    
    return c.json({ 
      success: true, 
      howtoId: result.howtoId,
      slug: result.slug,
      message: '승인되어 게시되었습니다'
    })
  } catch (error) {
    console.error('[approve draft] Error:', error)
    return c.json({ success: false, error: '승인 처리 중 오류가 발생했습니다' }, 500)
  }
})

// 초안 반려 (관리자)
app.post('/api/admin/howto/drafts/:id/reject', requireAdmin, async (c) => {
  try {
    const user = c.get('user')!
    const draftId = parseInt(c.req.param('id'))
    const body = await c.req.json()
    const { reason } = body
    
    if (!Number.isFinite(draftId)) {
      return c.json({ success: false, error: '유효하지 않은 초안 ID입니다' }, 400)
    }
    
    if (!reason || typeof reason !== 'string' || reason.trim().length === 0) {
      return c.json({ success: false, error: '반려 사유를 입력해주세요' }, 400)
    }
    
    const { rejectDraft } = await import('./services/publishService')
    const result = await rejectDraft(c.env.DB, draftId, user.id, reason.trim())
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 400)
    }
    
    return c.json({ success: true, message: '반려 처리되었습니다' })
  } catch (error) {
    console.error('[reject draft] Error:', error)
    return c.json({ success: false, error: '반려 처리 중 오류가 발생했습니다' }, 500)
  }
})

// =====================================================
// 파일 업로드 API
// =====================================================

// 간단한 업로드 (FormData 방식)
app.post('/api/upload', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const formData = await c.req.parseBody()
    const file = formData['file'] as File
    
    if (!file || !(file instanceof File)) {
      return c.json({ success: false, error: '파일이 필요합니다' }, 400)
    }
    
    const { validateContentType, validateFileSize, validateMagicNumber, uploadToR2, generateFileKey } = await import('./services/uploadService')
    
    // 콘텐츠 타입 검증
    const typeResult = validateContentType(file.type)
    if (!typeResult.valid) {
      return c.json({ success: false, error: typeResult.error }, 400)
    }
    
    // 파일 크기 검증
    const sizeResult = validateFileSize(file.size)
    if (!sizeResult.valid) {
      return c.json({ success: false, error: sizeResult.error }, 400)
    }
    
    // 파일 데이터 읽기
    const body = await file.arrayBuffer()
    
    // 매직 넘버 검증
    if (!validateMagicNumber(body, file.type)) {
      return c.json({ success: false, error: '파일 형식이 올바르지 않습니다' }, 400)
    }
    
    // 파일 키 생성 (howto/YYYY/MM/DD/{파일명}-{shortId}.ext 형식)
    const ext = file.name.split('.').pop()?.toLowerCase() || 'bin'
    const fileKey = generateFileKey(ext, file.name)
    
    // R2에 업로드
    const uploadResult = await uploadToR2(c.env.UPLOADS, fileKey, body, file.type, {
      uploadedBy: user.id.toString(),
      originalName: file.name
    })
    
    if (!uploadResult.success) {
      return c.json({ success: false, error: uploadResult.error }, 500)
    }
    
    // URL 반환
    const baseUrl = new URL(c.req.url).origin
    const publicUrl = `${baseUrl}/uploads/${fileKey}`
    
    return c.json({ success: true, url: publicUrl })
  } catch (error) {
    console.error('[upload simple] Error:', error)
    return c.json({ success: false, error: '업로드 중 오류가 발생했습니다' }, 500)
  }
})

// 업로드 준비 (파일 키 발급)
app.post('/api/upload/prepare', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const body = await c.req.json()
    const { filename, contentType, contentLength } = body
    
    if (!filename || !contentType || !contentLength) {
      return c.json({ success: false, error: '필수 정보가 누락되었습니다' }, 400)
    }
    
    const { createUploadInfo, validateContentType, validateFileSize } = await import('./services/uploadService')
    
    // 검증
    const typeResult = validateContentType(contentType)
    if (!typeResult.valid) {
      return c.json({ success: false, error: typeResult.error }, 400)
    }
    
    const sizeResult = validateFileSize(contentLength)
    if (!sizeResult.valid) {
      return c.json({ success: false, error: sizeResult.error }, 400)
    }
    
    // 업로드 정보 생성
    const uploadInfo = createUploadInfo({ filename, contentType, contentLength })
    if (!uploadInfo.success) {
      return c.json({ success: false, error: uploadInfo.error }, 400)
    }
    
    // 기본 URL 결정
    const baseUrl = new URL(c.req.url).origin
    
    return c.json({
      success: true,
      fileKey: uploadInfo.data!.fileKey,
      uploadUrl: `${baseUrl}/api/upload/file`,
      publicUrl: `${baseUrl}/uploads/${uploadInfo.data!.fileKey}`,
      expiresIn: 300 // 5분
    })
  } catch (error) {
    console.error('[upload prepare] Error:', error)
    return c.json({ success: false, error: '업로드 준비 중 오류가 발생했습니다' }, 500)
  }
})

// 파일 업로드 (실제 업로드)
app.post('/api/upload/file', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    const fileKey = c.req.header('X-File-Key')
    const contentType = c.req.header('Content-Type') || ''
    
    if (!fileKey) {
      return c.json({ success: false, error: '파일 키가 필요합니다' }, 400)
    }
    
    const { validateContentType, validateMagicNumber, uploadToR2, getPublicUrl } = await import('./services/uploadService')
    
    // 콘텐츠 타입 검증
    const typeResult = validateContentType(contentType)
    if (!typeResult.valid) {
      return c.json({ success: false, error: typeResult.error }, 400)
    }
    
    // 파일 본문 읽기
    const body = await c.req.arrayBuffer()
    
    // 매직 넘버 검증
    if (!validateMagicNumber(body, contentType)) {
      return c.json({ success: false, error: '파일 형식이 올바르지 않습니다 (파일 시그니처 불일치)' }, 400)
    }
    
    // R2에 업로드
    const uploadResult = await uploadToR2(c.env.UPLOADS, fileKey, body, contentType, {
      uploadedBy: user.id.toString(),
      originalContentType: contentType
    })
    
    if (!uploadResult.success) {
      return c.json({ success: false, error: uploadResult.error }, 500)
    }
    
    // DB에 메타데이터 저장
    await c.env.DB.prepare(`
      INSERT INTO uploaded_files (user_id, file_key, content_type, file_size)
      VALUES (?, ?, ?, ?)
    `).bind(user.id, fileKey, contentType, body.byteLength).run()
    
    const baseUrl = new URL(c.req.url).origin
    
    return c.json({
      success: true,
      fileKey,
      publicUrl: `${baseUrl}/uploads/${fileKey}`,
      size: body.byteLength
    })
  } catch (error) {
    console.error('[upload file] Error:', error)
    return c.json({ success: false, error: '파일 업로드 중 오류가 발생했습니다' }, 500)
  }
})

// 이미지 서빙 (R2 프록시)
app.get('/uploads/*', async (c) => {
  try {
    const rawUrl = c.req.raw.url
    const urlObj = new URL(rawUrl)
    const pathAfterUploads = urlObj.pathname.replace('/uploads/', '')

    if (!pathAfterUploads) {
      return c.json({ error: 'Empty path' }, 404)
    }

    if (!c.env.UPLOADS) {
      return c.json({ error: 'R2 bucket not bound' }, 500)
    }

    // R2 키가 다양한 형태로 저장되어 있으므로 모든 변형을 시도
    // 옛 이미지: 인코딩된 키 (jobs/job-%EB%B2%95%EC%9D%98%ED%95%99%EC%9E%90.webp)
    // 새 이미지: 디코딩된 키 (jobs/job-법의학자.webp)
    const decodedPath = decodeURIComponent(pathAfterUploads)

    // 파일명에서 슬래시→언더스코어 변환 (UI/UX 같은 이름 처리)
    const firstSlash = decodedPath.indexOf('/')
    const dir = firstSlash !== -1 ? decodedPath.substring(0, firstSlash) : ''
    const filename = firstSlash !== -1 ? decodedPath.substring(firstSlash + 1) : decodedPath
    const safeFilename = filename.replace(/\//g, '_')

    // 파일명 부분만 인코딩한 키 (디렉토리 구분자는 유지)
    const reEncodedFilename = encodeURIComponent(safeFilename).replace(/%2F/g, '/')
    const reEncodedPath = dir ? `${dir}/${reEncodedFilename}` : reEncodedFilename

    // 시도할 R2 키 목록 (중복 제거)
    const keysToTry = [...new Set([
      decodedPath,                                    // 1. 디코딩된 한글 (새 이미지)
      pathAfterUploads,                               // 2. URL에서 추출한 원본 (인코딩된 상태)
      reEncodedPath,                                  // 3. 파일명만 재인코딩
      dir ? `${dir}/${safeFilename}` : safeFilename,  // 4. 슬래시→언더스코어 변환
    ])]

    let object: R2ObjectBody | null = null
    let usedPath = ''

    for (const key of keysToTry) {
      object = await c.env.UPLOADS.get(key)
      if (object) {
        usedPath = key
        break
      }
    }

    if (!object) {
      return c.json({
        error: 'File not found in R2',
        tried: keysToTry,
      }, 404)
    }
    
    // 확장자 기반 Content-Type 추론 (R2 메타데이터가 없을 경우 대비)
    const getContentTypeByExtension = (filepath: string): string => {
      const ext = filepath.split('.').pop()?.toLowerCase()
      const mimeTypes: Record<string, string> = {
        'webp': 'image/webp',
        'png': 'image/png',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'svg': 'image/svg+xml',
        'ico': 'image/x-icon',
        'avif': 'image/avif'
      }
      return mimeTypes[ext || ''] || 'application/octet-stream'
    }
    
    // 캐시 헤더 설정 (1년)
    const headers = new Headers()
    const contentType = object.httpMetadata?.contentType || getContentTypeByExtension(usedPath)
    headers.set('Content-Type', contentType)
    headers.set('Cache-Control', 'public, max-age=31536000, immutable')
    headers.set('ETag', object.httpEtag)
    
    // If-None-Match 헤더 확인 (304 응답)
    const ifNoneMatch = c.req.header('If-None-Match')
    if (ifNoneMatch && ifNoneMatch === object.httpEtag) {
      return new Response(null, { status: 304, headers })
    }
    
    return new Response(object.body as ReadableStream, { headers })
  } catch (error) {
    // 에러 발생 시 상세 정보 반환
    return c.json({
      error: 'R2 proxy error',
      message: error instanceof Error ? error.message : String(error)
    }, 500)
  }
})

// ============================================
// Z-Image Turbo 이미지 생성 API
// ============================================

// 이미지 생성 요청 (관리자 전용)
app.post('/api/image/generate', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    
    // 관리자 권한 확인
    if (user.role !== 'admin') {
      return c.json({ success: false, error: '관리자 권한이 필요합니다' }, 403)
    }
    
    const apiKey = c.env.EVOLINK_API_KEY
    if (!apiKey) {
      return c.json({ success: false, error: 'EVOLINK_API_KEY가 설정되지 않았습니다' }, 500)
    }
    
    const body = await c.req.json()
    const { type, slug, promptOverride } = body as {
      type: 'jobs' | 'majors'
      slug: string
      promptOverride?: string
    }
    
    if (!type || !slug) {
      return c.json({ success: false, error: 'type과 slug가 필요합니다' }, 400)
    }
    
    // DB에서 프롬프트 조회
    let imagePrompt = promptOverride
    if (!imagePrompt) {
      const table = type === 'jobs' ? 'jobs' : 'majors'
      const record = await c.env.DB.prepare(`
        SELECT image_prompt FROM ${table} WHERE slug = ?
      `).bind(slug).first()
      
      if (!record || !record.image_prompt) {
        return c.json({ success: false, error: '해당 항목의 프롬프트를 찾을 수 없습니다' }, 404)
      }
      imagePrompt = record.image_prompt as string
    }
    
    // 콜백 URL 생성
    const baseUrl = new URL(c.req.url).origin
    const callbackUrl = `${baseUrl}/webhooks/image-completed`
    
    // Z-Image Turbo API 호출
    const { requestImageGeneration } = await import('./services/imageGenerationService')
    const result = await requestImageGeneration(apiKey, {
      prompt: imagePrompt,
      size: '16:9',
      callback_url: callbackUrl
    })
    
    if (!result.success || !result.data) {
      return c.json({ success: false, error: result.error || '이미지 생성 요청 실패' }, 500)
    }
    
    // 태스크 정보를 KV에 저장 (콜백 시 사용)
    const taskMeta = {
      type,
      slug,
      prompt: imagePrompt.substring(0, 200), // 프롬프트 요약
      createdAt: Date.now(),
      createdBy: user.id
    }
    
    // KV가 바인딩되어 있으면 저장 (로컬 개발 환경에서는 없을 수 있음)
    if (c.env.KV) {
      await c.env.KV.put(`image-task:${result.data.id}`, JSON.stringify(taskMeta), {
        expirationTtl: 86400 // 24시간
      })
    } else {
      console.warn('[image/generate] KV not bound, task metadata not saved. Callback may not work.')
    }
    
    return c.json({
      success: true,
      taskId: result.data.id,
      status: result.data.status,
      estimatedTime: result.data.task_info?.estimated_time || 10
    })
  } catch (error) {
    console.error('[image/generate] Error:', error)
    return c.json({ success: false, error: '이미지 생성 요청 중 오류 발생' }, 500)
  }
})

// 이미지 생성 상태 조회
app.get('/api/image/status/:taskId', requireAuth, async (c) => {
  try {
    const taskId = c.req.param('taskId')
    const apiKey = c.env.EVOLINK_API_KEY
    
    if (!apiKey) {
      return c.json({ success: false, error: 'EVOLINK_API_KEY가 설정되지 않았습니다' }, 500)
    }
    
    const { queryTaskStatus } = await import('./services/imageGenerationService')
    const result = await queryTaskStatus(apiKey, taskId)
    
    // 🔍 디버그: API 응답 로깅
    console.log('[image/status] Raw response:', JSON.stringify(result.data, null, 2))
    
    if (!result.success || !result.data) {
      return c.json({ success: false, error: result.error || '상태 조회 실패' }, 500)
    }
    
    // 상태 정규화 (다양한 API 응답 형식 처리)
    const rawStatus = (result.data as any).status || (result.data as any).state || ''
    const normalizedStatus = rawStatus.toLowerCase()
    const isCompleted = normalizedStatus === 'completed' || normalizedStatus === 'success' || normalizedStatus === 'done'
    const isFailed = normalizedStatus === 'failed' || normalizedStatus === 'error'

    // results 배열 우선, data.url/urls는 fallback
    const imageUrl = (result.data as any).results?.[0] || (result.data as any).data?.url || (result.data as any).data?.urls?.[0] || (result.data as any).output?.url
    
    console.log('[image/status] Parsed:', { rawStatus, isCompleted, isFailed, hasImageUrl: !!imageUrl })
    
    return c.json({
      success: true,
      taskId: result.data.id,
      status: isCompleted ? 'completed' : (isFailed ? 'failed' : rawStatus),
      progress: result.data.progress,
      imageUrl
    })
  } catch (error) {
    console.error('[image/status] Error:', error)
    return c.json({ success: false, error: '상태 조회 중 오류 발생' }, 500)
  }
})

// 이미지 저장 API (폴링 방식용 - 로컬 환경에서 콜백이 작동하지 않을 때 사용)
app.post('/api/image/save', requireAuth, async (c) => {
  try {
    const user = c.get('user')!
    
    // 관리자 권한 확인
    if (user.role !== 'admin') {
      return c.json({ success: false, error: '관리자 권한이 필요합니다' }, 403)
    }
    
    const body = await c.req.json()
    const { taskId, type, slug, imageUrl } = body as {
      taskId: string
      type: 'jobs' | 'majors'
      slug: string
      imageUrl: string
    }
    
    if (!taskId || !type || !slug || !imageUrl) {
      return c.json({ success: false, error: 'taskId, type, slug, imageUrl가 필요합니다' }, 400)
    }
    
    const { downloadImage, generateImageFileKey, getImagePublicUrl } = 
      await import('./services/imageGenerationService')
    const { uploadToR2 } = await import('./services/uploadService')
    
    // 이미지 다운로드
    console.log('[image/save] Downloading image:', imageUrl)
    const downloadResult = await downloadImage(imageUrl)
    if (!downloadResult.success || !downloadResult.data) {
      console.error('[image/save] Download failed:', downloadResult.error)
      return c.json({ success: false, error: downloadResult.error || '이미지 다운로드 실패' }, 500)
    }
    
    // R2에 업로드 (기존 이미지 덮어쓰기)
    const fileKey = generateImageFileKey(type, slug)
    console.log('[image/save] Uploading to R2:', fileKey)
    const uploadResult = await uploadToR2(
      c.env.UPLOADS,
      fileKey,
      downloadResult.data,
      downloadResult.contentType || 'image/png',
      {
        source: 'z-image-turbo',
        taskId,
        slug
      }
    )
    
    if (!uploadResult.success) {
      console.error('[image/save] Upload failed:', uploadResult.error)
      return c.json({ success: false, error: uploadResult.error || 'R2 업로드 실패' }, 500)
    }
    
    // DB 업데이트 (image_url 컬럼 + merged_profile_json 둘 다 업데이트)
    const baseUrl = new URL(c.req.url).origin
    const publicUrl = getImagePublicUrl(fileKey, baseUrl)
    // 캐시 버스터 추가 (브라우저 캐시 우회)
    const publicUrlWithCache = `${publicUrl}?v=${Date.now()}`
    const table = type === 'jobs' ? 'jobs' : 'majors'
    
    // slug로 레코드 찾기 - image_url 컬럼과 merged_profile_json 둘 다 업데이트
    let updateResult = await c.env.DB.prepare(`
      UPDATE ${table}
      SET image_url = ?,
          merged_profile_json = json_set(COALESCE(merged_profile_json, '{}'), '$.image_url', ?)
      WHERE slug = ?
    `).bind(publicUrlWithCache, publicUrlWithCache, slug).run()
    
    // slug로 못 찾으면 name으로 시도
    if (updateResult.meta.changes === 0) {
      updateResult = await c.env.DB.prepare(`
        UPDATE ${table}
        SET image_url = ?,
            merged_profile_json = json_set(COALESCE(merged_profile_json, '{}'), '$.image_url', ?)
        WHERE name = ?
      `).bind(publicUrlWithCache, publicUrlWithCache, slug).run()
    }
    
    console.log('[image/save] DB updated:', table, slug, publicUrl, 'changes:', updateResult.meta.changes)
    
    // ISR 캐시 무효화 (wiki_pages에서 해당 페이지 삭제)
    try {
      const pageType = type === 'jobs' ? 'job' : 'major'
      await c.env.DB.prepare(`
        DELETE FROM wiki_pages WHERE slug LIKE ? AND page_type = ?
      `).bind(`%${slug}%`, pageType).run()
      console.log('[image/save] ISR cache invalidated for:', slug)
    } catch (cacheError) {
      console.warn('[image/save] Cache invalidation failed:', cacheError)
    }
    
    return c.json({ 
      success: true, 
      imageUrl: publicUrl,
      message: '이미지가 성공적으로 저장되었습니다. 페이지를 새로고침해주세요.'
    })
  } catch (error) {
    console.error('[image/save] Error:', error)
    return c.json({ success: false, error: '이미지 저장 중 오류 발생' }, 500)
  }
})

// Z-Image Turbo 콜백 핸들러 (이미지 생성 완료 시 호출됨)
app.post('/webhooks/image-completed', async (c) => {
  try {
    const body = await c.req.json()
    console.log('[webhook/image-completed] Received:', JSON.stringify(body).substring(0, 500))
    
    const { parseCallbackData, downloadImage, generateImageFileKey, getImagePublicUrl } = 
      await import('./services/imageGenerationService')
    const { uploadToR2 } = await import('./services/uploadService')
    
    // 콜백 데이터 파싱
    const taskData = parseCallbackData(body)
    if (!taskData) {
      console.error('[webhook/image-completed] Invalid callback data')
      return c.json({ success: false, error: 'Invalid callback data' }, 400)
    }
    
    const taskId = taskData.id
    const status = taskData.status
    
    // 태스크 메타데이터 조회
    const taskMetaStr = await c.env.KV.get(`image-task:${taskId}`)
    if (!taskMetaStr) {
      console.error('[webhook/image-completed] Task metadata not found:', taskId)
      return c.json({ success: false, error: 'Task metadata not found' }, 404)
    }
    
    const taskMeta = JSON.parse(taskMetaStr) as {
      type: 'jobs' | 'majors'
      slug: string
      prompt: string
      createdAt: number
      createdBy: number
    }
    
    // 실패 처리
    if (status === 'failed') {
      console.error('[webhook/image-completed] Task failed:', taskId, taskData.error)
      // 실패 로그 저장 (선택사항)
      await c.env.KV.put(`image-task-failed:${taskId}`, JSON.stringify({
        ...taskMeta,
        error: taskData.error,
        failedAt: Date.now()
      }), { expirationTtl: 604800 }) // 7일
      return c.json({ success: true, status: 'failed' })
    }
    
    // 완료가 아니면 무시
    if (status !== 'completed') {
      console.log('[webhook/image-completed] Task not completed yet:', taskId, status)
      return c.json({ success: true, status })
    }
    
    // 이미지 URL 추출 (results 배열 우선)
    const imageUrl = taskData.results?.[0] || taskData.data?.url || taskData.data?.urls?.[0]
    if (!imageUrl) {
      console.error('[webhook/image-completed] No image URL in callback:', taskId)
      return c.json({ success: false, error: 'No image URL' }, 400)
    }
    
    // 이미지 다운로드
    const downloadResult = await downloadImage(imageUrl)
    if (!downloadResult.success || !downloadResult.data) {
      console.error('[webhook/image-completed] Download failed:', downloadResult.error)
      return c.json({ success: false, error: downloadResult.error }, 500)
    }
    
    // R2에 업로드
    const fileKey = generateImageFileKey(taskMeta.type, taskMeta.slug)
    const uploadResult = await uploadToR2(
      c.env.UPLOADS,
      fileKey,
      downloadResult.data,
      downloadResult.contentType || 'image/png',
      {
        source: 'z-image-turbo',
        taskId,
        slug: taskMeta.slug
      }
    )
    
    if (!uploadResult.success) {
      console.error('[webhook/image-completed] Upload failed:', uploadResult.error)
      return c.json({ success: false, error: uploadResult.error }, 500)
    }
    
    // DB 업데이트
    const baseUrl = new URL(c.req.url).origin
    const publicUrl = getImagePublicUrl(fileKey, baseUrl)
    const table = taskMeta.type === 'jobs' ? 'jobs' : 'majors'
    
    await c.env.DB.prepare(`
      UPDATE ${table}
      SET image_url = ?, updated_at = datetime('now')
      WHERE slug = ?
    `).bind(publicUrl, taskMeta.slug).run()
    
    console.log('[webhook/image-completed] Success:', taskMeta.type, taskMeta.slug, publicUrl)
    
    // 태스크 메타데이터 삭제
    await c.env.KV.delete(`image-task:${taskId}`)
    
    // 성공 로그 저장 (선택사항)
    await c.env.KV.put(`image-task-completed:${taskId}`, JSON.stringify({
      ...taskMeta,
      imageUrl: publicUrl,
      completedAt: Date.now()
    }), { expirationTtl: 604800 }) // 7일
    
    return c.json({ success: true, status: 'completed', imageUrl: publicUrl })
  } catch (error) {
    console.error('[webhook/image-completed] Error:', error)
    return c.json({ success: false, error: 'Internal error' }, 500)
  }
})

// HowTo 신고 (로그인/익명 모두 가능)
app.post('/api/howto/:slug/report', authMiddleware, async (c) => {
  try {
    const slug = c.req.param('slug')
    const authUser = c.get('user')  // User 타입 (id: number)
    const body = await c.req.json()
    
    const { reasonType, reasonDetail } = body
    
    // 유효한 신고 사유인지 확인
    const validReasons = ['defamation', 'obscene', 'spam', 'copyright', 'false_info', 'other']
    if (!reasonType || !validReasons.includes(reasonType)) {
      return c.json({ success: false, error: '유효한 신고 사유를 선택해주세요' }, 400)
    }
    
    // HowTo 페이지 조회 (page_type='guide')
    const page = await c.env.DB.prepare(`
      SELECT id FROM pages WHERE slug = ? AND page_type = 'guide'
    `).bind(slug).first<{ id: number }>()
    
    if (!page) {
      return c.json({ success: false, error: 'HowTo를 찾을 수 없습니다' }, 404)
    }
    
    // 신고 생성
    const { createHowtoReport } = await import('./services/howtoReportService')
    const clientIp = c.req.header('CF-Connecting-IP') || c.req.header('X-Forwarded-For')?.split(',')[0]?.trim()
    
    const result = await createHowtoReport(c.env.DB, {
      pageId: page.id,
      reporterId: authUser?.id ?? null,
      reporterIp: !authUser ? clientIp : null,
      reasonType,
      reasonDetail: reasonDetail?.slice(0, 500) // 500자 제한
    })
    
    return c.json({
      success: true,
      reportId: result.reportId,
      autoBlinded: result.autoBlinded,
      message: result.autoBlinded 
        ? '신고가 접수되었으며, 신고 누적으로 해당 글이 블라인드 처리되었습니다.'
        : '신고가 접수되었습니다. 관리자 검토 후 조치될 예정입니다.'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error)
    console.error('[howto report] Error:', message)
    
    if (message === 'ALREADY_REPORTED') {
      return c.json({ success: false, error: '이미 신고한 글입니다' }, 400)
    }
    
    return c.json({ success: false, error: '신고 처리 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo 블라인드 처리 (관리자 전용)
app.post('/api/admin/howto/:slug/blind', requireAdmin, async (c) => {
  try {
    const slug = c.req.param('slug')
    const user = c.get('user')!
    const body = await c.req.json()
    const { reason } = body
    
    if (!reason || typeof reason !== 'string' || reason.trim().length === 0) {
      return c.json({ success: false, error: '블라인드 사유를 입력해주세요' }, 400)
    }
    
    // HowTo 페이지 조회 (page_type='guide')
    const page = await c.env.DB.prepare(`
      SELECT id FROM pages WHERE slug = ? AND page_type = 'guide'
    `).bind(slug).first<{ id: number }>()
    
    if (!page) {
      return c.json({ success: false, error: 'HowTo를 찾을 수 없습니다' }, 404)
    }
    
    const { blindHowto } = await import('./services/howtoReportService')
    await blindHowto(c.env.DB, page.id, user.id, reason.trim())
    
    return c.json({ success: true, message: '블라인드 처리되었습니다' })
  } catch (error) {
    console.error('[howto blind] Error:', error)
    return c.json({ success: false, error: '처리 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo 블라인드 해제 (관리자 전용)
app.post('/api/admin/howto/:slug/unblind', requireAdmin, async (c) => {
  try {
    const slug = c.req.param('slug')
    
    // HowTo 페이지 조회 (page_type='guide')
    const page = await c.env.DB.prepare(`
      SELECT id FROM pages WHERE slug = ? AND page_type = 'guide'
    `).bind(slug).first<{ id: number }>()
    
    if (!page) {
      return c.json({ success: false, error: 'HowTo를 찾을 수 없습니다' }, 404)
    }
    
    const { unblindHowto } = await import('./services/howtoReportService')
    await unblindHowto(c.env.DB, page.id)
    
    return c.json({ success: true, message: '블라인드가 해제되었습니다' })
  } catch (error) {
    console.error('[howto unblind] Error:', error)
    return c.json({ success: false, error: '처리 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo 신고 목록 조회 (관리자 전용)
app.get('/api/admin/howto/reports', requireAdmin, async (c) => {
  try {
    const status = c.req.query('status')
    const pageId = c.req.query('pageId')
    const limit = parseInt(c.req.query('limit') || '50')
    const offset = parseInt(c.req.query('offset') || '0')
    
    const { listHowtoReports } = await import('./services/howtoReportService')
    const result = await listHowtoReports(c.env.DB, {
      status: status || undefined,
      pageId: pageId ? parseInt(pageId) : undefined,
      limit,
      offset
    })
    
    return c.json({ success: true, ...result })
  } catch (error) {
    console.error('[howto reports] Error:', error)
    return c.json({ success: false, error: '조회 중 오류가 발생했습니다' }, 500)
  }
})

// HowTo 신고 처리 (관리자 전용)
app.post('/api/admin/howto/reports/:id/resolve', requireAdmin, async (c) => {
  try {
    const reportId = parseInt(c.req.param('id'))
    const user = c.get('user')!
    const body = await c.req.json()
    const { action } = body // 'resolve' or 'dismiss'
    
    if (!['resolve', 'dismiss'].includes(action)) {
      return c.json({ success: false, error: '유효하지 않은 액션입니다' }, 400)
    }
    
    const { resolveHowtoReport } = await import('./services/howtoReportService')
    await resolveHowtoReport(c.env.DB, reportId, user.id, action)
    
    return c.json({ 
      success: true, 
      message: action === 'resolve' ? '신고가 처리되었습니다' : '신고가 기각되었습니다'
    })
  } catch (error) {
    console.error('[howto report resolve] Error:', error)
    return c.json({ success: false, error: '처리 중 오류가 발생했습니다' }, 500)
  }
})

// Revision 상세 조회
app.get('/api/revision/:id', authMiddleware, async (c) => {
  try {
    const revisionId = Number(c.req.param('id'))
    const includeFullData = c.req.query('fullData') === 'true'
    const formatForEdit = c.req.query('formatForEdit') === 'true' // 편집 형식으로 변환
    
    if (!Number.isFinite(revisionId) || revisionId <= 0) {
      return c.json({ success: false, error: 'invalid revision id' }, 400)
    }
    
    const revision = await getRevisionById(c.env.DB, revisionId)
    
    if (!revision) {
      return c.json({ success: false, error: 'revision not found' }, 404)
    }
    
    let fullData = null
    let editFormattedData = null
    
    if (includeFullData) {
      // 전체 데이터 재구성
      const { reconstructFullData } = await import('./services/revisionService')
      try {
        const snapshot = JSON.parse(revision.dataSnapshot)
        
        // 변경사항만 저장된 경우 전체 데이터 재구성 필요
        if (snapshot.changedFields !== undefined) {
          // entityType이 'job' | 'major' | 'howto'인 경우에만 재구성
          if (revision.entityType === 'job' || revision.entityType === 'major' || revision.entityType === 'howto') {
            fullData = await reconstructFullData(
              c.env.DB,
              revision.entityType,
              revision.entityId,
              revision.revisionNumber
            )
          } else {
            // 'guide' 등 다른 타입은 스냅샷 그대로 사용
            fullData = snapshot
          }
        } else {
          // 전체 스냅샷인 경우 그대로 사용
          fullData = snapshot
        }
        
        // 편집 형식으로 변환 요청 시
        if (formatForEdit && revision.entityType === 'job' && fullData) {
          // edit-data API와 동일한 로직으로 필드 추출
          const { mergeJobData } = await import('./services/jobDataMerger')
          
          // fullData가 원본 구조인지 확인 (careernet, goyong24 포함 여부)
          let rawApiData: { careernet: any; goyong24: any } = { careernet: null, goyong24: null }
          if (fullData.careernet !== undefined || fullData.goyong24 !== undefined) {
            rawApiData = {
              careernet: fullData.careernet || null,
              goyong24: fullData.goyong24 || null
            }
          } else {
            // fullData가 이미 병합된 구조인 경우, 원본 구조로 가정
            rawApiData = fullData as any
          }
          
          const mergedData = mergeJobData(rawApiData)
          
          // profile 객체 생성 (fullData에서 직접 필드 추출)
          const profile = {
            name: fullData.name || '',
            summary: fullData.summary || (rawApiData?.goyong24 as any)?.duty?.jobSum || '',
            duties: fullData.duties || '',
            way: fullData.way || '',
            salary: fullData.salary || '',
            prospect: fullData.prospect || '',
            satisfaction: fullData.satisfaction || '',
            status: fullData.status || '',
            abilities: fullData.abilities || '',
            knowledge: fullData.knowledge || '',
            environment: fullData.environment || '',
            personality: fullData.personality || '',
            interests: fullData.interests || '',
            values: fullData.values || '',
            technKnow: fullData.technKnow || '',
            aptitudeList: fullData.aptitudeList || [],
            educationDistribution: fullData.educationDistribution || null,
            majorDistribution: fullData.majorDistribution || null
          }
          
          // edit-data API와 동일한 로직으로 필드 추출
          const summaryForEdit = profile.summary || (rawApiData?.goyong24 as any)?.duty?.jobSum || ''
          const workSummary = mergedData.work.summary || profile.summary || ''
          
          const workSimple = mergedData.work.simple
          let duties = ''
          if (workSimple && Array.isArray(workSimple) && workSimple.length > 0) {
            duties = workSimple
              .map((item: any) => {
                const text = typeof item === 'string' ? item : item.work || item.list_content || ''
                return text?.trim() || ''
              })
              .filter(Boolean)
              .join('\n')
          } else if (profile.duties?.trim()) {
            duties = profile.duties
          }
          
          const tagList = (rawApiData?.careernet as any)?.encyclopedia?.tagList || []
          const tagText = Array.isArray(tagList) 
            ? tagList.map((tag: any) => {
                const tagText = typeof tag === 'string' ? tag : (tag?.tag || tag?.list_content || '')
                return tagText?.trim() || ''
              }).filter(Boolean).join('\n')
            : ''
          
          // heroTags 처리
          let heroTags: string[] = []
          if (Array.isArray(fullData.heroTags)) {
            heroTags = fullData.heroTags
          } else if (Array.isArray(tagList) && tagList.length > 0) {
            heroTags = tagList.map((tag: any) => {
              if (typeof tag === 'string') return tag.trim()
              return (tag?.tag || tag?.list_content || '').trim()
            }).filter(Boolean)
          }
          
          // heroCategory 처리
          let heroCategory = ''
          if (typeof fullData.heroCategory === 'string') {
            heroCategory = fullData.heroCategory
          } else if (fullData.heroCategory?.value) {
            heroCategory = fullData.heroCategory.value
          } else if (fullData.heroCategory?.large) {
            heroCategory = fullData.heroCategory.large
          }
          
          editFormattedData = {
            name: profile.name || '',
            summary: summaryForEdit,
            heroTags: heroTags, // 추가
            heroCategory: heroCategory, // 추가
            duties: duties,
            way: profile.way || '',
            salary: mergedData.salary.primary || profile.salary || '',
            prospect: mergedData.prospect.primary || profile.prospect || '',
            satisfaction: mergedData.satisfaction.primary || profile.satisfaction || '',
            status: profile.status || '',
            abilities: profile.abilities || '',
            knowledge: profile.knowledge || '',
            environment: profile.environment || '',
            personality: profile.personality || '',
            interests: profile.interests || '',
            values: profile.values || '',
            technKnow: profile.technKnow || '',
            aptitude: profile.aptitudeList?.map((item: any) => item.name || '').join('\n') || '',
            educationDistribution: profile.educationDistribution ? JSON.stringify(profile.educationDistribution, null, 2) : '',
            majorDistribution: profile.majorDistribution ? JSON.stringify(profile.majorDistribution, null, 2) : '',
            tags: tagText,
            workSummary: workSummary
          }
        }
      } catch (error) {
        console.error('[revision/:id] Failed to reconstruct full data:', error)
      }
    }
    
    return c.json({
      success: true,
      data: {
        ...revision,
        fullData,
        editFormattedData
      }
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to get revision'
    return c.json({ success: false, error: message }, 500)
  }
})

// Revision 목록 조회
app.get('/api/job/:id/revisions', authMiddleware, async (c) => {
  try {
    const jobIdParam = c.req.param('id')
    const limit = parseInt(c.req.query('limit') || '20', 10)
    const offset = parseInt(c.req.query('offset') || '0', 10)
    
    // 실제 DB ID로 변환 (editJob과 동일한 로직)
    let jobId = jobIdParam
    let job = await c.env.DB.prepare('SELECT id FROM jobs WHERE id = ? AND is_active = 1')
      .bind(jobId)
      .first<{ id: string }>()
    
    // ID로 찾지 못한 경우 slug로 시도
    if (!job) {
      // job:G_K000000890 같은 형식에서 실제 ID 추출 시도
      let extractedId = jobId
      if (jobId.includes(':')) {
        const parts = jobId.split(':')
        if (parts.length > 1) {
          extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
          job = await c.env.DB.prepare('SELECT id FROM jobs WHERE id = ? AND is_active = 1')
            .bind(extractedId)
            .first<{ id: string }>()
          
          if (job) {
            jobId = extractedId
          }
        }
      }
      
      // 여전히 찾지 못한 경우 slug로 시도
      if (!job) {
        const decodedSlug = decodeURIComponent(jobId)
        const normalizedSlug = decodedSlug.toLowerCase()
        
        job = await c.env.DB.prepare(
          'SELECT id FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first<{ id: string }>()
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first<{ id: string }>()
        }
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(decodedSlug).first<{ id: string }>()
        }
        
        if (job) {
          jobId = job.id
        }
      }
    }
    
    if (!job) {
      return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
    }
    
    const result = await listRevisions(c.env.DB, 'job', jobId, {
      limit: Math.min(Math.max(limit, 1), 100),
      offset: Math.max(offset, 0)
    })
    
    return c.json({
      success: true,
      data: result
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to list revisions'
    return c.json({ success: false, error: message }, 500)
  }
})

app.get('/api/major/:id/revisions', authMiddleware, async (c) => {
  try {
    let majorId = c.req.param('id')
    const limit = parseInt(c.req.query('limit') || '20', 10)
    const offset = parseInt(c.req.query('offset') || '0', 10)
    
    // ID 해결 (직업 상세페이지와 동일한 로직)
    if (c.env.DB && majorId) {
      try {
        const db = c.env.DB
        
        // composite ID인 경우 (major:C_xxx 또는 major:G_xxx)
        if (majorId.includes(':')) {
          const parts = majorId.split(':')
          if (parts.length > 1) {
            const sourceId = parts[parts.length - 1].replace(/^C_/, '').replace(/^G_/, '')
            const dbResult = await db.prepare(
              'SELECT id FROM majors WHERE careernet_id = ? OR goyong24_id = ? LIMIT 1'
            ).bind(sourceId, sourceId).first() as { id: string } | null
            if (dbResult?.id) {
              majorId = dbResult.id
            }
          }
        } else {
          // majorId가 composite ID가 아닌 경우 DB에서 찾기
          let dbResult = await db.prepare(
            'SELECT id FROM majors WHERE id = ? AND is_active = 1 LIMIT 1'
          ).bind(majorId).first() as { id: string } | null
          
          if (!dbResult) {
            // slug로 조회 시도
            const decodedSlug = decodeURIComponent(majorId)
            const normalizedSlug = decodedSlug.toLowerCase()
            dbResult = await db.prepare(
              'SELECT id FROM majors WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
            ).bind(normalizedSlug).first() as { id: string } | null
            
            if (dbResult?.id) {
              majorId = dbResult.id
            }
          }
        }
      } catch (dbError) {
        console.error('[major revisions] Failed to resolve ID:', dbError)
      }
    }
    
    const result = await listRevisions(c.env.DB, 'major', majorId, {
      limit: Math.min(Math.max(limit, 1), 100),
      offset: Math.max(offset, 0)
    })
    
    
    return c.json({
      success: true,
      data: result
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to list revisions'
    console.error('[major revisions] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// HowTo 역사 조회
app.get('/api/howto/:slug/revisions', authMiddleware, async (c) => {
  try {
    const slug = c.req.param('slug')
    const limit = parseInt(c.req.query('limit') || '20', 10)
    const offset = parseInt(c.req.query('offset') || '0', 10)
    
    // HowTo 존재 확인
    const howto = await c.env.DB.prepare(
      'SELECT slug FROM pages WHERE slug = ? AND page_type = \'guide\' AND status = \'published\''
    ).bind(slug).first()
    
    if (!howto) {
      return c.json({ success: false, error: 'HOWTO_NOT_FOUND' }, 404)
    }
    
    const result = await listRevisions(c.env.DB, 'howto', slug, {
      limit: Math.min(Math.max(limit, 1), 100),
      offset: Math.max(offset, 0)
    })
    
    return c.json({
      success: true,
      data: result
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to list revisions'
    console.error('[howto revisions] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// 되돌리기
app.post('/api/revision/:id/restore', authMiddleware, async (c) => {
  try {
    const revisionId = Number(c.req.param('id'))
    const user = getOptionalUser(c)
    let body: any
    
    try {
      body = await c.req.json()
    } catch {
      body = {}
    }
    
    if (!Number.isFinite(revisionId) || revisionId <= 0) {
      return c.json({ success: false, error: 'invalid revision id' }, 400)
    }
    
    const password = typeof body.password === 'string' ? body.password : undefined
    
    // 익명 편집인 경우 비밀번호 검증 (passwordHash가 있는 경우에만)
    const targetRevision = await getRevisionById(c.env.DB, revisionId)
    if (targetRevision?.editorType === 'anonymous' && targetRevision.passwordHash) {
      // passwordHash가 있는 경우에만 비밀번호 검증 필요
      if (!password) {
        return c.json({ success: false, error: 'PASSWORD_REQUIRED' }, 403)
      }
      
      const { verifyEditPassword } = await import('./utils/anonymousEdit')
      const isValid = await verifyEditPassword(password, targetRevision.passwordHash)
      if (!isValid) {
        return c.json({ success: false, error: 'INVALID_PASSWORD' }, 403)
      }
    }
    
    // 되돌리기 실행
    const revision = await restoreRevision(
      c.env.DB,
      revisionId,
      user?.id?.toString() ?? null,
      password,
      user?.username ?? user?.name ?? null  // 사용자 닉네임 전달
    )
    
    // 캐시 무효화 (jobId 또는 majorId 사용)
    await invalidatePageCache(c.env.DB, {
      jobId: revision.entityType === 'job' ? revision.entityId : undefined,
      majorId: revision.entityType === 'major' ? revision.entityId : undefined,
      slug: revision.entityType === 'howto' ? revision.entityId : undefined,
      pageType: revision.entityType === 'howto' ? 'guide' : revision.entityType
    })
    
    return c.json({
      success: true,
      revisionId: revision.id,
      message: 'Revision restored successfully'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'restore failed'
    const status = message.includes('NOT_FOUND') ? 404
      : message.includes('REQUIRED') || message.includes('UNAUTHORIZED') ? 403
      : message.includes('INVALID') ? 400
      : 500
    
    return c.json({ success: false, error: message }, status)
  }
})

// SEO skeleton (dev/local only)
app.get('/robots.txt', (c) => {
  const url = new URL(c.req.url)
  const origin = `${url.protocol}//${url.host}`
  const body = `User-agent: *

Allow: /
Sitemap: ${origin}/sitemap.xml
`
  return c.text(body, 200, { 'content-type': 'text/plain; charset=utf-8' })
})

app.get('/sitemap.xml', async (c) => {
  const url = new URL(c.req.url)
  const origin = `${url.protocol}//${url.host}`
  const urls = ['/job/software-developer', '/job/가상현실전문가', '/major/digital-marketing-major']
  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urls.map((u) => `<url><loc>${origin}${encodeURI(u)}</loc></url>`).join('\n')}
</urlset>`
  return c.text(xml, 200, { 'content-type': 'application/xml; charset=utf-8' })
})

// Global 404 fallback
app.notFound((c) => {
  const user = c.get('user')
  const userData = user ? { id: user.id, name: user.name, email: user.email, role: user.role, picture_url: user.picture_url, custom_picture_url: user.custom_picture_url, username: user.username } : null
  const userMenuHtml = renderUserMenu(userData)
  return c.html(renderNotFoundPage({ userMenuHtml, requestedPath: c.req.path }), 404)
})

export default app

export const scheduled: ExportedHandlerScheduledHandler<Bindings> = async (event, env, ctx) => {
  const run = Promise.all(
    SERP_FRESHNESS_TARGETS.map(async (target) => {
      try {
        const result = await attemptScheduledRefresh(env.KV, env, target, {
          reason: event.cron ? `cron:${event.cron}` : 'scheduled-cron'
        })
        if (result.outcome === 'error') {
          console.error('[freshness][scheduled]', target.id, result.error)
        }
      } catch (error) {
        console.error('[freshness][scheduled]', target.id, error)
      }
    })
  )

  ctx.waitUntil(run)
  await run
}

// 🆕 API에서 원본 데이터를 다시 가져와서 api_data_json 업데이트
app.post('/api/job/:id/refetch-api-data', authMiddleware, async (c) => {
  try {
    const jobIdParam = c.req.param('id')
    
    // 실제 DB ID로 변환
    let jobId = jobIdParam
    let job = await c.env.DB.prepare('SELECT id, name, careernet_id, goyong24_id FROM jobs WHERE id = ? AND is_active = 1')
      .bind(jobId)
      .first<{ id: string; name: string; careernet_id: string | null; goyong24_id: string | null }>()
    
    // ID로 찾지 못한 경우 slug로 시도
    if (!job) {
      let extractedId = jobId
      if (jobId.includes(':')) {
        const parts = jobId.split(':')
        if (parts.length > 1) {
          extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
          job = await c.env.DB.prepare('SELECT id, name, careernet_id, goyong24_id FROM jobs WHERE id = ? AND is_active = 1')
            .bind(extractedId)
            .first<{ id: string; name: string; careernet_id: string | null; goyong24_id: string | null }>()
          
          if (job) {
            jobId = extractedId
          }
        }
      }
      
      if (!job) {
        const decodedSlug = decodeURIComponent(jobId)
        const normalizedSlug = decodedSlug.toLowerCase()
        
        job = await c.env.DB.prepare(
          'SELECT id, name, careernet_id, goyong24_id FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first<{ id: string; name: string; careernet_id: string | null; goyong24_id: string | null }>()
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id, name, careernet_id, goyong24_id FROM jobs WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first<{ id: string; name: string; careernet_id: string | null; goyong24_id: string | null }>()
        }
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id, name, careernet_id, goyong24_id FROM jobs WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(decodedSlug).first<{ id: string; name: string; careernet_id: string | null; goyong24_id: string | null }>()
        }
        
        if (job) {
          jobId = job.id
        }
      }
    }
    
    if (!job) {
      return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
    }
    
    
    // API에서 데이터 가져오기 (명시적으로 source ID 전달하여 강제로 API 호출)
    const { getUnifiedJobDetailWithRawData } = await import('./services/profileDataService')
    const result = await getUnifiedJobDetailWithRawData(
      {
        id: jobId,
        careernetId: job.careernet_id || undefined,
        goyong24JobId: job.goyong24_id || undefined,
        includeSources: ['CAREERNET', 'GOYONG24']
      },
      c.env as any
    )
    
    if (!result.profile) {
      return c.json({ success: false, error: 'Failed to fetch data from API' }, 500)
    }
    
    // api_data_json 업데이트
    // ⚠️ api_data_json에는 원본 API 데이터 구조를 저장해야 함 (rawApiData 사용)
    const rawApiData = result.rawApiData || { careernet: null, goyong24: null }
    
    // DB에 직접 저장 (updateApiData는 UnifiedJobDetail을 받지만, 우리는 rawApiData를 저장해야 함)
    const now = Date.now()
    const apiDataJson = JSON.stringify(rawApiData)
    
    // 해시 생성 (rawApiData 사용) - Web Crypto API 사용 (Cloudflare Workers 호환)
    const normalized = JSON.stringify(rawApiData, Object.keys(rawApiData).sort())
    const encoder = new TextEncoder()
    const dataBuffer = encoder.encode(normalized)
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer)
    const hashArray = Array.from(new Uint8Array(hashBuffer))
    const dataHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
    
    await c.env.DB.prepare(`
      UPDATE jobs 
      SET api_data_json = ?, api_data_hash = ?, api_last_fetched_at = ?, api_last_updated_at = ?
      WHERE id = ?
    `).bind(apiDataJson, dataHash, now, now, jobId).run()
    
    const updateResult = { updated: true, changedFields: [] }
    
    // 캐시 무효화
    await invalidatePageCache(c.env.DB, {
      jobId: jobId,
      pageType: 'job'
    })
    
    return c.json({
      success: true,
      message: 'API data refetched and saved successfully',
      updated: updateResult.updated,
      changedFields: updateResult.changedFields
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to refetch API data'
    console.error('[refetch-api-data] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// 🆕 user_contributed_json 비우기 (원본 API 데이터 복구용)
app.post('/api/job/:id/reset-contributions', authMiddleware, async (c) => {
  try {
    const jobIdParam = c.req.param('id')
    
    // 실제 DB ID로 변환 (editJob과 동일한 로직)
    let jobId = jobIdParam
    let job = await c.env.DB.prepare('SELECT id FROM jobs WHERE id = ? AND is_active = 1')
      .bind(jobId)
      .first<{ id: string }>()
    
    // ID로 찾지 못한 경우 slug로 시도
    if (!job) {
      let extractedId = jobId
      if (jobId.includes(':')) {
        const parts = jobId.split(':')
        if (parts.length > 1) {
          extractedId = parts[parts.length - 1].replace(/^G_/, '').replace(/^C_/, '')
          job = await c.env.DB.prepare('SELECT id FROM jobs WHERE id = ? AND is_active = 1')
            .bind(extractedId)
            .first<{ id: string }>()
          
          if (job) {
            jobId = extractedId
          }
        }
      }
      
      if (!job) {
        const decodedSlug = decodeURIComponent(jobId)
        const normalizedSlug = decodedSlug.toLowerCase()
        
        job = await c.env.DB.prepare(
          'SELECT id FROM jobs WHERE LOWER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(name, "-", ""), ",", ""), "·", ""), "ㆍ", ""), "/", ""), " ", ""), "(", ""), ")", "")) = ? AND is_active = 1 LIMIT 1'
        ).bind(normalizedSlug).first<{ id: string }>()
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE LOWER(name) = ? AND is_active = 1 LIMIT 1'
          ).bind(normalizedSlug).first<{ id: string }>()
        }
        
        if (!job) {
          job = await c.env.DB.prepare(
            'SELECT id FROM jobs WHERE LOWER(name) = LOWER(?) AND is_active = 1 LIMIT 1'
          ).bind(decodedSlug).first<{ id: string }>()
        }
        
        if (job) {
          jobId = job.id
        }
      }
    }
    
    if (!job) {
      return c.json({ success: false, error: 'JOB_NOT_FOUND' }, 404)
    }
    
    // user_contributed_json을 빈 객체로 설정
    const now = Date.now()
    await c.env.DB.prepare(`
      UPDATE jobs 
      SET user_contributed_json = '{}', user_last_updated_at = ?
      WHERE id = ?
    `).bind(now, jobId).run()
    
    // 캐시 무효화
    await invalidatePageCache(c.env.DB, {
      jobId: jobId,
      pageType: 'job'
    })
    
    return c.json({
      success: true,
      message: 'User contributions cleared. Original API data will now be displayed.'
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'failed to reset contributions'
    return c.json({ success: false, error: message }, 500)
  }
})

// ============================================================================
// 관리자 페이지 라우트
// ============================================================================

// 관리자 대시보드 메인
app.get('/admin', requireAdmin, async (c) => {
  try {
    const db = c.env.DB
    
    // 통계 데이터 조회
    const [jobsResult, majorsResult, usersResult, todayEditsResult] = await Promise.all([
      db.prepare('SELECT COUNT(*) as count FROM jobs WHERE is_active = 1').first<{ count: number }>(),
      db.prepare('SELECT COUNT(*) as count FROM majors WHERE is_active = 1').first<{ count: number }>(),
      db.prepare('SELECT COUNT(*) as count FROM users').first<{ count: number }>(),
      db.prepare(`
        SELECT COUNT(*) as count FROM page_revisions 
        WHERE created_at >= datetime('now', '-1 day')
      `).first<{ count: number }>()
    ])
    
    // 캐시 히트율 계산 (최근 24시간 SERP 데이터 기반)
    const cacheStats = await db.prepare(`
      SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN cache_status = 'HIT' THEN 1 ELSE 0 END) as hits
      FROM serp_interaction_logs
      WHERE recorded_at >= datetime('now', '-1 day')
    `).first<{ total: number; hits: number }>()
    
    const cacheHitRate = cacheStats && cacheStats.total > 0 
      ? (cacheStats.hits / cacheStats.total) * 100 
      : 0
    
    // 최근 편집 5건
    const recentEdits = await db.prepare(`
      SELECT 
        pr.id,
        pr.entity_type as entityType,
        pr.entity_id as entityId,
        COALESCE(j.name, m.name, pr.entity_id) as entityName,
        COALESCE(pr.editor_name, '익명') as editorName,
        COALESCE(pr.editor_type, 'anonymous') as editorType,
        pr.created_at as createdAt
      FROM page_revisions pr
      LEFT JOIN jobs j ON pr.entity_type = 'job' AND pr.entity_id = j.id
      LEFT JOIN majors m ON pr.entity_type = 'major' AND pr.entity_id = m.id
      ORDER BY pr.created_at DESC
      LIMIT 5
    `).all()
    
    // 최근 가입 사용자 5명
    const recentUsers = await db.prepare(`
      SELECT id, name, email, role, created_at as createdAt
      FROM users
      ORDER BY created_at DESC
      LIMIT 5
    `).all()
    
    return c.html(renderAdminDashboard({
      stats: {
        totalJobs: jobsResult?.count || 0,
        totalMajors: majorsResult?.count || 0,
        totalUsers: usersResult?.count || 0,
        todayEdits: todayEditsResult?.count || 0,
        cacheHitRate
      },
      recentEdits: (recentEdits.results || []) as any[],
      recentUsers: (recentUsers.results || []) as any[]
    }))
  } catch (error) {
    console.error('Admin dashboard error:', error)
    return c.text('관리자 대시보드를 불러오는데 실패했습니다.', 500)
  }
})

// ============================================
// AI Analyzer 관제판
// ============================================
import { renderAdminAiAnalyzer } from './templates/admin/adminAiAnalyzer'
import { adminAiApi } from './services/ai-analyzer/admin-api'

// Admin API 마운트
app.route('/admin/api/ai', adminAiApi)

// AI Analyzer 관제판 페이지 (개발환경: localhost 접근 시 인증 우회)
app.get('/admin/ai-analyzer', async (c, next) => {
  // 개발환경(localhost)에서는 인증 우회
  const host = c.req.header('host') || ''
  const isLocalhost = host.startsWith('localhost') || host.startsWith('127.0.0.1')
  if (isLocalhost) {
    console.log('⚠️ [Admin] Localhost detected - skipping auth for admin')
    return next()
  }
  return requireAdmin(c as any, next)
}, async (c) => {
  const db = c.env.DB

  try {
    // AI 추천 핵심 통계 수집
    const [
      totalCompleted, totalRequests, reanalysisCount,
      analysisLast24h, followupLast24h, totalSessions
    ] = await Promise.all([
      db.prepare("SELECT COUNT(*) as count FROM ai_analysis_requests WHERE status = 'completed'").first<{ count: number }>().catch(() => ({ count: 0 })),
      db.prepare("SELECT COUNT(*) as count FROM ai_analysis_requests").first<{ count: number }>().catch(() => ({ count: 0 })),
      db.prepare("SELECT COUNT(*) as count FROM ai_analysis_requests WHERE is_reanalysis = 1").first<{ count: number }>().catch(() => ({ count: 0 })),
      db.prepare("SELECT COUNT(*) as count FROM ai_analysis_requests WHERE requested_at >= datetime('now', '-24 hours')").first<{ count: number }>().catch(() => ({ count: 0 })),
      db.prepare("SELECT COUNT(*) as count FROM facts WHERE collected_at >= datetime('now', '-24 hours')").first<{ count: number }>().catch(() => ({ count: 0 })),
      db.prepare("SELECT COUNT(DISTINCT session_id) as count FROM ai_analysis_requests").first<{ count: number }>().catch(() => ({ count: 0 })),
    ])

    const { VERSIONS } = await import('./services/ai-analyzer/types')

    return c.html(renderAdminAiAnalyzer({
      overview: {
        totalCompletedAnalyses: totalCompleted?.count || 0,
        totalRequests: totalRequests?.count || 0,
        reanalysisCount: reanalysisCount?.count || 0,
        analysisRequestsLast24h: analysisLast24h?.count || 0,
        followupsLast24h: followupLast24h?.count || 0,
        totalSessions: totalSessions?.count || 0,
        engineVersions: {
          scoring: VERSIONS.scoring,
          recipe: VERSIONS.recipe,
        },
      },
    }))
  } catch (error) {
    console.error('AI Analyzer admin error:', error)
    return c.text('AI Analyzer 관제판을 불러오는데 실패했습니다: ' + (error instanceof Error ? error.message : 'Unknown'), 500)
  }
})

// 관리자 - 피드백 관리
app.get('/admin/feedback', requireAdmin, async (c) => {
  try {
    const page = parseNumberParam(c.req.query('page'), 1, { min: 1 })
    const pageSize = 20
    const result = await listFeedbackWithCommentCount(c.env.DB, { page, pageSize, includePrivate: true })

    return c.html(
      renderAdminFeedbackPage({
        page,
        total: result.total,
        pageSize,
        items: result.items as any,
      })
    )
  } catch (error) {
    console.error('Admin feedback page error:', error)
    return c.text('피드백 목록을 불러오는데 실패했습니다.', 500)
  }
})

// 피드백 상세
app.get('/admin/feedback/:id', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.redirect('/admin/feedback')

    const feedback = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!feedback) return c.redirect('/admin/feedback')

    // 작성자 정보 조회
    const authorRow = await c.env.DB.prepare(
      `SELECT name, username, picture_url FROM users WHERE id = ?`
    ).bind(feedback.user_id).first<{ name: string | null; username: string | null; picture_url: string | null }>()

    // 댓글 목록 조회
    const comments = await listComments(c.env.DB, id)
    const hasAdminComment = comments.some((c) => c.is_admin)

    return c.html(
      renderAdminFeedbackDetail({
        feedback: {
          ...feedback,
          author_name: authorRow?.name || authorRow?.username || `user_${feedback.user_id}`,
          author_picture: authorRow?.picture_url || null,
          last_activity_at: (feedback as any).last_activity_at || feedback.created_at,
        } as any,
        comments,
        hasAdminComment,
      })
    )
  } catch (error) {
    console.error('Admin feedback detail error:', error)
    return c.text('피드백을 불러오는데 실패했습니다.', 500)
  }
})

// 관리자 - 피드백 상태 업데이트
app.patch('/api/admin/feedback/:id/status', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) return c.json({ success: false, error: 'invalid_id' }, 400)
    const body = await c.req.json().catch(() => ({}))
    const status = typeof body.status === 'string' ? body.status.trim() : ''
    if (!isValidFeedbackStatus(status)) return c.json({ success: false, error: 'invalid_status' }, 400)

    const exists = await getFeedbackById(c.env.DB, id, { includePrivate: true })
    if (!exists) return c.json({ success: false, error: 'not_found' }, 404)

    const updated = await updateFeedbackStatus(c.env.DB, id, status)
    return c.json({ success: true, status: updated?.status })
  } catch (error) {
    console.error('[feedback] status update error', error)
    return c.json({ success: false, error: 'failed_to_update_status' }, 500)
  }
})

// 관리자 - 사용자 관리 페이지
app.get('/admin/users', requireAdmin, async (c) => {
  try {
    const page = parseInt(c.req.query('page') || '1')
    const perPage = parseInt(c.req.query('perPage') || '20')
    const search = c.req.query('search') || ''
    const role = c.req.query('role') || 'all'
    const status = c.req.query('status') || 'all'
    
    const result = await getUsers(c.env.DB, {
      page,
      perPage,
      search,
      role: role as any,
      status: status as any
    })
    
    return c.html(renderAdminUsers({
      users: result.users as any[],
      total: result.total,
      page: result.page,
      perPage: result.perPage,
      totalPages: result.totalPages,
      filters: { search, role, status }
    }))
  } catch (error) {
    console.error('Admin users error:', error)
    return c.text('사용자 목록을 불러오는데 실패했습니다.', 500)
  }
})

// 관리자 - 사용자 상세 페이지
app.get('/admin/users/:id', requireAdmin, async (c) => {
  try {
    const userId = parseInt(c.req.param('id'))
    
    // 사용자 정보 조회
    const userRow = await c.env.DB
      .prepare(`SELECT * FROM users WHERE id = ?`)
      .bind(userId)
      .first()
    
    if (!userRow) {
      return c.text('사용자를 찾을 수 없습니다.', 404)
    }
    
    const user = {
      id: Number(userRow.id),
      email: String(userRow.email),
      name: userRow.name ? String(userRow.name) : null,
      username: userRow.username ? String(userRow.username) : null,
      pictureUrl: userRow.picture_url ? String(userRow.picture_url) : null,
      provider: userRow.provider ? String(userRow.provider) : 'google',
      providerUserId: userRow.provider_user_id ? String(userRow.provider_user_id) : null,
      googleId: userRow.google_id ? String(userRow.google_id) : null,
      role: String(userRow.role),
      editCount: Number(userRow.edit_count || 0),
      commentCount: Number(userRow.comment_count || 0),
      isBanned: Number(userRow.is_banned) === 1,
      banReason: userRow.ban_reason ? String(userRow.ban_reason) : null,
      bannedUntil: userRow.banned_until ? Number(userRow.banned_until) : null,
      onboarded: Number(userRow.onboarded || 0) === 1,
      lastLoginAt: userRow.last_login_at ? Number(userRow.last_login_at) : null,
      createdAt: Number(userRow.created_at)
    }
    
    // 유입경로 조회
    const attributionRow = await getUserAttribution(c.env.DB, userId)
    const attribution = attributionRow ? {
      selfChannel: attributionRow.self_channel,
      selfChannelOther: attributionRow.self_channel_other,
      interestState: attributionRow.interest_state,
      careerState: attributionRow.career_state,
      utmSource: attributionRow.utm_source,
      utmMedium: attributionRow.utm_medium,
      utmCampaign: attributionRow.utm_campaign,
      referrer: attributionRow.referrer,
      firstTouchAt: Math.floor(Date.now() / 1000) // 실제 값으로 교체 필요
    } : null
    
    // 최근 IP (댓글 기준)
    const latestIpRow = await c.env.DB
      .prepare(`SELECT display_ip FROM comments WHERE author_id = ? AND display_ip IS NOT NULL ORDER BY created_at DESC LIMIT 1`)
      .bind(String(userId))
      .first<{ display_ip: string | null }>()
    const latestIp = latestIpRow?.display_ip ? String(latestIpRow.display_ip) : null

    // 동의 이력 조회
    const consentsData = await getUserConsents(c.env.DB, userId)
    const consents = consentsData.map(consent => ({
      type: consent.type,
      version: consent.version,
      consentedAt: consent.consented_at,
      ip: consent.ip,
      ua: consent.ua
    }))
    
    // 최근 댓글 조회
    const commentsResult = await c.env.DB
      .prepare(`
        SELECT c.id, c.content, c.moderated, c.original_content, c.created_at, c.status,
               p.page_type, p.slug
        FROM comments c
        JOIN pages p ON p.id = c.page_id
        WHERE c.author_id = ?
        ORDER BY c.created_at DESC
        LIMIT 20
      `)
      .bind(String(userId))
      .all()
    
    const comments = (commentsResult.results || []).map((row: any) => ({
      id: Number(row.id),
      pageType: String(row.page_type),
      slug: String(row.slug),
      content: String(row.content),
      moderated: Number(row.moderated || 0) === 1,
      originalContent: row.original_content ? String(row.original_content) : undefined,
      createdAt: String(row.created_at),
      status: String(row.status)
    }))
    
    return c.html(renderAdminUserDetail({
      user,
      attribution,
      consents,
      comments,
      latestIp
    }))
  } catch (error) {
    console.error('Admin user detail error:', error)
    return c.text('사용자 정보를 불러오는데 실패했습니다.', 500)
  }
})

// 관리자 API - 사용자 댓글 목록
app.get('/api/admin/users/:id/comments', requireAdmin, async (c) => {
  try {
    const userId = parseInt(c.req.param('id'))
    const limit = parseInt(c.req.query('limit') || '20')
    
    const commentsResult = await c.env.DB
      .prepare(`
        SELECT c.id, c.content, c.moderated, c.original_content, c.created_at, c.status,
               p.page_type, p.slug
        FROM comments c
        JOIN pages p ON p.id = c.page_id
        WHERE c.author_id = ?
        ORDER BY c.created_at DESC
        LIMIT ?
      `)
      .bind(String(userId), limit)
      .all()
    
    const comments = (commentsResult.results || []).map((row: any) => ({
      id: Number(row.id),
      pageType: String(row.page_type),
      slug: String(row.slug),
      content: String(row.content),
      moderated: Number(row.moderated || 0) === 1,
      originalContent: row.original_content ? String(row.original_content) : undefined,
      createdAt: String(row.created_at),
      status: String(row.status)
    }))
    
    return c.json({ success: true, data: comments })
  } catch (error) {
    console.error('Admin user comments error:', error)
    return c.json({ success: false, error: 'Failed to get user comments' }, 500)
  }
})

// 관리자 API - 사용자 관리
app.patch('/api/admin/users/:id', requireAdmin, async (c) => {
  try {
    const userId = parseInt(c.req.param('id'))
    const body = await c.req.json()
    
    // 역할 변경
    if (body.role) {
      const success = await updateUserRole(c.env.DB, userId, body.role)
      return c.json({ success })
    }
    
    // 차단
    if (body.action === 'ban') {
      const success = await banUser(c.env.DB, userId, body.duration, body.reason)
      return c.json({ success })
    }
    
    // 차단 해제
    if (body.action === 'unban') {
      const success = await unbanUser(c.env.DB, userId)
      return c.json({ success })
    }
    
    return c.json({ success: false, error: 'Invalid action' }, 400)
  } catch (error) {
    console.error('Admin user update error:', error)
    return c.json({ success: false, error: 'Failed to update user' }, 500)
  }
})

// 관리자 - 콘텐츠/편집 관리 페이지
app.get('/admin/content', requireAdmin, async (c) => {
  try {
    const activeTab = (c.req.query('tab') || 'revisions') as 'revisions' | 'archive' | 'comments'
    const page = parseInt(c.req.query('page') || '1')
    const perPage = parseInt(c.req.query('perPage') || '20')
    const entityType = c.req.query('entityType') || 'all'
    const editorType = c.req.query('editorType') || 'all'
    const startDate = c.req.query('startDate') || ''
    const endDate = c.req.query('endDate') || ''
    
    // 편집 이력 가져오기
    const result = await getRevisions(c.env.DB, {
      page,
      perPage,
      entityType: entityType as any,
      editorType: editorType as any,
      startDate: startDate || undefined,
      endDate: endDate || undefined
    })

    let moderation: any = null
    let howtoReports = null
    if (activeTab === 'comments') {
      const modPage = page
      const modPerPage = perPage
      const flagged = await listFlaggedComments(c.env.DB, modPage, modPerPage)
      moderation = {
        items: flagged.items,
        total: flagged.total,
        page: modPage,
        perPage: modPerPage,
        totalPages: Math.max(1, Math.ceil(flagged.total / modPerPage))
      }
    } else if (activeTab === 'archive') {
      const rptPage = page
      const rptPerPage = perPage
      const reports = await listHowtoReports(c.env.DB, { status: 'pending', limit: rptPerPage, offset: (rptPage - 1) * rptPerPage })
      howtoReports = {
        items: reports.reports.map((r: any) => ({
          id: r.id,
          pageId: r.page_id,
          pageSlug: r.page_slug,
          pageTitle: r.page_title,
          reasonType: r.reason_type,
          reasonDetail: r.reason_detail,
          status: r.status,
          reporterId: r.reporter_id,
          reporterIpHash: r.reporter_ip_hash,
          createdAt: r.created_at
        })),
        total: reports.total,
        page: rptPage,
        perPage: rptPerPage,
        totalPages: Math.max(1, Math.ceil(reports.total / rptPerPage))
      }
    }
    
    // 숨겨진 직업/전공 목록 가져오기
    const hiddenJobsResult = await c.env.DB.prepare(`
      SELECT id, name, slug, primary_source, user_last_updated_at 
      FROM jobs 
      WHERE is_active = 0 
      ORDER BY user_last_updated_at DESC
    `).all<{ id: string; name: string; slug: string | null; primary_source: string; user_last_updated_at: number }>()
    
    const hiddenMajorsResult = await c.env.DB.prepare(`
      SELECT id, name, slug, primary_source, user_last_updated_at 
      FROM majors 
      WHERE is_active = 0 
      ORDER BY user_last_updated_at DESC
    `).all<{ id: string; name: string; slug: string | null; primary_source: string; user_last_updated_at: number }>()
    
    const hiddenJobs = (hiddenJobsResult.results || []).map(job => ({
      id: job.id,
      name: job.name,
      slug: job.slug,
      primarySource: job.primary_source,
      hiddenAt: job.user_last_updated_at
    }))
    
    const hiddenMajors = (hiddenMajorsResult.results || []).map(major => ({
      id: major.id,
      name: major.name,
      slug: major.slug,
      primarySource: major.primary_source,
      hiddenAt: major.user_last_updated_at
    }))
    
    return c.html(renderAdminContent({
      activeTab,
      revisions: result.revisions as any[],
      total: result.total,
      page: result.page,
      perPage: result.perPage,
      totalPages: result.totalPages,
      filters: { entityType, editorType, startDate, endDate },
      hiddenJobs,
      hiddenMajors,
      howtoReports: howtoReports ?? undefined,
      moderation: moderation ?? undefined
    }))
  } catch (error) {
    console.error('Admin content error:', error)
    return c.text('편집 이력을 불러오는데 실패했습니다.', 500)
  }
})

// 관리자 API - 리비전 목록
app.get('/api/admin/revisions', requireAdmin, async (c) => {
  try {
    const page = parseInt(c.req.query('page') || '1')
    const perPage = parseInt(c.req.query('perPage') || '20')
    const entityType = c.req.query('entityType') || 'all'
    const editorType = c.req.query('editorType') || 'all'
    const startDate = c.req.query('startDate') || ''
    const endDate = c.req.query('endDate') || ''
    
    const result = await getRevisions(c.env.DB, {
      page,
      perPage,
      entityType: entityType as any,
      editorType: editorType as any,
      startDate: startDate || undefined,
      endDate: endDate || undefined
    })
    
    return c.json({ success: true, data: result })
  } catch (error) {
    console.error('Admin revisions API error:', error)
    return c.json({ success: false, error: 'Failed to fetch revisions' }, 500)
  }
})

// 관리자 API - 신고/블라인드 댓글 목록
app.get('/api/admin/comments/moderation', requireAdmin, async (c) => {
  try {
    const page = parseInt(c.req.query('page') || '1')
    const perPage = parseInt(c.req.query('perPage') || '20')
    const result = await listFlaggedComments(c.env.DB, page, perPage)
    const totalPages = Math.max(1, Math.ceil(result.total / perPage))
    return c.json({
      success: true,
      data: {
        items: result.items,
        total: result.total,
        page,
        perPage,
        totalPages
      }
    })
  } catch (error) {
    console.error('Admin comments moderation list error:', error)
    return c.json({ success: false, error: 'Failed to fetch comments' }, 500)
  }
})

// 관리자 API - 댓글 블라인드
app.post('/api/admin/comments/:id/blind', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) {
      return c.json({ success: false, error: 'invalid id' }, 400)
    }
    await setCommentStatus(c.env.DB, id, 'blinded')
    return c.json({ success: true })
  } catch (error) {
    console.error('Admin comment blind error:', error)
    return c.json({ success: false, error: 'Failed to blind comment' }, 500)
  }
})

// 관리자 API - 댓글 블라인드 해제
app.post('/api/admin/comments/:id/unblind', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) {
      return c.json({ success: false, error: 'invalid id' }, 400)
    }
    await setCommentStatus(c.env.DB, id, 'visible')
    return c.json({ success: true })
  } catch (error) {
    console.error('Admin comment unblind error:', error)
    return c.json({ success: false, error: 'Failed to unblind comment' }, 500)
  }
})

// 관리자 API - 신고 카운트 초기화
app.post('/api/admin/comments/:id/reset-reports', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) {
      return c.json({ success: false, error: 'invalid id' }, 400)
    }
    await resetCommentReports(c.env.DB, id)
    return c.json({ success: true })
  } catch (error) {
    console.error('Admin comment reset reports error:', error)
    return c.json({ success: false, error: 'Failed to reset reports' }, 500)
  }
})

// 관리자 API - 댓글 삭제 (대댓글 포함)
app.delete('/api/admin/comments/:id', requireAdmin, async (c) => {
  try {
    const id = Number(c.req.param('id'))
    if (!Number.isFinite(id)) {
      return c.json({ success: false, error: 'invalid id' }, 400)
    }
    await deleteComment(c.env.DB, { commentId: id, userId: 'admin', userRole: 'admin' })
    return c.json({ success: true })
  } catch (error) {
    console.error('Admin comment delete error:', error)
    return c.json({ success: false, error: 'Failed to delete comment' }, 500)
  }
})

// 관리자 API - 고아 대댓글 정리 (1회성)
app.post('/api/admin/comments/cleanup-orphans', requireAdmin, async (c) => {
  try {
    const deleted = await deleteOrphanReplies(c.env.DB)
    return c.json({ success: true, deleted })
  } catch (error) {
    console.error('Admin orphan cleanup error:', error)
    return c.json({ success: false, error: 'Failed to cleanup orphans' }, 500)
  }
})

// 관리자 API - 리비전 복원
app.post('/api/admin/revisions/:id/restore', requireAdmin, async (c) => {
  try {
    const revisionId = parseInt(c.req.param('id'))
    const user = c.get('user')
    const body = await c.req.json()
    
    if (!user) {
      return c.json({ success: false, error: 'Unauthorized' }, 401)
    }
    
    const success = await restoreRevisionAdmin(c.env.DB, revisionId, user.id, body.reason)
    return c.json({ success })
  } catch (error) {
    console.error('Admin restore revision error:', error)
    return c.json({ success: false, error: 'Failed to restore revision' }, 500)
  }
})

// 관리자 - 통계 대시보드 페이지
app.get('/admin/stats', requireAdmin, async (c) => {
  try {
    const endDate = c.req.query('endDate') || new Date().toISOString().split('T')[0]
    const startDate = c.req.query('startDate') || new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0]
    const topLimit = parseInt(c.req.query('topLimit') || '10')
    
    const stats = await getAnalyticsStats(c.env.DB, { startDate, endDate, topLimit })
    
    return c.html(renderAdminStats({
      filters: { startDate, endDate, topLimit },
      ...stats
    }))
  } catch (error) {
    console.error('Admin stats error:', error)
    return c.text('통계를 불러오는데 실패했습니다.', 500)
  }
})

// 관리자 API - 통계 데이터
app.get('/api/admin/stats', requireAdmin, async (c) => {
  try {
    const endDate = c.req.query('endDate') || new Date().toISOString().split('T')[0]
    const startDate = c.req.query('startDate') || new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0]
    const topLimit = parseInt(c.req.query('topLimit') || '10')
    
    const stats = await getAnalyticsStats(c.env.DB, { startDate, endDate, topLimit })
    
    return c.json({ success: true, data: stats })
  } catch (error) {
    console.error('Admin stats API error:', error)
    return c.json({ success: false, error: 'Failed to fetch stats' }, 500)
  }
})

// ============================================================================
// 유사 이름 병합 관리 페이지 및 API
// ============================================================================

// 유사 이름 병합 관리 페이지 (데이터는 클라이언트에서 비동기 로드)
app.get('/similar-names', async (c) => {
  const typeParam = c.req.query('type') || 'job'
  const type = typeParam === 'major' ? 'major' : 'job'
  
  // 빈 페이지 먼저 렌더링, 데이터는 클라이언트에서 API 호출
  return c.html(renderAdminSimilarNamesPage({ type }))
})

// 유사 이름 후보 조회 API
app.get('/api/similar-names/:type', async (c) => {
  try {
    const type = c.req.param('type') as 'job' | 'major'
    if (type !== 'job' && type !== 'major') {
      return c.json({ success: false, error: 'Invalid type. Must be "job" or "major".' }, 400)
    }
    
    const minScoreParam = c.req.query('minScore')
    const minScore = minScoreParam ? parseFloat(minScoreParam) : 0.7
    
    if (isNaN(minScore) || minScore < 0 || minScore > 1) {
      return c.json({ success: false, error: 'minScore must be between 0 and 1' }, 400)
    }
    
    const result = await findSimilarNames(c.env.DB, type, minScore)
    
    return c.json({
      success: true,
      data: result
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Failed to find similar names'
    console.error('[similar-names] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// 이름 매핑 저장 API
app.post('/api/name-mappings', async (c) => {
  try {
    const body = await c.req.json<{
      mappings: Array<{
        type: 'job' | 'major'
        sourceName: string
        targetName: string
        similarityScore?: number
        matchReason?: string
      }>
    }>()
    
    if (!body.mappings || !Array.isArray(body.mappings) || body.mappings.length === 0) {
      return c.json({ success: false, error: 'mappings array is required' }, 400)
    }
    
    // 유효성 검사
    for (const mapping of body.mappings) {
      if (!mapping.type || !['job', 'major'].includes(mapping.type)) {
        return c.json({ success: false, error: 'Invalid type in mapping' }, 400)
      }
      if (!mapping.sourceName || !mapping.targetName) {
        return c.json({ success: false, error: 'sourceName and targetName are required' }, 400)
      }
    }
    
    // 현재 사용자 정보 (미들웨어에서 설정)
    const user = c.get('user')
    const createdBy = user ? String(user.id) : 'admin'
    
    const result = await saveNameMappings(c.env.DB, body.mappings, createdBy)
    
    return c.json({
      success: true,
      data: result
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Failed to save mappings'
    console.error('[name-mappings] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// 기존 매핑 조회 API
app.get('/api/name-mappings/:type', async (c) => {
  try {
    const type = c.req.param('type') as 'job' | 'major'
    if (type !== 'job' && type !== 'major') {
      return c.json({ success: false, error: 'Invalid type. Must be "job" or "major".' }, 400)
    }
    
    const mappings = await getExistingMappings(c.env.DB, type)
    
    return c.json({
      success: true,
      data: mappings
    })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Failed to get mappings'
    console.error('[name-mappings] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

// 매핑 삭제 API
app.delete('/api/name-mappings/:id', async (c) => {
  try {
    const idParam = c.req.param('id')
    const id = parseInt(idParam, 10)
    
    if (isNaN(id)) {
      return c.json({ success: false, error: 'Invalid mapping ID' }, 400)
    }
    
    const result = await deleteNameMapping(c.env.DB, id)
    
    if (!result.success) {
      return c.json({ success: false, error: result.error }, 500)
    }
    
    return c.json({ success: true })
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Failed to delete mapping'
    console.error('[name-mappings] Error:', error)
    return c.json({ success: false, error: message }, 500)
  }
})

