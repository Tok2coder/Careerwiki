# Phase 3 완료 보고서: RAG 검색 품질 개선

## 1. 작업 요약
- 시작: 2026-02-25
- 완료: 2026-02-25
- 수정한 파일: 1개 (src/services/rag-search.ts)
- 배포: 3회 (Batch 1, Batch 1+2, 최종)

## 2. Before/After 비교

### 총점: 92/180 (51.1%) → 113/180 (62.8%) = **+21점, +11.7%p 향상**

| 카테고리 | 쿼리 | Before | After | 변화 |
|---------|------|--------|-------|------|
| 직업명 직접 | 데이터 분석가 | 13 | 15 | +2 |
| 직업명 직접 | 웹 개발자 | 13 | 13 | 0 |
| 속어/은어 | 철밥통 | 0 | 3 | +3 |
| 속어/은어 | 코드몽키 | 11 | 13 | +2 |
| 의도 기반 | 연봉 높은 직업 | 8 | 7 | -1 |
| 의도 기반 | 워라밸 좋은 직업 | 6 | 4 | -2 |
| 전공명 | 컴퓨터공학 | 14 | 15 | +1 |
| 전공명 | 심리학 | 9 | 10 | +1 |
| 추상적 | 뭐 할지 모르겠어요 | 3 | 7 | +4 |
| HowTo | 면접 준비 | 1 | 4 | +3 |
| HowTo | 포트폴리오 만들기 | 3 | 9 | +6 |
| 복합 쿼리 | 안정적+연봉+IT | 11 | 13 | +2 |

### 카테고리별 요약
| 카테고리 | Before | After | 변화 |
|---------|--------|-------|------|
| 직접 직업 검색 | 26/30 | 28/30 | +2 (개선) |
| 속어/은어 쿼리 | 11/30 | 16/30 | +5 (개선) |
| 속성 기반 쿼리 | 14/30 | 11/30 | -3 (소폭 저하) |
| 직접 전공 검색 | 23/30 | 25/30 | +2 (개선) |
| 탐색 의도 쿼리 | 7/45 | 20/45 | +13 (대폭 개선) |
| 복합 조건 | 11/15 | 13/15 | +2 (개선) |

## 3. 변경 내용 상세

| 수정 | 내용 | 이유 |
|------|------|------|
| 속어 임베딩 분리 | preprocessQuery 반환 타입 변경: searchQuery(임베딩용), keywordQuery(LIKE용) 분리 | "철밥통"이 임베딩에서 "철도/철강"으로 오염되는 문제 해결 |
| 복수 부분매칭 | SLANG_DICTIONARY 부분매칭이 첫 번째에서 중단 → 전체 순회 | "코딩하는 의대생" 같은 복합 쿼리에서 모든 속어 매칭 |
| 속어 10개 추가 | 백수, 취준생, 알바, 프리랜서, 유튜버, 인플루언서, 판검사, 기레기, 선생님, 공시생 | 커버리지 확대 |
| MIN_VECTOR_SCORE 0.3→0.25 | 벡터 임계값 낮춤 | topK=100 제약에서 recall 향상 |
| MIN_VECTOR_SCORE_HOWTO 0.5→0.40 | HowTo 벡터 임계값 낮춤 | HowTo 검색 0건 문제 완화 |
| HowTo intent 패턴 3개 | "되는법/방법/어떻게" + "자격증/시험/준비" + "유망/뜨는" | Transactional 의도 → HowTo 우선 |
| re-ranking 로그 스케일 | blendedScore 공식 개선 | 20위 이후 항목도 재정렬 가능 |
| 도메인 접미사 15개 | 간호, 컴퓨터, 심리 등 → 직업/전공 변형 확장 | 2-5글자 쿼리 정밀도 향상 |

## 4. 부작용 점검
- [x] 타입 체크 통과 (npx tsc --noEmit — 기존 에러만 잔존)
- [x] 빌드 성공 (npm run build)
- [x] 배포 성공 (npm run deploy)
- [x] Analyst 부작용 검증 통과 (preprocessQuery 호출부 3곳 전부 확인)
- [x] 직접 검색(직업명/전공명) 회귀 없음
- [x] 콘솔 에러 없음
- [x] 의도하지 않은 UI 변경 없음

## 5. 배포 후 프로덕션 확인
- URL: https://careerwiki.org/search?q=유튜버 (새 속어 테스트)
- 정상 동작: ✅ (미디어콘텐츠창작자, 디지털크리에이터 등 반환)

## 6. 알려진 한계 / 개선 제안
1. 속성 기반 쿼리(연봉/워라밸) -3점 저하: DB 속성 데이터 품질 문제 + 벡터 후보 풀 다양성 부족
2. "철밥통" → 공무원 직접 매핑 미달: 임베딩 공간에서 "공무원"이 특정 직업보다 일반 사무직에 가까움
3. HowTo 가이드 절대 수 부족: 검색 개선보다 콘텐츠 생산이 필요 (Phase 6 대상)
4. FTS5 도입 시 LIKE 검색 10배 속도 향상 + BM25 점수 품질 개선 가능 (중기 과제)
5. Vectorize 인덱스 분리(직업/전공/HowTo 각각) 시 topK 3배 확보 가능 (중기 과제)

## 7. 다음 Phase 전달사항
- vectorize-pipeline.ts는 미수정 (AI 추천 파이프라인에 영향 없음)
- rag-search.ts의 preprocessQuery 반환 타입이 변경됨 (Phase 1에서 참고)
- ENABLE_QUERY_EXPANSION은 Cloudflare Pages 대시보드에서 이미 설정되어 있음
